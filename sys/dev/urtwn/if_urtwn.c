begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: if_urtwn.c,v 1.16 2011/02/10 17:26:40 jakemsr Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 2010 Damien Bergamini<damien.bergamini@free.fr>  * Copyright (c) 2014 Kevin Lo<kevlo@FreeBSD.org>  * Copyright (c) 2015 Andriy Voskoboinyk<avos@FreeBSD.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Driver for Realtek RTL8188CE-VAU/RTL8188CUS/RTL8188EU/RTL8188RU/RTL8192CU.  */
end_comment

begin_include
include|#
directive|include
file|"opt_wlan.h"
end_include

begin_include
include|#
directive|include
file|"opt_urtwn.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/kdb.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_regdomain.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ratectl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|IEEE80211_SUPPORT_SUPERG
end_ifdef

begin_include
include|#
directive|include
file|<net80211/ieee80211_superg.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/usb/usb.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usbdi.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_device.h>
end_include

begin_include
include|#
directive|include
file|"usbdevs.h"
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/urtwn/if_urtwnreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/urtwn/if_urtwnvar.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_enum
enum|enum
block|{
name|URTWN_DEBUG_XMIT
init|=
literal|0x00000001
block|,
comment|/* basic xmit operation */
name|URTWN_DEBUG_RECV
init|=
literal|0x00000002
block|,
comment|/* basic recv operation */
name|URTWN_DEBUG_STATE
init|=
literal|0x00000004
block|,
comment|/* 802.11 state transitions */
name|URTWN_DEBUG_RA
init|=
literal|0x00000008
block|,
comment|/* f/w rate adaptation setup */
name|URTWN_DEBUG_USB
init|=
literal|0x00000010
block|,
comment|/* usb requests */
name|URTWN_DEBUG_FIRMWARE
init|=
literal|0x00000020
block|,
comment|/* firmware(9) loading debug */
name|URTWN_DEBUG_BEACON
init|=
literal|0x00000040
block|,
comment|/* beacon handling */
name|URTWN_DEBUG_INTR
init|=
literal|0x00000080
block|,
comment|/* ISR */
name|URTWN_DEBUG_TEMP
init|=
literal|0x00000100
block|,
comment|/* temperature calibration */
name|URTWN_DEBUG_ROM
init|=
literal|0x00000200
block|,
comment|/* various ROM info */
name|URTWN_DEBUG_KEY
init|=
literal|0x00000400
block|,
comment|/* crypto keys management */
name|URTWN_DEBUG_TXPWR
init|=
literal|0x00000800
block|,
comment|/* dump Tx power values */
name|URTWN_DEBUG_RSSI
init|=
literal|0x00001000
block|,
comment|/* dump RSSI lookups */
name|URTWN_DEBUG_ANY
init|=
literal|0xffffffff
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|URTWN_DPRINTF
parameter_list|(
name|_sc
parameter_list|,
name|_m
parameter_list|,
modifier|...
parameter_list|)
value|do {			\ 	if ((_sc)->sc_debug& (_m))				\ 		device_printf((_sc)->sc_dev, __VA_ARGS__);	\ } while(0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|URTWN_DPRINTF
parameter_list|(
name|_sc
parameter_list|,
name|_m
parameter_list|,
modifier|...
parameter_list|)
value|do { (void) sc; } while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|IEEE80211_HAS_ADDR4
parameter_list|(
name|wh
parameter_list|)
value|IEEE80211_IS_DSTODS(wh)
end_define

begin_decl_stmt
specifier|static
name|int
name|urtwn_enable_11n
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.usb.urtwn.enable_11n"
argument_list|,
operator|&
name|urtwn_enable_11n
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* various supported device vendors/products */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|STRUCT_USB_HOST_ID
name|urtwn_devs
index|[]
init|=
block|{
define|#
directive|define
name|URTWN_DEV
parameter_list|(
name|v
parameter_list|,
name|p
parameter_list|)
value|{ USB_VP(USB_VENDOR_##v, USB_PRODUCT_##v##_##p) }
define|#
directive|define
name|URTWN_RTL8188E_DEV
parameter_list|(
name|v
parameter_list|,
name|p
parameter_list|)
define|\
value|{ USB_VPI(USB_VENDOR_##v, USB_PRODUCT_##v##_##p, URTWN_RTL8188E) }
define|#
directive|define
name|URTWN_RTL8188E
value|1
name|URTWN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RTL8188CU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RTL8188CU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|ASUS
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|ASUS
argument_list|,
name|USBN10NANO
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RTL8188CE_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RTL8188CE_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|AZUREWAVE
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|F7D2102
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|BELKIN
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|CHICONY
argument_list|,
name|RTL8188CUS_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|CHICONY
argument_list|,
name|RTL8188CUS_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|CHICONY
argument_list|,
name|RTL8188CUS_3
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|CHICONY
argument_list|,
name|RTL8188CUS_4
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|CHICONY
argument_list|,
name|RTL8188CUS_5
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|COREGA
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|DLINK
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|DLINK
argument_list|,
name|RTL8192CU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|DLINK
argument_list|,
name|RTL8192CU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|DLINK
argument_list|,
name|RTL8192CU_3
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|DLINK
argument_list|,
name|DWA131B
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|EDIMAX
argument_list|,
name|EW7811UN
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|EDIMAX
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|FEIXUN
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|FEIXUN
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|GUILLEMOT
argument_list|,
name|HWNUP150
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|HAWKING
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|HP3
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|NETGEAR
argument_list|,
name|WNA1000M
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|NETGEAR
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|NETGEAR4
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|NOVATECH
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8188CU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8188CU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8188CU_3
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8188CU_4
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8188CUS
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|PLANEX2
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CE_0
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CE_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CTV
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CU_0
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CU_3
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CU_COMBO
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188CUS
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188RU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188RU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188RU_3
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8191CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8192CE
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RTL8188CU_1
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RTL8188CU_2
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|SITECOMEU
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|TRENDNET
argument_list|,
name|RTL8188CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|TRENDNET
argument_list|,
name|RTL8192CU
argument_list|)
block|,
name|URTWN_DEV
argument_list|(
name|ZYXEL
argument_list|,
name|RTL8192CU
argument_list|)
block|,
comment|/* URTWN_RTL8188E */
name|URTWN_RTL8188E_DEV
argument_list|(
name|ABOCOM
argument_list|,
name|RTL8188EU
argument_list|)
block|,
name|URTWN_RTL8188E_DEV
argument_list|(
name|DLINK
argument_list|,
name|DWA123D1
argument_list|)
block|,
name|URTWN_RTL8188E_DEV
argument_list|(
name|DLINK
argument_list|,
name|DWA125D1
argument_list|)
block|,
name|URTWN_RTL8188E_DEV
argument_list|(
name|ELECOM
argument_list|,
name|WDC150SU2M
argument_list|)
block|,
name|URTWN_RTL8188E_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188ETV
argument_list|)
block|,
name|URTWN_RTL8188E_DEV
argument_list|(
name|REALTEK
argument_list|,
name|RTL8188EU
argument_list|)
block|,
undef|#
directive|undef
name|URTWN_RTL8188E_DEV
undef|#
directive|undef
name|URTWN_DEV
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_probe_t
name|urtwn_match
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_attach_t
name|urtwn_attach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_detach_t
name|urtwn_detach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|urtwn_bulk_tx_callback
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usb_callback_t
name|urtwn_bulk_rx_callback
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|urtwn_sysctlattach
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_drain_mbufq
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usb_error_t
name|urtwn_do_request
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|usb_device_request
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|urtwn_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
specifier|const
name|char
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
parameter_list|,
name|enum
name|ieee80211_opmode
parameter_list|,
name|int
parameter_list|,
specifier|const
name|uint8_t
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_vap_clear_tx
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_vap_clear_tx_queue
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|urtwn_datahead
modifier|*
parameter_list|,
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|mbuf
modifier|*
name|urtwn_rx_copy_to_mbuf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|r92c_rx_stat
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|mbuf
modifier|*
name|urtwn_report_intr
parameter_list|(
name|struct
name|usb_xfer
modifier|*
parameter_list|,
name|struct
name|urtwn_data
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|mbuf
modifier|*
name|urtwn_rxeof
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r88e_ratectl_tx_complete
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ieee80211_node
modifier|*
name|urtwn_rx_frame
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_txeof
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|urtwn_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_alloc_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|urtwn_data
type|[]
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_alloc_rx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_alloc_tx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_free_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|urtwn_data
name|data
index|[]
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_free_rx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_free_tx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|urtwn_data
modifier|*
name|_urtwn_getbuf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|urtwn_data
modifier|*
name|urtwn_getbuf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usb_error_t
name|urtwn_write_region_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usb_error_t
name|urtwn_write_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usb_error_t
name|urtwn_write_2
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usb_error_t
name|urtwn_write_4
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|usb_error_t
name|urtwn_read_region_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|urtwn_read_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|urtwn_read_2
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|urtwn_read_4
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_fw_cmd
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_cmdq_cb
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_cmd_sleepable
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|CMD_FUNC_PROTO
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r92c_rf_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r88e_rf_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|urtwn_rf_read
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_llt_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_efuse_read_next
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_efuse_read_data
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_function_decl
specifier|static
name|void
name|urtwn_dump_rom_contents
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|urtwn_efuse_read
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_efuse_switch_power
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_read_chipid
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_read_rom
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_r88e_read_rom
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_ra_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_init_beacon
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|urtwn_vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_setup_beacon
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_update_beacon
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_tx_beacon
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|urtwn_vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_key_alloc
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
parameter_list|,
name|ieee80211_keyix
modifier|*
parameter_list|,
name|ieee80211_keyix
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_key_set_cb
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|union
name|sec_param
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_key_del_cb
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|union
name|sec_param
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_key_set
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_key
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_key_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_key
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_tsf_task_adhoc
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_tsf_sync_enable
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_get_tsf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint64_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_led
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_mode
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_ibss_recv_mgmt
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
specifier|const
name|struct
name|ieee80211_rx_stats
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|enum
name|ieee80211_state
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_calib_to
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_calib_cb
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|union
name|sec_param
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_watchdog
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_update_avgrssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int8_t
name|urtwn_get_rssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int8_t
name|urtwn_r88e_get_rssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_tx_data
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|urtwn_data
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_tx_raw
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|urtwn_data
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_tx_start
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|struct
name|urtwn_data
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_transmit
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_start
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_parent
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_r92c_power_on
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_r88e_power_on
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r92c_power_off
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r88e_power_off
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_llt_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|URTWN_WITHOUT_UCODE
end_ifndef

begin_function_decl
specifier|static
name|void
name|urtwn_fw_reset
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r88e_fw_reset
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_fw_loadpage
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_load_firmware
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|urtwn_dma_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_mac_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_bb_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_rf_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_cam_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_cam_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_pa_bias_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_rxfilter_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_edca_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_write_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_get_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|uint16_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_r88e_get_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|uint16_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_rx_bssid_all
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_gain
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_getradiocaps
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
type|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_wme_update
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_update_slot
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_update_slot_cb
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|union
name|sec_param
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_update_aifs
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|urtwn_get_multi_pos
parameter_list|(
specifier|const
name|uint8_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_multi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_promisc
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_update_promisc
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_update_mcast
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ieee80211_node
modifier|*
name|urtwn_node_alloc
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_newassoc
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_node_free
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_set_chan
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_iq_calib
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_lc_calib
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_temp_calib
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_setup_static_keys
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|,
name|struct
name|urtwn_vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_stop
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_abort_xfers
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|urtwn_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|urtwn_ms_delay
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Aliases. */
end_comment

begin_define
define|#
directive|define
name|urtwn_bb_write
value|urtwn_write_4
end_define

begin_define
define|#
directive|define
name|urtwn_bb_read
value|urtwn_read_4
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|usb_config
name|urtwn_config
index|[
name|URTWN_N_TRANSFER
index|]
init|=
block|{
index|[
name|URTWN_BULK_RX
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
name|UE_ADDR_ANY
block|,
operator|.
name|direction
operator|=
name|UE_DIR_IN
block|,
operator|.
name|bufsize
operator|=
name|URTWN_RXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|short_xfer_ok
operator|=
literal|1
block|}
block|,
operator|.
name|callback
operator|=
name|urtwn_bulk_rx_callback
block|, 	}
block|,
index|[
name|URTWN_BULK_TX_BE
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
literal|0x03
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|URTWN_TXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|ext_buffer
operator|=
literal|1
block|,
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|}
block|,
operator|.
name|callback
operator|=
name|urtwn_bulk_tx_callback
block|,
operator|.
name|timeout
operator|=
name|URTWN_TX_TIMEOUT
block|,
comment|/* ms */
block|}
block|,
index|[
name|URTWN_BULK_TX_BK
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
literal|0x03
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|URTWN_TXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|ext_buffer
operator|=
literal|1
block|,
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|, 		}
block|,
operator|.
name|callback
operator|=
name|urtwn_bulk_tx_callback
block|,
operator|.
name|timeout
operator|=
name|URTWN_TX_TIMEOUT
block|,
comment|/* ms */
block|}
block|,
index|[
name|URTWN_BULK_TX_VI
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
literal|0x02
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|URTWN_TXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|ext_buffer
operator|=
literal|1
block|,
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|}
block|,
operator|.
name|callback
operator|=
name|urtwn_bulk_tx_callback
block|,
operator|.
name|timeout
operator|=
name|URTWN_TX_TIMEOUT
block|,
comment|/* ms */
block|}
block|,
index|[
name|URTWN_BULK_TX_VO
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|UE_BULK
block|,
operator|.
name|endpoint
operator|=
literal|0x02
block|,
operator|.
name|direction
operator|=
name|UE_DIR_OUT
block|,
operator|.
name|bufsize
operator|=
name|URTWN_TXBUFSZ
block|,
operator|.
name|flags
operator|=
block|{
operator|.
name|ext_buffer
operator|=
literal|1
block|,
operator|.
name|pipe_bof
operator|=
literal|1
block|,
operator|.
name|force_short_xfer
operator|=
literal|1
block|}
block|,
operator|.
name|callback
operator|=
name|urtwn_bulk_tx_callback
block|,
operator|.
name|timeout
operator|=
name|URTWN_TX_TIMEOUT
block|,
comment|/* ms */
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
specifier|const
struct|struct
name|wme_to_queue
block|{
name|uint16_t
name|reg
decl_stmt|;
name|uint8_t
name|qid
decl_stmt|;
block|}
name|wme2queue
index|[
name|WME_NUM_AC
index|]
init|=
block|{
block|{
name|R92C_EDCA_BE_PARAM
block|,
name|URTWN_BULK_TX_BE
block|}
block|,
block|{
name|R92C_EDCA_BK_PARAM
block|,
name|URTWN_BULK_TX_BK
block|}
block|,
block|{
name|R92C_EDCA_VI_PARAM
block|,
name|URTWN_BULK_TX_VI
block|}
block|,
block|{
name|R92C_EDCA_VO_PARAM
block|,
name|URTWN_BULK_TX_VO
block|}
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|uint8_t
name|urtwn_chan_2ghz
index|[]
init|=
block|{
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|12
block|,
literal|13
block|,
literal|14
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|urtwn_match
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
if|if
condition|(
name|uaa
operator|->
name|usb_mode
operator|!=
name|USB_MODE_HOST
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|uaa
operator|->
name|info
operator|.
name|bConfigIndex
operator|!=
name|URTWN_CONFIG_INDEX
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|uaa
operator|->
name|info
operator|.
name|bIfaceIndex
operator|!=
name|URTWN_IFACE_INDEX
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
name|usbd_lookup_id_by_uaa
argument_list|(
name|urtwn_devs
argument_list|,
sizeof|sizeof
argument_list|(
name|urtwn_devs
argument_list|)
argument_list|,
name|uaa
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_update_chw
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|int
name|urtwn_ampdu_enable
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|ieee80211_tx_ampdu
modifier|*
name|tap
parameter_list|)
block|{
comment|/* We're driving this ourselves (eventually); don't involve net80211 */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_attach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|usb_attach_arg
modifier|*
name|uaa
init|=
name|device_get_ivars
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|int
name|error
decl_stmt|;
name|device_set_usb_desc
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_udev
operator|=
name|uaa
operator|->
name|device
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|self
expr_stmt|;
if|if
condition|(
name|USB_GET_DRIVER_INFO
argument_list|(
name|uaa
argument_list|)
operator|==
name|URTWN_RTL8188E
condition|)
name|sc
operator|->
name|chip
operator||=
name|URTWN_CHIP_88E
expr_stmt|;
ifdef|#
directive|ifdef
name|USB_DEBUG
name|int
name|debug
decl_stmt|;
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
literal|"debug"
argument_list|,
operator|&
name|debug
argument_list|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_debug
operator|=
name|debug
expr_stmt|;
endif|#
directive|endif
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|self
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|URTWN_CMDQ_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|URTWN_NT_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_calib_to
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbufq_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|ifqmaxlen
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_iface_index
operator|=
name|URTWN_IFACE_INDEX
expr_stmt|;
name|error
operator|=
name|usbd_transfer_setup
argument_list|(
name|uaa
operator|->
name|device
argument_list|,
operator|&
name|sc
operator|->
name|sc_iface_index
argument_list|,
name|sc
operator|->
name|sc_xfer
argument_list|,
name|urtwn_config
argument_list|,
name|URTWN_N_TRANSFER
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|self
argument_list|,
literal|"could not allocate USB transfers, "
literal|"err=%s\n"
argument_list|,
name|usbd_errstr
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtwn_read_chipid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported test chip\n"
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
comment|/* Determine number of Tx/Rx chains. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C
condition|)
block|{
name|sc
operator|->
name|ntxchains
operator|=
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C_1T2R
operator|)
condition|?
literal|1
else|:
literal|2
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|ntxchains
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|error
operator|=
name|urtwn_r88e_read_rom
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|urtwn_read_rom
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: cannot read rom, error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|detach
goto|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MAC/BB RTL%s, RF 6052 %dT%dR\n"
argument_list|,
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C
operator|)
condition|?
literal|"8192CU"
else|:
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|?
literal|"8188EU"
else|:
operator|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
operator|)
condition|?
literal|"8188RU"
else|:
operator|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
operator|)
condition|?
literal|"8188CE-VAU"
else|:
literal|"8188CUS"
argument_list|,
name|sc
operator|->
name|ntxchains
argument_list|,
name|sc
operator|->
name|nrxchains
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_softc
operator|=
name|sc
expr_stmt|;
name|ic
operator|->
name|ic_name
operator|=
name|device_get_nameunit
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_phytype
operator|=
name|IEEE80211_T_OFDM
expr_stmt|;
comment|/* not only, but not used */
name|ic
operator|->
name|ic_opmode
operator|=
name|IEEE80211_M_STA
expr_stmt|;
comment|/* default to BSS mode */
comment|/* set device capabilities */
name|ic
operator|->
name|ic_caps
operator|=
name|IEEE80211_C_STA
comment|/* station mode */
operator||
name|IEEE80211_C_MONITOR
comment|/* monitor mode */
operator||
name|IEEE80211_C_IBSS
comment|/* adhoc mode */
operator||
name|IEEE80211_C_HOSTAP
comment|/* hostap mode */
operator||
name|IEEE80211_C_SHPREAMBLE
comment|/* short preamble supported */
operator||
name|IEEE80211_C_SHSLOT
comment|/* short slot time supported */
if|#
directive|if
literal|0
expr|| IEEE80211_C_BGSCAN
comment|/* capable of bg scanning */
endif|#
directive|endif
operator||
name|IEEE80211_C_WPA
comment|/* 802.11i */
operator||
name|IEEE80211_C_WME
comment|/* 802.11e */
operator||
name|IEEE80211_C_SWAMSDUTX
comment|/* Do software A-MSDU TX */
operator||
name|IEEE80211_C_FF
comment|/* Atheros fast-frames */
expr_stmt|;
name|ic
operator|->
name|ic_cryptocaps
operator|=
name|IEEE80211_CRYPTO_WEP
operator||
name|IEEE80211_CRYPTO_TKIP
operator||
name|IEEE80211_CRYPTO_AES_CCM
expr_stmt|;
comment|/* Assume they're all 11n capable for now */
if|if
condition|(
name|urtwn_enable_11n
condition|)
block|{
name|device_printf
argument_list|(
name|self
argument_list|,
literal|"enabling 11n\n"
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_htcaps
operator|=
name|IEEE80211_HTC_HT
operator||
if|#
directive|if
literal|0
expr|IEEE80211_HTC_AMPDU |
endif|#
directive|endif
name|IEEE80211_HTC_AMSDU
operator||
name|IEEE80211_HTCAP_MAXAMSDU_3839
operator||
name|IEEE80211_HTCAP_SMPS_OFF
expr_stmt|;
comment|/* no HT40 just yet */
comment|// ic->ic_htcaps |= IEEE80211_HTCAP_CHWIDTH40;
comment|/* XXX TODO: verify chains versus streams for urtwn */
name|ic
operator|->
name|ic_txstream
operator|=
name|sc
operator|->
name|ntxchains
expr_stmt|;
name|ic
operator|->
name|ic_rxstream
operator|=
name|sc
operator|->
name|nrxchains
expr_stmt|;
block|}
comment|/* XXX TODO: setup regdomain if R92C_CHANNEL_PLAN_BY_HW bit is set. */
name|urtwn_getradiocaps
argument_list|(
name|ic
argument_list|,
name|IEEE80211_CHAN_MAX
argument_list|,
operator|&
name|ic
operator|->
name|ic_nchans
argument_list|,
name|ic
operator|->
name|ic_channels
argument_list|)
expr_stmt|;
name|ieee80211_ifattach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_raw_xmit
operator|=
name|urtwn_raw_xmit
expr_stmt|;
name|ic
operator|->
name|ic_scan_start
operator|=
name|urtwn_scan_start
expr_stmt|;
name|ic
operator|->
name|ic_scan_end
operator|=
name|urtwn_scan_end
expr_stmt|;
name|ic
operator|->
name|ic_getradiocaps
operator|=
name|urtwn_getradiocaps
expr_stmt|;
name|ic
operator|->
name|ic_set_channel
operator|=
name|urtwn_set_channel
expr_stmt|;
name|ic
operator|->
name|ic_transmit
operator|=
name|urtwn_transmit
expr_stmt|;
name|ic
operator|->
name|ic_parent
operator|=
name|urtwn_parent
expr_stmt|;
name|ic
operator|->
name|ic_vap_create
operator|=
name|urtwn_vap_create
expr_stmt|;
name|ic
operator|->
name|ic_vap_delete
operator|=
name|urtwn_vap_delete
expr_stmt|;
name|ic
operator|->
name|ic_wme
operator|.
name|wme_update
operator|=
name|urtwn_wme_update
expr_stmt|;
name|ic
operator|->
name|ic_updateslot
operator|=
name|urtwn_update_slot
expr_stmt|;
name|ic
operator|->
name|ic_update_promisc
operator|=
name|urtwn_update_promisc
expr_stmt|;
name|ic
operator|->
name|ic_update_mcast
operator|=
name|urtwn_update_mcast
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|ic
operator|->
name|ic_node_alloc
operator|=
name|urtwn_node_alloc
expr_stmt|;
name|ic
operator|->
name|ic_newassoc
operator|=
name|urtwn_newassoc
expr_stmt|;
name|sc
operator|->
name|sc_node_free
operator|=
name|ic
operator|->
name|ic_node_free
expr_stmt|;
name|ic
operator|->
name|ic_node_free
operator|=
name|urtwn_node_free
expr_stmt|;
block|}
name|ic
operator|->
name|ic_update_chw
operator|=
name|urtwn_update_chw
expr_stmt|;
name|ic
operator|->
name|ic_ampdu_enable
operator|=
name|urtwn_ampdu_enable
expr_stmt|;
name|ieee80211_radiotap_attach
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|sc_txtap
operator|.
name|wt_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_txtap
argument_list|)
argument_list|,
name|URTWN_TX_RADIOTAP_PRESENT
argument_list|,
operator|&
name|sc
operator|->
name|sc_rxtap
operator|.
name|wr_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_rxtap
argument_list|)
argument_list|,
name|URTWN_RX_RADIOTAP_PRESENT
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|,
literal|0
argument_list|,
name|urtwn_cmdq_cb
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|urtwn_sysctlattach
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|ieee80211_announce
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|detach
label|:
name|urtwn_detach
argument_list|(
name|self
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* failure */
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_sysctlattach
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|USB_DEBUG
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
init|=
name|device_get_sysctl_ctx
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tree
init|=
name|device_get_sysctl_tree
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
decl_stmt|;
name|SYSCTL_ADD_U32
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"debug"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|sc
operator|->
name|sc_debug
argument_list|,
name|sc
operator|->
name|sc_debug
argument_list|,
literal|"control debugging printfs"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_detach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|self
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|unsigned
name|int
name|x
decl_stmt|;
comment|/* Prevent further ioctls. */
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|URTWN_DETACHED
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_calib_to
argument_list|)
expr_stmt|;
comment|/* stop all USB transfers */
name|usbd_transfer_unsetup
argument_list|(
name|sc
operator|->
name|sc_xfer
argument_list|,
name|URTWN_N_TRANSFER
argument_list|)
expr_stmt|;
comment|/* Prevent further allocations from RX/TX data lists. */
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* drain USB transfers */
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|URTWN_N_TRANSFER
condition|;
name|x
operator|++
control|)
name|usbd_transfer_drain
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|x
index|]
argument_list|)
expr_stmt|;
comment|/* Free data buffers. */
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_free_tx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_free_rx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_softc
operator|==
name|sc
condition|)
block|{
name|ieee80211_draintask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|)
expr_stmt|;
name|ieee80211_ifdetach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
block|}
name|URTWN_NT_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|URTWN_CMDQ_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_drain_mbufq
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|m
operator|=
name|mbufq_dequeue
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ni
operator|=
operator|(
expr|struct
name|ieee80211_node
operator|*
operator|)
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|NULL
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|usb_error_t
name|urtwn_do_request
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|usb_device_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|usb_error_t
name|err
decl_stmt|;
name|int
name|ntries
init|=
literal|10
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|ntries
operator|--
condition|)
block|{
name|err
operator|=
name|usbd_do_request_flags
argument_list|(
name|sc
operator|->
name|sc_udev
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|req
argument_list|,
name|data
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|250
comment|/* ms */
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
break|break;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_USB
argument_list|,
literal|"%s: control request failed, %s (retries left: %d)\n"
argument_list|,
name|__func__
argument_list|,
name|usbd_errstr
argument_list|(
name|err
argument_list|)
argument_list|,
name|ntries
argument_list|)
expr_stmt|;
name|usb_pause_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|hz
operator|/
literal|100
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|urtwn_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
specifier|const
name|char
name|name
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
name|unit
parameter_list|,
name|enum
name|ieee80211_opmode
name|opmode
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|uint8_t
name|bssid
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|urtwn_vap
modifier|*
name|uvp
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
if|if
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
condition|)
comment|/* only one at a time */
return|return
operator|(
name|NULL
operator|)
return|;
name|uvp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|urtwn_vap
argument_list|)
argument_list|,
name|M_80211_VAP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|vap
operator|=
operator|&
name|uvp
operator|->
name|vap
expr_stmt|;
comment|/* enable s/w bmiss handling for sta mode */
if|if
condition|(
name|ieee80211_vap_setup
argument_list|(
name|ic
argument_list|,
name|vap
argument_list|,
name|name
argument_list|,
name|unit
argument_list|,
name|opmode
argument_list|,
name|flags
operator||
name|IEEE80211_CLONE_NOBEACONS
argument_list|,
name|bssid
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* out of memory */
name|free
argument_list|(
name|uvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|opmode
operator|==
name|IEEE80211_M_HOSTAP
operator|||
name|opmode
operator|==
name|IEEE80211_M_IBSS
condition|)
name|urtwn_init_beacon
argument_list|(
name|sc
argument_list|,
name|uvp
argument_list|)
expr_stmt|;
comment|/* override state transition machine */
name|uvp
operator|->
name|newstate
operator|=
name|vap
operator|->
name|iv_newstate
expr_stmt|;
name|vap
operator|->
name|iv_newstate
operator|=
name|urtwn_newstate
expr_stmt|;
name|vap
operator|->
name|iv_update_beacon
operator|=
name|urtwn_update_beacon
expr_stmt|;
name|vap
operator|->
name|iv_key_alloc
operator|=
name|urtwn_key_alloc
expr_stmt|;
name|vap
operator|->
name|iv_key_set
operator|=
name|urtwn_key_set
expr_stmt|;
name|vap
operator|->
name|iv_key_delete
operator|=
name|urtwn_key_delete
expr_stmt|;
comment|/* 802.11n parameters */
name|vap
operator|->
name|iv_ampdu_density
operator|=
name|IEEE80211_HTCAP_MPDUDENSITY_16
expr_stmt|;
name|vap
operator|->
name|iv_ampdu_rxmax
operator|=
name|IEEE80211_HTCAP_MAXRXAMPDU_64K
expr_stmt|;
if|if
condition|(
name|opmode
operator|==
name|IEEE80211_M_IBSS
condition|)
block|{
name|uvp
operator|->
name|recv_mgmt
operator|=
name|vap
operator|->
name|iv_recv_mgmt
expr_stmt|;
name|vap
operator|->
name|iv_recv_mgmt
operator|=
name|urtwn_ibss_recv_mgmt
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|uvp
operator|->
name|tsf_task_adhoc
argument_list|,
literal|0
argument_list|,
name|urtwn_tsf_task_adhoc
argument_list|,
name|vap
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|URTWN_CHIP_HAS_RATECTL
argument_list|(
name|sc
argument_list|)
condition|)
name|ieee80211_ratectl_init
argument_list|(
name|vap
argument_list|)
expr_stmt|;
comment|/* complete setup */
name|ieee80211_vap_attach
argument_list|(
name|vap
argument_list|,
name|ieee80211_media_change
argument_list|,
name|ieee80211_media_status
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_opmode
operator|=
name|opmode
expr_stmt|;
return|return
operator|(
name|vap
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|urtwn_vap
modifier|*
name|uvp
init|=
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
comment|/* Guarantee that nothing will go through this vap. */
name|ieee80211_new_state
argument_list|(
name|vap
argument_list|,
name|IEEE80211_S_INIT
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ieee80211_draintask
argument_list|(
name|ic
argument_list|,
operator|&
name|vap
operator|->
name|iv_nstate_task
argument_list|)
expr_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|uvp
operator|->
name|bcn_mbuf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|uvp
operator|->
name|bcn_mbuf
argument_list|)
expr_stmt|;
comment|/* Cancel any unfinished Tx. */
name|urtwn_vap_clear_tx
argument_list|(
name|sc
argument_list|,
name|vap
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_IBSS
condition|)
name|ieee80211_draintask
argument_list|(
name|ic
argument_list|,
operator|&
name|uvp
operator|->
name|tsf_task_adhoc
argument_list|)
expr_stmt|;
if|if
condition|(
name|URTWN_CHIP_HAS_RATECTL
argument_list|(
name|sc
argument_list|)
condition|)
name|ieee80211_ratectl_deinit
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|ieee80211_vap_detach
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|uvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_vap_clear_tx
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_vap_clear_tx_queue
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|,
name|vap
argument_list|)
expr_stmt|;
name|urtwn_vap_clear_tx_queue
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|,
name|vap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_vap_clear_tx_queue
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|urtwn_datahead
modifier|*
name|head
parameter_list|,
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|urtwn_data
modifier|*
name|dp
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|STAILQ_FOREACH_SAFE
argument_list|(
argument|dp
argument_list|,
argument|head
argument_list|,
argument|next
argument_list|,
argument|tmp
argument_list|)
block|{
if|if
condition|(
name|dp
operator|->
name|ni
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|dp
operator|->
name|ni
operator|->
name|ni_vap
operator|==
name|vap
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|dp
operator|->
name|ni
argument_list|)
expr_stmt|;
name|dp
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|dp
operator|->
name|m
argument_list|)
expr_stmt|;
name|dp
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
name|STAILQ_REMOVE
argument_list|(
name|head
argument_list|,
name|dp
argument_list|,
name|urtwn_data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|dp
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|urtwn_rx_copy_to_mbuf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|r92c_rx_stat
modifier|*
name|stat
parameter_list|,
name|int
name|totlen
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|uint32_t
name|rxdw0
decl_stmt|;
name|int
name|pktlen
decl_stmt|;
comment|/* 	 * don't pass packets to the ieee80211 framework if the driver isn't 	 * RUNNING. 	 */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_RUNNING
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|rxdw0
operator|=
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxdw0
operator|&
operator|(
name|R92C_RXDW0_CRCERR
operator||
name|R92C_RXDW0_ICVERR
operator|)
condition|)
block|{
comment|/* 		 * This should not happen since we setup our Rx filter 		 * to not receive these frames. 		 */
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_RECV
argument_list|,
literal|"%s: RX flags error (%s)\n"
argument_list|,
name|__func__
argument_list|,
name|rxdw0
operator|&
name|R92C_RXDW0_CRCERR
condition|?
literal|"CRC"
else|:
literal|"ICV"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|pktlen
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_PKTLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|pktlen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame_ack
argument_list|)
condition|)
block|{
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_RECV
argument_list|,
literal|"%s: frame is too short: %d\n"
argument_list|,
name|__func__
argument_list|,
name|pktlen
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|__predict_false
argument_list|(
name|totlen
operator|>
name|MCLBYTES
argument_list|)
condition|)
block|{
comment|/* convert to m_getjcl if this happens */
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: frame too long: %d (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|pktlen
argument_list|,
name|totlen
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|m
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|m
operator|==
name|NULL
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not allocate RX mbuf\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Finalize mbuf. */
name|memcpy
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|uint8_t
operator|*
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|stat
argument_list|,
name|totlen
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|totlen
expr_stmt|;
return|return
operator|(
name|m
operator|)
return|;
name|fail
label|:
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|urtwn_report_intr
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|struct
name|urtwn_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|data
operator|->
name|sc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|r92c_rx_stat
modifier|*
name|stat
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|;
name|usbd_xfer_status
argument_list|(
name|xfer
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|stat
argument_list|)
condition|)
block|{
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|buf
operator|=
name|data
operator|->
name|buf
expr_stmt|;
name|stat
operator|=
operator|(
expr|struct
name|r92c_rx_stat
operator|*
operator|)
name|buf
expr_stmt|;
comment|/* 	 * For 88E chips we can tie the FF flushing here; 	 * this is where we do know exactly how deep the 	 * transmit queue is. 	 * 	 * But it won't work for R92 chips, so we can't 	 * take the easy way out. 	 */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|int
name|report_sel
init|=
name|MS
argument_list|(
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw3
argument_list|)
argument_list|,
name|R88E_RXDW3_RPT
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|report_sel
condition|)
block|{
case|case
name|R88E_RXDW3_RPT_RX
case|:
return|return
operator|(
name|urtwn_rxeof
argument_list|(
name|sc
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|)
return|;
case|case
name|R88E_RXDW3_RPT_TX1
case|:
name|urtwn_r88e_ratectl_tx_complete
argument_list|(
name|sc
argument_list|,
operator|&
name|stat
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_INTR
argument_list|,
literal|"%s: case %d was not handled\n"
argument_list|,
name|__func__
argument_list|,
name|report_sel
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
return|return
operator|(
name|urtwn_rxeof
argument_list|(
name|sc
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|urtwn_rxeof
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|r92c_rx_stat
modifier|*
name|stat
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m0
init|=
name|NULL
decl_stmt|,
modifier|*
name|prevm
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|rxdw0
decl_stmt|;
name|int
name|totlen
decl_stmt|,
name|pktlen
decl_stmt|,
name|infosz
decl_stmt|,
name|npkts
decl_stmt|;
comment|/* Get the number of encapsulated frames. */
name|stat
operator|=
operator|(
expr|struct
name|r92c_rx_stat
operator|*
operator|)
name|buf
expr_stmt|;
name|npkts
operator|=
name|MS
argument_list|(
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw2
argument_list|)
argument_list|,
name|R92C_RXDW2_PKTCNT
argument_list|)
expr_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_RECV
argument_list|,
literal|"%s: Rx %d frames in one chunk\n"
argument_list|,
name|__func__
argument_list|,
name|npkts
argument_list|)
expr_stmt|;
comment|/* Process all of them. */
while|while
condition|(
name|npkts
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|stat
argument_list|)
condition|)
break|break;
name|stat
operator|=
operator|(
expr|struct
name|r92c_rx_stat
operator|*
operator|)
name|buf
expr_stmt|;
name|rxdw0
operator|=
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw0
argument_list|)
expr_stmt|;
name|pktlen
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_PKTLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|pktlen
operator|==
literal|0
condition|)
break|break;
name|infosz
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_INFOSZ
argument_list|)
operator|*
literal|8
expr_stmt|;
comment|/* Make sure everything fits in xfer. */
name|totlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|stat
argument_list|)
operator|+
name|infosz
operator|+
name|pktlen
expr_stmt|;
if|if
condition|(
name|totlen
operator|>
name|len
condition|)
break|break;
name|m
operator|=
name|urtwn_rx_copy_to_mbuf
argument_list|(
name|sc
argument_list|,
name|stat
argument_list|,
name|totlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
name|m0
operator|=
name|m
expr_stmt|;
if|if
condition|(
name|prevm
operator|==
name|NULL
condition|)
name|prevm
operator|=
name|m
expr_stmt|;
else|else
block|{
name|prevm
operator|->
name|m_next
operator|=
name|m
expr_stmt|;
name|prevm
operator|=
name|m
expr_stmt|;
block|}
comment|/* Next chunk is 128-byte aligned. */
name|totlen
operator|=
operator|(
name|totlen
operator|+
literal|127
operator|)
operator|&
operator|~
literal|127
expr_stmt|;
name|buf
operator|+=
name|totlen
expr_stmt|;
name|len
operator|-=
name|totlen
expr_stmt|;
block|}
return|return
operator|(
name|m0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r88e_ratectl_tx_complete
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|r88e_tx_rpt_ccx
modifier|*
name|rpt
init|=
name|arg
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|uint8_t
name|macid
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|macid
operator|=
name|MS
argument_list|(
name|rpt
operator|->
name|rptb1
argument_list|,
name|R88E_RPTB1_MACID
argument_list|)
expr_stmt|;
name|ntries
operator|=
name|MS
argument_list|(
name|rpt
operator|->
name|rptb2
argument_list|,
name|R88E_RPTB2_RETRY_CNT
argument_list|)
expr_stmt|;
name|URTWN_NT_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ni
operator|=
name|sc
operator|->
name|node_list
index|[
name|macid
index|]
expr_stmt|;
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
name|vap
operator|=
name|ni
operator|->
name|ni_vap
expr_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_INTR
argument_list|,
literal|"%s: frame for macid %d was"
literal|"%s sent (%d retries)\n"
argument_list|,
name|__func__
argument_list|,
name|macid
argument_list|,
operator|(
name|rpt
operator|->
name|rptb1
operator|&
name|R88E_RPTB1_PKT_OK
operator|)
condition|?
literal|""
else|:
literal|" not"
argument_list|,
name|ntries
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpt
operator|->
name|rptb1
operator|&
name|R88E_RPTB1_PKT_OK
condition|)
block|{
name|ieee80211_ratectl_tx_complete
argument_list|(
name|vap
argument_list|,
name|ni
argument_list|,
name|IEEE80211_RATECTL_TX_SUCCESS
argument_list|,
operator|&
name|ntries
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ieee80211_ratectl_tx_complete
argument_list|(
name|vap
argument_list|,
name|ni
argument_list|,
name|IEEE80211_RATECTL_TX_FAILURE
argument_list|,
operator|&
name|ntries
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_INTR
argument_list|,
literal|"%s: macid %d, ni is NULL\n"
argument_list|,
name|__func__
argument_list|,
name|macid
argument_list|)
expr_stmt|;
block|}
name|URTWN_NT_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211_node
modifier|*
name|urtwn_rx_frame
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int8_t
modifier|*
name|rssi_p
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211_frame_min
modifier|*
name|wh
decl_stmt|;
name|struct
name|r92c_rx_stat
modifier|*
name|stat
decl_stmt|;
name|uint32_t
name|rxdw0
decl_stmt|,
name|rxdw3
decl_stmt|;
name|uint8_t
name|rate
decl_stmt|,
name|cipher
decl_stmt|;
name|int8_t
name|rssi
init|=
operator|-
literal|127
decl_stmt|;
name|int
name|infosz
decl_stmt|;
name|stat
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|r92c_rx_stat
operator|*
argument_list|)
expr_stmt|;
name|rxdw0
operator|=
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw0
argument_list|)
expr_stmt|;
name|rxdw3
operator|=
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw3
argument_list|)
expr_stmt|;
name|rate
operator|=
name|MS
argument_list|(
name|rxdw3
argument_list|,
name|R92C_RXDW3_RATE
argument_list|)
expr_stmt|;
name|cipher
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_CIPHER
argument_list|)
expr_stmt|;
name|infosz
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_INFOSZ
argument_list|)
operator|*
literal|8
expr_stmt|;
comment|/* Get RSSI from PHY status descriptor if present. */
if|if
condition|(
name|infosz
operator|!=
literal|0
operator|&&
operator|(
name|rxdw0
operator|&
name|R92C_RXDW0_PHYST
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|rssi
operator|=
name|urtwn_r88e_get_rssi
argument_list|(
name|sc
argument_list|,
name|rate
argument_list|,
operator|&
name|stat
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
else|else
name|rssi
operator|=
name|urtwn_get_rssi
argument_list|(
name|sc
argument_list|,
name|rate
argument_list|,
operator|&
name|stat
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_RSSI
argument_list|,
literal|"%s: rssi=%d\n"
argument_list|,
name|__func__
argument_list|,
name|rssi
argument_list|)
expr_stmt|;
comment|/* Update our average RSSI. */
name|urtwn_update_avgrssi
argument_list|(
name|sc
argument_list|,
name|rate
argument_list|,
name|rssi
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ieee80211_radiotap_active
argument_list|(
name|ic
argument_list|)
condition|)
block|{
name|struct
name|urtwn_rx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_rxtap
decl_stmt|;
name|tap
operator|->
name|wr_flags
operator|=
literal|0
expr_stmt|;
name|urtwn_get_tsf
argument_list|(
name|sc
argument_list|,
operator|&
name|tap
operator|->
name|wr_tsft
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|le32toh
argument_list|(
operator|(
name|uint32_t
operator|)
name|tap
operator|->
name|wr_tsft
argument_list|)
operator|<
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw5
argument_list|)
argument_list|)
condition|)
block|{
name|tap
operator|->
name|wr_tsft
operator|=
name|le32toh
argument_list|(
name|tap
operator|->
name|wr_tsft
operator|>>
literal|32
argument_list|)
operator|-
literal|1
expr_stmt|;
name|tap
operator|->
name|wr_tsft
operator|=
operator|(
name|uint64_t
operator|)
name|htole32
argument_list|(
name|tap
operator|->
name|wr_tsft
argument_list|)
operator|<<
literal|32
expr_stmt|;
block|}
else|else
name|tap
operator|->
name|wr_tsft
operator|&=
literal|0xffffffff00000000
expr_stmt|;
name|tap
operator|->
name|wr_tsft
operator|+=
name|stat
operator|->
name|rxdw5
expr_stmt|;
comment|/* XXX 20/40? */
comment|/* XXX shortgi? */
comment|/* Map HW rate index to 802.11 rate. */
if|if
condition|(
operator|!
operator|(
name|rxdw3
operator|&
name|R92C_RXDW3_HT
operator|)
condition|)
block|{
name|tap
operator|->
name|wr_rate
operator|=
name|ridx2rate
index|[
name|rate
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rate
operator|>=
literal|12
condition|)
block|{
comment|/* MCS0~15. */
comment|/* Bit 7 set means HT MCS instead of rate. */
name|tap
operator|->
name|wr_rate
operator|=
literal|0x80
operator||
operator|(
name|rate
operator|-
literal|12
operator|)
expr_stmt|;
block|}
comment|/* XXX TODO: this isn't right; should use the last good RSSI */
name|tap
operator|->
name|wr_dbm_antsignal
operator|=
name|rssi
expr_stmt|;
name|tap
operator|->
name|wr_dbm_antnoise
operator|=
name|URTWN_NOISE_FLOOR
expr_stmt|;
block|}
operator|*
name|rssi_p
operator|=
name|rssi
expr_stmt|;
comment|/* Drop descriptor. */
name|m_adj
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|stat
argument_list|)
operator|+
name|infosz
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame_min
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
operator|)
operator|&&
name|cipher
operator|!=
name|R92C_CAM_ALGO_NONE
condition|)
block|{
name|m
operator|->
name|m_flags
operator||=
name|M_WEP
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|m_len
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
condition|)
return|return
operator|(
name|ieee80211_find_rxnode
argument_list|(
name|ic
argument_list|,
name|wh
argument_list|)
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_bulk_rx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
name|NULL
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|struct
name|urtwn_data
modifier|*
name|data
decl_stmt|;
name|int8_t
name|nf
decl_stmt|,
name|rssi
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|tr_setup
goto|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|m
operator|=
name|urtwn_report_intr
argument_list|(
name|xfer
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|KASSERT
argument_list|(
name|m
operator|==
name|NULL
argument_list|,
operator|(
literal|"mbuf isn't NULL"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|finish
goto|;
block|}
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_data
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|buf
argument_list|,
name|usbd_xfer_max_len
argument_list|(
name|xfer
argument_list|)
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
comment|/* 		 * To avoid LOR we should unlock our private mutex here to call 		 * ieee80211_input() because here is at the end of a USB 		 * callback and safe to unlock. 		 */
while|while
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
name|next
operator|=
name|m
operator|->
name|m_next
expr_stmt|;
name|m
operator|->
name|m_next
operator|=
name|NULL
expr_stmt|;
name|ni
operator|=
name|urtwn_rx_frame
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
operator|&
name|rssi
argument_list|)
expr_stmt|;
comment|/* Store a global last-good RSSI */
if|if
condition|(
name|rssi
operator|!=
operator|-
literal|127
condition|)
name|sc
operator|->
name|last_rssi
operator|=
name|rssi
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nf
operator|=
name|URTWN_NOISE_FLOOR
expr_stmt|;
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rssi
operator|!=
operator|-
literal|127
condition|)
name|URTWN_NODE
argument_list|(
name|ni
argument_list|)
operator|->
name|last_rssi
operator|=
name|rssi
expr_stmt|;
if|if
condition|(
name|ni
operator|->
name|ni_flags
operator|&
name|IEEE80211_NODE_HT
condition|)
name|m
operator|->
name|m_flags
operator||=
name|M_AMPDU
expr_stmt|;
operator|(
name|void
operator|)
name|ieee80211_input
argument_list|(
name|ni
argument_list|,
name|m
argument_list|,
name|URTWN_NODE
argument_list|(
name|ni
argument_list|)
operator|->
name|last_rssi
operator|-
name|nf
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Use last good global RSSI */
operator|(
name|void
operator|)
name|ieee80211_input_all
argument_list|(
name|ic
argument_list|,
name|m
argument_list|,
name|sc
operator|->
name|last_rssi
operator|-
name|nf
argument_list|,
name|nf
argument_list|)
expr_stmt|;
block|}
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m
operator|=
name|next
expr_stmt|;
block|}
break|break;
default|default:
comment|/* needs it to the inactive queue due to a error. */
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
name|finish
label|:
comment|/* Finished receive; age anything left on the FF queue by a little bump */
comment|/* 	 * XXX TODO: just make this a callout timer schedule so we can 	 * flush the FF staging queue if we're approaching idle. 	 */
ifdef|#
directive|ifdef
name|IEEE80211_SUPPORT_SUPERG
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ieee80211_ff_age_all
argument_list|(
name|ic
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Kick-start more transmit in case we stalled */
name|urtwn_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_txeof
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|urtwn_data
modifier|*
name|data
parameter_list|,
name|int
name|status
parameter_list|)
block|{
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|ni
operator|!=
name|NULL
condition|)
comment|/* not a beacon frame */
name|ieee80211_tx_complete
argument_list|(
name|data
operator|->
name|ni
argument_list|,
name|data
operator|->
name|m
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_tx_n_active
operator|>
literal|0
condition|)
name|sc
operator|->
name|sc_tx_n_active
operator|--
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_txtimer
operator|=
literal|0
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_alloc_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|urtwn_data
name|data
index|[]
parameter_list|,
name|int
name|ndata
parameter_list|,
name|int
name|maxsz
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|urtwn_data
modifier|*
name|dp
init|=
operator|&
name|data
index|[
name|i
index|]
decl_stmt|;
name|dp
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|dp
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|dp
operator|->
name|buf
operator|=
name|malloc
argument_list|(
name|maxsz
argument_list|,
name|M_USBDEV
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|buf
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate buffer\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|dp
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|urtwn_free_list
argument_list|(
name|sc
argument_list|,
name|data
argument_list|,
name|ndata
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_alloc_rx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
name|urtwn_alloc_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_rx
argument_list|,
name|URTWN_RX_LIST_COUNT
argument_list|,
name|URTWN_RXBUFSZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|URTWN_RX_LIST_COUNT
condition|;
name|i
operator|++
control|)
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_rx_inactive
argument_list|,
operator|&
name|sc
operator|->
name|sc_rx
index|[
name|i
index|]
argument_list|,
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_alloc_tx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
name|urtwn_alloc_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_tx
argument_list|,
name|URTWN_TX_LIST_COUNT
argument_list|,
name|URTWN_TXBUFSZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|URTWN_TX_LIST_COUNT
condition|;
name|i
operator|++
control|)
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
operator|&
name|sc
operator|->
name|sc_tx
index|[
name|i
index|]
argument_list|,
name|next
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_free_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|urtwn_data
name|data
index|[]
parameter_list|,
name|int
name|ndata
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndata
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|urtwn_data
modifier|*
name|dp
init|=
operator|&
name|data
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|dp
operator|->
name|buf
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|dp
operator|->
name|buf
argument_list|,
name|M_USBDEV
argument_list|)
expr_stmt|;
name|dp
operator|->
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dp
operator|->
name|ni
operator|!=
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|dp
operator|->
name|ni
argument_list|)
expr_stmt|;
name|dp
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_free_rx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|urtwn_free_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_rx
argument_list|,
name|URTWN_RX_LIST_COUNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_free_tx_list
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|urtwn_free_list
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_tx
argument_list|,
name|URTWN_TX_LIST_COUNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_bulk_tx_callback
parameter_list|(
name|struct
name|usb_xfer
modifier|*
name|xfer
parameter_list|,
name|usb_error_t
name|error
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|usbd_xfer_softc
argument_list|(
name|xfer
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|IEEE80211_SUPPORT_SUPERG
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
endif|#
directive|endif
name|struct
name|urtwn_data
modifier|*
name|data
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|USB_GET_STATE
argument_list|(
name|xfer
argument_list|)
condition|)
block|{
case|case
name|USB_ST_TRANSFERRED
case|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|tr_setup
goto|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|urtwn_txeof
argument_list|(
name|sc
argument_list|,
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|USB_ST_SETUP
case|:
name|tr_setup
label|:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_XMIT
argument_list|,
literal|"%s: empty pending queue\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_n_active
operator|=
literal|0
expr_stmt|;
goto|goto
name|finish
goto|;
block|}
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_xfer_set_frame_data
argument_list|(
name|xfer
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|buf
argument_list|,
name|data
operator|->
name|buflen
argument_list|)
expr_stmt|;
name|usbd_transfer_submit
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_n_active
operator|++
expr_stmt|;
break|break;
default|default:
name|data
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
goto|goto
name|tr_setup
goto|;
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|urtwn_txeof
argument_list|(
name|sc
argument_list|,
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_CANCELLED
condition|)
block|{
name|usbd_xfer_set_stall
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
goto|goto
name|tr_setup
goto|;
block|}
break|break;
block|}
name|finish
label|:
ifdef|#
directive|ifdef
name|IEEE80211_SUPPORT_SUPERG
comment|/* 	 * If the TX active queue drops below a certain 	 * threshold, ensure we age fast-frames out so they're 	 * transmitted. 	 */
if|if
condition|(
name|sc
operator|->
name|sc_tx_n_active
operator|<=
literal|1
condition|)
block|{
comment|/* XXX ew - net80211 should defer this for us! */
comment|/* 		 * Note: this sc_tx_n_active currently tracks 		 * the number of pending transmit submissions 		 * and not the actual depth of the TX frames 		 * pending to the hardware.  That means that 		 * we're going to end up with some sub-optimal 		 * aggregation behaviour. 		 */
comment|/* 		 * XXX TODO: just make this a callout timer schedule so we can 		 * flush the FF staging queue if we're approaching idle. 		 */
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ieee80211_ff_flush
argument_list|(
name|ic
argument_list|,
name|WME_AC_VO
argument_list|)
expr_stmt|;
name|ieee80211_ff_flush
argument_list|(
name|ic
argument_list|,
name|WME_AC_VI
argument_list|)
expr_stmt|;
name|ieee80211_ff_flush
argument_list|(
name|ic
argument_list|,
name|WME_AC_BE
argument_list|)
expr_stmt|;
name|ieee80211_ff_flush
argument_list|(
name|ic
argument_list|,
name|WME_AC_BK
argument_list|)
expr_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* Kick-start more transmit */
name|urtwn_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|urtwn_data
modifier|*
name|_urtwn_getbuf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|urtwn_data
modifier|*
name|bf
decl_stmt|;
name|bf
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|!=
name|NULL
condition|)
name|STAILQ_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|next
argument_list|)
expr_stmt|;
else|else
block|{
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_XMIT
argument_list|,
literal|"%s: out of xmit buffers\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|bf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|urtwn_data
modifier|*
name|urtwn_getbuf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|urtwn_data
modifier|*
name|bf
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bf
operator|=
name|_urtwn_getbuf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
block|{
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_XMIT
argument_list|,
literal|"%s: stop queue\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|bf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usb_error_t
name|urtwn_write_region_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_WRITE_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|R92C_REQ_REGS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|urtwn_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
name|buf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usb_error_t
name|urtwn_write_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
return|return
operator|(
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|&
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usb_error_t
name|urtwn_write_2
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
name|val
operator|=
name|htole16
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usb_error_t
name|urtwn_write_4
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|val
operator|=
name|htole32
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|usb_error_t
name|urtwn_read_region_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|usb_device_request_t
name|req
decl_stmt|;
name|req
operator|.
name|bmRequestType
operator|=
name|UT_READ_VENDOR_DEVICE
expr_stmt|;
name|req
operator|.
name|bRequest
operator|=
name|R92C_REQ_REGS
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wValue
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wIndex
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|USETW
argument_list|(
name|req
operator|.
name|wLength
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|urtwn_do_request
argument_list|(
name|sc
argument_list|,
operator|&
name|req
argument_list|,
name|buf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|urtwn_read_1
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
if|if
condition|(
name|urtwn_read_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|&
name|val
argument_list|,
literal|1
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0xff
operator|)
return|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|urtwn_read_2
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
if|if
condition|(
name|urtwn_read_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|val
argument_list|,
literal|2
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0xffff
operator|)
return|;
return|return
operator|(
name|le16toh
argument_list|(
name|val
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|urtwn_read_4
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
if|if
condition|(
name|urtwn_read_region_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|val
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0xffffffff
operator|)
return|;
return|return
operator|(
name|le32toh
argument_list|(
name|val
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_fw_cmd
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|id
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|r92c_fw_cmd
name|cmd
decl_stmt|;
name|usb_error_t
name|error
decl_stmt|;
name|int
name|ntries
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_FW_LOADED
operator|)
condition|)
block|{
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_FIRMWARE
argument_list|,
literal|"%s: firmware "
literal|"was not loaded; command (id %d) will be discarded\n"
argument_list|,
name|__func__
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Wait for current FW box to be empty. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_HMETFR
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|sc
operator|->
name|fwcur
operator|)
operator|)
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not send firmware command\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
name|memset
argument_list|(
operator|&
name|cmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|id
operator|=
name|id
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|3
condition|)
name|cmd
operator|.
name|id
operator||=
name|R92C_CMD_FLAG_EXT
expr_stmt|;
name|KASSERT
argument_list|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
name|cmd
operator|.
name|msg
argument_list|)
argument_list|,
operator|(
literal|"urtwn_fw_cmd\n"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cmd
operator|.
name|msg
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Write the first word last since that will trigger the FW. */
name|error
operator|=
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|R92C_HMEBOX_EXT
argument_list|(
name|sc
operator|->
name|fwcur
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|cmd
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|error
operator|=
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|R92C_HMEBOX
argument_list|(
name|sc
operator|->
name|fwcur
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|cmd
operator|+
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|sc
operator|->
name|fwcur
operator|=
operator|(
name|sc
operator|->
name|fwcur
operator|+
literal|1
operator|)
operator|%
name|R92C_H2C_NBOX
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_cmdq_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|urtwn_cmdq
modifier|*
name|item
decl_stmt|;
comment|/* 	 * Device must be powered on (via urtwn_power_on()) 	 * before any command may be sent. 	 */
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_RUNNING
operator|)
condition|)
block|{
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|URTWN_CMDQ_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|cmdq
index|[
name|sc
operator|->
name|cmdq_first
index|]
operator|.
name|func
operator|!=
name|NULL
condition|)
block|{
name|item
operator|=
operator|&
name|sc
operator|->
name|cmdq
index|[
name|sc
operator|->
name|cmdq_first
index|]
expr_stmt|;
name|sc
operator|->
name|cmdq_first
operator|=
operator|(
name|sc
operator|->
name|cmdq_first
operator|+
literal|1
operator|)
operator|%
name|URTWN_CMDQ_SIZE
expr_stmt|;
name|URTWN_CMDQ_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|item
operator|->
name|func
argument_list|(
name|sc
argument_list|,
operator|&
name|item
operator|->
name|data
argument_list|)
expr_stmt|;
name|URTWN_CMDQ_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|item
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|item
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|URTWN_CMDQ_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_cmd_sleepable
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|CMD_FUNC_PROTO
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|KASSERT
argument_list|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
expr|union
name|sec_param
argument_list|)
argument_list|,
operator|(
literal|"buffer overflow"
operator|)
argument_list|)
expr_stmt|;
name|URTWN_CMDQ_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cmdq
index|[
name|sc
operator|->
name|cmdq_last
index|]
operator|.
name|func
operator|!=
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: cmdq overflow\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|URTWN_CMDQ_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|EAGAIN
operator|)
return|;
block|}
if|if
condition|(
name|ptr
operator|!=
name|NULL
condition|)
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|cmdq
index|[
name|sc
operator|->
name|cmdq_last
index|]
operator|.
name|data
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cmdq
index|[
name|sc
operator|->
name|cmdq_last
index|]
operator|.
name|func
operator|=
name|func
expr_stmt|;
name|sc
operator|->
name|cmdq_last
operator|=
operator|(
name|sc
operator|->
name|cmdq_last
operator|+
literal|1
operator|)
operator|%
name|URTWN_CMDQ_SIZE
expr_stmt|;
name|URTWN_CMDQ_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|cmdq_task
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|urtwn_rf_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|sc
operator|->
name|sc_rf_write
argument_list|(
name|sc
argument_list|,
name|chain
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r92c_rf_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_PARAM
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_LSSI_PARAM_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LSSI_PARAM_DATA
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r88e_rf_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_PARAM
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R88E_LSSI_PARAM_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LSSI_PARAM_DATA
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|urtwn_rf_read
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint8_t
name|addr
parameter_list|)
block|{
name|uint32_t
name|reg
index|[
name|R92C_MAX_CHAINS
index|]
decl_stmt|,
name|val
decl_stmt|;
name|reg
index|[
literal|0
index|]
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|!=
literal|0
condition|)
name|reg
index|[
name|chain
index|]
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reg
index|[
literal|0
index|]
operator|&
operator|~
name|R92C_HSSI_PARAM2_READ_EDGE
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|chain
argument_list|)
argument_list|,
name|RW
argument_list|(
name|reg
index|[
name|chain
index|]
argument_list|,
name|R92C_HSSI_PARAM2_READ_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|R92C_HSSI_PARAM2_READ_EDGE
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reg
index|[
literal|0
index|]
operator||
name|R92C_HSSI_PARAM2_READ_EDGE
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM1
argument_list|(
name|chain
argument_list|)
argument_list|)
operator|&
name|R92C_HSSI_PARAM1_PI
condition|)
name|val
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSPI_READBACK
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|val
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_READBACK
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|MS
argument_list|(
name|val
argument_list|,
name|R92C_LSSI_READBACK_DATA
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_llt_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|usb_error_t
name|error
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|error
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_LLT_INIT
argument_list|,
name|SM
argument_list|(
name|R92C_LLT_INIT_OP
argument_list|,
name|R92C_LLT_INIT_OP_WRITE
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LLT_INIT_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LLT_INIT_DATA
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Wait for write operation to complete. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|20
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|MS
argument_list|(
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_LLT_INIT
argument_list|)
argument_list|,
name|R92C_LLT_INIT_OP
argument_list|)
operator|==
name|R92C_LLT_INIT_OP_NO_ACTIVE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_efuse_read_next
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|val
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|usb_error_t
name|error
decl_stmt|;
name|int
name|ntries
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|last_rom_addr
operator|>=
name|URTWN_EFUSE_MAX_LEN
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_CTRL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_EFUSE_CTRL_ADDR
argument_list|,
name|sc
operator|->
name|last_rom_addr
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_EFUSE_CTRL_VALID
expr_stmt|;
name|error
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Wait for read operation to complete. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|R92C_EFUSE_CTRL_VALID
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not read efuse byte at address 0x%x\n"
argument_list|,
name|sc
operator|->
name|last_rom_addr
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
operator|*
name|val
operator|=
name|MS
argument_list|(
name|reg
argument_list|,
name|R92C_EFUSE_CTRL_DATA
argument_list|)
expr_stmt|;
name|sc
operator|->
name|last_rom_addr
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_efuse_read_data
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|rom
parameter_list|,
name|uint8_t
name|off
parameter_list|,
name|uint8_t
name|msk
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msk
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
continue|continue;
name|error
operator|=
name|urtwn_efuse_read_next
argument_list|(
name|sc
argument_list|,
operator|&
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_ROM
argument_list|,
literal|"rom[0x%03X] == 0x%02X\n"
argument_list|,
name|off
operator|*
literal|8
operator|+
name|i
operator|*
literal|2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|rom
index|[
name|off
operator|*
literal|8
operator|+
name|i
operator|*
literal|2
operator|+
literal|0
index|]
operator|=
name|reg
expr_stmt|;
name|error
operator|=
name|urtwn_efuse_read_next
argument_list|(
name|sc
argument_list|,
operator|&
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_ROM
argument_list|,
literal|"rom[0x%03X] == 0x%02X\n"
argument_list|,
name|off
operator|*
literal|8
operator|+
name|i
operator|*
literal|2
operator|+
literal|1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|rom
index|[
name|off
operator|*
literal|8
operator|+
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
name|reg
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|USB_DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|urtwn_dump_rom_contents
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|rom
parameter_list|,
name|uint16_t
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* Dump ROM contents. */
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s:"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|32
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n%03X: "
argument_list|,
name|i
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|%
literal|4
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02X"
argument_list|,
name|rom
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|urtwn_efuse_read
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|rom
parameter_list|,
name|uint16_t
name|size
parameter_list|)
block|{
define|#
directive|define
name|URTWN_CHK
parameter_list|(
name|res
parameter_list|)
value|do {	\ 	if ((error = res) != 0)	\ 		goto end;	\ } while(0)
name|uint8_t
name|msk
decl_stmt|,
name|off
decl_stmt|,
name|reg
decl_stmt|;
name|int
name|error
decl_stmt|;
name|URTWN_CHK
argument_list|(
name|urtwn_efuse_switch_power
argument_list|(
name|sc
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Read full ROM image. */
name|sc
operator|->
name|last_rom_addr
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|rom
argument_list|,
literal|0xff
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|URTWN_CHK
argument_list|(
name|urtwn_efuse_read_next
argument_list|(
name|sc
argument_list|,
operator|&
name|reg
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|reg
operator|!=
literal|0xff
condition|)
block|{
comment|/* check for extended header */
if|if
condition|(
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
operator|&&
operator|(
name|reg
operator|&
literal|0x1f
operator|)
operator|==
literal|0x0f
condition|)
block|{
name|off
operator|=
name|reg
operator|>>
literal|5
expr_stmt|;
name|URTWN_CHK
argument_list|(
name|urtwn_efuse_read_next
argument_list|(
name|sc
argument_list|,
operator|&
name|reg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
literal|0x0f
operator|)
operator|!=
literal|0x0f
condition|)
name|off
operator|=
operator|(
operator|(
name|reg
operator|&
literal|0xf0
operator|)
operator|>>
literal|1
operator|)
operator||
name|off
expr_stmt|;
else|else
continue|continue;
block|}
else|else
name|off
operator|=
name|reg
operator|>>
literal|4
expr_stmt|;
name|msk
operator|=
name|reg
operator|&
literal|0xf
expr_stmt|;
name|URTWN_CHK
argument_list|(
name|urtwn_efuse_read_data
argument_list|(
name|sc
argument_list|,
name|rom
argument_list|,
name|off
argument_list|,
name|msk
argument_list|)
argument_list|)
expr_stmt|;
name|URTWN_CHK
argument_list|(
name|urtwn_efuse_read_next
argument_list|(
name|sc
argument_list|,
operator|&
name|reg
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|end
label|:
ifdef|#
directive|ifdef
name|USB_DEBUG
if|if
condition|(
name|sc
operator|->
name|sc_debug
operator|&
name|URTWN_DEBUG_ROM
condition|)
name|urtwn_dump_rom_contents
argument_list|(
name|sc
argument_list|,
name|rom
argument_list|,
name|size
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_ACCESS
argument_list|,
name|R92C_EFUSE_ACCESS_OFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: error while reading ROM\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
undef|#
directive|undef
name|URTWN_CHK
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_efuse_switch_power
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usb_error_t
name|error
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_ACCESS
argument_list|,
name|R92C_EFUSE_ACCESS_ON
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_SYS_ISO_CTRL_PWC_EV12V
operator|)
condition|)
block|{
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|,
name|reg
operator||
name|R92C_SYS_ISO_CTRL_PWC_EV12V
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_SYS_FUNC_EN_ELDR
operator|)
condition|)
block|{
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
operator||
name|R92C_SYS_FUNC_EN_ELDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CLKR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
operator|(
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_ANA8M
operator|)
operator|)
operator|!=
operator|(
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_ANA8M
operator|)
condition|)
block|{
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CLKR
argument_list|,
name|reg
operator||
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_ANA8M
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_read_chipid
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CFG
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|R92C_SYS_CFG_TRP_VAUX_EN
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
if|if
condition|(
name|reg
operator|&
name|R92C_SYS_CFG_TYPE_92C
condition|)
block|{
name|sc
operator|->
name|chip
operator||=
name|URTWN_CHIP_92C
expr_stmt|;
comment|/* Check if it is a castrated 8192C. */
if|if
condition|(
name|MS
argument_list|(
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_HPON_FSM
argument_list|)
argument_list|,
name|R92C_HPON_FSM_CHIP_BONDING_ID
argument_list|)
operator|==
name|R92C_HPON_FSM_CHIP_BONDING_ID_92C_1T2R
condition|)
name|sc
operator|->
name|chip
operator||=
name|URTWN_CHIP_92C_1T2R
expr_stmt|;
block|}
if|if
condition|(
name|reg
operator|&
name|R92C_SYS_CFG_VENDOR_UMC
condition|)
block|{
name|sc
operator|->
name|chip
operator||=
name|URTWN_CHIP_UMC
expr_stmt|;
if|if
condition|(
name|MS
argument_list|(
name|reg
argument_list|,
name|R92C_SYS_CFG_CHIP_VER_RTL
argument_list|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|chip
operator||=
name|URTWN_CHIP_UMC_A_CUT
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_read_rom
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|r92c_rom
modifier|*
name|rom
init|=
operator|&
name|sc
operator|->
name|rom
operator|.
name|r92c_rom
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Read full ROM image. */
name|error
operator|=
name|urtwn_efuse_read
argument_list|(
name|sc
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|rom
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rom
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* XXX Weird but this is what the vendor driver does. */
name|sc
operator|->
name|last_rom_addr
operator|=
literal|0x1fa
expr_stmt|;
name|error
operator|=
name|urtwn_efuse_read_next
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|pa_setting
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_ROM
argument_list|,
literal|"%s: PA setting=0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|pa_setting
argument_list|)
expr_stmt|;
name|sc
operator|->
name|board_type
operator|=
name|MS
argument_list|(
name|rom
operator|->
name|rf_opt1
argument_list|,
name|R92C_ROM_RF1_BOARD_TYPE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regulatory
operator|=
name|MS
argument_list|(
name|rom
operator|->
name|rf_opt1
argument_list|,
name|R92C_ROM_RF1_REGULATORY
argument_list|)
expr_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_ROM
argument_list|,
literal|"%s: regulatory type=%d\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|regulatory
argument_list|)
expr_stmt|;
name|IEEE80211_ADDR_COPY
argument_list|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_macaddr
argument_list|,
name|rom
operator|->
name|macaddr
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rf_write
operator|=
name|urtwn_r92c_rf_write
expr_stmt|;
name|sc
operator|->
name|sc_power_on
operator|=
name|urtwn_r92c_power_on
expr_stmt|;
name|sc
operator|->
name|sc_power_off
operator|=
name|urtwn_r92c_power_off
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_r88e_read_rom
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|r88e_rom
modifier|*
name|rom
init|=
operator|&
name|sc
operator|->
name|rom
operator|.
name|r88e_rom
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|urtwn_efuse_read
argument_list|(
name|sc
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|rom
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|rom
operator|.
name|r88e_rom
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|sc
operator|->
name|bw20_tx_pwr_diff
operator|=
operator|(
name|rom
operator|->
name|tx_pwr_diff
operator|>>
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bw20_tx_pwr_diff
operator|&
literal|0x08
condition|)
name|sc
operator|->
name|bw20_tx_pwr_diff
operator||=
literal|0xf0
expr_stmt|;
name|sc
operator|->
name|ofdm_tx_pwr_diff
operator|=
operator|(
name|rom
operator|->
name|tx_pwr_diff
operator|&
literal|0xf
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ofdm_tx_pwr_diff
operator|&
literal|0x08
condition|)
name|sc
operator|->
name|ofdm_tx_pwr_diff
operator||=
literal|0xf0
expr_stmt|;
name|sc
operator|->
name|regulatory
operator|=
name|MS
argument_list|(
name|rom
operator|->
name|rf_board_opt
argument_list|,
name|R92C_ROM_RF1_REGULATORY
argument_list|)
expr_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_ROM
argument_list|,
literal|"%s: regulatory type %d\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|regulatory
argument_list|)
expr_stmt|;
name|IEEE80211_ADDR_COPY
argument_list|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_macaddr
argument_list|,
name|rom
operator|->
name|macaddr
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rf_write
operator|=
name|urtwn_r88e_rf_write
expr_stmt|;
name|sc
operator|->
name|sc_power_on
operator|=
name|urtwn_r88e_power_on
expr_stmt|;
name|sc
operator|->
name|sc_power_off
operator|=
name|urtwn_r88e_power_off
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|uint8_t
name|rate2ridx
parameter_list|(
name|uint8_t
name|rate
parameter_list|)
block|{
if|if
condition|(
name|rate
operator|&
name|IEEE80211_RATE_MCS
condition|)
block|{
comment|/* 11n rates start at idx 12 */
return|return
operator|(
operator|(
name|rate
operator|&
literal|0xf
operator|)
operator|+
literal|12
operator|)
return|;
block|}
switch|switch
condition|(
name|rate
condition|)
block|{
comment|/* 11g */
case|case
literal|12
case|:
return|return
literal|4
return|;
case|case
literal|18
case|:
return|return
literal|5
return|;
case|case
literal|24
case|:
return|return
literal|6
return|;
case|case
literal|36
case|:
return|return
literal|7
return|;
case|case
literal|48
case|:
return|return
literal|8
return|;
case|case
literal|72
case|:
return|return
literal|9
return|;
case|case
literal|96
case|:
return|return
literal|10
return|;
case|case
literal|108
case|:
return|return
literal|11
return|;
comment|/* 11b */
case|case
literal|2
case|:
return|return
literal|0
return|;
case|case
literal|4
case|:
return|return
literal|1
return|;
case|case
literal|11
case|:
return|return
literal|2
return|;
case|case
literal|22
case|:
return|return
literal|3
return|;
default|default:
return|return
name|URTWN_RIDX_UNKNOWN
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Initialize rate adaptation in firmware.  */
end_comment

begin_function
specifier|static
name|int
name|urtwn_ra_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|ieee80211_rateset
modifier|*
name|rs
decl_stmt|,
modifier|*
name|rs_ht
decl_stmt|;
name|struct
name|r92c_fw_cmd_macid_cfg
name|cmd
decl_stmt|;
name|uint32_t
name|rates
decl_stmt|,
name|basicrates
decl_stmt|;
name|uint8_t
name|mode
decl_stmt|,
name|ridx
decl_stmt|;
name|int
name|maxrate
decl_stmt|,
name|maxbasicrate
decl_stmt|,
name|error
decl_stmt|,
name|i
decl_stmt|;
name|ni
operator|=
name|ieee80211_ref_node
argument_list|(
name|vap
operator|->
name|iv_bss
argument_list|)
expr_stmt|;
name|rs
operator|=
operator|&
name|ni
operator|->
name|ni_rates
expr_stmt|;
name|rs_ht
operator|=
operator|(
expr|struct
name|ieee80211_rateset
operator|*
operator|)
operator|&
name|ni
operator|->
name|ni_htrates
expr_stmt|;
comment|/* Get normal and basic rates mask. */
name|rates
operator|=
name|basicrates
operator|=
literal|0
expr_stmt|;
name|maxrate
operator|=
name|maxbasicrate
operator|=
literal|0
expr_stmt|;
comment|/* This is for 11bg */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|rs_nrates
condition|;
name|i
operator|++
control|)
block|{
comment|/* Convert 802.11 rate to HW rate index. */
name|ridx
operator|=
name|rate2ridx
argument_list|(
name|IEEE80211_RV
argument_list|(
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ridx
operator|==
name|URTWN_RIDX_UNKNOWN
condition|)
comment|/* Unknown rate, skip. */
continue|continue;
name|rates
operator||=
literal|1
operator|<<
name|ridx
expr_stmt|;
if|if
condition|(
name|ridx
operator|>
name|maxrate
condition|)
name|maxrate
operator|=
name|ridx
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
operator|&
name|IEEE80211_RATE_BASIC
condition|)
block|{
name|basicrates
operator||=
literal|1
operator|<<
name|ridx
expr_stmt|;
if|if
condition|(
name|ridx
operator|>
name|maxbasicrate
condition|)
name|maxbasicrate
operator|=
name|ridx
expr_stmt|;
block|}
block|}
comment|/* If we're doing 11n, enable 11n rates */
if|if
condition|(
name|ni
operator|->
name|ni_flags
operator|&
name|IEEE80211_NODE_HT
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs_ht
operator|->
name|rs_nrates
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rs_ht
operator|->
name|rs_rates
index|[
name|i
index|]
operator|&
literal|0x7f
operator|)
operator|>
literal|0xf
condition|)
continue|continue;
comment|/* 11n rates start at index 12 */
name|ridx
operator|=
operator|(
operator|(
name|rs_ht
operator|->
name|rs_rates
index|[
name|i
index|]
operator|)
operator|&
literal|0xf
operator|)
operator|+
literal|12
expr_stmt|;
name|rates
operator||=
operator|(
literal|1
operator|<<
name|ridx
operator|)
expr_stmt|;
comment|/* Guard against the rate table being oddly ordered */
if|if
condition|(
name|ridx
operator|>
name|maxrate
condition|)
name|maxrate
operator|=
name|ridx
expr_stmt|;
block|}
block|}
if|#
directive|if
literal|0
block|if (ic->ic_curmode == IEEE80211_MODE_11NG) 		raid = R92C_RAID_11GN;
endif|#
directive|endif
comment|/* NB: group addressed frames are done at 11bg rates for now */
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|mode
operator|=
name|R92C_RAID_11B
expr_stmt|;
else|else
name|mode
operator|=
name|R92C_RAID_11BG
expr_stmt|;
comment|/* XXX misleading 'mode' value here for unicast frames */
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_RA
argument_list|,
literal|"%s: mode 0x%x, rates 0x%08x, basicrates 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|mode
argument_list|,
name|rates
argument_list|,
name|basicrates
argument_list|)
expr_stmt|;
comment|/* Set rates mask for group addressed frames. */
name|cmd
operator|.
name|macid
operator|=
name|URTWN_MACID_BC
operator||
name|URTWN_MACID_VALID
expr_stmt|;
name|cmd
operator|.
name|mask
operator|=
name|htole32
argument_list|(
name|mode
operator|<<
literal|28
operator||
name|basicrates
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtwn_fw_cmd
argument_list|(
name|sc
argument_list|,
name|R92C_CMD_MACID_CONFIG
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not add broadcast station\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Set initial MRR rate. */
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_RA
argument_list|,
literal|"%s: maxbasicrate %d\n"
argument_list|,
name|__func__
argument_list|,
name|maxbasicrate
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIDATA_RATE_SEL
argument_list|(
name|URTWN_MACID_BC
argument_list|)
argument_list|,
name|maxbasicrate
argument_list|)
expr_stmt|;
comment|/* Set rates mask for unicast frames. */
if|if
condition|(
name|ni
operator|->
name|ni_flags
operator|&
name|IEEE80211_NODE_HT
condition|)
name|mode
operator|=
name|R92C_RAID_11GN
expr_stmt|;
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|mode
operator|=
name|R92C_RAID_11B
expr_stmt|;
else|else
name|mode
operator|=
name|R92C_RAID_11BG
expr_stmt|;
name|cmd
operator|.
name|macid
operator|=
name|URTWN_MACID_BSS
operator||
name|URTWN_MACID_VALID
expr_stmt|;
name|cmd
operator|.
name|mask
operator|=
name|htole32
argument_list|(
name|mode
operator|<<
literal|28
operator||
name|rates
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtwn_fw_cmd
argument_list|(
name|sc
argument_list|,
name|R92C_CMD_MACID_CONFIG
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not add BSS station\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Set initial MRR rate. */
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_RA
argument_list|,
literal|"%s: maxrate %d\n"
argument_list|,
name|__func__
argument_list|,
name|maxrate
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIDATA_RATE_SEL
argument_list|(
name|URTWN_MACID_BSS
argument_list|)
argument_list|,
name|maxrate
argument_list|)
expr_stmt|;
comment|/* Indicate highest supported rate. */
if|if
condition|(
name|ni
operator|->
name|ni_flags
operator|&
name|IEEE80211_NODE_HT
condition|)
name|ni
operator|->
name|ni_txrate
operator|=
name|rs_ht
operator|->
name|rs_rates
index|[
name|rs_ht
operator|->
name|rs_nrates
operator|-
literal|1
index|]
operator||
name|IEEE80211_RATE_MCS
expr_stmt|;
else|else
name|ni
operator|->
name|ni_txrate
operator|=
name|rs
operator|->
name|rs_rates
index|[
name|rs
operator|->
name|rs_nrates
operator|-
literal|1
index|]
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_init_beacon
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|urtwn_vap
modifier|*
name|uvp
parameter_list|)
block|{
name|struct
name|r92c_tx_desc
modifier|*
name|txd
init|=
operator|&
name|uvp
operator|->
name|bcn_desc
decl_stmt|;
name|txd
operator|->
name|txdw0
operator|=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW0_OFFSET
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
argument_list|)
operator||
name|R92C_TXDW0_BMCAST
operator||
name|R92C_TXDW0_OWN
operator||
name|R92C_TXDW0_FSG
operator||
name|R92C_TXDW0_LSG
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw1
operator|=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_QSEL
argument_list|,
name|R92C_TXDW1_QSEL_BEACON
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_RAID
argument_list|,
name|R92C_RAID_11B
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R88E_TXDW1_MACID
argument_list|,
name|URTWN_MACID_BC
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdseq
operator||=
name|htole16
argument_list|(
name|R88E_TXDSEQ_HWSEQ_EN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_MACID
argument_list|,
name|URTWN_MACID_BC
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_HWSEQ_EN
argument_list|)
expr_stmt|;
block|}
name|txd
operator|->
name|txdw4
operator|=
name|htole32
argument_list|(
name|R92C_TXDW4_DRVRATE
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator|=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_DATARATE
argument_list|,
name|URTWN_RIDX_CCK1
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_setup_beacon
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|urtwn_vap
modifier|*
name|uvp
init|=
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|error
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni
operator|->
name|ni_chan
operator|==
name|IEEE80211_CHAN_ANYC
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|m
operator|=
name|ieee80211_beacon_alloc
argument_list|(
name|ni
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not allocate beacon frame\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
if|if
condition|(
name|uvp
operator|->
name|bcn_mbuf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|uvp
operator|->
name|bcn_mbuf
argument_list|)
expr_stmt|;
name|uvp
operator|->
name|bcn_mbuf
operator|=
name|m
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|urtwn_tx_beacon
argument_list|(
name|sc
argument_list|,
name|uvp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* XXX bcnq stuck workaround */
if|if
condition|(
operator|(
name|error
operator|=
name|urtwn_tx_beacon
argument_list|(
name|sc
argument_list|,
name|uvp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_BEACON
argument_list|,
literal|"%s: beacon was %srecognized\n"
argument_list|,
name|__func__
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_TDECTRL
operator|+
literal|2
argument_list|)
operator|&
operator|(
name|R92C_TDECTRL_BCN_VALID
operator|>>
literal|16
operator|)
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_update_beacon
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|int
name|item
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|vap
operator|->
name|iv_ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|urtwn_vap
modifier|*
name|uvp
init|=
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|struct
name|ieee80211_beacon_offsets
modifier|*
name|bo
init|=
operator|&
name|vap
operator|->
name|iv_bcn_off
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
init|=
name|vap
operator|->
name|iv_bss
decl_stmt|;
name|int
name|mcast
init|=
literal|0
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|uvp
operator|->
name|bcn_mbuf
operator|==
name|NULL
condition|)
block|{
name|uvp
operator|->
name|bcn_mbuf
operator|=
name|ieee80211_beacon_alloc
argument_list|(
name|ni
argument_list|)
expr_stmt|;
if|if
condition|(
name|uvp
operator|->
name|bcn_mbuf
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not allocate beacon frame\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|item
operator|==
name|IEEE80211_BEACON_TIM
condition|)
name|mcast
operator|=
literal|1
expr_stmt|;
comment|/* XXX */
name|setbit
argument_list|(
name|bo
operator|->
name|bo_flags
argument_list|,
name|item
argument_list|)
expr_stmt|;
name|ieee80211_beacon_update
argument_list|(
name|ni
argument_list|,
name|uvp
operator|->
name|bcn_mbuf
argument_list|,
name|mcast
argument_list|)
expr_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_tx_beacon
argument_list|(
name|sc
argument_list|,
name|uvp
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Push a beacon frame into the chip. Beacon will  * be repeated by the chip every R92C_BCN_INTERVAL.  */
end_comment

begin_function
specifier|static
name|int
name|urtwn_tx_beacon
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|urtwn_vap
modifier|*
name|uvp
parameter_list|)
block|{
name|struct
name|r92c_tx_desc
modifier|*
name|desc
init|=
operator|&
name|uvp
operator|->
name|bcn_desc
decl_stmt|;
name|struct
name|urtwn_data
modifier|*
name|bf
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bf
operator|=
name|urtwn_getbuf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|memcpy
argument_list|(
name|bf
operator|->
name|buf
argument_list|,
name|desc
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|desc
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_tx_start
argument_list|(
name|sc
argument_list|,
name|uvp
operator|->
name|bcn_mbuf
argument_list|,
name|IEEE80211_FC0_TYPE_MGT
argument_list|,
name|bf
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txtimer
operator|=
literal|5
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|urtwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_key_alloc
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
name|k
parameter_list|,
name|ieee80211_keyix
modifier|*
name|keyix
parameter_list|,
name|ieee80211_keyix
modifier|*
name|rxkeyix
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|vap
operator|->
name|iv_ic
operator|->
name|ic_softc
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
if|if
condition|(
operator|!
operator|(
operator|&
name|vap
operator|->
name|iv_nw_keys
index|[
literal|0
index|]
operator|<=
name|k
operator|&&
name|k
operator|<
operator|&
name|vap
operator|->
name|iv_nw_keys
index|[
name|IEEE80211_WEP_NKID
index|]
operator|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_SWCRYPT
operator|)
condition|)
block|{
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* 			 * First 4 slots for group keys, 			 * what is left - for pairwise. 			 * XXX incompatible with IBSS RSN. 			 */
for|for
control|(
name|i
operator|=
name|IEEE80211_WEP_NKID
init|;
name|i
operator|<
name|R92C_CAM_ENTRY_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|keys_bmap
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|keys_bmap
operator||=
literal|1
operator|<<
name|i
expr_stmt|;
operator|*
name|keyix
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|R92C_CAM_ENTRY_COUNT
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: no free space in the key table\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
else|else
operator|*
name|keyix
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
operator|*
name|keyix
operator|=
name|k
operator|-
name|vap
operator|->
name|iv_nw_keys
expr_stmt|;
block|}
operator|*
name|rxkeyix
operator|=
operator|*
name|keyix
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_key_set_cb
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|union
name|sec_param
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ieee80211_key
modifier|*
name|k
init|=
operator|&
name|data
operator|->
name|key
decl_stmt|;
name|uint8_t
name|algo
decl_stmt|,
name|keyid
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
if|if
condition|(
name|k
operator|->
name|wk_keyix
operator|<
name|IEEE80211_WEP_NKID
condition|)
name|keyid
operator|=
name|k
operator|->
name|wk_keyix
expr_stmt|;
else|else
name|keyid
operator|=
literal|0
expr_stmt|;
comment|/* Map net80211 cipher to HW crypto algorithm. */
switch|switch
condition|(
name|k
operator|->
name|wk_cipher
operator|->
name|ic_cipher
condition|)
block|{
case|case
name|IEEE80211_CIPHER_WEP
case|:
if|if
condition|(
name|k
operator|->
name|wk_keylen
operator|<
literal|8
condition|)
name|algo
operator|=
name|R92C_CAM_ALGO_WEP40
expr_stmt|;
else|else
name|algo
operator|=
name|R92C_CAM_ALGO_WEP104
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_TKIP
case|:
name|algo
operator|=
name|R92C_CAM_ALGO_TKIP
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_AES_CCM
case|:
name|algo
operator|=
name|R92C_CAM_ALGO_AES
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: undefined cipher %d\n"
argument_list|,
name|__func__
argument_list|,
name|k
operator|->
name|wk_cipher
operator|->
name|ic_cipher
argument_list|)
expr_stmt|;
return|return;
block|}
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_KEY
argument_list|,
literal|"%s: keyix %d, keyid %d, algo %d/%d, flags %04X, len %d, "
literal|"macaddr %s\n"
argument_list|,
name|__func__
argument_list|,
name|k
operator|->
name|wk_keyix
argument_list|,
name|keyid
argument_list|,
name|k
operator|->
name|wk_cipher
operator|->
name|ic_cipher
argument_list|,
name|algo
argument_list|,
name|k
operator|->
name|wk_flags
argument_list|,
name|k
operator|->
name|wk_keylen
argument_list|,
name|ether_sprintf
argument_list|(
name|k
operator|->
name|wk_macaddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write key. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|urtwn_cam_write
argument_list|(
name|sc
argument_list|,
name|R92C_CAM_KEY
argument_list|(
name|k
operator|->
name|wk_keyix
argument_list|,
name|i
argument_list|)
argument_list|,
name|le32dec
argument_list|(
operator|&
name|k
operator|->
name|wk_key
index|[
name|i
operator|*
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
block|}
comment|/* Write CTL0 last since that will validate the CAM entry. */
name|error
operator|=
name|urtwn_cam_write
argument_list|(
name|sc
argument_list|,
name|R92C_CAM_CTL1
argument_list|(
name|k
operator|->
name|wk_keyix
argument_list|)
argument_list|,
name|le32dec
argument_list|(
operator|&
name|k
operator|->
name|wk_macaddr
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtwn_cam_write
argument_list|(
name|sc
argument_list|,
name|R92C_CAM_CTL0
argument_list|(
name|k
operator|->
name|wk_keyix
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_CAM_ALGO
argument_list|,
name|algo
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_CAM_KEYID
argument_list|,
name|keyid
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_CAM_MACLO
argument_list|,
name|le16dec
argument_list|(
operator|&
name|k
operator|->
name|wk_macaddr
index|[
literal|0
index|]
argument_list|)
argument_list|)
operator||
name|R92C_CAM_VALID
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
return|return;
name|fail
label|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s fails, error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_key_del_cb
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|union
name|sec_param
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ieee80211_key
modifier|*
name|k
init|=
operator|&
name|data
operator|->
name|key
decl_stmt|;
name|int
name|i
decl_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_KEY
argument_list|,
literal|"%s: keyix %d, flags %04X, macaddr %s\n"
argument_list|,
name|__func__
argument_list|,
name|k
operator|->
name|wk_keyix
argument_list|,
name|k
operator|->
name|wk_flags
argument_list|,
name|ether_sprintf
argument_list|(
name|k
operator|->
name|wk_macaddr
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_cam_write
argument_list|(
name|sc
argument_list|,
name|R92C_CAM_CTL0
argument_list|(
name|k
operator|->
name|wk_keyix
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtwn_cam_write
argument_list|(
name|sc
argument_list|,
name|R92C_CAM_CTL1
argument_list|(
name|k
operator|->
name|wk_keyix
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Clear key. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|urtwn_cam_write
argument_list|(
name|sc
argument_list|,
name|R92C_CAM_KEY
argument_list|(
name|k
operator|->
name|wk_keyix
argument_list|,
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|keys_bmap
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|k
operator|->
name|wk_keyix
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_key_set
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
specifier|const
name|struct
name|ieee80211_key
modifier|*
name|k
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|vap
operator|->
name|iv_ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|urtwn_vap
modifier|*
name|uvp
init|=
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
if|if
condition|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_SWCRYPT
condition|)
block|{
comment|/* Not for us. */
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|&
name|vap
operator|->
name|iv_nw_keys
index|[
literal|0
index|]
operator|<=
name|k
operator|&&
name|k
operator|<
operator|&
name|vap
operator|->
name|iv_nw_keys
index|[
name|IEEE80211_WEP_NKID
index|]
condition|)
block|{
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|uvp
operator|->
name|keys
index|[
name|k
operator|->
name|wk_keyix
index|]
operator|=
name|k
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 			 * The device was not started; 			 * the key will be installed later. 			 */
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|!
name|urtwn_cmd_sleepable
argument_list|(
name|sc
argument_list|,
name|k
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|k
argument_list|)
argument_list|,
name|urtwn_key_set_cb
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_key_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
specifier|const
name|struct
name|ieee80211_key
modifier|*
name|k
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|vap
operator|->
name|iv_ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|urtwn_vap
modifier|*
name|uvp
init|=
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
if|if
condition|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_SWCRYPT
condition|)
block|{
comment|/* Not for us. */
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|&
name|vap
operator|->
name|iv_nw_keys
index|[
literal|0
index|]
operator|<=
name|k
operator|&&
name|k
operator|<
operator|&
name|vap
operator|->
name|iv_nw_keys
index|[
name|IEEE80211_WEP_NKID
index|]
condition|)
block|{
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|uvp
operator|->
name|keys
index|[
name|k
operator|->
name|wk_keyix
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* All keys are removed on device reset. */
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|!
name|urtwn_cmd_sleepable
argument_list|(
name|sc
argument_list|,
name|k
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|k
argument_list|)
argument_list|,
name|urtwn_key_del_cb
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_tsf_task_adhoc
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|arg
decl_stmt|;
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|vap
operator|->
name|iv_ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ni
operator|=
name|ieee80211_ref_node
argument_list|(
name|vap
operator|->
name|iv_bss
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
expr_stmt|;
comment|/* Accept beacons with the same BSSID. */
name|urtwn_set_rx_bssid_all
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Enable synchronization. */
name|reg
operator|&=
operator|~
name|R92C_BCN_CTRL_DIS_TSF_UDT0
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Synchronize. */
name|usb_pause_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|hz
operator|*
name|ni
operator|->
name|ni_intval
operator|*
literal|5
operator|/
literal|1000
argument_list|)
expr_stmt|;
comment|/* Disable synchronization. */
name|reg
operator||=
name|R92C_BCN_CTRL_DIS_TSF_UDT0
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Remove beacon filter. */
name|urtwn_set_rx_bssid_all
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Enable beaconing. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MBID_NUM
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MBID_NUM
argument_list|)
operator||
name|R92C_MBID_TXBCN_RPT0
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_BCN_CTRL_EN_BCN
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_tsf_sync_enable
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|urtwn_vap
modifier|*
name|uvp
init|=
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
comment|/* Reset TSF. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_DUAL_TSF_RST
argument_list|,
name|R92C_DUAL_TSF_RST0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|vap
operator|->
name|iv_opmode
condition|)
block|{
case|case
name|IEEE80211_M_STA
case|:
comment|/* Enable TSF synchronization. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator|&
operator|~
name|R92C_BCN_CTRL_DIS_TSF_UDT0
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_IBSS
case|:
name|ieee80211_runtask
argument_list|(
name|ic
argument_list|,
operator|&
name|uvp
operator|->
name|tsf_task_adhoc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_HOSTAP
case|:
comment|/* Enable beaconing. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MBID_NUM
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MBID_NUM
argument_list|)
operator||
name|R92C_MBID_TXBCN_RPT0
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator||
name|R92C_BCN_CTRL_EN_BCN
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"undefined opmode %d\n"
argument_list|,
name|vap
operator|->
name|iv_opmode
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_get_tsf
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
modifier|*
name|buf
parameter_list|)
block|{
name|urtwn_read_region_1
argument_list|(
name|sc
argument_list|,
name|R92C_TSFTR
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|buf
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_led
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|led
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
if|if
condition|(
name|led
operator|==
name|URTWN_LED_LINK
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|)
operator|&
literal|0xf0
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|,
name|reg
operator||
literal|0x60
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|on
condition|)
block|{
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|)
operator|&
literal|0x90
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|,
name|reg
operator||
name|R92C_LEDCFG0_DIS
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_PINMUX_CFG
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_PINMUX_CFG
argument_list|)
operator|&
literal|0xfe
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG0
argument_list|)
operator|&
literal|0x70
expr_stmt|;
if|if
condition|(
operator|!
name|on
condition|)
name|reg
operator||=
name|R92C_LEDCFG0_DIS
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|ledlink
operator|=
name|on
expr_stmt|;
comment|/* Save LED state. */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_mode
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|mode
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MSR
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
name|R92C_MSR_MASK
operator|)
operator||
name|mode
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MSR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_ibss_recv_mgmt
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|subtype
parameter_list|,
specifier|const
name|struct
name|ieee80211_rx_stats
modifier|*
name|rxs
parameter_list|,
name|int
name|rssi
parameter_list|,
name|int
name|nf
parameter_list|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|vap
operator|->
name|iv_ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|urtwn_vap
modifier|*
name|uvp
init|=
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|uint64_t
name|ni_tstamp
decl_stmt|,
name|curr_tstamp
decl_stmt|;
name|uvp
operator|->
name|recv_mgmt
argument_list|(
name|ni
argument_list|,
name|m
argument_list|,
name|subtype
argument_list|,
name|rxs
argument_list|,
name|rssi
argument_list|,
name|nf
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_RUN
operator|&&
operator|(
name|subtype
operator|==
name|IEEE80211_FC0_SUBTYPE_BEACON
operator|||
name|subtype
operator|==
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
operator|)
condition|)
block|{
name|ni_tstamp
operator|=
name|le64toh
argument_list|(
name|ni
operator|->
name|ni_tstamp
operator|.
name|tsf
argument_list|)
expr_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_get_tsf
argument_list|(
name|sc
argument_list|,
operator|&
name|curr_tstamp
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|curr_tstamp
operator|=
name|le64toh
argument_list|(
name|curr_tstamp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni_tstamp
operator|>=
name|curr_tstamp
condition|)
operator|(
name|void
operator|)
name|ieee80211_ibss_merge
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|enum
name|ieee80211_state
name|nstate
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|struct
name|urtwn_vap
modifier|*
name|uvp
init|=
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|enum
name|ieee80211_state
name|ostate
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|uint8_t
name|mode
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|ostate
operator|=
name|vap
operator|->
name|iv_state
expr_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_STATE
argument_list|,
literal|"%s -> %s\n"
argument_list|,
name|ieee80211_state_name
index|[
name|ostate
index|]
argument_list|,
name|ieee80211_state_name
index|[
name|nstate
index|]
argument_list|)
expr_stmt|;
name|IEEE80211_UNLOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|ostate
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
comment|/* Stop calibration. */
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_calib_to
argument_list|)
expr_stmt|;
comment|/* Turn link LED off. */
name|urtwn_set_led
argument_list|(
name|sc
argument_list|,
name|URTWN_LED_LINK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set media status to 'No Link'. */
name|urtwn_set_mode
argument_list|(
name|sc
argument_list|,
name|R92C_MSR_NOLINK
argument_list|)
expr_stmt|;
comment|/* Stop Rx of data frames. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable TSF synchronization. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
operator|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator|&
operator|~
name|R92C_BCN_CTRL_EN_BCN
operator|)
operator||
name|R92C_BCN_CTRL_DIS_TSF_UDT0
argument_list|)
expr_stmt|;
comment|/* Disable beaconing. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MBID_NUM
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MBID_NUM
argument_list|)
operator|&
operator|~
name|R92C_MBID_TXBCN_RPT0
argument_list|)
expr_stmt|;
comment|/* Reset TSF. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_DUAL_TSF_RST
argument_list|,
name|R92C_DUAL_TSF_RST0
argument_list|)
expr_stmt|;
comment|/* Reset EDCA parameters. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VO_PARAM
argument_list|,
literal|0x002f3217
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VI_PARAM
argument_list|,
literal|0x005e4317
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BE_PARAM
argument_list|,
literal|0x00105320
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BK_PARAM
argument_list|,
literal|0x0000a444
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|nstate
condition|)
block|{
case|case
name|IEEE80211_S_INIT
case|:
comment|/* Turn link LED off. */
name|urtwn_set_led
argument_list|(
name|sc
argument_list|,
name|URTWN_LED_LINK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_S_SCAN
case|:
comment|/* Pause AC Tx queues. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|)
operator||
name|R92C_TX_QUEUE_AC
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_S_AUTH
case|:
name|urtwn_set_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_S_RUN
case|:
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_MONITOR
condition|)
block|{
comment|/* Turn link LED on. */
name|urtwn_set_led
argument_list|(
name|sc
argument_list|,
name|URTWN_LED_LINK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|ni
operator|=
name|ieee80211_ref_node
argument_list|(
name|vap
operator|->
name|iv_bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_bsschan
operator|==
name|IEEE80211_CHAN_ANYC
operator|||
name|ni
operator|->
name|ni_chan
operator|==
name|IEEE80211_CHAN_ANYC
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not move to RUN state\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|end_run
goto|;
block|}
switch|switch
condition|(
name|vap
operator|->
name|iv_opmode
condition|)
block|{
case|case
name|IEEE80211_M_STA
case|:
name|mode
operator|=
name|R92C_MSR_INFRA
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_IBSS
case|:
name|mode
operator|=
name|R92C_MSR_ADHOC
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_HOSTAP
case|:
name|mode
operator|=
name|R92C_MSR_AP
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"undefined opmode %d\n"
argument_list|,
name|vap
operator|->
name|iv_opmode
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|end_run
goto|;
block|}
comment|/* Set media status to 'Associated'. */
name|urtwn_set_mode
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
comment|/* Set BSSID. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_BSSID
operator|+
literal|0
argument_list|,
name|le32dec
argument_list|(
operator|&
name|ni
operator|->
name|ni_bssid
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_BSSID
operator|+
literal|4
argument_list|,
name|le16dec
argument_list|(
operator|&
name|ni
operator|->
name|ni_bssid
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIRTS_RATE_SEL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
comment|/* 802.11b/g */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIRTS_RATE_SEL
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* Enable Rx of data frames. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* Flush all AC queues. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set beacon interval. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_INTERVAL
argument_list|,
name|ni
operator|->
name|ni_intval
argument_list|)
expr_stmt|;
comment|/* Allow Rx from our BSSID only. */
if|if
condition|(
name|ic
operator|->
name|ic_promisc
operator|==
literal|0
condition|)
block|{
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|!=
name|IEEE80211_M_HOSTAP
condition|)
block|{
name|reg
operator||=
name|R92C_RCR_CBSSID_DATA
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|!=
name|IEEE80211_M_IBSS
condition|)
name|reg
operator||=
name|R92C_RCR_CBSSID_BCN
expr_stmt|;
block|}
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_HOSTAP
operator|||
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_IBSS
condition|)
block|{
name|error
operator|=
name|urtwn_setup_beacon
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unable to push beacon into the chip, "
literal|"error %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|end_run
goto|;
block|}
block|}
comment|/* Enable TSF synchronization. */
name|urtwn_tsf_sync_enable
argument_list|(
name|sc
argument_list|,
name|vap
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_CCK
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_OFDM
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SPEC_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_SPEC_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_R2T_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_T2T_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* Intialize rate adaptation. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
name|urtwn_ra_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Turn link LED on. */
name|urtwn_set_led
argument_list|(
name|sc
argument_list|,
name|URTWN_LED_LINK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|avg_pwdb
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Reset average RSSI. */
comment|/* Reset temperature calibration state machine. */
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|URTWN_TEMP_MEASURED
expr_stmt|;
name|sc
operator|->
name|thcal_lctemp
operator|=
literal|0
expr_stmt|;
comment|/* Start periodic calibration. */
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_calib_to
argument_list|,
literal|2
operator|*
name|hz
argument_list|,
name|urtwn_calib_to
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|end_run
label|:
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|IEEE80211_LOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|!=
literal|0
condition|?
name|error
else|:
name|uvp
operator|->
name|newstate
argument_list|(
name|vap
argument_list|,
name|nstate
argument_list|,
name|arg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_calib_to
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
comment|/* Do it in a process context. */
name|urtwn_cmd_sleepable
argument_list|(
name|sc
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|urtwn_calib_cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_calib_cb
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|union
name|sec_param
modifier|*
name|data
parameter_list|)
block|{
comment|/* Do temperature compensation. */
name|urtwn_temp_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MSR
argument_list|)
operator|&
name|R92C_MSR_MASK
operator|)
operator|!=
name|R92C_MSR_NOLINK
condition|)
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_calib_to
argument_list|,
literal|2
operator|*
name|hz
argument_list|,
name|urtwn_calib_to
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_watchdog
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_txtimer
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|sc
operator|->
name|sc_txtimer
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"device timeout\n"
argument_list|)
expr_stmt|;
name|counter_u64_add
argument_list|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_oerrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|urtwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_update_avgrssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|rate
parameter_list|,
name|int8_t
name|rssi
parameter_list|)
block|{
name|int
name|pwdb
decl_stmt|;
comment|/* Convert antenna signal to percentage. */
if|if
condition|(
name|rssi
operator|<=
operator|-
literal|100
operator|||
name|rssi
operator|>=
literal|20
condition|)
name|pwdb
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|rssi
operator|>=
literal|0
condition|)
name|pwdb
operator|=
literal|100
expr_stmt|;
else|else
name|pwdb
operator|=
literal|100
operator|+
name|rssi
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
if|if
condition|(
name|rate
operator|<=
name|URTWN_RIDX_CCK11
condition|)
block|{
comment|/* CCK gain is smaller than OFDM/MCS gain. */
name|pwdb
operator|+=
literal|6
expr_stmt|;
if|if
condition|(
name|pwdb
operator|>
literal|100
condition|)
name|pwdb
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|pwdb
operator|<=
literal|14
condition|)
name|pwdb
operator|-=
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|26
condition|)
name|pwdb
operator|-=
literal|8
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|34
condition|)
name|pwdb
operator|-=
literal|6
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|42
condition|)
name|pwdb
operator|-=
literal|2
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|avg_pwdb
operator|==
operator|-
literal|1
condition|)
comment|/* Init. */
name|sc
operator|->
name|avg_pwdb
operator|=
name|pwdb
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|avg_pwdb
operator|<
name|pwdb
condition|)
name|sc
operator|->
name|avg_pwdb
operator|=
operator|(
operator|(
name|sc
operator|->
name|avg_pwdb
operator|*
literal|19
operator|+
name|pwdb
operator|)
operator|/
literal|20
operator|)
operator|+
literal|1
expr_stmt|;
else|else
name|sc
operator|->
name|avg_pwdb
operator|=
operator|(
operator|(
name|sc
operator|->
name|avg_pwdb
operator|*
literal|19
operator|+
name|pwdb
operator|)
operator|/
literal|20
operator|)
expr_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_RSSI
argument_list|,
literal|"%s: PWDB %d, EMA %d\n"
argument_list|,
name|__func__
argument_list|,
name|pwdb
argument_list|,
name|sc
operator|->
name|avg_pwdb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int8_t
name|urtwn_get_rssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|rate
parameter_list|,
name|void
modifier|*
name|physt
parameter_list|)
block|{
specifier|static
specifier|const
name|int8_t
name|cckoff
index|[]
init|=
block|{
literal|16
block|,
operator|-
literal|12
block|,
operator|-
literal|26
block|,
operator|-
literal|46
block|}
decl_stmt|;
name|struct
name|r92c_rx_phystat
modifier|*
name|phy
decl_stmt|;
name|struct
name|r92c_rx_cck
modifier|*
name|cck
decl_stmt|;
name|uint8_t
name|rpt
decl_stmt|;
name|int8_t
name|rssi
decl_stmt|;
if|if
condition|(
name|rate
operator|<=
name|URTWN_RIDX_CCK11
condition|)
block|{
name|cck
operator|=
operator|(
expr|struct
name|r92c_rx_cck
operator|*
operator|)
name|physt
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_FLAG_CCK_HIPWR
condition|)
block|{
name|rpt
operator|=
operator|(
name|cck
operator|->
name|agc_rpt
operator|>>
literal|5
operator|)
operator|&
literal|0x3
expr_stmt|;
name|rssi
operator|=
operator|(
name|cck
operator|->
name|agc_rpt
operator|&
literal|0x1f
operator|)
operator|<<
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rpt
operator|=
operator|(
name|cck
operator|->
name|agc_rpt
operator|>>
literal|6
operator|)
operator|&
literal|0x3
expr_stmt|;
name|rssi
operator|=
name|cck
operator|->
name|agc_rpt
operator|&
literal|0x3e
expr_stmt|;
block|}
name|rssi
operator|=
name|cckoff
index|[
name|rpt
index|]
operator|-
name|rssi
expr_stmt|;
block|}
else|else
block|{
comment|/* OFDM/HT. */
name|phy
operator|=
operator|(
expr|struct
name|r92c_rx_phystat
operator|*
operator|)
name|physt
expr_stmt|;
name|rssi
operator|=
operator|(
operator|(
name|le32toh
argument_list|(
name|phy
operator|->
name|phydw1
argument_list|)
operator|>>
literal|1
operator|)
operator|&
literal|0x7f
operator|)
operator|-
literal|110
expr_stmt|;
block|}
return|return
operator|(
name|rssi
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int8_t
name|urtwn_r88e_get_rssi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|rate
parameter_list|,
name|void
modifier|*
name|physt
parameter_list|)
block|{
name|struct
name|r92c_rx_phystat
modifier|*
name|phy
decl_stmt|;
name|struct
name|r88e_rx_cck
modifier|*
name|cck
decl_stmt|;
name|uint8_t
name|cck_agc_rpt
decl_stmt|,
name|lna_idx
decl_stmt|,
name|vga_idx
decl_stmt|;
name|int8_t
name|rssi
decl_stmt|;
name|rssi
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rate
operator|<=
name|URTWN_RIDX_CCK11
condition|)
block|{
name|cck
operator|=
operator|(
expr|struct
name|r88e_rx_cck
operator|*
operator|)
name|physt
expr_stmt|;
name|cck_agc_rpt
operator|=
name|cck
operator|->
name|agc_rpt
expr_stmt|;
name|lna_idx
operator|=
operator|(
name|cck_agc_rpt
operator|&
literal|0xe0
operator|)
operator|>>
literal|5
expr_stmt|;
name|vga_idx
operator|=
name|cck_agc_rpt
operator|&
literal|0x1f
expr_stmt|;
switch|switch
condition|(
name|lna_idx
condition|)
block|{
case|case
literal|7
case|:
if|if
condition|(
name|vga_idx
operator|<=
literal|27
condition|)
name|rssi
operator|=
operator|-
literal|100
operator|+
literal|2
operator|*
operator|(
literal|27
operator|-
name|vga_idx
operator|)
expr_stmt|;
else|else
name|rssi
operator|=
operator|-
literal|100
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|rssi
operator|=
operator|-
literal|48
operator|+
literal|2
operator|*
operator|(
literal|2
operator|-
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|rssi
operator|=
operator|-
literal|42
operator|+
literal|2
operator|*
operator|(
literal|7
operator|-
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|rssi
operator|=
operator|-
literal|36
operator|+
literal|2
operator|*
operator|(
literal|7
operator|-
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|rssi
operator|=
operator|-
literal|24
operator|+
literal|2
operator|*
operator|(
literal|7
operator|-
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rssi
operator|=
operator|-
literal|12
operator|+
literal|2
operator|*
operator|(
literal|5
operator|-
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|rssi
operator|=
literal|8
operator|-
operator|(
literal|2
operator|*
name|vga_idx
operator|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
name|rssi
operator|=
literal|14
operator|-
operator|(
literal|2
operator|*
name|vga_idx
operator|)
expr_stmt|;
break|break;
block|}
name|rssi
operator|+=
literal|6
expr_stmt|;
block|}
else|else
block|{
comment|/* OFDM/HT. */
name|phy
operator|=
operator|(
expr|struct
name|r92c_rx_phystat
operator|*
operator|)
name|physt
expr_stmt|;
name|rssi
operator|=
operator|(
operator|(
name|le32toh
argument_list|(
name|phy
operator|->
name|phydw1
argument_list|)
operator|>>
literal|1
operator|)
operator|&
literal|0x7f
operator|)
operator|-
literal|110
expr_stmt|;
block|}
return|return
operator|(
name|rssi
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_tx_data
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|urtwn_data
modifier|*
name|data
parameter_list|)
block|{
specifier|const
name|struct
name|ieee80211_txparam
modifier|*
name|tp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
init|=
name|NULL
decl_stmt|;
name|struct
name|ieee80211_channel
modifier|*
name|chan
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|r92c_tx_desc
modifier|*
name|txd
decl_stmt|;
name|uint8_t
name|macid
decl_stmt|,
name|raid
decl_stmt|,
name|rate
decl_stmt|,
name|ridx
decl_stmt|,
name|type
decl_stmt|,
name|tid
decl_stmt|,
name|qos
decl_stmt|,
name|qsel
decl_stmt|;
name|int
name|hasqos
decl_stmt|,
name|ismcast
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
name|hasqos
operator|=
name|IEEE80211_QOS_HAS_SEQ
argument_list|(
name|wh
argument_list|)
expr_stmt|;
name|ismcast
operator|=
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
expr_stmt|;
comment|/* Select TX ring for this frame. */
if|if
condition|(
name|hasqos
condition|)
block|{
name|qos
operator|=
operator|(
operator|(
specifier|const
expr|struct
name|ieee80211_qosframe
operator|*
operator|)
name|wh
operator|)
operator|->
name|i_qos
index|[
literal|0
index|]
expr_stmt|;
name|tid
operator|=
name|qos
operator|&
name|IEEE80211_QOS_TID
expr_stmt|;
block|}
else|else
block|{
name|qos
operator|=
literal|0
expr_stmt|;
name|tid
operator|=
literal|0
expr_stmt|;
block|}
name|chan
operator|=
operator|(
name|ni
operator|->
name|ni_chan
operator|!=
name|IEEE80211_CHAN_ANYC
operator|)
condition|?
name|ni
operator|->
name|ni_chan
else|:
name|ic
operator|->
name|ic_curchan
expr_stmt|;
name|tp
operator|=
operator|&
name|vap
operator|->
name|iv_txparms
index|[
name|ieee80211_chan2mode
argument_list|(
name|chan
argument_list|)
index|]
expr_stmt|;
comment|/* Choose a TX rate index. */
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_MGT
condition|)
name|rate
operator|=
name|tp
operator|->
name|mgmtrate
expr_stmt|;
elseif|else
if|if
condition|(
name|ismcast
condition|)
name|rate
operator|=
name|tp
operator|->
name|mcastrate
expr_stmt|;
elseif|else
if|if
condition|(
name|tp
operator|->
name|ucastrate
operator|!=
name|IEEE80211_FIXED_RATE_NONE
condition|)
name|rate
operator|=
name|tp
operator|->
name|ucastrate
expr_stmt|;
elseif|else
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_EAPOL
condition|)
name|rate
operator|=
name|tp
operator|->
name|mgmtrate
expr_stmt|;
else|else
block|{
if|if
condition|(
name|URTWN_CHIP_HAS_RATECTL
argument_list|(
name|sc
argument_list|)
condition|)
block|{
comment|/* XXX pass pktlen */
operator|(
name|void
operator|)
name|ieee80211_ratectl_rate
argument_list|(
name|ni
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rate
operator|=
name|ni
operator|->
name|ni_txrate
expr_stmt|;
block|}
else|else
block|{
comment|/* XXX TODO: drop the default rate for 11b/11g? */
if|if
condition|(
name|ni
operator|->
name|ni_flags
operator|&
name|IEEE80211_NODE_HT
condition|)
name|rate
operator|=
name|IEEE80211_RATE_MCS
operator||
literal|0x4
expr_stmt|;
comment|/* MCS4 */
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|!=
name|IEEE80211_MODE_11B
condition|)
name|rate
operator|=
literal|108
expr_stmt|;
else|else
name|rate
operator|=
literal|22
expr_stmt|;
block|}
block|}
comment|/* 	 * XXX TODO: this should be per-node, for 11b versus 11bg 	 * nodes in hostap mode 	 */
name|ridx
operator|=
name|rate2ridx
argument_list|(
name|rate
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni
operator|->
name|ni_flags
operator|&
name|IEEE80211_NODE_HT
condition|)
name|raid
operator|=
name|R92C_RAID_11GN
expr_stmt|;
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|!=
name|IEEE80211_MODE_11B
condition|)
name|raid
operator|=
name|R92C_RAID_11BG
expr_stmt|;
else|else
name|raid
operator|=
name|R92C_RAID_11B
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
block|{
name|k
operator|=
name|ieee80211_crypto_encap
argument_list|(
name|ni
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"ieee80211_crypto_encap returns NULL.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* in case packet header moved, reset pointer */
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
block|}
comment|/* Fill Tx descriptor. */
name|txd
operator|=
operator|(
expr|struct
name|r92c_tx_desc
operator|*
operator|)
name|data
operator|->
name|buf
expr_stmt|;
name|memset
argument_list|(
name|txd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw0
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW0_OFFSET
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
argument_list|)
operator||
name|R92C_TXDW0_OWN
operator||
name|R92C_TXDW0_FSG
operator||
name|R92C_TXDW0_LSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ismcast
condition|)
name|txd
operator|->
name|txdw0
operator||=
name|htole32
argument_list|(
name|R92C_TXDW0_BMCAST
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ismcast
condition|)
block|{
comment|/* Unicast frame, check if an ACK is expected. */
if|if
condition|(
operator|!
name|qos
operator|||
operator|(
name|qos
operator|&
name|IEEE80211_QOS_ACKPOLICY
operator|)
operator|!=
name|IEEE80211_QOS_ACKPOLICY_NOACK
condition|)
block|{
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|R92C_TXDW5_RTY_LMT_ENA
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_RTY_LMT
argument_list|,
name|tp
operator|->
name|maxretry
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|struct
name|urtwn_node
modifier|*
name|un
init|=
name|URTWN_NODE
argument_list|(
name|ni
argument_list|)
decl_stmt|;
name|macid
operator|=
name|un
operator|->
name|id
expr_stmt|;
block|}
else|else
name|macid
operator|=
name|URTWN_MACID_BSS
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_DATA
condition|)
block|{
name|qsel
operator|=
name|tid
operator|%
name|URTWN_MAX_TID
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|txd
operator|->
name|txdw2
operator||=
name|htole32
argument_list|(
name|R88E_TXDW2_AGGBK
operator||
name|R88E_TXDW2_CCX_RPT
argument_list|)
expr_stmt|;
block|}
else|else
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|R92C_TXDW1_AGGBK
argument_list|)
expr_stmt|;
comment|/* protmode, non-HT */
comment|/* XXX TODO: noack frames? */
if|if
condition|(
operator|(
name|rate
operator|&
literal|0x80
operator|)
operator|==
literal|0
operator|&&
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_USEPROT
operator|)
condition|)
block|{
switch|switch
condition|(
name|ic
operator|->
name|ic_protmode
condition|)
block|{
case|case
name|IEEE80211_PROT_CTSONLY
case|:
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_CTS2SELF
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_PROT_RTSCTS
case|:
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_RTSEN
operator||
name|R92C_TXDW4_HWRTSEN
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
comment|/* protmode, HT */
comment|/* XXX TODO: noack frames? */
if|if
condition|(
operator|(
name|rate
operator|&
literal|0x80
operator|)
operator|&&
operator|(
name|ic
operator|->
name|ic_htprotmode
operator|==
name|IEEE80211_PROT_RTSCTS
operator|)
condition|)
block|{
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_RTSEN
operator||
name|R92C_TXDW4_HWRTSEN
argument_list|)
expr_stmt|;
block|}
comment|/* XXX TODO: rtsrate is configurable? 24mbit may 			 * be a bit high for RTS rate? */
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW4_RTSRATE
argument_list|,
name|URTWN_RIDX_OFDM24
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
literal|0x0001ff00
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* IEEE80211_FC0_TYPE_MGT */
name|qsel
operator|=
name|R92C_TXDW1_QSEL_MGNT
expr_stmt|;
block|}
else|else
block|{
name|macid
operator|=
name|URTWN_MACID_BC
expr_stmt|;
name|qsel
operator|=
name|R92C_TXDW1_QSEL_MGNT
expr_stmt|;
block|}
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_QSEL
argument_list|,
name|qsel
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_RAID
argument_list|,
name|raid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX TODO: 40MHZ flag? */
comment|/* XXX TODO: AMPDU flag? (AGG_ENABLE or AGG_BREAK?) Density shift? */
comment|/* XXX Short preamble? */
comment|/* XXX Short-GI? */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R88E_TXDW1_MACID
argument_list|,
name|macid
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_MACID
argument_list|,
name|macid
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_DATARATE
argument_list|,
name|ridx
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Force this rate if needed. */
if|if
condition|(
name|URTWN_CHIP_HAS_RATECTL
argument_list|(
name|sc
argument_list|)
operator|||
name|ismcast
operator|||
operator|(
name|tp
operator|->
name|ucastrate
operator|!=
name|IEEE80211_FIXED_RATE_NONE
operator|)
operator|||
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_EAPOL
operator|)
operator|||
name|type
operator|!=
name|IEEE80211_FC0_TYPE_DATA
condition|)
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_DRVRATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hasqos
condition|)
block|{
comment|/* Use HW sequence numbering for non-QoS frames. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|txd
operator|->
name|txdseq
operator|=
name|htole16
argument_list|(
name|R88E_TXDSEQ_HWSEQ_EN
argument_list|)
expr_stmt|;
else|else
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_HWSEQ_EN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Set sequence number. */
name|txd
operator|->
name|txdseq
operator|=
name|htole16
argument_list|(
name|M_SEQNO_GET
argument_list|(
name|m
argument_list|)
operator|%
name|IEEE80211_SEQ_RANGE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|k
operator|!=
name|NULL
operator|&&
operator|!
operator|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_SWCRYPT
operator|)
condition|)
block|{
name|uint8_t
name|cipher
decl_stmt|;
switch|switch
condition|(
name|k
operator|->
name|wk_cipher
operator|->
name|ic_cipher
condition|)
block|{
case|case
name|IEEE80211_CIPHER_WEP
case|:
case|case
name|IEEE80211_CIPHER_TKIP
case|:
name|cipher
operator|=
name|R92C_TXDW1_CIPHER_RC4
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_AES_CCM
case|:
name|cipher
operator|=
name|R92C_TXDW1_CIPHER_AES
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: unknown cipher %d\n"
argument_list|,
name|__func__
argument_list|,
name|k
operator|->
name|wk_cipher
operator|->
name|ic_cipher
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_CIPHER
argument_list|,
name|cipher
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ieee80211_radiotap_active_vap
argument_list|(
name|vap
argument_list|)
condition|)
block|{
name|struct
name|urtwn_tx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_txtap
decl_stmt|;
name|tap
operator|->
name|wt_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|k
operator|!=
name|NULL
condition|)
name|tap
operator|->
name|wt_flags
operator||=
name|IEEE80211_RADIOTAP_F_WEP
expr_stmt|;
name|ieee80211_radiotap_tx
argument_list|(
name|vap
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
name|urtwn_tx_start
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|type
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_tx_raw
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|urtwn_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
init|=
name|NULL
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|r92c_tx_desc
modifier|*
name|txd
decl_stmt|;
name|uint8_t
name|cipher
decl_stmt|,
name|ridx
decl_stmt|,
name|type
decl_stmt|;
comment|/* Encrypt the frame if need be. */
name|cipher
operator|=
name|R92C_TXDW1_CIPHER_NONE
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|ibp_flags
operator|&
name|IEEE80211_BPF_CRYPTO
condition|)
block|{
comment|/* Retrieve key for TX. */
name|k
operator|=
name|ieee80211_crypto_encap
argument_list|(
name|ni
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|k
operator|->
name|wk_flags
operator|&
name|IEEE80211_KEY_SWCRYPT
operator|)
condition|)
block|{
switch|switch
condition|(
name|k
operator|->
name|wk_cipher
operator|->
name|ic_cipher
condition|)
block|{
case|case
name|IEEE80211_CIPHER_WEP
case|:
case|case
name|IEEE80211_CIPHER_TKIP
case|:
name|cipher
operator|=
name|R92C_TXDW1_CIPHER_RC4
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_AES_CCM
case|:
name|cipher
operator|=
name|R92C_TXDW1_CIPHER_AES
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: unknown cipher %d\n"
argument_list|,
name|__func__
argument_list|,
name|k
operator|->
name|wk_cipher
operator|->
name|ic_cipher
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
block|}
comment|/* XXX TODO: 11n checks, matching urtwn_tx_data() */
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
comment|/* Fill Tx descriptor. */
name|txd
operator|=
operator|(
expr|struct
name|r92c_tx_desc
operator|*
operator|)
name|data
operator|->
name|buf
expr_stmt|;
name|memset
argument_list|(
name|txd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw0
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW0_OFFSET
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
argument_list|)
operator||
name|R92C_TXDW0_OWN
operator||
name|R92C_TXDW0_FSG
operator||
name|R92C_TXDW0_LSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
condition|)
name|txd
operator|->
name|txdw0
operator||=
name|htole32
argument_list|(
name|R92C_TXDW0_BMCAST
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|params
operator|->
name|ibp_flags
operator|&
name|IEEE80211_BPF_NOACK
operator|)
operator|==
literal|0
condition|)
block|{
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|R92C_TXDW5_RTY_LMT_ENA
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_RTY_LMT
argument_list|,
name|params
operator|->
name|ibp_try0
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|ibp_flags
operator|&
name|IEEE80211_BPF_RTS
condition|)
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_RTSEN
operator||
name|R92C_TXDW4_HWRTSEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|ibp_flags
operator|&
name|IEEE80211_BPF_CTS
condition|)
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_CTS2SELF
argument_list|)
expr_stmt|;
if|if
condition|(
name|txd
operator|->
name|txdw4
operator|&
name|htole32
argument_list|(
name|R92C_TXDW4_RTSEN
operator||
name|R92C_TXDW4_CTS2SELF
argument_list|)
condition|)
block|{
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW4_RTSRATE
argument_list|,
name|URTWN_RIDX_OFDM24
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R88E_TXDW1_MACID
argument_list|,
name|URTWN_MACID_BC
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_MACID
argument_list|,
name|URTWN_MACID_BC
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX TODO: rate index/config (RAID) for 11n? */
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_QSEL
argument_list|,
name|R92C_TXDW1_QSEL_MGNT
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_CIPHER
argument_list|,
name|cipher
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Choose a TX rate index. */
name|ridx
operator|=
name|rate2ridx
argument_list|(
name|params
operator|->
name|ibp_rate0
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_DATARATE
argument_list|,
name|ridx
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
literal|0x0001ff00
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_DRVRATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IEEE80211_QOS_HAS_SEQ
argument_list|(
name|wh
argument_list|)
condition|)
block|{
comment|/* Use HW sequence numbering for non-QoS frames. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|txd
operator|->
name|txdseq
operator|=
name|htole16
argument_list|(
name|R88E_TXDSEQ_HWSEQ_EN
argument_list|)
expr_stmt|;
else|else
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_HWSEQ_EN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Set sequence number. */
name|txd
operator|->
name|txdseq
operator|=
name|htole16
argument_list|(
name|M_SEQNO_GET
argument_list|(
name|m
argument_list|)
operator|%
name|IEEE80211_SEQ_RANGE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ieee80211_radiotap_active_vap
argument_list|(
name|vap
argument_list|)
condition|)
block|{
name|struct
name|urtwn_tx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_txtap
decl_stmt|;
name|tap
operator|->
name|wt_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|k
operator|!=
name|NULL
condition|)
name|tap
operator|->
name|wt_flags
operator||=
name|IEEE80211_RADIOTAP_F_WEP
expr_stmt|;
name|ieee80211_radiotap_tx
argument_list|(
name|vap
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
name|urtwn_tx_start
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|type
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_tx_start
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|uint8_t
name|type
parameter_list|,
name|struct
name|urtwn_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|usb_xfer
modifier|*
name|xfer
decl_stmt|;
name|struct
name|r92c_tx_desc
modifier|*
name|txd
decl_stmt|;
name|uint16_t
name|ac
decl_stmt|,
name|sum
decl_stmt|;
name|int
name|i
decl_stmt|,
name|xferlen
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ac
operator|=
name|M_WME_GETAC
argument_list|(
name|m
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|IEEE80211_FC0_TYPE_CTL
case|:
case|case
name|IEEE80211_FC0_TYPE_MGT
case|:
name|xfer
operator|=
name|sc
operator|->
name|sc_xfer
index|[
name|URTWN_BULK_TX_VO
index|]
expr_stmt|;
break|break;
default|default:
name|xfer
operator|=
name|sc
operator|->
name|sc_xfer
index|[
name|wme2queue
index|[
name|ac
index|]
operator|.
name|qid
index|]
expr_stmt|;
break|break;
block|}
name|txd
operator|=
operator|(
expr|struct
name|r92c_tx_desc
operator|*
operator|)
name|data
operator|->
name|buf
expr_stmt|;
name|txd
operator|->
name|txdw0
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW0_PKTLEN
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Compute Tx descriptor checksum. */
name|sum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
operator|/
literal|2
condition|;
name|i
operator|++
control|)
name|sum
operator|^=
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|txd
operator|)
index|[
name|i
index|]
expr_stmt|;
name|txd
operator|->
name|txdsum
operator|=
name|sum
expr_stmt|;
comment|/* NB: already little endian. */
name|xferlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
operator|+
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|txd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|data
operator|->
name|buflen
operator|=
name|xferlen
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|m
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_pending
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_transmit
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
name|mbufq_enqueue
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|urtwn_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_start
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|urtwn_data
modifier|*
name|bf
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|m
operator|=
name|mbufq_dequeue
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|bf
operator|=
name|urtwn_getbuf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
block|{
name|mbufq_prepend
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
name|ni
operator|=
operator|(
expr|struct
name|ieee80211_node
operator|*
operator|)
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|NULL
expr_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_XMIT
argument_list|,
literal|"%s: called; m=%p\n"
argument_list|,
name|__func__
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|urtwn_tx_data
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
name|bf
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ni
operator|->
name|ni_vap
operator|->
name|iv_ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|bf
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|sc_txtimer
operator|=
literal|5
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|urtwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_parent
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_DETACHED
condition|)
block|{
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_nrunning
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|urtwn_init
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
if|if
condition|(
name|vap
operator|!=
name|NULL
condition|)
name|ieee80211_stop
argument_list|(
name|vap
argument_list|)
expr_stmt|;
block|}
else|else
name|ieee80211_start_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
block|}
else|else
name|urtwn_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|urtwn_power_on
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
name|sc
operator|->
name|sc_power_on
argument_list|(
name|sc
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_r92c_power_on
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|usb_error_t
name|error
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Wait for autoload done bit. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator|&
name|R92C_APS_FSMCO_PFM_ALDN
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for chip autoload\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Unlock ISO/CLK/Power control register. */
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RSV_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Move SPS into PWM mode. */
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SPS0_CTRL
argument_list|,
literal|0x2b
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LDOV12D_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_LDOV12D_CTRL_LDV12_EN
operator|)
condition|)
block|{
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LDOV12D_CTRL
argument_list|,
name|reg
operator||
name|R92C_LDOV12D_CTRL_LDV12_EN
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|)
operator|&
operator|~
name|R92C_SYS_ISO_CTRL_MD2PP
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* Auto enable WLAN. */
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator||
name|R92C_APS_FSMCO_APFM_ONMAC
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator|&
name|R92C_APS_FSMCO_APFM_ONMAC
operator|)
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for MAC auto ON\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Enable radio, GPIO and LED functions. */
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|R92C_APS_FSMCO_AFSM_HSUS
operator||
name|R92C_APS_FSMCO_PDN_EN
operator||
name|R92C_APS_FSMCO_PFM_ALDN
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Release RF digital isolation. */
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|)
operator|&
operator|~
name|R92C_SYS_ISO_CTRL_DIOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Initialize MAC. */
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|)
operator|&
operator|~
name|R92C_APSD_CTRL_OFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|200
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|)
operator|&
name|R92C_APSD_CTRL_OFF_STATUS
operator|)
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|200
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for MAC initialization\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Enable MAC DMA/WMAC/SCHEDULE/SEC blocks. */
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_CR_HCI_TXDMA_EN
operator||
name|R92C_CR_HCI_RXDMA_EN
operator||
name|R92C_CR_TXDMA_EN
operator||
name|R92C_CR_RXDMA_EN
operator||
name|R92C_CR_PROTOCOL_EN
operator||
name|R92C_CR_SCHEDULE_EN
operator||
name|R92C_CR_MACTXEN
operator||
name|R92C_CR_MACRXEN
operator||
name|R92C_CR_ENSEC
expr_stmt|;
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0xfe10
argument_list|,
literal|0x19
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_r88e_power_on
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|usb_error_t
name|error
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Wait for power ready bit. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|5000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator|&
name|R92C_APS_FSMCO_SUS_HOST
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|5000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for chip power up\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Reset BB. */
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
operator|&
operator|~
operator|(
name|R92C_SYS_FUNC_EN_BBRSTB
operator||
name|R92C_SYS_FUNC_EN_BB_GLB_RST
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
operator|+
literal|2
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
operator|+
literal|2
argument_list|)
operator||
literal|0x80
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Disable HWPDN. */
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator|&
operator|~
name|R92C_APS_FSMCO_APDM_HPDN
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Disable WL suspend. */
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator|&
operator|~
operator|(
name|R92C_APS_FSMCO_AFSM_HSUS
operator||
name|R92C_APS_FSMCO_AFSM_PCIE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator||
name|R92C_APS_FSMCO_APFM_ONMAC
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|5000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator|&
name|R92C_APS_FSMCO_APFM_ONMAC
operator|)
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|5000
condition|)
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
comment|/* Enable LDO normal mode. */
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LPLDO_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LPLDO_CTRL
argument_list|)
operator|&
operator|~
name|R92C_LPLDO_CTRL_SLEEP
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Enable MAC DMA/WMAC/SCHEDULE/SEC blocks. */
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_CR_HCI_TXDMA_EN
operator||
name|R92C_CR_HCI_RXDMA_EN
operator||
name|R92C_CR_TXDMA_EN
operator||
name|R92C_CR_RXDMA_EN
operator||
name|R92C_CR_PROTOCOL_EN
operator||
name|R92C_CR_SCHEDULE_EN
operator||
name|R92C_CR_ENSEC
operator||
name|R92C_CR_CALTMR_EN
expr_stmt|;
name|error
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|urtwn_power_off
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
name|sc
operator|->
name|sc_power_off
argument_list|(
name|sc
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r92c_power_off
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* Block all Tx queues. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
name|R92C_TX_QUEUE_ALL
argument_list|)
expr_stmt|;
comment|/* Disable RF */
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|,
name|R92C_APSD_CTRL_OFF
argument_list|)
expr_stmt|;
comment|/* Reset BB state machine */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|R92C_SYS_FUNC_EN_USBD
operator||
name|R92C_SYS_FUNC_EN_USBA
operator||
name|R92C_SYS_FUNC_EN_BB_GLB_RST
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|R92C_SYS_FUNC_EN_USBD
operator||
name|R92C_SYS_FUNC_EN_USBA
argument_list|)
expr_stmt|;
comment|/* 	 * Reset digital sequence 	 */
ifndef|#
directive|ifndef
name|URTWN_WITHOUT_UCODE
if|if
condition|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_RDY
condition|)
block|{
comment|/* Reset MCU ready status */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* If firmware in ram code, do reset */
name|urtwn_fw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* Reset MAC and Enable 8051 */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
operator|+
literal|1
argument_list|,
operator|(
name|R92C_SYS_FUNC_EN_CPUEN
operator||
name|R92C_SYS_FUNC_EN_ELDR
operator||
name|R92C_SYS_FUNC_EN_HWPDN
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* Reset MCU ready status */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable MAC clock */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CLKR
argument_list|,
name|R92C_SYS_CLKR_ANAD16V_EN
operator||
name|R92C_SYS_CLKR_ANA8M
operator||
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_80M_SSC_DIS
operator||
name|R92C_SYS_CLKR_SYS_EN
operator||
name|R92C_SYS_CLKR_RING_EN
operator||
literal|0x4000
argument_list|)
expr_stmt|;
comment|/* Disable AFE PLL */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_PLL_CTRL
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
comment|/* Gated AFE DIG_CLOCK */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
argument_list|,
literal|0x880F
argument_list|)
expr_stmt|;
comment|/* Isolated digital to PON */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|,
name|R92C_SYS_ISO_CTRL_MD2PP
operator||
name|R92C_SYS_ISO_CTRL_PA2PCIE
operator||
name|R92C_SYS_ISO_CTRL_PD2CORE
operator||
name|R92C_SYS_ISO_CTRL_IP2MAC
operator||
name|R92C_SYS_ISO_CTRL_DIOP
operator||
name|R92C_SYS_ISO_CTRL_DIOE
argument_list|)
expr_stmt|;
comment|/* 	 * Pull GPIO PIN to balance level and LED control 	 */
comment|/* 1. Disable GPIO[7:0] */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_IOSEL
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_PIN_CTRL
argument_list|)
operator|&
operator|~
literal|0x0000ff00
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
name|reg
operator|<<
literal|8
operator|)
operator|&
literal|0x0000ff00
operator|)
operator||
literal|0x00ff0000
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_PIN_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Disable GPIO[10:8] */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_PINMUX_CFG
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_IO_SEL
argument_list|)
operator|&
operator|~
literal|0x00f0
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
operator|(
name|reg
operator|&
literal|0x000f
operator|)
operator|<<
literal|4
operator|)
operator||
literal|0x0780
operator|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_IO_SEL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Disable LED0& 1 */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG0
argument_list|,
literal|0x8080
argument_list|)
expr_stmt|;
comment|/* 	 * Reset digital sequence 	 */
comment|/* Disable ELDR clock */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CLKR
argument_list|,
name|R92C_SYS_CLKR_ANAD16V_EN
operator||
name|R92C_SYS_CLKR_ANA8M
operator||
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_80M_SSC_DIS
operator||
name|R92C_SYS_CLKR_SYS_EN
operator||
name|R92C_SYS_CLKR_RING_EN
operator||
literal|0x4000
argument_list|)
expr_stmt|;
comment|/* Isolated ELDR to PON */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
operator|+
literal|1
argument_list|,
operator|(
name|R92C_SYS_ISO_CTRL_DIOR
operator||
name|R92C_SYS_ISO_CTRL_PWC_EV12V
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* 	 * Disable analog sequence 	 */
comment|/* Disable A15 power */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LDOA15_CTRL
argument_list|,
name|R92C_LDOA15_CTRL_OBUF
argument_list|)
expr_stmt|;
comment|/* Disable digital core power */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LDOV12D_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LDOV12D_CTRL
argument_list|)
operator|&
operator|~
name|R92C_LDOV12D_CTRL_LDV12_EN
argument_list|)
expr_stmt|;
comment|/* Enter PFM mode */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SPS0_CTRL
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
comment|/* Set USB suspend */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|R92C_APS_FSMCO_APDM_HOST
operator||
name|R92C_APS_FSMCO_AFSM_HSUS
operator||
name|R92C_APS_FSMCO_PFM_ALDN
argument_list|)
expr_stmt|;
comment|/* Lock ISO/CLK/Power control register. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RSV_CTRL
argument_list|,
literal|0x0E
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r88e_power_off
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Disable any kind of TX reports. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R88E_TX_RPT_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R88E_TX_RPT_CTRL
argument_list|)
operator|&
operator|~
operator|(
name|R88E_TX_RPT1_ENA
operator||
name|R88E_TX_RPT2_ENA
operator|)
argument_list|)
expr_stmt|;
comment|/* Stop Rx. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Move card to Low Power State. */
comment|/* Block all Tx queues. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
name|R92C_TX_QUEUE_ALL
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|20
condition|;
name|ntries
operator|++
control|)
block|{
comment|/* Should be zero if no packet is transmitting. */
if|if
condition|(
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R88E_SCH_TXCMD
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|20
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: failed to block Tx queues\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* CCK and OFDM are disabled, and clock are gated. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
operator|&
operator|~
name|R92C_SYS_FUNC_EN_BBRSTB
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Reset MAC TRX */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|R92C_CR_HCI_TXDMA_EN
operator||
name|R92C_CR_HCI_RXDMA_EN
operator||
name|R92C_CR_TXDMA_EN
operator||
name|R92C_CR_RXDMA_EN
operator||
name|R92C_CR_PROTOCOL_EN
operator||
name|R92C_CR_SCHEDULE_EN
argument_list|)
expr_stmt|;
comment|/* check if removed later */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_CR
operator|+
literal|1
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_CR
operator|+
literal|1
argument_list|)
operator|&
operator|~
operator|(
name|R92C_CR_ENSEC
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
comment|/* Respond TxOK to scheduler */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_DUAL_TSF_RST
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_DUAL_TSF_RST
argument_list|)
operator||
literal|0x20
argument_list|)
expr_stmt|;
comment|/* If firmware in ram code, do reset. */
ifndef|#
directive|ifndef
name|URTWN_WITHOUT_UCODE
if|if
condition|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_RDY
condition|)
name|urtwn_r88e_fw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Reset MCU ready status. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* Disable 32k. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R88E_32K_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R88E_32K_CTRL
argument_list|)
operator|&
operator|~
literal|0x01
argument_list|)
expr_stmt|;
comment|/* Move card to Disabled state. */
comment|/* Turn off RF. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RF_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* LDO Sleep mode. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LPLDO_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LPLDO_CTRL
argument_list|)
operator||
name|R92C_LPLDO_CTRL_SLEEP
argument_list|)
expr_stmt|;
comment|/* Turn off MAC by HW state machine */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
operator|+
literal|1
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
operator|+
literal|1
argument_list|)
operator||
operator|(
name|R92C_APS_FSMCO_APFM_OFF
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|20
condition|;
name|ntries
operator|++
control|)
block|{
comment|/* Wait until it will be disabled. */
if|if
condition|(
operator|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
operator|+
literal|1
argument_list|)
operator|&
operator|(
name|R92C_APS_FSMCO_APFM_OFF
operator|>>
literal|8
operator|)
operator|)
operator|==
literal|0
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|20
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: could not turn off MAC\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* schmit trigger */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
operator|+
literal|2
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
operator|+
literal|2
argument_list|)
operator||
literal|0x80
argument_list|)
expr_stmt|;
comment|/* Enable WL suspend. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
operator|+
literal|1
argument_list|,
operator|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
operator|+
literal|1
argument_list|)
operator|&
operator|~
literal|0x10
operator|)
operator||
literal|0x08
argument_list|)
expr_stmt|;
comment|/* Enable bandgap mbias in suspend. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
operator|+
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Clear SIC_EN register. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
operator|+
literal|1
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
operator|+
literal|1
argument_list|)
operator|&
operator|~
literal|0x10
argument_list|)
expr_stmt|;
comment|/* Set USB suspend enable local register */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_SUSPEND
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_SUSPEND
argument_list|)
operator||
literal|0x10
argument_list|)
expr_stmt|;
comment|/* Reset MCU IO Wrapper. */
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_RSV_CTRL
operator|+
literal|1
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RSV_CTRL
operator|+
literal|1
argument_list|,
name|reg
operator|&
operator|~
literal|0x08
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RSV_CTRL
operator|+
literal|1
argument_list|,
name|reg
operator||
literal|0x08
argument_list|)
expr_stmt|;
comment|/* marked as 'For Power Consumption' code. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_OUT
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_IN
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_IOSEL
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_IO_SEL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_IO_SEL
argument_list|)
operator|<<
literal|4
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MOD
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MOD
argument_list|)
operator||
literal|0x0f
argument_list|)
expr_stmt|;
comment|/* Set LNA, TRSW, EX_PA Pin to output mode. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R88E_BB_PAD_CTRL
argument_list|,
literal|0x00080808
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_llt_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|page_count
decl_stmt|,
name|pktbuf_count
decl_stmt|;
name|page_count
operator|=
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|?
name|R88E_TX_PAGE_COUNT
else|:
name|R92C_TX_PAGE_COUNT
expr_stmt|;
name|pktbuf_count
operator|=
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|?
name|R88E_TXPKTBUF_COUNT
else|:
name|R92C_TXPKTBUF_COUNT
expr_stmt|;
comment|/* Reserve pages [0; page_count]. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|page_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|urtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* NB: 0xff indicates end-of-list. */
if|if
condition|(
operator|(
name|error
operator|=
name|urtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
literal|0xff
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * Use pages [page_count + 1; pktbuf_count - 1] 	 * as ring buffer. 	 */
for|for
control|(
operator|++
name|i
init|;
name|i
operator|<
name|pktbuf_count
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|urtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Make the last page point to the beginning of the ring buffer. */
name|error
operator|=
name|urtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|page_count
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|URTWN_WITHOUT_UCODE
end_ifndef

begin_function
specifier|static
name|void
name|urtwn_fw_reset
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Tell 8051 to reset itself. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_HMETFR
operator|+
literal|3
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|/* Wait until 8051 resets by itself. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_SYS_FUNC_EN_CPUEN
operator|)
condition|)
return|return;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
comment|/* Force 8051 reset. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
operator|&
operator|~
name|R92C_SYS_FUNC_EN_CPUEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r88e_fw_reset
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
operator|&
operator|~
name|R92C_SYS_FUNC_EN_CPUEN
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
operator||
name|R92C_SYS_FUNC_EN_CPUEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_fw_loadpage
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|page
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|usb_error_t
name|error
init|=
name|USB_ERR_NORMAL_COMPLETION
decl_stmt|;
name|int
name|off
decl_stmt|,
name|mlen
decl_stmt|;
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_MCUFWDL_PAGE
argument_list|,
name|page
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|off
operator|=
name|R92C_FW_START_ADDR
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|len
operator|>
literal|196
condition|)
name|mlen
operator|=
literal|196
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|4
condition|)
name|mlen
operator|=
literal|4
expr_stmt|;
else|else
name|mlen
operator|=
literal|1
expr_stmt|;
comment|/* XXX fix this deconst */
name|error
operator|=
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|off
argument_list|,
name|__DECONST
argument_list|(
name|uint8_t
operator|*
argument_list|,
name|buf
argument_list|)
argument_list|,
name|mlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
break|break;
name|off
operator|+=
name|mlen
expr_stmt|;
name|buf
operator|+=
name|mlen
expr_stmt|;
name|len
operator|-=
name|mlen
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_load_firmware
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|struct
name|firmware
modifier|*
name|fw
decl_stmt|;
specifier|const
name|struct
name|r92c_fw_hdr
modifier|*
name|hdr
decl_stmt|;
specifier|const
name|char
modifier|*
name|imagename
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|mlen
decl_stmt|,
name|ntries
decl_stmt|,
name|page
decl_stmt|,
name|error
decl_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Read firmware image from the filesystem. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|imagename
operator|=
literal|"urtwn-rtl8188eufw"
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|sc
operator|->
name|chip
operator|&
operator|(
name|URTWN_CHIP_UMC_A_CUT
operator||
name|URTWN_CHIP_92C
operator|)
operator|)
operator|==
name|URTWN_CHIP_UMC_A_CUT
condition|)
name|imagename
operator|=
literal|"urtwn-rtl8192cfwU"
expr_stmt|;
else|else
name|imagename
operator|=
literal|"urtwn-rtl8192cfwT"
expr_stmt|;
name|fw
operator|=
name|firmware_get
argument_list|(
name|imagename
argument_list|)
expr_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed loadfirmware of file %s\n"
argument_list|,
name|imagename
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
name|len
operator|=
name|fw
operator|->
name|datasize
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"firmware too short\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ptr
operator|=
name|fw
operator|->
name|data
expr_stmt|;
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|r92c_fw_hdr
operator|*
operator|)
name|ptr
expr_stmt|;
comment|/* Check if there is a valid FW header and skip it. */
if|if
condition|(
operator|(
name|le16toh
argument_list|(
name|hdr
operator|->
name|signature
argument_list|)
operator|>>
literal|4
operator|)
operator|==
literal|0x88c
operator|||
operator|(
name|le16toh
argument_list|(
name|hdr
operator|->
name|signature
argument_list|)
operator|>>
literal|4
operator|)
operator|==
literal|0x88e
operator|||
operator|(
name|le16toh
argument_list|(
name|hdr
operator|->
name|signature
argument_list|)
operator|>>
literal|4
operator|)
operator|==
literal|0x92c
condition|)
block|{
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_FIRMWARE
argument_list|,
literal|"FW V%d.%d %02d-%02d %02d:%02d\n"
argument_list|,
name|le16toh
argument_list|(
name|hdr
operator|->
name|version
argument_list|)
argument_list|,
name|le16toh
argument_list|(
name|hdr
operator|->
name|subversion
argument_list|)
argument_list|,
name|hdr
operator|->
name|month
argument_list|,
name|hdr
operator|->
name|date
argument_list|,
name|hdr
operator|->
name|hour
argument_list|,
name|hdr
operator|->
name|minute
argument_list|)
expr_stmt|;
name|ptr
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_RAM_DL_SEL
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|urtwn_r88e_fw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|urtwn_fw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
operator||
name|R92C_SYS_FUNC_EN_CPUEN
argument_list|)
expr_stmt|;
block|}
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator||
name|R92C_MCUFWDL_EN
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
operator|+
literal|2
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
operator|+
literal|2
argument_list|)
operator|&
operator|~
literal|0x08
argument_list|)
expr_stmt|;
comment|/* Reset the FWDL checksum. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator||
name|R92C_MCUFWDL_CHKSUM_RPT
argument_list|)
expr_stmt|;
for|for
control|(
name|page
operator|=
literal|0
init|;
name|len
operator|>
literal|0
condition|;
name|page
operator|++
control|)
block|{
name|mlen
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|R92C_FW_PAGE_SIZE
argument_list|)
expr_stmt|;
name|error
operator|=
name|urtwn_fw_loadpage
argument_list|(
name|sc
argument_list|,
name|page
argument_list|,
name|ptr
argument_list|,
name|mlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load firmware page\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ptr
operator|+=
name|mlen
expr_stmt|;
name|len
operator|-=
name|mlen
expr_stmt|;
block|}
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
operator|~
name|R92C_MCUFWDL_EN
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Wait for checksum report. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_CHKSUM_RPT
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for checksum report\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
name|R92C_MCUFWDL_WINTINI_RDY
operator|)
operator||
name|R92C_MCUFWDL_RDY
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|urtwn_r88e_fw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Wait for firmware readiness. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_WINTINI_RDY
condition|)
break|break;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for firmware readiness\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|fail
label|:
name|firmware_put
argument_list|(
name|fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|urtwn_dma_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|usb_endpoint
modifier|*
name|ep
decl_stmt|,
modifier|*
name|ep_end
decl_stmt|;
name|usb_error_t
name|usb_err
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|hashq
decl_stmt|,
name|hasnq
decl_stmt|,
name|haslq
decl_stmt|,
name|nqueues
decl_stmt|,
name|ntx
decl_stmt|;
name|int
name|error
decl_stmt|,
name|pagecount
decl_stmt|,
name|npubqpages
decl_stmt|,
name|nqpages
decl_stmt|,
name|nrempages
decl_stmt|,
name|tx_boundary
decl_stmt|;
comment|/* Initialize LLT table. */
name|error
operator|=
name|urtwn_llt_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Determine the number of bulk-out pipes. */
name|ntx
operator|=
literal|0
expr_stmt|;
name|ep
operator|=
name|sc
operator|->
name|sc_udev
operator|->
name|endpoints
expr_stmt|;
name|ep_end
operator|=
name|sc
operator|->
name|sc_udev
operator|->
name|endpoints
operator|+
name|sc
operator|->
name|sc_udev
operator|->
name|endpoints_max
expr_stmt|;
for|for
control|(
init|;
name|ep
operator|!=
name|ep_end
condition|;
name|ep
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ep
operator|->
name|edesc
operator|==
name|NULL
operator|)
operator|||
operator|(
name|ep
operator|->
name|iface_index
operator|!=
name|sc
operator|->
name|sc_iface_index
operator|)
condition|)
continue|continue;
if|if
condition|(
name|UE_GET_DIR
argument_list|(
name|ep
operator|->
name|edesc
operator|->
name|bEndpointAddress
argument_list|)
operator|==
name|UE_DIR_OUT
condition|)
name|ntx
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ntx
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%d: invalid number of Tx bulk pipes\n"
argument_list|,
name|ntx
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* Get Tx queues to USB endpoints mapping. */
name|hashq
operator|=
name|hasnq
operator|=
name|haslq
operator|=
name|nqueues
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|ntx
condition|)
block|{
case|case
literal|1
case|:
name|hashq
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|hashq
operator|=
name|hasnq
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|3
case|:
case|case
literal|4
case|:
name|hashq
operator|=
name|hasnq
operator|=
name|haslq
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|nqueues
operator|=
name|hashq
operator|+
name|hasnq
operator|+
name|haslq
expr_stmt|;
if|if
condition|(
name|nqueues
operator|==
literal|0
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|npubqpages
operator|=
name|nqpages
operator|=
name|nrempages
operator|=
name|pagecount
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|tx_boundary
operator|=
name|R88E_TX_PAGE_BOUNDARY
expr_stmt|;
else|else
block|{
name|pagecount
operator|=
name|R92C_TX_PAGE_COUNT
expr_stmt|;
name|npubqpages
operator|=
name|R92C_PUBQ_NPAGES
expr_stmt|;
name|tx_boundary
operator|=
name|R92C_TX_PAGE_BOUNDARY
expr_stmt|;
block|}
comment|/* Set number of pages for normal priority queue. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|usb_err
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN_NPQ
argument_list|,
literal|0xd
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|usb_err
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN
argument_list|,
literal|0x808e000d
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
block|}
else|else
block|{
comment|/* Get the number of pages for each queue. */
name|nqpages
operator|=
operator|(
name|pagecount
operator|-
name|npubqpages
operator|)
operator|/
name|nqueues
expr_stmt|;
comment|/*  		 * The remaining pages are assigned to the high priority 		 * queue. 		 */
name|nrempages
operator|=
operator|(
name|pagecount
operator|-
name|npubqpages
operator|)
operator|%
name|nqueues
expr_stmt|;
name|usb_err
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN_NPQ
argument_list|,
name|hasnq
condition|?
name|nqpages
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|usb_err
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN
argument_list|,
comment|/* Set number of pages for public queue. */
name|SM
argument_list|(
name|R92C_RQPN_PUBQ
argument_list|,
name|npubqpages
argument_list|)
operator||
comment|/* Set number of pages for high priority queue. */
name|SM
argument_list|(
name|R92C_RQPN_HPQ
argument_list|,
name|hashq
condition|?
name|nqpages
operator|+
name|nrempages
else|:
literal|0
argument_list|)
operator||
comment|/* Set number of pages for low priority queue. */
name|SM
argument_list|(
name|R92C_RQPN_LPQ
argument_list|,
name|haslq
condition|?
name|nqpages
else|:
literal|0
argument_list|)
operator||
comment|/* Load values. */
name|R92C_RQPN_LD
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|usb_err
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_BCNQ_BDNY
argument_list|,
name|tx_boundary
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|usb_err
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_MGQ_BDNY
argument_list|,
name|tx_boundary
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|usb_err
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_WMAC_LBK_BF_HD
argument_list|,
name|tx_boundary
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|usb_err
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TRXFF_BNDY
argument_list|,
name|tx_boundary
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|usb_err
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TDECTRL
operator|+
literal|1
argument_list|,
name|tx_boundary
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Set queue to USB pipe mapping. */
name|reg
operator|=
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_TRXDMA_CTRL_QMAP_M
expr_stmt|;
if|if
condition|(
name|nqueues
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|hashq
condition|)
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_HQ
expr_stmt|;
elseif|else
if|if
condition|(
name|hasnq
condition|)
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_NQ
expr_stmt|;
else|else
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_LQ
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nqueues
operator|==
literal|2
condition|)
block|{
comment|/*  		 * All 2-endpoints configs have high and normal  		 * priority queues. 		 */
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_HQ_NQ
expr_stmt|;
block|}
else|else
name|reg
operator||=
name|R92C_TRXDMA_CTRL_QMAP_3EP
expr_stmt|;
name|usb_err
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Set Tx/Rx transfer page boundary. */
name|usb_err
operator|=
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXFF_BNDY
operator|+
literal|2
argument_list|,
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|?
literal|0x23ff
else|:
literal|0x27ff
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* Set Tx/Rx transfer page size. */
name|usb_err
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_PBP
argument_list|,
name|SM
argument_list|(
name|R92C_PBP_PSRX
argument_list|,
name|R92C_PBP_128
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_PBP_PSTX
argument_list|,
name|R92C_PBP_128
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_mac_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usb_error_t
name|error
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Write MAC initialization values. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|rtl8188eu_mac
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|rtl8188eu_mac
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rtl8188eu_mac
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MAX_AGGR_NUM
argument_list|,
literal|0x07
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|rtl8192cu_mac
argument_list|)
condition|;
name|i
operator|++
control|)
name|error
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|rtl8192cu_mac
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rtl8192cu_mac
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_bb_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|struct
name|urtwn_bb_prog
modifier|*
name|prog
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|uint8_t
name|crystalcap
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Enable BB and RF. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
operator||
name|R92C_SYS_FUNC_EN_BBRSTB
operator||
name|R92C_SYS_FUNC_EN_BB_GLB_RST
operator||
name|R92C_SYS_FUNC_EN_DIO_RF
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_PLL_CTRL
argument_list|,
literal|0xdb83
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RF_CTRL
argument_list|,
name|R92C_RF_CTRL_EN
operator||
name|R92C_RF_CTRL_RSTB
operator||
name|R92C_RF_CTRL_SDMRSTB
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|R92C_SYS_FUNC_EN_USBA
operator||
name|R92C_SYS_FUNC_EN_USBD
operator||
name|R92C_SYS_FUNC_EN_BB_GLB_RST
operator||
name|R92C_SYS_FUNC_EN_BBRSTB
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LDOHCI12_CTRL
argument_list|,
literal|0x0f
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x15
argument_list|,
literal|0xe9
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
operator|+
literal|1
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
block|}
comment|/* Select BB programming based on board type. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|prog
operator|=
operator|&
name|rtl8188eu_bb_prog
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
condition|)
name|prog
operator|=
operator|&
name|rtl8188ce_bb_prog
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
condition|)
name|prog
operator|=
operator|&
name|rtl8188ru_bb_prog
expr_stmt|;
else|else
name|prog
operator|=
operator|&
name|rtl8188cu_bb_prog
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
condition|)
name|prog
operator|=
operator|&
name|rtl8192ce_bb_prog
expr_stmt|;
else|else
name|prog
operator|=
operator|&
name|rtl8192cu_bb_prog
expr_stmt|;
block|}
comment|/* Write BB initialization values. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|prog
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|prog
operator|->
name|regs
index|[
name|i
index|]
argument_list|,
name|prog
operator|->
name|vals
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C_1T2R
condition|)
block|{
comment|/* 8192C 1T only configuration. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_TXINFO
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000003
operator|)
operator||
literal|0x2
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_TXINFO
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_TXINFO
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00300033
operator|)
operator||
literal|0x00200022
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_TXINFO
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_AFESETTING
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0xff000000
operator|)
operator||
literal|0x45
operator|<<
literal|24
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_AFESETTING
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRXPATHENA
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x000000ff
operator|)
operator||
literal|0x23
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRXPATHENA
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCPARAM1
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000030
operator|)
operator||
literal|1
operator|<<
literal|4
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCPARAM1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe74
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe74
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe78
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe78
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe7c
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe7c
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe80
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe80
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe88
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe88
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* Write AGC values. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|prog
operator|->
name|agccount
condition|;
name|i
operator|++
control|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCRSSITABLE
argument_list|,
name|prog
operator|->
name|agcvals
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x69553422
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x69553420
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|crystalcap
operator|=
name|sc
operator|->
name|rom
operator|.
name|r88e_rom
operator|.
name|crystalcap
expr_stmt|;
if|if
condition|(
name|crystalcap
operator|==
literal|0xff
condition|)
name|crystalcap
operator|=
literal|0x20
expr_stmt|;
name|crystalcap
operator|&=
literal|0x3f
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
argument_list|,
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_AFE_XTAL_CTRL_ADDR
argument_list|,
name|crystalcap
operator||
name|crystalcap
operator|<<
literal|6
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|)
operator|&
name|R92C_HSSI_PARAM2_CCK_HIPWR
condition|)
name|sc
operator|->
name|sc_flags
operator||=
name|URTWN_FLAG_CCK_HIPWR
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_rf_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|struct
name|urtwn_rf_prog
modifier|*
name|prog
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|,
name|type
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|idx
decl_stmt|,
name|off
decl_stmt|;
comment|/* Select RF programming based on board type. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|prog
operator|=
name|rtl8188eu_rf_prog
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
condition|)
name|prog
operator|=
name|rtl8188ce_rf_prog
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
condition|)
name|prog
operator|=
name|rtl8188ru_rf_prog
expr_stmt|;
else|else
name|prog
operator|=
name|rtl8188cu_rf_prog
expr_stmt|;
block|}
else|else
name|prog
operator|=
name|rtl8192ce_rf_prog
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
comment|/* Save RF_ENV control type. */
name|idx
operator|=
name|i
operator|/
literal|2
expr_stmt|;
name|off
operator|=
operator|(
name|i
operator|%
literal|2
operator|)
operator|*
literal|16
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
operator|(
name|reg
operator|>>
name|off
operator|)
operator|&
literal|0x10
expr_stmt|;
comment|/* Set RF_ENV enable. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
literal|0x100000
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Set RF_ENV output high. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
literal|0x10
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Set address and data lengths of RF registers. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_HSSI_PARAM2_ADDR_LENGTH
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_HSSI_PARAM2_DATA_LENGTH
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Write RF initialization values for this chain. */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|prog
index|[
name|i
index|]
operator|.
name|count
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|prog
index|[
name|i
index|]
operator|.
name|regs
index|[
name|j
index|]
operator|>=
literal|0xf9
operator|&&
name|prog
index|[
name|i
index|]
operator|.
name|regs
index|[
name|j
index|]
operator|<=
literal|0xfe
condition|)
block|{
comment|/* 				 * These are fake RF registers offsets that 				 * indicate a delay is required. 				 */
name|usb_pause_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|hz
operator|/
literal|20
argument_list|)
expr_stmt|;
comment|/* 50ms */
continue|continue;
block|}
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|prog
index|[
name|i
index|]
operator|.
name|regs
index|[
name|j
index|]
argument_list|,
name|prog
index|[
name|i
index|]
operator|.
name|vals
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|urtwn_ms_delay
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
comment|/* Restore RF_ENV control type. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
literal|0x10
operator|<<
name|off
operator|)
operator||
operator|(
name|type
operator|<<
name|off
operator|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Cache RF register CHNLBW. */
name|sc
operator|->
name|rf_chnlbw
index|[
name|i
index|]
operator|=
name|urtwn_rf_read
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_CHNLBW
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|chip
operator|&
operator|(
name|URTWN_CHIP_UMC_A_CUT
operator||
name|URTWN_CHIP_92C
operator|)
operator|)
operator|==
name|URTWN_CHIP_UMC_A_CUT
condition|)
block|{
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_RX_G1
argument_list|,
literal|0x30255
argument_list|)
expr_stmt|;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_RX_G2
argument_list|,
literal|0x50a00
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_cam_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Invalidate all CAM entries. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CAMCMD
argument_list|,
name|R92C_CAMCMD_POLLING
operator||
name|R92C_CAMCMD_CLR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_cam_write
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|usb_error_t
name|error
decl_stmt|;
name|error
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CAMWRITE
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|error
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CAMCMD
argument_list|,
name|R92C_CAMCMD_POLLING
operator||
name|R92C_CAMCMD_WRITE
operator||
name|SM
argument_list|(
name|R92C_CAMCMD_ADDR
argument_list|,
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_pa_bias_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|pa_setting
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
continue|continue;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x0f406
argument_list|)
expr_stmt|;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x4f406
argument_list|)
expr_stmt|;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x8f406
argument_list|)
expr_stmt|;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0xcf406
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|pa_setting
operator|&
literal|0x10
operator|)
condition|)
block|{
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0xf0
operator|)
operator||
literal|0x90
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x16
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_rxfilter_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|uint32_t
name|rcr
decl_stmt|;
name|uint16_t
name|filter
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Setup multicast filter. */
name|urtwn_set_multi
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Filter for management frames. */
name|filter
operator|=
literal|0x7f3f
expr_stmt|;
switch|switch
condition|(
name|vap
operator|->
name|iv_opmode
condition|)
block|{
case|case
name|IEEE80211_M_STA
case|:
name|filter
operator|&=
operator|~
operator|(
name|R92C_RXFLTMAP_SUBTYPE
argument_list|(
name|IEEE80211_FC0_SUBTYPE_ASSOC_REQ
argument_list|)
operator||
name|R92C_RXFLTMAP_SUBTYPE
argument_list|(
name|IEEE80211_FC0_SUBTYPE_REASSOC_REQ
argument_list|)
operator||
name|R92C_RXFLTMAP_SUBTYPE
argument_list|(
name|IEEE80211_FC0_SUBTYPE_PROBE_REQ
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_HOSTAP
case|:
name|filter
operator|&=
operator|~
operator|(
name|R92C_RXFLTMAP_SUBTYPE
argument_list|(
name|IEEE80211_FC0_SUBTYPE_ASSOC_RESP
argument_list|)
operator||
name|R92C_RXFLTMAP_SUBTYPE
argument_list|(
name|IEEE80211_FC0_SUBTYPE_REASSOC_RESP
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_MONITOR
case|:
case|case
name|IEEE80211_M_IBSS
case|:
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: undefined opmode %d\n"
argument_list|,
name|__func__
argument_list|,
name|vap
operator|->
name|iv_opmode
argument_list|)
expr_stmt|;
break|break;
block|}
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP0
argument_list|,
name|filter
argument_list|)
expr_stmt|;
comment|/* Reject all control frames. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP1
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* Reject all data frames. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|rcr
operator|=
name|R92C_RCR_AM
operator||
name|R92C_RCR_AB
operator||
name|R92C_RCR_APM
operator||
name|R92C_RCR_HTC_LOC_CTRL
operator||
name|R92C_RCR_APP_PHYSTS
operator||
name|R92C_RCR_APP_ICV
operator||
name|R92C_RCR_APP_MIC
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_MONITOR
condition|)
block|{
comment|/* Accept all frames. */
name|rcr
operator||=
name|R92C_RCR_ACF
operator||
name|R92C_RCR_ADF
operator||
name|R92C_RCR_AMF
operator||
name|R92C_RCR_AAP
expr_stmt|;
block|}
comment|/* Set Rx filter. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|rcr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_promisc
operator|!=
literal|0
condition|)
block|{
comment|/* Update Rx filter. */
name|urtwn_set_promisc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_edca_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SPEC_SIFS
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_SPEC_SIFS
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_CCK
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_OFDM
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BE_PARAM
argument_list|,
literal|0x005ea42b
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BK_PARAM
argument_list|,
literal|0x0000a44f
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VI_PARAM
argument_list|,
literal|0x005ea324
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VO_PARAM
argument_list|,
literal|0x002fa226
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_write_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint16_t
name|power
index|[
name|URTWN_RIDX_COUNT
index|]
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* Write per-CCK rate Tx power. */
if|if
condition|(
name|chain
operator|==
literal|0
condition|)
block|{
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_A_CCK1_MCS32
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK1
argument_list|,
name|power
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_A_CCK1_MCS32
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK2
argument_list|,
name|power
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK55
argument_list|,
name|power
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK11
argument_list|,
name|power
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK1_55_MCS32
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK1
argument_list|,
name|power
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK2
argument_list|,
name|power
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK55
argument_list|,
name|power
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK1_55_MCS32
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK11
argument_list|,
name|power
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* Write per-OFDM rate Tx power. */
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_RATE18_06
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_RATE06
argument_list|,
name|power
index|[
literal|4
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE09
argument_list|,
name|power
index|[
literal|5
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE12
argument_list|,
name|power
index|[
literal|6
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE18
argument_list|,
name|power
index|[
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_RATE54_24
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_RATE24
argument_list|,
name|power
index|[
literal|8
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE36
argument_list|,
name|power
index|[
literal|9
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE48
argument_list|,
name|power
index|[
literal|10
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE54
argument_list|,
name|power
index|[
literal|11
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write per-MCS Tx power. */
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS03_MCS00
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS00
argument_list|,
name|power
index|[
literal|12
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS01
argument_list|,
name|power
index|[
literal|13
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS02
argument_list|,
name|power
index|[
literal|14
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS03
argument_list|,
name|power
index|[
literal|15
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS07_MCS04
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS04
argument_list|,
name|power
index|[
literal|16
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS05
argument_list|,
name|power
index|[
literal|17
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS06
argument_list|,
name|power
index|[
literal|18
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS07
argument_list|,
name|power
index|[
literal|19
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS11_MCS08
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS08
argument_list|,
name|power
index|[
literal|20
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS09
argument_list|,
name|power
index|[
literal|21
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS10
argument_list|,
name|power
index|[
literal|22
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS11
argument_list|,
name|power
index|[
literal|23
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS15_MCS12
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS12
argument_list|,
name|power
index|[
literal|24
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS13
argument_list|,
name|power
index|[
literal|25
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS14
argument_list|,
name|power
index|[
literal|26
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS15
argument_list|,
name|power
index|[
literal|27
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_get_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|,
name|uint16_t
name|power
index|[
name|URTWN_RIDX_COUNT
index|]
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|r92c_rom
modifier|*
name|rom
init|=
operator|&
name|sc
operator|->
name|rom
operator|.
name|r92c_rom
decl_stmt|;
name|uint16_t
name|cckpow
decl_stmt|,
name|ofdmpow
decl_stmt|,
name|htpow
decl_stmt|,
name|diff
decl_stmt|,
name|max
decl_stmt|;
specifier|const
name|struct
name|urtwn_txpwr
modifier|*
name|base
decl_stmt|;
name|int
name|ridx
decl_stmt|,
name|chan
decl_stmt|,
name|group
decl_stmt|;
comment|/* Determine channel group. */
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* XXX center freq! */
if|if
condition|(
name|chan
operator|<=
literal|3
condition|)
name|group
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|9
condition|)
name|group
operator|=
literal|1
expr_stmt|;
else|else
name|group
operator|=
literal|2
expr_stmt|;
comment|/* Get original Tx power based on board type and RF chain. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_92C
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
condition|)
name|base
operator|=
operator|&
name|rtl8188ru_txagc
index|[
name|chain
index|]
expr_stmt|;
else|else
name|base
operator|=
operator|&
name|rtl8192cu_txagc
index|[
name|chain
index|]
expr_stmt|;
block|}
else|else
name|base
operator|=
operator|&
name|rtl8192cu_txagc
index|[
name|chain
index|]
expr_stmt|;
name|memset
argument_list|(
name|power
argument_list|,
literal|0
argument_list|,
name|URTWN_RIDX_COUNT
operator|*
sizeof|sizeof
argument_list|(
name|power
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|ridx
operator|=
name|URTWN_RIDX_CCK1
init|;
name|ridx
operator|<=
name|URTWN_RIDX_CCK11
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
for|for
control|(
name|ridx
operator|=
name|URTWN_RIDX_OFDM6
init|;
name|ridx
operator|<
name|URTWN_RIDX_COUNT
condition|;
name|ridx
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|3
condition|)
block|{
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
comment|/* Apply vendor limits. */
if|if
condition|(
name|extc
operator|!=
name|NULL
condition|)
name|max
operator|=
name|rom
operator|->
name|ht40_max_pwr
index|[
name|group
index|]
expr_stmt|;
else|else
name|max
operator|=
name|rom
operator|->
name|ht20_max_pwr
index|[
name|group
index|]
expr_stmt|;
name|max
operator|=
operator|(
name|max
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|max
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|max
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|extc
operator|==
name|NULL
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
name|group
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|!=
literal|2
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
comment|/* Compute per-CCK rate Tx power. */
name|cckpow
operator|=
name|rom
operator|->
name|cck_tx_pwr
index|[
name|chain
index|]
index|[
name|group
index|]
expr_stmt|;
for|for
control|(
name|ridx
operator|=
name|URTWN_RIDX_CCK1
init|;
name|ridx
operator|<=
name|URTWN_RIDX_CCK11
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|cckpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
name|htpow
operator|=
name|rom
operator|->
name|ht40_1s_tx_pwr
index|[
name|chain
index|]
index|[
name|group
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
block|{
comment|/* Apply reduction for 2 spatial streams. */
name|diff
operator|=
name|rom
operator|->
name|ht40_2s_tx_pwr_diff
index|[
name|group
index|]
expr_stmt|;
name|diff
operator|=
operator|(
name|diff
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
name|htpow
operator|=
operator|(
name|htpow
operator|>
name|diff
operator|)
condition|?
name|htpow
operator|-
name|diff
else|:
literal|0
expr_stmt|;
block|}
comment|/* Compute per-OFDM rate Tx power. */
name|diff
operator|=
name|rom
operator|->
name|ofdm_tx_pwr_diff
index|[
name|group
index|]
expr_stmt|;
name|diff
operator|=
operator|(
name|diff
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
name|ofdmpow
operator|=
name|htpow
operator|+
name|diff
expr_stmt|;
comment|/* HT->OFDM correction. */
for|for
control|(
name|ridx
operator|=
name|URTWN_RIDX_OFDM6
init|;
name|ridx
operator|<=
name|URTWN_RIDX_OFDM54
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|ofdmpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
comment|/* Compute per-MCS Tx power. */
if|if
condition|(
name|extc
operator|==
name|NULL
condition|)
block|{
name|diff
operator|=
name|rom
operator|->
name|ht20_tx_pwr_diff
index|[
name|group
index|]
expr_stmt|;
name|diff
operator|=
operator|(
name|diff
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
name|htpow
operator|+=
name|diff
expr_stmt|;
comment|/* HT40->HT20 correction. */
block|}
for|for
control|(
name|ridx
operator|=
literal|12
init|;
name|ridx
operator|<=
literal|27
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|htpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|USB_DEBUG
if|if
condition|(
name|sc
operator|->
name|sc_debug
operator|&
name|URTWN_DEBUG_TXPWR
condition|)
block|{
comment|/* Dump per-rate Tx power values. */
name|printf
argument_list|(
literal|"Tx power for chain %d:\n"
argument_list|,
name|chain
argument_list|)
expr_stmt|;
for|for
control|(
name|ridx
operator|=
name|URTWN_RIDX_CCK1
init|;
name|ridx
operator|<
name|URTWN_RIDX_COUNT
condition|;
name|ridx
operator|++
control|)
name|printf
argument_list|(
literal|"Rate %d = %u\n"
argument_list|,
name|ridx
argument_list|,
name|power
index|[
name|ridx
index|]
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_r88e_get_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|,
name|uint16_t
name|power
index|[
name|URTWN_RIDX_COUNT
index|]
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|r88e_rom
modifier|*
name|rom
init|=
operator|&
name|sc
operator|->
name|rom
operator|.
name|r88e_rom
decl_stmt|;
name|uint16_t
name|cckpow
decl_stmt|,
name|ofdmpow
decl_stmt|,
name|bw20pow
decl_stmt|,
name|htpow
decl_stmt|;
specifier|const
name|struct
name|urtwn_r88e_txpwr
modifier|*
name|base
decl_stmt|;
name|int
name|ridx
decl_stmt|,
name|chan
decl_stmt|,
name|group
decl_stmt|;
comment|/* Determine channel group. */
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* XXX center freq! */
if|if
condition|(
name|chan
operator|<=
literal|2
condition|)
name|group
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|5
condition|)
name|group
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|8
condition|)
name|group
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|11
condition|)
name|group
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|13
condition|)
name|group
operator|=
literal|4
expr_stmt|;
else|else
name|group
operator|=
literal|5
expr_stmt|;
comment|/* Get original Tx power based on board type and RF chain. */
name|base
operator|=
operator|&
name|rtl8188eu_txagc
index|[
name|chain
index|]
expr_stmt|;
name|memset
argument_list|(
name|power
argument_list|,
literal|0
argument_list|,
name|URTWN_RIDX_COUNT
operator|*
sizeof|sizeof
argument_list|(
name|power
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|ridx
operator|=
name|URTWN_RIDX_CCK1
init|;
name|ridx
operator|<=
name|URTWN_RIDX_CCK11
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
for|for
control|(
name|ridx
operator|=
name|URTWN_RIDX_OFDM6
init|;
name|ridx
operator|<
name|URTWN_RIDX_COUNT
condition|;
name|ridx
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|3
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|extc
operator|==
name|NULL
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
name|group
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|!=
literal|2
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
comment|/* Compute per-CCK rate Tx power. */
name|cckpow
operator|=
name|rom
operator|->
name|cck_tx_pwr
index|[
name|group
index|]
expr_stmt|;
for|for
control|(
name|ridx
operator|=
name|URTWN_RIDX_CCK1
init|;
name|ridx
operator|<=
name|URTWN_RIDX_CCK11
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|cckpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
name|htpow
operator|=
name|rom
operator|->
name|ht40_tx_pwr
index|[
name|group
index|]
expr_stmt|;
comment|/* Compute per-OFDM rate Tx power. */
name|ofdmpow
operator|=
name|htpow
operator|+
name|sc
operator|->
name|ofdm_tx_pwr_diff
expr_stmt|;
for|for
control|(
name|ridx
operator|=
name|URTWN_RIDX_OFDM6
init|;
name|ridx
operator|<=
name|URTWN_RIDX_OFDM54
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|ofdmpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
name|bw20pow
operator|=
name|htpow
operator|+
name|sc
operator|->
name|bw20_tx_pwr_diff
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|12
init|;
name|ridx
operator|<=
literal|27
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|bw20pow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_txpower
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|)
block|{
name|uint16_t
name|power
index|[
name|URTWN_RIDX_COUNT
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|ntxchains
condition|;
name|i
operator|++
control|)
block|{
comment|/* Compute per-rate Tx power values. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|urtwn_r88e_get_txpower
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|c
argument_list|,
name|extc
argument_list|,
name|power
argument_list|)
expr_stmt|;
else|else
name|urtwn_get_txpower
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|c
argument_list|,
name|extc
argument_list|,
name|power
argument_list|)
expr_stmt|;
comment|/* Write per-rate Tx power values to hardware. */
name|urtwn_write_txpower
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|power
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_rx_bssid_all
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|reg
operator|&=
operator|~
name|R92C_RCR_CBSSID_BCN
expr_stmt|;
else|else
name|reg
operator||=
name|R92C_RCR_CBSSID_BCN
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_gain
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|gain
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_OFDM0_AGCCORE1_GAIN
argument_list|,
name|gain
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_OFDM0_AGCCORE1_GAIN
argument_list|,
name|gain
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|1
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Receive beacons / probe responses from any BSSID. */
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_IBSS
operator|&&
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_HOSTAP
condition|)
name|urtwn_set_rx_bssid_all
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Set gain for scanning. */
name|urtwn_set_gain
argument_list|(
name|sc
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Restore limitations. */
if|if
condition|(
name|ic
operator|->
name|ic_promisc
operator|==
literal|0
operator|&&
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_IBSS
operator|&&
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_HOSTAP
condition|)
name|urtwn_set_rx_bssid_all
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set gain under link. */
name|urtwn_set_gain
argument_list|(
name|sc
argument_list|,
literal|0x32
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_getradiocaps
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|int
name|maxchans
parameter_list|,
name|int
modifier|*
name|nchans
parameter_list|,
name|struct
name|ieee80211_channel
name|chans
index|[]
parameter_list|)
block|{
name|uint8_t
name|bands
index|[
name|IEEE80211_MODE_BYTES
index|]
decl_stmt|;
name|memset
argument_list|(
name|bands
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bands
argument_list|)
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
name|bands
argument_list|,
name|IEEE80211_MODE_11B
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
name|bands
argument_list|,
name|IEEE80211_MODE_11G
argument_list|)
expr_stmt|;
if|if
condition|(
name|urtwn_enable_11n
condition|)
name|setbit
argument_list|(
name|bands
argument_list|,
name|IEEE80211_MODE_11NG
argument_list|)
expr_stmt|;
name|ieee80211_add_channel_list_2ghz
argument_list|(
name|chans
argument_list|,
name|maxchans
argument_list|,
name|nchans
argument_list|,
name|urtwn_chan_2ghz
argument_list|,
name|nitems
argument_list|(
name|urtwn_chan_2ghz
argument_list|)
argument_list|,
name|bands
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|ieee80211_channel
modifier|*
name|c
init|=
name|ic
operator|->
name|ic_curchan
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_SCAN
condition|)
block|{
comment|/* Make link LED blink during scan. */
name|urtwn_set_led
argument_list|(
name|sc
argument_list|,
name|URTWN_LED_LINK
argument_list|,
operator|!
name|sc
operator|->
name|ledlink
argument_list|)
expr_stmt|;
block|}
name|urtwn_set_chan
argument_list|(
name|sc
argument_list|,
name|c
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxtap
operator|.
name|wr_chan_freq
operator|=
name|htole16
argument_list|(
name|c
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxtap
operator|.
name|wr_chan_flags
operator|=
name|htole16
argument_list|(
name|c
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txtap
operator|.
name|wt_chan_freq
operator|=
name|htole16
argument_list|(
name|c
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txtap
operator|.
name|wt_chan_flags
operator|=
name|htole16
argument_list|(
name|c
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_wme_update
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
specifier|const
name|struct
name|wmeParams
modifier|*
name|wmep
init|=
name|ic
operator|->
name|ic_wme
operator|.
name|wme_chanParams
operator|.
name|cap_wmeParams
decl_stmt|;
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|uint8_t
name|aifs
decl_stmt|,
name|acm
decl_stmt|,
name|slottime
decl_stmt|;
name|int
name|ac
decl_stmt|;
name|acm
operator|=
literal|0
expr_stmt|;
name|slottime
operator|=
name|IEEE80211_GET_SLOTTIME
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|ac
operator|=
name|WME_AC_BE
init|;
name|ac
operator|<
name|WME_NUM_AC
condition|;
name|ac
operator|++
control|)
block|{
comment|/* AIFS[AC] = AIFSN[AC] * aSlotTime + aSIFSTime. */
name|aifs
operator|=
name|wmep
index|[
name|ac
index|]
operator|.
name|wmep_aifsn
operator|*
name|slottime
operator|+
name|IEEE80211_DUR_SIFS
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|wme2queue
index|[
name|ac
index|]
operator|.
name|reg
argument_list|,
name|SM
argument_list|(
name|R92C_EDCA_PARAM_TXOP
argument_list|,
name|wmep
index|[
name|ac
index|]
operator|.
name|wmep_txopLimit
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_EDCA_PARAM_ECWMIN
argument_list|,
name|wmep
index|[
name|ac
index|]
operator|.
name|wmep_logcwmin
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_EDCA_PARAM_ECWMAX
argument_list|,
name|wmep
index|[
name|ac
index|]
operator|.
name|wmep_logcwmax
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_EDCA_PARAM_AIFS
argument_list|,
name|aifs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ac
operator|!=
name|WME_AC_BE
condition|)
name|acm
operator||=
name|wmep
index|[
name|ac
index|]
operator|.
name|wmep_acm
operator|<<
name|ac
expr_stmt|;
block|}
if|if
condition|(
name|acm
operator|!=
literal|0
condition|)
name|acm
operator||=
name|R92C_ACMHWCTRL_EN
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_ACMHWCTRL
argument_list|,
operator|(
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_ACMHWCTRL
argument_list|)
operator|&
operator|~
name|R92C_ACMHWCTRL_ACM_MASK
operator|)
operator||
name|acm
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_update_slot
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|urtwn_cmd_sleepable
argument_list|(
name|ic
operator|->
name|ic_softc
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|urtwn_update_slot_cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_update_slot_cb
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|union
name|sec_param
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint8_t
name|slottime
decl_stmt|;
name|slottime
operator|=
name|IEEE80211_GET_SLOTTIME
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_ANY
argument_list|,
literal|"%s: setting slot time to %uus\n"
argument_list|,
name|__func__
argument_list|,
name|slottime
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SLOT
argument_list|,
name|slottime
argument_list|)
expr_stmt|;
name|urtwn_update_aifs
argument_list|(
name|sc
argument_list|,
name|slottime
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_update_aifs
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|slottime
parameter_list|)
block|{
specifier|const
name|struct
name|wmeParams
modifier|*
name|wmep
init|=
name|sc
operator|->
name|sc_ic
operator|.
name|ic_wme
operator|.
name|wme_chanParams
operator|.
name|cap_wmeParams
decl_stmt|;
name|uint8_t
name|aifs
decl_stmt|,
name|ac
decl_stmt|;
for|for
control|(
name|ac
operator|=
name|WME_AC_BE
init|;
name|ac
operator|<
name|WME_NUM_AC
condition|;
name|ac
operator|++
control|)
block|{
comment|/* AIFS[AC] = AIFSN[AC] * aSlotTime + aSIFSTime. */
name|aifs
operator|=
name|wmep
index|[
name|ac
index|]
operator|.
name|wmep_aifsn
operator|*
name|slottime
operator|+
name|IEEE80211_DUR_SIFS
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|wme2queue
index|[
name|ac
index|]
operator|.
name|reg
argument_list|,
name|aifs
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|urtwn_get_multi_pos
parameter_list|(
specifier|const
name|uint8_t
name|maddr
index|[]
parameter_list|)
block|{
name|uint64_t
name|mask
init|=
literal|0x00004d101df481b4
decl_stmt|;
name|uint8_t
name|pos
init|=
literal|0x27
decl_stmt|;
comment|/* initial value */
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IEEE80211_ADDR_LEN
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
if|if
condition|(
operator|(
name|maddr
index|[
name|i
index|]
operator|>>
name|j
operator|)
operator|&
literal|1
condition|)
name|pos
operator|^=
operator|(
name|mask
operator|>>
operator|(
name|i
operator|*
literal|8
operator|+
name|j
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|pos
operator|&=
literal|0x3f
expr_stmt|;
return|return
operator|(
name|pos
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_multi
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint32_t
name|mfilt
index|[
literal|2
index|]
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* general structure was copied from ath(4). */
if|if
condition|(
name|ic
operator|->
name|ic_allmulti
operator|==
literal|0
condition|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
comment|/* 		 * Merge multicast addresses to form the hardware filter. 		 */
name|mfilt
index|[
literal|0
index|]
operator|=
name|mfilt
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|vap
argument_list|,
argument|&ic->ic_vaps
argument_list|,
argument|iv_next
argument_list|)
block|{
name|ifp
operator|=
name|vap
operator|->
name|iv_ifp
expr_stmt|;
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
name|caddr_t
name|dl
decl_stmt|;
name|uint8_t
name|pos
decl_stmt|;
name|dl
operator|=
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
expr_stmt|;
name|pos
operator|=
name|urtwn_get_multi_pos
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|mfilt
index|[
name|pos
operator|/
literal|32
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
name|pos
operator|%
literal|32
operator|)
operator|)
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|mfilt
index|[
literal|0
index|]
operator|=
name|mfilt
index|[
literal|1
index|]
operator|=
operator|~
literal|0
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MAR
operator|+
literal|0
argument_list|,
name|mfilt
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MAR
operator|+
literal|4
argument_list|,
name|mfilt
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_STATE
argument_list|,
literal|"%s: MC filter %08x:%08x\n"
argument_list|,
name|__func__
argument_list|,
name|mfilt
index|[
literal|0
index|]
argument_list|,
name|mfilt
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_promisc
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|uint32_t
name|rcr
decl_stmt|,
name|mask1
decl_stmt|,
name|mask2
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_MONITOR
condition|)
return|return;
name|mask1
operator|=
name|R92C_RCR_ACF
operator||
name|R92C_RCR_ADF
operator||
name|R92C_RCR_AMF
operator||
name|R92C_RCR_AAP
expr_stmt|;
name|mask2
operator|=
name|R92C_RCR_APM
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
switch|switch
condition|(
name|vap
operator|->
name|iv_opmode
condition|)
block|{
case|case
name|IEEE80211_M_STA
case|:
name|mask2
operator||=
name|R92C_RCR_CBSSID_BCN
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|IEEE80211_M_IBSS
case|:
name|mask2
operator||=
name|R92C_RCR_CBSSID_DATA
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_HOSTAP
case|:
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: undefined opmode %d\n"
argument_list|,
name|__func__
argument_list|,
name|vap
operator|->
name|iv_opmode
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|rcr
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_promisc
operator|==
literal|0
condition|)
name|rcr
operator|=
operator|(
name|rcr
operator|&
operator|~
name|mask1
operator|)
operator||
name|mask2
expr_stmt|;
else|else
name|rcr
operator|=
operator|(
name|rcr
operator|&
operator|~
name|mask2
operator|)
operator||
name|mask1
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|rcr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_update_promisc
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_RUNNING
condition|)
name|urtwn_set_promisc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_update_mcast
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_RUNNING
condition|)
name|urtwn_set_multi
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211_node
modifier|*
name|urtwn_node_alloc
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|struct
name|urtwn_node
modifier|*
name|un
decl_stmt|;
name|un
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|urtwn_node
argument_list|)
argument_list|,
name|M_80211_NODE
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|un
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|un
operator|->
name|id
operator|=
name|URTWN_MACID_UNDEFINED
expr_stmt|;
return|return
operator|&
name|un
operator|->
name|ni
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_newassoc
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|int
name|isnew
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ni
operator|->
name|ni_ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|urtwn_node
modifier|*
name|un
init|=
name|URTWN_NODE
argument_list|(
name|ni
argument_list|)
decl_stmt|;
name|uint8_t
name|id
decl_stmt|;
comment|/* Only do this bit for R88E chips */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
return|return;
if|if
condition|(
operator|!
name|isnew
condition|)
return|return;
name|URTWN_NT_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|id
operator|=
literal|0
init|;
name|id
operator|<=
name|URTWN_MACID_MAX
argument_list|(
name|sc
argument_list|)
condition|;
name|id
operator|++
control|)
block|{
if|if
condition|(
name|id
operator|!=
name|URTWN_MACID_BC
operator|&&
name|sc
operator|->
name|node_list
index|[
name|id
index|]
operator|==
name|NULL
condition|)
block|{
name|un
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|sc
operator|->
name|node_list
index|[
name|id
index|]
operator|=
name|ni
expr_stmt|;
break|break;
block|}
block|}
name|URTWN_NT_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|>
name|URTWN_MACID_MAX
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: node table is full\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_node_free
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|)
block|{
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ni
operator|->
name|ni_ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|urtwn_node
modifier|*
name|un
init|=
name|URTWN_NODE
argument_list|(
name|ni
argument_list|)
decl_stmt|;
name|URTWN_NT_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|un
operator|->
name|id
operator|!=
name|URTWN_MACID_UNDEFINED
condition|)
name|sc
operator|->
name|node_list
index|[
name|un
operator|->
name|id
index|]
operator|=
name|NULL
expr_stmt|;
name|URTWN_NT_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_node_free
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_set_chan
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|u_int
name|chan
decl_stmt|;
name|int
name|i
decl_stmt|;
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* XXX center freq! */
if|if
condition|(
name|chan
operator|==
literal|0
operator|||
name|chan
operator|==
name|IEEE80211_CHAN_ANY
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: invalid channel %x\n"
argument_list|,
name|__func__
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Set Tx power for this new channel. */
name|urtwn_set_txpower
argument_list|(
name|sc
argument_list|,
name|c
argument_list|,
name|extc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
name|RW
argument_list|(
name|sc
operator|->
name|rf_chnlbw
index|[
name|i
index|]
argument_list|,
name|R92C_RF_CHNLBW_CHNL
argument_list|,
name|chan
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|IEEE80211_NO_HT
if|if
condition|(
name|extc
operator|!=
name|NULL
condition|)
block|{
comment|/* Is secondary channel below or above primary? */
name|int
name|prichlo
init|=
name|c
operator|->
name|ic_freq
operator|<
name|extc
operator|->
name|ic_freq
decl_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|)
operator|&
operator|~
name|R92C_BWOPMODE_20MHZ
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
operator|+
literal|2
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x6f
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|1
else|:
literal|2
operator|)
operator|<<
literal|5
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
operator|+
literal|2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
operator||
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|)
operator||
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
comment|/* Set CCK side band. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_SYSTEM
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000010
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|0
else|:
literal|1
operator|)
operator|<<
literal|4
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_SYSTEM
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000c00
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|1
else|:
literal|2
operator|)
operator|<<
literal|10
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|)
operator|&
operator|~
name|R92C_FPGA0_ANAPARAM2_CBW20
argument_list|)
expr_stmt|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0x818
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|2
else|:
literal|1
operator|)
operator|<<
literal|26
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x818
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Select 40MHz bandwidth. */
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
operator|(
name|sc
operator|->
name|rf_chnlbw
index|[
literal|0
index|]
operator|&
operator|~
literal|0xfff
operator|)
operator||
name|chan
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|)
operator||
name|R92C_BWOPMODE_20MHZ
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
operator|&
operator|~
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|)
operator|&
operator|~
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|,
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|)
operator||
name|R92C_FPGA0_ANAPARAM2_CBW20
argument_list|)
expr_stmt|;
block|}
comment|/* Select 20MHz bandwidth. */
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
operator|(
name|sc
operator|->
name|rf_chnlbw
index|[
literal|0
index|]
operator|&
operator|~
literal|0xfff
operator|)
operator||
name|chan
operator||
operator|(
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|?
name|R88E_RF_CHNLBW_BW20
else|:
name|R92C_RF_CHNLBW_BW20
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_iq_calib
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* TODO */
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_lc_calib
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|rf_ac
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|txmode
decl_stmt|;
name|int
name|i
decl_stmt|;
name|txmode
operator|=
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
operator|+
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|txmode
operator|&
literal|0x70
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Disable all continuous Tx. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
operator|+
literal|3
argument_list|,
name|txmode
operator|&
operator|~
literal|0x70
argument_list|)
expr_stmt|;
comment|/* Set RF mode to standby mode. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
name|rf_ac
index|[
name|i
index|]
operator|=
name|urtwn_rf_read
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_AC
argument_list|)
expr_stmt|;
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_AC
argument_list|,
name|RW
argument_list|(
name|rf_ac
index|[
name|i
index|]
argument_list|,
name|R92C_RF_AC_MODE
argument_list|,
name|R92C_RF_AC_MODE_STANDBY
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Block all Tx queues. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
name|R92C_TX_QUEUE_ALL
argument_list|)
expr_stmt|;
block|}
comment|/* Start calibration. */
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
name|urtwn_rf_read
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|)
operator||
name|R92C_RF_CHNLBW_LCSTART
argument_list|)
expr_stmt|;
comment|/* Give calibration the time to complete. */
name|usb_pause_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
comment|/* 100ms */
comment|/* Restore configuration. */
if|if
condition|(
operator|(
name|txmode
operator|&
literal|0x70
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Restore Tx mode. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
operator|+
literal|3
argument_list|,
name|txmode
argument_list|)
expr_stmt|;
comment|/* Restore RF mode. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_AC
argument_list|,
name|rf_ac
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Unblock all Tx queues. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_temp_calib
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|temp
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_TEMP_MEASURED
operator|)
condition|)
block|{
comment|/* Start measuring temperature. */
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_TEMP
argument_list|,
literal|"%s: start measuring temperature\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R88E_RF_T_METER
argument_list|,
name|R88E_RF_T_METER_START
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|urtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_T_METER
argument_list|,
name|R92C_RF_T_METER_START
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_flags
operator||=
name|URTWN_TEMP_MEASURED
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|URTWN_TEMP_MEASURED
expr_stmt|;
comment|/* Read measured temperature. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|temp
operator|=
name|MS
argument_list|(
name|urtwn_rf_read
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R88E_RF_T_METER
argument_list|)
argument_list|,
name|R88E_RF_T_METER_VAL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|=
name|MS
argument_list|(
name|urtwn_rf_read
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_T_METER
argument_list|)
argument_list|,
name|R92C_RF_T_METER_VAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|temp
operator|==
literal|0
condition|)
block|{
comment|/* Read failed, skip. */
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_TEMP
argument_list|,
literal|"%s: temperature read failed, skipping\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_TEMP
argument_list|,
literal|"%s: temperature: previous %u, current %u\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|thcal_lctemp
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/* 	 * Redo LC calibration if temperature changed significantly since 	 * last calibration. 	 */
if|if
condition|(
name|sc
operator|->
name|thcal_lctemp
operator|==
literal|0
condition|)
block|{
comment|/* First LC calibration is performed in urtwn_init(). */
name|sc
operator|->
name|thcal_lctemp
operator|=
name|temp
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|abs
argument_list|(
name|temp
operator|-
name|sc
operator|->
name|thcal_lctemp
argument_list|)
operator|>
literal|1
condition|)
block|{
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_TEMP
argument_list|,
literal|"%s: LC calib triggered by temp: %u -> %u\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|thcal_lctemp
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|urtwn_lc_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Record temperature of last LC calibration. */
name|sc
operator|->
name|thcal_lctemp
operator|=
name|temp
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_setup_static_keys
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|urtwn_vap
modifier|*
name|uvp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IEEE80211_WEP_NKID
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|struct
name|ieee80211_key
modifier|*
name|k
init|=
name|uvp
operator|->
name|keys
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|k
operator|!=
name|NULL
condition|)
block|{
name|urtwn_cmd_sleepable
argument_list|(
name|sc
argument_list|,
name|k
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|k
argument_list|)
argument_list|,
name|urtwn_key_set_cb
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_init
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|uint8_t
name|macaddr
index|[
name|IEEE80211_ADDR_LEN
index|]
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|usb_error_t
name|usb_err
init|=
name|USB_ERR_NORMAL_COMPLETION
decl_stmt|;
name|int
name|error
decl_stmt|;
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_RUNNING
condition|)
block|{
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Init firmware commands ring. */
name|sc
operator|->
name|fwcur
operator|=
literal|0
expr_stmt|;
comment|/* Allocate Tx/Rx buffers. */
name|error
operator|=
name|urtwn_alloc_rx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|urtwn_alloc_tx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* Power on adapter. */
name|error
operator|=
name|urtwn_power_on
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* Initialize DMA. */
name|error
operator|=
name|urtwn_dma_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* Set info size in Rx descriptors (in 64-bit words). */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RX_DRVINFO_SZ
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Init interrupts. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|usb_err
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R88E_HISR
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
goto|goto
name|fail
goto|;
name|usb_err
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R88E_HIMR
argument_list|,
name|R88E_HIMR_CPWM
operator||
name|R88E_HIMR_CPWM2
operator||
name|R88E_HIMR_TBDER
operator||
name|R88E_HIMR_PSTIMEOUT
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
goto|goto
name|fail
goto|;
name|usb_err
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R88E_HIMRE
argument_list|,
name|R88E_HIMRE_RXFOVW
operator||
name|R88E_HIMRE_TXFOVW
operator||
name|R88E_HIMRE_RXERR
operator||
name|R88E_HIMRE_TXERR
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
goto|goto
name|fail
goto|;
name|usb_err
operator|=
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_SPECIAL_OPTION
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_SPECIAL_OPTION
argument_list|)
operator||
name|R92C_USB_SPECIAL_OPTION_INT_BULK_SEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
goto|goto
name|fail
goto|;
block|}
else|else
block|{
name|usb_err
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HISR
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
goto|goto
name|fail
goto|;
name|usb_err
operator|=
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HIMR
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
goto|goto
name|fail
goto|;
block|}
comment|/* Set MAC address. */
name|IEEE80211_ADDR_COPY
argument_list|(
name|macaddr
argument_list|,
name|vap
condition|?
name|vap
operator|->
name|iv_myaddr
else|:
name|ic
operator|->
name|ic_macaddr
argument_list|)
expr_stmt|;
name|usb_err
operator|=
name|urtwn_write_region_1
argument_list|(
name|sc
argument_list|,
name|R92C_MACID
argument_list|,
name|macaddr
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
goto|goto
name|fail
goto|;
comment|/* Set initial network type. */
name|urtwn_set_mode
argument_list|(
name|sc
argument_list|,
name|R92C_MSR_INFRA
argument_list|)
expr_stmt|;
comment|/* Initialize Rx filter. */
name|urtwn_rxfilter_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Set response rate. */
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_RRSR_RATE_BITMAP
argument_list|,
name|R92C_RRSR_RATE_CCK_ONLY_1M
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Set short/long retry limits. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RL
argument_list|,
name|SM
argument_list|(
name|R92C_RL_SRL
argument_list|,
literal|0x30
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_RL_LRL
argument_list|,
literal|0x30
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize EDCA parameters. */
name|urtwn_edca_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Setup rate fallback. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_DARFRC
operator|+
literal|0
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_DARFRC
operator|+
literal|4
argument_list|,
literal|0x10080404
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RARFRC
operator|+
literal|0
argument_list|,
literal|0x04030201
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RARFRC
operator|+
literal|4
argument_list|,
literal|0x08070605
argument_list|)
expr_stmt|;
block|}
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_FWHW_TXQ_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_FWHW_TXQ_CTRL
argument_list|)
operator||
name|R92C_FWHW_TXQ_CTRL_AMPDU_RTY_NEW
argument_list|)
expr_stmt|;
comment|/* Set ACK timeout. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_ACKTO
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
comment|/* Setup USB aggregation. */
name|reg
operator|=
name|urtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_TDECTRL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TDECTRL_BLK_DESC_NUM
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_TDECTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|)
operator||
name|R92C_TRXDMA_CTRL_RXDMA_AGG_EN
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RXDMA_AGG_PG_TH
argument_list|,
literal|48
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RXDMA_AGG_PG_TH
operator|+
literal|1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|else
block|{
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_DMA_AGG_TO
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_SPECIAL_OPTION
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_SPECIAL_OPTION
argument_list|)
operator||
name|R92C_USB_SPECIAL_OPTION_AGG_EN
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_AGG_TH
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USB_AGG_TO
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize beacon parameters. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
literal|0x1010
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TBTT_PROHIBIT
argument_list|,
literal|0x6404
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_DRVERLYINT
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCNDMATIM
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_BCNTCFG
argument_list|,
literal|0x660f
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
comment|/* Setup AMPDU aggregation. */
name|urtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_AGGLEN_LMT
argument_list|,
literal|0x99997631
argument_list|)
expr_stmt|;
comment|/* MCS7~0 */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AGGR_BREAK_TIME
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_MAX_AGGR_NUM
argument_list|,
literal|0x0708
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_MAX_ERR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|URTWN_WITHOUT_UCODE
comment|/* Load 8051 microcode. */
name|error
operator|=
name|urtwn_load_firmware
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_flags
operator||=
name|URTWN_FW_LOADED
expr_stmt|;
endif|#
directive|endif
comment|/* Initialize MAC/BB/RF blocks. */
name|error
operator|=
name|urtwn_mac_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: error while initializing MAC block\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|urtwn_bb_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_rf_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Reinitialize Rx filter (D3845 is not committed yet). */
name|urtwn_rxfilter_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|urtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
operator||
name|R92C_CR_MACTXEN
operator||
name|R92C_CR_MACRXEN
argument_list|)
expr_stmt|;
block|}
comment|/* Turn CCK and OFDM blocks on. */
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_RFMOD_CCK_EN
expr_stmt|;
name|usb_err
operator|=
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
goto|goto
name|fail
goto|;
name|reg
operator|=
name|urtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_RFMOD_OFDM_EN
expr_stmt|;
name|usb_err
operator|=
name|urtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
goto|goto
name|fail
goto|;
comment|/* Clear per-station keys table. */
name|urtwn_cam_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Enable decryption / encryption. */
name|urtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SECCFG
argument_list|,
name|R92C_SECCFG_TXUCKEY_DEF
operator||
name|R92C_SECCFG_RXUCKEY_DEF
operator||
name|R92C_SECCFG_TXENC_ENA
operator||
name|R92C_SECCFG_RXDEC_ENA
operator||
name|R92C_SECCFG_TXBCKEY_DEF
operator||
name|R92C_SECCFG_RXBCKEY_DEF
argument_list|)
expr_stmt|;
comment|/* Enable hardware sequence numbering. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_HWSEQ_CTRL
argument_list|,
name|R92C_TX_QUEUE_ALL
argument_list|)
expr_stmt|;
comment|/* Enable per-packet TX report. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
condition|)
block|{
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R88E_TX_RPT_CTRL
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R88E_TX_RPT_CTRL
argument_list|)
operator||
name|R88E_TX_RPT1_ENA
argument_list|)
expr_stmt|;
block|}
comment|/* Perform LO and IQ calibrations. */
name|urtwn_iq_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Perform LC calibration. */
name|urtwn_lc_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Fix USB interference issue. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
block|{
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0xfe40
argument_list|,
literal|0xe0
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0xfe41
argument_list|,
literal|0x8d
argument_list|)
expr_stmt|;
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0xfe42
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|urtwn_pa_bias_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize GPIO setting. */
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|,
name|urtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|)
operator|&
operator|~
name|R92C_GPIO_MUXCFG_ENBT
argument_list|)
expr_stmt|;
comment|/* Fix for lower temperature. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|URTWN_CHIP_88E
operator|)
condition|)
name|urtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x15
argument_list|,
literal|0xe9
argument_list|)
expr_stmt|;
name|usbd_transfer_start
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|URTWN_BULK_RX
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|URTWN_RUNNING
expr_stmt|;
comment|/* 	 * Install static keys (if any). 	 * Must be called after urtwn_cam_init(). 	 */
if|if
condition|(
name|vap
operator|!=
name|NULL
condition|)
name|urtwn_setup_static_keys
argument_list|(
name|sc
argument_list|,
name|URTWN_VAP
argument_list|(
name|vap
argument_list|)
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|urtwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|usb_err
operator|!=
name|USB_ERR_NORMAL_COMPLETION
condition|)
name|error
operator|=
name|EIO
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_stop
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_RUNNING
operator|)
condition|)
block|{
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
operator|(
name|URTWN_RUNNING
operator||
name|URTWN_FW_LOADED
operator||
name|URTWN_TEMP_MEASURED
operator|)
expr_stmt|;
name|sc
operator|->
name|thcal_lctemp
operator|=
literal|0
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|)
expr_stmt|;
name|urtwn_abort_xfers
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_drain_mbufq
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|urtwn_power_off
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_abort_xfers
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|URTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* abort any pending transfers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|URTWN_N_TRANSFER
condition|;
name|i
operator|++
control|)
name|usbd_transfer_stop
argument_list|(
name|sc
operator|->
name|sc_xfer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|urtwn_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|urtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|urtwn_data
modifier|*
name|bf
decl_stmt|;
name|int
name|error
decl_stmt|;
name|URTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|URTWN_DEBUG_XMIT
argument_list|,
literal|"%s: called; m=%p\n"
argument_list|,
name|__func__
argument_list|,
name|m
argument_list|)
expr_stmt|;
comment|/* prevent management frames from being sent if we're not ready */
name|URTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|URTWN_RUNNING
operator|)
condition|)
block|{
name|error
operator|=
name|ENETDOWN
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|bf
operator|=
name|urtwn_getbuf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bf
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|params
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * Legacy path; interpret frame contents to decide 		 * precisely how to send the frame. 		 */
name|error
operator|=
name|urtwn_tx_data
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
name|bf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Caller supplied explicit parameters to use in 		 * sending the frame. 		 */
name|error
operator|=
name|urtwn_tx_raw
argument_list|(
name|sc
argument_list|,
name|ni
argument_list|,
name|m
argument_list|,
name|bf
argument_list|,
name|params
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|STAILQ_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|sc_tx_inactive
argument_list|,
name|bf
argument_list|,
name|next
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|sc
operator|->
name|sc_txtimer
operator|=
literal|5
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_watchdog_ch
argument_list|,
name|hz
argument_list|,
name|urtwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|URTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|urtwn_ms_delay
parameter_list|(
name|struct
name|urtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|usb_pause_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|hz
operator|/
literal|1000
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|urtwn_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|urtwn_match
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|urtwn_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|urtwn_detach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|urtwn_driver
init|=
block|{
literal|"urtwn"
block|,
name|urtwn_methods
block|,
expr|sizeof
operator|(
expr|struct
name|urtwn_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|urtwn_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|urtwn
argument_list|,
name|uhub
argument_list|,
name|urtwn_driver
argument_list|,
name|urtwn_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|urtwn
argument_list|,
name|usb
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|urtwn
argument_list|,
name|wlan
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|URTWN_WITHOUT_UCODE
end_ifndef

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|urtwn
argument_list|,
name|firmware
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|urtwn
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|USB_PNP_HOST_INFO
argument_list|(
name|urtwn_devs
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


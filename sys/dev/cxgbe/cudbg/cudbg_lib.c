begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2017 Chelsio Communications, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|"common/common.h"
end_include

begin_include
include|#
directive|include
file|"common/t4_regs.h"
end_include

begin_include
include|#
directive|include
file|"cudbg.h"
end_include

begin_include
include|#
directive|include
file|"cudbg_lib_common.h"
end_include

begin_include
include|#
directive|include
file|"cudbg_lib.h"
end_include

begin_include
include|#
directive|include
file|"cudbg_entity.h"
end_include

begin_define
define|#
directive|define
name|BUFFER_WARN_LIMIT
value|10000000
end_define

begin_decl_stmt
name|struct
name|large_entity
name|large_entity_list
index|[]
init|=
block|{
block|{
name|CUDBG_EDC0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|CUDBG_EDC1
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|CUDBG_MC0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|CUDBG_MC1
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|is_fw_attached
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|)
block|{
return|return
operator|(
name|pdbg_init
operator|->
name|adap
operator|->
name|flags
operator|&
name|FW_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* This function will add additional padding bytes into debug_buffer to make it  * 4 byte aligned.*/
end_comment

begin_function
specifier|static
name|void
name|align_debug_buffer
parameter_list|(
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_entity_hdr
modifier|*
name|entity_hdr
parameter_list|)
block|{
name|u8
name|zero_buf
index|[
literal|4
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|u8
name|padding
decl_stmt|,
name|remain
decl_stmt|;
name|remain
operator|=
operator|(
name|dbg_buff
operator|->
name|offset
operator|-
name|entity_hdr
operator|->
name|start_offset
operator|)
operator|%
literal|4
expr_stmt|;
name|padding
operator|=
literal|4
operator|-
name|remain
expr_stmt|;
if|if
condition|(
name|remain
condition|)
block|{
name|memcpy
argument_list|(
operator|(
operator|(
name|u8
operator|*
operator|)
name|dbg_buff
operator|->
name|data
operator|)
operator|+
name|dbg_buff
operator|->
name|offset
argument_list|,
operator|&
name|zero_buf
argument_list|,
name|padding
argument_list|)
expr_stmt|;
name|dbg_buff
operator|->
name|offset
operator|+=
name|padding
expr_stmt|;
name|entity_hdr
operator|->
name|num_pad
operator|=
name|padding
expr_stmt|;
block|}
name|entity_hdr
operator|->
name|size
operator|=
name|dbg_buff
operator|->
name|offset
operator|-
name|entity_hdr
operator|->
name|start_offset
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|read_sge_ctxt
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|u32
name|cid
parameter_list|,
name|enum
name|ctxt_type
name|ctype
parameter_list|,
name|u32
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|int
name|rc
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|is_fw_attached
argument_list|(
name|pdbg_init
argument_list|)
condition|)
name|rc
operator|=
name|t4_sge_ctxt_rd
argument_list|(
name|padap
argument_list|,
name|padap
operator|->
name|mbox
argument_list|,
name|cid
argument_list|,
name|ctype
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|t4_sge_ctxt_rd_bd
argument_list|(
name|padap
argument_list|,
name|cid
argument_list|,
name|ctype
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_next_ext_entity_hdr
parameter_list|(
name|void
modifier|*
name|outbuf
parameter_list|,
name|u32
modifier|*
name|ext_size
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_entity_hdr
modifier|*
modifier|*
name|entity_hdr
parameter_list|)
block|{
name|struct
name|cudbg_hdr
modifier|*
name|cudbg_hdr
init|=
operator|(
expr|struct
name|cudbg_hdr
operator|*
operator|)
name|outbuf
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|u32
name|ext_offset
init|=
name|cudbg_hdr
operator|->
name|data_len
decl_stmt|;
operator|*
name|ext_size
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dbg_buff
operator|->
name|size
operator|-
name|dbg_buff
operator|->
name|offset
operator|<=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
condition|)
block|{
name|rc
operator|=
name|CUDBG_STATUS_BUFFER_SHORT
expr_stmt|;
goto|goto
name|err
goto|;
block|}
operator|*
name|entity_hdr
operator|=
operator|(
expr|struct
name|cudbg_entity_hdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|outbuf
operator|+
name|cudbg_hdr
operator|->
name|data_len
operator|)
expr_stmt|;
comment|/* Find the last extended entity header */
while|while
condition|(
operator|(
operator|*
name|entity_hdr
operator|)
operator|->
name|size
condition|)
block|{
name|ext_offset
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
operator|+
operator|(
operator|*
name|entity_hdr
operator|)
operator|->
name|size
expr_stmt|;
operator|*
name|ext_size
operator|+=
operator|(
operator|*
name|entity_hdr
operator|)
operator|->
name|size
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbg_buff
operator|->
name|size
operator|-
name|dbg_buff
operator|->
name|offset
operator|+
operator|*
name|ext_size
operator|<=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
condition|)
block|{
name|rc
operator|=
name|CUDBG_STATUS_BUFFER_SHORT
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|ext_offset
operator|!=
operator|(
operator|*
name|entity_hdr
operator|)
operator|->
name|next_ext_offset
condition|)
block|{
name|ext_offset
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
operator|+
operator|(
operator|*
name|entity_hdr
operator|)
operator|->
name|size
expr_stmt|;
break|break;
block|}
operator|(
operator|*
name|entity_hdr
operator|)
operator|->
name|next_ext_offset
operator|=
operator|*
name|ext_size
expr_stmt|;
operator|*
name|entity_hdr
operator|=
operator|(
expr|struct
name|cudbg_entity_hdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|outbuf
operator|+
name|ext_offset
operator|)
expr_stmt|;
block|}
comment|/* update the data offset */
name|dbg_buff
operator|->
name|offset
operator|=
name|ext_offset
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wr_entity_to_flash
parameter_list|(
name|void
modifier|*
name|handle
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|u32
name|cur_entity_data_offset
parameter_list|,
name|u32
name|cur_entity_size
parameter_list|,
name|int
name|entity_nu
parameter_list|,
name|u32
name|ext_size
parameter_list|)
block|{
name|struct
name|cudbg_private
modifier|*
name|priv
init|=
name|handle
decl_stmt|;
name|struct
name|cudbg_init
modifier|*
name|cudbg_init
init|=
operator|&
name|priv
operator|->
name|dbg_init
decl_stmt|;
name|struct
name|cudbg_flash_sec_info
modifier|*
name|sec_info
init|=
operator|&
name|priv
operator|->
name|sec_info
decl_stmt|;
name|u64
name|timestamp
decl_stmt|;
name|u32
name|cur_entity_hdr_offset
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_hdr
argument_list|)
decl_stmt|;
name|u32
name|remain_flash_size
decl_stmt|;
name|u32
name|flash_data_offset
decl_stmt|;
name|u32
name|data_hdr_size
decl_stmt|;
name|int
name|rc
init|=
operator|-
literal|1
decl_stmt|;
name|data_hdr_size
operator|=
name|CUDBG_MAX_ENTITY
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_hdr
argument_list|)
expr_stmt|;
name|flash_data_offset
operator|=
operator|(
name|FLASH_CUDBG_NSECS
operator|*
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_flash_hdr
argument_list|)
operator|+
name|data_hdr_size
operator|)
operator|)
operator|+
operator|(
name|cur_entity_data_offset
operator|-
name|data_hdr_size
operator|)
expr_stmt|;
if|if
condition|(
name|flash_data_offset
operator|>
name|CUDBG_FLASH_SIZE
condition|)
block|{
name|update_skip_size
argument_list|(
name|sec_info
argument_list|,
name|cur_entity_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|cudbg_init
operator|->
name|verbose
condition|)
name|cudbg_init
operator|->
name|print
argument_list|(
literal|"Large entity skipping...\n"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|remain_flash_size
operator|=
name|CUDBG_FLASH_SIZE
operator|-
name|flash_data_offset
expr_stmt|;
if|if
condition|(
name|cur_entity_size
operator|>
name|remain_flash_size
condition|)
block|{
name|update_skip_size
argument_list|(
name|sec_info
argument_list|,
name|cur_entity_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|cudbg_init
operator|->
name|verbose
condition|)
name|cudbg_init
operator|->
name|print
argument_list|(
literal|"Large entity skipping...\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|timestamp
operator|=
literal|0
expr_stmt|;
name|cur_entity_hdr_offset
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
operator|*
operator|(
name|entity_nu
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|rc
operator|=
name|cudbg_write_flash
argument_list|(
name|handle
argument_list|,
name|timestamp
argument_list|,
name|dbg_buff
argument_list|,
name|cur_entity_data_offset
argument_list|,
name|cur_entity_hdr_offset
argument_list|,
name|cur_entity_size
argument_list|,
name|ext_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|CUDBG_STATUS_FLASH_FULL
operator|&&
name|cudbg_init
operator|->
name|verbose
condition|)
name|cudbg_init
operator|->
name|print
argument_list|(
literal|"\n\tFLASH is full... "
literal|"can not write in flash more\n\n"
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|cudbg_collect
parameter_list|(
name|void
modifier|*
name|handle
parameter_list|,
name|void
modifier|*
name|outbuf
parameter_list|,
name|u32
modifier|*
name|outbuf_size
parameter_list|)
block|{
name|struct
name|cudbg_entity_hdr
modifier|*
name|entity_hdr
init|=
name|NULL
decl_stmt|;
name|struct
name|cudbg_entity_hdr
modifier|*
name|ext_entity_hdr
init|=
name|NULL
decl_stmt|;
name|struct
name|cudbg_hdr
modifier|*
name|cudbg_hdr
decl_stmt|;
name|struct
name|cudbg_buffer
name|dbg_buff
decl_stmt|;
name|struct
name|cudbg_error
name|cudbg_err
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|large_entity_code
decl_stmt|;
name|u8
modifier|*
name|dbg_bitmap
init|=
operator|(
operator|(
expr|struct
name|cudbg_private
operator|*
operator|)
name|handle
operator|)
operator|->
name|dbg_init
operator|.
name|dbg_bitmap
decl_stmt|;
name|struct
name|cudbg_init
modifier|*
name|cudbg_init
init|=
operator|&
operator|(
operator|(
operator|(
expr|struct
name|cudbg_private
operator|*
operator|)
name|handle
operator|)
operator|->
name|dbg_init
operator|)
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|cudbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|total_size
decl_stmt|,
name|remaining_buf_size
decl_stmt|;
name|u32
name|ext_size
init|=
literal|0
decl_stmt|;
name|int
name|index
decl_stmt|,
name|bit
decl_stmt|,
name|i
decl_stmt|,
name|rc
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|all
decl_stmt|;
name|bool
name|flag_ext
init|=
literal|0
decl_stmt|;
name|reset_skip_entity
argument_list|()
expr_stmt|;
name|dbg_buff
operator|.
name|data
operator|=
name|outbuf
expr_stmt|;
name|dbg_buff
operator|.
name|size
operator|=
operator|*
name|outbuf_size
expr_stmt|;
name|dbg_buff
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|cudbg_hdr
operator|=
operator|(
expr|struct
name|cudbg_hdr
operator|*
operator|)
name|dbg_buff
operator|.
name|data
expr_stmt|;
name|cudbg_hdr
operator|->
name|signature
operator|=
name|CUDBG_SIGNATURE
expr_stmt|;
name|cudbg_hdr
operator|->
name|hdr_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_hdr
argument_list|)
expr_stmt|;
name|cudbg_hdr
operator|->
name|major_ver
operator|=
name|CUDBG_MAJOR_VERSION
expr_stmt|;
name|cudbg_hdr
operator|->
name|minor_ver
operator|=
name|CUDBG_MINOR_VERSION
expr_stmt|;
name|cudbg_hdr
operator|->
name|max_entities
operator|=
name|CUDBG_MAX_ENTITY
expr_stmt|;
name|cudbg_hdr
operator|->
name|chip_ver
operator|=
name|padap
operator|->
name|params
operator|.
name|chipid
expr_stmt|;
if|if
condition|(
name|cudbg_hdr
operator|->
name|data_len
condition|)
name|flag_ext
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cudbg_init
operator|->
name|use_flash
condition|)
block|{
ifndef|#
directive|ifndef
name|notyet
name|rc
operator|=
name|t4_get_flash_params
argument_list|(
name|padap
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|cudbg_init
operator|->
name|verbose
condition|)
name|cudbg_init
operator|->
name|print
argument_list|(
literal|"\nGet flash params failed.\n\n"
argument_list|)
expr_stmt|;
name|cudbg_init
operator|->
name|use_flash
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|notyet
comment|/* Timestamp is mandatory. If it is not passed then disable 		 * flash support 		 */
if|if
condition|(
operator|!
name|cudbg_init
operator|->
name|dbg_params
index|[
name|CUDBG_TIMESTAMP_PARAM
index|]
operator|.
name|u
operator|.
name|time
condition|)
block|{
if|if
condition|(
name|cudbg_init
operator|->
name|verbose
condition|)
name|cudbg_init
operator|->
name|print
argument_list|(
literal|"\nTimestamp param missing,"
literal|"so ignoring flash write request\n\n"
argument_list|)
expr_stmt|;
name|cudbg_init
operator|->
name|use_flash
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
operator|*
name|CUDBG_MAX_ENTITY
operator|>
name|dbg_buff
operator|.
name|size
condition|)
block|{
name|rc
operator|=
name|CUDBG_STATUS_SMALL_BUFF
expr_stmt|;
name|total_size
operator|=
name|cudbg_hdr
operator|->
name|hdr_len
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* If ext flag is set then move the offset to the end of the buf 	 * so that we can add ext entities 	 */
if|if
condition|(
name|flag_ext
condition|)
block|{
name|ext_entity_hdr
operator|=
operator|(
expr|struct
name|cudbg_entity_hdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|outbuf
operator|+
name|cudbg_hdr
operator|->
name|hdr_len
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
operator|*
operator|(
name|CUDBG_EXT_ENTITY
operator|-
literal|1
operator|)
operator|)
operator|)
expr_stmt|;
name|ext_entity_hdr
operator|->
name|start_offset
operator|=
name|cudbg_hdr
operator|->
name|data_len
expr_stmt|;
name|ext_entity_hdr
operator|->
name|entity_type
operator|=
name|CUDBG_EXT_ENTITY
expr_stmt|;
name|ext_entity_hdr
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|dbg_buff
operator|.
name|offset
operator|=
name|cudbg_hdr
operator|->
name|data_len
expr_stmt|;
block|}
else|else
block|{
name|dbg_buff
operator|.
name|offset
operator|+=
name|cudbg_hdr
operator|->
name|hdr_len
expr_stmt|;
comment|/* move 24 bytes*/
name|dbg_buff
operator|.
name|offset
operator|+=
name|CUDBG_MAX_ENTITY
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
expr_stmt|;
block|}
name|total_size
operator|=
name|dbg_buff
operator|.
name|offset
expr_stmt|;
name|all
operator|=
name|dbg_bitmap
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
name|CUDBG_ALL
operator|)
expr_stmt|;
comment|/*sort(large_entity_list);*/
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|CUDBG_MAX_ENTITY
condition|;
name|i
operator|++
control|)
block|{
name|index
operator|=
name|i
operator|/
literal|8
expr_stmt|;
name|bit
operator|=
name|i
operator|%
literal|8
expr_stmt|;
if|if
condition|(
name|entity_list
index|[
name|i
index|]
operator|.
name|bit
operator|==
name|CUDBG_EXT_ENTITY
condition|)
continue|continue;
if|if
condition|(
name|all
operator|||
operator|(
name|dbg_bitmap
index|[
name|index
index|]
operator|&
operator|(
literal|1
operator|<<
name|bit
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|flag_ext
condition|)
block|{
name|rc
operator|=
name|get_entity_hdr
argument_list|(
name|outbuf
argument_list|,
name|i
argument_list|,
name|dbg_buff
operator|.
name|size
argument_list|,
operator|&
name|entity_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|cudbg_hdr
operator|->
name|hdr_flags
operator|=
name|rc
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
name|get_next_ext_entity_hdr
argument_list|(
name|outbuf
argument_list|,
operator|&
name|ext_size
argument_list|,
operator|&
name|dbg_buff
argument_list|,
operator|&
name|entity_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* move the offset after the ext header */
name|dbg_buff
operator|.
name|offset
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
expr_stmt|;
block|}
name|entity_hdr
operator|->
name|entity_type
operator|=
name|i
expr_stmt|;
name|entity_hdr
operator|->
name|start_offset
operator|=
name|dbg_buff
operator|.
name|offset
expr_stmt|;
comment|/* process each entity by calling process_entity fp */
name|remaining_buf_size
operator|=
name|dbg_buff
operator|.
name|size
operator|-
name|dbg_buff
operator|.
name|offset
expr_stmt|;
if|if
condition|(
operator|(
name|remaining_buf_size
operator|<=
name|BUFFER_WARN_LIMIT
operator|)
operator|&&
name|is_large_entity
argument_list|(
name|i
argument_list|)
condition|)
block|{
if|if
condition|(
name|cudbg_init
operator|->
name|verbose
condition|)
name|cudbg_init
operator|->
name|print
argument_list|(
literal|"Skipping %s\n"
argument_list|,
name|entity_list
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|skip_entity
argument_list|(
name|i
argument_list|)
expr_stmt|;
continue|continue;
block|}
else|else
block|{
comment|/* If fw_attach is 0, then skip entities which 				 * communicates with firmware 				 */
if|if
condition|(
operator|!
name|is_fw_attached
argument_list|(
name|cudbg_init
argument_list|)
operator|&&
operator|(
name|entity_list
index|[
name|i
index|]
operator|.
name|flag
operator|&
operator|(
literal|1
operator|<<
name|ENTITY_FLAG_FW_NO_ATTACH
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|cudbg_init
operator|->
name|verbose
condition|)
name|cudbg_init
operator|->
name|print
argument_list|(
literal|"Skipping %s entity,"
expr|\
literal|"because fw_attach "
expr|\
literal|"is 0\n"
argument_list|,
name|entity_list
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|cudbg_init
operator|->
name|verbose
condition|)
name|cudbg_init
operator|->
name|print
argument_list|(
literal|"collecting debug entity: "
expr|\
literal|"%s\n"
argument_list|,
name|entity_list
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|cudbg_err
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_error
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|process_entity
index|[
name|i
operator|-
literal|1
index|]
operator|(
name|cudbg_init
operator|,
operator|&
name|dbg_buff
operator|,
operator|&
name|cudbg_err
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|rc
condition|)
block|{
name|entity_hdr
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|dbg_buff
operator|.
name|offset
operator|=
name|entity_hdr
operator|->
name|start_offset
expr_stmt|;
block|}
else|else
name|align_debug_buffer
argument_list|(
operator|&
name|dbg_buff
argument_list|,
name|entity_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cudbg_err
operator|.
name|sys_err
condition|)
name|rc
operator|=
name|CUDBG_SYSTEM_ERROR
expr_stmt|;
name|entity_hdr
operator|->
name|hdr_flags
operator|=
name|rc
expr_stmt|;
name|entity_hdr
operator|->
name|sys_err
operator|=
name|cudbg_err
operator|.
name|sys_err
expr_stmt|;
name|entity_hdr
operator|->
name|sys_warn
operator|=
name|cudbg_err
operator|.
name|sys_warn
expr_stmt|;
comment|/* We don't want to include ext entity size in global 			 * header 			 */
if|if
condition|(
operator|!
name|flag_ext
condition|)
name|total_size
operator|+=
name|entity_hdr
operator|->
name|size
expr_stmt|;
name|cudbg_hdr
operator|->
name|data_len
operator|=
name|total_size
expr_stmt|;
operator|*
name|outbuf_size
operator|=
name|total_size
expr_stmt|;
comment|/* consider the size of the ext entity header and data 			 * also 			 */
if|if
condition|(
name|flag_ext
condition|)
block|{
name|ext_size
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
operator|+
name|entity_hdr
operator|->
name|size
operator|)
expr_stmt|;
name|entity_hdr
operator|->
name|start_offset
operator|-=
name|cudbg_hdr
operator|->
name|data_len
expr_stmt|;
name|ext_entity_hdr
operator|->
name|size
operator|=
name|ext_size
expr_stmt|;
name|entity_hdr
operator|->
name|next_ext_offset
operator|=
name|ext_size
expr_stmt|;
name|entity_hdr
operator|->
name|flag
operator||=
name|CUDBG_EXT_DATA_VALID
expr_stmt|;
block|}
if|if
condition|(
name|cudbg_init
operator|->
name|use_flash
condition|)
block|{
if|if
condition|(
name|flag_ext
condition|)
block|{
name|wr_entity_to_flash
argument_list|(
name|handle
argument_list|,
operator|&
name|dbg_buff
argument_list|,
name|ext_entity_hdr
operator|->
name|start_offset
argument_list|,
name|entity_hdr
operator|->
name|size
argument_list|,
name|CUDBG_EXT_ENTITY
argument_list|,
name|ext_size
argument_list|)
expr_stmt|;
block|}
else|else
name|wr_entity_to_flash
argument_list|(
name|handle
argument_list|,
operator|&
name|dbg_buff
argument_list|,
name|entity_hdr
operator|->
name|\
name|start_offset
argument_list|,
name|entity_hdr
operator|->
name|size
argument_list|,
name|i
argument_list|,
name|ext_size
argument_list|)
expr_stmt|;
block|}
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|large_entity_list
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|large_entity
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|large_entity_code
operator|=
name|large_entity_list
index|[
name|i
index|]
operator|.
name|entity_code
expr_stmt|;
if|if
condition|(
name|large_entity_list
index|[
name|i
index|]
operator|.
name|skip_flag
condition|)
block|{
if|if
condition|(
operator|!
name|flag_ext
condition|)
block|{
name|rc
operator|=
name|get_entity_hdr
argument_list|(
name|outbuf
argument_list|,
name|large_entity_code
argument_list|,
name|dbg_buff
operator|.
name|size
argument_list|,
operator|&
name|entity_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|cudbg_hdr
operator|->
name|hdr_flags
operator|=
name|rc
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
name|get_next_ext_entity_hdr
argument_list|(
name|outbuf
argument_list|,
operator|&
name|ext_size
argument_list|,
operator|&
name|dbg_buff
argument_list|,
operator|&
name|entity_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|dbg_buff
operator|.
name|offset
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
expr_stmt|;
block|}
comment|/* If fw_attach is 0, then skip entities which 			 * communicates with firmware 			 */
if|if
condition|(
operator|!
name|is_fw_attached
argument_list|(
name|cudbg_init
argument_list|)
operator|&&
operator|(
name|entity_list
index|[
name|large_entity_code
index|]
operator|.
name|flag
operator|&
operator|(
literal|1
operator|<<
name|ENTITY_FLAG_FW_NO_ATTACH
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|cudbg_init
operator|->
name|verbose
condition|)
name|cudbg_init
operator|->
name|print
argument_list|(
literal|"Skipping %s entity,"
expr|\
literal|"because fw_attach "
expr|\
literal|"is 0\n"
argument_list|,
name|entity_list
index|[
name|large_entity_code
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|entity_hdr
operator|->
name|entity_type
operator|=
name|large_entity_code
expr_stmt|;
name|entity_hdr
operator|->
name|start_offset
operator|=
name|dbg_buff
operator|.
name|offset
expr_stmt|;
if|if
condition|(
name|cudbg_init
operator|->
name|verbose
condition|)
name|cudbg_init
operator|->
name|print
argument_list|(
literal|"Re-trying debug entity: %s\n"
argument_list|,
name|entity_list
index|[
name|large_entity_code
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|cudbg_err
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_error
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|process_entity
index|[
name|large_entity_code
operator|-
literal|1
index|]
operator|(
name|cudbg_init
operator|,
operator|&
name|dbg_buff
operator|,
operator|&
name|cudbg_err
operator|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|entity_hdr
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|dbg_buff
operator|.
name|offset
operator|=
name|entity_hdr
operator|->
name|start_offset
expr_stmt|;
block|}
else|else
name|align_debug_buffer
argument_list|(
operator|&
name|dbg_buff
argument_list|,
name|entity_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cudbg_err
operator|.
name|sys_err
condition|)
name|rc
operator|=
name|CUDBG_SYSTEM_ERROR
expr_stmt|;
name|entity_hdr
operator|->
name|hdr_flags
operator|=
name|rc
expr_stmt|;
name|entity_hdr
operator|->
name|sys_err
operator|=
name|cudbg_err
operator|.
name|sys_err
expr_stmt|;
name|entity_hdr
operator|->
name|sys_warn
operator|=
name|cudbg_err
operator|.
name|sys_warn
expr_stmt|;
comment|/* We don't want to include ext entity size in global 			 * header 			 */
if|if
condition|(
operator|!
name|flag_ext
condition|)
name|total_size
operator|+=
name|entity_hdr
operator|->
name|size
expr_stmt|;
name|cudbg_hdr
operator|->
name|data_len
operator|=
name|total_size
expr_stmt|;
operator|*
name|outbuf_size
operator|=
name|total_size
expr_stmt|;
comment|/* consider the size of the ext entity header and 			 * data also 			 */
if|if
condition|(
name|flag_ext
condition|)
block|{
name|ext_size
operator|+=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
operator|+
name|entity_hdr
operator|->
name|size
operator|)
expr_stmt|;
name|entity_hdr
operator|->
name|start_offset
operator|-=
name|cudbg_hdr
operator|->
name|data_len
expr_stmt|;
name|ext_entity_hdr
operator|->
name|size
operator|=
name|ext_size
expr_stmt|;
name|entity_hdr
operator|->
name|flag
operator||=
name|CUDBG_EXT_DATA_VALID
expr_stmt|;
block|}
if|if
condition|(
name|cudbg_init
operator|->
name|use_flash
condition|)
block|{
if|if
condition|(
name|flag_ext
condition|)
name|wr_entity_to_flash
argument_list|(
name|handle
argument_list|,
operator|&
name|dbg_buff
argument_list|,
name|ext_entity_hdr
operator|->
name|start_offset
argument_list|,
name|entity_hdr
operator|->
name|size
argument_list|,
name|CUDBG_EXT_ENTITY
argument_list|,
name|ext_size
argument_list|)
expr_stmt|;
else|else
name|wr_entity_to_flash
argument_list|(
name|handle
argument_list|,
operator|&
name|dbg_buff
argument_list|,
name|entity_hdr
operator|->
name|start_offset
argument_list|,
name|entity_hdr
operator|->
name|size
argument_list|,
name|large_entity_list
index|[
name|i
index|]
operator|.
name|entity_code
argument_list|,
name|ext_size
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|cudbg_hdr
operator|->
name|data_len
operator|=
name|total_size
expr_stmt|;
operator|*
name|outbuf_size
operator|=
name|total_size
expr_stmt|;
if|if
condition|(
name|flag_ext
condition|)
operator|*
name|outbuf_size
operator|+=
name|ext_size
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|void
name|reset_skip_entity
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|large_entity_list
argument_list|)
condition|;
name|i
operator|++
control|)
name|large_entity_list
index|[
name|i
index|]
operator|.
name|skip_flag
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|skip_entity
parameter_list|(
name|int
name|entity_code
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|large_entity_list
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|large_entity
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|large_entity_list
index|[
name|i
index|]
operator|.
name|entity_code
operator|==
name|entity_code
condition|)
name|large_entity_list
index|[
name|i
index|]
operator|.
name|skip_flag
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|is_large_entity
parameter_list|(
name|int
name|entity_code
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|large_entity_list
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|large_entity
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|large_entity_list
index|[
name|i
index|]
operator|.
name|entity_code
operator|==
name|entity_code
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|get_entity_hdr
parameter_list|(
name|void
modifier|*
name|outbuf
parameter_list|,
name|int
name|i
parameter_list|,
name|u32
name|size
parameter_list|,
name|struct
name|cudbg_entity_hdr
modifier|*
modifier|*
name|entity_hdr
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|struct
name|cudbg_hdr
modifier|*
name|cudbg_hdr
init|=
operator|(
expr|struct
name|cudbg_hdr
operator|*
operator|)
name|outbuf
decl_stmt|;
if|if
condition|(
name|cudbg_hdr
operator|->
name|hdr_len
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
operator|*
name|i
operator|)
operator|>
name|size
condition|)
return|return
name|CUDBG_STATUS_SMALL_BUFF
return|;
operator|*
name|entity_hdr
operator|=
operator|(
expr|struct
name|cudbg_entity_hdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|outbuf
operator|+
name|cudbg_hdr
operator|->
name|hdr_len
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_entity_hdr
argument_list|)
operator|*
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
operator|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_rss
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
name|RSS_NENTRIES
operator|*
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|rc
operator|=
name|t4_read_rss
argument_list|(
name|padap
argument_list|,
operator|(
name|u16
operator|*
operator|)
name|scratch_buff
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s(), t4_read_rss failed!, rc: %d\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_sw_state
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|sw_state
modifier|*
name|swstate
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sw_state
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|swstate
operator|=
operator|(
expr|struct
name|sw_state
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|swstate
operator|->
name|fw_state
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_PCIE_FW
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|swstate
operator|->
name|caller_string
argument_list|,
sizeof|sizeof
argument_list|(
name|swstate
operator|->
name|caller_string
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"FreeBSD"
argument_list|)
expr_stmt|;
name|swstate
operator|->
name|os_type
operator|=
literal|0
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_ddp_stats
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|tp_usm_stats
modifier|*
name|tp_usm_stats_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|tp_usm_stats
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|tp_usm_stats_buff
operator|=
operator|(
expr|struct
name|tp_usm_stats
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/* spin_lock(&padap->stats_lock);	TODO*/
name|t4_get_usm_stats
argument_list|(
name|padap
argument_list|,
name|tp_usm_stats_buff
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* spin_unlock(&padap->stats_lock);	TODO*/
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_ulptx_la
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_ulptx_la
modifier|*
name|ulptx_la_buff
decl_stmt|;
name|u32
name|size
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_ulptx_la
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|ulptx_la_buff
operator|=
operator|(
expr|struct
name|struct_ulptx_la
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CUDBG_NUM_ULPTX
condition|;
name|i
operator|++
control|)
block|{
name|ulptx_la_buff
operator|->
name|rdptr
index|[
name|i
index|]
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_ULP_TX_LA_RDPTR_0
operator|+
literal|0x10
operator|*
name|i
argument_list|)
expr_stmt|;
name|ulptx_la_buff
operator|->
name|wrptr
index|[
name|i
index|]
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_ULP_TX_LA_WRPTR_0
operator|+
literal|0x10
operator|*
name|i
argument_list|)
expr_stmt|;
name|ulptx_la_buff
operator|->
name|rddata
index|[
name|i
index|]
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_ULP_TX_LA_RDDATA_0
operator|+
literal|0x10
operator|*
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|CUDBG_NUM_ULPTX_READ
condition|;
name|j
operator|++
control|)
block|{
name|ulptx_la_buff
operator|->
name|rd_data
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_ULP_TX_LA_RDDATA_0
operator|+
literal|0x10
operator|*
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_ulprx_la
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_ulprx_la
modifier|*
name|ulprx_la_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_ulprx_la
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|ulprx_la_buff
operator|=
operator|(
expr|struct
name|struct_ulprx_la
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|t4_ulprx_read_la
argument_list|(
name|padap
argument_list|,
operator|(
name|u32
operator|*
operator|)
name|ulprx_la_buff
operator|->
name|data
argument_list|)
expr_stmt|;
name|ulprx_la_buff
operator|->
name|size
operator|=
name|ULPRX_LA_SIZE
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cpl_stats
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_tp_cpl_stats
modifier|*
name|tp_cpl_stats_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_tp_cpl_stats
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|tp_cpl_stats_buff
operator|=
operator|(
expr|struct
name|struct_tp_cpl_stats
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|tp_cpl_stats_buff
operator|->
name|nchan
operator|=
name|padap
operator|->
name|chip_params
operator|->
name|nchan
expr_stmt|;
comment|/* spin_lock(&padap->stats_lock);	TODO*/
name|t4_tp_get_cpl_stats
argument_list|(
name|padap
argument_list|,
operator|&
name|tp_cpl_stats_buff
operator|->
name|stats
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* spin_unlock(&padap->stats_lock);	TODO*/
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_wc_stats
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_wc_stats
modifier|*
name|wc_stats_buff
decl_stmt|;
name|u32
name|val1
decl_stmt|;
name|u32
name|val2
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_wc_stats
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|wc_stats_buff
operator|=
operator|(
expr|struct
name|struct_wc_stats
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
if|if
condition|(
operator|!
name|is_t4
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|val1
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_SGE_STAT_TOTAL
argument_list|)
expr_stmt|;
name|val2
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_SGE_STAT_MATCH
argument_list|)
expr_stmt|;
name|wc_stats_buff
operator|->
name|wr_cl_success
operator|=
name|val1
operator|-
name|val2
expr_stmt|;
name|wc_stats_buff
operator|->
name|wr_cl_fail
operator|=
name|val2
expr_stmt|;
block|}
else|else
block|{
name|wc_stats_buff
operator|->
name|wr_cl_success
operator|=
literal|0
expr_stmt|;
name|wc_stats_buff
operator|->
name|wr_cl_fail
operator|=
literal|0
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mem_desc_cmp
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|(
operator|(
specifier|const
expr|struct
name|struct_mem_desc
operator|*
operator|)
name|a
operator|)
operator|->
name|base
operator|-
operator|(
operator|(
specifier|const
expr|struct
name|struct_mem_desc
operator|*
operator|)
name|b
operator|)
operator|->
name|base
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|fill_meminfo
parameter_list|(
name|struct
name|adapter
modifier|*
name|padap
parameter_list|,
name|struct
name|struct_meminfo
modifier|*
name|meminfo_buff
parameter_list|)
block|{
name|struct
name|struct_mem_desc
modifier|*
name|md
decl_stmt|;
name|u32
name|size
decl_stmt|,
name|lo
decl_stmt|,
name|hi
decl_stmt|;
name|u32
name|used
decl_stmt|,
name|alloc
decl_stmt|;
name|int
name|n
decl_stmt|,
name|i
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_meminfo
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meminfo_buff
operator|->
name|avail
argument_list|,
literal|0
argument_list|,
name|ARRAY_SIZE
argument_list|(
name|meminfo_buff
operator|->
name|avail
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|struct_mem_desc
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meminfo_buff
operator|->
name|mem
argument_list|,
literal|0
argument_list|,
operator|(
name|ARRAY_SIZE
argument_list|(
name|region
argument_list|)
operator|+
literal|3
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|struct_mem_desc
argument_list|)
argument_list|)
expr_stmt|;
name|md
operator|=
name|meminfo_buff
operator|->
name|mem
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|meminfo_buff
operator|->
name|mem
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|meminfo_buff
operator|->
name|mem
index|[
name|i
index|]
operator|.
name|limit
operator|=
literal|0
expr_stmt|;
name|meminfo_buff
operator|->
name|mem
index|[
name|i
index|]
operator|.
name|idx
operator|=
name|i
expr_stmt|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|lo
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_TARGET_MEM_ENABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|lo
operator|&
name|F_EDRAM0_ENABLE
condition|)
block|{
name|hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_EDRAM0_BAR
argument_list|)
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|base
operator|=
name|G_EDRAM0_BASE
argument_list|(
name|hi
argument_list|)
operator|<<
literal|20
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|limit
operator|=
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|base
operator|+
operator|(
name|G_EDRAM0_SIZE
argument_list|(
name|hi
argument_list|)
operator|<<
literal|20
operator|)
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|idx
operator|=
literal|0
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|lo
operator|&
name|F_EDRAM1_ENABLE
condition|)
block|{
name|hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_EDRAM1_BAR
argument_list|)
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|base
operator|=
name|G_EDRAM1_BASE
argument_list|(
name|hi
argument_list|)
operator|<<
literal|20
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|limit
operator|=
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|base
operator|+
operator|(
name|G_EDRAM1_SIZE
argument_list|(
name|hi
argument_list|)
operator|<<
literal|20
operator|)
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|idx
operator|=
literal|1
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
if|if
condition|(
name|lo
operator|&
name|F_EXT_MEM0_ENABLE
condition|)
block|{
name|hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_EXT_MEMORY0_BAR
argument_list|)
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|base
operator|=
name|G_EXT_MEM_BASE
argument_list|(
name|hi
argument_list|)
operator|<<
literal|20
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|limit
operator|=
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|base
operator|+
operator|(
name|G_EXT_MEM_SIZE
argument_list|(
name|hi
argument_list|)
operator|<<
literal|20
operator|)
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|idx
operator|=
literal|3
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|lo
operator|&
name|F_EXT_MEM1_ENABLE
condition|)
block|{
name|hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_EXT_MEMORY1_BAR
argument_list|)
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|base
operator|=
name|G_EXT_MEM1_BASE
argument_list|(
name|hi
argument_list|)
operator|<<
literal|20
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|limit
operator|=
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|base
operator|+
operator|(
name|G_EXT_MEM1_SIZE
argument_list|(
name|hi
argument_list|)
operator|<<
literal|20
operator|)
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|idx
operator|=
literal|4
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
block|{
if|if
condition|(
name|lo
operator|&
name|F_EXT_MEM_ENABLE
condition|)
block|{
name|hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_EXT_MEMORY_BAR
argument_list|)
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|base
operator|=
name|G_EXT_MEM_BASE
argument_list|(
name|hi
argument_list|)
operator|<<
literal|20
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|limit
operator|=
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|base
operator|+
operator|(
name|G_EXT_MEM_SIZE
argument_list|(
name|hi
argument_list|)
operator|<<
literal|20
operator|)
expr_stmt|;
name|meminfo_buff
operator|->
name|avail
index|[
name|i
index|]
operator|.
name|idx
operator|=
literal|2
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|i
condition|)
block|{
comment|/* no memory available */
name|rc
operator|=
name|CUDBG_STATUS_ENTITY_NOT_FOUND
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|meminfo_buff
operator|->
name|avail_c
operator|=
name|i
expr_stmt|;
name|qsort
argument_list|(
name|meminfo_buff
operator|->
name|avail
argument_list|,
name|i
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|struct_mem_desc
argument_list|)
argument_list|,
name|mem_desc_cmp
argument_list|)
expr_stmt|;
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_SGE_DBQ_CTXT_BADDR
argument_list|)
expr_stmt|;
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_SGE_IMSG_CTXT_BADDR
argument_list|)
expr_stmt|;
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_SGE_FLM_CACHE_BADDR
argument_list|)
expr_stmt|;
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_CMM_TCB_BASE
argument_list|)
expr_stmt|;
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_CMM_MM_BASE
argument_list|)
expr_stmt|;
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_CMM_TIMER_BASE
argument_list|)
expr_stmt|;
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_CMM_MM_RX_FLST_BASE
argument_list|)
expr_stmt|;
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_CMM_MM_TX_FLST_BASE
argument_list|)
expr_stmt|;
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_CMM_MM_PS_FLST_BASE
argument_list|)
expr_stmt|;
comment|/* the next few have explicit upper bounds */
name|md
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PMM_TX_BASE
argument_list|)
expr_stmt|;
name|md
operator|->
name|limit
operator|=
name|md
operator|->
name|base
operator|-
literal|1
operator|+
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PMM_TX_PAGE_SIZE
argument_list|)
operator|*
name|G_PMTXMAXPAGE
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PMM_TX_MAX_PAGE
argument_list|)
argument_list|)
expr_stmt|;
name|md
operator|++
expr_stmt|;
name|md
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PMM_RX_BASE
argument_list|)
expr_stmt|;
name|md
operator|->
name|limit
operator|=
name|md
operator|->
name|base
operator|-
literal|1
operator|+
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PMM_RX_PAGE_SIZE
argument_list|)
operator|*
name|G_PMRXMAXPAGE
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PMM_RX_MAX_PAGE
argument_list|)
argument_list|)
expr_stmt|;
name|md
operator|++
expr_stmt|;
if|if
condition|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_CONFIG
argument_list|)
operator|&
name|F_HASHEN
condition|)
block|{
if|if
condition|(
name|chip_id
argument_list|(
name|padap
argument_list|)
operator|<=
name|CHELSIO_T5
condition|)
block|{
name|hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_TID_HASHBASE
argument_list|)
operator|/
literal|4
expr_stmt|;
name|md
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_HASH_TID_BASE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_HASH_TID_BASE
argument_list|)
expr_stmt|;
name|md
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_HASH_TBL_BASE_ADDR
argument_list|)
expr_stmt|;
block|}
name|md
operator|->
name|limit
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|md
operator|->
name|base
operator|=
literal|0
expr_stmt|;
name|md
operator|->
name|idx
operator|=
name|ARRAY_SIZE
argument_list|(
name|region
argument_list|)
expr_stmt|;
comment|/* hide it */
block|}
name|md
operator|++
expr_stmt|;
define|#
directive|define
name|ulp_region
parameter_list|(
name|reg
parameter_list|)
define|\
value|{\ 		md->base = t4_read_reg(padap, A_ULP_ ## reg ## _LLIMIT);\ 		(md++)->limit = t4_read_reg(padap, A_ULP_ ## reg ## _ULIMIT);\ 	}
name|ulp_region
argument_list|(
name|RX_ISCSI
argument_list|)
expr_stmt|;
name|ulp_region
argument_list|(
name|RX_TDDP
argument_list|)
expr_stmt|;
name|ulp_region
argument_list|(
name|TX_TPT
argument_list|)
expr_stmt|;
name|ulp_region
argument_list|(
name|RX_STAG
argument_list|)
expr_stmt|;
name|ulp_region
argument_list|(
name|RX_RQ
argument_list|)
expr_stmt|;
name|ulp_region
argument_list|(
name|RX_RQUDP
argument_list|)
expr_stmt|;
name|ulp_region
argument_list|(
name|RX_PBL
argument_list|)
expr_stmt|;
name|ulp_region
argument_list|(
name|TX_PBL
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|ulp_region
name|md
operator|->
name|base
operator|=
literal|0
expr_stmt|;
name|md
operator|->
name|idx
operator|=
name|ARRAY_SIZE
argument_list|(
name|region
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_t4
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|u32
name|sge_ctrl
init|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_SGE_CONTROL2
argument_list|)
decl_stmt|;
name|u32
name|fifo_size
init|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_SGE_DBVFIFO_SIZE
argument_list|)
decl_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
if|if
condition|(
name|sge_ctrl
operator|&
name|F_VFIFO_ENABLE
condition|)
name|size
operator|=
name|G_DBVFIFO_SIZE
argument_list|(
name|fifo_size
argument_list|)
expr_stmt|;
block|}
else|else
name|size
operator|=
name|G_T6_DBVFIFO_SIZE
argument_list|(
name|fifo_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
condition|)
block|{
name|md
operator|->
name|base
operator|=
name|G_BASEADDR
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_SGE_DBVFIFO_BADDR
argument_list|)
argument_list|)
expr_stmt|;
name|md
operator|->
name|limit
operator|=
name|md
operator|->
name|base
operator|+
operator|(
name|size
operator|<<
literal|2
operator|)
operator|-
literal|1
expr_stmt|;
block|}
block|}
name|md
operator|++
expr_stmt|;
name|md
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_ULP_RX_CTX_BASE
argument_list|)
expr_stmt|;
name|md
operator|->
name|limit
operator|=
literal|0
expr_stmt|;
name|md
operator|++
expr_stmt|;
name|md
operator|->
name|base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_ULP_TX_ERR_TABLE_BASE
argument_list|)
expr_stmt|;
name|md
operator|->
name|limit
operator|=
literal|0
expr_stmt|;
name|md
operator|++
expr_stmt|;
ifndef|#
directive|ifndef
name|__NO_DRIVER_OCQ_SUPPORT__
comment|/*md->base = padap->vres.ocq.start;*/
comment|/*if (adap->vres.ocq.size)*/
comment|/*	  md->limit = md->base + adap->vres.ocq.size - 1;*/
comment|/*else*/
name|md
operator|->
name|idx
operator|=
name|ARRAY_SIZE
argument_list|(
name|region
argument_list|)
expr_stmt|;
comment|/* hide it */
name|md
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* add any address-space holes, there can be up to 3 */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|i
operator|-
literal|1
condition|;
name|n
operator|++
control|)
if|if
condition|(
name|meminfo_buff
operator|->
name|avail
index|[
name|n
index|]
operator|.
name|limit
operator|<
name|meminfo_buff
operator|->
name|avail
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|base
condition|)
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|meminfo_buff
operator|->
name|avail
index|[
name|n
index|]
operator|.
name|limit
expr_stmt|;
if|if
condition|(
name|meminfo_buff
operator|->
name|avail
index|[
name|n
index|]
operator|.
name|limit
condition|)
operator|(
name|md
operator|++
operator|)
operator|->
name|base
operator|=
name|meminfo_buff
operator|->
name|avail
index|[
name|n
index|]
operator|.
name|limit
expr_stmt|;
name|n
operator|=
call|(
name|int
call|)
argument_list|(
name|md
operator|-
name|meminfo_buff
operator|->
name|mem
argument_list|)
expr_stmt|;
name|meminfo_buff
operator|->
name|mem_c
operator|=
name|n
expr_stmt|;
name|qsort
argument_list|(
name|meminfo_buff
operator|->
name|mem
argument_list|,
name|n
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|struct_mem_desc
argument_list|)
argument_list|,
name|mem_desc_cmp
argument_list|)
expr_stmt|;
name|lo
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_CIM_SDRAM_BASE_ADDR
argument_list|)
expr_stmt|;
name|hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_CIM_SDRAM_ADDR_SIZE
argument_list|)
operator|+
name|lo
operator|-
literal|1
expr_stmt|;
name|meminfo_buff
operator|->
name|up_ram_lo
operator|=
name|lo
expr_stmt|;
name|meminfo_buff
operator|->
name|up_ram_hi
operator|=
name|hi
expr_stmt|;
name|lo
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_CIM_EXTMEM2_BASE_ADDR
argument_list|)
expr_stmt|;
name|hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_CIM_EXTMEM2_ADDR_SIZE
argument_list|)
operator|+
name|lo
operator|-
literal|1
expr_stmt|;
name|meminfo_buff
operator|->
name|up_extmem2_lo
operator|=
name|lo
expr_stmt|;
name|meminfo_buff
operator|->
name|up_extmem2_hi
operator|=
name|hi
expr_stmt|;
name|lo
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PMM_RX_MAX_PAGE
argument_list|)
expr_stmt|;
name|meminfo_buff
operator|->
name|rx_pages_data
index|[
literal|0
index|]
operator|=
name|G_PMRXMAXPAGE
argument_list|(
name|lo
argument_list|)
expr_stmt|;
name|meminfo_buff
operator|->
name|rx_pages_data
index|[
literal|1
index|]
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PMM_RX_PAGE_SIZE
argument_list|)
operator|>>
literal|10
expr_stmt|;
name|meminfo_buff
operator|->
name|rx_pages_data
index|[
literal|2
index|]
operator|=
operator|(
name|lo
operator|&
name|F_PMRXNUMCHN
operator|)
condition|?
literal|2
else|:
literal|1
expr_stmt|;
name|lo
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PMM_TX_MAX_PAGE
argument_list|)
expr_stmt|;
name|hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PMM_TX_PAGE_SIZE
argument_list|)
expr_stmt|;
name|meminfo_buff
operator|->
name|tx_pages_data
index|[
literal|0
index|]
operator|=
name|G_PMTXMAXPAGE
argument_list|(
name|lo
argument_list|)
expr_stmt|;
name|meminfo_buff
operator|->
name|tx_pages_data
index|[
literal|1
index|]
operator|=
name|hi
operator|>=
operator|(
literal|1
operator|<<
literal|20
operator|)
condition|?
operator|(
name|hi
operator|>>
literal|20
operator|)
else|:
operator|(
name|hi
operator|>>
literal|10
operator|)
expr_stmt|;
name|meminfo_buff
operator|->
name|tx_pages_data
index|[
literal|2
index|]
operator|=
name|hi
operator|>=
operator|(
literal|1
operator|<<
literal|20
operator|)
condition|?
literal|'M'
else|:
literal|'K'
expr_stmt|;
name|meminfo_buff
operator|->
name|tx_pages_data
index|[
literal|3
index|]
operator|=
literal|1
operator|<<
name|G_PMTXNUMCHN
argument_list|(
name|lo
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|chip_id
argument_list|(
name|padap
argument_list|)
operator|>
name|CHELSIO_T5
condition|)
name|lo
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_RX_MAC_BG_PG_CNT0
operator|+
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
else|else
name|lo
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_RX_PG_RSV0
operator|+
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|used
operator|=
name|G_T5_USED
argument_list|(
name|lo
argument_list|)
expr_stmt|;
name|alloc
operator|=
name|G_T5_ALLOC
argument_list|(
name|lo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|used
operator|=
name|G_USED
argument_list|(
name|lo
argument_list|)
expr_stmt|;
name|alloc
operator|=
name|G_ALLOC
argument_list|(
name|lo
argument_list|)
expr_stmt|;
block|}
name|meminfo_buff
operator|->
name|port_used
index|[
name|i
index|]
operator|=
name|used
expr_stmt|;
name|meminfo_buff
operator|->
name|port_alloc
index|[
name|i
index|]
operator|=
name|alloc
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|padap
operator|->
name|chip_params
operator|->
name|nchan
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|chip_id
argument_list|(
name|padap
argument_list|)
operator|>
name|CHELSIO_T5
condition|)
name|lo
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_RX_LPBK_BG_PG_CNT0
operator|+
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
else|else
name|lo
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_RX_PG_RSV4
operator|+
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|used
operator|=
name|G_T5_USED
argument_list|(
name|lo
argument_list|)
expr_stmt|;
name|alloc
operator|=
name|G_T5_ALLOC
argument_list|(
name|lo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|used
operator|=
name|G_USED
argument_list|(
name|lo
argument_list|)
expr_stmt|;
name|alloc
operator|=
name|G_ALLOC
argument_list|(
name|lo
argument_list|)
expr_stmt|;
block|}
name|meminfo_buff
operator|->
name|loopback_used
index|[
name|i
index|]
operator|=
name|used
expr_stmt|;
name|meminfo_buff
operator|->
name|loopback_alloc
index|[
name|i
index|]
operator|=
name|alloc
expr_stmt|;
block|}
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_meminfo
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_meminfo
modifier|*
name|meminfo_buff
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_meminfo
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|meminfo_buff
operator|=
operator|(
expr|struct
name|struct_meminfo
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|rc
operator|=
name|fill_meminfo
argument_list|(
name|padap
argument_list|,
name|meminfo_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_lb_stats
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|lb_port_stats
modifier|*
name|tmp_stats
decl_stmt|;
name|struct
name|struct_lb_stats
modifier|*
name|lb_stats_buff
decl_stmt|;
name|u32
name|i
decl_stmt|,
name|n
decl_stmt|,
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|rc
operator|=
name|padap
operator|->
name|params
operator|.
name|nports
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
name|n
operator|=
name|rc
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_lb_stats
argument_list|)
operator|+
name|n
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|lb_port_stats
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|lb_stats_buff
operator|=
operator|(
expr|struct
name|struct_lb_stats
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|lb_stats_buff
operator|->
name|nchan
operator|=
name|n
expr_stmt|;
name|tmp_stats
operator|=
name|lb_stats_buff
operator|->
name|s
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|+=
literal|2
operator|,
name|tmp_stats
operator|+=
literal|2
control|)
block|{
name|t4_get_lb_stats
argument_list|(
name|padap
argument_list|,
name|i
argument_list|,
name|tmp_stats
argument_list|)
expr_stmt|;
name|t4_get_lb_stats
argument_list|(
name|padap
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|tmp_stats
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_rdma_stats
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_er
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|tp_rdma_stats
modifier|*
name|rdma_stats_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|tp_rdma_stats
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|rdma_stats_buff
operator|=
operator|(
expr|struct
name|tp_rdma_stats
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/* spin_lock(&padap->stats_lock);	TODO*/
name|t4_tp_get_rdma_stats
argument_list|(
name|padap
argument_list|,
name|rdma_stats_buff
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* spin_unlock(&padap->stats_lock);	TODO*/
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_clk_info
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|struct_clk_info
modifier|*
name|clk_info_buff
decl_stmt|;
name|u64
name|tp_tick_us
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|padap
operator|->
name|params
operator|.
name|vpd
operator|.
name|cclk
condition|)
block|{
name|rc
operator|=
name|CUDBG_STATUS_CCLK_NOT_DEFINED
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_clk_info
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|clk_info_buff
operator|=
operator|(
expr|struct
name|struct_clk_info
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|clk_info_buff
operator|->
name|cclk_ps
operator|=
literal|1000000000
operator|/
name|padap
operator|->
name|params
operator|.
name|vpd
operator|.
name|cclk
expr_stmt|;
comment|/* in ps 	*/
name|clk_info_buff
operator|->
name|res
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_TIMER_RESOLUTION
argument_list|)
expr_stmt|;
name|clk_info_buff
operator|->
name|tre
operator|=
name|G_TIMERRESOLUTION
argument_list|(
name|clk_info_buff
operator|->
name|res
argument_list|)
expr_stmt|;
name|clk_info_buff
operator|->
name|dack_re
operator|=
name|G_DELAYEDACKRESOLUTION
argument_list|(
name|clk_info_buff
operator|->
name|res
argument_list|)
expr_stmt|;
name|tp_tick_us
operator|=
operator|(
name|clk_info_buff
operator|->
name|cclk_ps
operator|<<
name|clk_info_buff
operator|->
name|tre
operator|)
operator|/
literal|1000000
expr_stmt|;
comment|/* in us */
name|clk_info_buff
operator|->
name|dack_timer
operator|=
operator|(
operator|(
name|clk_info_buff
operator|->
name|cclk_ps
operator|<<
name|clk_info_buff
operator|->
name|dack_re
operator|)
operator|/
literal|1000000
operator|)
operator|*
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_DACK_TIMER
argument_list|)
expr_stmt|;
name|clk_info_buff
operator|->
name|retransmit_min
operator|=
name|tp_tick_us
operator|*
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_RXT_MIN
argument_list|)
expr_stmt|;
name|clk_info_buff
operator|->
name|retransmit_max
operator|=
name|tp_tick_us
operator|*
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_RXT_MAX
argument_list|)
expr_stmt|;
name|clk_info_buff
operator|->
name|persist_timer_min
operator|=
name|tp_tick_us
operator|*
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PERS_MIN
argument_list|)
expr_stmt|;
name|clk_info_buff
operator|->
name|persist_timer_max
operator|=
name|tp_tick_us
operator|*
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_PERS_MAX
argument_list|)
expr_stmt|;
name|clk_info_buff
operator|->
name|keepalive_idle_timer
operator|=
name|tp_tick_us
operator|*
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_KEEP_IDLE
argument_list|)
expr_stmt|;
name|clk_info_buff
operator|->
name|keepalive_interval
operator|=
name|tp_tick_us
operator|*
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_KEEP_INTVL
argument_list|)
expr_stmt|;
name|clk_info_buff
operator|->
name|initial_srtt
operator|=
name|tp_tick_us
operator|*
name|G_INITSRTT
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_INIT_SRTT
argument_list|)
argument_list|)
expr_stmt|;
name|clk_info_buff
operator|->
name|finwait2_timer
operator|=
name|tp_tick_us
operator|*
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_FINWAIT2_TIMER
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_macstats
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_mac_stats_rev1
modifier|*
name|mac_stats_buff
decl_stmt|;
name|u32
name|i
decl_stmt|,
name|n
decl_stmt|,
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|rc
operator|=
name|padap
operator|->
name|params
operator|.
name|nports
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
name|n
operator|=
name|rc
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_mac_stats_rev1
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|mac_stats_buff
operator|=
operator|(
expr|struct
name|struct_mac_stats_rev1
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|mac_stats_buff
operator|->
name|ver_hdr
operator|.
name|signature
operator|=
name|CUDBG_ENTITY_SIGNATURE
expr_stmt|;
name|mac_stats_buff
operator|->
name|ver_hdr
operator|.
name|revision
operator|=
name|CUDBG_MAC_STATS_REV
expr_stmt|;
name|mac_stats_buff
operator|->
name|ver_hdr
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_mac_stats_rev1
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_ver_hdr
argument_list|)
expr_stmt|;
name|mac_stats_buff
operator|->
name|port_count
operator|=
name|n
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mac_stats_buff
operator|->
name|port_count
condition|;
name|i
operator|++
control|)
name|t4_get_port_stats
argument_list|(
name|padap
argument_list|,
name|i
argument_list|,
operator|&
name|mac_stats_buff
operator|->
name|stats
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_pif_la
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|cim_pif_la
modifier|*
name|cim_pif_la_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|cim_pif_la
argument_list|)
operator|+
literal|2
operator|*
name|CIM_PIFLA_SIZE
operator|*
literal|6
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|cim_pif_la_buff
operator|=
operator|(
expr|struct
name|cim_pif_la
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|cim_pif_la_buff
operator|->
name|size
operator|=
name|CIM_PIFLA_SIZE
expr_stmt|;
name|t4_cim_read_pif_la
argument_list|(
name|padap
argument_list|,
operator|(
name|u32
operator|*
operator|)
name|cim_pif_la_buff
operator|->
name|data
argument_list|,
operator|(
name|u32
operator|*
operator|)
name|cim_pif_la_buff
operator|->
name|data
operator|+
literal|6
operator|*
name|CIM_PIFLA_SIZE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_tp_la
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_tp_la
modifier|*
name|tp_la_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_tp_la
argument_list|)
operator|+
name|TPLA_SIZE
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|tp_la_buff
operator|=
operator|(
expr|struct
name|struct_tp_la
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|tp_la_buff
operator|->
name|mode
operator|=
name|G_DBGLAMODE
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_DBG_LA_CONFIG
argument_list|)
argument_list|)
expr_stmt|;
name|t4_tp_read_la
argument_list|(
name|padap
argument_list|,
operator|(
name|u64
operator|*
operator|)
name|tp_la_buff
operator|->
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_fcoe_stats
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_tp_fcoe_stats
modifier|*
name|tp_fcoe_stats_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_tp_fcoe_stats
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|tp_fcoe_stats_buff
operator|=
operator|(
expr|struct
name|struct_tp_fcoe_stats
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/* spin_lock(&padap->stats_lock);	TODO*/
name|t4_get_fcoe_stats
argument_list|(
name|padap
argument_list|,
literal|0
argument_list|,
operator|&
name|tp_fcoe_stats_buff
operator|->
name|stats
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|t4_get_fcoe_stats
argument_list|(
name|padap
argument_list|,
literal|1
argument_list|,
operator|&
name|tp_fcoe_stats_buff
operator|->
name|stats
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|padap
operator|->
name|chip_params
operator|->
name|nchan
operator|==
name|NCHAN
condition|)
block|{
name|t4_get_fcoe_stats
argument_list|(
name|padap
argument_list|,
literal|2
argument_list|,
operator|&
name|tp_fcoe_stats_buff
operator|->
name|stats
index|[
literal|2
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|t4_get_fcoe_stats
argument_list|(
name|padap
argument_list|,
literal|3
argument_list|,
operator|&
name|tp_fcoe_stats_buff
operator|->
name|stats
index|[
literal|3
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* spin_unlock(&padap->stats_lock);	TODO*/
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_tp_err_stats
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_tp_err_stats
modifier|*
name|tp_err_stats_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_tp_err_stats
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|tp_err_stats_buff
operator|=
operator|(
expr|struct
name|struct_tp_err_stats
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/* spin_lock(&padap->stats_lock);	TODO*/
name|t4_tp_get_err_stats
argument_list|(
name|padap
argument_list|,
operator|&
name|tp_err_stats_buff
operator|->
name|stats
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* spin_unlock(&padap->stats_lock);	TODO*/
name|tp_err_stats_buff
operator|->
name|nchan
operator|=
name|padap
operator|->
name|chip_params
operator|->
name|nchan
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_tcp_stats
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_tcp_stats
modifier|*
name|tcp_stats_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_tcp_stats
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|tcp_stats_buff
operator|=
operator|(
expr|struct
name|struct_tcp_stats
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/* spin_lock(&padap->stats_lock);	TODO*/
name|t4_tp_get_tcp_stats
argument_list|(
name|padap
argument_list|,
operator|&
name|tcp_stats_buff
operator|->
name|v4
argument_list|,
operator|&
name|tcp_stats_buff
operator|->
name|v6
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* spin_unlock(&padap->stats_lock);	TODO*/
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_hw_sched
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_hw_sched
modifier|*
name|hw_sched_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|padap
operator|->
name|params
operator|.
name|vpd
operator|.
name|cclk
condition|)
block|{
name|rc
operator|=
name|CUDBG_STATUS_CCLK_NOT_DEFINED
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_hw_sched
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|hw_sched_buff
operator|=
operator|(
expr|struct
name|struct_hw_sched
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|hw_sched_buff
operator|->
name|map
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_TX_MOD_QUEUE_REQ_MAP
argument_list|)
expr_stmt|;
name|hw_sched_buff
operator|->
name|mode
operator|=
name|G_TIMERMODE
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_MOD_CONFIG
argument_list|)
argument_list|)
expr_stmt|;
name|t4_read_pace_tbl
argument_list|(
name|padap
argument_list|,
name|hw_sched_buff
operator|->
name|pace_tab
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NTX_SCHED
condition|;
operator|++
name|i
control|)
block|{
name|t4_get_tx_sched
argument_list|(
name|padap
argument_list|,
name|i
argument_list|,
operator|&
name|hw_sched_buff
operator|->
name|kbps
index|[
name|i
index|]
argument_list|,
operator|&
name|hw_sched_buff
operator|->
name|ipg
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_pm_stats
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|struct_pm_stats
modifier|*
name|pm_stats_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_pm_stats
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|pm_stats_buff
operator|=
operator|(
expr|struct
name|struct_pm_stats
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|t4_pmtx_get_stats
argument_list|(
name|padap
argument_list|,
name|pm_stats_buff
operator|->
name|tx_cnt
argument_list|,
name|pm_stats_buff
operator|->
name|tx_cyc
argument_list|)
expr_stmt|;
name|t4_pmrx_get_stats
argument_list|(
name|padap
argument_list|,
name|pm_stats_buff
operator|->
name|rx_cnt
argument_list|,
name|pm_stats_buff
operator|->
name|rx_cyc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_path_mtu
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
name|NMTUS
operator|*
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|t4_read_mtu_tbl
argument_list|(
name|padap
argument_list|,
operator|(
name|u16
operator|*
operator|)
name|scratch_buff
operator|.
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_rss_key
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|size
operator|=
literal|10
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|t4_read_rss_key
argument_list|(
name|padap
argument_list|,
operator|(
name|u32
operator|*
operator|)
name|scratch_buff
operator|.
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_rss_config
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|rss_config
modifier|*
name|rss_conf
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|rss_config
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|rss_conf
operator|=
operator|(
expr|struct
name|rss_config
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|rss_conf
operator|->
name|tp_rssconf
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_RSS_CONFIG
argument_list|)
expr_stmt|;
name|rss_conf
operator|->
name|tp_rssconf_tnl
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_RSS_CONFIG_TNL
argument_list|)
expr_stmt|;
name|rss_conf
operator|->
name|tp_rssconf_ofd
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_RSS_CONFIG_OFD
argument_list|)
expr_stmt|;
name|rss_conf
operator|->
name|tp_rssconf_syn
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_RSS_CONFIG_SYN
argument_list|)
expr_stmt|;
name|rss_conf
operator|->
name|tp_rssconf_vrt
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_RSS_CONFIG_VRT
argument_list|)
expr_stmt|;
name|rss_conf
operator|->
name|tp_rssconf_cng
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_TP_RSS_CONFIG_CNG
argument_list|)
expr_stmt|;
name|rss_conf
operator|->
name|chip
operator|=
name|padap
operator|->
name|params
operator|.
name|chipid
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_rss_vf_config
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|rss_vf_conf
modifier|*
name|vfconf
decl_stmt|;
name|int
name|vf
decl_stmt|,
name|rc
decl_stmt|,
name|vf_count
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|vf_count
operator|=
name|padap
operator|->
name|chip_params
operator|->
name|vfcount
expr_stmt|;
name|size
operator|=
name|vf_count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|vfconf
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|vfconf
operator|=
operator|(
expr|struct
name|rss_vf_conf
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
for|for
control|(
name|vf
operator|=
literal|0
init|;
name|vf
operator|<
name|vf_count
condition|;
name|vf
operator|++
control|)
block|{
name|t4_read_rss_vf_config
argument_list|(
name|padap
argument_list|,
name|vf
argument_list|,
operator|&
name|vfconf
index|[
name|vf
index|]
operator|.
name|rss_vf_vfl
argument_list|,
operator|&
name|vfconf
index|[
name|vf
index|]
operator|.
name|rss_vf_vfh
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_rss_pf_config
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|rss_pf_conf
modifier|*
name|pfconf
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|rss_pf_map
decl_stmt|,
name|rss_pf_mask
decl_stmt|,
name|size
decl_stmt|;
name|int
name|pf
decl_stmt|,
name|rc
decl_stmt|;
name|size
operator|=
literal|8
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|pfconf
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|pfconf
operator|=
operator|(
expr|struct
name|rss_pf_conf
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|rss_pf_map
operator|=
name|t4_read_rss_pf_map
argument_list|(
name|padap
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rss_pf_mask
operator|=
name|t4_read_rss_pf_mask
argument_list|(
name|padap
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|pf
operator|=
literal|0
init|;
name|pf
operator|<
literal|8
condition|;
name|pf
operator|++
control|)
block|{
name|pfconf
index|[
name|pf
index|]
operator|.
name|rss_pf_map
operator|=
name|rss_pf_map
expr_stmt|;
name|pfconf
index|[
name|pf
index|]
operator|.
name|rss_pf_mask
operator|=
name|rss_pf_mask
expr_stmt|;
comment|/* no return val */
name|t4_read_rss_pf_config
argument_list|(
name|padap
argument_list|,
name|pf
argument_list|,
operator|&
name|pfconf
index|[
name|pf
index|]
operator|.
name|rss_pf_config
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_valid
parameter_list|(
name|u32
modifier|*
name|buf
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|int
name|index
decl_stmt|;
name|int
name|bit
decl_stmt|;
name|int
name|bit_pos
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|CTXT_EGRESS
case|:
name|bit_pos
operator|=
literal|176
expr_stmt|;
break|break;
case|case
name|CTXT_INGRESS
case|:
name|bit_pos
operator|=
literal|141
expr_stmt|;
break|break;
case|case
name|CTXT_FLM
case|:
name|bit_pos
operator|=
literal|89
expr_stmt|;
break|break;
block|}
name|index
operator|=
name|bit_pos
operator|/
literal|32
expr_stmt|;
name|bit
operator|=
name|bit_pos
operator|%
literal|32
expr_stmt|;
return|return
name|buf
index|[
name|index
index|]
operator|&
operator|(
literal|1U
operator|<<
name|bit
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * Get EGRESS, INGRESS, FLM, and CNM max qid.  *  * For EGRESS and INGRESS, do the following calculation.  * max_qid = (DBQ/IMSG context region size in bytes) /  *	     (size of context in bytes).  *  * For FLM, do the following calculation.  * max_qid = (FLM cache region size in bytes) /  *	     ((number of pointers cached in EDRAM) * 8 (bytes per pointer)).  *  * There's a 1-to-1 mapping between FLM and CNM if there's no header splitting  * enabled; i.e., max CNM qid is equal to max FLM qid. However, if header  * splitting is enabled, then max CNM qid is half of max FLM qid.  */
end_comment

begin_function
specifier|static
name|int
name|get_max_ctxt_qid
parameter_list|(
name|struct
name|adapter
modifier|*
name|padap
parameter_list|,
name|struct
name|struct_meminfo
modifier|*
name|meminfo
parameter_list|,
name|u32
modifier|*
name|max_ctx_qid
parameter_list|,
name|u8
name|nelem
parameter_list|)
block|{
name|u32
name|i
decl_stmt|,
name|idx
decl_stmt|,
name|found
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|nelem
operator|!=
operator|(
name|CTXT_CNM
operator|+
literal|1
operator|)
condition|)
return|return
operator|-
name|EINVAL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|meminfo
operator|->
name|mem_c
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|meminfo
operator|->
name|mem
index|[
name|i
index|]
operator|.
name|idx
operator|>=
name|ARRAY_SIZE
argument_list|(
name|region
argument_list|)
condition|)
continue|continue;
comment|/* skip holes */
name|idx
operator|=
name|meminfo
operator|->
name|mem
index|[
name|i
index|]
operator|.
name|idx
expr_stmt|;
comment|/* Get DBQ, IMSG, and FLM context region size */
if|if
condition|(
name|idx
operator|<=
name|CTXT_FLM
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|meminfo
operator|->
name|mem
index|[
name|i
index|]
operator|.
name|limit
operator|)
condition|)
name|meminfo
operator|->
name|mem
index|[
name|i
index|]
operator|.
name|limit
operator|=
name|i
operator|<
name|meminfo
operator|->
name|mem_c
operator|-
literal|1
condition|?
name|meminfo
operator|->
name|mem
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|base
operator|-
literal|1
else|:
operator|~
literal|0
expr_stmt|;
if|if
condition|(
name|idx
operator|<
name|CTXT_FLM
condition|)
block|{
comment|/* Get EGRESS and INGRESS max qid. */
name|max_ctx_qid
index|[
name|idx
index|]
operator|=
operator|(
name|meminfo
operator|->
name|mem
index|[
name|i
index|]
operator|.
name|limit
operator|-
name|meminfo
operator|->
name|mem
index|[
name|i
index|]
operator|.
name|base
operator|+
literal|1
operator|)
operator|/
name|CUDBG_CTXT_SIZE_BYTES
expr_stmt|;
name|found
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/* Get FLM and CNM max qid. */
name|u32
name|value
decl_stmt|,
name|edram_ptr_count
decl_stmt|;
name|u8
name|bytes_per_ptr
init|=
literal|8
decl_stmt|;
name|u8
name|nohdr
decl_stmt|;
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_SGE_FLM_CFG
argument_list|)
expr_stmt|;
comment|/* Check if header splitting is enabled. */
name|nohdr
operator|=
operator|(
name|value
operator|>>
name|S_NOHDR
operator|)
operator|&
literal|1U
expr_stmt|;
comment|/* Get the number of pointers in EDRAM per 				 * qid in units of 32. 				 */
name|edram_ptr_count
operator|=
literal|32
operator|*
operator|(
literal|1U
operator|<<
name|G_EDRAMPTRCNT
argument_list|(
name|value
argument_list|)
operator|)
expr_stmt|;
comment|/* EDRAMPTRCNT value of 3 is reserved. 				 * So don't exceed 128. 				 */
if|if
condition|(
name|edram_ptr_count
operator|>
literal|128
condition|)
name|edram_ptr_count
operator|=
literal|128
expr_stmt|;
name|max_ctx_qid
index|[
name|idx
index|]
operator|=
operator|(
name|meminfo
operator|->
name|mem
index|[
name|i
index|]
operator|.
name|limit
operator|-
name|meminfo
operator|->
name|mem
index|[
name|i
index|]
operator|.
name|base
operator|+
literal|1
operator|)
operator|/
operator|(
name|edram_ptr_count
operator|*
name|bytes_per_ptr
operator|)
expr_stmt|;
name|found
operator|++
expr_stmt|;
comment|/* CNM has 1-to-1 mapping with FLM. 				 * However, if header splitting is enabled, 				 * then max CNM qid is half of max FLM qid. 				 */
name|max_ctx_qid
index|[
name|CTXT_CNM
index|]
operator|=
name|nohdr
condition|?
name|max_ctx_qid
index|[
name|idx
index|]
else|:
name|max_ctx_qid
index|[
name|idx
index|]
operator|>>
literal|1
expr_stmt|;
comment|/* One more increment for CNM */
name|found
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|found
operator|==
name|nelem
condition|)
break|break;
block|}
comment|/* Sanity check. Ensure the values are within known max. */
name|max_ctx_qid
index|[
name|CTXT_EGRESS
index|]
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|max_ctx_qid
index|[
name|CTXT_EGRESS
index|]
argument_list|,
name|M_CTXTQID
argument_list|)
expr_stmt|;
name|max_ctx_qid
index|[
name|CTXT_INGRESS
index|]
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|max_ctx_qid
index|[
name|CTXT_INGRESS
index|]
argument_list|,
name|CUDBG_MAX_INGRESS_QIDS
argument_list|)
expr_stmt|;
name|max_ctx_qid
index|[
name|CTXT_FLM
index|]
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|max_ctx_qid
index|[
name|CTXT_FLM
index|]
argument_list|,
name|CUDBG_MAX_FL_QIDS
argument_list|)
expr_stmt|;
name|max_ctx_qid
index|[
name|CTXT_CNM
index|]
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|max_ctx_qid
index|[
name|CTXT_CNM
index|]
argument_list|,
name|CUDBG_MAX_CNM_QIDS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_dump_context
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|cudbg_buffer
name|temp_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|size
init|=
literal|0
decl_stmt|,
name|next_offset
init|=
literal|0
decl_stmt|,
name|total_size
init|=
literal|0
decl_stmt|;
name|struct
name|cudbg_ch_cntxt
modifier|*
name|buff
init|=
name|NULL
decl_stmt|;
name|struct
name|struct_meminfo
name|meminfo
decl_stmt|;
name|int
name|bytes
init|=
literal|0
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|u32
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u32
name|max_ctx_qid
index|[
name|CTXT_CNM
operator|+
literal|1
index|]
decl_stmt|;
name|bool
name|limit_qid
init|=
name|false
decl_stmt|;
name|u32
name|qid_count
init|=
literal|0
decl_stmt|;
name|rc
operator|=
name|fill_meminfo
argument_list|(
name|padap
argument_list|,
operator|&
name|meminfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* Get max valid qid for each type of queue */
name|rc
operator|=
name|get_max_ctxt_qid
argument_list|(
name|padap
argument_list|,
operator|&
name|meminfo
argument_list|,
name|max_ctx_qid
argument_list|,
name|CTXT_CNM
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* There are four types of queues. Collect context upto max 	 * qid of each type of queue. 	 */
for|for
control|(
name|i
operator|=
name|CTXT_EGRESS
init|;
name|i
operator|<=
name|CTXT_CNM
condition|;
name|i
operator|++
control|)
name|size
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_ch_cntxt
argument_list|)
operator|*
name|max_ctx_qid
index|[
name|i
index|]
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|CUDBG_STATUS_NO_SCRATCH_MEM
condition|)
block|{
comment|/* Not enough scratch Memory available. 		 * Collect context of at least CUDBG_LOWMEM_MAX_CTXT_QIDS 		 * for each queue type. 		 */
name|size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|CTXT_EGRESS
init|;
name|i
operator|<=
name|CTXT_CNM
condition|;
name|i
operator|++
control|)
name|size
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_ch_cntxt
argument_list|)
operator|*
name|CUDBG_LOWMEM_MAX_CTXT_QIDS
expr_stmt|;
name|limit_qid
operator|=
name|true
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
block|}
name|buff
operator|=
operator|(
expr|struct
name|cudbg_ch_cntxt
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/* Collect context data */
for|for
control|(
name|i
operator|=
name|CTXT_EGRESS
init|;
name|i
operator|<=
name|CTXT_FLM
condition|;
name|i
operator|++
control|)
block|{
name|qid_count
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|max_ctx_qid
index|[
name|i
index|]
condition|;
name|j
operator|++
control|)
block|{
name|read_sge_ctxt
argument_list|(
name|pdbg_init
argument_list|,
name|j
argument_list|,
name|i
argument_list|,
name|buff
operator|->
name|data
argument_list|)
expr_stmt|;
name|rc
operator|=
name|check_valid
argument_list|(
name|buff
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|buff
operator|->
name|cntxt_type
operator|=
name|i
expr_stmt|;
name|buff
operator|->
name|cntxt_id
operator|=
name|j
expr_stmt|;
name|buff
operator|++
expr_stmt|;
name|total_size
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_ch_cntxt
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|CTXT_FLM
condition|)
block|{
name|read_sge_ctxt
argument_list|(
name|pdbg_init
argument_list|,
name|j
argument_list|,
name|CTXT_CNM
argument_list|,
name|buff
operator|->
name|data
argument_list|)
expr_stmt|;
name|buff
operator|->
name|cntxt_type
operator|=
name|CTXT_CNM
expr_stmt|;
name|buff
operator|->
name|cntxt_id
operator|=
name|j
expr_stmt|;
name|buff
operator|++
expr_stmt|;
name|total_size
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_ch_cntxt
argument_list|)
expr_stmt|;
block|}
name|qid_count
operator|++
expr_stmt|;
block|}
comment|/* If there's not enough space to collect more qids, 			 * then bail and move on to next queue type. 			 */
if|if
condition|(
name|limit_qid
operator|&&
name|qid_count
operator|>=
name|CUDBG_LOWMEM_MAX_CTXT_QIDS
condition|)
break|break;
block|}
block|}
name|scratch_buff
operator|.
name|size
operator|=
name|total_size
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
comment|/* Splitting buffer and writing in terms of CUDBG_CHUNK_SIZE */
while|while
condition|(
name|total_size
operator|>
literal|0
condition|)
block|{
name|bytes
operator|=
name|min_t
argument_list|(
argument|unsigned long
argument_list|,
argument|(unsigned long)total_size
argument_list|,
argument|(unsigned long)CUDBG_CHUNK_SIZE
argument_list|)
expr_stmt|;
name|temp_buff
operator|.
name|size
operator|=
name|bytes
expr_stmt|;
name|temp_buff
operator|.
name|data
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|+
name|next_offset
operator|)
expr_stmt|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|temp_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|total_size
operator|-=
name|bytes
expr_stmt|;
name|next_offset
operator|+=
name|bytes
expr_stmt|;
block|}
name|err1
label|:
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_fw_devlog
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|notyet
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|devlog_params
modifier|*
name|dparams
init|=
operator|&
name|padap
operator|->
name|params
operator|.
name|devlog
decl_stmt|;
name|struct
name|cudbg_param
modifier|*
name|params
init|=
name|NULL
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|u32
name|offset
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|rc
operator|=
name|t4_init_devlog_params
argument_list|(
name|padap
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s(), t4_init_devlog_params failed!, rc: "
expr|\
literal|"%d\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pdbg_init
operator|->
name|dbg_params_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|dbg_params
index|[
name|i
index|]
operator|.
name|param_type
operator|==
name|CUDBG_DEVLOG_PARAM
condition|)
block|{
name|params
operator|=
operator|&
name|pdbg_init
operator|->
name|dbg_params
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|params
condition|)
block|{
name|dparams
operator|->
name|memtype
operator|=
name|params
operator|->
name|u
operator|.
name|devlog_param
operator|.
name|memtype
expr_stmt|;
name|dparams
operator|->
name|start
operator|=
name|params
operator|->
name|u
operator|.
name|devlog_param
operator|.
name|start
expr_stmt|;
name|dparams
operator|->
name|size
operator|=
name|params
operator|->
name|u
operator|.
name|devlog_param
operator|.
name|size
expr_stmt|;
block|}
else|else
block|{
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|dparams
operator|->
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* Collect FW devlog */
if|if
condition|(
name|dparams
operator|->
name|start
operator|!=
literal|0
condition|)
block|{
name|offset
operator|=
name|scratch_buff
operator|.
name|offset
expr_stmt|;
name|rc
operator|=
name|t4_memory_rw
argument_list|(
name|padap
argument_list|,
name|padap
operator|->
name|params
operator|.
name|drv_memwin
argument_list|,
name|dparams
operator|->
name|memtype
argument_list|,
name|dparams
operator|->
name|start
argument_list|,
name|dparams
operator|->
name|size
argument_list|,
operator|(
name|__be32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|+
name|offset
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s(), t4_memory_rw failed!, rc: "
expr|\
literal|"%d\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
endif|#
directive|endif
return|return
operator|(
name|EDOOFUS
operator|)
return|;
block|}
end_function

begin_comment
comment|/* CIM OBQ */
end_comment

begin_function
specifier|static
name|int
name|collect_cim_obq_ulp0
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|0
decl_stmt|;
name|rc
operator|=
name|read_cim_obq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_obq_ulp1
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|1
decl_stmt|;
name|rc
operator|=
name|read_cim_obq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_obq_ulp2
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|2
decl_stmt|;
name|rc
operator|=
name|read_cim_obq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_obq_ulp3
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|3
decl_stmt|;
name|rc
operator|=
name|read_cim_obq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_obq_sge
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|4
decl_stmt|;
name|rc
operator|=
name|read_cim_obq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_obq_ncsi
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|5
decl_stmt|;
name|rc
operator|=
name|read_cim_obq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_obq_sge_rx_q0
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|6
decl_stmt|;
name|rc
operator|=
name|read_cim_obq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_obq_sge_rx_q1
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|7
decl_stmt|;
name|rc
operator|=
name|read_cim_obq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|read_cim_obq
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|qsize
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|int
name|no_of_read_words
decl_stmt|;
comment|/* collect CIM OBQ */
name|qsize
operator|=
literal|6
operator|*
name|CIM_OBQ_SIZE
operator|*
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|qsize
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* t4_read_cim_obq will return no. of read words or error */
name|no_of_read_words
operator|=
name|t4_read_cim_obq
argument_list|(
name|padap
argument_list|,
name|qid
argument_list|,
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|u32
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|+
name|scratch_buff
operator|.
name|offset
operator|)
argument_list|,
name|qsize
argument_list|)
expr_stmt|;
comment|/* no_of_read_words is less than or equal to 0 means error */
if|if
condition|(
name|no_of_read_words
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|no_of_read_words
operator|==
literal|0
condition|)
name|rc
operator|=
name|CUDBG_SYSTEM_ERROR
expr_stmt|;
else|else
name|rc
operator|=
name|no_of_read_words
expr_stmt|;
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s: t4_read_cim_obq failed (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|scratch_buff
operator|.
name|size
operator|=
name|no_of_read_words
operator|*
literal|4
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/* CIM IBQ */
end_comment

begin_function
specifier|static
name|int
name|collect_cim_ibq_tp0
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|0
decl_stmt|;
name|rc
operator|=
name|read_cim_ibq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_ibq_tp1
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|1
decl_stmt|;
name|rc
operator|=
name|read_cim_ibq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_ibq_ulp
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|2
decl_stmt|;
name|rc
operator|=
name|read_cim_ibq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_ibq_sge0
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|3
decl_stmt|;
name|rc
operator|=
name|read_cim_ibq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_ibq_sge1
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|qid
init|=
literal|4
decl_stmt|;
name|rc
operator|=
name|read_cim_ibq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_ibq_ncsi
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|int
name|rc
decl_stmt|,
name|qid
init|=
literal|5
decl_stmt|;
name|rc
operator|=
name|read_cim_ibq
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|cudbg_err
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|read_cim_ibq
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|u32
name|qsize
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|int
name|no_of_read_words
decl_stmt|;
comment|/* collect CIM IBQ */
name|qsize
operator|=
name|CIM_IBQ_SIZE
operator|*
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|qsize
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* t4_read_cim_ibq will return no. of read words or error */
name|no_of_read_words
operator|=
name|t4_read_cim_ibq
argument_list|(
name|padap
argument_list|,
name|qid
argument_list|,
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|u32
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|+
name|scratch_buff
operator|.
name|offset
operator|)
argument_list|,
name|qsize
argument_list|)
expr_stmt|;
comment|/* no_of_read_words is less than or equal to 0 means error */
if|if
condition|(
name|no_of_read_words
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|no_of_read_words
operator|==
literal|0
condition|)
name|rc
operator|=
name|CUDBG_SYSTEM_ERROR
expr_stmt|;
else|else
name|rc
operator|=
name|no_of_read_words
expr_stmt|;
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s: t4_read_cim_ibq failed (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_ma_la
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|rc
init|=
literal|0
decl_stmt|;
comment|/* collect CIM MA LA */
name|scratch_buff
operator|.
name|size
operator|=
literal|2
operator|*
name|CIM_MALA_SIZE
operator|*
literal|5
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* no return */
name|t4_cim_read_ma_la
argument_list|(
name|padap
argument_list|,
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|+
name|scratch_buff
operator|.
name|offset
operator|)
argument_list|,
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|+
name|scratch_buff
operator|.
name|offset
operator|+
literal|5
operator|*
name|CIM_MALA_SIZE
operator|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_la
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|u32
name|cfg
init|=
literal|0
decl_stmt|;
name|int
name|size
decl_stmt|;
comment|/* collect CIM LA */
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|size
operator|=
name|padap
operator|->
name|params
operator|.
name|cim_la_size
operator|/
literal|10
operator|+
literal|1
expr_stmt|;
name|size
operator|*=
literal|11
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|size
operator|=
name|padap
operator|->
name|params
operator|.
name|cim_la_size
operator|/
literal|8
expr_stmt|;
name|size
operator|*=
literal|8
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
block|}
name|size
operator|+=
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|rc
operator|=
name|t4_cim_read
argument_list|(
name|padap
argument_list|,
name|A_UP_UP_DBG_LA_CFG
argument_list|,
literal|1
argument_list|,
operator|&
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s: t4_cim_read failed (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|+
name|scratch_buff
operator|.
name|offset
argument_list|,
operator|&
name|cfg
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|t4_cim_read_la
argument_list|(
name|padap
argument_list|,
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|+
name|scratch_buff
operator|.
name|offset
operator|+
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
operator|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s: t4_cim_read_la failed (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cim_qcfg
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|offset
decl_stmt|;
name|int
name|cim_num_obq
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|struct
name|struct_cim_qcfg
modifier|*
name|cim_qcfg_data
init|=
name|NULL
decl_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|struct_cim_qcfg
argument_list|)
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|offset
operator|=
name|scratch_buff
operator|.
name|offset
expr_stmt|;
name|cim_num_obq
operator|=
name|is_t4
argument_list|(
name|padap
argument_list|)
condition|?
name|CIM_NUM_OBQ
else|:
name|CIM_NUM_OBQ_T5
expr_stmt|;
name|cim_qcfg_data
operator|=
operator|(
expr|struct
name|struct_cim_qcfg
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|+
name|offset
operator|)
operator|)
expr_stmt|;
name|rc
operator|=
name|t4_cim_read
argument_list|(
name|padap
argument_list|,
name|A_UP_IBQ_0_RDADDR
argument_list|,
name|ARRAY_SIZE
argument_list|(
name|cim_qcfg_data
operator|->
name|stat
argument_list|)
argument_list|,
name|cim_qcfg_data
operator|->
name|stat
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s: t4_cim_read IBQ_0_RDADDR failed (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|rc
operator|=
name|t4_cim_read
argument_list|(
name|padap
argument_list|,
name|A_UP_OBQ_0_REALADDR
argument_list|,
name|ARRAY_SIZE
argument_list|(
name|cim_qcfg_data
operator|->
name|obq_wr
argument_list|)
argument_list|,
name|cim_qcfg_data
operator|->
name|obq_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s: t4_cim_read OBQ_0_REALADDR failed (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
comment|/* no return val */
name|t4_read_cimq_cfg
argument_list|(
name|padap
argument_list|,
name|cim_qcfg_data
operator|->
name|base
argument_list|,
name|cim_qcfg_data
operator|->
name|size
argument_list|,
name|cim_qcfg_data
operator|->
name|thres
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * Fetch the TX/RX payload regions start and end.  *  * @padap (IN): adapter handle.  * @mem_type (IN): EDC0, EDC1, MC/MC0/MC1.  * @mem_tot_len (IN): total length of @mem_type memory region to read.  * @payload_type (IN): TX or RX Payload.  * @reg_info (OUT): store the payload region info.  *  * Fetch the TX/RX payload region information from meminfo.  * However, reading from the @mem_type region starts at 0 and not  * from whatever base info is stored in meminfo.  Hence, if the  * payload region exists, then calculate the payload region  * start and end wrt 0 and @mem_tot_len, respectively, and set  * @reg_info->exist to true. Otherwise, set @reg_info->exist to false.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|notyet
end_ifdef

begin_function
specifier|static
name|int
name|get_payload_range
parameter_list|(
name|struct
name|adapter
modifier|*
name|padap
parameter_list|,
name|u8
name|mem_type
parameter_list|,
name|unsigned
name|long
name|mem_tot_len
parameter_list|,
name|u8
name|payload_type
parameter_list|,
name|struct
name|struct_region_info
modifier|*
name|reg_info
parameter_list|)
block|{
name|struct
name|struct_meminfo
name|meminfo
decl_stmt|;
name|struct
name|struct_mem_desc
name|mem_region
decl_stmt|;
name|struct
name|struct_mem_desc
name|payload
decl_stmt|;
name|u32
name|i
decl_stmt|,
name|idx
decl_stmt|,
name|found
init|=
literal|0
decl_stmt|;
name|u8
name|mc_type
decl_stmt|;
name|int
name|rc
decl_stmt|;
comment|/* Get meminfo of all regions */
name|rc
operator|=
name|fill_meminfo
argument_list|(
name|padap
argument_list|,
operator|&
name|meminfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
comment|/* Extract the specified TX or RX Payload region range */
name|memset
argument_list|(
operator|&
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|struct_mem_desc
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|meminfo
operator|.
name|mem_c
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|meminfo
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|idx
operator|>=
name|ARRAY_SIZE
argument_list|(
name|region
argument_list|)
condition|)
continue|continue;
comment|/* skip holes */
name|idx
operator|=
name|meminfo
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|idx
expr_stmt|;
comment|/* Get TX or RX Payload region start and end */
if|if
condition|(
name|idx
operator|==
name|payload_type
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|meminfo
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|limit
operator|)
condition|)
name|meminfo
operator|.
name|mem
index|[
name|i
index|]
operator|.
name|limit
operator|=
name|i
operator|<
name|meminfo
operator|.
name|mem_c
operator|-
literal|1
condition|?
name|meminfo
operator|.
name|mem
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|base
operator|-
literal|1
else|:
operator|~
literal|0
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|payload
argument_list|,
operator|&
name|meminfo
operator|.
name|mem
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
comment|/* If TX or RX Payload region is not found return error. */
if|if
condition|(
operator|!
name|found
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|mem_type
operator|<
name|MEM_MC
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|mem_region
argument_list|,
operator|&
name|meminfo
operator|.
name|avail
index|[
name|mem_type
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|mem_region
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Check if both MC0 and MC1 exist by checking if a 		 * base address for the specified @mem_type exists. 		 * If a base address exists, then there is MC1 and 		 * hence use the base address stored at index 3. 		 * Otherwise, use the base address stored at index 2. 		 */
name|mc_type
operator|=
name|meminfo
operator|.
name|avail
index|[
name|mem_type
index|]
operator|.
name|base
condition|?
name|mem_type
else|:
name|mem_type
operator|-
literal|1
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|mem_region
argument_list|,
operator|&
name|meminfo
operator|.
name|avail
index|[
name|mc_type
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|mem_region
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Check if payload region exists in current memory */
if|if
condition|(
name|payload
operator|.
name|base
operator|<
name|mem_region
operator|.
name|base
operator|&&
name|payload
operator|.
name|limit
operator|<
name|mem_region
operator|.
name|base
condition|)
block|{
name|reg_info
operator|->
name|exist
operator|=
name|false
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Get Payload region start and end with respect to 0 and 	 * mem_tot_len, respectively.  This is because reading from the 	 * memory region starts at 0 and not at base info stored in meminfo. 	 */
if|if
condition|(
name|payload
operator|.
name|base
operator|<
name|mem_region
operator|.
name|limit
condition|)
block|{
name|reg_info
operator|->
name|exist
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|payload
operator|.
name|base
operator|>=
name|mem_region
operator|.
name|base
condition|)
name|reg_info
operator|->
name|start
operator|=
name|payload
operator|.
name|base
operator|-
name|mem_region
operator|.
name|base
expr_stmt|;
else|else
name|reg_info
operator|->
name|start
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|payload
operator|.
name|limit
operator|<
name|mem_region
operator|.
name|limit
condition|)
name|reg_info
operator|->
name|end
operator|=
name|payload
operator|.
name|limit
operator|-
name|mem_region
operator|.
name|base
expr_stmt|;
else|else
name|reg_info
operator|->
name|end
operator|=
name|mem_tot_len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|read_fw_mem
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|u8
name|mem_type
parameter_list|,
name|unsigned
name|long
name|tot_len
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|notyet
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|unsigned
name|long
name|bytes_read
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|bytes_left
decl_stmt|;
name|unsigned
name|long
name|bytes
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|struct
name|struct_region_info
name|payload
index|[
literal|2
index|]
decl_stmt|;
comment|/* TX and RX Payload Region */
name|u16
name|get_payload_flag
decl_stmt|;
name|u8
name|i
decl_stmt|;
name|get_payload_flag
operator|=
name|pdbg_init
operator|->
name|dbg_params
index|[
name|CUDBG_GET_PAYLOAD_PARAM
index|]
operator|.
name|param_type
expr_stmt|;
comment|/* If explicitly asked to get TX/RX Payload data, 	 * then don't zero out the payload data. Otherwise, 	 * zero out the payload data. 	 */
if|if
condition|(
operator|!
name|get_payload_flag
condition|)
block|{
name|u8
name|region_index
index|[
literal|2
index|]
decl_stmt|;
name|u8
name|j
init|=
literal|0
decl_stmt|;
comment|/* Find the index of TX and RX Payload regions in meminfo */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|region
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|region
index|[
name|i
index|]
argument_list|,
literal|"Tx payload:"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|region
index|[
name|i
index|]
argument_list|,
literal|"Rx payload:"
argument_list|)
condition|)
block|{
name|region_index
index|[
name|j
index|]
operator|=
name|i
expr_stmt|;
name|j
operator|++
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|2
condition|)
break|break;
block|}
block|}
comment|/* Get TX/RX Payload region range if they exist */
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
name|ARRAY_SIZE
argument_list|(
name|payload
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
name|payload
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|payload
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|get_payload_range
argument_list|(
name|padap
argument_list|,
name|mem_type
argument_list|,
name|tot_len
argument_list|,
name|region_index
index|[
name|i
index|]
argument_list|,
operator|&
name|payload
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|payload
index|[
name|i
index|]
operator|.
name|exist
condition|)
block|{
comment|/* Align start and end to avoid wrap around */
name|payload
index|[
name|i
index|]
operator|.
name|start
operator|=
name|roundup
argument_list|(
name|payload
index|[
name|i
index|]
operator|.
name|start
argument_list|,
name|CUDBG_CHUNK_SIZE
argument_list|)
expr_stmt|;
name|payload
index|[
name|i
index|]
operator|.
name|end
operator|=
name|rounddown
argument_list|(
name|payload
index|[
name|i
index|]
operator|.
name|end
argument_list|,
name|CUDBG_CHUNK_SIZE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|bytes_left
operator|=
name|tot_len
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|tot_len
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
while|while
condition|(
name|bytes_left
operator|>
literal|0
condition|)
block|{
name|bytes
operator|=
name|min_t
argument_list|(
argument|unsigned long
argument_list|,
argument|bytes_left
argument_list|,
argument|(unsigned long)CUDBG_CHUNK_SIZE
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|bytes
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|rc
operator|=
name|CUDBG_STATUS_NO_SCRATCH_MEM
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|get_payload_flag
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|payload
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|payload
index|[
name|i
index|]
operator|.
name|exist
operator|&&
name|bytes_read
operator|>=
name|payload
index|[
name|i
index|]
operator|.
name|start
operator|&&
operator|(
name|bytes_read
operator|+
name|bytes
operator|)
operator|<=
name|payload
index|[
name|i
index|]
operator|.
name|end
condition|)
block|{
name|memset
argument_list|(
name|scratch_buff
operator|.
name|data
argument_list|,
literal|0
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
comment|/* TX and RX Payload regions 					 * can't overlap. 					 */
goto|goto
name|skip_read
goto|;
block|}
block|}
block|}
comment|/* Read from file */
comment|/*fread(scratch_buff.data, 1, Bytes, in);*/
name|rc
operator|=
name|t4_memory_rw
argument_list|(
name|padap
argument_list|,
name|MEMWIN_NIC
argument_list|,
name|mem_type
argument_list|,
name|bytes_read
argument_list|,
name|bytes
argument_list|,
operator|(
name|__be32
operator|*
operator|)
operator|(
name|scratch_buff
operator|.
name|data
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s: t4_memory_rw failed (%d)"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|skip_read
label|:
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|bytes_left
operator|-=
name|bytes
expr_stmt|;
name|bytes_read
operator|+=
name|bytes
expr_stmt|;
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
block|}
name|err1
label|:
if|if
condition|(
name|rc
condition|)
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
endif|#
directive|endif
return|return
operator|(
name|EDOOFUS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|collect_mem_info
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|card_mem
modifier|*
name|mem_info
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|value
decl_stmt|;
name|int
name|t4
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|is_t4
argument_list|(
name|padap
argument_list|)
condition|)
name|t4
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|t4
condition|)
block|{
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_EXT_MEMORY_BAR
argument_list|)
expr_stmt|;
name|value
operator|=
name|G_EXT_MEM_SIZE
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|mem_info
operator|->
name|size_mc0
operator|=
operator|(
name|u16
operator|)
name|value
expr_stmt|;
comment|/* size in MB */
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_TARGET_MEM_ENABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|&
name|F_EXT_MEM_ENABLE
condition|)
name|mem_info
operator|->
name|mem_flag
operator||=
operator|(
literal|1
operator|<<
name|MC0_FLAG
operator|)
expr_stmt|;
comment|/* set mc0 flag 								  bit */
block|}
else|else
block|{
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_EXT_MEMORY0_BAR
argument_list|)
expr_stmt|;
name|value
operator|=
name|G_EXT_MEM0_SIZE
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|mem_info
operator|->
name|size_mc0
operator|=
operator|(
name|u16
operator|)
name|value
expr_stmt|;
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_EXT_MEMORY1_BAR
argument_list|)
expr_stmt|;
name|value
operator|=
name|G_EXT_MEM1_SIZE
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|mem_info
operator|->
name|size_mc1
operator|=
operator|(
name|u16
operator|)
name|value
expr_stmt|;
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_TARGET_MEM_ENABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|&
name|F_EXT_MEM0_ENABLE
condition|)
name|mem_info
operator|->
name|mem_flag
operator||=
operator|(
literal|1
operator|<<
name|MC0_FLAG
operator|)
expr_stmt|;
if|if
condition|(
name|value
operator|&
name|F_EXT_MEM1_ENABLE
condition|)
name|mem_info
operator|->
name|mem_flag
operator||=
operator|(
literal|1
operator|<<
name|MC1_FLAG
operator|)
expr_stmt|;
block|}
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_EDRAM0_BAR
argument_list|)
expr_stmt|;
name|value
operator|=
name|G_EDRAM0_SIZE
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|mem_info
operator|->
name|size_edc0
operator|=
operator|(
name|u16
operator|)
name|value
expr_stmt|;
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_EDRAM1_BAR
argument_list|)
expr_stmt|;
name|value
operator|=
name|G_EDRAM1_SIZE
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|mem_info
operator|->
name|size_edc1
operator|=
operator|(
name|u16
operator|)
name|value
expr_stmt|;
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MA_TARGET_MEM_ENABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|&
name|F_EDRAM0_ENABLE
condition|)
name|mem_info
operator|->
name|mem_flag
operator||=
operator|(
literal|1
operator|<<
name|EDC0_FLAG
operator|)
expr_stmt|;
if|if
condition|(
name|value
operator|&
name|F_EDRAM1_ENABLE
condition|)
name|mem_info
operator|->
name|mem_flag
operator||=
operator|(
literal|1
operator|<<
name|EDC1_FLAG
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cudbg_t4_fwcache
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|is_fw_attached
argument_list|(
name|pdbg_init
argument_list|)
condition|)
block|{
comment|/* Flush uP dcache before reading edcX/mcX  */
name|rc
operator|=
name|t4_fwcache
argument_list|(
name|padap
argument_list|,
name|FW_PARAM_DEV_FWCACHE_FLUSH
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s: t4_fwcache failed (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|cudbg_err
operator|->
name|sys_warn
operator|=
name|rc
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|collect_edc0_meminfo
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|card_mem
name|mem_info
init|=
block|{
literal|0
block|}
decl_stmt|;
name|unsigned
name|long
name|edc0_size
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|cudbg_t4_fwcache
argument_list|(
name|pdbg_init
argument_list|,
name|cudbg_err
argument_list|)
expr_stmt|;
name|collect_mem_info
argument_list|(
name|pdbg_init
argument_list|,
operator|&
name|mem_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem_info
operator|.
name|mem_flag
operator|&
operator|(
literal|1
operator|<<
name|EDC0_FLAG
operator|)
condition|)
block|{
name|edc0_size
operator|=
operator|(
operator|(
operator|(
name|unsigned
name|long
operator|)
name|mem_info
operator|.
name|size_edc0
operator|)
operator|*
literal|1024
operator|*
literal|1024
operator|)
expr_stmt|;
name|rc
operator|=
name|read_fw_mem
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|MEM_EDC0
argument_list|,
name|edc0_size
argument_list|,
name|cudbg_err
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|rc
operator|=
name|CUDBG_STATUS_ENTITY_NOT_FOUND
expr_stmt|;
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s(), collect_mem_info failed!, %s\n"
argument_list|,
name|__func__
argument_list|,
name|err_msg
index|[
operator|-
name|rc
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_edc1_meminfo
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|card_mem
name|mem_info
init|=
block|{
literal|0
block|}
decl_stmt|;
name|unsigned
name|long
name|edc1_size
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|cudbg_t4_fwcache
argument_list|(
name|pdbg_init
argument_list|,
name|cudbg_err
argument_list|)
expr_stmt|;
name|collect_mem_info
argument_list|(
name|pdbg_init
argument_list|,
operator|&
name|mem_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem_info
operator|.
name|mem_flag
operator|&
operator|(
literal|1
operator|<<
name|EDC1_FLAG
operator|)
condition|)
block|{
name|edc1_size
operator|=
operator|(
operator|(
operator|(
name|unsigned
name|long
operator|)
name|mem_info
operator|.
name|size_edc1
operator|)
operator|*
literal|1024
operator|*
literal|1024
operator|)
expr_stmt|;
name|rc
operator|=
name|read_fw_mem
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|MEM_EDC1
argument_list|,
name|edc1_size
argument_list|,
name|cudbg_err
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|rc
operator|=
name|CUDBG_STATUS_ENTITY_NOT_FOUND
expr_stmt|;
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s(), collect_mem_info failed!, %s\n"
argument_list|,
name|__func__
argument_list|,
name|err_msg
index|[
operator|-
name|rc
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_mc0_meminfo
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|card_mem
name|mem_info
init|=
block|{
literal|0
block|}
decl_stmt|;
name|unsigned
name|long
name|mc0_size
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|cudbg_t4_fwcache
argument_list|(
name|pdbg_init
argument_list|,
name|cudbg_err
argument_list|)
expr_stmt|;
name|collect_mem_info
argument_list|(
name|pdbg_init
argument_list|,
operator|&
name|mem_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem_info
operator|.
name|mem_flag
operator|&
operator|(
literal|1
operator|<<
name|MC0_FLAG
operator|)
condition|)
block|{
name|mc0_size
operator|=
operator|(
operator|(
operator|(
name|unsigned
name|long
operator|)
name|mem_info
operator|.
name|size_mc0
operator|)
operator|*
literal|1024
operator|*
literal|1024
operator|)
expr_stmt|;
name|rc
operator|=
name|read_fw_mem
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|MEM_MC0
argument_list|,
name|mc0_size
argument_list|,
name|cudbg_err
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|rc
operator|=
name|CUDBG_STATUS_ENTITY_NOT_FOUND
expr_stmt|;
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s(), collect_mem_info failed!, %s\n"
argument_list|,
name|__func__
argument_list|,
name|err_msg
index|[
operator|-
name|rc
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_mc1_meminfo
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|card_mem
name|mem_info
init|=
block|{
literal|0
block|}
decl_stmt|;
name|unsigned
name|long
name|mc1_size
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|cudbg_t4_fwcache
argument_list|(
name|pdbg_init
argument_list|,
name|cudbg_err
argument_list|)
expr_stmt|;
name|collect_mem_info
argument_list|(
name|pdbg_init
argument_list|,
operator|&
name|mem_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem_info
operator|.
name|mem_flag
operator|&
operator|(
literal|1
operator|<<
name|MC1_FLAG
operator|)
condition|)
block|{
name|mc1_size
operator|=
operator|(
operator|(
operator|(
name|unsigned
name|long
operator|)
name|mem_info
operator|.
name|size_mc1
operator|)
operator|*
literal|1024
operator|*
literal|1024
operator|)
expr_stmt|;
name|rc
operator|=
name|read_fw_mem
argument_list|(
name|pdbg_init
argument_list|,
name|dbg_buff
argument_list|,
name|MEM_MC1
argument_list|,
name|mc1_size
argument_list|,
name|cudbg_err
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|rc
operator|=
name|CUDBG_STATUS_ENTITY_NOT_FOUND
expr_stmt|;
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s(), collect_mem_info failed!, %s\n"
argument_list|,
name|__func__
argument_list|,
name|err_msg
index|[
operator|-
name|rc
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_reg_dump
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|cudbg_buffer
name|tmp_scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|unsigned
name|long
name|bytes_read
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|bytes_left
decl_stmt|;
name|u32
name|buf_size
init|=
literal|0
decl_stmt|,
name|bytes
init|=
literal|0
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|is_t4
argument_list|(
name|padap
argument_list|)
condition|)
name|buf_size
operator|=
name|T4_REGMAP_SIZE
expr_stmt|;
comment|/*+ sizeof(unsigned int);*/
elseif|else
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
operator|||
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
name|buf_size
operator|=
name|T5_REGMAP_SIZE
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|buf_size
expr_stmt|;
name|tmp_scratch_buff
operator|=
name|scratch_buff
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* no return */
name|t4_get_regs
argument_list|(
name|padap
argument_list|,
operator|(
name|void
operator|*
operator|)
name|scratch_buff
operator|.
name|data
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|)
expr_stmt|;
name|bytes_left
operator|=
name|scratch_buff
operator|.
name|size
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
while|while
condition|(
name|bytes_left
operator|>
literal|0
condition|)
block|{
name|tmp_scratch_buff
operator|.
name|data
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|)
operator|+
name|bytes_read
expr_stmt|;
name|bytes
operator|=
name|min_t
argument_list|(
argument|unsigned long
argument_list|,
argument|bytes_left
argument_list|,
argument|(unsigned long)CUDBG_CHUNK_SIZE
argument_list|)
expr_stmt|;
name|tmp_scratch_buff
operator|.
name|size
operator|=
name|bytes
expr_stmt|;
name|compress_buff
argument_list|(
operator|&
name|tmp_scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|bytes_left
operator|-=
name|bytes
expr_stmt|;
name|bytes_read
operator|+=
name|bytes
expr_stmt|;
block|}
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_cctrl
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
operator|*
name|NMTUS
operator|*
name|NCCTRL_WIN
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|t4_read_cong_tbl
argument_list|(
name|padap
argument_list|,
operator|(
name|void
operator|*
operator|)
name|scratch_buff
operator|.
name|data
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_busy_bit
parameter_list|(
name|struct
name|adapter
modifier|*
name|padap
parameter_list|)
block|{
name|u32
name|val
decl_stmt|;
name|u32
name|busy
init|=
literal|1
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|retry
init|=
literal|10
decl_stmt|;
name|int
name|status
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|busy
operator|&
operator|(
literal|1
operator|<
name|retry
operator|)
condition|)
block|{
name|val
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_CIM_HOST_ACC_CTRL
argument_list|)
expr_stmt|;
name|busy
operator|=
operator|(
literal|0
operator|!=
operator|(
name|val
operator|&
name|CUDBG_CIM_BUSY_BIT
operator|)
operator|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|busy
condition|)
name|status
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cim_ha_rreg
parameter_list|(
name|struct
name|adapter
modifier|*
name|padap
parameter_list|,
name|u32
name|addr
parameter_list|,
name|u32
modifier|*
name|val
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
comment|/* write register address into the A_CIM_HOST_ACC_CTRL */
name|t4_write_reg
argument_list|(
name|padap
argument_list|,
name|A_CIM_HOST_ACC_CTRL
argument_list|,
name|addr
argument_list|)
expr_stmt|;
comment|/* Poll HOSTBUSY */
name|rc
operator|=
name|check_busy_bit
argument_list|(
name|padap
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* Read value from A_CIM_HOST_ACC_DATA */
operator|*
name|val
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_CIM_HOST_ACC_DATA
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dump_up_cim
parameter_list|(
name|struct
name|adapter
modifier|*
name|padap
parameter_list|,
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|ireg_field
modifier|*
name|up_cim_reg
parameter_list|,
name|u32
modifier|*
name|buff
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|up_cim_reg
operator|->
name|ireg_offset_range
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|cim_ha_rreg
argument_list|(
name|padap
argument_list|,
name|up_cim_reg
operator|->
name|ireg_local_offset
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
name|buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"BUSY timeout reading"
literal|"CIM_HOST_ACC_CTRL\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|buff
operator|++
expr_stmt|;
block|}
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_up_cim_indirect
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|ireg_buf
modifier|*
name|up_cim
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|,
name|n
decl_stmt|;
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t5_up_cim_reg_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ireg_buf
argument_list|)
operator|*
name|n
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|up_cim
operator|=
operator|(
expr|struct
name|ireg_buf
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|up_cim_reg
init|=
operator|&
name|up_cim
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|up_cim
operator|->
name|outbuf
decl_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|up_cim_reg
operator|->
name|ireg_addr
operator|=
name|t5_up_cim_reg_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|up_cim_reg
operator|->
name|ireg_data
operator|=
name|t5_up_cim_reg_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|up_cim_reg
operator|->
name|ireg_local_offset
operator|=
name|t5_up_cim_reg_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|up_cim_reg
operator|->
name|ireg_offset_range
operator|=
name|t5_up_cim_reg_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|up_cim_reg
operator|->
name|ireg_addr
operator|=
name|t6_up_cim_reg_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|up_cim_reg
operator|->
name|ireg_data
operator|=
name|t6_up_cim_reg_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|up_cim_reg
operator|->
name|ireg_local_offset
operator|=
name|t6_up_cim_reg_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|up_cim_reg
operator|->
name|ireg_offset_range
operator|=
name|t6_up_cim_reg_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
block|}
name|rc
operator|=
name|dump_up_cim
argument_list|(
name|padap
argument_list|,
name|pdbg_init
argument_list|,
name|up_cim_reg
argument_list|,
name|buff
argument_list|)
expr_stmt|;
name|up_cim
operator|++
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_mbox_log
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|notyet
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|cudbg_mbox_log
modifier|*
name|mboxlog
init|=
name|NULL
decl_stmt|;
name|struct
name|mbox_cmd_log
modifier|*
name|log
init|=
name|NULL
decl_stmt|;
name|struct
name|mbox_cmd
modifier|*
name|entry
decl_stmt|;
name|u64
name|flit
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|unsigned
name|int
name|entry_idx
decl_stmt|;
name|int
name|i
decl_stmt|,
name|k
decl_stmt|,
name|rc
decl_stmt|;
name|u16
name|mbox_cmds
decl_stmt|;
if|if
condition|(
name|pdbg_init
operator|->
name|dbg_params
index|[
name|CUDBG_MBOX_LOG_PARAM
index|]
operator|.
name|u
operator|.
name|mboxlog_param
operator|.
name|log
condition|)
block|{
name|log
operator|=
name|pdbg_init
operator|->
name|dbg_params
index|[
name|CUDBG_MBOX_LOG_PARAM
index|]
operator|.
name|u
operator|.
name|mboxlog_param
operator|.
name|log
expr_stmt|;
name|mbox_cmds
operator|=
name|pdbg_init
operator|->
name|dbg_params
index|[
name|CUDBG_MBOX_LOG_PARAM
index|]
operator|.
name|u
operator|.
name|mboxlog_param
operator|.
name|mbox_cmds
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"Mbox log is not requested\n"
argument_list|)
expr_stmt|;
return|return
name|CUDBG_STATUS_ENTITY_NOT_REQUESTED
return|;
block|}
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_mbox_log
argument_list|)
operator|*
name|mbox_cmds
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|mboxlog
operator|=
operator|(
expr|struct
name|cudbg_mbox_log
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|mbox_cmds
condition|;
name|k
operator|++
control|)
block|{
name|entry_idx
operator|=
name|log
operator|->
name|cursor
operator|+
name|k
expr_stmt|;
if|if
condition|(
name|entry_idx
operator|>=
name|log
operator|->
name|size
condition|)
name|entry_idx
operator|-=
name|log
operator|->
name|size
expr_stmt|;
name|entry
operator|=
name|mbox_cmd_log_entry
argument_list|(
name|log
argument_list|,
name|entry_idx
argument_list|)
expr_stmt|;
comment|/* skip over unused entries */
if|if
condition|(
name|entry
operator|->
name|timestamp
operator|==
literal|0
condition|)
continue|continue;
name|memcpy
argument_list|(
operator|&
name|mboxlog
operator|->
name|entry
argument_list|,
name|entry
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mbox_cmd
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MBOX_LEN
operator|/
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|flit
operator|=
name|entry
operator|->
name|cmd
index|[
name|i
index|]
expr_stmt|;
name|mboxlog
operator|->
name|hi
index|[
name|i
index|]
operator|=
call|(
name|u32
call|)
argument_list|(
name|flit
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|mboxlog
operator|->
name|lo
index|[
name|i
index|]
operator|=
operator|(
name|u32
operator|)
name|flit
expr_stmt|;
block|}
name|mboxlog
operator|++
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
endif|#
directive|endif
return|return
operator|(
name|EDOOFUS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_pbt_tables
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_pbt_tables
modifier|*
name|pbt
init|=
name|NULL
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|u32
name|addr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_pbt_tables
argument_list|)
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|pbt
operator|=
operator|(
expr|struct
name|cudbg_pbt_tables
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/* PBT dynamic entries */
name|addr
operator|=
name|CUDBG_CHAC_PBT_ADDR
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CUDBG_PBT_DYNAMIC_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|cim_ha_rreg
argument_list|(
name|padap
argument_list|,
name|addr
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
operator|&
name|pbt
operator|->
name|pbt_dynamic
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"BUSY timeout reading"
literal|"CIM_HOST_ACC_CTRL\n"
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
block|}
comment|/* PBT static entries */
comment|/* static entries start when bit 6 is set */
name|addr
operator|=
name|CUDBG_CHAC_PBT_ADDR
operator|+
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CUDBG_PBT_STATIC_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|cim_ha_rreg
argument_list|(
name|padap
argument_list|,
name|addr
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
operator|&
name|pbt
operator|->
name|pbt_static
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"BUSY timeout reading"
literal|"CIM_HOST_ACC_CTRL\n"
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
block|}
comment|/* LRF entries */
name|addr
operator|=
name|CUDBG_CHAC_PBT_LRF
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CUDBG_LRF_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|cim_ha_rreg
argument_list|(
name|padap
argument_list|,
name|addr
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
operator|&
name|pbt
operator|->
name|lrf_table
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"BUSY timeout reading"
literal|"CIM_HOST_ACC_CTRL\n"
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
block|}
comment|/* PBT data entries */
name|addr
operator|=
name|CUDBG_CHAC_PBT_DATA
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CUDBG_PBT_DATA_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|cim_ha_rreg
argument_list|(
name|padap
argument_list|,
name|addr
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
operator|&
name|pbt
operator|->
name|pbt_data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"BUSY timeout reading"
literal|"CIM_HOST_ACC_CTRL\n"
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_pm_indirect
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|ireg_buf
modifier|*
name|ch_pm
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|,
name|n
decl_stmt|;
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t5_pm_rx_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ireg_buf
argument_list|)
operator|*
name|n
operator|*
literal|2
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|ch_pm
operator|=
operator|(
expr|struct
name|ireg_buf
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/*PM_RX*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|pm_pio
init|=
operator|&
name|ch_pm
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|ch_pm
operator|->
name|outbuf
decl_stmt|;
name|pm_pio
operator|->
name|ireg_addr
operator|=
name|t5_pm_rx_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|pm_pio
operator|->
name|ireg_data
operator|=
name|t5_pm_rx_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|pm_pio
operator|->
name|ireg_local_offset
operator|=
name|t5_pm_rx_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|pm_pio
operator|->
name|ireg_offset_range
operator|=
name|t5_pm_rx_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
name|t4_read_indirect
argument_list|(
name|padap
argument_list|,
name|pm_pio
operator|->
name|ireg_addr
argument_list|,
name|pm_pio
operator|->
name|ireg_data
argument_list|,
name|buff
argument_list|,
name|pm_pio
operator|->
name|ireg_offset_range
argument_list|,
name|pm_pio
operator|->
name|ireg_local_offset
argument_list|)
expr_stmt|;
name|ch_pm
operator|++
expr_stmt|;
block|}
comment|/*PM_Tx*/
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t5_pm_tx_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|pm_pio
init|=
operator|&
name|ch_pm
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|ch_pm
operator|->
name|outbuf
decl_stmt|;
name|pm_pio
operator|->
name|ireg_addr
operator|=
name|t5_pm_tx_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|pm_pio
operator|->
name|ireg_data
operator|=
name|t5_pm_tx_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|pm_pio
operator|->
name|ireg_local_offset
operator|=
name|t5_pm_tx_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|pm_pio
operator|->
name|ireg_offset_range
operator|=
name|t5_pm_tx_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
name|t4_read_indirect
argument_list|(
name|padap
argument_list|,
name|pm_pio
operator|->
name|ireg_addr
argument_list|,
name|pm_pio
operator|->
name|ireg_data
argument_list|,
name|buff
argument_list|,
name|pm_pio
operator|->
name|ireg_offset_range
argument_list|,
name|pm_pio
operator|->
name|ireg_local_offset
argument_list|)
expr_stmt|;
name|ch_pm
operator|++
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_tid
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|tid_info_region
modifier|*
name|tid
decl_stmt|;
name|struct
name|tid_info_region_rev1
modifier|*
name|tid1
decl_stmt|;
name|u32
name|para
index|[
literal|7
index|]
decl_stmt|,
name|val
index|[
literal|7
index|]
decl_stmt|;
name|u32
name|mbox
decl_stmt|,
name|pf
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|tid_info_region_rev1
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
define|#
directive|define
name|FW_PARAM_DEV_A
parameter_list|(
name|param
parameter_list|)
define|\
value|(V_FW_PARAMS_MNEM(FW_PARAMS_MNEM_DEV) | \ 	 V_FW_PARAMS_PARAM_X(FW_PARAMS_PARAM_DEV_##param))
define|#
directive|define
name|FW_PARAM_PFVF_A
parameter_list|(
name|param
parameter_list|)
define|\
value|(V_FW_PARAMS_MNEM(FW_PARAMS_MNEM_PFVF) | \ 	 V_FW_PARAMS_PARAM_X(FW_PARAMS_PARAM_PFVF_##param)|  \ 	 V_FW_PARAMS_PARAM_Y(0) | \ 	 V_FW_PARAMS_PARAM_Z(0))
define|#
directive|define
name|MAX_ATIDS_A
value|8192U
name|tid1
operator|=
operator|(
expr|struct
name|tid_info_region_rev1
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|tid
operator|=
operator|&
operator|(
name|tid1
operator|->
name|tid
operator|)
expr_stmt|;
name|tid1
operator|->
name|ver_hdr
operator|.
name|signature
operator|=
name|CUDBG_ENTITY_SIGNATURE
expr_stmt|;
name|tid1
operator|->
name|ver_hdr
operator|.
name|revision
operator|=
name|CUDBG_TID_INFO_REV
expr_stmt|;
name|tid1
operator|->
name|ver_hdr
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|tid_info_region_rev1
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_ver_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|tid
operator|->
name|hash_base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_TID_HASHBASE
argument_list|)
expr_stmt|;
name|tid1
operator|->
name|tid_start
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|tid
operator|->
name|hash_base
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_T6_LE_DB_HASH_TID_BASE
argument_list|)
expr_stmt|;
name|tid1
operator|->
name|tid_start
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_ACTIVE_TABLE_START_INDEX
argument_list|)
expr_stmt|;
block|}
name|tid
operator|->
name|le_db_conf
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_CONFIG
argument_list|)
expr_stmt|;
name|para
index|[
literal|0
index|]
operator|=
name|FW_PARAM_PFVF_A
argument_list|(
name|FILTER_START
argument_list|)
expr_stmt|;
name|para
index|[
literal|1
index|]
operator|=
name|FW_PARAM_PFVF_A
argument_list|(
name|FILTER_END
argument_list|)
expr_stmt|;
name|para
index|[
literal|2
index|]
operator|=
name|FW_PARAM_PFVF_A
argument_list|(
name|ACTIVE_FILTER_START
argument_list|)
expr_stmt|;
name|para
index|[
literal|3
index|]
operator|=
name|FW_PARAM_PFVF_A
argument_list|(
name|ACTIVE_FILTER_END
argument_list|)
expr_stmt|;
name|para
index|[
literal|4
index|]
operator|=
name|FW_PARAM_DEV_A
argument_list|(
name|NTID
argument_list|)
expr_stmt|;
name|para
index|[
literal|5
index|]
operator|=
name|FW_PARAM_PFVF_A
argument_list|(
name|SERVER_START
argument_list|)
expr_stmt|;
name|para
index|[
literal|6
index|]
operator|=
name|FW_PARAM_PFVF_A
argument_list|(
name|SERVER_END
argument_list|)
expr_stmt|;
name|mbox
operator|=
name|padap
operator|->
name|mbox
expr_stmt|;
name|pf
operator|=
name|padap
operator|->
name|pf
expr_stmt|;
name|rc
operator|=
name|t4_query_params
argument_list|(
name|padap
argument_list|,
name|mbox
argument_list|,
name|pf
argument_list|,
literal|0
argument_list|,
literal|7
argument_list|,
name|para
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|rc
operator|==
operator|-
name|FW_EPERM
condition|)
block|{
comment|/* It looks like we don't have permission to use 			 * padap->mbox. 			 * 			 * Try mbox 4.  If it works, we'll continue to 			 * collect the rest of tid info from mbox 4. 			 * Else, quit trying to collect tid info. 			 */
name|mbox
operator|=
literal|4
expr_stmt|;
name|pf
operator|=
literal|4
expr_stmt|;
name|rc
operator|=
name|t4_query_params
argument_list|(
name|padap
argument_list|,
name|mbox
argument_list|,
name|pf
argument_list|,
literal|0
argument_list|,
literal|7
argument_list|,
name|para
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
block|}
else|else
block|{
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
block|}
name|tid
operator|->
name|ftid_base
operator|=
name|val
index|[
literal|0
index|]
expr_stmt|;
name|tid
operator|->
name|nftids
operator|=
name|val
index|[
literal|1
index|]
operator|-
name|val
index|[
literal|0
index|]
operator|+
literal|1
expr_stmt|;
comment|/*active filter region*/
if|if
condition|(
name|val
index|[
literal|2
index|]
operator|!=
name|val
index|[
literal|3
index|]
condition|)
block|{
ifdef|#
directive|ifdef
name|notyet
name|tid
operator|->
name|flags
operator||=
name|FW_OFLD_CONN
expr_stmt|;
endif|#
directive|endif
name|tid
operator|->
name|aftid_base
operator|=
name|val
index|[
literal|2
index|]
expr_stmt|;
name|tid
operator|->
name|aftid_end
operator|=
name|val
index|[
literal|3
index|]
expr_stmt|;
block|}
name|tid
operator|->
name|ntids
operator|=
name|val
index|[
literal|4
index|]
expr_stmt|;
name|tid
operator|->
name|natids
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|tid
operator|->
name|ntids
operator|/
literal|2
argument_list|,
name|MAX_ATIDS_A
argument_list|)
expr_stmt|;
name|tid
operator|->
name|stid_base
operator|=
name|val
index|[
literal|5
index|]
expr_stmt|;
name|tid
operator|->
name|nstids
operator|=
name|val
index|[
literal|6
index|]
operator|-
name|val
index|[
literal|5
index|]
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|chip_id
argument_list|(
name|padap
argument_list|)
operator|>=
name|CHELSIO_T6
condition|)
block|{
name|para
index|[
literal|0
index|]
operator|=
name|FW_PARAM_PFVF_A
argument_list|(
name|HPFILTER_START
argument_list|)
expr_stmt|;
name|para
index|[
literal|1
index|]
operator|=
name|FW_PARAM_PFVF_A
argument_list|(
name|HPFILTER_END
argument_list|)
expr_stmt|;
name|rc
operator|=
name|t4_query_params
argument_list|(
name|padap
argument_list|,
name|mbox
argument_list|,
name|pf
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|para
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|tid
operator|->
name|hpftid_base
operator|=
name|val
index|[
literal|0
index|]
expr_stmt|;
name|tid
operator|->
name|nhpftids
operator|=
name|val
index|[
literal|1
index|]
operator|-
name|val
index|[
literal|0
index|]
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|chip_id
argument_list|(
name|padap
argument_list|)
operator|<=
name|CHELSIO_T5
condition|)
block|{
name|tid
operator|->
name|sb
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_SERVER_INDEX
argument_list|)
operator|/
literal|4
expr_stmt|;
name|tid
operator|->
name|hash_base
operator|/=
literal|4
expr_stmt|;
block|}
else|else
name|tid
operator|->
name|sb
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_SRVR_START_INDEX
argument_list|)
expr_stmt|;
comment|/*UO context range*/
name|para
index|[
literal|0
index|]
operator|=
name|FW_PARAM_PFVF_A
argument_list|(
name|ETHOFLD_START
argument_list|)
expr_stmt|;
name|para
index|[
literal|1
index|]
operator|=
name|FW_PARAM_PFVF_A
argument_list|(
name|ETHOFLD_END
argument_list|)
expr_stmt|;
name|rc
operator|=
name|t4_query_params
argument_list|(
name|padap
argument_list|,
name|mbox
argument_list|,
name|pf
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|para
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
if|if
condition|(
name|val
index|[
literal|0
index|]
operator|!=
name|val
index|[
literal|1
index|]
condition|)
block|{
name|tid
operator|->
name|uotid_base
operator|=
name|val
index|[
literal|0
index|]
expr_stmt|;
name|tid
operator|->
name|nuotids
operator|=
name|val
index|[
literal|1
index|]
operator|-
name|val
index|[
literal|0
index|]
operator|+
literal|1
expr_stmt|;
block|}
name|tid
operator|->
name|IP_users
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_ACT_CNT_IPV4
argument_list|)
expr_stmt|;
name|tid
operator|->
name|IPv6_users
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_ACT_CNT_IPV6
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|FW_PARAM_PFVF_A
undef|#
directive|undef
name|FW_PARAM_DEV_A
undef|#
directive|undef
name|MAX_ATIDS_A
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_tx_rate
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|tx_rate
modifier|*
name|tx_rate
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|tx_rate
argument_list|)
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|tx_rate
operator|=
operator|(
expr|struct
name|tx_rate
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
name|t4_get_chan_txrate
argument_list|(
name|padap
argument_list|,
name|tx_rate
operator|->
name|nrate
argument_list|,
name|tx_rate
operator|->
name|orate
argument_list|)
expr_stmt|;
name|tx_rate
operator|->
name|nchan
operator|=
name|padap
operator|->
name|chip_params
operator|->
name|nchan
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|cudbg_tcamxy2valmask
parameter_list|(
name|u64
name|x
parameter_list|,
name|u64
name|y
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|,
name|u64
modifier|*
name|mask
parameter_list|)
block|{
operator|*
name|mask
operator|=
name|x
operator||
name|y
expr_stmt|;
name|y
operator|=
operator|(
name|__force
name|u64
operator|)
name|cpu_to_be64
argument_list|(
name|y
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|addr
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|y
operator|+
literal|2
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mps_rpl_backdoor
parameter_list|(
name|struct
name|adapter
modifier|*
name|padap
parameter_list|,
name|struct
name|fw_ldst_mps_rplc
modifier|*
name|mps_rplc
parameter_list|)
block|{
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|mps_rplc
operator|->
name|rplc255_224
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP3
argument_list|)
argument_list|)
expr_stmt|;
name|mps_rplc
operator|->
name|rplc223_192
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP2
argument_list|)
argument_list|)
expr_stmt|;
name|mps_rplc
operator|->
name|rplc191_160
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP1
argument_list|)
argument_list|)
expr_stmt|;
name|mps_rplc
operator|->
name|rplc159_128
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP0
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mps_rplc
operator|->
name|rplc255_224
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP7
argument_list|)
argument_list|)
expr_stmt|;
name|mps_rplc
operator|->
name|rplc223_192
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP6
argument_list|)
argument_list|)
expr_stmt|;
name|mps_rplc
operator|->
name|rplc191_160
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP5
argument_list|)
argument_list|)
expr_stmt|;
name|mps_rplc
operator|->
name|rplc159_128
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP4
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|mps_rplc
operator|->
name|rplc127_96
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP3
argument_list|)
argument_list|)
expr_stmt|;
name|mps_rplc
operator|->
name|rplc95_64
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP2
argument_list|)
argument_list|)
expr_stmt|;
name|mps_rplc
operator|->
name|rplc63_32
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP1
argument_list|)
argument_list|)
expr_stmt|;
name|mps_rplc
operator|->
name|rplc31_0
operator|=
name|htonl
argument_list|(
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_VF_RPLCT_MAP0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_mps_tcam
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_mps_tcam
modifier|*
name|tcam
init|=
name|NULL
decl_stmt|;
name|u32
name|size
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|n
decl_stmt|,
name|total_size
init|=
literal|0
decl_stmt|;
name|u32
name|ctl
decl_stmt|,
name|data2
decl_stmt|;
name|u64
name|tcamy
decl_stmt|,
name|tcamx
decl_stmt|,
name|val
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|n
operator|=
name|padap
operator|->
name|chip_params
operator|->
name|mps_tcam_size
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_mps_tcam
argument_list|)
operator|*
name|n
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|memset
argument_list|(
name|scratch_buff
operator|.
name|data
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|tcam
operator|=
operator|(
expr|struct
name|cudbg_mps_tcam
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|chip_id
argument_list|(
name|padap
argument_list|)
operator|>=
name|CHELSIO_T6
condition|)
block|{
comment|/* CtlReqID   - 1: use Host Driver Requester ID 			 * CtlCmdType - 0: Read, 1: Write 			 * CtlTcamSel - 0: TCAM0, 1: TCAM1 			 * CtlXYBitSel- 0: Y bit, 1: X bit 			 */
comment|/* Read tcamy */
name|ctl
operator|=
operator|(
name|V_CTLREQID
argument_list|(
literal|1
argument_list|)
operator||
name|V_CTLCMDTYPE
argument_list|(
literal|0
argument_list|)
operator||
name|V_CTLXYBITSEL
argument_list|(
literal|0
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|256
condition|)
name|ctl
operator||=
name|V_CTLTCAMINDEX
argument_list|(
name|i
argument_list|)
operator||
name|V_CTLTCAMSEL
argument_list|(
literal|0
argument_list|)
expr_stmt|;
else|else
name|ctl
operator||=
name|V_CTLTCAMINDEX
argument_list|(
name|i
operator|-
literal|256
argument_list|)
operator||
name|V_CTLTCAMSEL
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|t4_write_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_CLS_TCAM_DATA2_CTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|val
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_CLS_TCAM_RDATA1_REQ_ID1
argument_list|)
expr_stmt|;
name|tcamy
operator|=
name|G_DMACH
argument_list|(
name|val
argument_list|)
operator|<<
literal|32
expr_stmt|;
name|tcamy
operator||=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_CLS_TCAM_RDATA0_REQ_ID1
argument_list|)
expr_stmt|;
name|data2
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_CLS_TCAM_RDATA2_REQ_ID1
argument_list|)
expr_stmt|;
name|tcam
operator|->
name|lookup_type
operator|=
name|G_DATALKPTYPE
argument_list|(
name|data2
argument_list|)
expr_stmt|;
comment|/* 0 - Outer header, 1 - Inner header 			 * [71:48] bit locations are overloaded for 			 * outer vs. inner lookup types. 			 */
if|if
condition|(
name|tcam
operator|->
name|lookup_type
operator|&&
operator|(
name|tcam
operator|->
name|lookup_type
operator|!=
name|M_DATALKPTYPE
operator|)
condition|)
block|{
comment|/* Inner header VNI */
name|tcam
operator|->
name|vniy
operator|=
operator|(
operator|(
name|data2
operator|&
name|F_DATAVIDH2
operator|)
operator|<<
literal|23
operator|)
operator||
operator|(
name|G_DATAVIDH1
argument_list|(
name|data2
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|G_VIDL
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|tcam
operator|->
name|dip_hit
operator|=
name|data2
operator|&
name|F_DATADIPHIT
expr_stmt|;
block|}
else|else
block|{
name|tcam
operator|->
name|vlan_vld
operator|=
name|data2
operator|&
name|F_DATAVIDH2
expr_stmt|;
name|tcam
operator|->
name|ivlan
operator|=
name|G_VIDL
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
name|tcam
operator|->
name|port_num
operator|=
name|G_DATAPORTNUM
argument_list|(
name|data2
argument_list|)
expr_stmt|;
comment|/* Read tcamx. Change the control param */
name|ctl
operator||=
name|V_CTLXYBITSEL
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|t4_write_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_CLS_TCAM_DATA2_CTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|val
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_CLS_TCAM_RDATA1_REQ_ID1
argument_list|)
expr_stmt|;
name|tcamx
operator|=
name|G_DMACH
argument_list|(
name|val
argument_list|)
operator|<<
literal|32
expr_stmt|;
name|tcamx
operator||=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_CLS_TCAM_RDATA0_REQ_ID1
argument_list|)
expr_stmt|;
name|data2
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_MPS_CLS_TCAM_RDATA2_REQ_ID1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcam
operator|->
name|lookup_type
operator|&&
operator|(
name|tcam
operator|->
name|lookup_type
operator|!=
name|M_DATALKPTYPE
operator|)
condition|)
block|{
comment|/* Inner header VNI mask */
name|tcam
operator|->
name|vnix
operator|=
operator|(
operator|(
name|data2
operator|&
name|F_DATAVIDH2
operator|)
operator|<<
literal|23
operator|)
operator||
operator|(
name|G_DATAVIDH1
argument_list|(
name|data2
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|G_VIDL
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|tcamy
operator|=
name|t4_read_reg64
argument_list|(
name|padap
argument_list|,
name|MPS_CLS_TCAM_Y_L
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|tcamx
operator|=
name|t4_read_reg64
argument_list|(
name|padap
argument_list|,
name|MPS_CLS_TCAM_X_L
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tcamx
operator|&
name|tcamy
condition|)
continue|continue;
name|tcam
operator|->
name|cls_lo
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|MPS_CLS_SRAM_L
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|tcam
operator|->
name|cls_hi
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|MPS_CLS_SRAM_H
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
name|tcam
operator|->
name|repli
operator|=
operator|(
name|tcam
operator|->
name|cls_lo
operator|&
name|F_REPLICATE
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
name|tcam
operator|->
name|repli
operator|=
operator|(
name|tcam
operator|->
name|cls_lo
operator|&
name|F_T6_REPLICATE
operator|)
expr_stmt|;
if|if
condition|(
name|tcam
operator|->
name|repli
condition|)
block|{
name|struct
name|fw_ldst_cmd
name|ldst_cmd
decl_stmt|;
name|struct
name|fw_ldst_mps_rplc
name|mps_rplc
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ldst_cmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ldst_cmd
argument_list|)
argument_list|)
expr_stmt|;
name|ldst_cmd
operator|.
name|op_to_addrspace
operator|=
name|htonl
argument_list|(
name|V_FW_CMD_OP
argument_list|(
name|FW_LDST_CMD
argument_list|)
operator||
name|F_FW_CMD_REQUEST
operator||
name|F_FW_CMD_READ
operator||
name|V_FW_LDST_CMD_ADDRSPACE
argument_list|(
name|FW_LDST_ADDRSPC_MPS
argument_list|)
argument_list|)
expr_stmt|;
name|ldst_cmd
operator|.
name|cycles_to_len16
operator|=
name|htonl
argument_list|(
name|FW_LEN16
argument_list|(
name|ldst_cmd
argument_list|)
argument_list|)
expr_stmt|;
name|ldst_cmd
operator|.
name|u
operator|.
name|mps
operator|.
name|rplc
operator|.
name|fid_idx
operator|=
name|htons
argument_list|(
name|V_FW_LDST_CMD_FID
argument_list|(
name|FW_LDST_MPS_RPLC
argument_list|)
operator||
name|V_FW_LDST_CMD_IDX
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|t4_wr_mbox
argument_list|(
name|padap
argument_list|,
name|padap
operator|->
name|mbox
argument_list|,
operator|&
name|ldst_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|ldst_cmd
argument_list|)
argument_list|,
operator|&
name|ldst_cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|mps_rpl_backdoor
argument_list|(
name|padap
argument_list|,
operator|&
name|mps_rplc
argument_list|)
expr_stmt|;
else|else
name|mps_rplc
operator|=
name|ldst_cmd
operator|.
name|u
operator|.
name|mps
operator|.
name|rplc
expr_stmt|;
name|tcam
operator|->
name|rplc
index|[
literal|0
index|]
operator|=
name|ntohl
argument_list|(
name|mps_rplc
operator|.
name|rplc31_0
argument_list|)
expr_stmt|;
name|tcam
operator|->
name|rplc
index|[
literal|1
index|]
operator|=
name|ntohl
argument_list|(
name|mps_rplc
operator|.
name|rplc63_32
argument_list|)
expr_stmt|;
name|tcam
operator|->
name|rplc
index|[
literal|2
index|]
operator|=
name|ntohl
argument_list|(
name|mps_rplc
operator|.
name|rplc95_64
argument_list|)
expr_stmt|;
name|tcam
operator|->
name|rplc
index|[
literal|3
index|]
operator|=
name|ntohl
argument_list|(
name|mps_rplc
operator|.
name|rplc127_96
argument_list|)
expr_stmt|;
if|if
condition|(
name|padap
operator|->
name|chip_params
operator|->
name|mps_rplc_size
operator|>
name|CUDBG_MAX_RPLC_SIZE
condition|)
block|{
name|tcam
operator|->
name|rplc
index|[
literal|4
index|]
operator|=
name|ntohl
argument_list|(
name|mps_rplc
operator|.
name|rplc159_128
argument_list|)
expr_stmt|;
name|tcam
operator|->
name|rplc
index|[
literal|5
index|]
operator|=
name|ntohl
argument_list|(
name|mps_rplc
operator|.
name|rplc191_160
argument_list|)
expr_stmt|;
name|tcam
operator|->
name|rplc
index|[
literal|6
index|]
operator|=
name|ntohl
argument_list|(
name|mps_rplc
operator|.
name|rplc223_192
argument_list|)
expr_stmt|;
name|tcam
operator|->
name|rplc
index|[
literal|7
index|]
operator|=
name|ntohl
argument_list|(
name|mps_rplc
operator|.
name|rplc255_224
argument_list|)
expr_stmt|;
block|}
block|}
name|cudbg_tcamxy2valmask
argument_list|(
name|tcamx
argument_list|,
name|tcamy
argument_list|,
name|tcam
operator|->
name|addr
argument_list|,
operator|&
name|tcam
operator|->
name|mask
argument_list|)
expr_stmt|;
name|tcam
operator|->
name|idx
operator|=
name|i
expr_stmt|;
name|tcam
operator|->
name|rplc_size
operator|=
name|padap
operator|->
name|chip_params
operator|->
name|mps_rplc_size
expr_stmt|;
name|total_size
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_mps_tcam
argument_list|)
expr_stmt|;
name|tcam
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|total_size
operator|==
literal|0
condition|)
block|{
name|rc
operator|=
name|CUDBG_SYSTEM_ERROR
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|scratch_buff
operator|.
name|size
operator|=
name|total_size
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_pcie_config
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|size
decl_stmt|,
modifier|*
name|value
decl_stmt|,
name|j
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|,
name|n
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|*
name|NUM_PCIE_CONFIG_REGS
expr_stmt|;
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t5_pcie_config_array
argument_list|)
operator|/
operator|(
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|value
operator|=
operator|(
name|u32
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
name|t5_pcie_config_array
index|[
name|i
index|]
index|[
literal|0
index|]
init|;
name|j
operator|<=
name|t5_pcie_config_array
index|[
name|i
index|]
index|[
literal|1
index|]
condition|;
name|j
operator|+=
literal|4
control|)
block|{
operator|*
name|value
operator|++
operator|=
name|t4_hw_pci_read_cfg4
argument_list|(
name|padap
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cudbg_read_tid
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|u32
name|tid
parameter_list|,
name|struct
name|cudbg_tid_data
modifier|*
name|tid_data
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cmd_retry
init|=
literal|8
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|val
decl_stmt|;
comment|/* Fill REQ_DATA regs with 0's */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CUDBG_NUM_REQ_REGS
condition|;
name|i
operator|++
control|)
name|t4_write_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_DBGI_REQ_DATA
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Write DBIG command */
name|val
operator|=
operator|(
literal|0x4
operator|<<
name|S_DBGICMD
operator|)
operator||
name|tid
expr_stmt|;
name|t4_write_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_DBGI_REQ_TCAM_CMD
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|tid_data
operator|->
name|dbig_cmd
operator|=
name|val
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
name|val
operator||=
literal|1
operator|<<
name|S_DBGICMDSTRT
expr_stmt|;
name|val
operator||=
literal|1
expr_stmt|;
comment|/* LE mode */
name|t4_write_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_DBGI_CONFIG
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|tid_data
operator|->
name|dbig_conf
operator|=
name|val
expr_stmt|;
comment|/* Poll the DBGICMDBUSY bit */
name|val
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|val
condition|)
block|{
name|val
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_DBGI_CONFIG
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|val
operator|>>
name|S_DBGICMDBUSY
operator|)
operator|&
literal|1
expr_stmt|;
name|cmd_retry
operator|--
expr_stmt|;
if|if
condition|(
operator|!
name|cmd_retry
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s(): Timeout waiting for non-busy\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|CUDBG_SYSTEM_ERROR
return|;
block|}
block|}
comment|/* Check RESP status */
name|val
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_DBGI_RSP_STATUS
argument_list|)
expr_stmt|;
name|tid_data
operator|->
name|dbig_rsp_stat
operator|=
name|val
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|val
operator|&
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"%s(): DBGI command failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|CUDBG_SYSTEM_ERROR
return|;
block|}
comment|/* Read RESP data */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CUDBG_NUM_REQ_REGS
condition|;
name|i
operator|++
control|)
name|tid_data
operator|->
name|data
index|[
name|i
index|]
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_DBGI_RSP_DATA
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
name|tid_data
operator|->
name|tid
operator|=
name|tid
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_le_tcam
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|cudbg_tcam
name|tcam_region
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|cudbg_tid_data
modifier|*
name|tid_data
init|=
name|NULL
decl_stmt|;
name|u32
name|value
decl_stmt|,
name|bytes
init|=
literal|0
decl_stmt|,
name|bytes_left
init|=
literal|0
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|int
name|rc
decl_stmt|,
name|size
decl_stmt|;
comment|/* Get the LE regions */
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_TID_HASHBASE
argument_list|)
expr_stmt|;
comment|/* Get hash base 							     index */
name|tcam_region
operator|.
name|tid_hash_base
operator|=
name|value
expr_stmt|;
comment|/* Get routing table index */
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_ROUTING_TABLE_INDEX
argument_list|)
expr_stmt|;
name|tcam_region
operator|.
name|routing_start
operator|=
name|value
expr_stmt|;
comment|/*Get clip table index */
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_CLIP_TABLE_INDEX
argument_list|)
expr_stmt|;
name|tcam_region
operator|.
name|clip_start
operator|=
name|value
expr_stmt|;
comment|/* Get filter table index */
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_FILTER_TABLE_INDEX
argument_list|)
expr_stmt|;
name|tcam_region
operator|.
name|filter_start
operator|=
name|value
expr_stmt|;
comment|/* Get server table index */
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_SERVER_INDEX
argument_list|)
expr_stmt|;
name|tcam_region
operator|.
name|server_start
operator|=
name|value
expr_stmt|;
comment|/* Check whether hash is enabled and calculate the max tids */
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|>>
name|S_HASHEN
operator|)
operator|&
literal|1
condition|)
block|{
name|value
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_LE_DB_HASH_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
name|chip_id
argument_list|(
name|padap
argument_list|)
operator|>
name|CHELSIO_T5
condition|)
name|tcam_region
operator|.
name|max_tid
operator|=
operator|(
name|value
operator|&
literal|0xFFFFF
operator|)
operator|+
name|tcam_region
operator|.
name|tid_hash_base
expr_stmt|;
else|else
block|{
comment|/* for T5 */
name|value
operator|=
name|G_HASHTIDSIZE
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
literal|1
operator|<<
name|value
expr_stmt|;
name|tcam_region
operator|.
name|max_tid
operator|=
name|value
operator|+
name|tcam_region
operator|.
name|tid_hash_base
expr_stmt|;
block|}
block|}
else|else
comment|/* hash not enabled */
name|tcam_region
operator|.
name|max_tid
operator|=
name|CUDBG_MAX_TCAM_TID
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_tid_data
argument_list|)
operator|*
name|tcam_region
operator|.
name|max_tid
expr_stmt|;
name|size
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_tcam
argument_list|)
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|CUDBG_CHUNK_SIZE
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|memcpy
argument_list|(
name|scratch_buff
operator|.
name|data
argument_list|,
operator|&
name|tcam_region
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_tcam
argument_list|)
argument_list|)
expr_stmt|;
name|tid_data
operator|=
operator|(
expr|struct
name|cudbg_tid_data
operator|*
operator|)
operator|(
operator|(
operator|(
expr|struct
name|cudbg_tcam
operator|*
operator|)
name|scratch_buff
operator|.
name|data
operator|)
operator|+
literal|1
operator|)
expr_stmt|;
name|bytes_left
operator|=
name|CUDBG_CHUNK_SIZE
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_tcam
argument_list|)
expr_stmt|;
name|bytes
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_tcam
argument_list|)
expr_stmt|;
comment|/* read all tid */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tcam_region
operator|.
name|max_tid
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bytes_left
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_tid_data
argument_list|)
condition|)
block|{
name|scratch_buff
operator|.
name|size
operator|=
name|bytes
expr_stmt|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|scratch_buff
operator|.
name|size
operator|=
name|CUDBG_CHUNK_SIZE
expr_stmt|;
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
comment|/* new alloc */
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|CUDBG_CHUNK_SIZE
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|tid_data
operator|=
operator|(
expr|struct
name|cudbg_tid_data
operator|*
operator|)
operator|(
name|scratch_buff
operator|.
name|data
operator|)
expr_stmt|;
name|bytes_left
operator|=
name|CUDBG_CHUNK_SIZE
expr_stmt|;
name|bytes
operator|=
literal|0
expr_stmt|;
block|}
name|rc
operator|=
name|cudbg_read_tid
argument_list|(
name|pdbg_init
argument_list|,
name|i
argument_list|,
name|tid_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|cudbg_err
operator|->
name|sys_err
operator|=
name|rc
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|tid_data
operator|++
expr_stmt|;
name|bytes_left
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_tid_data
argument_list|)
expr_stmt|;
name|bytes
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|cudbg_tid_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bytes
condition|)
block|{
name|scratch_buff
operator|.
name|size
operator|=
name|bytes
expr_stmt|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
block|}
name|err1
label|:
name|scratch_buff
operator|.
name|size
operator|=
name|CUDBG_CHUNK_SIZE
expr_stmt|;
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_ma_indirect
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|ireg_buf
modifier|*
name|ma_indr
init|=
name|NULL
decl_stmt|;
name|u32
name|size
decl_stmt|,
name|j
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|,
name|n
decl_stmt|;
if|if
condition|(
name|chip_id
argument_list|(
name|padap
argument_list|)
operator|<
name|CHELSIO_T6
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"MA indirect available only in T6\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|CUDBG_STATUS_ENTITY_NOT_FOUND
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t6_ma_ireg_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ireg_buf
argument_list|)
operator|*
name|n
operator|*
literal|2
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|ma_indr
operator|=
operator|(
expr|struct
name|ireg_buf
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|ma_fli
init|=
operator|&
name|ma_indr
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|ma_indr
operator|->
name|outbuf
decl_stmt|;
name|ma_fli
operator|->
name|ireg_addr
operator|=
name|t6_ma_ireg_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|ma_fli
operator|->
name|ireg_data
operator|=
name|t6_ma_ireg_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|ma_fli
operator|->
name|ireg_local_offset
operator|=
name|t6_ma_ireg_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|ma_fli
operator|->
name|ireg_offset_range
operator|=
name|t6_ma_ireg_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
name|t4_read_indirect
argument_list|(
name|padap
argument_list|,
name|ma_fli
operator|->
name|ireg_addr
argument_list|,
name|ma_fli
operator|->
name|ireg_data
argument_list|,
name|buff
argument_list|,
name|ma_fli
operator|->
name|ireg_offset_range
argument_list|,
name|ma_fli
operator|->
name|ireg_local_offset
argument_list|)
expr_stmt|;
name|ma_indr
operator|++
expr_stmt|;
block|}
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t6_ma_ireg_array2
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|ma_fli
init|=
operator|&
name|ma_indr
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|ma_indr
operator|->
name|outbuf
decl_stmt|;
name|ma_fli
operator|->
name|ireg_addr
operator|=
name|t6_ma_ireg_array2
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|ma_fli
operator|->
name|ireg_data
operator|=
name|t6_ma_ireg_array2
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|ma_fli
operator|->
name|ireg_local_offset
operator|=
name|t6_ma_ireg_array2
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|t6_ma_ireg_array2
index|[
name|i
index|]
index|[
literal|3
index|]
condition|;
name|j
operator|++
control|)
block|{
name|t4_read_indirect
argument_list|(
name|padap
argument_list|,
name|ma_fli
operator|->
name|ireg_addr
argument_list|,
name|ma_fli
operator|->
name|ireg_data
argument_list|,
name|buff
argument_list|,
literal|1
argument_list|,
name|ma_fli
operator|->
name|ireg_local_offset
argument_list|)
expr_stmt|;
name|buff
operator|++
expr_stmt|;
name|ma_fli
operator|->
name|ireg_local_offset
operator|+=
literal|0x20
expr_stmt|;
block|}
name|ma_indr
operator|++
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_hma_indirect
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|ireg_buf
modifier|*
name|hma_indr
init|=
name|NULL
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|,
name|n
decl_stmt|;
if|if
condition|(
name|chip_id
argument_list|(
name|padap
argument_list|)
operator|<
name|CHELSIO_T6
condition|)
block|{
if|if
condition|(
name|pdbg_init
operator|->
name|verbose
condition|)
name|pdbg_init
operator|->
name|print
argument_list|(
literal|"HMA indirect available only in T6\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|CUDBG_STATUS_ENTITY_NOT_FOUND
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t6_hma_ireg_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ireg_buf
argument_list|)
operator|*
name|n
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|hma_indr
operator|=
operator|(
expr|struct
name|ireg_buf
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|hma_fli
init|=
operator|&
name|hma_indr
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|hma_indr
operator|->
name|outbuf
decl_stmt|;
name|hma_fli
operator|->
name|ireg_addr
operator|=
name|t6_hma_ireg_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|hma_fli
operator|->
name|ireg_data
operator|=
name|t6_hma_ireg_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|hma_fli
operator|->
name|ireg_local_offset
operator|=
name|t6_hma_ireg_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|hma_fli
operator|->
name|ireg_offset_range
operator|=
name|t6_hma_ireg_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
name|t4_read_indirect
argument_list|(
name|padap
argument_list|,
name|hma_fli
operator|->
name|ireg_addr
argument_list|,
name|hma_fli
operator|->
name|ireg_data
argument_list|,
name|buff
argument_list|,
name|hma_fli
operator|->
name|ireg_offset_range
argument_list|,
name|hma_fli
operator|->
name|ireg_local_offset
argument_list|)
expr_stmt|;
name|hma_indr
operator|++
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_pcie_indirect
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|ireg_buf
modifier|*
name|ch_pcie
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|,
name|n
decl_stmt|;
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t5_pcie_pdbg_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ireg_buf
argument_list|)
operator|*
name|n
operator|*
literal|2
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|ch_pcie
operator|=
operator|(
expr|struct
name|ireg_buf
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/*PCIE_PDBG*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|pcie_pio
init|=
operator|&
name|ch_pcie
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|ch_pcie
operator|->
name|outbuf
decl_stmt|;
name|pcie_pio
operator|->
name|ireg_addr
operator|=
name|t5_pcie_pdbg_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|pcie_pio
operator|->
name|ireg_data
operator|=
name|t5_pcie_pdbg_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|pcie_pio
operator|->
name|ireg_local_offset
operator|=
name|t5_pcie_pdbg_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|pcie_pio
operator|->
name|ireg_offset_range
operator|=
name|t5_pcie_pdbg_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
name|t4_read_indirect
argument_list|(
name|padap
argument_list|,
name|pcie_pio
operator|->
name|ireg_addr
argument_list|,
name|pcie_pio
operator|->
name|ireg_data
argument_list|,
name|buff
argument_list|,
name|pcie_pio
operator|->
name|ireg_offset_range
argument_list|,
name|pcie_pio
operator|->
name|ireg_local_offset
argument_list|)
expr_stmt|;
name|ch_pcie
operator|++
expr_stmt|;
block|}
comment|/*PCIE_CDBG*/
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t5_pcie_cdbg_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|pcie_pio
init|=
operator|&
name|ch_pcie
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|ch_pcie
operator|->
name|outbuf
decl_stmt|;
name|pcie_pio
operator|->
name|ireg_addr
operator|=
name|t5_pcie_cdbg_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|pcie_pio
operator|->
name|ireg_data
operator|=
name|t5_pcie_cdbg_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|pcie_pio
operator|->
name|ireg_local_offset
operator|=
name|t5_pcie_cdbg_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|pcie_pio
operator|->
name|ireg_offset_range
operator|=
name|t5_pcie_cdbg_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
name|t4_read_indirect
argument_list|(
name|padap
argument_list|,
name|pcie_pio
operator|->
name|ireg_addr
argument_list|,
name|pcie_pio
operator|->
name|ireg_data
argument_list|,
name|buff
argument_list|,
name|pcie_pio
operator|->
name|ireg_offset_range
argument_list|,
name|pcie_pio
operator|->
name|ireg_local_offset
argument_list|)
expr_stmt|;
name|ch_pcie
operator|++
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_tp_indirect
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|ireg_buf
modifier|*
name|ch_tp_pio
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|,
name|n
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t5_tp_pio_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t6_tp_pio_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ireg_buf
argument_list|)
operator|*
name|n
operator|*
literal|3
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|ch_tp_pio
operator|=
operator|(
expr|struct
name|ireg_buf
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/* TP_PIO*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|tp_pio
init|=
operator|&
name|ch_tp_pio
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|ch_tp_pio
operator|->
name|outbuf
decl_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|tp_pio
operator|->
name|ireg_addr
operator|=
name|t5_tp_pio_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_data
operator|=
name|t5_tp_pio_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_local_offset
operator|=
name|t5_tp_pio_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_offset_range
operator|=
name|t5_tp_pio_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|tp_pio
operator|->
name|ireg_addr
operator|=
name|t6_tp_pio_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_data
operator|=
name|t6_tp_pio_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_local_offset
operator|=
name|t6_tp_pio_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_offset_range
operator|=
name|t6_tp_pio_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
block|}
name|t4_tp_pio_read
argument_list|(
name|padap
argument_list|,
name|buff
argument_list|,
name|tp_pio
operator|->
name|ireg_offset_range
argument_list|,
name|tp_pio
operator|->
name|ireg_local_offset
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ch_tp_pio
operator|++
expr_stmt|;
block|}
comment|/* TP_TM_PIO*/
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t5_tp_tm_pio_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t6_tp_tm_pio_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|tp_pio
init|=
operator|&
name|ch_tp_pio
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|ch_tp_pio
operator|->
name|outbuf
decl_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|tp_pio
operator|->
name|ireg_addr
operator|=
name|t5_tp_tm_pio_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_data
operator|=
name|t5_tp_tm_pio_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_local_offset
operator|=
name|t5_tp_tm_pio_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_offset_range
operator|=
name|t5_tp_tm_pio_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|tp_pio
operator|->
name|ireg_addr
operator|=
name|t6_tp_tm_pio_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_data
operator|=
name|t6_tp_tm_pio_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_local_offset
operator|=
name|t6_tp_tm_pio_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_offset_range
operator|=
name|t6_tp_tm_pio_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
block|}
name|t4_tp_tm_pio_read
argument_list|(
name|padap
argument_list|,
name|buff
argument_list|,
name|tp_pio
operator|->
name|ireg_offset_range
argument_list|,
name|tp_pio
operator|->
name|ireg_local_offset
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ch_tp_pio
operator|++
expr_stmt|;
block|}
comment|/* TP_MIB_INDEX*/
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t5_tp_mib_index_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|t6_tp_mib_index_array
argument_list|)
operator|/
operator|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|tp_pio
init|=
operator|&
name|ch_tp_pio
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|ch_tp_pio
operator|->
name|outbuf
decl_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|tp_pio
operator|->
name|ireg_addr
operator|=
name|t5_tp_mib_index_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_data
operator|=
name|t5_tp_mib_index_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_local_offset
operator|=
name|t5_tp_mib_index_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_offset_range
operator|=
name|t5_tp_mib_index_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|tp_pio
operator|->
name|ireg_addr
operator|=
name|t6_tp_mib_index_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_data
operator|=
name|t6_tp_mib_index_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_local_offset
operator|=
name|t6_tp_mib_index_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|tp_pio
operator|->
name|ireg_offset_range
operator|=
name|t6_tp_mib_index_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
block|}
name|t4_tp_mib_read
argument_list|(
name|padap
argument_list|,
name|buff
argument_list|,
name|tp_pio
operator|->
name|ireg_offset_range
argument_list|,
name|tp_pio
operator|->
name|ireg_local_offset
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ch_tp_pio
operator|++
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_sge_indirect
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|ireg_buf
modifier|*
name|ch_sge_dbg
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ireg_buf
argument_list|)
operator|*
literal|2
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|ch_sge_dbg
operator|=
operator|(
expr|struct
name|ireg_buf
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ireg_field
modifier|*
name|sge_pio
init|=
operator|&
name|ch_sge_dbg
operator|->
name|tp_pio
decl_stmt|;
name|u32
modifier|*
name|buff
init|=
name|ch_sge_dbg
operator|->
name|outbuf
decl_stmt|;
name|sge_pio
operator|->
name|ireg_addr
operator|=
name|t5_sge_dbg_index_array
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
name|sge_pio
operator|->
name|ireg_data
operator|=
name|t5_sge_dbg_index_array
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
name|sge_pio
operator|->
name|ireg_local_offset
operator|=
name|t5_sge_dbg_index_array
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
name|sge_pio
operator|->
name|ireg_offset_range
operator|=
name|t5_sge_dbg_index_array
index|[
name|i
index|]
index|[
literal|3
index|]
expr_stmt|;
name|t4_read_indirect
argument_list|(
name|padap
argument_list|,
name|sge_pio
operator|->
name|ireg_addr
argument_list|,
name|sge_pio
operator|->
name|ireg_data
argument_list|,
name|buff
argument_list|,
name|sge_pio
operator|->
name|ireg_offset_range
argument_list|,
name|sge_pio
operator|->
name|ireg_local_offset
argument_list|)
expr_stmt|;
name|ch_sge_dbg
operator|++
expr_stmt|;
block|}
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_full
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|u32
name|reg_addr
decl_stmt|,
name|reg_data
decl_stmt|,
name|reg_local_offset
decl_stmt|,
name|reg_offset_range
decl_stmt|;
name|u32
modifier|*
name|sp
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|int
name|nreg
init|=
literal|0
decl_stmt|;
comment|/* Collect Registers: 	 * TP_DBG_SCHED_TX (0x7e40 + 0x6a), 	 * TP_DBG_SCHED_RX (0x7e40 + 0x6b), 	 * TP_DBG_CSIDE_INT (0x7e40 + 0x23f), 	 * TP_DBG_ESIDE_INT (0x7e40 + 0x148), 	 * PCIE_CDEBUG_INDEX[AppData0] (0x5a10 + 2), 	 * PCIE_CDEBUG_INDEX[AppData1] (0x5a10 + 3)  This is for T6 	 * SGE_DEBUG_DATA_HIGH_INDEX_10 (0x12a8) 	 **/
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
name|nreg
operator|=
literal|6
expr_stmt|;
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
name|nreg
operator|=
literal|7
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|nreg
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|sp
operator|=
operator|(
name|u32
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
comment|/* TP_DBG_SCHED_TX */
name|reg_local_offset
operator|=
name|t5_tp_pio_array
index|[
literal|3
index|]
index|[
literal|2
index|]
operator|+
literal|0xa
expr_stmt|;
name|reg_offset_range
operator|=
literal|1
expr_stmt|;
name|t4_tp_pio_read
argument_list|(
name|padap
argument_list|,
name|sp
argument_list|,
name|reg_offset_range
argument_list|,
name|reg_local_offset
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|sp
operator|++
expr_stmt|;
comment|/* TP_DBG_SCHED_RX */
name|reg_local_offset
operator|=
name|t5_tp_pio_array
index|[
literal|3
index|]
index|[
literal|2
index|]
operator|+
literal|0xb
expr_stmt|;
name|reg_offset_range
operator|=
literal|1
expr_stmt|;
name|t4_tp_pio_read
argument_list|(
name|padap
argument_list|,
name|sp
argument_list|,
name|reg_offset_range
argument_list|,
name|reg_local_offset
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|sp
operator|++
expr_stmt|;
comment|/* TP_DBG_CSIDE_INT */
name|reg_local_offset
operator|=
name|t5_tp_pio_array
index|[
literal|9
index|]
index|[
literal|2
index|]
operator|+
literal|0xf
expr_stmt|;
name|reg_offset_range
operator|=
literal|1
expr_stmt|;
name|t4_tp_pio_read
argument_list|(
name|padap
argument_list|,
name|sp
argument_list|,
name|reg_offset_range
argument_list|,
name|reg_local_offset
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|sp
operator|++
expr_stmt|;
comment|/* TP_DBG_ESIDE_INT */
name|reg_local_offset
operator|=
name|t5_tp_pio_array
index|[
literal|8
index|]
index|[
literal|2
index|]
operator|+
literal|3
expr_stmt|;
name|reg_offset_range
operator|=
literal|1
expr_stmt|;
name|t4_tp_pio_read
argument_list|(
name|padap
argument_list|,
name|sp
argument_list|,
name|reg_offset_range
argument_list|,
name|reg_local_offset
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|sp
operator|++
expr_stmt|;
comment|/* PCIE_CDEBUG_INDEX[AppData0] */
name|reg_addr
operator|=
name|t5_pcie_cdbg_array
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|reg_data
operator|=
name|t5_pcie_cdbg_array
index|[
literal|0
index|]
index|[
literal|1
index|]
expr_stmt|;
name|reg_local_offset
operator|=
name|t5_pcie_cdbg_array
index|[
literal|0
index|]
index|[
literal|2
index|]
operator|+
literal|2
expr_stmt|;
name|reg_offset_range
operator|=
literal|1
expr_stmt|;
name|t4_read_indirect
argument_list|(
name|padap
argument_list|,
name|reg_addr
argument_list|,
name|reg_data
argument_list|,
name|sp
argument_list|,
name|reg_offset_range
argument_list|,
name|reg_local_offset
argument_list|)
expr_stmt|;
name|sp
operator|++
expr_stmt|;
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
block|{
comment|/* PCIE_CDEBUG_INDEX[AppData1] */
name|reg_addr
operator|=
name|t5_pcie_cdbg_array
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|reg_data
operator|=
name|t5_pcie_cdbg_array
index|[
literal|0
index|]
index|[
literal|1
index|]
expr_stmt|;
name|reg_local_offset
operator|=
name|t5_pcie_cdbg_array
index|[
literal|0
index|]
index|[
literal|2
index|]
operator|+
literal|3
expr_stmt|;
name|reg_offset_range
operator|=
literal|1
expr_stmt|;
name|t4_read_indirect
argument_list|(
name|padap
argument_list|,
name|reg_addr
argument_list|,
name|reg_data
argument_list|,
name|sp
argument_list|,
name|reg_offset_range
argument_list|,
name|reg_local_offset
argument_list|)
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
comment|/* SGE_DEBUG_DATA_HIGH_INDEX_10 */
operator|*
name|sp
operator|=
name|t4_read_reg
argument_list|(
name|padap
argument_list|,
name|A_SGE_DEBUG_DATA_HIGH_INDEX_10
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_vpd_data
parameter_list|(
name|struct
name|cudbg_init
modifier|*
name|pdbg_init
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|dbg_buff
parameter_list|,
name|struct
name|cudbg_error
modifier|*
name|cudbg_err
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|notyet
name|struct
name|cudbg_buffer
name|scratch_buff
decl_stmt|;
name|struct
name|adapter
modifier|*
name|padap
init|=
name|pdbg_init
operator|->
name|adap
decl_stmt|;
name|struct
name|struct_vpd_data
modifier|*
name|vpd_data
decl_stmt|;
name|char
name|vpd_ver
index|[
literal|4
index|]
decl_stmt|;
name|u32
name|fw_vers
decl_stmt|;
name|u32
name|size
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|struct_vpd_data
argument_list|)
expr_stmt|;
name|scratch_buff
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|dbg_buff
argument_list|,
name|scratch_buff
operator|.
name|size
argument_list|,
operator|&
name|scratch_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|vpd_data
operator|=
operator|(
expr|struct
name|struct_vpd_data
operator|*
operator|)
name|scratch_buff
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|is_t5
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|read_vpd_reg
argument_list|(
name|padap
argument_list|,
name|SN_REG_ADDR
argument_list|,
name|SN_MAX_LEN
argument_list|,
name|vpd_data
operator|->
name|sn
argument_list|)
expr_stmt|;
name|read_vpd_reg
argument_list|(
name|padap
argument_list|,
name|BN_REG_ADDR
argument_list|,
name|BN_MAX_LEN
argument_list|,
name|vpd_data
operator|->
name|bn
argument_list|)
expr_stmt|;
name|read_vpd_reg
argument_list|(
name|padap
argument_list|,
name|NA_REG_ADDR
argument_list|,
name|NA_MAX_LEN
argument_list|,
name|vpd_data
operator|->
name|na
argument_list|)
expr_stmt|;
name|read_vpd_reg
argument_list|(
name|padap
argument_list|,
name|MN_REG_ADDR
argument_list|,
name|MN_MAX_LEN
argument_list|,
name|vpd_data
operator|->
name|mn
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_t6
argument_list|(
name|padap
argument_list|)
condition|)
block|{
name|read_vpd_reg
argument_list|(
name|padap
argument_list|,
name|SN_T6_ADDR
argument_list|,
name|SN_MAX_LEN
argument_list|,
name|vpd_data
operator|->
name|sn
argument_list|)
expr_stmt|;
name|read_vpd_reg
argument_list|(
name|padap
argument_list|,
name|BN_T6_ADDR
argument_list|,
name|BN_MAX_LEN
argument_list|,
name|vpd_data
operator|->
name|bn
argument_list|)
expr_stmt|;
name|read_vpd_reg
argument_list|(
name|padap
argument_list|,
name|NA_T6_ADDR
argument_list|,
name|NA_MAX_LEN
argument_list|,
name|vpd_data
operator|->
name|na
argument_list|)
expr_stmt|;
name|read_vpd_reg
argument_list|(
name|padap
argument_list|,
name|MN_T6_ADDR
argument_list|,
name|MN_MAX_LEN
argument_list|,
name|vpd_data
operator|->
name|mn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|is_fw_attached
argument_list|(
name|pdbg_init
argument_list|)
condition|)
block|{
name|rc
operator|=
name|t4_get_scfg_version
argument_list|(
name|padap
argument_list|,
operator|&
name|vpd_data
operator|->
name|scfg_vers
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|rc
condition|)
block|{
comment|/* Now trying with backdoor mechanism */
name|rc
operator|=
name|read_vpd_reg
argument_list|(
name|padap
argument_list|,
name|SCFG_VER_ADDR
argument_list|,
name|SCFG_VER_LEN
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|vpd_data
operator|->
name|scfg_vers
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
block|}
if|if
condition|(
name|is_fw_attached
argument_list|(
name|pdbg_init
argument_list|)
condition|)
block|{
name|rc
operator|=
name|t4_get_vpd_version
argument_list|(
name|padap
argument_list|,
operator|&
name|vpd_data
operator|->
name|vpd_vers
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|rc
condition|)
block|{
comment|/* Now trying with backdoor mechanism */
name|rc
operator|=
name|read_vpd_reg
argument_list|(
name|padap
argument_list|,
name|VPD_VER_ADDR
argument_list|,
name|VPD_VER_LEN
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|vpd_ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
comment|/* read_vpd_reg return string of stored hex 		 * converting hex string to char string 		 * vpd version is 2 bytes only */
name|sprintf
argument_list|(
name|vpd_ver
argument_list|,
literal|"%c%c\n"
argument_list|,
name|vpd_ver
index|[
literal|0
index|]
argument_list|,
name|vpd_ver
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|vpd_data
operator|->
name|vpd_vers
operator|=
name|simple_strtoul
argument_list|(
name|vpd_ver
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
comment|/* Get FW version if it's not already filled in */
name|fw_vers
operator|=
name|padap
operator|->
name|params
operator|.
name|fw_vers
expr_stmt|;
if|if
condition|(
operator|!
name|fw_vers
condition|)
block|{
name|rc
operator|=
name|t4_get_fw_version
argument_list|(
name|padap
argument_list|,
operator|&
name|fw_vers
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
block|}
name|vpd_data
operator|->
name|fw_major
operator|=
name|G_FW_HDR_FW_VER_MAJOR
argument_list|(
name|fw_vers
argument_list|)
expr_stmt|;
name|vpd_data
operator|->
name|fw_minor
operator|=
name|G_FW_HDR_FW_VER_MINOR
argument_list|(
name|fw_vers
argument_list|)
expr_stmt|;
name|vpd_data
operator|->
name|fw_micro
operator|=
name|G_FW_HDR_FW_VER_MICRO
argument_list|(
name|fw_vers
argument_list|)
expr_stmt|;
name|vpd_data
operator|->
name|fw_build
operator|=
name|G_FW_HDR_FW_VER_BUILD
argument_list|(
name|fw_vers
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_compression_hdr
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|compress_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|scratch_buff
argument_list|,
name|dbg_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
endif|#
directive|endif
return|return
operator|(
name|EDOOFUS
operator|)
return|;
block|}
end_function

end_unit


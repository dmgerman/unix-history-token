begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    FastLZ - lightning-fast lossless compression library     Copyright (C) 2007 Ariya Hidayat (ariya@kde.org)    Copyright (C) 2006 Ariya Hidayat (ariya@kde.org)    Copyright (C) 2005 Ariya Hidayat (ariya@kde.org)     Permission is hereby granted, free of charge, to any person obtaining a copy    of this software and associated documentation files (the "Software"), to deal    in the Software without restriction, including without limitation the rights    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell    copies of the Software, and to permit persons to whom the Software is    furnished to do so, subject to the following conditions:     The above copyright notice and this permission notice shall be included in    all copies or substantial portions of the Software.     THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN    THE SOFTWARE.    */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"osdep.h"
end_include

begin_include
include|#
directive|include
file|"cudbg.h"
end_include

begin_include
include|#
directive|include
file|"cudbg_lib_common.h"
end_include

begin_include
include|#
directive|include
file|"fastlz.h"
end_include

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|sixpack_magic
index|[
literal|8
index|]
init|=
block|{
literal|137
block|,
literal|'6'
block|,
literal|'P'
block|,
literal|'K'
block|,
literal|13
block|,
literal|10
block|,
literal|26
block|,
literal|10
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CUDBG_BLOCK_SIZE
value|(63*1024)
end_define

begin_define
define|#
directive|define
name|CUDBG_CHUNK_BUF_LEN
value|16
end_define

begin_define
define|#
directive|define
name|CUDBG_MIN_COMPR_LEN
value|32
end_define

begin_comment
comment|/*min data length for applying compression*/
end_comment

begin_comment
comment|/* for Adler-32 checksum algorithm, see RFC 1950 Section 8.2 */
end_comment

begin_define
define|#
directive|define
name|ADLER32_BASE
value|65521
end_define

begin_function
specifier|static
specifier|inline
name|unsigned
name|long
name|update_adler32
parameter_list|(
name|unsigned
name|long
name|checksum
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|ptr
init|=
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|buf
decl_stmt|;
name|unsigned
name|long
name|s1
init|=
name|checksum
operator|&
literal|0xffff
decl_stmt|;
name|unsigned
name|long
name|s2
init|=
operator|(
name|checksum
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
decl_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|unsigned
name|k
init|=
name|len
operator|<
literal|5552
condition|?
name|len
else|:
literal|5552
decl_stmt|;
name|len
operator|-=
name|k
expr_stmt|;
while|while
condition|(
name|k
operator|>=
literal|8
condition|)
block|{
name|s1
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|s2
operator|+=
name|s1
expr_stmt|;
name|s1
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|s2
operator|+=
name|s1
expr_stmt|;
name|s1
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|s2
operator|+=
name|s1
expr_stmt|;
name|s1
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|s2
operator|+=
name|s1
expr_stmt|;
name|s1
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|s2
operator|+=
name|s1
expr_stmt|;
name|s1
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|s2
operator|+=
name|s1
expr_stmt|;
name|s1
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|s2
operator|+=
name|s1
expr_stmt|;
name|s1
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|s2
operator|+=
name|s1
expr_stmt|;
name|k
operator|-=
literal|8
expr_stmt|;
block|}
while|while
condition|(
name|k
operator|--
operator|>
literal|0
condition|)
block|{
name|s1
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|s2
operator|+=
name|s1
expr_stmt|;
block|}
name|s1
operator|=
name|s1
operator|%
name|ADLER32_BASE
expr_stmt|;
name|s2
operator|=
name|s2
operator|%
name|ADLER32_BASE
expr_stmt|;
block|}
return|return
operator|(
name|s2
operator|<<
literal|16
operator|)
operator|+
name|s1
return|;
block|}
end_function

begin_function
name|int
name|write_magic
parameter_list|(
name|struct
name|cudbg_buffer
modifier|*
name|_out_buff
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|write_to_buf
argument_list|(
name|_out_buff
operator|->
name|data
argument_list|,
name|_out_buff
operator|->
name|size
argument_list|,
operator|&
name|_out_buff
operator|->
name|offset
argument_list|,
name|sixpack_magic
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|write_to_buf
parameter_list|(
name|void
modifier|*
name|out_buf
parameter_list|,
name|u32
name|out_buf_size
parameter_list|,
name|u32
modifier|*
name|offset
parameter_list|,
name|void
modifier|*
name|in_buf
parameter_list|,
name|u32
name|in_buf_size
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|*
name|offset
operator|>=
name|out_buf_size
condition|)
block|{
name|rc
operator|=
name|CUDBG_STATUS_OUTBUFF_OVERFLOW
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|out_buf
operator|+
operator|*
name|offset
argument_list|,
name|in_buf
argument_list|,
name|in_buf_size
argument_list|)
expr_stmt|;
operator|*
name|offset
operator|=
operator|*
name|offset
operator|+
name|in_buf_size
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|read_from_buf
parameter_list|(
name|void
modifier|*
name|in_buf
parameter_list|,
name|u32
name|in_buf_size
parameter_list|,
name|u32
modifier|*
name|offset
parameter_list|,
name|void
modifier|*
name|out_buf
parameter_list|,
name|u32
name|out_buf_size
parameter_list|)
block|{
if|if
condition|(
name|in_buf_size
operator|-
operator|*
name|offset
operator|<
name|out_buf_size
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|out_buf
argument_list|,
operator|(
name|char
operator|*
operator|)
name|in_buf
operator|+
operator|*
name|offset
argument_list|,
name|out_buf_size
argument_list|)
expr_stmt|;
operator|*
name|offset
operator|=
operator|*
name|offset
operator|+
name|out_buf_size
expr_stmt|;
return|return
name|out_buf_size
return|;
block|}
end_function

begin_function
name|int
name|write_chunk_header
parameter_list|(
name|struct
name|cudbg_buffer
modifier|*
name|_outbuf
parameter_list|,
name|int
name|id
parameter_list|,
name|int
name|options
parameter_list|,
name|unsigned
name|long
name|size
parameter_list|,
name|unsigned
name|long
name|checksum
parameter_list|,
name|unsigned
name|long
name|extra
parameter_list|)
block|{
name|unsigned
name|char
name|buffer
index|[
name|CUDBG_CHUNK_BUF_LEN
index|]
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
name|id
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|1
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|id
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|buffer
index|[
literal|2
index|]
operator|=
name|options
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|3
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|options
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|buffer
index|[
literal|4
index|]
operator|=
name|size
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|5
index|]
operator|=
operator|(
name|size
operator|>>
literal|8
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|6
index|]
operator|=
operator|(
name|size
operator|>>
literal|16
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|7
index|]
operator|=
operator|(
name|size
operator|>>
literal|24
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|8
index|]
operator|=
name|checksum
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|9
index|]
operator|=
operator|(
name|checksum
operator|>>
literal|8
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|10
index|]
operator|=
operator|(
name|checksum
operator|>>
literal|16
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|11
index|]
operator|=
operator|(
name|checksum
operator|>>
literal|24
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|12
index|]
operator|=
name|extra
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|13
index|]
operator|=
operator|(
name|extra
operator|>>
literal|8
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|14
index|]
operator|=
operator|(
name|extra
operator|>>
literal|16
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|15
index|]
operator|=
operator|(
name|extra
operator|>>
literal|24
operator|)
operator|&
literal|255
expr_stmt|;
name|rc
operator|=
name|write_to_buf
argument_list|(
name|_outbuf
operator|->
name|data
argument_list|,
name|_outbuf
operator|->
name|size
argument_list|,
operator|&
name|_outbuf
operator|->
name|offset
argument_list|,
name|buffer
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|write_compression_hdr
parameter_list|(
name|struct
name|cudbg_buffer
modifier|*
name|pin_buff
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|pout_buff
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|tmp_buffer
decl_stmt|;
name|unsigned
name|long
name|fsize
init|=
name|pin_buff
operator|->
name|size
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buffer
decl_stmt|;
name|unsigned
name|long
name|checksum
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|char
modifier|*
name|shown_name
init|=
literal|"abc"
decl_stmt|;
comment|/* Always release inner scratch buffer, before releasing outer. */
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|pout_buff
argument_list|,
literal|10
argument_list|,
operator|&
name|tmp_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|buffer
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|tmp_buffer
operator|.
name|data
expr_stmt|;
name|rc
operator|=
name|write_magic
argument_list|(
name|pout_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
comment|/* chunk for File Entry */
name|buffer
index|[
literal|0
index|]
operator|=
name|fsize
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|1
index|]
operator|=
operator|(
name|fsize
operator|>>
literal|8
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|2
index|]
operator|=
operator|(
name|fsize
operator|>>
literal|16
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|3
index|]
operator|=
operator|(
name|fsize
operator|>>
literal|24
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|buffer
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|buffer
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|buffer
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|buffer
index|[
literal|8
index|]
operator|=
operator|(
name|strlen
argument_list|(
name|shown_name
argument_list|)
operator|+
literal|1
operator|)
operator|&
literal|255
expr_stmt|;
name|buffer
index|[
literal|9
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
operator|(
name|strlen
argument_list|(
name|shown_name
argument_list|)
operator|+
literal|1
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|checksum
operator|=
literal|1L
expr_stmt|;
name|checksum
operator|=
name|update_adler32
argument_list|(
name|checksum
argument_list|,
name|buffer
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|checksum
operator|=
name|update_adler32
argument_list|(
name|checksum
argument_list|,
name|shown_name
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|shown_name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_chunk_header
argument_list|(
name|pout_buff
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|10
operator|+
operator|(
name|unsigned
name|long
operator|)
name|strlen
argument_list|(
name|shown_name
argument_list|)
operator|+
literal|1
argument_list|,
name|checksum
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|write_to_buf
argument_list|(
name|pout_buff
operator|->
name|data
argument_list|,
name|pout_buff
operator|->
name|size
argument_list|,
operator|&
operator|(
name|pout_buff
operator|->
name|offset
operator|)
argument_list|,
name|buffer
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|rc
operator|=
name|write_to_buf
argument_list|(
name|pout_buff
operator|->
name|data
argument_list|,
name|pout_buff
operator|->
name|size
argument_list|,
operator|&
operator|(
name|pout_buff
operator|->
name|offset
operator|)
argument_list|,
name|shown_name
argument_list|,
operator|(
name|u32
operator|)
name|strlen
argument_list|(
name|shown_name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err1
goto|;
name|err1
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|tmp_buffer
argument_list|,
name|pout_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|compress_buff
parameter_list|(
name|struct
name|cudbg_buffer
modifier|*
name|pin_buff
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|pout_buff
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|tmp_buffer
decl_stmt|;
name|struct
name|cudbg_hdr
modifier|*
name|cudbg_hdr
decl_stmt|;
name|unsigned
name|long
name|checksum
decl_stmt|;
name|unsigned
name|char
modifier|*
name|result
decl_stmt|;
name|unsigned
name|int
name|bytes_read
decl_stmt|;
name|int
name|chunk_size
decl_stmt|,
name|level
init|=
literal|2
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|int
name|compress_method
init|=
literal|1
decl_stmt|;
name|bytes_read
operator|=
name|pin_buff
operator|->
name|size
expr_stmt|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|pout_buff
argument_list|,
name|CUDBG_BLOCK_SIZE
argument_list|,
operator|&
name|tmp_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
name|result
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|tmp_buffer
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|bytes_read
operator|<
literal|32
condition|)
name|compress_method
operator|=
literal|0
expr_stmt|;
name|cudbg_hdr
operator|=
operator|(
expr|struct
name|cudbg_hdr
operator|*
operator|)
name|pout_buff
operator|->
name|data
expr_stmt|;
switch|switch
condition|(
name|compress_method
condition|)
block|{
case|case
literal|1
case|:
name|chunk_size
operator|=
name|fastlz_compress_level
argument_list|(
name|level
argument_list|,
name|pin_buff
operator|->
name|data
argument_list|,
name|bytes_read
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|checksum
operator|=
name|update_adler32
argument_list|(
literal|1L
argument_list|,
name|result
argument_list|,
name|chunk_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|chunk_size
operator|>
literal|62000
operator|)
operator|&&
operator|(
name|cudbg_hdr
operator|->
name|reserved
index|[
literal|7
index|]
operator|<
operator|(
name|u32
operator|)
name|chunk_size
operator|)
condition|)
comment|/* 64512 */
name|cudbg_hdr
operator|->
name|reserved
index|[
literal|7
index|]
operator|=
operator|(
name|u32
operator|)
name|chunk_size
expr_stmt|;
name|rc
operator|=
name|write_chunk_header
argument_list|(
name|pout_buff
argument_list|,
literal|17
argument_list|,
literal|1
argument_list|,
name|chunk_size
argument_list|,
name|checksum
argument_list|,
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err_put_buff
goto|;
name|rc
operator|=
name|write_to_buf
argument_list|(
name|pout_buff
operator|->
name|data
argument_list|,
name|pout_buff
operator|->
name|size
argument_list|,
operator|&
name|pout_buff
operator|->
name|offset
argument_list|,
name|result
argument_list|,
name|chunk_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err_put_buff
goto|;
break|break;
comment|/* uncompressed, also fallback method */
case|case
literal|0
case|:
default|default:
name|checksum
operator|=
name|update_adler32
argument_list|(
literal|1L
argument_list|,
name|pin_buff
operator|->
name|data
argument_list|,
name|bytes_read
argument_list|)
expr_stmt|;
name|rc
operator|=
name|write_chunk_header
argument_list|(
name|pout_buff
argument_list|,
literal|17
argument_list|,
literal|0
argument_list|,
name|bytes_read
argument_list|,
name|checksum
argument_list|,
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err_put_buff
goto|;
name|rc
operator|=
name|write_to_buf
argument_list|(
name|pout_buff
operator|->
name|data
argument_list|,
name|pout_buff
operator|->
name|size
argument_list|,
operator|&
name|pout_buff
operator|->
name|offset
argument_list|,
name|pin_buff
operator|->
name|data
argument_list|,
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err_put_buff
goto|;
break|break;
block|}
name|err_put_buff
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|tmp_buffer
argument_list|,
name|pout_buff
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/* return non-zero if magic sequence is detected */
end_comment

begin_comment
comment|/* warning: reset the read pointer to the beginning of the file */
end_comment

begin_function
name|int
name|detect_magic
parameter_list|(
name|struct
name|cudbg_buffer
modifier|*
name|_c_buff
parameter_list|)
block|{
name|unsigned
name|char
name|buffer
index|[
literal|8
index|]
decl_stmt|;
name|size_t
name|bytes_read
decl_stmt|;
name|int
name|c
decl_stmt|;
name|bytes_read
operator|=
name|read_from_buf
argument_list|(
name|_c_buff
operator|->
name|data
argument_list|,
name|_c_buff
operator|->
name|size
argument_list|,
operator|&
name|_c_buff
operator|->
name|offset
argument_list|,
name|buffer
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes_read
operator|<
literal|8
condition|)
return|return
literal|0
return|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|8
condition|;
name|c
operator|++
control|)
if|if
condition|(
name|buffer
index|[
name|c
index|]
operator|!=
name|sixpack_magic
index|[
name|c
index|]
condition|)
return|return
literal|0
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|unsigned
name|long
name|readU16
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|ptr
parameter_list|)
block|{
return|return
name|ptr
index|[
literal|0
index|]
operator|+
operator|(
name|ptr
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|unsigned
name|long
name|readU32
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|ptr
parameter_list|)
block|{
return|return
name|ptr
index|[
literal|0
index|]
operator|+
operator|(
name|ptr
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator|+
operator|(
name|ptr
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator|+
operator|(
name|ptr
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
return|;
block|}
end_function

begin_function
name|int
name|read_chunk_header
parameter_list|(
name|struct
name|cudbg_buffer
modifier|*
name|pc_buff
parameter_list|,
name|int
modifier|*
name|pid
parameter_list|,
name|int
modifier|*
name|poptions
parameter_list|,
name|unsigned
name|long
modifier|*
name|psize
parameter_list|,
name|unsigned
name|long
modifier|*
name|pchecksum
parameter_list|,
name|unsigned
name|long
modifier|*
name|pextra
parameter_list|)
block|{
name|unsigned
name|char
name|buffer
index|[
name|CUDBG_CHUNK_BUF_LEN
index|]
decl_stmt|;
name|int
name|byte_r
init|=
name|read_from_buf
argument_list|(
name|pc_buff
operator|->
name|data
argument_list|,
name|pc_buff
operator|->
name|size
argument_list|,
operator|&
name|pc_buff
operator|->
name|offset
argument_list|,
name|buffer
argument_list|,
literal|16
argument_list|)
decl_stmt|;
if|if
condition|(
name|byte_r
operator|==
literal|0
condition|)
return|return
literal|0
return|;
operator|*
name|pid
operator|=
name|readU16
argument_list|(
name|buffer
argument_list|)
operator|&
literal|0xffff
expr_stmt|;
operator|*
name|poptions
operator|=
name|readU16
argument_list|(
name|buffer
operator|+
literal|2
argument_list|)
operator|&
literal|0xffff
expr_stmt|;
operator|*
name|psize
operator|=
name|readU32
argument_list|(
name|buffer
operator|+
literal|4
argument_list|)
operator|&
literal|0xffffffff
expr_stmt|;
operator|*
name|pchecksum
operator|=
name|readU32
argument_list|(
name|buffer
operator|+
literal|8
argument_list|)
operator|&
literal|0xffffffff
expr_stmt|;
operator|*
name|pextra
operator|=
name|readU32
argument_list|(
name|buffer
operator|+
literal|12
argument_list|)
operator|&
literal|0xffffffff
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|validate_buffer
parameter_list|(
name|struct
name|cudbg_buffer
modifier|*
name|compressed_buffer
parameter_list|)
block|{
if|if
condition|(
operator|!
name|detect_magic
argument_list|(
name|compressed_buffer
argument_list|)
condition|)
return|return
name|CUDBG_STATUS_INVALID_BUFF
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|decompress_buffer
parameter_list|(
name|struct
name|cudbg_buffer
modifier|*
name|pc_buff
parameter_list|,
name|struct
name|cudbg_buffer
modifier|*
name|pd_buff
parameter_list|)
block|{
name|struct
name|cudbg_buffer
name|tmp_compressed_buffer
decl_stmt|;
name|struct
name|cudbg_buffer
name|tmp_decompressed_buffer
decl_stmt|;
name|unsigned
name|char
modifier|*
name|compressed_buffer
decl_stmt|;
name|unsigned
name|char
modifier|*
name|decompressed_buffer
decl_stmt|;
name|unsigned
name|char
name|buffer
index|[
name|CUDBG_MIN_COMPR_LEN
index|]
decl_stmt|;
name|unsigned
name|long
name|chunk_size
decl_stmt|;
name|unsigned
name|long
name|chunk_checksum
decl_stmt|;
name|unsigned
name|long
name|chunk_extra
decl_stmt|;
name|unsigned
name|long
name|checksum
decl_stmt|;
name|unsigned
name|long
name|total_extracted
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|r
decl_stmt|;
name|unsigned
name|long
name|remaining
decl_stmt|;
name|unsigned
name|long
name|bytes_read
decl_stmt|;
name|u32
name|decompressed_size
init|=
literal|0
decl_stmt|;
name|int
name|chunk_id
decl_stmt|,
name|chunk_options
decl_stmt|,
name|rc
decl_stmt|;
if|if
condition|(
name|pd_buff
operator|->
name|size
operator|<
literal|2
operator|*
name|CUDBG_BLOCK_SIZE
condition|)
return|return
name|CUDBG_STATUS_SMALL_BUFF
return|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|pd_buff
argument_list|,
name|CUDBG_BLOCK_SIZE
argument_list|,
operator|&
name|tmp_compressed_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err_cbuff
goto|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|pd_buff
argument_list|,
name|CUDBG_BLOCK_SIZE
argument_list|,
operator|&
name|tmp_decompressed_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err_dcbuff
goto|;
name|compressed_buffer
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|tmp_compressed_buffer
operator|.
name|data
expr_stmt|;
name|decompressed_buffer
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|tmp_decompressed_buffer
operator|.
name|data
expr_stmt|;
comment|/* main loop */
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|pc_buff
operator|->
name|offset
operator|>
name|pc_buff
operator|->
name|size
condition|)
break|break;
name|rc
operator|=
name|read_chunk_header
argument_list|(
name|pc_buff
argument_list|,
operator|&
name|chunk_id
argument_list|,
operator|&
name|chunk_options
argument_list|,
operator|&
name|chunk_size
argument_list|,
operator|&
name|chunk_checksum
argument_list|,
operator|&
name|chunk_extra
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
break|break;
comment|/* skip 8+16 */
if|if
condition|(
operator|(
name|chunk_id
operator|==
literal|1
operator|)
operator|&&
operator|(
name|chunk_size
operator|>
literal|10
operator|)
operator|&&
operator|(
name|chunk_size
operator|<
name|CUDBG_BLOCK_SIZE
operator|)
condition|)
block|{
name|bytes_read
operator|=
name|read_from_buf
argument_list|(
name|pc_buff
operator|->
name|data
argument_list|,
name|pc_buff
operator|->
name|size
argument_list|,
operator|&
name|pc_buff
operator|->
name|offset
argument_list|,
name|buffer
argument_list|,
name|chunk_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes_read
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|checksum
operator|=
name|update_adler32
argument_list|(
literal|1L
argument_list|,
name|buffer
argument_list|,
name|chunk_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|checksum
operator|!=
name|chunk_checksum
condition|)
return|return
name|CUDBG_STATUS_CHKSUM_MISSMATCH
return|;
name|decompressed_size
operator|=
operator|(
name|u32
operator|)
name|readU32
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd_buff
operator|->
name|size
operator|<
name|decompressed_size
condition|)
block|{
name|pd_buff
operator|->
name|size
operator|=
literal|2
operator|*
name|CUDBG_BLOCK_SIZE
operator|+
name|decompressed_size
expr_stmt|;
name|pc_buff
operator|->
name|offset
operator|-=
name|chunk_size
operator|+
literal|16
expr_stmt|;
return|return
name|CUDBG_STATUS_SMALL_BUFF
return|;
block|}
name|total_extracted
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|chunk_size
operator|>
name|CUDBG_BLOCK_SIZE
condition|)
block|{
comment|/* Release old allocated memory */
name|release_scratch_buff
argument_list|(
operator|&
name|tmp_decompressed_buffer
argument_list|,
name|pd_buff
argument_list|)
expr_stmt|;
name|release_scratch_buff
argument_list|(
operator|&
name|tmp_compressed_buffer
argument_list|,
name|pd_buff
argument_list|)
expr_stmt|;
comment|/* allocate new memory with chunk_size size */
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|pd_buff
argument_list|,
name|chunk_size
argument_list|,
operator|&
name|tmp_compressed_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err_cbuff
goto|;
name|rc
operator|=
name|get_scratch_buff
argument_list|(
name|pd_buff
argument_list|,
name|chunk_size
argument_list|,
operator|&
name|tmp_decompressed_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err_dcbuff
goto|;
name|compressed_buffer
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|tmp_compressed_buffer
operator|.
name|data
expr_stmt|;
name|decompressed_buffer
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|tmp_decompressed_buffer
operator|.
name|data
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|chunk_id
operator|==
literal|17
operator|)
operator|&&
name|decompressed_size
condition|)
block|{
comment|/* uncompressed */
switch|switch
condition|(
name|chunk_options
condition|)
block|{
comment|/* stored, simply copy to output */
case|case
literal|0
case|:
name|total_extracted
operator|+=
name|chunk_size
expr_stmt|;
name|remaining
operator|=
name|chunk_size
expr_stmt|;
name|checksum
operator|=
literal|1L
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* Write a funtion for this */
name|r
operator|=
operator|(
name|CUDBG_BLOCK_SIZE
operator|<
name|remaining
operator|)
condition|?
name|CUDBG_BLOCK_SIZE
else|:
name|remaining
expr_stmt|;
name|bytes_read
operator|=
name|read_from_buf
argument_list|(
name|pc_buff
operator|->
name|data
argument_list|,
name|pc_buff
operator|->
name|size
argument_list|,
operator|&
name|pc_buff
operator|->
name|offset
argument_list|,
name|buffer
argument_list|,
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes_read
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|write_to_buf
argument_list|(
name|pd_buff
operator|->
name|data
argument_list|,
name|pd_buff
operator|->
name|size
argument_list|,
operator|&
name|pd_buff
operator|->
name|offset
argument_list|,
name|buffer
argument_list|,
name|bytes_read
argument_list|)
expr_stmt|;
name|checksum
operator|=
name|update_adler32
argument_list|(
name|checksum
argument_list|,
name|buffer
argument_list|,
name|bytes_read
argument_list|)
expr_stmt|;
name|remaining
operator|-=
name|bytes_read
expr_stmt|;
comment|/* verify everything is written 					 * correctly */
if|if
condition|(
name|checksum
operator|!=
name|chunk_checksum
condition|)
return|return
name|CUDBG_STATUS_CHKSUM_MISSMATCH
return|;
block|}
break|break;
comment|/* compressed using FastLZ */
case|case
literal|1
case|:
name|bytes_read
operator|=
name|read_from_buf
argument_list|(
name|pc_buff
operator|->
name|data
argument_list|,
name|pc_buff
operator|->
name|size
argument_list|,
operator|&
name|pc_buff
operator|->
name|offset
argument_list|,
name|compressed_buffer
argument_list|,
name|chunk_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes_read
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|checksum
operator|=
name|update_adler32
argument_list|(
literal|1L
argument_list|,
name|compressed_buffer
argument_list|,
name|chunk_size
argument_list|)
expr_stmt|;
name|total_extracted
operator|+=
name|chunk_extra
expr_stmt|;
comment|/* verify that the chunk data is correct */
if|if
condition|(
name|checksum
operator|!=
name|chunk_checksum
condition|)
block|{
return|return
name|CUDBG_STATUS_CHKSUM_MISSMATCH
return|;
block|}
else|else
block|{
comment|/* decompress and verify */
name|remaining
operator|=
name|fastlz_decompress
argument_list|(
name|compressed_buffer
argument_list|,
name|chunk_size
argument_list|,
name|decompressed_buffer
argument_list|,
name|chunk_extra
argument_list|)
expr_stmt|;
if|if
condition|(
name|remaining
operator|!=
name|chunk_extra
condition|)
block|{
name|rc
operator|=
name|CUDBG_STATUS_DECOMPRESS_FAIL
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|write_to_buf
argument_list|(
name|pd_buff
operator|->
name|data
argument_list|,
name|pd_buff
operator|->
name|size
argument_list|,
operator|&
name|pd_buff
operator|->
name|offset
argument_list|,
name|decompressed_buffer
argument_list|,
name|chunk_extra
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
break|break;
block|}
block|}
block|}
name|err
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|tmp_decompressed_buffer
argument_list|,
name|pd_buff
argument_list|)
expr_stmt|;
name|err_dcbuff
label|:
name|release_scratch_buff
argument_list|(
operator|&
name|tmp_compressed_buffer
argument_list|,
name|pd_buff
argument_list|)
expr_stmt|;
name|err_cbuff
label|:
return|return
name|rc
return|;
block|}
end_function

end_unit


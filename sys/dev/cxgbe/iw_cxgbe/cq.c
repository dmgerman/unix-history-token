begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2009-2013 Chelsio, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *	  copyright notice, this list of conditions and the following  *	  disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *	  copyright notice, this list of conditions and the following  *	  disclaimer in the documentation and/or other materials  *	  provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TCP_OFFLOAD
end_ifdef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/ktr.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sbuf.h>
end_include

begin_include
include|#
directive|include
file|"iw_cxgbe.h"
end_include

begin_include
include|#
directive|include
file|"user.h"
end_include

begin_function
specifier|static
name|int
name|destroy_cq
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|c4iw_dev_ucontext
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|sc
init|=
name|rdev
operator|->
name|adap
decl_stmt|;
name|struct
name|fw_ri_res_wr
modifier|*
name|res_wr
decl_stmt|;
name|struct
name|fw_ri_res
modifier|*
name|res
decl_stmt|;
name|int
name|wr_len
decl_stmt|;
name|struct
name|c4iw_wr_wait
name|wr_wait
decl_stmt|;
name|struct
name|wrqe
modifier|*
name|wr
decl_stmt|;
name|wr_len
operator|=
sizeof|sizeof
expr|*
name|res_wr
operator|+
sizeof|sizeof
expr|*
name|res
expr_stmt|;
name|wr
operator|=
name|alloc_wrqe
argument_list|(
name|wr_len
argument_list|,
operator|&
name|sc
operator|->
name|sge
operator|.
name|mgmtq
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|res_wr
operator|=
name|wrtod
argument_list|(
name|wr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|res_wr
argument_list|,
literal|0
argument_list|,
name|wr_len
argument_list|)
expr_stmt|;
name|res_wr
operator|->
name|op_nres
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_OP
argument_list|(
name|FW_RI_RES_WR
argument_list|)
operator||
name|V_FW_RI_RES_WR_NRES
argument_list|(
literal|1
argument_list|)
operator||
name|F_FW_WR_COMPL
argument_list|)
expr_stmt|;
name|res_wr
operator|->
name|len16_pkd
operator|=
name|cpu_to_be32
argument_list|(
name|DIV_ROUND_UP
argument_list|(
name|wr_len
argument_list|,
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|res_wr
operator|->
name|cookie
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|&
name|wr_wait
expr_stmt|;
name|res
operator|=
name|res_wr
operator|->
name|res
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|cq
operator|.
name|restype
operator|=
name|FW_RI_RES_TYPE_CQ
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|cq
operator|.
name|op
operator|=
name|FW_RI_RES_OP_RESET
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|cq
operator|.
name|iqid
operator|=
name|cpu_to_be32
argument_list|(
name|cq
operator|->
name|cqid
argument_list|)
expr_stmt|;
name|c4iw_init_wr_wait
argument_list|(
operator|&
name|wr_wait
argument_list|)
expr_stmt|;
name|t4_wrq_tx
argument_list|(
name|sc
argument_list|,
name|wr
argument_list|)
expr_stmt|;
name|c4iw_wait_for_reply
argument_list|(
name|rdev
argument_list|,
operator|&
name|wr_wait
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|cq
operator|->
name|sw_queue
argument_list|)
expr_stmt|;
name|contigfree
argument_list|(
name|cq
operator|->
name|queue
argument_list|,
name|cq
operator|->
name|memsize
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|c4iw_put_cqid
argument_list|(
name|rdev
argument_list|,
name|cq
operator|->
name|cqid
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|create_cq
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|c4iw_dev_ucontext
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|sc
init|=
name|rdev
operator|->
name|adap
decl_stmt|;
name|struct
name|fw_ri_res_wr
modifier|*
name|res_wr
decl_stmt|;
name|struct
name|fw_ri_res
modifier|*
name|res
decl_stmt|;
name|int
name|wr_len
decl_stmt|;
name|int
name|user
init|=
operator|(
name|uctx
operator|!=
operator|&
name|rdev
operator|->
name|uctx
operator|)
decl_stmt|;
name|struct
name|c4iw_wr_wait
name|wr_wait
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|wrqe
modifier|*
name|wr
decl_stmt|;
name|cq
operator|->
name|cqid
operator|=
name|c4iw_get_cqid
argument_list|(
name|rdev
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cq
operator|->
name|cqid
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
if|if
condition|(
operator|!
name|user
condition|)
block|{
name|cq
operator|->
name|sw_queue
operator|=
name|kzalloc
argument_list|(
name|cq
operator|->
name|memsize
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cq
operator|->
name|sw_queue
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
block|}
name|cq
operator|->
name|queue
operator|=
name|contigmalloc
argument_list|(
name|cq
operator|->
name|memsize
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
literal|0ul
argument_list|,
operator|~
literal|0ul
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cq
operator|->
name|queue
condition|)
name|cq
operator|->
name|dma_addr
operator|=
name|vtophys
argument_list|(
name|cq
operator|->
name|queue
argument_list|)
expr_stmt|;
else|else
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|pci_unmap_addr_set
argument_list|(
name|cq
argument_list|,
name|mapping
argument_list|,
name|cq
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|cq
operator|->
name|queue
argument_list|,
literal|0
argument_list|,
name|cq
operator|->
name|memsize
argument_list|)
expr_stmt|;
comment|/* build fw_ri_res_wr */
name|wr_len
operator|=
sizeof|sizeof
expr|*
name|res_wr
operator|+
sizeof|sizeof
expr|*
name|res
expr_stmt|;
name|wr
operator|=
name|alloc_wrqe
argument_list|(
name|wr_len
argument_list|,
operator|&
name|sc
operator|->
name|sge
operator|.
name|mgmtq
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|res_wr
operator|=
name|wrtod
argument_list|(
name|wr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|res_wr
argument_list|,
literal|0
argument_list|,
name|wr_len
argument_list|)
expr_stmt|;
name|res_wr
operator|->
name|op_nres
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_OP
argument_list|(
name|FW_RI_RES_WR
argument_list|)
operator||
name|V_FW_RI_RES_WR_NRES
argument_list|(
literal|1
argument_list|)
operator||
name|F_FW_WR_COMPL
argument_list|)
expr_stmt|;
name|res_wr
operator|->
name|len16_pkd
operator|=
name|cpu_to_be32
argument_list|(
name|DIV_ROUND_UP
argument_list|(
name|wr_len
argument_list|,
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|res_wr
operator|->
name|cookie
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|&
name|wr_wait
expr_stmt|;
name|res
operator|=
name|res_wr
operator|->
name|res
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|cq
operator|.
name|restype
operator|=
name|FW_RI_RES_TYPE_CQ
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|cq
operator|.
name|op
operator|=
name|FW_RI_RES_OP_WRITE
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|cq
operator|.
name|iqid
operator|=
name|cpu_to_be32
argument_list|(
name|cq
operator|->
name|cqid
argument_list|)
expr_stmt|;
comment|//Fixme: Always use first queue id for IQANDSTINDEX. Linux does the same.
name|res
operator|->
name|u
operator|.
name|cq
operator|.
name|iqandst_to_iqandstindex
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_RI_RES_WR_IQANUS
argument_list|(
literal|0
argument_list|)
operator||
name|V_FW_RI_RES_WR_IQANUD
argument_list|(
literal|1
argument_list|)
operator||
name|F_FW_RI_RES_WR_IQANDST
operator||
name|V_FW_RI_RES_WR_IQANDSTINDEX
argument_list|(
name|sc
operator|->
name|sge
operator|.
name|ofld_rxq
index|[
literal|0
index|]
operator|.
name|iq
operator|.
name|abs_id
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|cq
operator|.
name|iqdroprss_to_iqesize
operator|=
name|cpu_to_be16
argument_list|(
name|F_FW_RI_RES_WR_IQDROPRSS
operator||
name|V_FW_RI_RES_WR_IQPCIECH
argument_list|(
literal|2
argument_list|)
operator||
name|V_FW_RI_RES_WR_IQINTCNTTHRESH
argument_list|(
literal|0
argument_list|)
operator||
name|F_FW_RI_RES_WR_IQO
operator||
name|V_FW_RI_RES_WR_IQESIZE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|cq
operator|.
name|iqsize
operator|=
name|cpu_to_be16
argument_list|(
name|cq
operator|->
name|size
argument_list|)
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|cq
operator|.
name|iqaddr
operator|=
name|cpu_to_be64
argument_list|(
name|cq
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
name|c4iw_init_wr_wait
argument_list|(
operator|&
name|wr_wait
argument_list|)
expr_stmt|;
name|t4_wrq_tx
argument_list|(
name|sc
argument_list|,
name|wr
argument_list|)
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s wait_event wr_wait %p"
argument_list|,
name|__func__
argument_list|,
operator|&
name|wr_wait
argument_list|)
expr_stmt|;
name|ret
operator|=
name|c4iw_wait_for_reply
argument_list|(
name|rdev
argument_list|,
operator|&
name|wr_wait
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err4
goto|;
name|cq
operator|->
name|gen
operator|=
literal|1
expr_stmt|;
name|cq
operator|->
name|gts
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|rman_get_virtual
argument_list|(
name|sc
operator|->
name|regs_res
argument_list|)
operator|+
name|sc
operator|->
name|sge_gts_reg
operator|)
expr_stmt|;
name|cq
operator|->
name|rdev
operator|=
name|rdev
expr_stmt|;
if|if
condition|(
name|user
condition|)
block|{
name|cq
operator|->
name|ugts
operator|=
call|(
name|u64
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|rman_get_virtual
argument_list|(
name|sc
operator|->
name|udbs_res
argument_list|)
operator|+
operator|(
name|cq
operator|->
name|cqid
operator|<<
name|rdev
operator|->
name|cqshift
operator|)
argument_list|)
expr_stmt|;
name|cq
operator|->
name|ugts
operator|&=
name|PAGE_MASK
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s: UGTS %p cqid %x cqshift %d page_mask %x"
argument_list|,
name|__func__
argument_list|,
name|cq
operator|->
name|ugts
argument_list|,
name|cq
operator|->
name|cqid
argument_list|,
name|rdev
operator|->
name|cqshift
argument_list|,
name|PAGE_MASK
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
name|err4
label|:
name|contigfree
argument_list|(
name|cq
operator|->
name|queue
argument_list|,
name|cq
operator|->
name|memsize
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|err3
label|:
name|kfree
argument_list|(
name|cq
operator|->
name|sw_queue
argument_list|)
expr_stmt|;
name|err2
label|:
name|c4iw_put_cqid
argument_list|(
name|rdev
argument_list|,
name|cq
operator|->
name|cqid
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
name|err1
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|insert_recv_cqe
parameter_list|(
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|)
block|{
name|struct
name|t4_cqe
name|cqe
decl_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s wq %p cq %p sw_cidx %u sw_pidx %u"
argument_list|,
name|__func__
argument_list|,
name|wq
argument_list|,
name|cq
argument_list|,
name|cq
operator|->
name|sw_cidx
argument_list|,
name|cq
operator|->
name|sw_pidx
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|cqe
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|cqe
operator|.
name|header
operator|=
name|cpu_to_be32
argument_list|(
name|V_CQE_STATUS
argument_list|(
name|T4_ERR_SWFLUSH
argument_list|)
operator||
name|V_CQE_OPCODE
argument_list|(
name|FW_RI_SEND
argument_list|)
operator||
name|V_CQE_TYPE
argument_list|(
literal|0
argument_list|)
operator||
name|V_CQE_SWCQE
argument_list|(
literal|1
argument_list|)
operator||
name|V_CQE_QPID
argument_list|(
name|wq
operator|->
name|sq
operator|.
name|qid
argument_list|)
argument_list|)
expr_stmt|;
name|cqe
operator|.
name|bits_type_ts
operator|=
name|cpu_to_be64
argument_list|(
name|V_CQE_GENBIT
argument_list|(
operator|(
name|u64
operator|)
name|cq
operator|->
name|gen
argument_list|)
argument_list|)
expr_stmt|;
name|cq
operator|->
name|sw_queue
index|[
name|cq
operator|->
name|sw_pidx
index|]
operator|=
name|cqe
expr_stmt|;
name|t4_swcq_produce
argument_list|(
name|cq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|c4iw_flush_rq
parameter_list|(
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|int
name|flushed
init|=
literal|0
decl_stmt|;
name|int
name|in_use
init|=
name|wq
operator|->
name|rq
operator|.
name|in_use
operator|-
name|count
decl_stmt|;
name|BUG_ON
argument_list|(
name|in_use
operator|<
literal|0
argument_list|)
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s wq %p cq %p rq.in_use %u skip count %u"
argument_list|,
name|__func__
argument_list|,
name|wq
argument_list|,
name|cq
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|in_use
argument_list|,
name|count
argument_list|)
expr_stmt|;
while|while
condition|(
name|in_use
operator|--
condition|)
block|{
name|insert_recv_cqe
argument_list|(
name|wq
argument_list|,
name|cq
argument_list|)
expr_stmt|;
name|flushed
operator|++
expr_stmt|;
block|}
return|return
name|flushed
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|insert_sq_cqe
parameter_list|(
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|t4_swsqe
modifier|*
name|swcqe
parameter_list|)
block|{
name|struct
name|t4_cqe
name|cqe
decl_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s wq %p cq %p sw_cidx %u sw_pidx %u"
argument_list|,
name|__func__
argument_list|,
name|wq
argument_list|,
name|cq
argument_list|,
name|cq
operator|->
name|sw_cidx
argument_list|,
name|cq
operator|->
name|sw_pidx
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|cqe
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|cqe
operator|.
name|header
operator|=
name|cpu_to_be32
argument_list|(
name|V_CQE_STATUS
argument_list|(
name|T4_ERR_SWFLUSH
argument_list|)
operator||
name|V_CQE_OPCODE
argument_list|(
name|swcqe
operator|->
name|opcode
argument_list|)
operator||
name|V_CQE_TYPE
argument_list|(
literal|1
argument_list|)
operator||
name|V_CQE_SWCQE
argument_list|(
literal|1
argument_list|)
operator||
name|V_CQE_QPID
argument_list|(
name|wq
operator|->
name|sq
operator|.
name|qid
argument_list|)
argument_list|)
expr_stmt|;
name|CQE_WRID_SQ_IDX
argument_list|(
operator|&
name|cqe
argument_list|)
operator|=
name|swcqe
operator|->
name|idx
expr_stmt|;
name|cqe
operator|.
name|bits_type_ts
operator|=
name|cpu_to_be64
argument_list|(
name|V_CQE_GENBIT
argument_list|(
operator|(
name|u64
operator|)
name|cq
operator|->
name|gen
argument_list|)
argument_list|)
expr_stmt|;
name|cq
operator|->
name|sw_queue
index|[
name|cq
operator|->
name|sw_pidx
index|]
operator|=
name|cqe
expr_stmt|;
name|t4_swcq_produce
argument_list|(
name|cq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|c4iw_flush_sq
parameter_list|(
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|int
name|flushed
init|=
literal|0
decl_stmt|;
name|struct
name|t4_swsqe
modifier|*
name|swsqe
init|=
operator|&
name|wq
operator|->
name|sq
operator|.
name|sw_sq
index|[
name|wq
operator|->
name|sq
operator|.
name|cidx
operator|+
name|count
index|]
decl_stmt|;
name|int
name|in_use
init|=
name|wq
operator|->
name|sq
operator|.
name|in_use
operator|-
name|count
decl_stmt|;
name|BUG_ON
argument_list|(
name|in_use
operator|<
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|in_use
operator|--
condition|)
block|{
name|swsqe
operator|->
name|signaled
operator|=
literal|0
expr_stmt|;
name|insert_sq_cqe
argument_list|(
name|wq
argument_list|,
name|cq
argument_list|,
name|swsqe
argument_list|)
expr_stmt|;
name|swsqe
operator|++
expr_stmt|;
if|if
condition|(
name|swsqe
operator|==
operator|(
name|wq
operator|->
name|sq
operator|.
name|sw_sq
operator|+
name|wq
operator|->
name|sq
operator|.
name|size
operator|)
condition|)
name|swsqe
operator|=
name|wq
operator|->
name|sq
operator|.
name|sw_sq
expr_stmt|;
name|flushed
operator|++
expr_stmt|;
block|}
return|return
name|flushed
return|;
block|}
end_function

begin_comment
comment|/*  * Move all CQEs from the HWCQ into the SWCQ.  */
end_comment

begin_function
name|void
name|c4iw_flush_hw_cq
parameter_list|(
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|)
block|{
name|struct
name|t4_cqe
modifier|*
name|cqe
init|=
name|NULL
decl_stmt|,
modifier|*
name|swcqe
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s cq %p cqid 0x%x"
argument_list|,
name|__func__
argument_list|,
name|cq
argument_list|,
name|cq
operator|->
name|cqid
argument_list|)
expr_stmt|;
name|ret
operator|=
name|t4_next_hw_cqe
argument_list|(
name|cq
argument_list|,
operator|&
name|cqe
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|ret
condition|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s flushing hwcq cidx 0x%x swcq pidx 0x%x"
argument_list|,
name|__func__
argument_list|,
name|cq
operator|->
name|cidx
argument_list|,
name|cq
operator|->
name|sw_pidx
argument_list|)
expr_stmt|;
name|swcqe
operator|=
operator|&
name|cq
operator|->
name|sw_queue
index|[
name|cq
operator|->
name|sw_pidx
index|]
expr_stmt|;
operator|*
name|swcqe
operator|=
operator|*
name|cqe
expr_stmt|;
name|swcqe
operator|->
name|header
operator||=
name|cpu_to_be32
argument_list|(
name|V_CQE_SWCQE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|t4_swcq_produce
argument_list|(
name|cq
argument_list|)
expr_stmt|;
name|t4_hwcq_consume
argument_list|(
name|cq
argument_list|)
expr_stmt|;
name|ret
operator|=
name|t4_next_hw_cqe
argument_list|(
name|cq
argument_list|,
operator|&
name|cqe
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|cqe_completes_wr
parameter_list|(
name|struct
name|t4_cqe
modifier|*
name|cqe
parameter_list|,
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|)
block|{
if|if
condition|(
name|CQE_OPCODE
argument_list|(
name|cqe
argument_list|)
operator|==
name|FW_RI_TERMINATE
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|CQE_OPCODE
argument_list|(
name|cqe
argument_list|)
operator|==
name|FW_RI_RDMA_WRITE
operator|)
operator|&&
name|RQ_TYPE
argument_list|(
name|cqe
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|CQE_OPCODE
argument_list|(
name|cqe
argument_list|)
operator|==
name|FW_RI_READ_RESP
operator|)
operator|&&
name|SQ_TYPE
argument_list|(
name|cqe
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|CQE_SEND_OPCODE
argument_list|(
name|cqe
argument_list|)
operator|&&
name|RQ_TYPE
argument_list|(
name|cqe
argument_list|)
operator|&&
name|t4_rq_empty
argument_list|(
name|wq
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|c4iw_count_scqes
parameter_list|(
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|int
modifier|*
name|count
parameter_list|)
block|{
name|struct
name|t4_cqe
modifier|*
name|cqe
decl_stmt|;
name|u32
name|ptr
decl_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
name|cq
operator|->
name|sw_cidx
expr_stmt|;
while|while
condition|(
name|ptr
operator|!=
name|cq
operator|->
name|sw_pidx
condition|)
block|{
name|cqe
operator|=
operator|&
name|cq
operator|->
name|sw_queue
index|[
name|ptr
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|SQ_TYPE
argument_list|(
name|cqe
argument_list|)
operator|||
operator|(
operator|(
name|CQE_OPCODE
argument_list|(
name|cqe
argument_list|)
operator|==
name|FW_RI_READ_RESP
operator|)
operator|&&
name|wq
operator|->
name|sq
operator|.
name|oldest_read
operator|)
operator|)
operator|&&
operator|(
name|CQE_QPID
argument_list|(
name|cqe
argument_list|)
operator|==
name|wq
operator|->
name|sq
operator|.
name|qid
operator|)
condition|)
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|++
name|ptr
operator|==
name|cq
operator|->
name|size
condition|)
name|ptr
operator|=
literal|0
expr_stmt|;
block|}
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s cq %p count %d"
argument_list|,
name|__func__
argument_list|,
name|cq
argument_list|,
operator|*
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|c4iw_count_rcqes
parameter_list|(
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|int
modifier|*
name|count
parameter_list|)
block|{
name|struct
name|t4_cqe
modifier|*
name|cqe
decl_stmt|;
name|u32
name|ptr
decl_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s count zero %d"
argument_list|,
name|__func__
argument_list|,
operator|*
name|count
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|cq
operator|->
name|sw_cidx
expr_stmt|;
while|while
condition|(
name|ptr
operator|!=
name|cq
operator|->
name|sw_pidx
condition|)
block|{
name|cqe
operator|=
operator|&
name|cq
operator|->
name|sw_queue
index|[
name|ptr
index|]
expr_stmt|;
if|if
condition|(
name|RQ_TYPE
argument_list|(
name|cqe
argument_list|)
operator|&&
operator|(
name|CQE_OPCODE
argument_list|(
name|cqe
argument_list|)
operator|!=
name|FW_RI_READ_RESP
operator|)
operator|&&
operator|(
name|CQE_QPID
argument_list|(
name|cqe
argument_list|)
operator|==
name|wq
operator|->
name|sq
operator|.
name|qid
operator|)
operator|&&
name|cqe_completes_wr
argument_list|(
name|cqe
argument_list|,
name|wq
argument_list|)
condition|)
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|++
name|ptr
operator|==
name|cq
operator|->
name|size
condition|)
name|ptr
operator|=
literal|0
expr_stmt|;
block|}
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s cq %p count %d"
argument_list|,
name|__func__
argument_list|,
name|cq
argument_list|,
operator|*
name|count
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|flush_completed_wrs
parameter_list|(
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|)
block|{
name|struct
name|t4_swsqe
modifier|*
name|swsqe
decl_stmt|;
name|u16
name|ptr
init|=
name|wq
operator|->
name|sq
operator|.
name|cidx
decl_stmt|;
name|int
name|count
init|=
name|wq
operator|->
name|sq
operator|.
name|in_use
decl_stmt|;
name|int
name|unsignaled
init|=
literal|0
decl_stmt|;
name|swsqe
operator|=
operator|&
name|wq
operator|->
name|sq
operator|.
name|sw_sq
index|[
name|ptr
index|]
expr_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
if|if
condition|(
operator|!
name|swsqe
operator|->
name|signaled
condition|)
block|{
if|if
condition|(
operator|++
name|ptr
operator|==
name|wq
operator|->
name|sq
operator|.
name|size
condition|)
name|ptr
operator|=
literal|0
expr_stmt|;
name|swsqe
operator|=
operator|&
name|wq
operator|->
name|sq
operator|.
name|sw_sq
index|[
name|ptr
index|]
expr_stmt|;
name|unsignaled
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|swsqe
operator|->
name|complete
condition|)
block|{
comment|/* 			 * Insert this completed cqe into the swcq. 			 */
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s moving cqe into swcq sq idx %u cq idx %u"
argument_list|,
name|__func__
argument_list|,
name|ptr
argument_list|,
name|cq
operator|->
name|sw_pidx
argument_list|)
expr_stmt|;
name|swsqe
operator|->
name|cqe
operator|.
name|header
operator||=
name|htonl
argument_list|(
name|V_CQE_SWCQE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|cq
operator|->
name|sw_queue
index|[
name|cq
operator|->
name|sw_pidx
index|]
operator|=
name|swsqe
operator|->
name|cqe
expr_stmt|;
name|t4_swcq_produce
argument_list|(
name|cq
argument_list|)
expr_stmt|;
name|swsqe
operator|->
name|signaled
operator|=
literal|0
expr_stmt|;
name|wq
operator|->
name|sq
operator|.
name|in_use
operator|-=
name|unsignaled
expr_stmt|;
break|break;
block|}
else|else
break|break;
block|}
end_function

begin_function
specifier|static
name|void
name|create_read_req_cqe
parameter_list|(
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t4_cqe
modifier|*
name|hw_cqe
parameter_list|,
name|struct
name|t4_cqe
modifier|*
name|read_cqe
parameter_list|)
block|{
name|read_cqe
operator|->
name|u
operator|.
name|scqe
operator|.
name|cidx
operator|=
name|wq
operator|->
name|sq
operator|.
name|oldest_read
operator|->
name|idx
expr_stmt|;
name|read_cqe
operator|->
name|len
operator|=
name|cpu_to_be32
argument_list|(
name|wq
operator|->
name|sq
operator|.
name|oldest_read
operator|->
name|read_len
argument_list|)
expr_stmt|;
name|read_cqe
operator|->
name|header
operator|=
name|htonl
argument_list|(
name|V_CQE_QPID
argument_list|(
name|CQE_QPID
argument_list|(
name|hw_cqe
argument_list|)
argument_list|)
operator||
name|V_CQE_SWCQE
argument_list|(
name|SW_CQE
argument_list|(
name|hw_cqe
argument_list|)
argument_list|)
operator||
name|V_CQE_OPCODE
argument_list|(
name|FW_RI_READ_REQ
argument_list|)
operator||
name|V_CQE_TYPE
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|read_cqe
operator|->
name|bits_type_ts
operator|=
name|hw_cqe
operator|->
name|bits_type_ts
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Return a ptr to the next read wr in the SWSQ or NULL.  */
end_comment

begin_function
specifier|static
name|void
name|advance_oldest_read
parameter_list|(
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|)
block|{
name|u32
name|rptr
init|=
name|wq
operator|->
name|sq
operator|.
name|oldest_read
operator|-
name|wq
operator|->
name|sq
operator|.
name|sw_sq
operator|+
literal|1
decl_stmt|;
if|if
condition|(
name|rptr
operator|==
name|wq
operator|->
name|sq
operator|.
name|size
condition|)
name|rptr
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|rptr
operator|!=
name|wq
operator|->
name|sq
operator|.
name|pidx
condition|)
block|{
name|wq
operator|->
name|sq
operator|.
name|oldest_read
operator|=
operator|&
name|wq
operator|->
name|sq
operator|.
name|sw_sq
index|[
name|rptr
index|]
expr_stmt|;
if|if
condition|(
name|wq
operator|->
name|sq
operator|.
name|oldest_read
operator|->
name|opcode
operator|==
name|FW_RI_READ_REQ
condition|)
return|return;
if|if
condition|(
operator|++
name|rptr
operator|==
name|wq
operator|->
name|sq
operator|.
name|size
condition|)
name|rptr
operator|=
literal|0
expr_stmt|;
block|}
name|wq
operator|->
name|sq
operator|.
name|oldest_read
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * poll_cq  *  * Caller must:  *     check the validity of the first CQE,  *     supply the wq assicated with the qpid.  *  * credit: cq credit to return to sge.  * cqe_flushed: 1 iff the CQE is flushed.  * cqe: copy of the polled CQE.  *  * return value:  *    0		    CQE returned ok.  *    -EAGAIN       CQE skipped, try again.  *    -EOVERFLOW    CQ overflow detected.  */
end_comment

begin_function
specifier|static
name|int
name|poll_cq
parameter_list|(
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t4_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|t4_cqe
modifier|*
name|cqe
parameter_list|,
name|u8
modifier|*
name|cqe_flushed
parameter_list|,
name|u64
modifier|*
name|cookie
parameter_list|,
name|u32
modifier|*
name|credit
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|t4_cqe
modifier|*
name|hw_cqe
decl_stmt|,
name|read_cqe
decl_stmt|;
operator|*
name|cqe_flushed
operator|=
literal|0
expr_stmt|;
operator|*
name|credit
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|t4_next_cqe
argument_list|(
name|cq
argument_list|,
operator|&
name|hw_cqe
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|CTR6
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s CQE OVF %u qpid 0x%0x genbit %u type %u status 0x%0x"
argument_list|,
name|__func__
argument_list|,
name|CQE_OVFBIT
argument_list|(
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_QPID
argument_list|(
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_GENBIT
argument_list|(
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_TYPE
argument_list|(
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_STATUS
argument_list|(
name|hw_cqe
argument_list|)
argument_list|)
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s opcode 0x%0x len 0x%0x wrid_hi_stag 0x%x wrid_low_msn 0x%x"
argument_list|,
name|__func__
argument_list|,
name|CQE_OPCODE
argument_list|(
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_LEN
argument_list|(
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_WRID_HI
argument_list|(
name|hw_cqe
argument_list|)
argument_list|,
name|CQE_WRID_LOW
argument_list|(
name|hw_cqe
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * skip cqe's not affiliated with a QP. 	 */
if|if
condition|(
name|wq
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
name|EAGAIN
expr_stmt|;
goto|goto
name|skip_cqe
goto|;
block|}
comment|/* 	 * Special cqe for drain WR completions... 	 */
if|if
condition|(
name|CQE_OPCODE
argument_list|(
name|hw_cqe
argument_list|)
operator|==
name|C4IW_DRAIN_OPCODE
condition|)
block|{
operator|*
name|cookie
operator|=
name|CQE_DRAIN_COOKIE
argument_list|(
name|hw_cqe
argument_list|)
expr_stmt|;
operator|*
name|cqe
operator|=
operator|*
name|hw_cqe
expr_stmt|;
goto|goto
name|skip_cqe
goto|;
block|}
comment|/* 	 * Gotta tweak READ completions: 	 *	1) the cqe doesn't contain the sq_wptr from the wr. 	 *	2) opcode not reflected from the wr. 	 *	3) read_len not reflected from the wr. 	 *	4) cq_type is RQ_TYPE not SQ_TYPE. 	 */
if|if
condition|(
name|RQ_TYPE
argument_list|(
name|hw_cqe
argument_list|)
operator|&&
operator|(
name|CQE_OPCODE
argument_list|(
name|hw_cqe
argument_list|)
operator|==
name|FW_RI_READ_RESP
operator|)
condition|)
block|{
comment|/* 		 * If this is an unsolicited read response, then the read 		 * was generated by the kernel driver as part of peer-2-peer 		 * connection setup.  So ignore the completion. 		 */
if|if
condition|(
operator|!
name|wq
operator|->
name|sq
operator|.
name|oldest_read
condition|)
block|{
if|if
condition|(
name|CQE_STATUS
argument_list|(
name|hw_cqe
argument_list|)
condition|)
name|t4_set_wq_in_error
argument_list|(
name|wq
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EAGAIN
expr_stmt|;
goto|goto
name|skip_cqe
goto|;
block|}
comment|/* 		 * Don't write to the HWCQ, so create a new read req CQE 		 * in local memory. 		 */
name|create_read_req_cqe
argument_list|(
name|wq
argument_list|,
name|hw_cqe
argument_list|,
operator|&
name|read_cqe
argument_list|)
expr_stmt|;
name|hw_cqe
operator|=
operator|&
name|read_cqe
expr_stmt|;
name|advance_oldest_read
argument_list|(
name|wq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|CQE_STATUS
argument_list|(
name|hw_cqe
argument_list|)
operator|||
name|t4_wq_in_error
argument_list|(
name|wq
argument_list|)
condition|)
block|{
operator|*
name|cqe_flushed
operator|=
name|t4_wq_in_error
argument_list|(
name|wq
argument_list|)
expr_stmt|;
name|t4_set_wq_in_error
argument_list|(
name|wq
argument_list|)
expr_stmt|;
goto|goto
name|proc_cqe
goto|;
block|}
if|if
condition|(
name|CQE_OPCODE
argument_list|(
name|hw_cqe
argument_list|)
operator|==
name|FW_RI_TERMINATE
condition|)
block|{
name|ret
operator|=
operator|-
name|EAGAIN
expr_stmt|;
goto|goto
name|skip_cqe
goto|;
block|}
comment|/* 	 * RECV completion. 	 */
if|if
condition|(
name|RQ_TYPE
argument_list|(
name|hw_cqe
argument_list|)
condition|)
block|{
comment|/* 		 * HW only validates 4 bits of MSN.  So we must validate that 		 * the MSN in the SEND is the next expected MSN.  If its not, 		 * then we complete this with T4_ERR_MSN and mark the wq in 		 * error. 		 */
if|if
condition|(
name|t4_rq_empty
argument_list|(
name|wq
argument_list|)
condition|)
block|{
name|t4_set_wq_in_error
argument_list|(
name|wq
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EAGAIN
expr_stmt|;
goto|goto
name|skip_cqe
goto|;
block|}
if|if
condition|(
name|unlikely
argument_list|(
operator|(
name|CQE_WRID_MSN
argument_list|(
name|hw_cqe
argument_list|)
operator|!=
operator|(
name|wq
operator|->
name|rq
operator|.
name|msn
operator|)
operator|)
argument_list|)
condition|)
block|{
name|t4_set_wq_in_error
argument_list|(
name|wq
argument_list|)
expr_stmt|;
name|hw_cqe
operator|->
name|header
operator||=
name|htonl
argument_list|(
name|V_CQE_STATUS
argument_list|(
name|T4_ERR_MSN
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|proc_cqe
goto|;
block|}
goto|goto
name|proc_cqe
goto|;
block|}
comment|/* 	 * If we get here its a send completion. 	 * 	 * Handle out of order completion. These get stuffed 	 * in the SW SQ. Then the SW SQ is walked to move any 	 * now in-order completions into the SW CQ.  This handles 	 * 2 cases: 	 *	1) reaping unsignaled WRs when the first subsequent 	 *	   signaled WR is completed. 	 *	2) out of order read completions. 	 */
if|if
condition|(
operator|!
name|SW_CQE
argument_list|(
name|hw_cqe
argument_list|)
operator|&&
operator|(
name|CQE_WRID_SQ_IDX
argument_list|(
name|hw_cqe
argument_list|)
operator|!=
name|wq
operator|->
name|sq
operator|.
name|cidx
operator|)
condition|)
block|{
name|struct
name|t4_swsqe
modifier|*
name|swsqe
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s out of order completion going in sw_sq at idx %u"
argument_list|,
name|__func__
argument_list|,
name|CQE_WRID_SQ_IDX
argument_list|(
name|hw_cqe
argument_list|)
argument_list|)
expr_stmt|;
name|swsqe
operator|=
operator|&
name|wq
operator|->
name|sq
operator|.
name|sw_sq
index|[
name|CQE_WRID_SQ_IDX
argument_list|(
name|hw_cqe
argument_list|)
index|]
expr_stmt|;
name|swsqe
operator|->
name|cqe
operator|=
operator|*
name|hw_cqe
expr_stmt|;
name|swsqe
operator|->
name|complete
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
operator|-
name|EAGAIN
expr_stmt|;
goto|goto
name|flush_wq
goto|;
block|}
name|proc_cqe
label|:
operator|*
name|cqe
operator|=
operator|*
name|hw_cqe
expr_stmt|;
comment|/* 	 * Reap the associated WR(s) that are freed up with this 	 * completion. 	 */
if|if
condition|(
name|SQ_TYPE
argument_list|(
name|hw_cqe
argument_list|)
condition|)
block|{
name|wq
operator|->
name|sq
operator|.
name|cidx
operator|=
name|CQE_WRID_SQ_IDX
argument_list|(
name|hw_cqe
argument_list|)
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s completing sq idx %u"
argument_list|,
name|__func__
argument_list|,
name|wq
operator|->
name|sq
operator|.
name|cidx
argument_list|)
expr_stmt|;
operator|*
name|cookie
operator|=
name|wq
operator|->
name|sq
operator|.
name|sw_sq
index|[
name|wq
operator|->
name|sq
operator|.
name|cidx
index|]
operator|.
name|wr_id
expr_stmt|;
name|t4_sq_consume
argument_list|(
name|wq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s completing rq idx %u"
argument_list|,
name|__func__
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|cidx
argument_list|)
expr_stmt|;
operator|*
name|cookie
operator|=
name|wq
operator|->
name|rq
operator|.
name|sw_rq
index|[
name|wq
operator|->
name|rq
operator|.
name|cidx
index|]
operator|.
name|wr_id
expr_stmt|;
name|BUG_ON
argument_list|(
name|t4_rq_empty
argument_list|(
name|wq
argument_list|)
argument_list|)
expr_stmt|;
name|t4_rq_consume
argument_list|(
name|wq
argument_list|)
expr_stmt|;
block|}
name|flush_wq
label|:
comment|/* 	 * Flush any completed cqes that are now in-order. 	 */
name|flush_completed_wrs
argument_list|(
name|wq
argument_list|,
name|cq
argument_list|)
expr_stmt|;
name|skip_cqe
label|:
if|if
condition|(
name|SW_CQE
argument_list|(
name|hw_cqe
argument_list|)
condition|)
block|{
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s cq %p cqid 0x%x skip sw cqe cidx %u"
argument_list|,
name|__func__
argument_list|,
name|cq
argument_list|,
name|cq
operator|->
name|cqid
argument_list|,
name|cq
operator|->
name|sw_cidx
argument_list|)
expr_stmt|;
name|t4_swcq_consume
argument_list|(
name|cq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s cq %p cqid 0x%x skip hw cqe cidx %u"
argument_list|,
name|__func__
argument_list|,
name|cq
argument_list|,
name|cq
operator|->
name|cqid
argument_list|,
name|cq
operator|->
name|cidx
argument_list|)
expr_stmt|;
name|t4_hwcq_consume
argument_list|(
name|cq
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Get one cq entry from c4iw and map it to openib.  *  * Returns:  *	0			cqe returned  *	-ENODATA		EMPTY;  *	-EAGAIN			caller must try again  *	any other -errno	fatal error  */
end_comment

begin_function
specifier|static
name|int
name|c4iw_poll_cq_one
parameter_list|(
name|struct
name|c4iw_cq
modifier|*
name|chp
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|c4iw_qp
modifier|*
name|qhp
init|=
name|NULL
decl_stmt|;
name|struct
name|t4_cqe
name|cqe
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|,
modifier|*
name|rd_cqe
decl_stmt|;
name|struct
name|t4_wq
modifier|*
name|wq
decl_stmt|;
name|u32
name|credit
init|=
literal|0
decl_stmt|;
name|u8
name|cqe_flushed
decl_stmt|;
name|u64
name|cookie
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|t4_next_cqe
argument_list|(
operator|&
name|chp
operator|->
name|cq
argument_list|,
operator|&
name|rd_cqe
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|qhp
operator|=
name|get_qhp
argument_list|(
name|chp
operator|->
name|rhp
argument_list|,
name|CQE_QPID
argument_list|(
name|rd_cqe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
condition|)
name|wq
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|wq
operator|=
operator|&
operator|(
name|qhp
operator|->
name|wq
operator|)
expr_stmt|;
block|}
name|ret
operator|=
name|poll_cq
argument_list|(
name|wq
argument_list|,
operator|&
operator|(
name|chp
operator|->
name|cq
operator|)
argument_list|,
operator|&
name|cqe
argument_list|,
operator|&
name|cqe_flushed
argument_list|,
operator|&
name|cookie
argument_list|,
operator|&
name|credit
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|wc
operator|->
name|wr_id
operator|=
name|cookie
expr_stmt|;
name|wc
operator|->
name|qp
operator|=
operator|&
name|qhp
operator|->
name|ibqp
expr_stmt|;
name|wc
operator|->
name|vendor_err
operator|=
name|CQE_STATUS
argument_list|(
operator|&
name|cqe
argument_list|)
expr_stmt|;
name|wc
operator|->
name|wc_flags
operator|=
literal|0
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s qpid 0x%x type %d opcode %d status 0x%x"
argument_list|,
name|__func__
argument_list|,
name|CQE_QPID
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|,
name|CQE_TYPE
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|,
name|CQE_OPCODE
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|,
name|CQE_STATUS
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s len %u wrid hi 0x%x lo 0x%x cookie 0x%llx"
argument_list|,
name|__func__
argument_list|,
name|CQE_LEN
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|,
name|CQE_WRID_HI
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|,
name|CQE_WRID_LOW
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
name|CQE_TYPE
argument_list|(
operator|&
name|cqe
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|CQE_STATUS
argument_list|(
operator|&
name|cqe
argument_list|)
condition|)
name|wc
operator|->
name|byte_len
operator|=
name|CQE_LEN
argument_list|(
operator|&
name|cqe
argument_list|)
expr_stmt|;
else|else
name|wc
operator|->
name|byte_len
operator|=
literal|0
expr_stmt|;
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_RECV
expr_stmt|;
if|if
condition|(
name|CQE_OPCODE
argument_list|(
operator|&
name|cqe
argument_list|)
operator|==
name|FW_RI_SEND_WITH_INV
operator|||
name|CQE_OPCODE
argument_list|(
operator|&
name|cqe
argument_list|)
operator|==
name|FW_RI_SEND_WITH_SE_INV
condition|)
block|{
name|wc
operator|->
name|ex
operator|.
name|invalidate_rkey
operator|=
name|CQE_WRID_STAG
argument_list|(
operator|&
name|cqe
argument_list|)
expr_stmt|;
name|wc
operator|->
name|wc_flags
operator||=
name|IB_WC_WITH_INVALIDATE
expr_stmt|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|CQE_OPCODE
argument_list|(
operator|&
name|cqe
argument_list|)
condition|)
block|{
case|case
name|FW_RI_RDMA_WRITE
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_RDMA_WRITE
expr_stmt|;
break|break;
case|case
name|FW_RI_READ_REQ
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_RDMA_READ
expr_stmt|;
name|wc
operator|->
name|byte_len
operator|=
name|CQE_LEN
argument_list|(
operator|&
name|cqe
argument_list|)
expr_stmt|;
break|break;
case|case
name|FW_RI_SEND_WITH_INV
case|:
case|case
name|FW_RI_SEND_WITH_SE_INV
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_SEND
expr_stmt|;
name|wc
operator|->
name|wc_flags
operator||=
name|IB_WC_WITH_INVALIDATE
expr_stmt|;
break|break;
case|case
name|FW_RI_SEND
case|:
case|case
name|FW_RI_SEND_WITH_SE
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_SEND
expr_stmt|;
break|break;
case|case
name|FW_RI_BIND_MW
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_BIND_MW
expr_stmt|;
break|break;
case|case
name|FW_RI_LOCAL_INV
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_LOCAL_INV
expr_stmt|;
break|break;
case|case
name|FW_RI_FAST_REGISTER
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_FAST_REG_MR
expr_stmt|;
break|break;
case|case
name|C4IW_DRAIN_OPCODE
case|:
name|wc
operator|->
name|opcode
operator|=
name|IB_WC_SEND
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unexpected opcode %d "
literal|"in the CQE received for QPID = 0x%0x\n"
argument_list|,
name|CQE_OPCODE
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|,
name|CQE_QPID
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|cqe_flushed
condition|)
name|wc
operator|->
name|status
operator|=
name|IB_WC_WR_FLUSH_ERR
expr_stmt|;
else|else
block|{
switch|switch
condition|(
name|CQE_STATUS
argument_list|(
operator|&
name|cqe
argument_list|)
condition|)
block|{
case|case
name|T4_ERR_SUCCESS
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_SUCCESS
expr_stmt|;
break|break;
case|case
name|T4_ERR_STAG
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_LOC_ACCESS_ERR
expr_stmt|;
break|break;
case|case
name|T4_ERR_PDID
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_LOC_PROT_ERR
expr_stmt|;
break|break;
case|case
name|T4_ERR_QPID
case|:
case|case
name|T4_ERR_ACCESS
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_LOC_ACCESS_ERR
expr_stmt|;
break|break;
case|case
name|T4_ERR_WRAP
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_GENERAL_ERR
expr_stmt|;
break|break;
case|case
name|T4_ERR_BOUND
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_LOC_LEN_ERR
expr_stmt|;
break|break;
case|case
name|T4_ERR_INVALIDATE_SHARED_MR
case|:
case|case
name|T4_ERR_INVALIDATE_MR_WITH_MW_BOUND
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_MW_BIND_ERR
expr_stmt|;
break|break;
case|case
name|T4_ERR_CRC
case|:
case|case
name|T4_ERR_MARKER
case|:
case|case
name|T4_ERR_PDU_LEN_ERR
case|:
case|case
name|T4_ERR_OUT_OF_RQE
case|:
case|case
name|T4_ERR_DDP_VERSION
case|:
case|case
name|T4_ERR_RDMA_VERSION
case|:
case|case
name|T4_ERR_DDP_QUEUE_NUM
case|:
case|case
name|T4_ERR_MSN
case|:
case|case
name|T4_ERR_TBIT
case|:
case|case
name|T4_ERR_MO
case|:
case|case
name|T4_ERR_MSN_RANGE
case|:
case|case
name|T4_ERR_IRD_OVERFLOW
case|:
case|case
name|T4_ERR_OPCODE
case|:
case|case
name|T4_ERR_INTERNAL_ERR
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_FATAL_ERR
expr_stmt|;
break|break;
case|case
name|T4_ERR_SWFLUSH
case|:
name|wc
operator|->
name|status
operator|=
name|IB_WC_WR_FLUSH_ERR
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unexpected cqe_status 0x%x for QPID = 0x%0x\n"
argument_list|,
name|CQE_STATUS
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|,
name|CQE_QPID
argument_list|(
operator|&
name|cqe
argument_list|)
argument_list|)
expr_stmt|;
name|wc
operator|->
name|status
operator|=
name|IB_WC_FATAL_ERR
expr_stmt|;
block|}
block|}
name|out
label|:
if|if
condition|(
name|wq
condition|)
name|spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|c4iw_poll_cq
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|ibcq
parameter_list|,
name|int
name|num_entries
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|c4iw_cq
modifier|*
name|chp
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|npolled
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|chp
operator|=
name|to_c4iw_cq
argument_list|(
name|ibcq
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
for|for
control|(
name|npolled
operator|=
literal|0
init|;
name|npolled
operator|<
name|num_entries
condition|;
operator|++
name|npolled
control|)
block|{
do|do
block|{
name|err
operator|=
name|c4iw_poll_cq_one
argument_list|(
name|chp
argument_list|,
name|wc
operator|+
name|npolled
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|err
operator|==
operator|-
name|EAGAIN
condition|)
do|;
if|if
condition|(
name|err
condition|)
break|break;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
operator|!
name|err
operator|||
name|err
operator|==
operator|-
name|ENODATA
condition|?
name|npolled
else|:
name|err
return|;
block|}
end_function

begin_function
name|int
name|c4iw_destroy_cq
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|ib_cq
parameter_list|)
block|{
name|struct
name|c4iw_cq
modifier|*
name|chp
decl_stmt|;
name|struct
name|c4iw_ucontext
modifier|*
name|ucontext
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_cq %p"
argument_list|,
name|__func__
argument_list|,
name|ib_cq
argument_list|)
expr_stmt|;
name|chp
operator|=
name|to_c4iw_cq
argument_list|(
name|ib_cq
argument_list|)
expr_stmt|;
name|remove_handle
argument_list|(
name|chp
operator|->
name|rhp
argument_list|,
operator|&
name|chp
operator|->
name|rhp
operator|->
name|cqidr
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|)
expr_stmt|;
name|atomic_dec
argument_list|(
operator|&
name|chp
operator|->
name|refcnt
argument_list|)
expr_stmt|;
name|wait_event
argument_list|(
name|chp
operator|->
name|wait
argument_list|,
operator|!
name|atomic_read
argument_list|(
operator|&
name|chp
operator|->
name|refcnt
argument_list|)
argument_list|)
expr_stmt|;
name|ucontext
operator|=
name|ib_cq
operator|->
name|uobject
condition|?
name|to_c4iw_ucontext
argument_list|(
name|ib_cq
operator|->
name|uobject
operator|->
name|context
argument_list|)
else|:
name|NULL
expr_stmt|;
name|destroy_cq
argument_list|(
operator|&
name|chp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|chp
operator|->
name|cq
argument_list|,
name|ucontext
condition|?
operator|&
name|ucontext
operator|->
name|uctx
else|:
operator|&
name|chp
operator|->
name|cq
operator|.
name|rdev
operator|->
name|uctx
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|chp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ib_cq
modifier|*
name|c4iw_create_cq
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|int
name|entries
parameter_list|,
name|int
name|vector
parameter_list|,
name|struct
name|ib_ucontext
modifier|*
name|ib_context
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|c4iw_cq
modifier|*
name|chp
decl_stmt|;
name|struct
name|c4iw_create_cq_resp
name|uresp
decl_stmt|;
name|struct
name|c4iw_ucontext
modifier|*
name|ucontext
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|size_t
name|memsize
decl_stmt|,
name|hwentries
decl_stmt|;
name|struct
name|c4iw_mm_entry
modifier|*
name|mm
decl_stmt|,
modifier|*
name|mm2
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_dev %p entries %d"
argument_list|,
name|__func__
argument_list|,
name|ibdev
argument_list|,
name|entries
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|to_c4iw_dev
argument_list|(
name|ibdev
argument_list|)
expr_stmt|;
name|chp
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|chp
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|chp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
if|if
condition|(
name|ib_context
condition|)
name|ucontext
operator|=
name|to_c4iw_ucontext
argument_list|(
name|ib_context
argument_list|)
expr_stmt|;
comment|/* account for the status page. */
name|entries
operator|++
expr_stmt|;
comment|/* IQ needs one extra entry to differentiate full vs empty. */
name|entries
operator|++
expr_stmt|;
comment|/* 	 * entries must be multiple of 16 for HW. 	 */
name|entries
operator|=
name|roundup
argument_list|(
name|entries
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* 	 * Make actual HW queue 2x to avoid cidx_inc overflows. 	 */
name|hwentries
operator|=
name|entries
operator|*
literal|2
expr_stmt|;
comment|/* 	 * Make HW queue at least 64 entries so GTS updates aren't too 	 * frequent. 	 */
if|if
condition|(
name|hwentries
operator|<
literal|64
condition|)
name|hwentries
operator|=
literal|64
expr_stmt|;
name|memsize
operator|=
name|hwentries
operator|*
sizeof|sizeof
expr|*
name|chp
operator|->
name|cq
operator|.
name|queue
expr_stmt|;
comment|/* 	 * memsize must be a multiple of the page size if its a user cq. 	 */
if|if
condition|(
name|ucontext
condition|)
block|{
name|memsize
operator|=
name|roundup
argument_list|(
name|memsize
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|hwentries
operator|=
name|memsize
operator|/
sizeof|sizeof
expr|*
name|chp
operator|->
name|cq
operator|.
name|queue
expr_stmt|;
while|while
condition|(
name|hwentries
operator|>
name|T4_MAX_IQ_SIZE
condition|)
block|{
name|memsize
operator|-=
name|PAGE_SIZE
expr_stmt|;
name|hwentries
operator|=
name|memsize
operator|/
sizeof|sizeof
expr|*
name|chp
operator|->
name|cq
operator|.
name|queue
expr_stmt|;
block|}
block|}
name|chp
operator|->
name|cq
operator|.
name|size
operator|=
name|hwentries
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|memsize
operator|=
name|memsize
expr_stmt|;
name|ret
operator|=
name|create_cq
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|chp
operator|->
name|cq
argument_list|,
name|ucontext
condition|?
operator|&
name|ucontext
operator|->
name|uctx
else|:
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|uctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err1
goto|;
name|chp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|size
operator|--
expr_stmt|;
comment|/* status page */
name|chp
operator|->
name|ibcq
operator|.
name|cqe
operator|=
name|entries
operator|-
literal|2
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|chp
operator|->
name|comp_handler_lock
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|chp
operator|->
name|refcnt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|init_waitqueue_head
argument_list|(
operator|&
name|chp
operator|->
name|wait
argument_list|)
expr_stmt|;
name|ret
operator|=
name|insert_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|cqidr
argument_list|,
name|chp
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err2
goto|;
if|if
condition|(
name|ucontext
condition|)
block|{
name|mm
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mm
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm
condition|)
goto|goto
name|err3
goto|;
name|mm2
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mm2
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm2
condition|)
goto|goto
name|err4
goto|;
name|memset
argument_list|(
operator|&
name|uresp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|uresp
argument_list|)
argument_list|)
expr_stmt|;
name|uresp
operator|.
name|qid_mask
operator|=
name|rhp
operator|->
name|rdev
operator|.
name|cqmask
expr_stmt|;
name|uresp
operator|.
name|cqid
operator|=
name|chp
operator|->
name|cq
operator|.
name|cqid
expr_stmt|;
name|uresp
operator|.
name|size
operator|=
name|chp
operator|->
name|cq
operator|.
name|size
expr_stmt|;
name|uresp
operator|.
name|memsize
operator|=
name|chp
operator|->
name|cq
operator|.
name|memsize
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|ucontext
operator|->
name|mmap_lock
argument_list|)
expr_stmt|;
name|uresp
operator|.
name|key
operator|=
name|ucontext
operator|->
name|key
expr_stmt|;
name|ucontext
operator|->
name|key
operator|+=
name|PAGE_SIZE
expr_stmt|;
name|uresp
operator|.
name|gts_key
operator|=
name|ucontext
operator|->
name|key
expr_stmt|;
name|ucontext
operator|->
name|key
operator|+=
name|PAGE_SIZE
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|ucontext
operator|->
name|mmap_lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|uresp
argument_list|,
sizeof|sizeof
argument_list|(
name|uresp
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|uresp
operator|.
name|reserved
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err5
goto|;
name|mm
operator|->
name|key
operator|=
name|uresp
operator|.
name|key
expr_stmt|;
name|mm
operator|->
name|addr
operator|=
name|vtophys
argument_list|(
name|chp
operator|->
name|cq
operator|.
name|queue
argument_list|)
expr_stmt|;
name|mm
operator|->
name|len
operator|=
name|chp
operator|->
name|cq
operator|.
name|memsize
expr_stmt|;
name|insert_mmap
argument_list|(
name|ucontext
argument_list|,
name|mm
argument_list|)
expr_stmt|;
name|mm2
operator|->
name|key
operator|=
name|uresp
operator|.
name|gts_key
expr_stmt|;
name|mm2
operator|->
name|addr
operator|=
name|chp
operator|->
name|cq
operator|.
name|ugts
expr_stmt|;
name|mm2
operator|->
name|len
operator|=
name|PAGE_SIZE
expr_stmt|;
name|insert_mmap
argument_list|(
name|ucontext
argument_list|,
name|mm2
argument_list|)
expr_stmt|;
block|}
name|CTR6
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s cqid 0x%0x chp %p size %u memsize %zu, dma_addr 0x%0llx"
argument_list|,
name|__func__
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|,
name|chp
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|size
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|memsize
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|chp
operator|->
name|cq
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
return|return
operator|&
name|chp
operator|->
name|ibcq
return|;
name|err5
label|:
name|kfree
argument_list|(
name|mm2
argument_list|)
expr_stmt|;
name|err4
label|:
name|kfree
argument_list|(
name|mm
argument_list|)
expr_stmt|;
name|err3
label|:
name|remove_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|cqidr
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|)
expr_stmt|;
name|err2
label|:
name|destroy_cq
argument_list|(
operator|&
name|chp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|chp
operator|->
name|cq
argument_list|,
name|ucontext
condition|?
operator|&
name|ucontext
operator|->
name|uctx
else|:
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|uctx
argument_list|)
expr_stmt|;
name|err1
label|:
name|kfree
argument_list|(
name|chp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|c4iw_resize_cq
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|cq
parameter_list|,
name|int
name|cqe
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
return|return
operator|-
name|ENOSYS
return|;
block|}
end_function

begin_function
name|int
name|c4iw_arm_cq
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|ibcq
parameter_list|,
name|enum
name|ib_cq_notify_flags
name|flags
parameter_list|)
block|{
name|struct
name|c4iw_cq
modifier|*
name|chp
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|unsigned
name|long
name|flag
decl_stmt|;
name|chp
operator|=
name|to_c4iw_cq
argument_list|(
name|ibcq
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|ret
operator|=
name|t4_arm_cq
argument_list|(
operator|&
name|chp
operator|->
name|cq
argument_list|,
operator|(
name|flags
operator|&
name|IB_CQ_SOLICITED_MASK
operator|)
operator|==
name|IB_CQ_SOLICITED
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&&
operator|!
operator|(
name|flags
operator|&
name|IB_CQ_REPORT_MISSED_EVENTS
operator|)
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


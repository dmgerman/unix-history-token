begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2009-2013 Chelsio, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TCP_OFFLOAD
end_ifdef

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcpip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/toecore.h>
end_include

begin_struct_decl
struct_decl|struct
name|sge_iq
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|rss_header
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|cpl_set_tcb_rpl
struct_decl|;
end_struct_decl

begin_include
include|#
directive|include
file|<linux/types.h>
end_include

begin_include
include|#
directive|include
file|"offload.h"
end_include

begin_include
include|#
directive|include
file|"tom/t4_tom.h"
end_include

begin_include
include|#
directive|include
file|"iw_cxgbe.h"
end_include

begin_include
include|#
directive|include
file|"user.h"
end_include

begin_function_decl
specifier|static
name|int
name|creds
parameter_list|(
name|struct
name|toepcb
modifier|*
name|toep
parameter_list|,
name|struct
name|inpcb
modifier|*
name|inp
parameter_list|,
name|size_t
name|wrsize
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|set_state
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|,
name|enum
name|c4iw_qp_state
name|state
parameter_list|)
block|{
name|unsigned
name|long
name|flag
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|state
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dealloc_host_sq
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|struct
name|t4_sq
modifier|*
name|sq
parameter_list|)
block|{
name|contigfree
argument_list|(
name|sq
operator|->
name|queue
argument_list|,
name|sq
operator|->
name|memsize
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dealloc_sq
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|struct
name|t4_sq
modifier|*
name|sq
parameter_list|)
block|{
name|dealloc_host_sq
argument_list|(
name|rdev
argument_list|,
name|sq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|alloc_host_sq
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|struct
name|t4_sq
modifier|*
name|sq
parameter_list|)
block|{
name|sq
operator|->
name|queue
operator|=
name|contigmalloc
argument_list|(
name|sq
operator|->
name|memsize
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
literal|0ul
argument_list|,
operator|~
literal|0ul
argument_list|,
literal|4096
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sq
operator|->
name|queue
condition|)
name|sq
operator|->
name|dma_addr
operator|=
name|vtophys
argument_list|(
name|sq
operator|->
name|queue
argument_list|)
expr_stmt|;
else|else
return|return
operator|-
name|ENOMEM
return|;
name|sq
operator|->
name|phys_addr
operator|=
name|vtophys
argument_list|(
name|sq
operator|->
name|queue
argument_list|)
expr_stmt|;
name|pci_unmap_addr_set
argument_list|(
name|sq
argument_list|,
name|mapping
argument_list|,
name|sq
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s sq %p dma_addr %p phys_addr %p"
argument_list|,
name|__func__
argument_list|,
name|sq
operator|->
name|queue
argument_list|,
name|sq
operator|->
name|dma_addr
argument_list|,
name|sq
operator|->
name|phys_addr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|destroy_qp
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|c4iw_dev_ucontext
modifier|*
name|uctx
parameter_list|)
block|{
comment|/* 	 * uP clears EQ contexts when the connection exits rdma mode, 	 * so no need to post a RESET WR for these EQs. 	 */
name|contigfree
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|queue
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|memsize
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|dealloc_sq
argument_list|(
name|rdev
argument_list|,
operator|&
name|wq
operator|->
name|sq
argument_list|)
expr_stmt|;
name|c4iw_rqtpool_free
argument_list|(
name|rdev
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|rqt_hwaddr
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|rqt_size
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|sw_rq
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|wq
operator|->
name|sq
operator|.
name|sw_sq
argument_list|)
expr_stmt|;
name|c4iw_put_qpid
argument_list|(
name|rdev
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|qid
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
name|c4iw_put_qpid
argument_list|(
name|rdev
argument_list|,
name|wq
operator|->
name|sq
operator|.
name|qid
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|create_qp
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|struct
name|t4_cq
modifier|*
name|rcq
parameter_list|,
name|struct
name|t4_cq
modifier|*
name|scq
parameter_list|,
name|struct
name|c4iw_dev_ucontext
modifier|*
name|uctx
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|sc
init|=
name|rdev
operator|->
name|adap
decl_stmt|;
name|int
name|user
init|=
operator|(
name|uctx
operator|!=
operator|&
name|rdev
operator|->
name|uctx
operator|)
decl_stmt|;
name|struct
name|fw_ri_res_wr
modifier|*
name|res_wr
decl_stmt|;
name|struct
name|fw_ri_res
modifier|*
name|res
decl_stmt|;
name|int
name|wr_len
decl_stmt|;
name|struct
name|c4iw_wr_wait
name|wr_wait
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|eqsize
decl_stmt|;
name|struct
name|wrqe
modifier|*
name|wr
decl_stmt|;
specifier|const
name|int
name|spg_ndesc
init|=
name|sc
operator|->
name|params
operator|.
name|sge
operator|.
name|spg_len
operator|/
name|EQ_ESIZE
decl_stmt|;
name|wq
operator|->
name|sq
operator|.
name|qid
operator|=
name|c4iw_get_qpid
argument_list|(
name|rdev
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wq
operator|->
name|sq
operator|.
name|qid
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|wq
operator|->
name|rq
operator|.
name|qid
operator|=
name|c4iw_get_qpid
argument_list|(
name|rdev
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wq
operator|->
name|rq
operator|.
name|qid
condition|)
goto|goto
name|err1
goto|;
if|if
condition|(
operator|!
name|user
condition|)
block|{
name|wq
operator|->
name|sq
operator|.
name|sw_sq
operator|=
name|kzalloc
argument_list|(
name|wq
operator|->
name|sq
operator|.
name|size
operator|*
sizeof|sizeof
expr|*
name|wq
operator|->
name|sq
operator|.
name|sw_sq
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wq
operator|->
name|sq
operator|.
name|sw_sq
condition|)
goto|goto
name|err2
goto|;
name|wq
operator|->
name|rq
operator|.
name|sw_rq
operator|=
name|kzalloc
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|size
operator|*
sizeof|sizeof
expr|*
name|wq
operator|->
name|rq
operator|.
name|sw_rq
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wq
operator|->
name|rq
operator|.
name|sw_rq
condition|)
goto|goto
name|err3
goto|;
block|}
comment|/* RQT must be a power of 2. */
name|wq
operator|->
name|rq
operator|.
name|rqt_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|size
argument_list|)
expr_stmt|;
name|wq
operator|->
name|rq
operator|.
name|rqt_hwaddr
operator|=
name|c4iw_rqtpool_alloc
argument_list|(
name|rdev
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|rqt_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wq
operator|->
name|rq
operator|.
name|rqt_hwaddr
condition|)
goto|goto
name|err4
goto|;
if|if
condition|(
name|alloc_host_sq
argument_list|(
name|rdev
argument_list|,
operator|&
name|wq
operator|->
name|sq
argument_list|)
condition|)
goto|goto
name|err5
goto|;
name|memset
argument_list|(
name|wq
operator|->
name|sq
operator|.
name|queue
argument_list|,
literal|0
argument_list|,
name|wq
operator|->
name|sq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|pci_unmap_addr_set
argument_list|(
operator|&
name|wq
operator|->
name|sq
argument_list|,
name|mapping
argument_list|,
name|wq
operator|->
name|sq
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
name|wq
operator|->
name|rq
operator|.
name|queue
operator|=
name|contigmalloc
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|memsize
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
literal|0ul
argument_list|,
operator|~
literal|0ul
argument_list|,
literal|4096
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wq
operator|->
name|rq
operator|.
name|queue
condition|)
name|wq
operator|->
name|rq
operator|.
name|dma_addr
operator|=
name|vtophys
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|queue
argument_list|)
expr_stmt|;
else|else
goto|goto
name|err6
goto|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s sq base va 0x%p pa 0x%llx rq base va 0x%p pa 0x%llx"
argument_list|,
name|__func__
argument_list|,
name|wq
operator|->
name|sq
operator|.
name|queue
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|vtophys
argument_list|(
name|wq
operator|->
name|sq
operator|.
name|queue
argument_list|)
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|queue
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|vtophys
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|queue
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|queue
argument_list|,
literal|0
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|pci_unmap_addr_set
argument_list|(
operator|&
name|wq
operator|->
name|rq
argument_list|,
name|mapping
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
name|wq
operator|->
name|db
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|rman_get_virtual
argument_list|(
name|sc
operator|->
name|regs_res
argument_list|)
operator|+
name|sc
operator|->
name|sge_kdoorbell_reg
operator|)
expr_stmt|;
name|wq
operator|->
name|gts
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|rman_get_virtual
argument_list|(
name|rdev
operator|->
name|adap
operator|->
name|regs_res
argument_list|)
operator|+
name|sc
operator|->
name|sge_gts_reg
operator|)
expr_stmt|;
if|if
condition|(
name|user
condition|)
block|{
name|wq
operator|->
name|sq
operator|.
name|udb
operator|=
call|(
name|u64
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|rman_get_virtual
argument_list|(
name|rdev
operator|->
name|adap
operator|->
name|udbs_res
argument_list|)
operator|+
operator|(
name|wq
operator|->
name|sq
operator|.
name|qid
operator|<<
name|rdev
operator|->
name|qpshift
operator|)
argument_list|)
expr_stmt|;
name|wq
operator|->
name|sq
operator|.
name|udb
operator|&=
name|PAGE_MASK
expr_stmt|;
name|wq
operator|->
name|rq
operator|.
name|udb
operator|=
call|(
name|u64
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|rman_get_virtual
argument_list|(
name|rdev
operator|->
name|adap
operator|->
name|udbs_res
argument_list|)
operator|+
operator|(
name|wq
operator|->
name|rq
operator|.
name|qid
operator|<<
name|rdev
operator|->
name|qpshift
operator|)
argument_list|)
expr_stmt|;
name|wq
operator|->
name|rq
operator|.
name|udb
operator|&=
name|PAGE_MASK
expr_stmt|;
block|}
name|wq
operator|->
name|rdev
operator|=
name|rdev
expr_stmt|;
name|wq
operator|->
name|rq
operator|.
name|msn
operator|=
literal|1
expr_stmt|;
comment|/* build fw_ri_res_wr */
name|wr_len
operator|=
sizeof|sizeof
expr|*
name|res_wr
operator|+
literal|2
operator|*
sizeof|sizeof
expr|*
name|res
expr_stmt|;
name|wr
operator|=
name|alloc_wrqe
argument_list|(
name|wr_len
argument_list|,
operator|&
name|sc
operator|->
name|sge
operator|.
name|mgmtq
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|res_wr
operator|=
name|wrtod
argument_list|(
name|wr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|res_wr
argument_list|,
literal|0
argument_list|,
name|wr_len
argument_list|)
expr_stmt|;
name|res_wr
operator|->
name|op_nres
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_OP
argument_list|(
name|FW_RI_RES_WR
argument_list|)
operator||
name|V_FW_RI_RES_WR_NRES
argument_list|(
literal|2
argument_list|)
operator||
name|F_FW_WR_COMPL
argument_list|)
expr_stmt|;
name|res_wr
operator|->
name|len16_pkd
operator|=
name|cpu_to_be32
argument_list|(
name|DIV_ROUND_UP
argument_list|(
name|wr_len
argument_list|,
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|res_wr
operator|->
name|cookie
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|&
name|wr_wait
expr_stmt|;
name|res
operator|=
name|res_wr
operator|->
name|res
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|restype
operator|=
name|FW_RI_RES_TYPE_SQ
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|op
operator|=
name|FW_RI_RES_OP_WRITE
expr_stmt|;
comment|/* eqsize is the number of 64B entries plus the status page size. */
name|eqsize
operator|=
name|wq
operator|->
name|sq
operator|.
name|size
operator|*
name|T4_SQ_NUM_SLOTS
operator|+
name|spg_ndesc
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|fetchszm_to_iqid
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_RI_RES_WR_HOSTFCMODE
argument_list|(
literal|0
argument_list|)
operator||
comment|/* no host cidx updates */
name|V_FW_RI_RES_WR_CPRIO
argument_list|(
literal|0
argument_list|)
operator||
comment|/* don't keep in chip cache */
name|V_FW_RI_RES_WR_PCIECHN
argument_list|(
literal|0
argument_list|)
operator||
comment|/* set by uP at ri_init time */
name|V_FW_RI_RES_WR_IQID
argument_list|(
name|scq
operator|->
name|cqid
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|dcaen_to_eqsize
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_RI_RES_WR_DCAEN
argument_list|(
literal|0
argument_list|)
operator||
name|V_FW_RI_RES_WR_DCACPU
argument_list|(
literal|0
argument_list|)
operator||
name|V_FW_RI_RES_WR_FBMIN
argument_list|(
literal|2
argument_list|)
operator||
name|V_FW_RI_RES_WR_FBMAX
argument_list|(
literal|2
argument_list|)
operator||
name|V_FW_RI_RES_WR_CIDXFTHRESHO
argument_list|(
literal|0
argument_list|)
operator||
name|V_FW_RI_RES_WR_CIDXFTHRESH
argument_list|(
literal|0
argument_list|)
operator||
name|V_FW_RI_RES_WR_EQSIZE
argument_list|(
name|eqsize
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|eqid
operator|=
name|cpu_to_be32
argument_list|(
name|wq
operator|->
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|eqaddr
operator|=
name|cpu_to_be64
argument_list|(
name|wq
operator|->
name|sq
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
name|res
operator|++
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|restype
operator|=
name|FW_RI_RES_TYPE_RQ
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|op
operator|=
name|FW_RI_RES_OP_WRITE
expr_stmt|;
comment|/* eqsize is the number of 64B entries plus the status page size. */
name|eqsize
operator|=
name|wq
operator|->
name|rq
operator|.
name|size
operator|*
name|T4_RQ_NUM_SLOTS
operator|+
name|spg_ndesc
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|fetchszm_to_iqid
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_RI_RES_WR_HOSTFCMODE
argument_list|(
literal|0
argument_list|)
operator||
comment|/* no host cidx updates */
name|V_FW_RI_RES_WR_CPRIO
argument_list|(
literal|0
argument_list|)
operator||
comment|/* don't keep in chip cache */
name|V_FW_RI_RES_WR_PCIECHN
argument_list|(
literal|0
argument_list|)
operator||
comment|/* set by uP at ri_init time */
name|V_FW_RI_RES_WR_IQID
argument_list|(
name|rcq
operator|->
name|cqid
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|dcaen_to_eqsize
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_RI_RES_WR_DCAEN
argument_list|(
literal|0
argument_list|)
operator||
name|V_FW_RI_RES_WR_DCACPU
argument_list|(
literal|0
argument_list|)
operator||
name|V_FW_RI_RES_WR_FBMIN
argument_list|(
literal|2
argument_list|)
operator||
name|V_FW_RI_RES_WR_FBMAX
argument_list|(
literal|2
argument_list|)
operator||
name|V_FW_RI_RES_WR_CIDXFTHRESHO
argument_list|(
literal|0
argument_list|)
operator||
name|V_FW_RI_RES_WR_CIDXFTHRESH
argument_list|(
literal|0
argument_list|)
operator||
name|V_FW_RI_RES_WR_EQSIZE
argument_list|(
name|eqsize
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|eqid
operator|=
name|cpu_to_be32
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|res
operator|->
name|u
operator|.
name|sqrq
operator|.
name|eqaddr
operator|=
name|cpu_to_be64
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
name|c4iw_init_wr_wait
argument_list|(
operator|&
name|wr_wait
argument_list|)
expr_stmt|;
name|t4_wrq_tx
argument_list|(
name|sc
argument_list|,
name|wr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|c4iw_wait_for_reply
argument_list|(
name|rdev
argument_list|,
operator|&
name|wr_wait
argument_list|,
literal|0
argument_list|,
name|wq
operator|->
name|sq
operator|.
name|qid
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err7
goto|;
name|CTR6
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s sqid 0x%x rqid 0x%x kdb 0x%p squdb 0x%llx rqudb 0x%llx"
argument_list|,
name|__func__
argument_list|,
name|wq
operator|->
name|sq
operator|.
name|qid
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|qid
argument_list|,
name|wq
operator|->
name|db
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|wq
operator|->
name|sq
operator|.
name|udb
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|wq
operator|->
name|rq
operator|.
name|udb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err7
label|:
name|contigfree
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|queue
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|memsize
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|err6
label|:
name|dealloc_sq
argument_list|(
name|rdev
argument_list|,
operator|&
name|wq
operator|->
name|sq
argument_list|)
expr_stmt|;
name|err5
label|:
name|c4iw_rqtpool_free
argument_list|(
name|rdev
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|rqt_hwaddr
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|rqt_size
argument_list|)
expr_stmt|;
name|err4
label|:
name|kfree
argument_list|(
name|wq
operator|->
name|rq
operator|.
name|sw_rq
argument_list|)
expr_stmt|;
name|err3
label|:
name|kfree
argument_list|(
name|wq
operator|->
name|sq
operator|.
name|sw_sq
argument_list|)
expr_stmt|;
name|err2
label|:
name|c4iw_put_qpid
argument_list|(
name|rdev
argument_list|,
name|wq
operator|->
name|rq
operator|.
name|qid
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
name|err1
label|:
name|c4iw_put_qpid
argument_list|(
name|rdev
argument_list|,
name|wq
operator|->
name|sq
operator|.
name|qid
argument_list|,
name|uctx
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_immd
parameter_list|(
name|struct
name|t4_sq
modifier|*
name|sq
parameter_list|,
name|struct
name|fw_ri_immd
modifier|*
name|immdp
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|int
name|max
parameter_list|,
name|u32
modifier|*
name|plenp
parameter_list|)
block|{
name|u8
modifier|*
name|dstp
decl_stmt|,
modifier|*
name|srcp
decl_stmt|;
name|u32
name|plen
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|rem
decl_stmt|,
name|len
decl_stmt|;
name|dstp
operator|=
operator|(
name|u8
operator|*
operator|)
name|immdp
operator|->
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wr
operator|->
name|num_sge
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|plen
operator|+
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
operator|)
operator|>
name|max
condition|)
return|return
operator|-
name|EMSGSIZE
return|;
name|srcp
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
expr_stmt|;
name|plen
operator|+=
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
expr_stmt|;
name|rem
operator|=
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
expr_stmt|;
while|while
condition|(
name|rem
condition|)
block|{
if|if
condition|(
name|dstp
operator|==
operator|(
name|u8
operator|*
operator|)
operator|&
name|sq
operator|->
name|queue
index|[
name|sq
operator|->
name|size
index|]
condition|)
name|dstp
operator|=
operator|(
name|u8
operator|*
operator|)
name|sq
operator|->
name|queue
expr_stmt|;
if|if
condition|(
name|rem
operator|<=
operator|(
name|u8
operator|*
operator|)
operator|&
name|sq
operator|->
name|queue
index|[
name|sq
operator|->
name|size
index|]
operator|-
name|dstp
condition|)
name|len
operator|=
name|rem
expr_stmt|;
else|else
name|len
operator|=
operator|(
name|u8
operator|*
operator|)
operator|&
name|sq
operator|->
name|queue
index|[
name|sq
operator|->
name|size
index|]
operator|-
name|dstp
expr_stmt|;
name|memcpy
argument_list|(
name|dstp
argument_list|,
name|srcp
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dstp
operator|+=
name|len
expr_stmt|;
name|srcp
operator|+=
name|len
expr_stmt|;
name|rem
operator|-=
name|len
expr_stmt|;
block|}
block|}
name|len
operator|=
name|roundup
argument_list|(
name|plen
operator|+
sizeof|sizeof
expr|*
name|immdp
argument_list|,
literal|16
argument_list|)
operator|-
operator|(
name|plen
operator|+
sizeof|sizeof
expr|*
name|immdp
operator|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
name|memset
argument_list|(
name|dstp
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|immdp
operator|->
name|op
operator|=
name|FW_RI_DATA_IMMD
expr_stmt|;
name|immdp
operator|->
name|r1
operator|=
literal|0
expr_stmt|;
name|immdp
operator|->
name|r2
operator|=
literal|0
expr_stmt|;
name|immdp
operator|->
name|immdlen
operator|=
name|cpu_to_be32
argument_list|(
name|plen
argument_list|)
expr_stmt|;
operator|*
name|plenp
operator|=
name|plen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_isgl
parameter_list|(
name|__be64
modifier|*
name|queue_start
parameter_list|,
name|__be64
modifier|*
name|queue_end
parameter_list|,
name|struct
name|fw_ri_isgl
modifier|*
name|isglp
parameter_list|,
name|struct
name|ib_sge
modifier|*
name|sg_list
parameter_list|,
name|int
name|num_sge
parameter_list|,
name|u32
modifier|*
name|plenp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u32
name|plen
init|=
literal|0
decl_stmt|;
name|__be64
modifier|*
name|flitp
init|=
operator|(
name|__be64
operator|*
operator|)
name|isglp
operator|->
name|sge
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_sge
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|plen
operator|+
name|sg_list
index|[
name|i
index|]
operator|.
name|length
operator|)
operator|<
name|plen
condition|)
return|return
operator|-
name|EMSGSIZE
return|;
name|plen
operator|+=
name|sg_list
index|[
name|i
index|]
operator|.
name|length
expr_stmt|;
operator|*
name|flitp
operator|=
name|cpu_to_be64
argument_list|(
operator|(
operator|(
name|u64
operator|)
name|sg_list
index|[
name|i
index|]
operator|.
name|lkey
operator|<<
literal|32
operator|)
operator||
name|sg_list
index|[
name|i
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|flitp
operator|==
name|queue_end
condition|)
name|flitp
operator|=
name|queue_start
expr_stmt|;
operator|*
name|flitp
operator|=
name|cpu_to_be64
argument_list|(
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|flitp
operator|==
name|queue_end
condition|)
name|flitp
operator|=
name|queue_start
expr_stmt|;
block|}
operator|*
name|flitp
operator|=
operator|(
name|__force
name|__be64
operator|)
literal|0
expr_stmt|;
name|isglp
operator|->
name|op
operator|=
name|FW_RI_DATA_ISGL
expr_stmt|;
name|isglp
operator|->
name|r1
operator|=
literal|0
expr_stmt|;
name|isglp
operator|->
name|nsge
operator|=
name|cpu_to_be16
argument_list|(
name|num_sge
argument_list|)
expr_stmt|;
name|isglp
operator|->
name|r2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|plenp
condition|)
operator|*
name|plenp
operator|=
name|plen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_send
parameter_list|(
name|struct
name|t4_sq
modifier|*
name|sq
parameter_list|,
name|union
name|t4_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|len16
parameter_list|)
block|{
name|u32
name|plen
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
name|T4_MAX_SEND_SGE
condition|)
return|return
operator|-
name|EINVAL
return|;
switch|switch
condition|(
name|wr
operator|->
name|opcode
condition|)
block|{
case|case
name|IB_WR_SEND
case|:
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_SOLICITED
condition|)
name|wqe
operator|->
name|send
operator|.
name|sendop_pkd
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_RI_SEND_WR_SENDOP
argument_list|(
name|FW_RI_SEND_WITH_SE
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|wqe
operator|->
name|send
operator|.
name|sendop_pkd
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_RI_SEND_WR_SENDOP
argument_list|(
name|FW_RI_SEND
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|stag_inv
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|IB_WR_SEND_WITH_INV
case|:
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_SOLICITED
condition|)
name|wqe
operator|->
name|send
operator|.
name|sendop_pkd
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_RI_SEND_WR_SENDOP
argument_list|(
name|FW_RI_SEND_WITH_SE_INV
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|wqe
operator|->
name|send
operator|.
name|sendop_pkd
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_RI_SEND_WR_SENDOP
argument_list|(
name|FW_RI_SEND_WITH_INV
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|stag_inv
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|ex
operator|.
name|invalidate_rkey
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
name|plen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|num_sge
condition|)
block|{
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_INLINE
condition|)
block|{
name|ret
operator|=
name|build_immd
argument_list|(
name|sq
argument_list|,
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|immd_src
argument_list|,
name|wr
argument_list|,
name|T4_MAX_SEND_INLINE
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|send
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_immd
argument_list|)
operator|+
name|plen
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|build_isgl
argument_list|(
operator|(
name|__be64
operator|*
operator|)
name|sq
operator|->
name|queue
argument_list|,
operator|(
name|__be64
operator|*
operator|)
operator|&
name|sq
operator|->
name|queue
index|[
name|sq
operator|->
name|size
index|]
argument_list|,
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|isgl_src
argument_list|,
name|wr
operator|->
name|sg_list
argument_list|,
name|wr
operator|->
name|num_sge
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|send
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_isgl
argument_list|)
operator|+
name|wr
operator|->
name|num_sge
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_sge
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|op
operator|=
name|FW_RI_DATA_IMMD
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|r1
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|r2
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|immdlen
operator|=
literal|0
expr_stmt|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|send
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_immd
argument_list|)
expr_stmt|;
name|plen
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
name|size
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|plen
operator|=
name|cpu_to_be32
argument_list|(
name|plen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_write
parameter_list|(
name|struct
name|t4_sq
modifier|*
name|sq
parameter_list|,
name|union
name|t4_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|len16
parameter_list|)
block|{
name|u32
name|plen
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
name|T4_MAX_SEND_SGE
condition|)
return|return
operator|-
name|EINVAL
return|;
name|wqe
operator|->
name|write
operator|.
name|r2
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|stag_sink
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|rkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|to_sink
operator|=
name|cpu_to_be64
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|num_sge
condition|)
block|{
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_INLINE
condition|)
block|{
name|ret
operator|=
name|build_immd
argument_list|(
name|sq
argument_list|,
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|immd_src
argument_list|,
name|wr
argument_list|,
name|T4_MAX_WRITE_INLINE
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|write
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_immd
argument_list|)
operator|+
name|plen
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|build_isgl
argument_list|(
operator|(
name|__be64
operator|*
operator|)
name|sq
operator|->
name|queue
argument_list|,
operator|(
name|__be64
operator|*
operator|)
operator|&
name|sq
operator|->
name|queue
index|[
name|sq
operator|->
name|size
index|]
argument_list|,
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|isgl_src
argument_list|,
name|wr
operator|->
name|sg_list
argument_list|,
name|wr
operator|->
name|num_sge
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|write
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_isgl
argument_list|)
operator|+
name|wr
operator|->
name|num_sge
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_sge
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|op
operator|=
name|FW_RI_DATA_IMMD
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|r1
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|r2
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|immdlen
operator|=
literal|0
expr_stmt|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|write
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_immd
argument_list|)
expr_stmt|;
name|plen
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
name|size
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|plen
operator|=
name|cpu_to_be32
argument_list|(
name|plen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_read
parameter_list|(
name|union
name|t4_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|len16
parameter_list|)
block|{
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
literal|1
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|wr
operator|->
name|num_sge
condition|)
block|{
name|wqe
operator|->
name|read
operator|.
name|stag_src
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|rkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_src_hi
operator|=
name|cpu_to_be32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_src_lo
operator|=
name|cpu_to_be32
argument_list|(
operator|(
name|u32
operator|)
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|stag_sink
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|lkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|plen
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_sink_hi
operator|=
name|cpu_to_be32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|addr
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_sink_lo
operator|=
name|cpu_to_be32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wqe
operator|->
name|read
operator|.
name|stag_src
operator|=
name|cpu_to_be32
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_src_hi
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_src_lo
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|stag_sink
operator|=
name|cpu_to_be32
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|plen
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_sink_hi
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_sink_lo
operator|=
literal|0
expr_stmt|;
block|}
name|wqe
operator|->
name|read
operator|.
name|r2
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|r5
operator|=
literal|0
expr_stmt|;
operator|*
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
name|wqe
operator|->
name|read
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_recv
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|,
name|union
name|t4_recv_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_recv_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|len16
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|build_isgl
argument_list|(
operator|(
name|__be64
operator|*
operator|)
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
argument_list|,
operator|(
name|__be64
operator|*
operator|)
operator|&
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
index|[
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
index|]
argument_list|,
operator|&
name|wqe
operator|->
name|recv
operator|.
name|isgl
argument_list|,
name|wr
operator|->
name|sg_list
argument_list|,
name|wr
operator|->
name|num_sge
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
operator|*
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
name|wqe
operator|->
name|recv
operator|+
name|wr
operator|->
name|num_sge
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_sge
argument_list|)
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_fastreg
parameter_list|(
name|struct
name|t4_sq
modifier|*
name|sq
parameter_list|,
name|union
name|t4_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|len16
parameter_list|)
block|{
name|struct
name|fw_ri_immd
modifier|*
name|imdp
decl_stmt|;
name|__be64
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|pbllen
init|=
name|roundup
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|fast_reg
operator|.
name|page_list_len
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
literal|32
argument_list|)
decl_stmt|;
name|int
name|rem
decl_stmt|;
if|if
condition|(
name|wr
operator|->
name|wr
operator|.
name|fast_reg
operator|.
name|page_list_len
operator|>
name|T4_MAX_FR_DEPTH
condition|)
return|return
operator|-
name|EINVAL
return|;
name|wqe
operator|->
name|fr
operator|.
name|qpbinde_to_dcacpu
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|fr
operator|.
name|pgsz_shift
operator|=
name|wr
operator|->
name|wr
operator|.
name|fast_reg
operator|.
name|page_shift
operator|-
literal|12
expr_stmt|;
name|wqe
operator|->
name|fr
operator|.
name|addr_type
operator|=
name|FW_RI_VA_BASED_TO
expr_stmt|;
name|wqe
operator|->
name|fr
operator|.
name|mem_perms
operator|=
name|c4iw_ib_to_tpt_access
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|fast_reg
operator|.
name|access_flags
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|fr
operator|.
name|len_hi
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|fr
operator|.
name|len_lo
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|fast_reg
operator|.
name|length
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|fr
operator|.
name|stag
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|fast_reg
operator|.
name|rkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|fr
operator|.
name|va_hi
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|fast_reg
operator|.
name|iova_start
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|fr
operator|.
name|va_lo_fbo
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|fast_reg
operator|.
name|iova_start
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WARN_ON
argument_list|(
name|pbllen
operator|>
name|T4_MAX_FR_IMMD
argument_list|)
expr_stmt|;
name|imdp
operator|=
operator|(
expr|struct
name|fw_ri_immd
operator|*
operator|)
operator|(
operator|&
name|wqe
operator|->
name|fr
operator|+
literal|1
operator|)
expr_stmt|;
name|imdp
operator|->
name|op
operator|=
name|FW_RI_DATA_IMMD
expr_stmt|;
name|imdp
operator|->
name|r1
operator|=
literal|0
expr_stmt|;
name|imdp
operator|->
name|r2
operator|=
literal|0
expr_stmt|;
name|imdp
operator|->
name|immdlen
operator|=
name|cpu_to_be32
argument_list|(
name|pbllen
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|__be64
operator|*
operator|)
operator|(
name|imdp
operator|+
literal|1
operator|)
expr_stmt|;
name|rem
operator|=
name|pbllen
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wr
operator|->
name|wr
operator|.
name|fast_reg
operator|.
name|page_list_len
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|p
operator|=
name|cpu_to_be64
argument_list|(
operator|(
name|u64
operator|)
name|wr
operator|->
name|wr
operator|.
name|fast_reg
operator|.
name|page_list
operator|->
name|page_list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|rem
operator|-=
sizeof|sizeof
expr|*
name|p
expr_stmt|;
if|if
condition|(
operator|++
name|p
operator|==
operator|(
name|__be64
operator|*
operator|)
operator|&
name|sq
operator|->
name|queue
index|[
name|sq
operator|->
name|size
index|]
condition|)
name|p
operator|=
operator|(
name|__be64
operator|*
operator|)
name|sq
operator|->
name|queue
expr_stmt|;
block|}
name|BUG_ON
argument_list|(
name|rem
operator|<
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|rem
condition|)
block|{
operator|*
name|p
operator|=
literal|0
expr_stmt|;
name|rem
operator|-=
sizeof|sizeof
expr|*
name|p
expr_stmt|;
if|if
condition|(
operator|++
name|p
operator|==
operator|(
name|__be64
operator|*
operator|)
operator|&
name|sq
operator|->
name|queue
index|[
name|sq
operator|->
name|size
index|]
condition|)
name|p
operator|=
operator|(
name|__be64
operator|*
operator|)
name|sq
operator|->
name|queue
expr_stmt|;
block|}
operator|*
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
name|wqe
operator|->
name|fr
operator|+
sizeof|sizeof
expr|*
name|imdp
operator|+
name|pbllen
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_inv_stag
parameter_list|(
name|union
name|t4_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|len16
parameter_list|)
block|{
name|wqe
operator|->
name|inv
operator|.
name|stag_inv
operator|=
name|cpu_to_be32
argument_list|(
name|wr
operator|->
name|ex
operator|.
name|invalidate_rkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|inv
operator|.
name|r2
operator|=
literal|0
expr_stmt|;
operator|*
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
name|wqe
operator|->
name|inv
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|c4iw_qp_add_ref
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_qp %p"
argument_list|,
name|__func__
argument_list|,
name|qp
argument_list|)
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
operator|(
name|to_c4iw_qp
argument_list|(
name|qp
argument_list|)
operator|->
name|refcnt
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|c4iw_qp_rem_ref
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_qp %p"
argument_list|,
name|__func__
argument_list|,
name|qp
argument_list|)
expr_stmt|;
if|if
condition|(
name|atomic_dec_and_test
argument_list|(
operator|&
operator|(
name|to_c4iw_qp
argument_list|(
name|qp
argument_list|)
operator|->
name|refcnt
operator|)
argument_list|)
condition|)
name|wake_up
argument_list|(
operator|&
operator|(
name|to_c4iw_qp
argument_list|(
name|qp
argument_list|)
operator|->
name|wait
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|complete_sq_drain_wr
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|)
block|{
name|struct
name|t4_cqe
name|cqe
init|=
block|{}
decl_stmt|;
name|struct
name|c4iw_cq
modifier|*
name|schp
decl_stmt|;
name|unsigned
name|long
name|flag
decl_stmt|;
name|struct
name|t4_cq
modifier|*
name|cq
decl_stmt|;
name|schp
operator|=
name|to_c4iw_cq
argument_list|(
name|qhp
operator|->
name|ibqp
operator|.
name|send_cq
argument_list|)
expr_stmt|;
name|cq
operator|=
operator|&
name|schp
operator|->
name|cq
expr_stmt|;
name|PDBG
argument_list|(
literal|"%s drain sq id %u\n"
argument_list|,
name|__func__
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|cqe
operator|.
name|u
operator|.
name|drain_cookie
operator|=
name|wr
operator|->
name|wr_id
expr_stmt|;
name|cqe
operator|.
name|header
operator|=
name|cpu_to_be32
argument_list|(
name|V_CQE_STATUS
argument_list|(
name|T4_ERR_SWFLUSH
argument_list|)
operator||
name|V_CQE_OPCODE
argument_list|(
name|C4IW_DRAIN_OPCODE
argument_list|)
operator||
name|V_CQE_TYPE
argument_list|(
literal|1
argument_list|)
operator||
name|V_CQE_SWCQE
argument_list|(
literal|1
argument_list|)
operator||
name|V_CQE_QPID
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|schp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|cqe
operator|.
name|bits_type_ts
operator|=
name|cpu_to_be64
argument_list|(
name|V_CQE_GENBIT
argument_list|(
operator|(
name|u64
operator|)
name|cq
operator|->
name|gen
argument_list|)
argument_list|)
expr_stmt|;
name|cq
operator|->
name|sw_queue
index|[
name|cq
operator|->
name|sw_pidx
index|]
operator|=
name|cqe
expr_stmt|;
name|t4_swcq_produce
argument_list|(
name|cq
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|schp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|schp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
call|(
modifier|*
name|schp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|schp
operator|->
name|ibcq
argument_list|,
name|schp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|schp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|complete_rq_drain_wr
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|,
name|struct
name|ib_recv_wr
modifier|*
name|wr
parameter_list|)
block|{
name|struct
name|t4_cqe
name|cqe
init|=
block|{}
decl_stmt|;
name|struct
name|c4iw_cq
modifier|*
name|rchp
decl_stmt|;
name|unsigned
name|long
name|flag
decl_stmt|;
name|struct
name|t4_cq
modifier|*
name|cq
decl_stmt|;
name|rchp
operator|=
name|to_c4iw_cq
argument_list|(
name|qhp
operator|->
name|ibqp
operator|.
name|recv_cq
argument_list|)
expr_stmt|;
name|cq
operator|=
operator|&
name|rchp
operator|->
name|cq
expr_stmt|;
name|PDBG
argument_list|(
literal|"%s drain rq id %u\n"
argument_list|,
name|__func__
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|cqe
operator|.
name|u
operator|.
name|drain_cookie
operator|=
name|wr
operator|->
name|wr_id
expr_stmt|;
name|cqe
operator|.
name|header
operator|=
name|cpu_to_be32
argument_list|(
name|V_CQE_STATUS
argument_list|(
name|T4_ERR_SWFLUSH
argument_list|)
operator||
name|V_CQE_OPCODE
argument_list|(
name|C4IW_DRAIN_OPCODE
argument_list|)
operator||
name|V_CQE_TYPE
argument_list|(
literal|0
argument_list|)
operator||
name|V_CQE_SWCQE
argument_list|(
literal|1
argument_list|)
operator||
name|V_CQE_QPID
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|rchp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|cqe
operator|.
name|bits_type_ts
operator|=
name|cpu_to_be64
argument_list|(
name|V_CQE_GENBIT
argument_list|(
operator|(
name|u64
operator|)
name|cq
operator|->
name|gen
argument_list|)
argument_list|)
expr_stmt|;
name|cq
operator|->
name|sw_queue
index|[
name|cq
operator|->
name|sw_pidx
index|]
operator|=
name|cqe
expr_stmt|;
name|t4_swcq_produce
argument_list|(
name|cq
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rchp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|rchp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
call|(
modifier|*
name|rchp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|rchp
operator|->
name|ibcq
argument_list|,
name|rchp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rchp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|c4iw_post_send
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
name|wr
parameter_list|,
name|struct
name|ib_send_wr
modifier|*
modifier|*
name|bad_wr
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u8
name|len16
init|=
literal|0
decl_stmt|;
name|enum
name|fw_wr_opcodes
name|fw_opcode
init|=
literal|0
decl_stmt|;
name|enum
name|fw_ri_wr_flags
name|fw_flags
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
decl_stmt|;
name|union
name|t4_wr
modifier|*
name|wqe
decl_stmt|;
name|u32
name|num_wrs
decl_stmt|;
name|struct
name|t4_swsqe
modifier|*
name|swsqe
decl_stmt|;
name|unsigned
name|long
name|flag
decl_stmt|;
name|u16
name|idx
init|=
literal|0
decl_stmt|;
name|qhp
operator|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|t4_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|complete_sq_drain_wr
argument_list|(
name|qhp
argument_list|,
name|wr
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|num_wrs
operator|=
name|t4_sq_avail
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_wrs
operator|==
literal|0
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
while|while
condition|(
name|wr
condition|)
block|{
if|if
condition|(
name|num_wrs
operator|==
literal|0
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
break|break;
block|}
name|wqe
operator|=
operator|(
expr|union
name|t4_wr
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
operator|+
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|wq_pidx
operator|*
name|T4_EQ_ENTRY_SIZE
operator|)
expr_stmt|;
name|fw_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_SOLICITED
condition|)
name|fw_flags
operator||=
name|FW_RI_SOLICITED_EVENT_FLAG
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_SIGNALED
operator|||
name|qhp
operator|->
name|sq_sig_all
condition|)
name|fw_flags
operator||=
name|FW_RI_COMPLETION_FLAG
expr_stmt|;
name|swsqe
operator|=
operator|&
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
index|[
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
index|]
expr_stmt|;
switch|switch
condition|(
name|wr
operator|->
name|opcode
condition|)
block|{
case|case
name|IB_WR_SEND_WITH_INV
case|:
case|case
name|IB_WR_SEND
case|:
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_FENCE
condition|)
name|fw_flags
operator||=
name|FW_RI_READ_FENCE_FLAG
expr_stmt|;
name|fw_opcode
operator|=
name|FW_RI_SEND_WR
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|opcode
operator|==
name|IB_WR_SEND
condition|)
name|swsqe
operator|->
name|opcode
operator|=
name|FW_RI_SEND
expr_stmt|;
else|else
name|swsqe
operator|->
name|opcode
operator|=
name|FW_RI_SEND_WITH_INV
expr_stmt|;
name|err
operator|=
name|build_rdma_send
argument_list|(
operator|&
name|qhp
operator|->
name|wq
operator|.
name|sq
argument_list|,
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|len16
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_WR_RDMA_WRITE
case|:
name|fw_opcode
operator|=
name|FW_RI_RDMA_WRITE_WR
expr_stmt|;
name|swsqe
operator|->
name|opcode
operator|=
name|FW_RI_RDMA_WRITE
expr_stmt|;
name|err
operator|=
name|build_rdma_write
argument_list|(
operator|&
name|qhp
operator|->
name|wq
operator|.
name|sq
argument_list|,
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|len16
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_WR_RDMA_READ
case|:
case|case
name|IB_WR_RDMA_READ_WITH_INV
case|:
name|fw_opcode
operator|=
name|FW_RI_RDMA_READ_WR
expr_stmt|;
name|swsqe
operator|->
name|opcode
operator|=
name|FW_RI_READ_REQ
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|opcode
operator|==
name|IB_WR_RDMA_READ_WITH_INV
condition|)
name|fw_flags
operator|=
name|FW_RI_RDMA_READ_INVALIDATE
expr_stmt|;
else|else
name|fw_flags
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|build_rdma_read
argument_list|(
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|len16
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
name|swsqe
operator|->
name|read_len
operator|=
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|length
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|oldest_read
condition|)
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|oldest_read
operator|=
name|swsqe
expr_stmt|;
break|break;
case|case
name|IB_WR_FAST_REG_MR
case|:
name|fw_opcode
operator|=
name|FW_RI_FR_NSMR_WR
expr_stmt|;
name|swsqe
operator|->
name|opcode
operator|=
name|FW_RI_FAST_REGISTER
expr_stmt|;
name|err
operator|=
name|build_fastreg
argument_list|(
operator|&
name|qhp
operator|->
name|wq
operator|.
name|sq
argument_list|,
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|len16
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_WR_LOCAL_INV
case|:
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_FENCE
condition|)
name|fw_flags
operator||=
name|FW_RI_LOCAL_FENCE_FLAG
expr_stmt|;
name|fw_opcode
operator|=
name|FW_RI_INV_LSTAG_WR
expr_stmt|;
name|swsqe
operator|->
name|opcode
operator|=
name|FW_RI_LOCAL_INV
expr_stmt|;
name|err
operator|=
name|build_inv_stag
argument_list|(
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|len16
argument_list|)
expr_stmt|;
break|break;
default|default:
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s post of type =%d TBD!"
argument_list|,
name|__func__
argument_list|,
name|wr
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
block|{
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
break|break;
block|}
name|swsqe
operator|->
name|idx
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
expr_stmt|;
name|swsqe
operator|->
name|complete
operator|=
literal|0
expr_stmt|;
name|swsqe
operator|->
name|signaled
operator|=
operator|(
name|wr
operator|->
name|send_flags
operator|&
name|IB_SEND_SIGNALED
operator|)
operator|||
name|qhp
operator|->
name|sq_sig_all
expr_stmt|;
name|swsqe
operator|->
name|wr_id
operator|=
name|wr
operator|->
name|wr_id
expr_stmt|;
name|init_wr_hdr
argument_list|(
name|wqe
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
argument_list|,
name|fw_opcode
argument_list|,
name|fw_flags
argument_list|,
name|len16
argument_list|)
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s cookie 0x%llx pidx 0x%x opcode 0x%x read_len %u"
argument_list|,
name|__func__
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|wr
operator|->
name|wr_id
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
argument_list|,
name|swsqe
operator|->
name|opcode
argument_list|,
name|swsqe
operator|->
name|read_len
argument_list|)
expr_stmt|;
name|wr
operator|=
name|wr
operator|->
name|next
expr_stmt|;
name|num_wrs
operator|--
expr_stmt|;
name|t4_sq_produce
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|len16
argument_list|)
expr_stmt|;
name|idx
operator|+=
name|DIV_ROUND_UP
argument_list|(
name|len16
operator|*
literal|16
argument_list|,
name|T4_EQ_ENTRY_SIZE
argument_list|)
expr_stmt|;
block|}
name|t4_ring_sq_db
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|c4iw_post_receive
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ib_recv_wr
modifier|*
name|wr
parameter_list|,
name|struct
name|ib_recv_wr
modifier|*
modifier|*
name|bad_wr
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
decl_stmt|;
name|union
name|t4_recv_wr
modifier|*
name|wqe
decl_stmt|;
name|u32
name|num_wrs
decl_stmt|;
name|u8
name|len16
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|flag
decl_stmt|;
name|u16
name|idx
init|=
literal|0
decl_stmt|;
name|qhp
operator|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|t4_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|complete_rq_drain_wr
argument_list|(
name|qhp
argument_list|,
name|wr
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|num_wrs
operator|=
name|t4_rq_avail
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_wrs
operator|==
literal|0
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
while|while
condition|(
name|wr
condition|)
block|{
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
name|T4_MAX_RECV_SGE
condition|)
block|{
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
break|break;
block|}
name|wqe
operator|=
operator|(
expr|union
name|t4_recv_wr
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
operator|+
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|wq_pidx
operator|*
name|T4_EQ_ENTRY_SIZE
operator|)
expr_stmt|;
if|if
condition|(
name|num_wrs
condition|)
name|err
operator|=
name|build_rdma_recv
argument_list|(
name|qhp
argument_list|,
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|len16
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
break|break;
block|}
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|sw_rq
index|[
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|pidx
index|]
operator|.
name|wr_id
operator|=
name|wr
operator|->
name|wr_id
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|opcode
operator|=
name|FW_RI_RECV_WR
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|r1
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|wrid
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|pidx
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|r2
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|r2
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|r2
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|len16
operator|=
name|len16
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s cookie 0x%llx pidx %u"
argument_list|,
name|__func__
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|wr
operator|->
name|wr_id
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|pidx
argument_list|)
expr_stmt|;
name|t4_rq_produce
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|len16
argument_list|)
expr_stmt|;
name|idx
operator|+=
name|DIV_ROUND_UP
argument_list|(
name|len16
operator|*
literal|16
argument_list|,
name|T4_EQ_ENTRY_SIZE
argument_list|)
expr_stmt|;
name|wr
operator|=
name|wr
operator|->
name|next
expr_stmt|;
name|num_wrs
operator|--
expr_stmt|;
block|}
name|t4_ring_rq_db
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|c4iw_bind_mw
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|,
name|struct
name|ib_mw
modifier|*
name|mw
parameter_list|,
name|struct
name|ib_mw_bind
modifier|*
name|mw_bind
parameter_list|)
block|{
return|return
operator|-
name|ENOSYS
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|build_term_codes
parameter_list|(
name|struct
name|t4_cqe
modifier|*
name|err_cqe
parameter_list|,
name|u8
modifier|*
name|layer_type
parameter_list|,
name|u8
modifier|*
name|ecode
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|int
name|tagged
decl_stmt|;
name|int
name|opcode
decl_stmt|;
name|int
name|rqtype
decl_stmt|;
name|int
name|send_inv
decl_stmt|;
if|if
condition|(
operator|!
name|err_cqe
condition|)
block|{
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|DDP_LOCAL_CATA
expr_stmt|;
operator|*
name|ecode
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|status
operator|=
name|CQE_STATUS
argument_list|(
name|err_cqe
argument_list|)
expr_stmt|;
name|opcode
operator|=
name|CQE_OPCODE
argument_list|(
name|err_cqe
argument_list|)
expr_stmt|;
name|rqtype
operator|=
name|RQ_TYPE
argument_list|(
name|err_cqe
argument_list|)
expr_stmt|;
name|send_inv
operator|=
operator|(
name|opcode
operator|==
name|FW_RI_SEND_WITH_INV
operator|)
operator|||
operator|(
name|opcode
operator|==
name|FW_RI_SEND_WITH_SE_INV
operator|)
expr_stmt|;
name|tagged
operator|=
operator|(
name|opcode
operator|==
name|FW_RI_RDMA_WRITE
operator|)
operator|||
operator|(
name|rqtype
operator|&&
operator|(
name|opcode
operator|==
name|FW_RI_READ_RESP
operator|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|T4_ERR_STAG
case|:
if|if
condition|(
name|send_inv
condition|)
block|{
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_OP
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_CANT_INV_STAG
expr_stmt|;
block|}
else|else
block|{
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_INV_STAG
expr_stmt|;
block|}
break|break;
case|case
name|T4_ERR_PDID
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
if|if
condition|(
operator|(
name|opcode
operator|==
name|FW_RI_SEND_WITH_INV
operator|)
operator|||
operator|(
name|opcode
operator|==
name|FW_RI_SEND_WITH_SE_INV
operator|)
condition|)
operator|*
name|ecode
operator|=
name|RDMAP_CANT_INV_STAG
expr_stmt|;
else|else
operator|*
name|ecode
operator|=
name|RDMAP_STAG_NOT_ASSOC
expr_stmt|;
break|break;
case|case
name|T4_ERR_QPID
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_STAG_NOT_ASSOC
expr_stmt|;
break|break;
case|case
name|T4_ERR_ACCESS
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_ACC_VIOL
expr_stmt|;
break|break;
case|case
name|T4_ERR_WRAP
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_TO_WRAP
expr_stmt|;
break|break;
case|case
name|T4_ERR_BOUND
case|:
if|if
condition|(
name|tagged
condition|)
block|{
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_TAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPT_BASE_BOUNDS
expr_stmt|;
block|}
else|else
block|{
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_PROT
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_BASE_BOUNDS
expr_stmt|;
block|}
break|break;
case|case
name|T4_ERR_INVALIDATE_SHARED_MR
case|:
case|case
name|T4_ERR_INVALIDATE_MR_WITH_MW_BOUND
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_OP
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_CANT_INV_STAG
expr_stmt|;
break|break;
case|case
name|T4_ERR_ECC
case|:
case|case
name|T4_ERR_ECC_PSTAG
case|:
case|case
name|T4_ERR_INTERNAL_ERR
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_LOCAL_CATA
expr_stmt|;
operator|*
name|ecode
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|T4_ERR_OUT_OF_RQE
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_INV_MSN_NOBUF
expr_stmt|;
break|break;
case|case
name|T4_ERR_PBL_ADDR_BOUND
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_TAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPT_BASE_BOUNDS
expr_stmt|;
break|break;
case|case
name|T4_ERR_CRC
case|:
operator|*
name|layer_type
operator|=
name|LAYER_MPA
operator||
name|DDP_LLP
expr_stmt|;
operator|*
name|ecode
operator|=
name|MPA_CRC_ERR
expr_stmt|;
break|break;
case|case
name|T4_ERR_MARKER
case|:
operator|*
name|layer_type
operator|=
name|LAYER_MPA
operator||
name|DDP_LLP
expr_stmt|;
operator|*
name|ecode
operator|=
name|MPA_MARKER_ERR
expr_stmt|;
break|break;
case|case
name|T4_ERR_PDU_LEN_ERR
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_MSG_TOOBIG
expr_stmt|;
break|break;
case|case
name|T4_ERR_DDP_VERSION
case|:
if|if
condition|(
name|tagged
condition|)
block|{
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_TAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPT_INV_VERS
expr_stmt|;
block|}
else|else
block|{
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_INV_VERS
expr_stmt|;
block|}
break|break;
case|case
name|T4_ERR_RDMA_VERSION
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_OP
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_INV_VERS
expr_stmt|;
break|break;
case|case
name|T4_ERR_OPCODE
case|:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|RDMAP_REMOTE_OP
expr_stmt|;
operator|*
name|ecode
operator|=
name|RDMAP_INV_OPCODE
expr_stmt|;
break|break;
case|case
name|T4_ERR_DDP_QUEUE_NUM
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_INV_QN
expr_stmt|;
break|break;
case|case
name|T4_ERR_MSN
case|:
case|case
name|T4_ERR_MSN_GAP
case|:
case|case
name|T4_ERR_MSN_RANGE
case|:
case|case
name|T4_ERR_IRD_OVERFLOW
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_INV_MSN_RANGE
expr_stmt|;
break|break;
case|case
name|T4_ERR_TBIT
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_LOCAL_CATA
expr_stmt|;
operator|*
name|ecode
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|T4_ERR_MO
case|:
operator|*
name|layer_type
operator|=
name|LAYER_DDP
operator||
name|DDP_UNTAGGED_ERR
expr_stmt|;
operator|*
name|ecode
operator|=
name|DDPU_INV_MO
expr_stmt|;
break|break;
default|default:
operator|*
name|layer_type
operator|=
name|LAYER_RDMAP
operator||
name|DDP_LOCAL_CATA
expr_stmt|;
operator|*
name|ecode
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|post_terminate
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|,
name|struct
name|t4_cqe
modifier|*
name|err_cqe
parameter_list|,
name|gfp_t
name|gfp
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|fw_ri_wr
modifier|*
name|wqe
decl_stmt|;
name|struct
name|terminate_message
modifier|*
name|term
decl_stmt|;
name|struct
name|wrqe
modifier|*
name|wr
decl_stmt|;
name|struct
name|socket
modifier|*
name|so
init|=
name|qhp
operator|->
name|ep
operator|->
name|com
operator|.
name|so
decl_stmt|;
name|struct
name|inpcb
modifier|*
name|inp
init|=
name|sotoinpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
name|struct
name|tcpcb
modifier|*
name|tp
init|=
name|intotcpcb
argument_list|(
name|inp
argument_list|)
decl_stmt|;
name|struct
name|toepcb
modifier|*
name|toep
init|=
name|tp
operator|->
name|t_toe
decl_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s qhp %p qid 0x%x tid %u"
argument_list|,
name|__func__
argument_list|,
name|qhp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|,
name|qhp
operator|->
name|ep
operator|->
name|hwtid
argument_list|)
expr_stmt|;
name|wr
operator|=
name|alloc_wrqe
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
argument_list|,
name|toep
operator|->
name|ofld_txq
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|==
name|NULL
condition|)
return|return;
name|wqe
operator|=
name|wrtod
argument_list|(
name|wr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wqe
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|wqe
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|op_compl
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_OP
argument_list|(
name|FW_RI_WR
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|flowid_len16
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_FLOWID
argument_list|(
name|qhp
operator|->
name|ep
operator|->
name|hwtid
argument_list|)
operator||
name|V_FW_WR_LEN16
argument_list|(
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
expr|*
name|wqe
argument_list|,
literal|16
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|terminate
operator|.
name|type
operator|=
name|FW_RI_TYPE_TERMINATE
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|terminate
operator|.
name|immdlen
operator|=
name|cpu_to_be32
argument_list|(
sizeof|sizeof
expr|*
name|term
argument_list|)
expr_stmt|;
name|term
operator|=
operator|(
expr|struct
name|terminate_message
operator|*
operator|)
name|wqe
operator|->
name|u
operator|.
name|terminate
operator|.
name|termmsg
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|layer_etype
operator|==
operator|(
name|LAYER_MPA
operator||
name|DDP_LLP
operator|)
condition|)
block|{
name|term
operator|->
name|layer_etype
operator|=
name|qhp
operator|->
name|attr
operator|.
name|layer_etype
expr_stmt|;
name|term
operator|->
name|ecode
operator|=
name|qhp
operator|->
name|attr
operator|.
name|ecode
expr_stmt|;
block|}
else|else
name|build_term_codes
argument_list|(
name|err_cqe
argument_list|,
operator|&
name|term
operator|->
name|layer_etype
argument_list|,
operator|&
name|term
operator|->
name|ecode
argument_list|)
expr_stmt|;
name|ret
operator|=
name|creds
argument_list|(
name|toep
argument_list|,
name|inp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_wrqe
argument_list|(
name|wr
argument_list|)
expr_stmt|;
return|return;
block|}
name|t4_wrq_tx
argument_list|(
name|qhp
operator|->
name|rhp
operator|->
name|rdev
operator|.
name|adap
argument_list|,
name|wr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Assumes qhp lock is held. */
end_comment

begin_function
specifier|static
name|void
name|__flush_qp
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|,
name|struct
name|c4iw_cq
modifier|*
name|rchp
parameter_list|,
name|struct
name|c4iw_cq
modifier|*
name|schp
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|int
name|flushed
decl_stmt|;
name|unsigned
name|long
name|flag
decl_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s qhp %p rchp %p schp %p"
argument_list|,
name|__func__
argument_list|,
name|qhp
argument_list|,
name|rchp
argument_list|,
name|schp
argument_list|)
expr_stmt|;
comment|/* locking hierarchy: cq lock first, then qp lock. */
name|spin_lock_irqsave
argument_list|(
operator|&
name|rchp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|c4iw_flush_hw_cq
argument_list|(
operator|&
name|rchp
operator|->
name|cq
argument_list|)
expr_stmt|;
name|c4iw_count_rcqes
argument_list|(
operator|&
name|rchp
operator|->
name|cq
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|flushed
operator|=
name|c4iw_flush_rq
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|rchp
operator|->
name|cq
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rchp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|flushed
operator|&&
name|rchp
operator|->
name|ibcq
operator|.
name|comp_handler
condition|)
block|{
name|spin_lock_irqsave
argument_list|(
operator|&
name|rchp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
call|(
modifier|*
name|rchp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|rchp
operator|->
name|ibcq
argument_list|,
name|rchp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rchp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
block|}
comment|/* locking hierarchy: cq lock first, then qp lock. */
name|spin_lock_irqsave
argument_list|(
operator|&
name|schp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|c4iw_flush_hw_cq
argument_list|(
operator|&
name|schp
operator|->
name|cq
argument_list|)
expr_stmt|;
name|c4iw_count_scqes
argument_list|(
operator|&
name|schp
operator|->
name|cq
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|flushed
operator|=
name|c4iw_flush_sq
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|schp
operator|->
name|cq
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|schp
operator|->
name|lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|flushed
operator|&&
name|schp
operator|->
name|ibcq
operator|.
name|comp_handler
condition|)
block|{
name|spin_lock_irqsave
argument_list|(
operator|&
name|schp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
call|(
modifier|*
name|schp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|schp
operator|->
name|ibcq
argument_list|,
name|schp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|schp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|flush_qp
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|)
block|{
name|struct
name|c4iw_cq
modifier|*
name|rchp
decl_stmt|,
modifier|*
name|schp
decl_stmt|;
name|unsigned
name|long
name|flag
decl_stmt|;
name|rchp
operator|=
name|get_chp
argument_list|(
name|qhp
operator|->
name|rhp
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|rcq
argument_list|)
expr_stmt|;
name|schp
operator|=
name|get_chp
argument_list|(
name|qhp
operator|->
name|rhp
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|scq
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|ibqp
operator|.
name|uobject
condition|)
block|{
name|t4_set_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
expr_stmt|;
name|t4_set_cq_in_error
argument_list|(
operator|&
name|rchp
operator|->
name|cq
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|rchp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
call|(
modifier|*
name|rchp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|rchp
operator|->
name|ibcq
argument_list|,
name|rchp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rchp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|schp
operator|!=
name|rchp
condition|)
block|{
name|t4_set_cq_in_error
argument_list|(
operator|&
name|schp
operator|->
name|cq
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|schp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
call|(
modifier|*
name|schp
operator|->
name|ibcq
operator|.
name|comp_handler
call|)
argument_list|(
operator|&
name|schp
operator|->
name|ibcq
argument_list|,
name|schp
operator|->
name|ibcq
operator|.
name|cq_context
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|schp
operator|->
name|comp_handler_lock
argument_list|,
name|flag
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|__flush_qp
argument_list|(
name|qhp
argument_list|,
name|rchp
argument_list|,
name|schp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rdma_fini
parameter_list|(
name|struct
name|c4iw_dev
modifier|*
name|rhp
parameter_list|,
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|,
name|struct
name|c4iw_ep
modifier|*
name|ep
parameter_list|)
block|{
name|struct
name|c4iw_rdev
modifier|*
name|rdev
init|=
operator|&
name|rhp
operator|->
name|rdev
decl_stmt|;
name|struct
name|adapter
modifier|*
name|sc
init|=
name|rdev
operator|->
name|adap
decl_stmt|;
name|struct
name|fw_ri_wr
modifier|*
name|wqe
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|wrqe
modifier|*
name|wr
decl_stmt|;
name|struct
name|socket
modifier|*
name|so
init|=
name|ep
operator|->
name|com
operator|.
name|so
decl_stmt|;
name|struct
name|inpcb
modifier|*
name|inp
init|=
name|sotoinpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
name|struct
name|tcpcb
modifier|*
name|tp
init|=
name|intotcpcb
argument_list|(
name|inp
argument_list|)
decl_stmt|;
name|struct
name|toepcb
modifier|*
name|toep
init|=
name|tp
operator|->
name|t_toe
decl_stmt|;
name|KASSERT
argument_list|(
name|rhp
operator|==
name|qhp
operator|->
name|rhp
operator|&&
name|ep
operator|==
name|qhp
operator|->
name|ep
argument_list|,
operator|(
literal|"%s: EDOOFUS"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s qhp %p qid 0x%x tid %u"
argument_list|,
name|__func__
argument_list|,
name|qhp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|,
name|ep
operator|->
name|hwtid
argument_list|)
expr_stmt|;
name|wr
operator|=
name|alloc_wrqe
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
argument_list|,
name|toep
operator|->
name|ofld_txq
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|wqe
operator|=
name|wrtod
argument_list|(
name|wr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wqe
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|wqe
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|op_compl
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_OP
argument_list|(
name|FW_RI_WR
argument_list|)
operator||
name|F_FW_WR_COMPL
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|flowid_len16
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_FLOWID
argument_list|(
name|ep
operator|->
name|hwtid
argument_list|)
operator||
name|V_FW_WR_LEN16
argument_list|(
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
expr|*
name|wqe
argument_list|,
literal|16
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|cookie
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|&
name|ep
operator|->
name|com
operator|.
name|wr_wait
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|fini
operator|.
name|type
operator|=
name|FW_RI_TYPE_FINI
expr_stmt|;
name|c4iw_init_wr_wait
argument_list|(
operator|&
name|ep
operator|->
name|com
operator|.
name|wr_wait
argument_list|)
expr_stmt|;
name|ret
operator|=
name|creds
argument_list|(
name|toep
argument_list|,
name|inp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_wrqe
argument_list|(
name|wr
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|t4_wrq_tx
argument_list|(
name|sc
argument_list|,
name|wr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|c4iw_wait_for_reply
argument_list|(
name|rdev
argument_list|,
operator|&
name|ep
operator|->
name|com
operator|.
name|wr_wait
argument_list|,
name|ep
operator|->
name|hwtid
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|build_rtr_msg
parameter_list|(
name|u8
name|p2p_type
parameter_list|,
name|struct
name|fw_ri_init
modifier|*
name|init
parameter_list|)
block|{
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s p2p_type = %d"
argument_list|,
name|__func__
argument_list|,
name|p2p_type
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|init
operator|->
name|u
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|init
operator|->
name|u
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|p2p_type
condition|)
block|{
case|case
name|FW_RI_INIT_P2PTYPE_RDMA_WRITE
case|:
name|init
operator|->
name|u
operator|.
name|write
operator|.
name|opcode
operator|=
name|FW_RI_RDMA_WRITE_WR
expr_stmt|;
name|init
operator|->
name|u
operator|.
name|write
operator|.
name|stag_sink
operator|=
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|init
operator|->
name|u
operator|.
name|write
operator|.
name|to_sink
operator|=
name|cpu_to_be64
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|init
operator|->
name|u
operator|.
name|write
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|op
operator|=
name|FW_RI_DATA_IMMD
expr_stmt|;
name|init
operator|->
name|u
operator|.
name|write
operator|.
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
name|init
operator|->
name|u
operator|.
name|write
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_immd
argument_list|)
argument_list|,
literal|16
argument_list|)
expr_stmt|;
break|break;
case|case
name|FW_RI_INIT_P2PTYPE_READ_REQ
case|:
name|init
operator|->
name|u
operator|.
name|write
operator|.
name|opcode
operator|=
name|FW_RI_RDMA_READ_WR
expr_stmt|;
name|init
operator|->
name|u
operator|.
name|read
operator|.
name|stag_src
operator|=
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|init
operator|->
name|u
operator|.
name|read
operator|.
name|to_src_lo
operator|=
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|init
operator|->
name|u
operator|.
name|read
operator|.
name|stag_sink
operator|=
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|init
operator|->
name|u
operator|.
name|read
operator|.
name|to_sink_lo
operator|=
name|cpu_to_be32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|init
operator|->
name|u
operator|.
name|read
operator|.
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
name|init
operator|->
name|u
operator|.
name|read
argument_list|,
literal|16
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|creds
parameter_list|(
name|struct
name|toepcb
modifier|*
name|toep
parameter_list|,
name|struct
name|inpcb
modifier|*
name|inp
parameter_list|,
name|size_t
name|wrsize
parameter_list|)
block|{
name|struct
name|ofld_tx_sdesc
modifier|*
name|txsd
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:creB  %p %u"
argument_list|,
name|__func__
argument_list|,
name|toep
argument_list|,
name|wrsize
argument_list|)
expr_stmt|;
name|INP_WLOCK
argument_list|(
name|inp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|inp
operator|->
name|inp_flags
operator|&
operator|(
name|INP_DROPPED
operator||
name|INP_TIMEWAIT
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|INP_WUNLOCK
argument_list|(
name|inp
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|txsd
operator|=
operator|&
name|toep
operator|->
name|txsd
index|[
name|toep
operator|->
name|txsd_pidx
index|]
expr_stmt|;
name|txsd
operator|->
name|tx_credits
operator|=
name|howmany
argument_list|(
name|wrsize
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|txsd
operator|->
name|plen
operator|=
literal|0
expr_stmt|;
name|KASSERT
argument_list|(
name|toep
operator|->
name|tx_credits
operator|>=
name|txsd
operator|->
name|tx_credits
operator|&&
name|toep
operator|->
name|txsd_avail
operator|>
literal|0
argument_list|,
operator|(
literal|"%s: not enough credits (%d)"
operator|,
name|__func__
operator|,
name|toep
operator|->
name|tx_credits
operator|)
argument_list|)
expr_stmt|;
name|toep
operator|->
name|tx_credits
operator|-=
name|txsd
operator|->
name|tx_credits
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
operator|++
name|toep
operator|->
name|txsd_pidx
operator|==
name|toep
operator|->
name|txsd_total
argument_list|)
condition|)
name|toep
operator|->
name|txsd_pidx
operator|=
literal|0
expr_stmt|;
name|toep
operator|->
name|txsd_avail
operator|--
expr_stmt|;
name|INP_WUNLOCK
argument_list|(
name|inp
argument_list|)
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:creE  %p %u %u %u"
argument_list|,
name|__func__
argument_list|,
name|toep
argument_list|,
name|txsd
operator|->
name|tx_credits
argument_list|,
name|toep
operator|->
name|tx_credits
argument_list|,
name|toep
operator|->
name|txsd_pidx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rdma_init
parameter_list|(
name|struct
name|c4iw_dev
modifier|*
name|rhp
parameter_list|,
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|)
block|{
name|struct
name|fw_ri_wr
modifier|*
name|wqe
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|wrqe
modifier|*
name|wr
decl_stmt|;
name|struct
name|c4iw_ep
modifier|*
name|ep
init|=
name|qhp
operator|->
name|ep
decl_stmt|;
name|struct
name|c4iw_rdev
modifier|*
name|rdev
init|=
operator|&
name|qhp
operator|->
name|rhp
operator|->
name|rdev
decl_stmt|;
name|struct
name|adapter
modifier|*
name|sc
init|=
name|rdev
operator|->
name|adap
decl_stmt|;
name|struct
name|socket
modifier|*
name|so
init|=
name|ep
operator|->
name|com
operator|.
name|so
decl_stmt|;
name|struct
name|inpcb
modifier|*
name|inp
init|=
name|sotoinpcb
argument_list|(
name|so
argument_list|)
decl_stmt|;
name|struct
name|tcpcb
modifier|*
name|tp
init|=
name|intotcpcb
argument_list|(
name|inp
argument_list|)
decl_stmt|;
name|struct
name|toepcb
modifier|*
name|toep
init|=
name|tp
operator|->
name|t_toe
decl_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s qhp %p qid 0x%x tid %u"
argument_list|,
name|__func__
argument_list|,
name|qhp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|,
name|ep
operator|->
name|hwtid
argument_list|)
expr_stmt|;
name|wr
operator|=
name|alloc_wrqe
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
argument_list|,
name|toep
operator|->
name|ofld_txq
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|wqe
operator|=
name|wrtod
argument_list|(
name|wr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wqe
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|wqe
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|op_compl
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_OP
argument_list|(
name|FW_RI_WR
argument_list|)
operator||
name|F_FW_WR_COMPL
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|flowid_len16
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_FLOWID
argument_list|(
name|ep
operator|->
name|hwtid
argument_list|)
operator||
name|V_FW_WR_LEN16
argument_list|(
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
expr|*
name|wqe
argument_list|,
literal|16
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|cookie
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|&
name|ep
operator|->
name|com
operator|.
name|wr_wait
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|type
operator|=
name|FW_RI_TYPE_INIT
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|mpareqbit_p2ptype
operator|=
name|V_FW_RI_WR_MPAREQBIT
argument_list|(
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|initiator
argument_list|)
operator||
name|V_FW_RI_WR_P2PTYPE
argument_list|(
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|p2p_type
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|mpa_attrs
operator|=
name|FW_RI_MPA_IETF_ENABLE
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|recv_marker_enabled
condition|)
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|mpa_attrs
operator||=
name|FW_RI_MPA_RX_MARKER_ENABLE
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|xmit_marker_enabled
condition|)
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|mpa_attrs
operator||=
name|FW_RI_MPA_TX_MARKER_ENABLE
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|crc_enabled
condition|)
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|mpa_attrs
operator||=
name|FW_RI_MPA_CRC_ENABLE
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|qp_caps
operator|=
name|FW_RI_QP_RDMA_READ_ENABLE
operator||
name|FW_RI_QP_RDMA_WRITE_ENABLE
operator||
name|FW_RI_QP_BIND_ENABLE
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
operator|->
name|ibqp
operator|.
name|uobject
condition|)
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|qp_caps
operator||=
name|FW_RI_QP_FAST_REGISTER_ENABLE
operator||
name|FW_RI_QP_STAG0_ENABLE
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|nrqe
operator|=
name|cpu_to_be16
argument_list|(
name|t4_rqes_posted
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|pdid
operator|=
name|cpu_to_be32
argument_list|(
name|qhp
operator|->
name|attr
operator|.
name|pd
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|qpid
operator|=
name|cpu_to_be32
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|sq_eqid
operator|=
name|cpu_to_be32
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|rq_eqid
operator|=
name|cpu_to_be32
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|scqid
operator|=
name|cpu_to_be32
argument_list|(
name|qhp
operator|->
name|attr
operator|.
name|scq
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|rcqid
operator|=
name|cpu_to_be32
argument_list|(
name|qhp
operator|->
name|attr
operator|.
name|rcq
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|ord_max
operator|=
name|cpu_to_be32
argument_list|(
name|qhp
operator|->
name|attr
operator|.
name|max_ord
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|ird_max
operator|=
name|cpu_to_be32
argument_list|(
name|qhp
operator|->
name|attr
operator|.
name|max_ird
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|iss
operator|=
name|cpu_to_be32
argument_list|(
name|ep
operator|->
name|snd_seq
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|irs
operator|=
name|cpu_to_be32
argument_list|(
name|ep
operator|->
name|rcv_seq
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|hwrqsize
operator|=
name|cpu_to_be32
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|rqt_size
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|u
operator|.
name|init
operator|.
name|hwrqaddr
operator|=
name|cpu_to_be32
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|rqt_hwaddr
operator|-
name|sc
operator|->
name|vres
operator|.
name|rq
operator|.
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|initiator
condition|)
name|build_rtr_msg
argument_list|(
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|.
name|p2p_type
argument_list|,
operator|&
name|wqe
operator|->
name|u
operator|.
name|init
argument_list|)
expr_stmt|;
name|c4iw_init_wr_wait
argument_list|(
operator|&
name|ep
operator|->
name|com
operator|.
name|wr_wait
argument_list|)
expr_stmt|;
name|ret
operator|=
name|creds
argument_list|(
name|toep
argument_list|,
name|inp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wqe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_wrqe
argument_list|(
name|wr
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|t4_wrq_tx
argument_list|(
name|sc
argument_list|,
name|wr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|c4iw_wait_for_reply
argument_list|(
name|rdev
argument_list|,
operator|&
name|ep
operator|->
name|com
operator|.
name|wr_wait
argument_list|,
name|ep
operator|->
name|hwtid
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|toep
operator|->
name|ulp_mode
operator|=
name|ULP_MODE_RDMA
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|c4iw_modify_qp
parameter_list|(
name|struct
name|c4iw_dev
modifier|*
name|rhp
parameter_list|,
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|,
name|enum
name|c4iw_qp_attr_mask
name|mask
parameter_list|,
name|struct
name|c4iw_qp_attributes
modifier|*
name|attrs
parameter_list|,
name|int
name|internal
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|c4iw_qp_attributes
name|newattr
init|=
name|qhp
operator|->
name|attr
decl_stmt|;
name|int
name|disconnect
init|=
literal|0
decl_stmt|;
name|int
name|terminate
init|=
literal|0
decl_stmt|;
name|int
name|abort
init|=
literal|0
decl_stmt|;
name|int
name|free
init|=
literal|0
decl_stmt|;
name|struct
name|c4iw_ep
modifier|*
name|ep
init|=
name|NULL
decl_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s qhp %p sqid 0x%x rqid 0x%x ep %p"
argument_list|,
name|__func__
argument_list|,
name|qhp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|qid
argument_list|,
name|qhp
operator|->
name|ep
argument_list|)
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s state %d -> %d"
argument_list|,
name|__func__
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|state
argument_list|,
operator|(
name|mask
operator|&
name|C4IW_QP_ATTR_NEXT_STATE
operator|)
condition|?
name|attrs
operator|->
name|next_state
else|:
operator|-
literal|1
argument_list|)
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|qhp
operator|->
name|mutex
argument_list|)
expr_stmt|;
comment|/* Process attr changes if in IDLE */
if|if
condition|(
name|mask
operator|&
name|C4IW_QP_ATTR_VALID_MODIFY
condition|)
block|{
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|!=
name|C4IW_QP_STATE_IDLE
condition|)
block|{
name|ret
operator|=
operator|-
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|mask
operator|&
name|C4IW_QP_ATTR_ENABLE_RDMA_READ
condition|)
name|newattr
operator|.
name|enable_rdma_read
operator|=
name|attrs
operator|->
name|enable_rdma_read
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|C4IW_QP_ATTR_ENABLE_RDMA_WRITE
condition|)
name|newattr
operator|.
name|enable_rdma_write
operator|=
name|attrs
operator|->
name|enable_rdma_write
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|C4IW_QP_ATTR_ENABLE_RDMA_BIND
condition|)
name|newattr
operator|.
name|enable_bind
operator|=
name|attrs
operator|->
name|enable_bind
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|C4IW_QP_ATTR_MAX_ORD
condition|)
block|{
if|if
condition|(
name|attrs
operator|->
name|max_ord
operator|>
name|c4iw_max_read_depth
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|newattr
operator|.
name|max_ord
operator|=
name|attrs
operator|->
name|max_ord
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|C4IW_QP_ATTR_MAX_IRD
condition|)
block|{
if|if
condition|(
name|attrs
operator|->
name|max_ird
operator|>
name|c4iw_max_read_depth
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|newattr
operator|.
name|max_ird
operator|=
name|attrs
operator|->
name|max_ird
expr_stmt|;
block|}
name|qhp
operator|->
name|attr
operator|=
name|newattr
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|C4IW_QP_ATTR_NEXT_STATE
operator|)
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|==
name|attrs
operator|->
name|next_state
condition|)
goto|goto
name|out
goto|;
switch|switch
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
condition|)
block|{
case|case
name|C4IW_QP_STATE_IDLE
case|:
switch|switch
condition|(
name|attrs
operator|->
name|next_state
condition|)
block|{
case|case
name|C4IW_QP_STATE_RTS
case|:
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|C4IW_QP_ATTR_LLP_STREAM_HANDLE
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|C4IW_QP_ATTR_MPA_ATTR
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|qhp
operator|->
name|attr
operator|.
name|mpa_attr
operator|=
name|attrs
operator|->
name|mpa_attr
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|llp_stream_handle
operator|=
name|attrs
operator|->
name|llp_stream_handle
expr_stmt|;
name|qhp
operator|->
name|ep
operator|=
name|qhp
operator|->
name|attr
operator|.
name|llp_stream_handle
expr_stmt|;
name|set_state
argument_list|(
name|qhp
argument_list|,
name|C4IW_QP_STATE_RTS
argument_list|)
expr_stmt|;
comment|/* 			 * Ref the endpoint here and deref when we 			 * disassociate the endpoint from the QP.  This 			 * happens in CLOSING->IDLE transition or *->ERROR 			 * transition. 			 */
name|c4iw_get_ep
argument_list|(
operator|&
name|qhp
operator|->
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_init
argument_list|(
name|rhp
argument_list|,
name|qhp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
break|break;
case|case
name|C4IW_QP_STATE_ERROR
case|:
name|set_state
argument_list|(
name|qhp
argument_list|,
name|C4IW_QP_STATE_ERROR
argument_list|)
expr_stmt|;
name|flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
break|break;
case|case
name|C4IW_QP_STATE_RTS
case|:
switch|switch
condition|(
name|attrs
operator|->
name|next_state
condition|)
block|{
case|case
name|C4IW_QP_STATE_CLOSING
case|:
name|BUG_ON
argument_list|(
name|atomic_read
argument_list|(
operator|&
name|qhp
operator|->
name|ep
operator|->
name|com
operator|.
name|kref
operator|.
name|refcount
argument_list|)
operator|<
literal|2
argument_list|)
expr_stmt|;
name|set_state
argument_list|(
name|qhp
argument_list|,
name|C4IW_QP_STATE_CLOSING
argument_list|)
expr_stmt|;
name|ep
operator|=
name|qhp
operator|->
name|ep
expr_stmt|;
if|if
condition|(
operator|!
name|internal
condition|)
block|{
name|abort
operator|=
literal|0
expr_stmt|;
name|disconnect
operator|=
literal|1
expr_stmt|;
name|c4iw_get_ep
argument_list|(
operator|&
name|qhp
operator|->
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|qhp
operator|->
name|ibqp
operator|.
name|uobject
condition|)
name|t4_set_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_fini
argument_list|(
name|rhp
argument_list|,
name|qhp
argument_list|,
name|ep
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
break|break;
case|case
name|C4IW_QP_STATE_TERMINATE
case|:
name|set_state
argument_list|(
name|qhp
argument_list|,
name|C4IW_QP_STATE_TERMINATE
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|layer_etype
operator|=
name|attrs
operator|->
name|layer_etype
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|ecode
operator|=
name|attrs
operator|->
name|ecode
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|ibqp
operator|.
name|uobject
condition|)
name|t4_set_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
expr_stmt|;
name|ep
operator|=
name|qhp
operator|->
name|ep
expr_stmt|;
if|if
condition|(
operator|!
name|internal
condition|)
name|terminate
operator|=
literal|1
expr_stmt|;
name|disconnect
operator|=
literal|1
expr_stmt|;
name|c4iw_get_ep
argument_list|(
operator|&
name|qhp
operator|->
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
break|break;
case|case
name|C4IW_QP_STATE_ERROR
case|:
name|set_state
argument_list|(
name|qhp
argument_list|,
name|C4IW_QP_STATE_ERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|ibqp
operator|.
name|uobject
condition|)
name|t4_set_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|internal
condition|)
block|{
name|abort
operator|=
literal|1
expr_stmt|;
name|disconnect
operator|=
literal|1
expr_stmt|;
name|ep
operator|=
name|qhp
operator|->
name|ep
expr_stmt|;
name|c4iw_get_ep
argument_list|(
operator|&
name|qhp
operator|->
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
block|}
goto|goto
name|err
goto|;
break|break;
default|default:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
break|break;
case|case
name|C4IW_QP_STATE_CLOSING
case|:
comment|/* 		 * Allow kernel users to move to ERROR for qp draining. 		 */
if|if
condition|(
operator|!
name|internal
operator|&&
operator|(
name|qhp
operator|->
name|ibqp
operator|.
name|uobject
operator|||
name|attrs
operator|->
name|next_state
operator|!=
name|C4IW_QP_STATE_ERROR
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
switch|switch
condition|(
name|attrs
operator|->
name|next_state
condition|)
block|{
case|case
name|C4IW_QP_STATE_IDLE
case|:
name|flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|set_state
argument_list|(
name|qhp
argument_list|,
name|C4IW_QP_STATE_IDLE
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|llp_stream_handle
operator|=
name|NULL
expr_stmt|;
name|c4iw_put_ep
argument_list|(
operator|&
name|qhp
operator|->
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|ep
operator|=
name|NULL
expr_stmt|;
name|wake_up
argument_list|(
operator|&
name|qhp
operator|->
name|wait
argument_list|)
expr_stmt|;
break|break;
case|case
name|C4IW_QP_STATE_ERROR
case|:
goto|goto
name|err
goto|;
default|default:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|err
goto|;
block|}
break|break;
case|case
name|C4IW_QP_STATE_ERROR
case|:
if|if
condition|(
name|attrs
operator|->
name|next_state
operator|!=
name|C4IW_QP_STATE_IDLE
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|t4_sq_empty
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
operator|||
operator|!
name|t4_rq_empty
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|set_state
argument_list|(
name|qhp
argument_list|,
name|C4IW_QP_STATE_IDLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|C4IW_QP_STATE_TERMINATE
case|:
if|if
condition|(
operator|!
name|internal
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
goto|goto
name|err
goto|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%s in a bad state %d\n"
argument_list|,
name|__func__
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|err
goto|;
break|break;
block|}
goto|goto
name|out
goto|;
name|err
label|:
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s disassociating ep %p qpid 0x%x"
argument_list|,
name|__func__
argument_list|,
name|qhp
operator|->
name|ep
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
comment|/* disassociate the LLP connection */
name|qhp
operator|->
name|attr
operator|.
name|llp_stream_handle
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|ep
condition|)
name|ep
operator|=
name|qhp
operator|->
name|ep
expr_stmt|;
name|qhp
operator|->
name|ep
operator|=
name|NULL
expr_stmt|;
name|set_state
argument_list|(
name|qhp
argument_list|,
name|C4IW_QP_STATE_ERROR
argument_list|)
expr_stmt|;
name|free
operator|=
literal|1
expr_stmt|;
name|abort
operator|=
literal|1
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|ep
argument_list|)
expr_stmt|;
name|flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|wake_up
argument_list|(
operator|&
name|qhp
operator|->
name|wait
argument_list|)
expr_stmt|;
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|terminate
condition|)
name|post_terminate
argument_list|(
name|qhp
argument_list|,
name|NULL
argument_list|,
name|internal
condition|?
name|GFP_ATOMIC
else|:
name|GFP_KERNEL
argument_list|)
expr_stmt|;
comment|/* 	 * If disconnect is 1, then we need to initiate a disconnect 	 * on the EP.  This can be a normal close (RTS->CLOSING) or 	 * an abnormal close (RTS/CLOSING->ERROR). 	 */
if|if
condition|(
name|disconnect
condition|)
block|{
name|c4iw_ep_disconnect
argument_list|(
name|ep
argument_list|,
name|abort
argument_list|,
name|internal
condition|?
name|GFP_ATOMIC
else|:
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|c4iw_put_ep
argument_list|(
operator|&
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * If free is 1, then we've disassociated the EP from the QP 	 * and we need to dereference the EP. 	 */
if|if
condition|(
name|free
condition|)
name|c4iw_put_ep
argument_list|(
operator|&
name|ep
operator|->
name|com
argument_list|)
expr_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s exit state %d"
argument_list|,
name|__func__
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|state
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|c4iw_destroy_qp
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ib_qp
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
decl_stmt|;
name|struct
name|c4iw_qp_attributes
name|attrs
decl_stmt|;
name|struct
name|c4iw_ucontext
modifier|*
name|ucontext
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_qp %p"
argument_list|,
name|__func__
argument_list|,
name|ib_qp
argument_list|)
expr_stmt|;
name|qhp
operator|=
name|to_c4iw_qp
argument_list|(
name|ib_qp
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|qhp
operator|->
name|rhp
expr_stmt|;
name|attrs
operator|.
name|next_state
operator|=
name|C4IW_QP_STATE_ERROR
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|attr
operator|.
name|state
operator|==
name|C4IW_QP_STATE_TERMINATE
condition|)
name|c4iw_modify_qp
argument_list|(
name|rhp
argument_list|,
name|qhp
argument_list|,
name|C4IW_QP_ATTR_NEXT_STATE
argument_list|,
operator|&
name|attrs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|c4iw_modify_qp
argument_list|(
name|rhp
argument_list|,
name|qhp
argument_list|,
name|C4IW_QP_ATTR_NEXT_STATE
argument_list|,
operator|&
name|attrs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wait_event
argument_list|(
name|qhp
operator|->
name|wait
argument_list|,
operator|!
name|qhp
operator|->
name|ep
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|rhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|remove_handle_nolock
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|qpidr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|rhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|atomic_dec
argument_list|(
operator|&
name|qhp
operator|->
name|refcnt
argument_list|)
expr_stmt|;
name|wait_event
argument_list|(
name|qhp
operator|->
name|wait
argument_list|,
operator|!
name|atomic_read
argument_list|(
operator|&
name|qhp
operator|->
name|refcnt
argument_list|)
argument_list|)
expr_stmt|;
name|ucontext
operator|=
name|ib_qp
operator|->
name|uobject
condition|?
name|to_c4iw_ucontext
argument_list|(
name|ib_qp
operator|->
name|uobject
operator|->
name|context
argument_list|)
else|:
name|NULL
expr_stmt|;
name|destroy_qp
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|ucontext
condition|?
operator|&
name|ucontext
operator|->
name|uctx
else|:
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|uctx
argument_list|)
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_qp %p qpid 0x%0x"
argument_list|,
name|__func__
argument_list|,
name|ib_qp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ib_qp
modifier|*
name|c4iw_create_qp
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ib_qp_init_attr
modifier|*
name|attrs
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
decl_stmt|;
name|struct
name|c4iw_pd
modifier|*
name|php
decl_stmt|;
name|struct
name|c4iw_cq
modifier|*
name|schp
decl_stmt|;
name|struct
name|c4iw_cq
modifier|*
name|rchp
decl_stmt|;
name|struct
name|c4iw_create_qp_resp
name|uresp
decl_stmt|;
name|int
name|sqsize
decl_stmt|,
name|rqsize
decl_stmt|;
name|struct
name|c4iw_ucontext
modifier|*
name|ucontext
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|spg_ndesc
decl_stmt|;
name|struct
name|c4iw_mm_entry
modifier|*
name|mm1
decl_stmt|,
modifier|*
name|mm2
decl_stmt|,
modifier|*
name|mm3
decl_stmt|,
modifier|*
name|mm4
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_pd %p"
argument_list|,
name|__func__
argument_list|,
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|attrs
operator|->
name|qp_type
operator|!=
name|IB_QPT_RC
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|php
operator|=
name|to_c4iw_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|php
operator|->
name|rhp
expr_stmt|;
name|schp
operator|=
name|get_chp
argument_list|(
name|rhp
argument_list|,
operator|(
operator|(
expr|struct
name|c4iw_cq
operator|*
operator|)
name|attrs
operator|->
name|send_cq
operator|)
operator|->
name|cq
operator|.
name|cqid
argument_list|)
expr_stmt|;
name|rchp
operator|=
name|get_chp
argument_list|(
name|rhp
argument_list|,
operator|(
operator|(
expr|struct
name|c4iw_cq
operator|*
operator|)
name|attrs
operator|->
name|recv_cq
operator|)
operator|->
name|cq
operator|.
name|cqid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|schp
operator|||
operator|!
name|rchp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
if|if
condition|(
name|attrs
operator|->
name|cap
operator|.
name|max_inline_data
operator|>
name|T4_MAX_SEND_INLINE
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|spg_ndesc
operator|=
name|rhp
operator|->
name|rdev
operator|.
name|adap
operator|->
name|params
operator|.
name|sge
operator|.
name|spg_len
operator|/
name|EQ_ESIZE
expr_stmt|;
name|rqsize
operator|=
name|roundup
argument_list|(
name|attrs
operator|->
name|cap
operator|.
name|max_recv_wr
operator|+
literal|1
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|rqsize
operator|>
name|T4_MAX_RQ_SIZE
argument_list|(
name|spg_ndesc
argument_list|)
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|E2BIG
argument_list|)
return|;
name|sqsize
operator|=
name|roundup
argument_list|(
name|attrs
operator|->
name|cap
operator|.
name|max_send_wr
operator|+
literal|1
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|sqsize
operator|>
name|T4_MAX_SQ_SIZE
argument_list|(
name|spg_ndesc
argument_list|)
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|E2BIG
argument_list|)
return|;
name|ucontext
operator|=
name|pd
operator|->
name|uobject
condition|?
name|to_c4iw_ucontext
argument_list|(
name|pd
operator|->
name|uobject
operator|->
name|context
argument_list|)
else|:
name|NULL
expr_stmt|;
name|qhp
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|qhp
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
operator|=
name|sqsize
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
operator|=
operator|(
name|sqsize
operator|+
name|spg_ndesc
operator|)
operator|*
sizeof|sizeof
expr|*
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
operator|+
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|__be64
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
operator|=
name|rqsize
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
operator|=
operator|(
name|rqsize
operator|+
name|spg_ndesc
operator|)
operator|*
sizeof|sizeof
expr|*
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
expr_stmt|;
if|if
condition|(
name|ucontext
condition|)
block|{
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
operator|=
name|roundup
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
operator|=
name|roundup
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
block|}
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s sqsize %u sqmemsize %zu rqsize %u rqmemsize %zu"
argument_list|,
name|__func__
argument_list|,
name|sqsize
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|,
name|rqsize
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|ret
operator|=
name|create_qp
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|schp
operator|->
name|cq
argument_list|,
operator|&
name|rchp
operator|->
name|cq
argument_list|,
name|ucontext
condition|?
operator|&
name|ucontext
operator|->
name|uctx
else|:
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|uctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err1
goto|;
name|attrs
operator|->
name|cap
operator|.
name|max_recv_wr
operator|=
name|rqsize
operator|-
literal|1
expr_stmt|;
name|attrs
operator|->
name|cap
operator|.
name|max_send_wr
operator|=
name|sqsize
operator|-
literal|1
expr_stmt|;
name|attrs
operator|->
name|cap
operator|.
name|max_inline_data
operator|=
name|T4_MAX_SEND_INLINE
expr_stmt|;
name|qhp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|pd
operator|=
name|php
operator|->
name|pdid
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|scq
operator|=
operator|(
operator|(
expr|struct
name|c4iw_cq
operator|*
operator|)
name|attrs
operator|->
name|send_cq
operator|)
operator|->
name|cq
operator|.
name|cqid
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|rcq
operator|=
operator|(
operator|(
expr|struct
name|c4iw_cq
operator|*
operator|)
name|attrs
operator|->
name|recv_cq
operator|)
operator|->
name|cq
operator|.
name|cqid
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|sq_num_entries
operator|=
name|attrs
operator|->
name|cap
operator|.
name|max_send_wr
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|rq_num_entries
operator|=
name|attrs
operator|->
name|cap
operator|.
name|max_recv_wr
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|sq_max_sges
operator|=
name|attrs
operator|->
name|cap
operator|.
name|max_send_sge
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|sq_max_sges_rdma_write
operator|=
name|attrs
operator|->
name|cap
operator|.
name|max_send_sge
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|rq_max_sges
operator|=
name|attrs
operator|->
name|cap
operator|.
name|max_recv_sge
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|state
operator|=
name|C4IW_QP_STATE_IDLE
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|next_state
operator|=
name|C4IW_QP_STATE_IDLE
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|enable_rdma_read
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|enable_rdma_write
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|enable_bind
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|max_ord
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|attr
operator|.
name|max_ird
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|sq_sig_all
operator|=
name|attrs
operator|->
name|sq_sig_type
operator|==
name|IB_SIGNAL_ALL_WR
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|qhp
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|init_waitqueue_head
argument_list|(
operator|&
name|qhp
operator|->
name|wait
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|qhp
operator|->
name|refcnt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|rhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|insert_handle_nolock
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|qpidr
argument_list|,
name|qhp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|rhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err2
goto|;
if|if
condition|(
name|udata
condition|)
block|{
name|mm1
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mm1
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm1
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|mm2
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mm2
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm2
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err4
goto|;
block|}
name|mm3
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mm3
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm3
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err5
goto|;
block|}
name|mm4
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|mm4
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm4
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err6
goto|;
block|}
name|uresp
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|uresp
operator|.
name|qid_mask
operator|=
name|rhp
operator|->
name|rdev
operator|.
name|qpmask
expr_stmt|;
name|uresp
operator|.
name|sqid
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
expr_stmt|;
name|uresp
operator|.
name|sq_size
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
expr_stmt|;
name|uresp
operator|.
name|sq_memsize
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
expr_stmt|;
name|uresp
operator|.
name|rqid
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|qid
expr_stmt|;
name|uresp
operator|.
name|rq_size
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
expr_stmt|;
name|uresp
operator|.
name|rq_memsize
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|ucontext
operator|->
name|mmap_lock
argument_list|)
expr_stmt|;
name|uresp
operator|.
name|sq_key
operator|=
name|ucontext
operator|->
name|key
expr_stmt|;
name|ucontext
operator|->
name|key
operator|+=
name|PAGE_SIZE
expr_stmt|;
name|uresp
operator|.
name|rq_key
operator|=
name|ucontext
operator|->
name|key
expr_stmt|;
name|ucontext
operator|->
name|key
operator|+=
name|PAGE_SIZE
expr_stmt|;
name|uresp
operator|.
name|sq_db_gts_key
operator|=
name|ucontext
operator|->
name|key
expr_stmt|;
name|ucontext
operator|->
name|key
operator|+=
name|PAGE_SIZE
expr_stmt|;
name|uresp
operator|.
name|rq_db_gts_key
operator|=
name|ucontext
operator|->
name|key
expr_stmt|;
name|ucontext
operator|->
name|key
operator|+=
name|PAGE_SIZE
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|ucontext
operator|->
name|mmap_lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|uresp
argument_list|,
sizeof|sizeof
name|uresp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err7
goto|;
name|mm1
operator|->
name|key
operator|=
name|uresp
operator|.
name|sq_key
expr_stmt|;
name|mm1
operator|->
name|addr
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|phys_addr
expr_stmt|;
name|mm1
operator|->
name|len
operator|=
name|PAGE_ALIGN
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s mm1 %x, %x, %d"
argument_list|,
name|__func__
argument_list|,
name|mm1
operator|->
name|key
argument_list|,
name|mm1
operator|->
name|addr
argument_list|,
name|mm1
operator|->
name|len
argument_list|)
expr_stmt|;
name|insert_mmap
argument_list|(
name|ucontext
argument_list|,
name|mm1
argument_list|)
expr_stmt|;
name|mm2
operator|->
name|key
operator|=
name|uresp
operator|.
name|rq_key
expr_stmt|;
name|mm2
operator|->
name|addr
operator|=
name|vtophys
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
argument_list|)
expr_stmt|;
name|mm2
operator|->
name|len
operator|=
name|PAGE_ALIGN
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s mm2 %x, %x, %d"
argument_list|,
name|__func__
argument_list|,
name|mm2
operator|->
name|key
argument_list|,
name|mm2
operator|->
name|addr
argument_list|,
name|mm2
operator|->
name|len
argument_list|)
expr_stmt|;
name|insert_mmap
argument_list|(
name|ucontext
argument_list|,
name|mm2
argument_list|)
expr_stmt|;
name|mm3
operator|->
name|key
operator|=
name|uresp
operator|.
name|sq_db_gts_key
expr_stmt|;
name|mm3
operator|->
name|addr
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|udb
expr_stmt|;
name|mm3
operator|->
name|len
operator|=
name|PAGE_SIZE
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s mm3 %x, %x, %d"
argument_list|,
name|__func__
argument_list|,
name|mm3
operator|->
name|key
argument_list|,
name|mm3
operator|->
name|addr
argument_list|,
name|mm3
operator|->
name|len
argument_list|)
expr_stmt|;
name|insert_mmap
argument_list|(
name|ucontext
argument_list|,
name|mm3
argument_list|)
expr_stmt|;
name|mm4
operator|->
name|key
operator|=
name|uresp
operator|.
name|rq_db_gts_key
expr_stmt|;
name|mm4
operator|->
name|addr
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|udb
expr_stmt|;
name|mm4
operator|->
name|len
operator|=
name|PAGE_SIZE
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s mm4 %x, %x, %d"
argument_list|,
name|__func__
argument_list|,
name|mm4
operator|->
name|key
argument_list|,
name|mm4
operator|->
name|addr
argument_list|,
name|mm4
operator|->
name|len
argument_list|)
expr_stmt|;
name|insert_mmap
argument_list|(
name|ucontext
argument_list|,
name|mm4
argument_list|)
expr_stmt|;
block|}
name|qhp
operator|->
name|ibqp
operator|.
name|qp_num
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
expr_stmt|;
name|init_timer
argument_list|(
operator|&
operator|(
name|qhp
operator|->
name|timer
operator|)
argument_list|)
expr_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s qhp %p sq_num_entries %d, rq_num_entries %d qpid 0x%0x"
argument_list|,
name|__func__
argument_list|,
name|qhp
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|sq_num_entries
argument_list|,
name|qhp
operator|->
name|attr
operator|.
name|rq_num_entries
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
return|return
operator|&
name|qhp
operator|->
name|ibqp
return|;
name|err7
label|:
name|kfree
argument_list|(
name|mm4
argument_list|)
expr_stmt|;
name|err6
label|:
name|kfree
argument_list|(
name|mm3
argument_list|)
expr_stmt|;
name|err5
label|:
name|kfree
argument_list|(
name|mm2
argument_list|)
expr_stmt|;
name|err4
label|:
name|kfree
argument_list|(
name|mm1
argument_list|)
expr_stmt|;
name|err3
label|:
name|remove_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|qpidr
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|)
expr_stmt|;
name|err2
label|:
name|destroy_qp
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|ucontext
condition|?
operator|&
name|ucontext
operator|->
name|uctx
else|:
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|uctx
argument_list|)
expr_stmt|;
name|err1
label|:
name|kfree
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|c4iw_ib_modify_qp
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ib_qp_attr
modifier|*
name|attr
parameter_list|,
name|int
name|attr_mask
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
decl_stmt|;
name|enum
name|c4iw_qp_attr_mask
name|mask
init|=
literal|0
decl_stmt|;
name|struct
name|c4iw_qp_attributes
name|attrs
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_qp %p"
argument_list|,
name|__func__
argument_list|,
name|ibqp
argument_list|)
expr_stmt|;
comment|/* iwarp does not support the RTR state */
if|if
condition|(
operator|(
name|attr_mask
operator|&
name|IB_QP_STATE
operator|)
operator|&&
operator|(
name|attr
operator|->
name|qp_state
operator|==
name|IB_QPS_RTR
operator|)
condition|)
name|attr_mask
operator|&=
operator|~
name|IB_QP_STATE
expr_stmt|;
comment|/* Make sure we still have something left to do */
if|if
condition|(
operator|!
name|attr_mask
condition|)
return|return
literal|0
return|;
name|memset
argument_list|(
operator|&
name|attrs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|attrs
argument_list|)
expr_stmt|;
name|qhp
operator|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|qhp
operator|->
name|rhp
expr_stmt|;
name|attrs
operator|.
name|next_state
operator|=
name|c4iw_convert_state
argument_list|(
name|attr
operator|->
name|qp_state
argument_list|)
expr_stmt|;
name|attrs
operator|.
name|enable_rdma_read
operator|=
operator|(
name|attr
operator|->
name|qp_access_flags
operator|&
name|IB_ACCESS_REMOTE_READ
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|attrs
operator|.
name|enable_rdma_write
operator|=
operator|(
name|attr
operator|->
name|qp_access_flags
operator|&
name|IB_ACCESS_REMOTE_WRITE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|attrs
operator|.
name|enable_bind
operator|=
operator|(
name|attr
operator|->
name|qp_access_flags
operator|&
name|IB_ACCESS_MW_BIND
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|mask
operator||=
operator|(
name|attr_mask
operator|&
name|IB_QP_STATE
operator|)
condition|?
name|C4IW_QP_ATTR_NEXT_STATE
else|:
literal|0
expr_stmt|;
name|mask
operator||=
operator|(
name|attr_mask
operator|&
name|IB_QP_ACCESS_FLAGS
operator|)
condition|?
operator|(
name|C4IW_QP_ATTR_ENABLE_RDMA_READ
operator||
name|C4IW_QP_ATTR_ENABLE_RDMA_WRITE
operator||
name|C4IW_QP_ATTR_ENABLE_RDMA_BIND
operator|)
else|:
literal|0
expr_stmt|;
return|return
name|c4iw_modify_qp
argument_list|(
name|rhp
argument_list|,
name|qhp
argument_list|,
name|mask
argument_list|,
operator|&
name|attrs
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|ib_qp
modifier|*
name|c4iw_get_qp
parameter_list|(
name|struct
name|ib_device
modifier|*
name|dev
parameter_list|,
name|int
name|qpn
parameter_list|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_dev %p qpn 0x%x"
argument_list|,
name|__func__
argument_list|,
name|dev
argument_list|,
name|qpn
argument_list|)
expr_stmt|;
return|return
operator|(
expr|struct
name|ib_qp
operator|*
operator|)
name|get_qhp
argument_list|(
name|to_c4iw_dev
argument_list|(
name|dev
argument_list|)
argument_list|,
name|qpn
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|c4iw_ib_query_qp
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ib_qp_attr
modifier|*
name|attr
parameter_list|,
name|int
name|attr_mask
parameter_list|,
name|struct
name|ib_qp_init_attr
modifier|*
name|init_attr
parameter_list|)
block|{
name|struct
name|c4iw_qp
modifier|*
name|qhp
init|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
decl_stmt|;
name|memset
argument_list|(
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|attr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|init_attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|init_attr
argument_list|)
expr_stmt|;
name|attr
operator|->
name|qp_state
operator|=
name|to_ib_qp_state
argument_list|(
name|qhp
operator|->
name|attr
operator|.
name|state
argument_list|)
expr_stmt|;
name|init_attr
operator|->
name|cap
operator|.
name|max_send_wr
operator|=
name|qhp
operator|->
name|attr
operator|.
name|sq_num_entries
expr_stmt|;
name|init_attr
operator|->
name|cap
operator|.
name|max_recv_wr
operator|=
name|qhp
operator|->
name|attr
operator|.
name|rq_num_entries
expr_stmt|;
name|init_attr
operator|->
name|cap
operator|.
name|max_send_sge
operator|=
name|qhp
operator|->
name|attr
operator|.
name|sq_max_sges
expr_stmt|;
name|init_attr
operator|->
name|cap
operator|.
name|max_recv_sge
operator|=
name|qhp
operator|->
name|attr
operator|.
name|sq_max_sges
expr_stmt|;
name|init_attr
operator|->
name|cap
operator|.
name|max_inline_data
operator|=
name|T4_MAX_SEND_INLINE
expr_stmt|;
name|init_attr
operator|->
name|sq_sig_type
operator|=
name|qhp
operator|->
name|sq_sig_all
condition|?
name|IB_SIGNAL_ALL_WR
else|:
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2009-2013 Chelsio, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TCP_OFFLOAD
end_ifdef

begin_include
include|#
directive|include
file|<linux/types.h>
end_include

begin_include
include|#
directive|include
file|<linux/kref.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|<asm/atomic.h>
end_include

begin_include
include|#
directive|include
file|<common/t4_msg.h>
end_include

begin_include
include|#
directive|include
file|"iw_cxgbe.h"
end_include

begin_decl_stmt
name|int
name|use_dsgl
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|T4_ULPTX_MIN_IO
value|32
end_define

begin_define
define|#
directive|define
name|C4IW_MAX_INLINE_SIZE
value|96
end_define

begin_function
specifier|static
name|int
name|mr_exceeds_hw_limits
parameter_list|(
name|struct
name|c4iw_dev
modifier|*
name|dev
parameter_list|,
name|u64
name|length
parameter_list|)
block|{
return|return
operator|(
name|is_t5
argument_list|(
name|dev
operator|->
name|rdev
operator|.
name|adap
argument_list|)
operator|&&
name|length
operator|>=
literal|8
operator|*
literal|1024
operator|*
literal|1024
operator|*
literal|1024ULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|write_adapter_mem
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|u32
name|addr
parameter_list|,
name|u32
name|len
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|sc
init|=
name|rdev
operator|->
name|adap
decl_stmt|;
name|struct
name|ulp_mem_io
modifier|*
name|ulpmc
decl_stmt|;
name|struct
name|ulptx_idata
modifier|*
name|ulpsc
decl_stmt|;
name|u8
name|wr_len
decl_stmt|,
modifier|*
name|to_dp
decl_stmt|,
modifier|*
name|from_dp
decl_stmt|;
name|int
name|copy_len
decl_stmt|,
name|num_wqe
decl_stmt|,
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|c4iw_wr_wait
name|wr_wait
decl_stmt|;
name|struct
name|wrqe
modifier|*
name|wr
decl_stmt|;
name|u32
name|cmd
decl_stmt|;
name|cmd
operator|=
name|cpu_to_be32
argument_list|(
name|V_ULPTX_CMD
argument_list|(
name|ULP_TX_MEM_WRITE
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator||=
name|cpu_to_be32
argument_list|(
name|F_T5_ULP_MEMIO_IMM
argument_list|)
expr_stmt|;
name|addr
operator|&=
literal|0x7FFFFFF
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s addr 0x%x len %u"
argument_list|,
name|__func__
argument_list|,
name|addr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|num_wqe
operator|=
name|DIV_ROUND_UP
argument_list|(
name|len
argument_list|,
name|C4IW_MAX_INLINE_SIZE
argument_list|)
expr_stmt|;
name|c4iw_init_wr_wait
argument_list|(
operator|&
name|wr_wait
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_wqe
condition|;
name|i
operator|++
control|)
block|{
name|copy_len
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|C4IW_MAX_INLINE_SIZE
argument_list|)
expr_stmt|;
name|wr_len
operator|=
name|roundup
argument_list|(
sizeof|sizeof
expr|*
name|ulpmc
operator|+
sizeof|sizeof
expr|*
name|ulpsc
operator|+
name|roundup
argument_list|(
name|copy_len
argument_list|,
name|T4_ULPTX_MIN_IO
argument_list|)
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|wr
operator|=
name|alloc_wrqe
argument_list|(
name|wr_len
argument_list|,
operator|&
name|sc
operator|->
name|sge
operator|.
name|mgmtq
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|ulpmc
operator|=
name|wrtod
argument_list|(
name|wr
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ulpmc
argument_list|,
literal|0
argument_list|,
name|wr_len
argument_list|)
expr_stmt|;
name|INIT_ULPTX_WR
argument_list|(
name|ulpmc
argument_list|,
name|wr_len
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|num_wqe
operator|-
literal|1
operator|)
condition|)
block|{
name|ulpmc
operator|->
name|wr
operator|.
name|wr_hi
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_OP
argument_list|(
name|FW_ULPTX_WR
argument_list|)
operator||
name|F_FW_WR_COMPL
argument_list|)
expr_stmt|;
name|ulpmc
operator|->
name|wr
operator|.
name|wr_lo
operator|=
operator|(
name|__force
name|__be64
operator|)
operator|(
name|unsigned
name|long
operator|)
operator|&
name|wr_wait
expr_stmt|;
block|}
else|else
name|ulpmc
operator|->
name|wr
operator|.
name|wr_hi
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_OP
argument_list|(
name|FW_ULPTX_WR
argument_list|)
argument_list|)
expr_stmt|;
name|ulpmc
operator|->
name|wr
operator|.
name|wr_mid
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_WR_LEN16
argument_list|(
name|DIV_ROUND_UP
argument_list|(
name|wr_len
argument_list|,
literal|16
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ulpmc
operator|->
name|cmd
operator|=
name|cmd
expr_stmt|;
name|ulpmc
operator|->
name|dlen
operator|=
name|cpu_to_be32
argument_list|(
name|V_ULP_MEMIO_DATA_LEN
argument_list|(
name|DIV_ROUND_UP
argument_list|(
name|copy_len
argument_list|,
name|T4_ULPTX_MIN_IO
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ulpmc
operator|->
name|len16
operator|=
name|cpu_to_be32
argument_list|(
name|DIV_ROUND_UP
argument_list|(
name|wr_len
operator|-
sizeof|sizeof
argument_list|(
name|ulpmc
operator|->
name|wr
argument_list|)
argument_list|,
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|ulpmc
operator|->
name|lock_addr
operator|=
name|cpu_to_be32
argument_list|(
name|V_ULP_MEMIO_ADDR
argument_list|(
name|addr
operator|+
name|i
operator|*
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|ulpsc
operator|=
operator|(
expr|struct
name|ulptx_idata
operator|*
operator|)
operator|(
name|ulpmc
operator|+
literal|1
operator|)
expr_stmt|;
name|ulpsc
operator|->
name|cmd_more
operator|=
name|cpu_to_be32
argument_list|(
name|V_ULPTX_CMD
argument_list|(
name|ULP_TX_SC_IMM
argument_list|)
argument_list|)
expr_stmt|;
name|ulpsc
operator|->
name|len
operator|=
name|cpu_to_be32
argument_list|(
name|roundup
argument_list|(
name|copy_len
argument_list|,
name|T4_ULPTX_MIN_IO
argument_list|)
argument_list|)
expr_stmt|;
name|to_dp
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|ulpsc
operator|+
literal|1
operator|)
expr_stmt|;
name|from_dp
operator|=
operator|(
name|u8
operator|*
operator|)
name|data
operator|+
name|i
operator|*
name|C4IW_MAX_INLINE_SIZE
expr_stmt|;
if|if
condition|(
name|data
condition|)
name|memcpy
argument_list|(
name|to_dp
argument_list|,
name|from_dp
argument_list|,
name|copy_len
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|to_dp
argument_list|,
literal|0
argument_list|,
name|copy_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|copy_len
operator|%
name|T4_ULPTX_MIN_IO
condition|)
name|memset
argument_list|(
name|to_dp
operator|+
name|copy_len
argument_list|,
literal|0
argument_list|,
name|T4_ULPTX_MIN_IO
operator|-
operator|(
name|copy_len
operator|%
name|T4_ULPTX_MIN_IO
operator|)
argument_list|)
expr_stmt|;
name|t4_wrq_tx
argument_list|(
name|sc
argument_list|,
name|wr
argument_list|)
expr_stmt|;
name|len
operator|-=
name|C4IW_MAX_INLINE_SIZE
expr_stmt|;
block|}
name|ret
operator|=
name|c4iw_wait_for_reply
argument_list|(
name|rdev
argument_list|,
operator|&
name|wr_wait
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Build and write a TPT entry.  * IN: stag key, pdid, perm, bind_enabled, zbva, to, len, page_size,  *     pbl_size and pbl_addr  * OUT: stag index  */
end_comment

begin_function
specifier|static
name|int
name|write_tpt_entry
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|u32
name|reset_tpt_entry
parameter_list|,
name|u32
modifier|*
name|stag
parameter_list|,
name|u8
name|stag_state
parameter_list|,
name|u32
name|pdid
parameter_list|,
name|enum
name|fw_ri_stag_type
name|type
parameter_list|,
name|enum
name|fw_ri_mem_perms
name|perm
parameter_list|,
name|int
name|bind_enabled
parameter_list|,
name|u32
name|zbva
parameter_list|,
name|u64
name|to
parameter_list|,
name|u64
name|len
parameter_list|,
name|u8
name|page_size
parameter_list|,
name|u32
name|pbl_size
parameter_list|,
name|u32
name|pbl_addr
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|struct
name|fw_ri_tpte
name|tpt
decl_stmt|;
name|u32
name|stag_idx
decl_stmt|;
specifier|static
name|atomic_t
name|key
decl_stmt|;
if|if
condition|(
name|c4iw_fatal_error
argument_list|(
name|rdev
argument_list|)
condition|)
return|return
operator|-
name|EIO
return|;
name|stag_state
operator|=
name|stag_state
operator|>
literal|0
expr_stmt|;
name|stag_idx
operator|=
operator|(
operator|*
name|stag
operator|)
operator|>>
literal|8
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|reset_tpt_entry
operator|)
operator|&&
operator|(
operator|*
name|stag
operator|==
name|T4_STAG_UNSET
operator|)
condition|)
block|{
name|stag_idx
operator|=
name|c4iw_get_resource
argument_list|(
operator|&
name|rdev
operator|->
name|resource
operator|.
name|tpt_table
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|stag_idx
condition|)
block|{
name|mutex_lock
argument_list|(
operator|&
name|rdev
operator|->
name|stats
operator|.
name|lock
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|stats
operator|.
name|stag
operator|.
name|fail
operator|++
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|rdev
operator|->
name|stats
operator|.
name|lock
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|mutex_lock
argument_list|(
operator|&
name|rdev
operator|->
name|stats
operator|.
name|lock
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|stats
operator|.
name|stag
operator|.
name|cur
operator|+=
literal|32
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|stats
operator|.
name|stag
operator|.
name|cur
operator|>
name|rdev
operator|->
name|stats
operator|.
name|stag
operator|.
name|max
condition|)
name|rdev
operator|->
name|stats
operator|.
name|stag
operator|.
name|max
operator|=
name|rdev
operator|->
name|stats
operator|.
name|stag
operator|.
name|cur
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|rdev
operator|->
name|stats
operator|.
name|lock
argument_list|)
expr_stmt|;
operator|*
name|stag
operator|=
operator|(
name|stag_idx
operator|<<
literal|8
operator|)
operator||
operator|(
name|atomic_inc_return
argument_list|(
operator|&
name|key
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s stag_state 0x%0x type 0x%0x pdid 0x%0x, stag_idx 0x%x"
argument_list|,
name|__func__
argument_list|,
name|stag_state
argument_list|,
name|type
argument_list|,
name|pdid
argument_list|,
name|stag_idx
argument_list|)
expr_stmt|;
comment|/* write TPT entry */
if|if
condition|(
name|reset_tpt_entry
condition|)
name|memset
argument_list|(
operator|&
name|tpt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tpt
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|tpt
operator|.
name|valid_to_pdid
operator|=
name|cpu_to_be32
argument_list|(
name|F_FW_RI_TPTE_VALID
operator||
name|V_FW_RI_TPTE_STAGKEY
argument_list|(
operator|(
operator|*
name|stag
operator|&
name|M_FW_RI_TPTE_STAGKEY
operator|)
argument_list|)
operator||
name|V_FW_RI_TPTE_STAGSTATE
argument_list|(
name|stag_state
argument_list|)
operator||
name|V_FW_RI_TPTE_STAGTYPE
argument_list|(
name|type
argument_list|)
operator||
name|V_FW_RI_TPTE_PDID
argument_list|(
name|pdid
argument_list|)
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|locread_to_qpid
operator|=
name|cpu_to_be32
argument_list|(
name|V_FW_RI_TPTE_PERM
argument_list|(
name|perm
argument_list|)
operator||
operator|(
name|bind_enabled
condition|?
name|F_FW_RI_TPTE_MWBINDEN
else|:
literal|0
operator|)
operator||
name|V_FW_RI_TPTE_ADDRTYPE
argument_list|(
operator|(
name|zbva
condition|?
name|FW_RI_ZERO_BASED_TO
else|:
name|FW_RI_VA_BASED_TO
operator|)
argument_list|)
operator||
name|V_FW_RI_TPTE_PS
argument_list|(
name|page_size
argument_list|)
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|nosnoop_pbladdr
operator|=
operator|!
name|pbl_size
condition|?
literal|0
else|:
name|cpu_to_be32
argument_list|(
name|V_FW_RI_TPTE_PBLADDR
argument_list|(
name|PBL_OFF
argument_list|(
name|rdev
argument_list|,
name|pbl_addr
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|len_lo
operator|=
name|cpu_to_be32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|len
operator|&
literal|0xffffffffUL
argument_list|)
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|va_hi
operator|=
name|cpu_to_be32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|to
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|va_lo_fbo
operator|=
name|cpu_to_be32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|to
operator|&
literal|0xffffffffUL
argument_list|)
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|dca_mwbcnt_pstag
operator|=
name|cpu_to_be32
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|tpt
operator|.
name|len_hi
operator|=
name|cpu_to_be32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|len
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|write_adapter_mem
argument_list|(
name|rdev
argument_list|,
name|stag_idx
operator|+
operator|(
name|rdev
operator|->
name|adap
operator|->
name|vres
operator|.
name|stag
operator|.
name|start
operator|>>
literal|5
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|tpt
argument_list|)
argument_list|,
operator|&
name|tpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset_tpt_entry
condition|)
block|{
name|c4iw_put_resource
argument_list|(
operator|&
name|rdev
operator|->
name|resource
operator|.
name|tpt_table
argument_list|,
name|stag_idx
argument_list|)
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|rdev
operator|->
name|stats
operator|.
name|lock
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|stats
operator|.
name|stag
operator|.
name|cur
operator|-=
literal|32
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|rdev
operator|->
name|stats
operator|.
name|lock
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|write_pbl
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|__be64
modifier|*
name|pbl
parameter_list|,
name|u32
name|pbl_addr
parameter_list|,
name|u32
name|pbl_size
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s *pdb_addr 0x%x, pbl_base 0x%x, pbl_size %d"
argument_list|,
name|__func__
argument_list|,
name|pbl_addr
argument_list|,
name|rdev
operator|->
name|adap
operator|->
name|vres
operator|.
name|pbl
operator|.
name|start
argument_list|,
name|pbl_size
argument_list|)
expr_stmt|;
name|err
operator|=
name|write_adapter_mem
argument_list|(
name|rdev
argument_list|,
name|pbl_addr
operator|>>
literal|5
argument_list|,
name|pbl_size
operator|<<
literal|3
argument_list|,
name|pbl
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dereg_mem
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|u32
name|stag
parameter_list|,
name|u32
name|pbl_size
parameter_list|,
name|u32
name|pbl_addr
parameter_list|)
block|{
return|return
name|write_tpt_entry
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|,
operator|&
name|stag
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0UL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|pbl_size
argument_list|,
name|pbl_addr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|allocate_window
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|u32
modifier|*
name|stag
parameter_list|,
name|u32
name|pdid
parameter_list|)
block|{
operator|*
name|stag
operator|=
name|T4_STAG_UNSET
expr_stmt|;
return|return
name|write_tpt_entry
argument_list|(
name|rdev
argument_list|,
literal|0
argument_list|,
name|stag
argument_list|,
literal|0
argument_list|,
name|pdid
argument_list|,
name|FW_RI_STAG_MW
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0UL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|deallocate_window
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|u32
name|stag
parameter_list|)
block|{
return|return
name|write_tpt_entry
argument_list|(
name|rdev
argument_list|,
literal|1
argument_list|,
operator|&
name|stag
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0UL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|allocate_stag
parameter_list|(
name|struct
name|c4iw_rdev
modifier|*
name|rdev
parameter_list|,
name|u32
modifier|*
name|stag
parameter_list|,
name|u32
name|pdid
parameter_list|,
name|u32
name|pbl_size
parameter_list|,
name|u32
name|pbl_addr
parameter_list|)
block|{
operator|*
name|stag
operator|=
name|T4_STAG_UNSET
expr_stmt|;
return|return
name|write_tpt_entry
argument_list|(
name|rdev
argument_list|,
literal|0
argument_list|,
name|stag
argument_list|,
literal|0
argument_list|,
name|pdid
argument_list|,
name|FW_RI_STAG_NSMR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0UL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|pbl_size
argument_list|,
name|pbl_addr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|finish_mem_reg
parameter_list|(
name|struct
name|c4iw_mr
modifier|*
name|mhp
parameter_list|,
name|u32
name|stag
parameter_list|)
block|{
name|u32
name|mmid
decl_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|state
operator|=
literal|1
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|stag
operator|=
name|stag
expr_stmt|;
name|mmid
operator|=
name|stag
operator|>>
literal|8
expr_stmt|;
name|mhp
operator|->
name|ibmr
operator|.
name|rkey
operator|=
name|mhp
operator|->
name|ibmr
operator|.
name|lkey
operator|=
name|stag
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s mmid 0x%x mhp %p"
argument_list|,
name|__func__
argument_list|,
name|mmid
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
return|return
name|insert_handle
argument_list|(
name|mhp
operator|->
name|rhp
argument_list|,
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|mmidr
argument_list|,
name|mhp
argument_list|,
name|mmid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|register_mem
parameter_list|(
name|struct
name|c4iw_dev
modifier|*
name|rhp
parameter_list|,
name|struct
name|c4iw_pd
modifier|*
name|php
parameter_list|,
name|struct
name|c4iw_mr
modifier|*
name|mhp
parameter_list|,
name|int
name|shift
parameter_list|)
block|{
name|u32
name|stag
init|=
name|T4_STAG_UNSET
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|write_tpt_entry
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
literal|0
argument_list|,
operator|&
name|stag
argument_list|,
literal|1
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pdid
argument_list|,
name|FW_RI_STAG_NSMR
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|len
condition|?
name|mhp
operator|->
name|attr
operator|.
name|perms
else|:
literal|0
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|mw_bind_enable
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|zbva
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|len
condition|?
name|mhp
operator|->
name|attr
operator|.
name|len
else|:
operator|-
literal|1
argument_list|,
name|shift
operator|-
literal|12
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|finish_mem_reg
argument_list|(
name|mhp
argument_list|,
name|stag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|dereg_mem
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|stag
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|alloc_pbl
parameter_list|(
name|struct
name|c4iw_mr
modifier|*
name|mhp
parameter_list|,
name|int
name|npages
parameter_list|)
block|{
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
operator|=
name|c4iw_pblpool_alloc
argument_list|(
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
name|npages
operator|<<
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
operator|=
name|npages
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ib_mr
modifier|*
name|c4iw_get_dma_mr
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|int
name|acc
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|c4iw_pd
modifier|*
name|php
decl_stmt|;
name|struct
name|c4iw_mr
modifier|*
name|mhp
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|u32
name|stag
init|=
name|T4_STAG_UNSET
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_pd %p"
argument_list|,
name|__func__
argument_list|,
name|pd
argument_list|)
expr_stmt|;
name|php
operator|=
name|to_c4iw_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|php
operator|->
name|rhp
expr_stmt|;
name|mhp
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mhp
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|mhp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|pdid
operator|=
name|php
operator|->
name|pdid
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|perms
operator|=
name|c4iw_ib_to_tpt_access
argument_list|(
name|acc
argument_list|)
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|mw_bind_enable
operator|=
operator|(
name|acc
operator|&
name|IB_ACCESS_MW_BIND
operator|)
operator|==
name|IB_ACCESS_MW_BIND
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|zbva
operator|=
literal|0
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
operator|=
literal|0
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|page_size
operator|=
literal|0
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|len
operator|=
operator|~
literal|0ULL
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|write_tpt_entry
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
literal|0
argument_list|,
operator|&
name|stag
argument_list|,
literal|1
argument_list|,
name|php
operator|->
name|pdid
argument_list|,
name|FW_RI_STAG_NSMR
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|perms
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|mw_bind_enable
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|~
literal|0ULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err1
goto|;
name|ret
operator|=
name|finish_mem_reg
argument_list|(
name|mhp
argument_list|,
name|stag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err2
goto|;
return|return
operator|&
name|mhp
operator|->
name|ibmr
return|;
name|err2
label|:
name|dereg_mem
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|stag
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
expr_stmt|;
name|err1
label|:
name|kfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|ib_mr
modifier|*
name|c4iw_reg_user_mr
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|u64
name|start
parameter_list|,
name|u64
name|length
parameter_list|,
name|u64
name|virt
parameter_list|,
name|int
name|acc
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|__be64
modifier|*
name|pages
decl_stmt|;
name|int
name|shift
decl_stmt|,
name|n
decl_stmt|,
name|len
decl_stmt|;
name|int
name|i
decl_stmt|,
name|k
decl_stmt|,
name|entry
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|scatterlist
modifier|*
name|sg
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|c4iw_pd
modifier|*
name|php
decl_stmt|;
name|struct
name|c4iw_mr
modifier|*
name|mhp
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_pd %p"
argument_list|,
name|__func__
argument_list|,
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|==
operator|~
literal|0ULL
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
if|if
condition|(
operator|(
name|length
operator|+
name|start
operator|)
operator|<
name|start
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|php
operator|=
name|to_c4iw_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|php
operator|->
name|rhp
expr_stmt|;
if|if
condition|(
name|mr_exceeds_hw_limits
argument_list|(
name|rhp
argument_list|,
name|length
argument_list|)
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|mhp
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mhp
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|mhp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
name|mhp
operator|->
name|umem
operator|=
name|ib_umem_get
argument_list|(
name|pd
operator|->
name|uobject
operator|->
name|context
argument_list|,
name|start
argument_list|,
name|length
argument_list|,
name|acc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mhp
operator|->
name|umem
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|mhp
operator|->
name|umem
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
name|shift
operator|=
name|ffs
argument_list|(
name|mhp
operator|->
name|umem
operator|->
name|page_size
argument_list|)
operator|-
literal|1
expr_stmt|;
name|n
operator|=
name|mhp
operator|->
name|umem
operator|->
name|nmap
expr_stmt|;
name|err
operator|=
name|alloc_pbl
argument_list|(
name|mhp
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err
goto|;
name|pages
operator|=
operator|(
name|__be64
operator|*
operator|)
name|__get_free_page
argument_list|(
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pages
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_pbl
goto|;
block|}
name|i
operator|=
name|n
operator|=
literal|0
expr_stmt|;
name|for_each_sg
argument_list|(
argument|mhp->umem->sg_head.sgl
argument_list|,
argument|sg
argument_list|,
argument|mhp->umem->nmap
argument_list|,
argument|entry
argument_list|)
block|{
name|len
operator|=
name|sg_dma_len
argument_list|(
name|sg
argument_list|)
operator|>>
name|shift
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|len
condition|;
operator|++
name|k
control|)
block|{
name|pages
index|[
name|i
operator|++
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|sg_dma_address
argument_list|(
name|sg
argument_list|)
operator|+
name|mhp
operator|->
name|umem
operator|->
name|page_size
operator|*
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|PAGE_SIZE
operator|/
sizeof|sizeof
expr|*
name|pages
condition|)
block|{
name|err
operator|=
name|write_pbl
argument_list|(
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
name|pages
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
operator|+
operator|(
name|n
operator|<<
literal|3
operator|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|pbl_done
goto|;
name|n
operator|+=
name|i
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|i
condition|)
name|err
operator|=
name|write_pbl
argument_list|(
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
name|pages
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
operator|+
operator|(
name|n
operator|<<
literal|3
operator|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|pbl_done
label|:
name|free_page
argument_list|(
operator|(
name|unsigned
name|long
operator|)
name|pages
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_pbl
goto|;
name|mhp
operator|->
name|attr
operator|.
name|pdid
operator|=
name|php
operator|->
name|pdid
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|zbva
operator|=
literal|0
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|perms
operator|=
name|c4iw_ib_to_tpt_access
argument_list|(
name|acc
argument_list|)
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|va_fbo
operator|=
name|virt
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|page_size
operator|=
name|shift
operator|-
literal|12
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|len
operator|=
name|length
expr_stmt|;
name|err
operator|=
name|register_mem
argument_list|(
name|rhp
argument_list|,
name|php
argument_list|,
name|mhp
argument_list|,
name|shift
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_pbl
goto|;
return|return
operator|&
name|mhp
operator|->
name|ibmr
return|;
name|err_pbl
label|:
name|c4iw_pblpool_free
argument_list|(
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
operator|<<
literal|3
argument_list|)
expr_stmt|;
name|err
label|:
name|ib_umem_release
argument_list|(
name|mhp
operator|->
name|umem
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|ib_mw
modifier|*
name|c4iw_alloc_mw
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|enum
name|ib_mw_type
name|type
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|c4iw_pd
modifier|*
name|php
decl_stmt|;
name|struct
name|c4iw_mw
modifier|*
name|mhp
decl_stmt|;
name|u32
name|mmid
decl_stmt|;
name|u32
name|stag
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|type
operator|!=
name|IB_MW_TYPE_1
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|php
operator|=
name|to_c4iw_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|php
operator|->
name|rhp
expr_stmt|;
name|mhp
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mhp
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|ret
operator|=
name|allocate_window
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|stag
argument_list|,
name|php
operator|->
name|pdid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|ret
argument_list|)
return|;
block|}
name|mhp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|pdid
operator|=
name|php
operator|->
name|pdid
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|type
operator|=
name|FW_RI_STAG_MW
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|stag
operator|=
name|stag
expr_stmt|;
name|mmid
operator|=
operator|(
name|stag
operator|)
operator|>>
literal|8
expr_stmt|;
name|mhp
operator|->
name|ibmw
operator|.
name|rkey
operator|=
name|stag
expr_stmt|;
if|if
condition|(
name|insert_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|mmidr
argument_list|,
name|mhp
argument_list|,
name|mmid
argument_list|)
condition|)
block|{
name|deallocate_window
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|stag
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s mmid 0x%x mhp %p stag 0x%x"
argument_list|,
name|__func__
argument_list|,
name|mmid
argument_list|,
name|mhp
argument_list|,
name|stag
argument_list|)
expr_stmt|;
return|return
operator|&
operator|(
name|mhp
operator|->
name|ibmw
operator|)
return|;
block|}
end_function

begin_function
name|int
name|c4iw_dealloc_mw
parameter_list|(
name|struct
name|ib_mw
modifier|*
name|mw
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|c4iw_mw
modifier|*
name|mhp
decl_stmt|;
name|u32
name|mmid
decl_stmt|;
name|mhp
operator|=
name|to_c4iw_mw
argument_list|(
name|mw
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|mhp
operator|->
name|rhp
expr_stmt|;
name|mmid
operator|=
operator|(
name|mw
operator|->
name|rkey
operator|)
operator|>>
literal|8
expr_stmt|;
name|remove_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|mmidr
argument_list|,
name|mmid
argument_list|)
expr_stmt|;
name|deallocate_window
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|stag
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_mw %p mmid 0x%x ptr %p"
argument_list|,
name|__func__
argument_list|,
name|mw
argument_list|,
name|mmid
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ib_mr
modifier|*
name|c4iw_alloc_mr
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|enum
name|ib_mr_type
name|mr_type
parameter_list|,
name|u32
name|max_num_sg
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|c4iw_pd
modifier|*
name|php
decl_stmt|;
name|struct
name|c4iw_mr
modifier|*
name|mhp
decl_stmt|;
name|u32
name|mmid
decl_stmt|;
name|u32
name|stag
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|length
init|=
name|roundup
argument_list|(
name|max_num_sg
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
literal|32
argument_list|)
decl_stmt|;
name|php
operator|=
name|to_c4iw_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|php
operator|->
name|rhp
expr_stmt|;
if|if
condition|(
name|mr_type
operator|!=
name|IB_MR_TYPE_MEM_REG
operator|||
name|max_num_sg
operator|>
name|t4_max_fr_depth
argument_list|(
name|rhp
operator|->
name|rdev
operator|.
name|adap
operator|->
name|params
operator|.
name|ulptx_memwrite_dsgl
operator|&&
name|use_dsgl
argument_list|)
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|mhp
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mhp
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|mhp
operator|->
name|mpl
operator|=
name|dma_alloc_coherent
argument_list|(
name|rhp
operator|->
name|ibdev
operator|.
name|dma_device
argument_list|,
name|length
argument_list|,
operator|&
name|mhp
operator|->
name|mpl_addr
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
operator|->
name|mpl
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_mpl
goto|;
block|}
name|mhp
operator|->
name|max_mpl_len
operator|=
name|length
expr_stmt|;
name|mhp
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
name|ret
operator|=
name|alloc_pbl
argument_list|(
name|mhp
argument_list|,
name|max_num_sg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err1
goto|;
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
operator|=
name|max_num_sg
expr_stmt|;
name|ret
operator|=
name|allocate_stag
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|stag
argument_list|,
name|php
operator|->
name|pdid
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err2
goto|;
name|mhp
operator|->
name|attr
operator|.
name|pdid
operator|=
name|php
operator|->
name|pdid
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|type
operator|=
name|FW_RI_STAG_NSMR
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|stag
operator|=
name|stag
expr_stmt|;
name|mhp
operator|->
name|attr
operator|.
name|state
operator|=
literal|0
expr_stmt|;
name|mmid
operator|=
operator|(
name|stag
operator|)
operator|>>
literal|8
expr_stmt|;
name|mhp
operator|->
name|ibmr
operator|.
name|rkey
operator|=
name|mhp
operator|->
name|ibmr
operator|.
name|lkey
operator|=
name|stag
expr_stmt|;
if|if
condition|(
name|insert_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|mmidr
argument_list|,
name|mhp
argument_list|,
name|mmid
argument_list|)
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|PDBG
argument_list|(
literal|"%s mmid 0x%x mhp %p stag 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|mmid
argument_list|,
name|mhp
argument_list|,
name|stag
argument_list|)
expr_stmt|;
return|return
operator|&
operator|(
name|mhp
operator|->
name|ibmr
operator|)
return|;
name|err3
label|:
name|dereg_mem
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|stag
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
expr_stmt|;
name|err2
label|:
name|c4iw_pblpool_free
argument_list|(
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
operator|<<
literal|3
argument_list|)
expr_stmt|;
name|err1
label|:
name|dma_free_coherent
argument_list|(
name|rhp
operator|->
name|ibdev
operator|.
name|dma_device
argument_list|,
name|mhp
operator|->
name|max_mpl_len
argument_list|,
name|mhp
operator|->
name|mpl
argument_list|,
name|mhp
operator|->
name|mpl_addr
argument_list|)
expr_stmt|;
name|err_mpl
label|:
name|kfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|ERR_PTR
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|c4iw_set_page
parameter_list|(
name|struct
name|ib_mr
modifier|*
name|ibmr
parameter_list|,
name|u64
name|addr
parameter_list|)
block|{
name|struct
name|c4iw_mr
modifier|*
name|mhp
init|=
name|to_c4iw_mr
argument_list|(
name|ibmr
argument_list|)
decl_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|mhp
operator|->
name|mpl_len
operator|==
name|mhp
operator|->
name|max_mpl_len
argument_list|)
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|mhp
operator|->
name|mpl
index|[
name|mhp
operator|->
name|mpl_len
operator|++
index|]
operator|=
name|addr
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|c4iw_map_mr_sg
parameter_list|(
name|struct
name|ib_mr
modifier|*
name|ibmr
parameter_list|,
name|struct
name|scatterlist
modifier|*
name|sg
parameter_list|,
name|int
name|sg_nents
parameter_list|,
name|unsigned
name|int
modifier|*
name|sg_offset
parameter_list|)
block|{
name|struct
name|c4iw_mr
modifier|*
name|mhp
init|=
name|to_c4iw_mr
argument_list|(
name|ibmr
argument_list|)
decl_stmt|;
name|mhp
operator|->
name|mpl_len
operator|=
literal|0
expr_stmt|;
return|return
name|ib_sg_to_pages
argument_list|(
name|ibmr
argument_list|,
name|sg
argument_list|,
name|sg_nents
argument_list|,
name|sg_offset
argument_list|,
name|c4iw_set_page
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|c4iw_dereg_mr
parameter_list|(
name|struct
name|ib_mr
modifier|*
name|ib_mr
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|struct
name|c4iw_mr
modifier|*
name|mhp
decl_stmt|;
name|u32
name|mmid
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ib_mr %p"
argument_list|,
name|__func__
argument_list|,
name|ib_mr
argument_list|)
expr_stmt|;
name|mhp
operator|=
name|to_c4iw_mr
argument_list|(
name|ib_mr
argument_list|)
expr_stmt|;
name|rhp
operator|=
name|mhp
operator|->
name|rhp
expr_stmt|;
name|mmid
operator|=
name|mhp
operator|->
name|attr
operator|.
name|stag
operator|>>
literal|8
expr_stmt|;
name|remove_handle
argument_list|(
name|rhp
argument_list|,
operator|&
name|rhp
operator|->
name|mmidr
argument_list|,
name|mmid
argument_list|)
expr_stmt|;
name|dereg_mem
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|stag
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
condition|)
name|c4iw_pblpool_free
argument_list|(
operator|&
name|mhp
operator|->
name|rhp
operator|->
name|rdev
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_addr
argument_list|,
name|mhp
operator|->
name|attr
operator|.
name|pbl_size
operator|<<
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|mhp
operator|->
name|kva
condition|)
name|kfree
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|mhp
operator|->
name|kva
argument_list|)
expr_stmt|;
if|if
condition|(
name|mhp
operator|->
name|umem
condition|)
name|ib_umem_release
argument_list|(
name|mhp
operator|->
name|umem
argument_list|)
expr_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s mmid 0x%x ptr %p"
argument_list|,
name|__func__
argument_list|,
name|mmid
argument_list|,
name|mhp
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|c4iw_invalidate_mr
parameter_list|(
name|struct
name|c4iw_dev
modifier|*
name|rhp
parameter_list|,
name|u32
name|rkey
parameter_list|)
block|{
name|struct
name|c4iw_mr
modifier|*
name|mhp
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|rhp
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|mhp
operator|=
name|get_mhp
argument_list|(
name|rhp
argument_list|,
name|rkey
operator|>>
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|mhp
condition|)
name|mhp
operator|->
name|attr
operator|.
name|state
operator|=
literal|0
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|rhp
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


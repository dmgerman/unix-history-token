begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2009-2013, 2016 Chelsio, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TCP_OFFLOAD
end_ifdef

begin_include
include|#
directive|include
file|<asm/pgtable.h>
end_include

begin_include
include|#
directive|include
file|<linux/page.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_user_verbs.h>
end_include

begin_include
include|#
directive|include
file|"iw_cxgbe.h"
end_include

begin_include
include|#
directive|include
file|"user.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|fastreg_support
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param
argument_list|(
name|fastreg_support
argument_list|,
name|int
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|fastreg_support
argument_list|,
literal|"Advertise fastreg support (default = 1)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|c4iw_modify_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|int
name|port_modify_mask
parameter_list|,
name|struct
name|ib_port_modify
modifier|*
name|props
parameter_list|)
block|{
return|return
operator|-
name|ENOSYS
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_ah
modifier|*
name|c4iw_ah_create
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ib_ah_attr
modifier|*
name|ah_attr
parameter_list|)
block|{
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOSYS
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|c4iw_ah_destroy
parameter_list|(
name|struct
name|ib_ah
modifier|*
name|ah
parameter_list|)
block|{
return|return
operator|-
name|ENOSYS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|c4iw_multicast_attach
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
name|u16
name|lid
parameter_list|)
block|{
return|return
operator|-
name|ENOSYS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|c4iw_multicast_detach
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
name|u16
name|lid
parameter_list|)
block|{
return|return
operator|-
name|ENOSYS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|c4iw_process_mad
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|int
name|mad_flags
parameter_list|,
name|u8
name|port_num
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|in_wc
parameter_list|,
name|struct
name|ib_grh
modifier|*
name|in_grh
parameter_list|,
name|struct
name|ib_mad
modifier|*
name|in_mad
parameter_list|,
name|struct
name|ib_mad
modifier|*
name|out_mad
parameter_list|)
block|{
return|return
operator|-
name|ENOSYS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|c4iw_dealloc_ucontext
parameter_list|(
name|struct
name|ib_ucontext
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|rhp
init|=
name|to_c4iw_dev
argument_list|(
name|context
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|c4iw_ucontext
modifier|*
name|ucontext
init|=
name|to_c4iw_ucontext
argument_list|(
name|context
argument_list|)
decl_stmt|;
name|struct
name|c4iw_mm_entry
modifier|*
name|mm
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s context %p"
argument_list|,
name|__func__
argument_list|,
name|context
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|mm
argument_list|,
argument|tmp
argument_list|,
argument|&ucontext->mmaps
argument_list|,
argument|entry
argument_list|)
name|kfree
argument_list|(
name|mm
argument_list|)
expr_stmt|;
name|c4iw_release_dev_ucontext
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|ucontext
operator|->
name|uctx
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|ucontext
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_ucontext
modifier|*
name|c4iw_alloc_ucontext
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|c4iw_ucontext
modifier|*
name|context
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|rhp
init|=
name|to_c4iw_dev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|CTR2
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ibdev %p"
argument_list|,
name|__func__
argument_list|,
name|ibdev
argument_list|)
expr_stmt|;
name|context
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|context
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|context
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|c4iw_init_dev_ucontext
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
argument_list|,
operator|&
name|context
operator|->
name|uctx
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|context
operator|->
name|mmaps
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|context
operator|->
name|mmap_lock
argument_list|)
expr_stmt|;
return|return
operator|&
name|context
operator|->
name|ibucontext
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DOT5
end_ifdef

begin_function
specifier|static
specifier|inline
name|pgprot_t
name|t4_pgprot_wc
parameter_list|(
name|pgprot_t
name|prot
parameter_list|)
block|{
return|return
name|pgprot_writecombine
argument_list|(
name|prot
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|c4iw_mmap
parameter_list|(
name|struct
name|ib_ucontext
modifier|*
name|context
parameter_list|,
name|struct
name|vm_area_struct
modifier|*
name|vma
parameter_list|)
block|{
name|int
name|len
init|=
name|vma
operator|->
name|vm_end
operator|-
name|vma
operator|->
name|vm_start
decl_stmt|;
name|u32
name|key
init|=
name|vma
operator|->
name|vm_pgoff
operator|<<
name|PAGE_SHIFT
decl_stmt|;
name|struct
name|c4iw_rdev
modifier|*
name|rdev
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|c4iw_mm_entry
modifier|*
name|mm
decl_stmt|;
name|struct
name|c4iw_ucontext
modifier|*
name|ucontext
decl_stmt|;
name|u64
name|addr
decl_stmt|,
name|paddr
decl_stmt|;
name|u64
name|va_regs_res
init|=
literal|0
decl_stmt|,
name|va_udbs_res
init|=
literal|0
decl_stmt|;
name|u64
name|len_regs_res
init|=
literal|0
decl_stmt|,
name|len_udbs_res
init|=
literal|0
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:1 ctx %p vma %p"
argument_list|,
name|__func__
argument_list|,
name|context
argument_list|,
name|vma
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:1a pgoff 0x%lx key 0x%x len %d"
argument_list|,
name|__func__
argument_list|,
name|vma
operator|->
name|vm_pgoff
argument_list|,
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|vma
operator|->
name|vm_start
operator|&
operator|(
name|PAGE_SIZE
operator|-
literal|1
operator|)
condition|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:2 unaligned vm_start %u vma %p"
argument_list|,
name|__func__
argument_list|,
name|vma
operator|->
name|vm_start
argument_list|,
name|vma
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|rdev
operator|=
operator|&
operator|(
name|to_c4iw_dev
argument_list|(
name|context
operator|->
name|device
argument_list|)
operator|->
name|rdev
operator|)
expr_stmt|;
name|ucontext
operator|=
name|to_c4iw_ucontext
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|mm
operator|=
name|remove_mmap
argument_list|(
name|ucontext
argument_list|,
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm
condition|)
block|{
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:3 ucontext %p key %u len %u"
argument_list|,
name|__func__
argument_list|,
name|ucontext
argument_list|,
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|addr
operator|=
name|mm
operator|->
name|addr
expr_stmt|;
name|kfree
argument_list|(
name|mm
argument_list|)
expr_stmt|;
name|va_regs_res
operator|=
operator|(
name|u64
operator|)
name|rman_get_virtual
argument_list|(
name|rdev
operator|->
name|adap
operator|->
name|regs_res
argument_list|)
expr_stmt|;
name|len_regs_res
operator|=
operator|(
name|u64
operator|)
name|rman_get_size
argument_list|(
name|rdev
operator|->
name|adap
operator|->
name|regs_res
argument_list|)
expr_stmt|;
name|va_udbs_res
operator|=
operator|(
name|u64
operator|)
name|rman_get_virtual
argument_list|(
name|rdev
operator|->
name|adap
operator|->
name|udbs_res
argument_list|)
expr_stmt|;
name|len_udbs_res
operator|=
operator|(
name|u64
operator|)
name|rman_get_size
argument_list|(
name|rdev
operator|->
name|adap
operator|->
name|udbs_res
argument_list|)
expr_stmt|;
name|CTR6
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:4 addr %p, masync region %p:%p, udb region %p:%p"
argument_list|,
name|__func__
argument_list|,
name|addr
argument_list|,
name|va_regs_res
argument_list|,
name|va_regs_res
operator|+
name|len_regs_res
argument_list|,
name|va_udbs_res
argument_list|,
name|va_udbs_res
operator|+
name|len_udbs_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|>=
name|va_regs_res
operator|&&
name|addr
operator|<
name|va_regs_res
operator|+
name|len_regs_res
condition|)
block|{
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:5 MA_SYNC addr %p region %p, reglen %u"
argument_list|,
name|__func__
argument_list|,
name|addr
argument_list|,
name|va_regs_res
argument_list|,
name|len_regs_res
argument_list|)
expr_stmt|;
comment|/* 		 * MA_SYNC register... 		 */
name|paddr
operator|=
name|vtophys
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|vma
operator|->
name|vm_page_prot
operator|=
name|pgprot_noncached
argument_list|(
name|vma
operator|->
name|vm_page_prot
argument_list|)
expr_stmt|;
name|ret
operator|=
name|io_remap_pfn_range
argument_list|(
name|vma
argument_list|,
name|vma
operator|->
name|vm_start
argument_list|,
name|paddr
operator|>>
name|PAGE_SHIFT
argument_list|,
name|len
argument_list|,
name|vma
operator|->
name|vm_page_prot
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|addr
operator|>=
name|va_udbs_res
operator|&&
name|addr
operator|<
name|va_udbs_res
operator|+
name|len_udbs_res
condition|)
block|{
comment|/* 			* Map user DB or OCQP memory... 			*/
name|paddr
operator|=
name|vtophys
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:6 USER DB-GTS addr %p region %p, reglen %u"
argument_list|,
name|__func__
argument_list|,
name|addr
argument_list|,
name|va_udbs_res
argument_list|,
name|len_udbs_res
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DOT5
if|if
condition|(
operator|!
name|is_t4
argument_list|(
name|rdev
operator|->
name|lldi
operator|.
name|adapter_type
argument_list|)
operator|&&
name|map_udb_as_wc
condition|)
name|vma
operator|->
name|vm_page_prot
operator|=
name|t4_pgprot_wc
argument_list|(
name|vma
operator|->
name|vm_page_prot
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|vma
operator|->
name|vm_page_prot
operator|=
name|pgprot_noncached
argument_list|(
name|vma
operator|->
name|vm_page_prot
argument_list|)
expr_stmt|;
name|ret
operator|=
name|io_remap_pfn_range
argument_list|(
name|vma
argument_list|,
name|vma
operator|->
name|vm_start
argument_list|,
name|paddr
operator|>>
name|PAGE_SHIFT
argument_list|,
name|len
argument_list|,
name|vma
operator|->
name|vm_page_prot
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Map WQ or CQ contig dma memory... 			 */
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:7 WQ/CQ addr %p vm_start %u vma %p"
argument_list|,
name|__func__
argument_list|,
name|addr
argument_list|,
name|vma
operator|->
name|vm_start
argument_list|,
name|vma
argument_list|)
expr_stmt|;
name|ret
operator|=
name|io_remap_pfn_range
argument_list|(
name|vma
argument_list|,
name|vma
operator|->
name|vm_start
argument_list|,
name|addr
operator|>>
name|PAGE_SHIFT
argument_list|,
name|len
argument_list|,
name|vma
operator|->
name|vm_page_prot
argument_list|)
expr_stmt|;
block|}
block|}
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s:8 ctx %p vma %p ret %u"
argument_list|,
name|__func__
argument_list|,
name|context
argument_list|,
name|vma
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|c4iw_deallocate_pd
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|)
block|{
name|struct
name|c4iw_pd
modifier|*
name|php
init|=
name|to_c4iw_pd
argument_list|(
name|pd
argument_list|)
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|rhp
init|=
name|php
operator|->
name|rhp
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s: pd %p, pdid 0x%x"
argument_list|,
name|__func__
argument_list|,
name|pd
argument_list|,
name|php
operator|->
name|pdid
argument_list|)
expr_stmt|;
name|c4iw_put_resource
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|resource
operator|.
name|pdid_table
argument_list|,
name|php
operator|->
name|pdid
argument_list|)
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|stats
operator|.
name|lock
argument_list|)
expr_stmt|;
name|rhp
operator|->
name|rdev
operator|.
name|stats
operator|.
name|pd
operator|.
name|cur
operator|--
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|stats
operator|.
name|lock
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|php
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_pd
modifier|*
name|c4iw_allocate_pd
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_ucontext
modifier|*
name|context
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|c4iw_pd
modifier|*
name|php
decl_stmt|;
name|u32
name|pdid
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|rhp
decl_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s: ibdev %p, context %p, data %p"
argument_list|,
name|__func__
argument_list|,
name|ibdev
argument_list|,
name|context
argument_list|,
name|udata
argument_list|)
expr_stmt|;
name|rhp
operator|=
operator|(
expr|struct
name|c4iw_dev
operator|*
operator|)
name|ibdev
expr_stmt|;
name|pdid
operator|=
name|c4iw_get_resource
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|resource
operator|.
name|pdid_table
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pdid
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|php
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|php
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|php
condition|)
block|{
name|c4iw_put_resource
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|resource
operator|.
name|pdid_table
argument_list|,
name|pdid
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|php
operator|->
name|pdid
operator|=
name|pdid
expr_stmt|;
name|php
operator|->
name|rhp
operator|=
name|rhp
expr_stmt|;
if|if
condition|(
name|context
condition|)
block|{
if|if
condition|(
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|php
operator|->
name|pdid
argument_list|,
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|)
condition|)
block|{
name|c4iw_deallocate_pd
argument_list|(
operator|&
name|php
operator|->
name|ibpd
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EFAULT
argument_list|)
return|;
block|}
block|}
name|mutex_lock
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|stats
operator|.
name|lock
argument_list|)
expr_stmt|;
name|rhp
operator|->
name|rdev
operator|.
name|stats
operator|.
name|pd
operator|.
name|cur
operator|++
expr_stmt|;
if|if
condition|(
name|rhp
operator|->
name|rdev
operator|.
name|stats
operator|.
name|pd
operator|.
name|cur
operator|>
name|rhp
operator|->
name|rdev
operator|.
name|stats
operator|.
name|pd
operator|.
name|max
condition|)
name|rhp
operator|->
name|rdev
operator|.
name|stats
operator|.
name|pd
operator|.
name|max
operator|=
name|rhp
operator|->
name|rdev
operator|.
name|stats
operator|.
name|pd
operator|.
name|cur
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|rhp
operator|->
name|rdev
operator|.
name|stats
operator|.
name|lock
argument_list|)
expr_stmt|;
name|CTR6
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s: ibdev %p, context %p, data %p, pddid 0x%x, pd %p"
argument_list|,
name|__func__
argument_list|,
name|ibdev
argument_list|,
name|context
argument_list|,
name|udata
argument_list|,
name|pdid
argument_list|,
name|php
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|php
operator|->
name|ibpd
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|c4iw_query_pkey
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u16
name|index
parameter_list|,
name|u16
modifier|*
name|pkey
parameter_list|)
block|{
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ibdev %p, port %d, index %d, pkey %p"
argument_list|,
name|__func__
argument_list|,
name|ibdev
argument_list|,
name|port
argument_list|,
name|index
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
operator|*
name|pkey
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|c4iw_query_gid
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|int
name|index
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|dev
decl_stmt|;
name|struct
name|port_info
modifier|*
name|pi
decl_stmt|;
name|struct
name|adapter
modifier|*
name|sc
decl_stmt|;
name|CTR5
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ibdev %p, port %d, index %d, gid %p"
argument_list|,
name|__func__
argument_list|,
name|ibdev
argument_list|,
name|port
argument_list|,
name|index
argument_list|,
name|gid
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|gid
operator|->
name|raw
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gid
operator|->
name|raw
argument_list|)
argument_list|)
expr_stmt|;
name|dev
operator|=
name|to_c4iw_dev
argument_list|(
name|ibdev
argument_list|)
expr_stmt|;
name|sc
operator|=
name|dev
operator|->
name|rdev
operator|.
name|adap
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
operator|||
name|port
operator|>
name|sc
operator|->
name|params
operator|.
name|nports
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|pi
operator|=
name|sc
operator|->
name|port
index|[
name|port
operator|-
literal|1
index|]
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|gid
operator|->
name|raw
index|[
literal|0
index|]
argument_list|,
name|pi
operator|->
name|vi
index|[
literal|0
index|]
operator|.
name|hw_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|c4iw_query_device
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_device_attr
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|dev
init|=
name|to_c4iw_dev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|adapter
modifier|*
name|sc
init|=
name|dev
operator|->
name|rdev
operator|.
name|adap
decl_stmt|;
specifier|const
name|int
name|spg_ndesc
init|=
name|sc
operator|->
name|params
operator|.
name|sge
operator|.
name|spg_len
operator|/
name|EQ_ESIZE
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ibdev %p, props %p"
argument_list|,
name|__func__
argument_list|,
name|ibdev
argument_list|,
name|props
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|props
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|props
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|props
operator|->
name|sys_image_guid
argument_list|,
name|sc
operator|->
name|port
index|[
literal|0
index|]
operator|->
name|vi
index|[
literal|0
index|]
operator|.
name|hw_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|props
operator|->
name|hw_ver
operator|=
name|sc
operator|->
name|params
operator|.
name|chipid
expr_stmt|;
name|props
operator|->
name|fw_ver
operator|=
name|sc
operator|->
name|params
operator|.
name|fw_vers
expr_stmt|;
name|props
operator|->
name|device_cap_flags
operator|=
name|dev
operator|->
name|device_cap_flags
expr_stmt|;
name|props
operator|->
name|page_size_cap
operator|=
name|T4_PAGESIZE_MASK
expr_stmt|;
name|props
operator|->
name|vendor_id
operator|=
name|pci_get_vendor
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|props
operator|->
name|vendor_part_id
operator|=
name|pci_get_device
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_mr_size
operator|=
name|T4_MAX_MR_SIZE
expr_stmt|;
name|props
operator|->
name|max_qp
operator|=
name|sc
operator|->
name|vres
operator|.
name|qp
operator|.
name|size
operator|/
literal|2
expr_stmt|;
name|props
operator|->
name|max_qp_wr
operator|=
name|T4_MAX_QP_DEPTH
argument_list|(
name|spg_ndesc
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_sge
operator|=
name|T4_MAX_RECV_SGE
expr_stmt|;
name|props
operator|->
name|max_sge_rd
operator|=
literal|1
expr_stmt|;
name|props
operator|->
name|max_res_rd_atom
operator|=
name|sc
operator|->
name|params
operator|.
name|max_ird_adapter
expr_stmt|;
name|props
operator|->
name|max_qp_rd_atom
operator|=
name|min
argument_list|(
name|sc
operator|->
name|params
operator|.
name|max_ordird_qp
argument_list|,
name|c4iw_max_read_depth
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_qp_init_rd_atom
operator|=
name|props
operator|->
name|max_qp_rd_atom
expr_stmt|;
name|props
operator|->
name|max_cq
operator|=
name|sc
operator|->
name|vres
operator|.
name|qp
operator|.
name|size
expr_stmt|;
name|props
operator|->
name|max_cqe
operator|=
name|T4_MAX_CQ_DEPTH
expr_stmt|;
name|props
operator|->
name|max_mr
operator|=
name|c4iw_num_stags
argument_list|(
operator|&
name|dev
operator|->
name|rdev
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_pd
operator|=
name|T4_MAX_NUM_PD
expr_stmt|;
name|props
operator|->
name|local_ca_ack_delay
operator|=
literal|0
expr_stmt|;
name|props
operator|->
name|max_fast_reg_page_list_len
operator|=
name|T4_MAX_FR_DEPTH
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Returns -errno on failure.  */
end_comment

begin_function
specifier|static
name|int
name|c4iw_query_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|struct
name|ib_port_attr
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|dev
decl_stmt|;
name|struct
name|adapter
modifier|*
name|sc
decl_stmt|;
name|struct
name|port_info
modifier|*
name|pi
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|CTR4
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s ibdev %p, port %d, props %p"
argument_list|,
name|__func__
argument_list|,
name|ibdev
argument_list|,
name|port
argument_list|,
name|props
argument_list|)
expr_stmt|;
name|dev
operator|=
name|to_c4iw_dev
argument_list|(
name|ibdev
argument_list|)
expr_stmt|;
name|sc
operator|=
name|dev
operator|->
name|rdev
operator|.
name|adap
expr_stmt|;
if|if
condition|(
name|port
operator|>
name|sc
operator|->
name|params
operator|.
name|nports
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|pi
operator|=
name|sc
operator|->
name|port
index|[
name|port
operator|-
literal|1
index|]
expr_stmt|;
name|ifp
operator|=
name|pi
operator|->
name|vi
index|[
literal|0
index|]
operator|.
name|ifp
expr_stmt|;
name|memset
argument_list|(
name|props
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ib_port_attr
argument_list|)
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_mtu
operator|=
name|IB_MTU_4096
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_mtu
operator|>=
literal|4096
condition|)
name|props
operator|->
name|active_mtu
operator|=
name|IB_MTU_4096
expr_stmt|;
elseif|else
if|if
condition|(
name|ifp
operator|->
name|if_mtu
operator|>=
literal|2048
condition|)
name|props
operator|->
name|active_mtu
operator|=
name|IB_MTU_2048
expr_stmt|;
elseif|else
if|if
condition|(
name|ifp
operator|->
name|if_mtu
operator|>=
literal|1024
condition|)
name|props
operator|->
name|active_mtu
operator|=
name|IB_MTU_1024
expr_stmt|;
elseif|else
if|if
condition|(
name|ifp
operator|->
name|if_mtu
operator|>=
literal|512
condition|)
name|props
operator|->
name|active_mtu
operator|=
name|IB_MTU_512
expr_stmt|;
else|else
name|props
operator|->
name|active_mtu
operator|=
name|IB_MTU_256
expr_stmt|;
name|props
operator|->
name|state
operator|=
name|pi
operator|->
name|link_cfg
operator|.
name|link_ok
condition|?
name|IB_PORT_ACTIVE
else|:
name|IB_PORT_DOWN
expr_stmt|;
name|props
operator|->
name|port_cap_flags
operator|=
name|IB_PORT_CM_SUP
operator||
name|IB_PORT_SNMP_TUNNEL_SUP
operator||
name|IB_PORT_REINIT_SUP
operator||
name|IB_PORT_DEVICE_MGMT_SUP
operator||
name|IB_PORT_VENDOR_CLASS_SUP
operator||
name|IB_PORT_BOOT_MGMT_SUP
expr_stmt|;
name|props
operator|->
name|gid_tbl_len
operator|=
literal|1
expr_stmt|;
name|props
operator|->
name|pkey_tbl_len
operator|=
literal|1
expr_stmt|;
name|props
operator|->
name|active_width
operator|=
literal|2
expr_stmt|;
name|props
operator|->
name|active_speed
operator|=
literal|2
expr_stmt|;
name|props
operator|->
name|max_msg_sz
operator|=
operator|-
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Returns -errno on error.  */
end_comment

begin_function
name|int
name|c4iw_register_device
parameter_list|(
name|struct
name|c4iw_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|sc
init|=
name|dev
operator|->
name|rdev
operator|.
name|adap
decl_stmt|;
name|struct
name|ib_device
modifier|*
name|ibdev
init|=
operator|&
name|dev
operator|->
name|ibdev
decl_stmt|;
name|struct
name|iw_cm_verbs
modifier|*
name|iwcm
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s c4iw_dev %p, adapter %p"
argument_list|,
name|__func__
argument_list|,
name|dev
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|sc
operator|->
name|port
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ibdev
operator|->
name|name
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|ibdev
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ibdev
operator|->
name|node_guid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ibdev
operator|->
name|node_guid
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ibdev
operator|->
name|node_guid
argument_list|,
name|sc
operator|->
name|port
index|[
literal|0
index|]
operator|->
name|vi
index|[
literal|0
index|]
operator|.
name|hw_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|ibdev
operator|->
name|owner
operator|=
name|THIS_MODULE
expr_stmt|;
name|dev
operator|->
name|device_cap_flags
operator|=
name|IB_DEVICE_LOCAL_DMA_LKEY
operator||
name|IB_DEVICE_MEM_WINDOW
expr_stmt|;
if|if
condition|(
name|fastreg_support
condition|)
name|dev
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_MEM_MGT_EXTENSIONS
expr_stmt|;
name|ibdev
operator|->
name|local_dma_lkey
operator|=
literal|0
expr_stmt|;
name|ibdev
operator|->
name|uverbs_cmd_mask
operator|=
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_GET_CONTEXT
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_DEVICE
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_PORT
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_ALLOC_PD
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DEALLOC_PD
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_REG_MR
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DEREG_MR
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DESTROY_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_REQ_NOTIFY_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_MODIFY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_POLL_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DESTROY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_POST_SEND
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_POST_RECV
operator|)
expr_stmt|;
name|ibdev
operator|->
name|node_type
operator|=
name|RDMA_NODE_RNIC
expr_stmt|;
name|strlcpy
argument_list|(
name|ibdev
operator|->
name|node_desc
argument_list|,
name|C4IW_NODE_DESC
argument_list|,
sizeof|sizeof
argument_list|(
name|ibdev
operator|->
name|node_desc
argument_list|)
argument_list|)
expr_stmt|;
name|ibdev
operator|->
name|phys_port_cnt
operator|=
name|sc
operator|->
name|params
operator|.
name|nports
expr_stmt|;
name|ibdev
operator|->
name|num_comp_vectors
operator|=
literal|1
expr_stmt|;
name|ibdev
operator|->
name|dma_device
operator|=
name|NULL
expr_stmt|;
name|ibdev
operator|->
name|query_device
operator|=
name|c4iw_query_device
expr_stmt|;
name|ibdev
operator|->
name|query_port
operator|=
name|c4iw_query_port
expr_stmt|;
name|ibdev
operator|->
name|modify_port
operator|=
name|c4iw_modify_port
expr_stmt|;
name|ibdev
operator|->
name|query_pkey
operator|=
name|c4iw_query_pkey
expr_stmt|;
name|ibdev
operator|->
name|query_gid
operator|=
name|c4iw_query_gid
expr_stmt|;
name|ibdev
operator|->
name|alloc_ucontext
operator|=
name|c4iw_alloc_ucontext
expr_stmt|;
name|ibdev
operator|->
name|dealloc_ucontext
operator|=
name|c4iw_dealloc_ucontext
expr_stmt|;
name|ibdev
operator|->
name|mmap
operator|=
name|c4iw_mmap
expr_stmt|;
name|ibdev
operator|->
name|alloc_pd
operator|=
name|c4iw_allocate_pd
expr_stmt|;
name|ibdev
operator|->
name|dealloc_pd
operator|=
name|c4iw_deallocate_pd
expr_stmt|;
name|ibdev
operator|->
name|create_ah
operator|=
name|c4iw_ah_create
expr_stmt|;
name|ibdev
operator|->
name|destroy_ah
operator|=
name|c4iw_ah_destroy
expr_stmt|;
name|ibdev
operator|->
name|create_qp
operator|=
name|c4iw_create_qp
expr_stmt|;
name|ibdev
operator|->
name|modify_qp
operator|=
name|c4iw_ib_modify_qp
expr_stmt|;
name|ibdev
operator|->
name|query_qp
operator|=
name|c4iw_ib_query_qp
expr_stmt|;
name|ibdev
operator|->
name|destroy_qp
operator|=
name|c4iw_destroy_qp
expr_stmt|;
name|ibdev
operator|->
name|create_cq
operator|=
name|c4iw_create_cq
expr_stmt|;
name|ibdev
operator|->
name|destroy_cq
operator|=
name|c4iw_destroy_cq
expr_stmt|;
name|ibdev
operator|->
name|resize_cq
operator|=
name|c4iw_resize_cq
expr_stmt|;
name|ibdev
operator|->
name|poll_cq
operator|=
name|c4iw_poll_cq
expr_stmt|;
name|ibdev
operator|->
name|get_dma_mr
operator|=
name|c4iw_get_dma_mr
expr_stmt|;
name|ibdev
operator|->
name|reg_phys_mr
operator|=
name|c4iw_register_phys_mem
expr_stmt|;
name|ibdev
operator|->
name|rereg_phys_mr
operator|=
name|c4iw_reregister_phys_mem
expr_stmt|;
name|ibdev
operator|->
name|reg_user_mr
operator|=
name|c4iw_reg_user_mr
expr_stmt|;
name|ibdev
operator|->
name|dereg_mr
operator|=
name|c4iw_dereg_mr
expr_stmt|;
name|ibdev
operator|->
name|alloc_mw
operator|=
name|c4iw_alloc_mw
expr_stmt|;
name|ibdev
operator|->
name|bind_mw
operator|=
name|c4iw_bind_mw
expr_stmt|;
name|ibdev
operator|->
name|dealloc_mw
operator|=
name|c4iw_dealloc_mw
expr_stmt|;
name|ibdev
operator|->
name|alloc_fast_reg_mr
operator|=
name|c4iw_alloc_fast_reg_mr
expr_stmt|;
name|ibdev
operator|->
name|alloc_fast_reg_page_list
operator|=
name|c4iw_alloc_fastreg_pbl
expr_stmt|;
name|ibdev
operator|->
name|free_fast_reg_page_list
operator|=
name|c4iw_free_fastreg_pbl
expr_stmt|;
name|ibdev
operator|->
name|attach_mcast
operator|=
name|c4iw_multicast_attach
expr_stmt|;
name|ibdev
operator|->
name|detach_mcast
operator|=
name|c4iw_multicast_detach
expr_stmt|;
name|ibdev
operator|->
name|process_mad
operator|=
name|c4iw_process_mad
expr_stmt|;
name|ibdev
operator|->
name|req_notify_cq
operator|=
name|c4iw_arm_cq
expr_stmt|;
name|ibdev
operator|->
name|post_send
operator|=
name|c4iw_post_send
expr_stmt|;
name|ibdev
operator|->
name|post_recv
operator|=
name|c4iw_post_receive
expr_stmt|;
name|ibdev
operator|->
name|uverbs_abi_ver
operator|=
name|C4IW_UVERBS_ABI_VERSION
expr_stmt|;
name|iwcm
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|iwcm
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iwcm
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|iwcm
operator|->
name|connect
operator|=
name|c4iw_connect
expr_stmt|;
name|iwcm
operator|->
name|accept
operator|=
name|c4iw_accept_cr
expr_stmt|;
name|iwcm
operator|->
name|reject
operator|=
name|c4iw_reject_cr
expr_stmt|;
name|iwcm
operator|->
name|create_listen_ep
operator|=
name|c4iw_create_listen_ep
expr_stmt|;
name|iwcm
operator|->
name|destroy_listen_ep
operator|=
name|c4iw_destroy_listen_ep
expr_stmt|;
name|iwcm
operator|->
name|newconn
operator|=
name|process_newconn
expr_stmt|;
name|iwcm
operator|->
name|add_ref
operator|=
name|c4iw_qp_add_ref
expr_stmt|;
name|iwcm
operator|->
name|rem_ref
operator|=
name|c4iw_qp_rem_ref
expr_stmt|;
name|iwcm
operator|->
name|get_qp
operator|=
name|c4iw_get_qp
expr_stmt|;
name|ibdev
operator|->
name|iwcm
operator|=
name|iwcm
expr_stmt|;
name|ret
operator|=
name|ib_register_device
argument_list|(
operator|&
name|dev
operator|->
name|ibdev
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|kfree
argument_list|(
name|iwcm
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
name|c4iw_unregister_device
parameter_list|(
name|struct
name|c4iw_dev
modifier|*
name|dev
parameter_list|)
block|{
name|CTR3
argument_list|(
name|KTR_IW_CXGBE
argument_list|,
literal|"%s c4iw_dev %p, adapter %p"
argument_list|,
name|__func__
argument_list|,
name|dev
argument_list|,
name|dev
operator|->
name|rdev
operator|.
name|adap
argument_list|)
expr_stmt|;
name|ib_unregister_device
argument_list|(
operator|&
name|dev
operator|->
name|ibdev
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|dev
operator|->
name|ibdev
operator|.
name|iwcm
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


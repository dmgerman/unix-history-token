begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2011, Bryan Venteicher<bryanv@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/* Driver for VirtIO memory balloon devices. */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/kthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/sglist.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_page.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/virtio/virtio.h>
end_include

begin_include
include|#
directive|include
file|<dev/virtio/virtqueue.h>
end_include

begin_include
include|#
directive|include
file|<dev/virtio/balloon/virtio_balloon.h>
end_include

begin_include
include|#
directive|include
file|"virtio_if.h"
end_include

begin_struct
struct|struct
name|vtballoon_softc
block|{
name|device_t
name|vtballoon_dev
decl_stmt|;
name|struct
name|mtx
name|vtballoon_mtx
decl_stmt|;
name|uint64_t
name|vtballoon_features
decl_stmt|;
name|uint32_t
name|vtballoon_flags
decl_stmt|;
define|#
directive|define
name|VTBALLOON_FLAG_DETACH
value|0x01
name|struct
name|virtqueue
modifier|*
name|vtballoon_inflate_vq
decl_stmt|;
name|struct
name|virtqueue
modifier|*
name|vtballoon_deflate_vq
decl_stmt|;
name|uint32_t
name|vtballoon_desired_npages
decl_stmt|;
name|uint32_t
name|vtballoon_current_npages
decl_stmt|;
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|vm_page
argument_list|)
name|vtballoon_pages
expr_stmt|;
name|struct
name|thread
modifier|*
name|vtballoon_td
decl_stmt|;
name|uint32_t
modifier|*
name|vtballoon_page_frames
decl_stmt|;
name|int
name|vtballoon_timeout
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|virtio_feature_desc
name|vtballoon_feature_desc
index|[]
init|=
block|{
block|{
name|VIRTIO_BALLOON_F_MUST_TELL_HOST
block|,
literal|"MustTellHost"
block|}
block|,
block|{
name|VIRTIO_BALLOON_F_STATS_VQ
block|,
literal|"StatsVq"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|vtballoon_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vtballoon_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vtballoon_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vtballoon_config_change
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vtballoon_negotiate_features
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vtballoon_alloc_virtqueues
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vtballoon_vq_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vtballoon_inflate
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vtballoon_deflate
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vtballoon_send_page_frames
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|,
name|struct
name|virtqueue
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vtballoon_pop
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vtballoon_stop
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|vm_page_t
name|vtballoon_alloc_page
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vtballoon_free_page
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|,
name|vm_page_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vtballoon_sleep
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vtballoon_thread
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vtballoon_add_sysctl
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Features desired/implemented by this driver. */
end_comment

begin_define
define|#
directive|define
name|VTBALLOON_FEATURES
value|0
end_define

begin_comment
comment|/* Timeout between retries when the balloon needs inflating. */
end_comment

begin_define
define|#
directive|define
name|VTBALLOON_LOWMEM_TIMEOUT
value|hz
end_define

begin_comment
comment|/*  * Maximum number of pages we'll request to inflate or deflate  * the balloon in one virtqueue request. Both Linux and NetBSD  * have settled on 256, doing up to 1MB at a time.  */
end_comment

begin_define
define|#
directive|define
name|VTBALLOON_PAGES_PER_REQUEST
value|256
end_define

begin_comment
comment|/* Must be able to fix all pages frames in one page (segment). */
end_comment

begin_expr_stmt
name|CTASSERT
argument_list|(
name|VTBALLOON_PAGES_PER_REQUEST
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|<=
name|PAGE_SIZE
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|VTBALLOON_MTX
parameter_list|(
name|_sc
parameter_list|)
value|&(_sc)->vtballoon_mtx
end_define

begin_define
define|#
directive|define
name|VTBALLOON_LOCK_INIT
parameter_list|(
name|_sc
parameter_list|,
name|_name
parameter_list|)
value|mtx_init(VTBALLOON_MTX((_sc)), _name, \ 					    "VirtIO Balloon Lock", MTX_DEF)
end_define

begin_define
define|#
directive|define
name|VTBALLOON_LOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_lock(VTBALLOON_MTX((_sc)))
end_define

begin_define
define|#
directive|define
name|VTBALLOON_UNLOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_unlock(VTBALLOON_MTX((_sc)))
end_define

begin_define
define|#
directive|define
name|VTBALLOON_LOCK_DESTROY
parameter_list|(
name|_sc
parameter_list|)
value|mtx_destroy(VTBALLOON_MTX((_sc)))
end_define

begin_decl_stmt
specifier|static
name|device_method_t
name|vtballoon_methods
index|[]
init|=
block|{
comment|/* Device methods. */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|vtballoon_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|vtballoon_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|vtballoon_detach
argument_list|)
block|,
comment|/* VirtIO methods. */
name|DEVMETHOD
argument_list|(
name|virtio_config_change
argument_list|,
name|vtballoon_config_change
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|vtballoon_driver
init|=
block|{
literal|"vtballoon"
block|,
name|vtballoon_methods
block|,
expr|sizeof
operator|(
expr|struct
name|vtballoon_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|vtballoon_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|virtio_balloon
argument_list|,
name|virtio_pci
argument_list|,
name|vtballoon_driver
argument_list|,
name|vtballoon_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|virtio_balloon
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|virtio_balloon
argument_list|,
name|virtio
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|vtballoon_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|virtio_get_device_type
argument_list|(
name|dev
argument_list|)
operator|!=
name|VIRTIO_ID_BALLOON
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"VirtIO Balloon Adapter"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vtballoon_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|vtballoon_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vtballoon_dev
operator|=
name|dev
expr_stmt|;
name|VTBALLOON_LOCK_INIT
argument_list|(
name|sc
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|vtballoon_pages
argument_list|)
expr_stmt|;
name|vtballoon_add_sysctl
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|virtio_set_feature_desc
argument_list|(
name|dev
argument_list|,
name|vtballoon_feature_desc
argument_list|)
expr_stmt|;
name|vtballoon_negotiate_features
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vtballoon_page_frames
operator|=
name|malloc
argument_list|(
name|VTBALLOON_PAGES_PER_REQUEST
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vtballoon_page_frames
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate page frame request array\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|vtballoon_alloc_virtqueues
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate virtqueues\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|virtio_setup_intr
argument_list|(
name|dev
argument_list|,
name|INTR_TYPE_MISC
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot setup virtqueue interrupts\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|kthread_add
argument_list|(
name|vtballoon_thread
argument_list|,
name|sc
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|vtballoon_td
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|"virtio_balloon"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot create balloon kthread\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|virtqueue_enable_intr
argument_list|(
name|sc
operator|->
name|vtballoon_inflate_vq
argument_list|)
expr_stmt|;
name|virtqueue_enable_intr
argument_list|(
name|sc
operator|->
name|vtballoon_deflate_vq
argument_list|)
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|error
condition|)
name|vtballoon_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vtballoon_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|vtballoon_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vtballoon_td
operator|!=
name|NULL
condition|)
block|{
name|VTBALLOON_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vtballoon_flags
operator||=
name|VTBALLOON_FLAG_DETACH
expr_stmt|;
name|wakeup_one
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
name|sc
operator|->
name|vtballoon_td
argument_list|,
name|VTBALLOON_MTX
argument_list|(
name|sc
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|"vtbdth"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|VTBALLOON_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vtballoon_td
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|device_is_attached
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|vtballoon_pop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vtballoon_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vtballoon_page_frames
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|sc
operator|->
name|vtballoon_page_frames
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vtballoon_page_frames
operator|=
name|NULL
expr_stmt|;
block|}
name|VTBALLOON_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vtballoon_config_change
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|vtballoon_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|VTBALLOON_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|wakeup_one
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VTBALLOON_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_negotiate_features
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|uint64_t
name|features
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vtballoon_dev
expr_stmt|;
name|features
operator|=
name|virtio_negotiate_features
argument_list|(
name|dev
argument_list|,
name|VTBALLOON_FEATURES
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vtballoon_features
operator|=
name|features
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vtballoon_alloc_virtqueues
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|vq_alloc_info
name|vq_info
index|[
literal|2
index|]
decl_stmt|;
name|int
name|nvqs
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vtballoon_dev
expr_stmt|;
name|nvqs
operator|=
literal|2
expr_stmt|;
name|VQ_ALLOC_INFO_INIT
argument_list|(
operator|&
name|vq_info
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
name|vtballoon_vq_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vtballoon_inflate_vq
argument_list|,
literal|"%s inflate"
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|VQ_ALLOC_INFO_INIT
argument_list|(
operator|&
name|vq_info
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
name|vtballoon_vq_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vtballoon_deflate_vq
argument_list|,
literal|"%s deflate"
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|virtio_alloc_virtqueues
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|nvqs
argument_list|,
name|vq_info
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_vq_intr
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|vtballoon_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|VTBALLOON_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|wakeup_one
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VTBALLOON_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_inflate
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|,
name|int
name|npages
parameter_list|)
block|{
name|struct
name|virtqueue
modifier|*
name|vq
decl_stmt|;
name|vm_page_t
name|m
decl_stmt|;
name|int
name|i
decl_stmt|;
name|vq
operator|=
name|sc
operator|->
name|vtballoon_inflate_vq
expr_stmt|;
if|if
condition|(
name|npages
operator|>
name|VTBALLOON_PAGES_PER_REQUEST
condition|)
name|npages
operator|=
name|VTBALLOON_PAGES_PER_REQUEST
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|npages
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|m
operator|=
name|vtballoon_alloc_page
argument_list|(
name|sc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|vtballoon_timeout
operator|=
name|VTBALLOON_LOWMEM_TIMEOUT
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|vtballoon_page_frames
index|[
name|i
index|]
operator|=
name|VM_PAGE_TO_PHYS
argument_list|(
name|m
argument_list|)
operator|>>
name|VIRTIO_BALLOON_PFN_SHIFT
expr_stmt|;
name|KASSERT
argument_list|(
name|m
operator|->
name|queue
operator|==
name|PQ_NONE
argument_list|,
operator|(
literal|"%s: allocated page %p on queue"
operator|,
name|__func__
operator|,
name|m
operator|)
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|vtballoon_pages
argument_list|,
name|m
argument_list|,
name|plinks
operator|.
name|q
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|vtballoon_send_page_frames
argument_list|(
name|sc
argument_list|,
name|vq
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_deflate
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|,
name|int
name|npages
parameter_list|)
block|{
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|vm_page
argument_list|)
name|free_pages
expr_stmt|;
name|struct
name|virtqueue
modifier|*
name|vq
decl_stmt|;
name|vm_page_t
name|m
decl_stmt|;
name|int
name|i
decl_stmt|;
name|vq
operator|=
name|sc
operator|->
name|vtballoon_deflate_vq
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|free_pages
argument_list|)
expr_stmt|;
if|if
condition|(
name|npages
operator|>
name|VTBALLOON_PAGES_PER_REQUEST
condition|)
name|npages
operator|=
name|VTBALLOON_PAGES_PER_REQUEST
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|npages
condition|;
name|i
operator|++
control|)
block|{
name|m
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|vtballoon_pages
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|m
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s: no more pages to deflate"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vtballoon_page_frames
index|[
name|i
index|]
operator|=
name|VM_PAGE_TO_PHYS
argument_list|(
name|m
argument_list|)
operator|>>
name|VIRTIO_BALLOON_PFN_SHIFT
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|vtballoon_pages
argument_list|,
name|m
argument_list|,
name|plinks
operator|.
name|q
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|free_pages
argument_list|,
name|m
argument_list|,
name|plinks
operator|.
name|q
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|>
literal|0
condition|)
block|{
comment|/* Always tell host first before freeing the pages. */
name|vtballoon_send_page_frames
argument_list|(
name|sc
argument_list|,
name|vq
argument_list|,
name|i
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|m
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|free_pages
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|free_pages
argument_list|,
name|m
argument_list|,
name|plinks
operator|.
name|q
argument_list|)
expr_stmt|;
name|vtballoon_free_page
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
block|}
name|KASSERT
argument_list|(
operator|(
name|TAILQ_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|vtballoon_pages
argument_list|)
operator|&&
name|sc
operator|->
name|vtballoon_current_npages
operator|==
literal|0
operator|)
operator|||
operator|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|vtballoon_pages
argument_list|)
operator|&&
name|sc
operator|->
name|vtballoon_current_npages
operator|!=
literal|0
operator|)
argument_list|,
operator|(
literal|"%s: bogus page count %d"
operator|,
name|__func__
operator|,
name|sc
operator|->
name|vtballoon_current_npages
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_send_page_frames
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|virtqueue
modifier|*
name|vq
parameter_list|,
name|int
name|npages
parameter_list|)
block|{
name|struct
name|sglist
name|sg
decl_stmt|;
name|struct
name|sglist_seg
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|void
modifier|*
name|c
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sglist_init
argument_list|(
operator|&
name|sg
argument_list|,
literal|1
argument_list|,
name|segs
argument_list|)
expr_stmt|;
name|error
operator|=
name|sglist_append
argument_list|(
operator|&
name|sg
argument_list|,
name|sc
operator|->
name|vtballoon_page_frames
argument_list|,
name|npages
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|error
operator|==
literal|0
argument_list|,
operator|(
literal|"error adding page frames to sglist"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|virtqueue_enqueue
argument_list|(
name|vq
argument_list|,
name|vq
argument_list|,
operator|&
name|sg
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|error
operator|==
literal|0
argument_list|,
operator|(
literal|"error enqueuing page frames to virtqueue"
operator|)
argument_list|)
expr_stmt|;
name|virtqueue_notify
argument_list|(
name|vq
argument_list|)
expr_stmt|;
comment|/* 	 * Inflate and deflate operations are done synchronously. The 	 * interrupt handler will wake us up. 	 */
name|VTBALLOON_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|virtqueue_dequeue
argument_list|(
name|vq
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|msleep
argument_list|(
name|sc
argument_list|,
name|VTBALLOON_MTX
argument_list|(
name|sc
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|"vtbspf"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|VTBALLOON_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|c
operator|==
name|vq
argument_list|,
operator|(
literal|"unexpected balloon operation response"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_pop
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|)
block|{
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|vtballoon_pages
argument_list|)
condition|)
name|vtballoon_deflate
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|vtballoon_current_npages
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_stop
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|)
block|{
name|virtqueue_disable_intr
argument_list|(
name|sc
operator|->
name|vtballoon_inflate_vq
argument_list|)
expr_stmt|;
name|virtqueue_disable_intr
argument_list|(
name|sc
operator|->
name|vtballoon_deflate_vq
argument_list|)
expr_stmt|;
name|virtio_stop
argument_list|(
name|sc
operator|->
name|vtballoon_dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|vm_page_t
name|vtballoon_alloc_page
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|)
block|{
name|vm_page_t
name|m
decl_stmt|;
name|m
operator|=
name|vm_page_alloc
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|,
name|VM_ALLOC_NORMAL
operator||
name|VM_ALLOC_NOOBJ
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|sc
operator|->
name|vtballoon_current_npages
operator|++
expr_stmt|;
return|return
operator|(
name|m
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_free_page
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|,
name|vm_page_t
name|m
parameter_list|)
block|{
name|vm_page_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vtballoon_current_npages
operator|--
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|vtballoon_desired_size
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|desired
decl_stmt|;
name|desired
operator|=
name|virtio_read_dev_config_4
argument_list|(
name|sc
operator|->
name|vtballoon_dev
argument_list|,
name|offsetof
argument_list|(
expr|struct
name|virtio_balloon_config
argument_list|,
name|num_pages
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|le32toh
argument_list|(
name|desired
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_update_size
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|)
block|{
name|virtio_write_dev_config_4
argument_list|(
name|sc
operator|->
name|vtballoon_dev
argument_list|,
name|offsetof
argument_list|(
expr|struct
name|virtio_balloon_config
argument_list|,
name|actual
argument_list|)
argument_list|,
name|htole32
argument_list|(
name|sc
operator|->
name|vtballoon_current_npages
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vtballoon_sleep
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|rc
decl_stmt|,
name|timeout
decl_stmt|;
name|uint32_t
name|current
decl_stmt|,
name|desired
decl_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
name|current
operator|=
name|sc
operator|->
name|vtballoon_current_npages
expr_stmt|;
name|VTBALLOON_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|vtballoon_flags
operator|&
name|VTBALLOON_FLAG_DETACH
condition|)
block|{
name|rc
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|desired
operator|=
name|vtballoon_desired_size
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vtballoon_desired_npages
operator|=
name|desired
expr_stmt|;
comment|/* 		 * If given, use non-zero timeout on the first time through 		 * the loop. On subsequent times, timeout will be zero so 		 * we will reevaluate the desired size of the balloon and 		 * break out to retry if needed. 		 */
name|timeout
operator|=
name|sc
operator|->
name|vtballoon_timeout
expr_stmt|;
name|sc
operator|->
name|vtballoon_timeout
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|current
operator|>
name|desired
condition|)
break|break;
if|if
condition|(
name|current
operator|<
name|desired
operator|&&
name|timeout
operator|==
literal|0
condition|)
break|break;
name|msleep
argument_list|(
name|sc
argument_list|,
name|VTBALLOON_MTX
argument_list|(
name|sc
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|"vtbslp"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
block|}
name|VTBALLOON_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_thread
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|vtballoon_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|current
decl_stmt|,
name|desired
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|vtballoon_sleep
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
break|break;
name|current
operator|=
name|sc
operator|->
name|vtballoon_current_npages
expr_stmt|;
name|desired
operator|=
name|sc
operator|->
name|vtballoon_desired_npages
expr_stmt|;
if|if
condition|(
name|desired
operator|!=
name|current
condition|)
block|{
if|if
condition|(
name|desired
operator|>
name|current
condition|)
name|vtballoon_inflate
argument_list|(
name|sc
argument_list|,
name|desired
operator|-
name|current
argument_list|)
expr_stmt|;
else|else
name|vtballoon_deflate
argument_list|(
name|sc
argument_list|,
name|current
operator|-
name|desired
argument_list|)
expr_stmt|;
name|vtballoon_update_size
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
name|kthread_exit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vtballoon_add_sysctl
parameter_list|(
name|struct
name|vtballoon_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tree
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|child
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vtballoon_dev
expr_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|tree
operator|=
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|child
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"desired"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|vtballoon_desired_npages
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
literal|"Desired balloon size in pages"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"current"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|vtballoon_current_npages
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
literal|"Current balloon size in pages"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


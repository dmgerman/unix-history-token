begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $NetBSD: pcmcia_cis.c,v 1.17 2000/02/10 09:01:52 chopps Exp $ */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*-  * Copyright (c) 1997 Marc Horowitz.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Marc Horowitz.  * 4. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<dev/pccard/pccardreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pccard/pccardvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pccard/pccardvarp.h>
end_include

begin_include
include|#
directive|include
file|<dev/pccard/pccard_cis.h>
end_include

begin_include
include|#
directive|include
file|"card_if.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|pccard_cis_debug
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PCCARDCISDEBUG
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|PCCARDCISDEBUG
end_ifdef

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|arg
parameter_list|)
value|do { if (pccard_cis_debug) printf arg; } while (0)
end_define

begin_define
define|#
directive|define
name|DEVPRINTF
parameter_list|(
name|arg
parameter_list|)
value|do { if (pccard_cis_debug) device_printf arg; } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|arg
parameter_list|)
end_define

begin_define
define|#
directive|define
name|DEVPRINTF
parameter_list|(
name|arg
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|PCCARD_CIS_SIZE
value|4096
end_define

begin_struct
struct|struct
name|cis_state
block|{
name|int
name|count
decl_stmt|;
name|int
name|gotmfc
decl_stmt|;
name|struct
name|pccard_config_entry
name|temp_cfe
decl_stmt|;
name|struct
name|pccard_config_entry
modifier|*
name|default_cfe
decl_stmt|;
name|struct
name|pccard_card
modifier|*
name|card
decl_stmt|;
name|struct
name|pccard_function
modifier|*
name|pf
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|pccard_parse_cis_tuple
parameter_list|(
specifier|const
name|struct
name|pccard_tuple
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|decode_funce
parameter_list|(
specifier|const
name|struct
name|pccard_tuple
modifier|*
parameter_list|,
name|struct
name|pccard_function
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|pccard_read_cis
parameter_list|(
name|struct
name|pccard_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|cis_state
name|state
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|state
argument_list|,
sizeof|sizeof
name|state
argument_list|)
expr_stmt|;
name|state
operator|.
name|card
operator|=
operator|&
name|sc
operator|->
name|card
expr_stmt|;
name|state
operator|.
name|card
operator|->
name|error
operator|=
literal|0
expr_stmt|;
name|state
operator|.
name|card
operator|->
name|cis1_major
operator|=
operator|-
literal|1
expr_stmt|;
name|state
operator|.
name|card
operator|->
name|cis1_minor
operator|=
operator|-
literal|1
expr_stmt|;
name|state
operator|.
name|card
operator|->
name|cis1_info
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|state
operator|.
name|card
operator|->
name|cis1_info
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|state
operator|.
name|card
operator|->
name|cis1_info
index|[
literal|2
index|]
operator|=
name|NULL
expr_stmt|;
name|state
operator|.
name|card
operator|->
name|cis1_info
index|[
literal|3
index|]
operator|=
name|NULL
expr_stmt|;
name|state
operator|.
name|card
operator|->
name|manufacturer
operator|=
name|PCMCIA_VENDOR_INVALID
expr_stmt|;
name|state
operator|.
name|card
operator|->
name|product
operator|=
name|PCMCIA_PRODUCT_INVALID
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|state
operator|.
name|card
operator|->
name|pf_head
argument_list|)
expr_stmt|;
name|state
operator|.
name|pf
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * XXX The following shouldn't be needed, but some slow cards 	 * XXX seem to need it still.  Need to investigate if there's 	 * XXX a way to tell if the card is 'ready' or not rather than 	 * XXX sleeping like this.  We're called just after the power 	 * XXX up of the socket.  The standard timing diagrams don't 	 * XXX seem to indicate that a delay is required.  The old 	 * XXX delay was 1s.  This delay is .1s. 	 */
name|pause
argument_list|(
literal|"pccard"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|pccard_scan_cis
argument_list|(
name|device_get_parent
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|sc
operator|->
name|dev
argument_list|,
name|pccard_parse_cis_tuple
argument_list|,
operator|&
name|state
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|state
operator|.
name|card
operator|->
name|error
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pccard_scan_cis
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|device_t
name|dev
parameter_list|,
name|pccard_scan_t
name|fct
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|resource
modifier|*
name|res
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|struct
name|pccard_tuple
name|tuple
decl_stmt|;
name|int
name|longlink_present
decl_stmt|;
name|int
name|longlink_common
decl_stmt|;
name|u_long
name|longlink_addr
decl_stmt|;
comment|/* Type suspect */
name|int
name|mfc_count
decl_stmt|;
name|int
name|mfc_index
decl_stmt|;
ifdef|#
directive|ifdef
name|PCCARDCISDEBUG
name|int
name|cis_none_cnt
init|=
literal|10
decl_stmt|;
comment|/* Only report 10 CIS_NONEs */
endif|#
directive|endif
struct|struct
block|{
name|int
name|common
decl_stmt|;
name|u_long
name|addr
decl_stmt|;
block|}
name|mfc
index|[
literal|256
operator|/
literal|5
index|]
struct|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
comment|/* allocate some memory */
comment|/* 	 * Some reports from the field suggest that a 64k memory boundary 	 * helps card CIS being able to be read.  Try it here and see what 	 * the results actually are.  I'm not sure I understand why this 	 * would make cards work better, but it is easy enough to test. 	 */
name|rid
operator|=
literal|0
expr_stmt|;
name|res
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
name|PCCARD_CIS_SIZE
argument_list|,
name|RF_ACTIVE
operator||
name|rman_make_alignment_flags
argument_list|(
literal|64
operator|*
literal|1024
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't alloc memory to read attributes\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|CARD_SET_RES_FLAGS
argument_list|(
name|bus
argument_list|,
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rid
argument_list|,
name|PCCARD_A_MEM_ATTR
argument_list|)
expr_stmt|;
name|tuple
operator|.
name|memt
operator|=
name|rman_get_bustag
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|tuple
operator|.
name|memh
operator|=
name|rman_get_bushandle
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|tuple
operator|.
name|ptr
operator|=
literal|0
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"cis mem map 0x%x (resource: 0x%lx)\n"
operator|,
operator|(
name|unsigned
name|int
operator|)
name|tuple
operator|.
name|memh
operator|,
name|rman_get_start
argument_list|(
name|res
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tuple
operator|.
name|mult
operator|=
literal|2
expr_stmt|;
name|longlink_present
operator|=
literal|1
expr_stmt|;
name|longlink_common
operator|=
literal|1
expr_stmt|;
name|longlink_addr
operator|=
literal|0
expr_stmt|;
name|mfc_count
operator|=
literal|0
expr_stmt|;
name|mfc_index
operator|=
literal|0
expr_stmt|;
name|DEVPRINTF
argument_list|(
operator|(
name|dev
operator|,
literal|"CIS tuple chain:\n"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
while|while
condition|(
literal|1
condition|)
block|{
comment|/* 			 * Perform boundary check for insane cards. 			 * If CIS is too long, simulate CIS end. 			 * (This check may not be sufficient for 			 * malicious cards.) 			 */
if|if
condition|(
name|tuple
operator|.
name|mult
operator|*
name|tuple
operator|.
name|ptr
operator|>=
name|PCCARD_CIS_SIZE
operator|-
literal|1
operator|-
literal|32
comment|/* ad hoc value */
condition|)
block|{
name|printf
argument_list|(
literal|"CIS is too long -- truncating\n"
argument_list|)
expr_stmt|;
name|tuple
operator|.
name|code
operator|=
name|CISTPL_END
expr_stmt|;
block|}
else|else
block|{
comment|/* get the tuple code */
name|tuple
operator|.
name|code
operator|=
name|pccard_cis_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
name|tuple
operator|.
name|ptr
argument_list|)
expr_stmt|;
block|}
comment|/* two special-case tuples */
if|if
condition|(
name|tuple
operator|.
name|code
operator|==
name|CISTPL_NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|PCCARDCISDEBUG
if|if
condition|(
name|cis_none_cnt
operator|>
literal|0
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_NONE\n 00\n"
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cis_none_cnt
operator|==
literal|0
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"TOO MANY CIS_NONE\n"
operator|)
argument_list|)
expr_stmt|;
name|cis_none_cnt
operator|--
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
call|(
modifier|*
name|fct
call|)
argument_list|(
operator|&
name|tuple
argument_list|,
name|arg
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|tuple
operator|.
name|ptr
operator|++
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|tuple
operator|.
name|code
operator|==
name|CISTPL_END
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_END\n ff\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Call the function for the END tuple, since 				   the CIS semantics depend on it */
if|if
condition|(
call|(
modifier|*
name|fct
call|)
argument_list|(
operator|&
name|tuple
argument_list|,
name|arg
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|tuple
operator|.
name|ptr
operator|++
expr_stmt|;
break|break;
block|}
comment|/* now all the normal tuples */
name|tuple
operator|.
name|length
operator|=
name|pccard_cis_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
name|tuple
operator|.
name|ptr
operator|+
literal|1
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|tuple
operator|.
name|code
condition|)
block|{
case|case
name|CISTPL_LONGLINK_A
case|:
case|case
name|CISTPL_LONGLINK_C
case|:
if|if
condition|(
call|(
modifier|*
name|fct
call|)
argument_list|(
operator|&
name|tuple
argument_list|,
name|arg
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|tuple
operator|.
name|length
operator|<
literal|4
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_LONGLINK_%s too "
literal|"short %d\n"
operator|,
name|longlink_common
condition|?
literal|"C"
else|:
literal|"A"
operator|,
name|tuple
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|longlink_present
operator|=
literal|1
expr_stmt|;
name|longlink_common
operator|=
operator|(
name|tuple
operator|.
name|code
operator|==
name|CISTPL_LONGLINK_C
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|longlink_addr
operator|=
name|pccard_tuple_read_4
argument_list|(
operator|&
name|tuple
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_LONGLINK_%s %lx\n"
operator|,
name|longlink_common
condition|?
literal|"C"
else|:
literal|"A"
operator|,
name|longlink_addr
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CISTPL_NO_LINK
case|:
if|if
condition|(
call|(
modifier|*
name|fct
call|)
argument_list|(
operator|&
name|tuple
argument_list|,
name|arg
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|longlink_present
operator|=
literal|0
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_NO_LINK\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CISTPL_CHECKSUM
case|:
if|if
condition|(
call|(
modifier|*
name|fct
call|)
argument_list|(
operator|&
name|tuple
argument_list|,
name|arg
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|tuple
operator|.
name|length
operator|<
literal|5
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_CHECKSUM too "
literal|"short %d\n"
operator|,
name|tuple
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|{
name|int16_t
name|offset
decl_stmt|;
name|u_long
name|addr
decl_stmt|,
name|length
decl_stmt|;
name|u_int
name|cksum
decl_stmt|,
name|sum
decl_stmt|;
name|int
name|i
decl_stmt|;
name|offset
operator|=
operator|(
name|uint16_t
operator|)
name|pccard_tuple_read_2
argument_list|(
operator|&
name|tuple
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|length
operator|=
name|pccard_tuple_read_2
argument_list|(
operator|&
name|tuple
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|cksum
operator|=
name|pccard_tuple_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|addr
operator|=
name|tuple
operator|.
name|ptr
operator|+
name|offset
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_CHECKSUM addr=%lx "
literal|"len=%lx cksum=%x"
operator|,
name|addr
operator|,
name|length
operator|,
name|cksum
operator|)
argument_list|)
expr_stmt|;
comment|/* 					 * XXX do more work to deal with 					 * distant regions 					 */
if|if
condition|(
operator|(
name|addr
operator|>=
name|PCCARD_CIS_SIZE
operator|)
operator|||
operator|(
operator|(
name|addr
operator|+
name|length
operator|)
operator|>=
name|PCCARD_CIS_SIZE
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|" skipped, "
literal|"too distant\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|sum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
name|sum
operator|+=
name|bus_space_read_1
argument_list|(
name|tuple
operator|.
name|memt
argument_list|,
name|tuple
operator|.
name|memh
argument_list|,
name|addr
operator|+
name|tuple
operator|.
name|mult
operator|*
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|cksum
operator|!=
operator|(
name|sum
operator|&
literal|0xff
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|" failed sum=%x\n"
operator|,
name|sum
operator|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"CIS checksum failed\n"
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* 						 * XXX Some working cards have 						 * XXX bad checksums!! 						 */
block|ret = -1;
endif|#
directive|endif
block|}
else|else
block|{
name|DPRINTF
argument_list|(
operator|(
literal|" ok\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|CISTPL_LONGLINK_MFC
case|:
if|if
condition|(
name|tuple
operator|.
name|length
operator|<
literal|1
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_LONGLINK_MFC too "
literal|"short %d\n"
operator|,
name|tuple
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
operator|(
name|tuple
operator|.
name|length
operator|-
literal|1
operator|)
operator|%
literal|5
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_LONGLINK_MFC bogus "
literal|"length %d\n"
operator|,
name|tuple
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 				 * this is kind of ad hoc, as I don't have 				 * any real documentation 				 */
block|{
name|int
name|i
decl_stmt|,
name|tmp_count
decl_stmt|;
comment|/* 					 * put count into tmp var so that 					 * if we have to bail (because it's 					 * a bogus count) it won't be 					 * remembered for later use. 					 */
name|tmp_count
operator|=
name|pccard_tuple_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_LONGLINK_MFC %d"
operator|,
name|tmp_count
operator|)
argument_list|)
expr_stmt|;
comment|/* 					 * make _sure_ it's the right size; 					 * if too short, it may be a weird 					 * (unknown/undefined) format 					 */
if|if
condition|(
name|tuple
operator|.
name|length
operator|!=
operator|(
name|tmp_count
operator|*
literal|5
operator|+
literal|1
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|" bogus length %d\n"
operator|,
name|tuple
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 					 * sanity check for a programming 					 * error which is difficult to find 					 * when debugging. 					 */
if|if
condition|(
name|tmp_count
operator|>
name|howmany
argument_list|(
sizeof|sizeof
name|mfc
argument_list|,
sizeof|sizeof
name|mfc
index|[
literal|0
index|]
argument_list|)
condition|)
name|panic
argument_list|(
literal|"CISTPL_LONGLINK_MFC mfc "
literal|"count would blow stack"
argument_list|)
expr_stmt|;
name|mfc_count
operator|=
name|tmp_count
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mfc_count
condition|;
name|i
operator|++
control|)
block|{
name|mfc
index|[
name|i
index|]
operator|.
name|common
operator|=
operator|(
name|pccard_tuple_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
literal|1
operator|+
literal|5
operator|*
name|i
argument_list|)
operator|==
name|PCCARD_MFC_MEM_COMMON
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|mfc
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|pccard_tuple_read_4
argument_list|(
operator|&
name|tuple
argument_list|,
literal|1
operator|+
literal|5
operator|*
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|" %s:%lx"
operator|,
name|mfc
index|[
name|i
index|]
operator|.
name|common
condition|?
literal|"common"
else|:
literal|"attr"
operator|,
name|mfc
index|[
name|i
index|]
operator|.
name|addr
operator|)
argument_list|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* 				 * for LONGLINK_MFC, fall through to the 				 * function.  This tuple has structural and 				 * semantic content. 				 */
default|default:
block|{
if|if
condition|(
call|(
modifier|*
name|fct
call|)
argument_list|(
operator|&
name|tuple
argument_list|,
name|arg
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
break|break;
block|}
comment|/* switch */
ifdef|#
directive|ifdef
name|PCCARDCISDEBUG
comment|/* print the tuple */
block|{
name|int
name|i
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|" %02x %02x"
operator|,
name|tuple
operator|.
name|code
operator|,
name|tuple
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tuple
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|" %02x"
operator|,
name|pccard_tuple_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
name|i
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
literal|16
operator|)
operator|==
literal|13
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|i
operator|%
literal|16
operator|)
operator|!=
literal|14
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* skip to the next tuple */
name|tuple
operator|.
name|ptr
operator|+=
literal|2
operator|+
name|tuple
operator|.
name|length
expr_stmt|;
block|}
comment|/* 		 * the chain is done.  Clean up and move onto the next one, 		 * if any.  The loop is here in the case that there is an MFC 		 * card with no longlink (which defaults to existing, == 0). 		 * In general, this means that if one pointer fails, it will 		 * try the next one, instead of just bailing. 		 */
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|longlink_present
condition|)
block|{
name|CARD_SET_RES_FLAGS
argument_list|(
name|bus
argument_list|,
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rid
argument_list|,
name|longlink_common
condition|?
name|PCCARD_A_MEM_COM
else|:
name|PCCARD_A_MEM_ATTR
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"cis mem map %x\n"
operator|,
operator|(
name|unsigned
name|int
operator|)
name|tuple
operator|.
name|memh
operator|)
argument_list|)
expr_stmt|;
name|tuple
operator|.
name|mult
operator|=
name|longlink_common
condition|?
literal|1
else|:
literal|2
expr_stmt|;
name|tuple
operator|.
name|ptr
operator|=
name|longlink_addr
expr_stmt|;
name|longlink_present
operator|=
literal|0
expr_stmt|;
name|longlink_common
operator|=
literal|1
expr_stmt|;
name|longlink_addr
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mfc_count
operator|&&
operator|(
name|mfc_index
operator|<
name|mfc_count
operator|)
condition|)
block|{
name|CARD_SET_RES_FLAGS
argument_list|(
name|bus
argument_list|,
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rid
argument_list|,
name|mfc
index|[
name|mfc_index
index|]
operator|.
name|common
condition|?
name|PCCARD_A_MEM_COM
else|:
name|PCCARD_A_MEM_ATTR
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"cis mem map %x\n"
operator|,
operator|(
name|unsigned
name|int
operator|)
name|tuple
operator|.
name|memh
operator|)
argument_list|)
expr_stmt|;
comment|/* set parse state, and point at the next one */
name|tuple
operator|.
name|mult
operator|=
name|mfc
index|[
name|mfc_index
index|]
operator|.
name|common
condition|?
literal|1
else|:
literal|2
expr_stmt|;
name|tuple
operator|.
name|ptr
operator|=
name|mfc
index|[
name|mfc_index
index|]
operator|.
name|addr
expr_stmt|;
name|mfc_index
operator|++
expr_stmt|;
block|}
else|else
block|{
goto|goto
name|done
goto|;
block|}
comment|/* make sure that the link is valid */
name|tuple
operator|.
name|code
operator|=
name|pccard_cis_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
name|tuple
operator|.
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tuple
operator|.
name|code
operator|!=
name|CISTPL_LINKTARGET
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_LINKTARGET expected, "
literal|"code %02x observed\n"
operator|,
name|tuple
operator|.
name|code
operator|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|tuple
operator|.
name|length
operator|=
name|pccard_cis_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
name|tuple
operator|.
name|ptr
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tuple
operator|.
name|length
operator|<
literal|3
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_LINKTARGET too short %d\n"
operator|,
name|tuple
operator|.
name|length
operator|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|pccard_tuple_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
literal|0
argument_list|)
operator|!=
literal|'C'
operator|)
operator|||
operator|(
name|pccard_tuple_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
literal|1
argument_list|)
operator|!=
literal|'I'
operator|)
operator|||
operator|(
name|pccard_tuple_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
literal|2
argument_list|)
operator|!=
literal|'S'
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_LINKTARGET magic "
literal|"%02x%02x%02x incorrect\n"
operator|,
name|pccard_tuple_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
literal|0
argument_list|)
operator|,
name|pccard_tuple_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
literal|1
argument_list|)
operator|,
name|pccard_tuple_read_1
argument_list|(
operator|&
name|tuple
argument_list|,
literal|2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|tuple
operator|.
name|ptr
operator|+=
literal|2
operator|+
name|tuple
operator|.
name|length
expr_stmt|;
break|break;
block|}
block|}
name|done
label|:
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rid
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX this is incredibly verbose.  Not sure what trt is */
end_comment

begin_function
name|void
name|pccard_print_cis
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|pccard_softc
modifier|*
name|sc
init|=
name|PCCARD_SOFTC
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|pccard_card
modifier|*
name|card
init|=
operator|&
name|sc
operator|->
name|card
decl_stmt|;
name|struct
name|pccard_function
modifier|*
name|pf
decl_stmt|;
name|struct
name|pccard_config_entry
modifier|*
name|cfe
decl_stmt|;
name|int
name|i
decl_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"CIS version "
argument_list|)
expr_stmt|;
if|if
condition|(
name|card
operator|->
name|cis1_major
operator|==
literal|4
condition|)
block|{
if|if
condition|(
name|card
operator|->
name|cis1_minor
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"PCCARD 1.0\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|card
operator|->
name|cis1_minor
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|"PCCARD 2.0 or 2.1\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|card
operator|->
name|cis1_major
operator|>=
literal|5
condition|)
name|printf
argument_list|(
literal|"PC Card Standard %d.%d\n"
argument_list|,
name|card
operator|->
name|cis1_major
argument_list|,
name|card
operator|->
name|cis1_minor
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"unknown (major=%d, minor=%d)\n"
argument_list|,
name|card
operator|->
name|cis1_major
argument_list|,
name|card
operator|->
name|cis1_minor
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"CIS info: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|card
operator|->
name|cis1_info
index|[
name|i
index|]
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|i
condition|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|card
operator|->
name|cis1_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Manufacturer code 0x%x, product 0x%x\n"
argument_list|,
name|card
operator|->
name|manufacturer
argument_list|,
name|card
operator|->
name|product
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|pf
argument_list|,
argument|&card->pf_head
argument_list|,
argument|pf_list
argument_list|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"function %d: "
argument_list|,
name|pf
operator|->
name|number
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pf
operator|->
name|function
condition|)
block|{
case|case
name|PCCARD_FUNCTION_UNSPEC
case|:
name|printf
argument_list|(
literal|"unspecified"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_MULTIFUNCTION
case|:
name|printf
argument_list|(
literal|"multi-function"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_MEMORY
case|:
name|printf
argument_list|(
literal|"memory"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_SERIAL
case|:
name|printf
argument_list|(
literal|"serial port"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_PARALLEL
case|:
name|printf
argument_list|(
literal|"parallel port"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_DISK
case|:
name|printf
argument_list|(
literal|"fixed disk"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_VIDEO
case|:
name|printf
argument_list|(
literal|"video adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_NETWORK
case|:
name|printf
argument_list|(
literal|"network adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_AIMS
case|:
name|printf
argument_list|(
literal|"auto incrementing mass storage"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_SCSI
case|:
name|printf
argument_list|(
literal|"SCSI bridge"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_SECURITY
case|:
name|printf
argument_list|(
literal|"Security services"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_FUNCTION_INSTRUMENT
case|:
name|printf
argument_list|(
literal|"Instrument"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown (%d)"
argument_list|,
name|pf
operator|->
name|function
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|", ccr addr %x mask %x\n"
argument_list|,
name|pf
operator|->
name|ccr_base
argument_list|,
name|pf
operator|->
name|ccr_mask
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|cfe
argument_list|,
argument|&pf->cfe_head
argument_list|,
argument|cfe_list
argument_list|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"function %d, config table entry "
literal|"%d: "
argument_list|,
name|pf
operator|->
name|number
argument_list|,
name|cfe
operator|->
name|number
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cfe
operator|->
name|iftype
condition|)
block|{
case|case
name|PCCARD_IFTYPE_MEMORY
case|:
name|printf
argument_list|(
literal|"memory card"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_IFTYPE_IO
case|:
name|printf
argument_list|(
literal|"I/O card"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"card type unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"; irq mask %x"
argument_list|,
name|cfe
operator|->
name|irqmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|num_iospace
condition|)
block|{
name|printf
argument_list|(
literal|"; iomask %lx, iospace"
argument_list|,
name|cfe
operator|->
name|iomask
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfe
operator|->
name|num_iospace
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" %lx"
argument_list|,
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|length
condition|)
name|printf
argument_list|(
literal|"-%lx"
argument_list|,
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|start
operator|+
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|length
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cfe
operator|->
name|num_memspace
condition|)
block|{
name|printf
argument_list|(
literal|"; memspace"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfe
operator|->
name|num_memspace
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" %lx"
argument_list|,
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|cardaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|length
condition|)
name|printf
argument_list|(
literal|"-%lx"
argument_list|,
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|cardaddr
operator|+
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|length
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|hostaddr
condition|)
name|printf
argument_list|(
literal|"@%lx"
argument_list|,
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|hostaddr
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cfe
operator|->
name|maxtwins
condition|)
name|printf
argument_list|(
literal|"; maxtwins %d"
argument_list|,
name|cfe
operator|->
name|maxtwins
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|";"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_MWAIT_REQUIRED
condition|)
name|printf
argument_list|(
literal|" mwait_required"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_RDYBSY_ACTIVE
condition|)
name|printf
argument_list|(
literal|" rdybsy_active"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_WP_ACTIVE
condition|)
name|printf
argument_list|(
literal|" wp_active"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_BVD_ACTIVE
condition|)
name|printf
argument_list|(
literal|" bvd_active"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_IO8
condition|)
name|printf
argument_list|(
literal|" io8"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_IO16
condition|)
name|printf
argument_list|(
literal|" io16"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_IRQSHARE
condition|)
name|printf
argument_list|(
literal|" irqshare"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_IRQPULSE
condition|)
name|printf
argument_list|(
literal|" irqpulse"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_IRQLEVEL
condition|)
name|printf
argument_list|(
literal|" irqlevel"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_POWERDOWN
condition|)
name|printf
argument_list|(
literal|" powerdown"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_READONLY
condition|)
name|printf
argument_list|(
literal|" readonly"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|flags
operator|&
name|PCCARD_CFE_AUDIO
condition|)
name|printf
argument_list|(
literal|" audio"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|card
operator|->
name|error
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%d errors found while parsing CIS\n"
argument_list|,
name|card
operator|->
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|pccard_parse_cis_tuple
parameter_list|(
specifier|const
name|struct
name|pccard_tuple
modifier|*
name|tuple
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
comment|/* most of these are educated guesses */
specifier|static
name|struct
name|pccard_config_entry
name|init_cfe
init|=
block|{
operator|-
literal|1
block|,
name|PCCARD_CFE_RDYBSY_ACTIVE
operator||
name|PCCARD_CFE_WP_ACTIVE
operator||
name|PCCARD_CFE_BVD_ACTIVE
block|,
name|PCCARD_IFTYPE_MEMORY
block|, 	}
decl_stmt|;
name|struct
name|cis_state
modifier|*
name|state
init|=
name|arg
decl_stmt|;
switch|switch
condition|(
name|tuple
operator|->
name|code
condition|)
block|{
case|case
name|CISTPL_END
case|:
comment|/* if we've seen a LONGLINK_MFC, and this is the first 		 * END after it, reset the function list.   		 * 		 * XXX This might also be the right place to start a 		 * new function, but that assumes that a function 		 * definition never crosses any longlink, and I'm not 		 * sure about that.  This is probably safe for MFC 		 * cards, but what we have now isn't broken, so I'd 		 * rather not change it. 		 */
if|if
condition|(
name|state
operator|->
name|gotmfc
operator|==
literal|1
condition|)
block|{
name|struct
name|pccard_function
modifier|*
name|pf
decl_stmt|,
modifier|*
name|pfnext
decl_stmt|;
for|for
control|(
name|pf
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|state
operator|->
name|card
operator|->
name|pf_head
argument_list|)
init|;
name|pf
operator|!=
name|NULL
condition|;
name|pf
operator|=
name|pfnext
control|)
block|{
name|pfnext
operator|=
name|STAILQ_NEXT
argument_list|(
name|pf
argument_list|,
name|pf_list
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
name|STAILQ_INIT
argument_list|(
operator|&
name|state
operator|->
name|card
operator|->
name|pf_head
argument_list|)
expr_stmt|;
name|state
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|state
operator|->
name|gotmfc
operator|=
literal|2
expr_stmt|;
name|state
operator|->
name|pf
operator|=
name|NULL
expr_stmt|;
block|}
break|break;
case|case
name|CISTPL_LONGLINK_MFC
case|:
comment|/* 		 * this tuple's structure was dealt with in scan_cis.  here, 		 * record the fact that the MFC tuple was seen, so that 		 * functions declared before the MFC link can be cleaned 		 * up. 		 */
name|state
operator|->
name|gotmfc
operator|=
literal|1
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|PCCARDCISDEBUG
case|case
name|CISTPL_DEVICE
case|:
case|case
name|CISTPL_DEVICE_A
case|:
block|{
name|u_int
name|reg
decl_stmt|,
name|dtype
decl_stmt|,
name|dspeed
decl_stmt|;
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dtype
operator|=
name|reg
operator|&
name|PCCARD_DTYPE_MASK
expr_stmt|;
name|dspeed
operator|=
name|reg
operator|&
name|PCCARD_DSPEED_MASK
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_DEVICE%s type="
operator|,
operator|(
name|tuple
operator|->
name|code
operator|==
name|CISTPL_DEVICE
operator|)
condition|?
literal|""
else|:
literal|"_A"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dtype
condition|)
block|{
case|case
name|PCCARD_DTYPE_NULL
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"null"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DTYPE_ROM
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"rom"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DTYPE_OTPROM
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"otprom"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DTYPE_EPROM
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"eprom"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DTYPE_EEPROM
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"eeprom"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DTYPE_FLASH
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"flash"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DTYPE_SRAM
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"sram"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DTYPE_DRAM
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"dram"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DTYPE_FUNCSPEC
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"funcspec"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DTYPE_EXTEND
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"extend"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"reserved"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|" speed="
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dspeed
condition|)
block|{
case|case
name|PCCARD_DSPEED_NULL
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"null"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DSPEED_250NS
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"250ns"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DSPEED_200NS
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"200ns"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DSPEED_150NS
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"150ns"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DSPEED_100NS
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"100ns"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCCARD_DSPEED_EXT
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"ext"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"reserved"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|CISTPL_VERS_1
case|:
if|if
condition|(
name|tuple
operator|->
name|length
operator|<
literal|6
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_VERS_1 too short %d\n"
operator|,
name|tuple
operator|->
name|length
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|{
name|int
name|start
decl_stmt|,
name|i
decl_stmt|,
name|ch
decl_stmt|,
name|count
decl_stmt|;
name|state
operator|->
name|card
operator|->
name|cis1_major
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|state
operator|->
name|card
operator|->
name|cis1_minor
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
operator|,
name|start
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
operator|(
name|count
operator|<
literal|4
operator|)
operator|&&
operator|(
operator|(
name|i
operator|+
literal|4
operator|)
operator|<
literal|256
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|2
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|0xff
condition|)
break|break;
name|state
operator|->
name|card
operator|->
name|cis1_info_buf
index|[
name|i
index|]
operator|=
name|ch
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|0
condition|)
block|{
name|state
operator|->
name|card
operator|->
name|cis1_info
index|[
name|count
index|]
operator|=
name|state
operator|->
name|card
operator|->
name|cis1_info_buf
operator|+
name|start
expr_stmt|;
name|start
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_VERS_1\n"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CISTPL_MANFID
case|:
if|if
condition|(
name|tuple
operator|->
name|length
operator|<
literal|4
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_MANFID too short %d\n"
operator|,
name|tuple
operator|->
name|length
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|state
operator|->
name|card
operator|->
name|manufacturer
operator|=
name|pccard_tuple_read_2
argument_list|(
name|tuple
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|state
operator|->
name|card
operator|->
name|product
operator|=
name|pccard_tuple_read_2
argument_list|(
name|tuple
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* 		 * This is for xe driver. But not limited to that driver. 		 * In PC Card Standard, 		 * Manufacturer ID: 2byte. 		 * Product ID: typically 2bytes, but there's no limit on its 		 * size.  prodext is a two byte field, so maybe we should 		 * also handle the '6' case.  So far no cards have surfaced 		 * with a length of '6'. 		 */
if|if
condition|(
name|tuple
operator|->
name|length
operator|==
literal|5
condition|)
name|state
operator|->
name|card
operator|->
name|prodext
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_MANFID\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CISTPL_FUNCID
case|:
if|if
condition|(
name|tuple
operator|->
name|length
operator|<
literal|1
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_FUNCID too short %d\n"
operator|,
name|tuple
operator|->
name|length
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|state
operator|->
name|pf
operator|==
name|NULL
operator|)
operator|||
operator|(
name|state
operator|->
name|gotmfc
operator|==
literal|2
operator|)
condition|)
block|{
name|state
operator|->
name|pf
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|state
operator|->
name|pf
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|state
operator|->
name|pf
operator|->
name|number
operator|=
name|state
operator|->
name|count
operator|++
expr_stmt|;
name|state
operator|->
name|pf
operator|->
name|last_config_index
operator|=
operator|-
literal|1
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|state
operator|->
name|pf
operator|->
name|cfe_head
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|state
operator|->
name|card
operator|->
name|pf_head
argument_list|,
name|state
operator|->
name|pf
argument_list|,
name|pf_list
argument_list|)
expr_stmt|;
block|}
name|state
operator|->
name|pf
operator|->
name|function
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_FUNCID\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CISTPL_FUNCE
case|:
if|if
condition|(
name|state
operator|->
name|pf
operator|==
name|NULL
operator|||
name|state
operator|->
name|pf
operator|->
name|function
operator|<=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_FUNCE is not followed by "
literal|"valid CISTPL_FUNCID\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tuple
operator|->
name|length
operator|>=
literal|2
condition|)
name|decode_funce
argument_list|(
name|tuple
argument_list|,
name|state
operator|->
name|pf
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_FUNCE\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CISTPL_CONFIG
case|:
if|if
condition|(
name|tuple
operator|->
name|length
operator|<
literal|3
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_CONFIG too short %d\n"
operator|,
name|tuple
operator|->
name|length
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|{
name|u_int
name|reg
decl_stmt|,
name|rasz
decl_stmt|,
name|rmsz
decl_stmt|,
name|rfsz
decl_stmt|;
name|int
name|i
decl_stmt|;
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rasz
operator|=
literal|1
operator|+
operator|(
operator|(
name|reg
operator|&
name|PCCARD_TPCC_RASZ_MASK
operator|)
operator|>>
name|PCCARD_TPCC_RASZ_SHIFT
operator|)
expr_stmt|;
name|rmsz
operator|=
literal|1
operator|+
operator|(
operator|(
name|reg
operator|&
name|PCCARD_TPCC_RMSZ_MASK
operator|)
operator|>>
name|PCCARD_TPCC_RMSZ_SHIFT
operator|)
expr_stmt|;
name|rfsz
operator|=
operator|(
operator|(
name|reg
operator|&
name|PCCARD_TPCC_RFSZ_MASK
operator|)
operator|>>
name|PCCARD_TPCC_RFSZ_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|tuple
operator|->
name|length
operator|<
operator|(
name|rasz
operator|+
name|rmsz
operator|+
name|rfsz
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_CONFIG (%d,%d,%d) too "
literal|"short %d\n"
operator|,
name|rasz
operator|,
name|rmsz
operator|,
name|rfsz
operator|,
name|tuple
operator|->
name|length
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|state
operator|->
name|pf
operator|==
name|NULL
condition|)
block|{
name|state
operator|->
name|pf
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|state
operator|->
name|pf
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|state
operator|->
name|pf
operator|->
name|number
operator|=
name|state
operator|->
name|count
operator|++
expr_stmt|;
name|state
operator|->
name|pf
operator|->
name|last_config_index
operator|=
operator|-
literal|1
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|state
operator|->
name|pf
operator|->
name|cfe_head
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|state
operator|->
name|card
operator|->
name|pf_head
argument_list|,
name|state
operator|->
name|pf
argument_list|,
name|pf_list
argument_list|)
expr_stmt|;
name|state
operator|->
name|pf
operator|->
name|function
operator|=
name|PCCARD_FUNCTION_UNSPEC
expr_stmt|;
block|}
name|state
operator|->
name|pf
operator|->
name|last_config_index
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|state
operator|->
name|pf
operator|->
name|ccr_base
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rasz
condition|;
name|i
operator|++
control|)
name|state
operator|->
name|pf
operator|->
name|ccr_base
operator||=
operator|(
operator|(
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|2
operator|+
name|i
argument_list|)
operator|)
operator|<<
operator|(
name|i
operator|*
literal|8
operator|)
operator|)
expr_stmt|;
name|state
operator|->
name|pf
operator|->
name|ccr_mask
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rmsz
condition|;
name|i
operator|++
control|)
name|state
operator|->
name|pf
operator|->
name|ccr_mask
operator||=
operator|(
operator|(
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|2
operator|+
name|rasz
operator|+
name|i
argument_list|)
operator|)
operator|<<
operator|(
name|i
operator|*
literal|8
operator|)
operator|)
expr_stmt|;
comment|/* skip the reserved area and subtuples */
comment|/* reset the default cfe for each cfe list */
name|state
operator|->
name|temp_cfe
operator|=
name|init_cfe
expr_stmt|;
name|state
operator|->
name|default_cfe
operator|=
operator|&
name|state
operator|->
name|temp_cfe
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_CONFIG\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CISTPL_CFTABLE_ENTRY
case|:
block|{
name|int
name|idx
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_int
name|reg
decl_stmt|,
name|reg2
decl_stmt|;
name|u_int
name|intface
decl_stmt|,
name|def
decl_stmt|,
name|num
decl_stmt|;
name|u_int
name|power
decl_stmt|,
name|timing
decl_stmt|,
name|iospace
decl_stmt|,
name|irq
decl_stmt|,
name|memspace
decl_stmt|,
name|misc
decl_stmt|;
name|struct
name|pccard_config_entry
modifier|*
name|cfe
decl_stmt|;
name|idx
operator|=
literal|0
expr_stmt|;
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|intface
operator|=
name|reg
operator|&
name|PCCARD_TPCE_INDX_INTFACE
expr_stmt|;
name|def
operator|=
name|reg
operator|&
name|PCCARD_TPCE_INDX_DEFAULT
expr_stmt|;
name|num
operator|=
name|reg
operator|&
name|PCCARD_TPCE_INDX_NUM_MASK
expr_stmt|;
comment|/* 			 * this is a little messy.  Some cards have only a 			 * cfentry with the default bit set.  So, as we go 			 * through the list, we add new indexes to the queue, 			 * and keep a pointer to the last one with the 			 * default bit set.  if we see a record with the same 			 * index, as the default, we stash the default and 			 * replace the queue entry. otherwise, we just add 			 * new entries to the queue, pointing the default ptr 			 * at them if the default bit is set.  if we get to 			 * the end with the default pointer pointing at a 			 * record which hasn't had a matching index, that's 			 * ok; it just becomes a cfentry like any other. 			 */
comment|/* 			 * if the index in the cis differs from the default 			 * cis, create new entry in the queue and start it 			 * with the current default 			 */
if|if
condition|(
name|num
operator|!=
name|state
operator|->
name|default_cfe
operator|->
name|number
condition|)
block|{
name|cfe
operator|=
operator|(
expr|struct
name|pccard_config_entry
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cfe
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"no memory for config entry\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|abort_cfe
goto|;
block|}
operator|*
name|cfe
operator|=
operator|*
name|state
operator|->
name|default_cfe
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|state
operator|->
name|pf
operator|->
name|cfe_head
argument_list|,
name|cfe
argument_list|,
name|cfe_list
argument_list|)
expr_stmt|;
name|cfe
operator|->
name|number
operator|=
name|num
expr_stmt|;
comment|/* 				 * if the default bit is set in the cis, then 				 * point the new default at whatever is being 				 * filled in 				 */
if|if
condition|(
name|def
condition|)
name|state
operator|->
name|default_cfe
operator|=
name|cfe
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * the cis index matches the default index, 				 * fill in the default cfentry.  It is 				 * assumed that the cfdefault index is in the 				 * queue.  For it to be otherwise, the cis 				 * index would have to be -1 (initial 				 * condition) which is not possible, or there 				 * would have to be a preceding cis entry 				 * which had the same cis index and had the 				 * default bit unset. Neither condition 				 * should happen.  If it does, this cfentry 				 * is lost (written into temp space), which 				 * is an acceptable failure mode. 				 */
name|cfe
operator|=
name|state
operator|->
name|default_cfe
expr_stmt|;
comment|/* 				 * if the cis entry does not have the default 				 * bit set, copy the default out of the way 				 * first. 				 */
if|if
condition|(
operator|!
name|def
condition|)
block|{
name|state
operator|->
name|temp_cfe
operator|=
operator|*
name|state
operator|->
name|default_cfe
expr_stmt|;
name|state
operator|->
name|default_cfe
operator|=
operator|&
name|state
operator|->
name|temp_cfe
expr_stmt|;
block|}
block|}
if|if
condition|(
name|intface
condition|)
block|{
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|cfe
operator|->
name|flags
operator|&=
operator|~
operator|(
name|PCCARD_CFE_MWAIT_REQUIRED
operator||
name|PCCARD_CFE_RDYBSY_ACTIVE
operator||
name|PCCARD_CFE_WP_ACTIVE
operator||
name|PCCARD_CFE_BVD_ACTIVE
operator|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IF_MWAIT
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_MWAIT_REQUIRED
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IF_RDYBSY
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_RDYBSY_ACTIVE
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IF_WP
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_WP_ACTIVE
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IF_BVD
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_BVD_ACTIVE
expr_stmt|;
name|cfe
operator|->
name|iftype
operator|=
name|reg
operator|&
name|PCCARD_TPCE_IF_IFTYPE
expr_stmt|;
block|}
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|power
operator|=
name|reg
operator|&
name|PCCARD_TPCE_FS_POWER_MASK
expr_stmt|;
name|timing
operator|=
name|reg
operator|&
name|PCCARD_TPCE_FS_TIMING
expr_stmt|;
name|iospace
operator|=
name|reg
operator|&
name|PCCARD_TPCE_FS_IOSPACE
expr_stmt|;
name|irq
operator|=
name|reg
operator|&
name|PCCARD_TPCE_FS_IRQ
expr_stmt|;
name|memspace
operator|=
name|reg
operator|&
name|PCCARD_TPCE_FS_MEMSPACE_MASK
expr_stmt|;
name|misc
operator|=
name|reg
operator|&
name|PCCARD_TPCE_FS_MISC
expr_stmt|;
if|if
condition|(
name|power
condition|)
block|{
comment|/* skip over power, don't save */
comment|/* for each parameter selection byte */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|power
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
comment|/* for each bit */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|7
condition|;
name|j
operator|++
control|)
block|{
comment|/* if the bit is set */
if|if
condition|(
operator|(
name|reg
operator|>>
name|j
operator|)
operator|&
literal|0x01
condition|)
block|{
comment|/* skip over bytes */
do|do
block|{
name|reg2
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
comment|/* 								 * until 								 * non-extensi 								 * on byte 								 */
block|}
do|while
condition|(
name|reg2
operator|&
literal|0x80
condition|)
do|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|timing
condition|)
block|{
comment|/* skip over timing, don't save */
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
name|PCCARD_TPCE_TD_RESERVED_MASK
operator|)
operator|!=
name|PCCARD_TPCE_TD_RESERVED_MASK
condition|)
name|idx
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
name|PCCARD_TPCE_TD_RDYBSY_MASK
operator|)
operator|!=
name|PCCARD_TPCE_TD_RDYBSY_MASK
condition|)
name|idx
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
name|PCCARD_TPCE_TD_WAIT_MASK
operator|)
operator|!=
name|PCCARD_TPCE_TD_WAIT_MASK
condition|)
name|idx
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|iospace
condition|)
block|{
if|if
condition|(
name|tuple
operator|->
name|length
operator|<=
name|idx
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ran out of space before TCPE_IO\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|abort_cfe
goto|;
block|}
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|cfe
operator|->
name|flags
operator|&=
operator|~
operator|(
name|PCCARD_CFE_IO8
operator||
name|PCCARD_CFE_IO16
operator|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IO_BUSWIDTH_8BIT
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_IO8
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IO_BUSWIDTH_16BIT
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_IO16
expr_stmt|;
name|cfe
operator|->
name|iomask
operator|=
name|reg
operator|&
name|PCCARD_TPCE_IO_IOADDRLINES_MASK
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IO_HASRANGE
condition|)
block|{
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|cfe
operator|->
name|num_iospace
operator|=
literal|1
operator|+
operator|(
name|reg
operator|&
name|PCCARD_TPCE_IO_RANGE_COUNT
operator|)
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|num_iospace
operator|>
operator|(
sizeof|sizeof
argument_list|(
name|cfe
operator|->
name|iospace
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|cfe
operator|->
name|iospace
index|[
literal|0
index|]
argument_list|)
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"too many io "
literal|"spaces %d"
operator|,
name|cfe
operator|->
name|num_iospace
operator|)
argument_list|)
expr_stmt|;
name|state
operator|->
name|card
operator|->
name|error
operator|++
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfe
operator|->
name|num_iospace
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IO_RANGE_ADDRSIZE_MASK
condition|)
block|{
case|case
name|PCCARD_TPCE_IO_RANGE_ADDRSIZE_ONE
case|:
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|start
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
break|break;
case|case
name|PCCARD_TPCE_IO_RANGE_ADDRSIZE_TWO
case|:
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|start
operator|=
name|pccard_tuple_read_2
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|PCCARD_TPCE_IO_RANGE_ADDRSIZE_FOUR
case|:
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|start
operator|=
name|pccard_tuple_read_4
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
literal|4
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IO_RANGE_LENGTHSIZE_MASK
condition|)
block|{
case|case
name|PCCARD_TPCE_IO_RANGE_LENGTHSIZE_ONE
case|:
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|length
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
break|break;
case|case
name|PCCARD_TPCE_IO_RANGE_LENGTHSIZE_TWO
case|:
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|length
operator|=
name|pccard_tuple_read_2
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|PCCARD_TPCE_IO_RANGE_LENGTHSIZE_FOUR
case|:
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|length
operator|=
name|pccard_tuple_read_4
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
literal|4
expr_stmt|;
break|break;
block|}
name|cfe
operator|->
name|iospace
index|[
name|i
index|]
operator|.
name|length
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|cfe
operator|->
name|num_iospace
operator|=
literal|1
expr_stmt|;
name|cfe
operator|->
name|iospace
index|[
literal|0
index|]
operator|.
name|start
operator|=
literal|0
expr_stmt|;
name|cfe
operator|->
name|iospace
index|[
literal|0
index|]
operator|.
name|length
operator|=
operator|(
literal|1
operator|<<
name|cfe
operator|->
name|iomask
operator|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|irq
condition|)
block|{
if|if
condition|(
name|tuple
operator|->
name|length
operator|<=
name|idx
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ran out of space before TCPE_IR\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|abort_cfe
goto|;
block|}
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|cfe
operator|->
name|flags
operator|&=
operator|~
operator|(
name|PCCARD_CFE_IRQSHARE
operator||
name|PCCARD_CFE_IRQPULSE
operator||
name|PCCARD_CFE_IRQLEVEL
operator|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IR_SHARE
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_IRQSHARE
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IR_PULSE
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_IRQPULSE
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IR_LEVEL
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_IRQLEVEL
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_IR_HASMASK
condition|)
block|{
comment|/* 					 * it's legal to ignore the 					 * special-interrupt bits, so I will 					 */
name|cfe
operator|->
name|irqmask
operator|=
name|pccard_tuple_read_2
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|cfe
operator|->
name|irqmask
operator|=
operator|(
literal|1
operator|<<
operator|(
name|reg
operator|&
name|PCCARD_TPCE_IR_IRQ
operator|)
operator|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|memspace
condition|)
block|{
if|if
condition|(
name|tuple
operator|->
name|length
operator|<=
name|idx
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ran out of space before TCPE_MS\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|abort_cfe
goto|;
block|}
if|if
condition|(
name|memspace
operator|==
name|PCCARD_TPCE_FS_MEMSPACE_LENGTH
condition|)
block|{
name|cfe
operator|->
name|num_memspace
operator|=
literal|1
expr_stmt|;
name|cfe
operator|->
name|memspace
index|[
literal|0
index|]
operator|.
name|length
operator|=
literal|256
operator|*
name|pccard_tuple_read_2
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
literal|2
expr_stmt|;
name|cfe
operator|->
name|memspace
index|[
literal|0
index|]
operator|.
name|cardaddr
operator|=
literal|0
expr_stmt|;
name|cfe
operator|->
name|memspace
index|[
literal|0
index|]
operator|.
name|hostaddr
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|memspace
operator|==
name|PCCARD_TPCE_FS_MEMSPACE_LENGTHADDR
condition|)
block|{
name|cfe
operator|->
name|num_memspace
operator|=
literal|1
expr_stmt|;
name|cfe
operator|->
name|memspace
index|[
literal|0
index|]
operator|.
name|length
operator|=
literal|256
operator|*
name|pccard_tuple_read_2
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
literal|2
expr_stmt|;
name|cfe
operator|->
name|memspace
index|[
literal|0
index|]
operator|.
name|cardaddr
operator|=
literal|256
operator|*
name|pccard_tuple_read_2
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
literal|2
expr_stmt|;
name|cfe
operator|->
name|memspace
index|[
literal|0
index|]
operator|.
name|hostaddr
operator|=
name|cfe
operator|->
name|memspace
index|[
literal|0
index|]
operator|.
name|cardaddr
expr_stmt|;
block|}
else|else
block|{
name|int
name|lengthsize
decl_stmt|;
name|int
name|cardaddrsize
decl_stmt|;
name|int
name|hostaddrsize
decl_stmt|;
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|cfe
operator|->
name|num_memspace
operator|=
operator|(
name|reg
operator|&
name|PCCARD_TPCE_MS_COUNT
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|cfe
operator|->
name|num_memspace
operator|>
operator|(
sizeof|sizeof
argument_list|(
name|cfe
operator|->
name|memspace
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|cfe
operator|->
name|memspace
index|[
literal|0
index|]
argument_list|)
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"too many mem "
literal|"spaces %d"
operator|,
name|cfe
operator|->
name|num_memspace
operator|)
argument_list|)
expr_stmt|;
name|state
operator|->
name|card
operator|->
name|error
operator|++
expr_stmt|;
break|break;
block|}
name|lengthsize
operator|=
operator|(
operator|(
name|reg
operator|&
name|PCCARD_TPCE_MS_LENGTH_SIZE_MASK
operator|)
operator|>>
name|PCCARD_TPCE_MS_LENGTH_SIZE_SHIFT
operator|)
expr_stmt|;
name|cardaddrsize
operator|=
operator|(
operator|(
name|reg
operator|&
name|PCCARD_TPCE_MS_CARDADDR_SIZE_MASK
operator|)
operator|>>
name|PCCARD_TPCE_MS_CARDADDR_SIZE_SHIFT
operator|)
expr_stmt|;
name|hostaddrsize
operator|=
operator|(
name|reg
operator|&
name|PCCARD_TPCE_MS_HOSTADDR
operator|)
condition|?
name|cardaddrsize
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|lengthsize
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"cfe memspace "
literal|"lengthsize == 0"
operator|)
argument_list|)
expr_stmt|;
name|state
operator|->
name|card
operator|->
name|error
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfe
operator|->
name|num_memspace
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|lengthsize
condition|)
block|{
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|length
operator|=
literal|256
operator|*
name|pccard_tuple_read_n
argument_list|(
name|tuple
argument_list|,
name|lengthsize
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
name|lengthsize
expr_stmt|;
block|}
else|else
block|{
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|length
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|length
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"cfe->memspace[%d].length == 0"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|state
operator|->
name|card
operator|->
name|error
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cardaddrsize
condition|)
block|{
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|cardaddr
operator|=
literal|256
operator|*
name|pccard_tuple_read_n
argument_list|(
name|tuple
argument_list|,
name|cardaddrsize
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
name|cardaddrsize
expr_stmt|;
block|}
else|else
block|{
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|cardaddr
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|hostaddrsize
condition|)
block|{
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|hostaddr
operator|=
literal|256
operator|*
name|pccard_tuple_read_n
argument_list|(
name|tuple
argument_list|,
name|hostaddrsize
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|+=
name|hostaddrsize
expr_stmt|;
block|}
else|else
block|{
name|cfe
operator|->
name|memspace
index|[
name|i
index|]
operator|.
name|hostaddr
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
name|cfe
operator|->
name|num_memspace
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|misc
condition|)
block|{
if|if
condition|(
name|tuple
operator|->
name|length
operator|<=
name|idx
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ran out of space before TCPE_MI\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|abort_cfe
goto|;
block|}
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|cfe
operator|->
name|flags
operator|&=
operator|~
operator|(
name|PCCARD_CFE_POWERDOWN
operator||
name|PCCARD_CFE_READONLY
operator||
name|PCCARD_CFE_AUDIO
operator|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_MI_PWRDOWN
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_POWERDOWN
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_MI_READONLY
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_READONLY
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|PCCARD_TPCE_MI_AUDIO
condition|)
name|cfe
operator|->
name|flags
operator||=
name|PCCARD_CFE_AUDIO
expr_stmt|;
name|cfe
operator|->
name|maxtwins
operator|=
name|reg
operator|&
name|PCCARD_TPCE_MI_MAXTWINS
expr_stmt|;
while|while
condition|(
name|reg
operator|&
name|PCCARD_TPCE_MI_EXT
condition|)
block|{
name|reg
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|idx
operator|++
expr_stmt|;
block|}
block|}
comment|/* skip all the subtuples */
block|}
name|abort_cfe
label|:
name|DPRINTF
argument_list|(
operator|(
literal|"CISTPL_CFTABLE_ENTRY\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"unhandled CISTPL %x\n"
operator|,
name|tuple
operator|->
name|code
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|decode_funce
parameter_list|(
specifier|const
name|struct
name|pccard_tuple
modifier|*
name|tuple
parameter_list|,
name|struct
name|pccard_function
modifier|*
name|pf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|type
init|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|0
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|pf
operator|->
name|function
condition|)
block|{
case|case
name|PCCARD_FUNCTION_DISK
case|:
if|if
condition|(
name|type
operator|==
name|PCCARD_TPLFE_TYPE_DISK_DEVICE_INTERFACE
condition|)
block|{
name|pf
operator|->
name|pf_funce_disk_interface
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PCCARD_FUNCTION_NETWORK
case|:
if|if
condition|(
name|type
operator|==
name|PCCARD_TPLFE_TYPE_LAN_NID
condition|)
block|{
name|len
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tuple
operator|->
name|length
operator|<
literal|2
operator|+
name|len
operator|||
name|len
operator|>
literal|8
condition|)
block|{
comment|/* tuple length not enough or nid too long */
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|pf
operator|->
name|pf_funce_lan_nid
index|[
name|i
index|]
operator|=
name|pccard_tuple_read_1
argument_list|(
name|tuple
argument_list|,
name|i
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
name|pf
operator|->
name|pf_funce_lan_nidlen
operator|=
name|len
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2013-2015, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_comment
comment|/* **	Virtual Channel support **		These are support functions to communication **		between the VF and PF drivers. */
end_comment

begin_include
include|#
directive|include
file|"ixl.h"
end_include

begin_include
include|#
directive|include
file|"ixlv.h"
end_include

begin_include
include|#
directive|include
file|"i40e_prototype.h"
end_include

begin_comment
comment|/* busy wait delay in msec */
end_comment

begin_define
define|#
directive|define
name|IXLV_BUSY_WAIT_DELAY
value|10
end_define

begin_define
define|#
directive|define
name|IXLV_BUSY_WAIT_COUNT
value|50
end_define

begin_function_decl
specifier|static
name|void
name|ixl_vc_process_resp
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|enum
name|i40e_status_code
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vc_process_next
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vc_schedule_retry
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vc_send_current
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|IXL_DEBUG
end_ifdef

begin_comment
comment|/* ** Validate VF messages */
end_comment

begin_function
specifier|static
name|int
name|ixl_vc_validate_vf_msg
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|,
name|u32
name|v_opcode
parameter_list|,
name|u8
modifier|*
name|msg
parameter_list|,
name|u16
name|msglen
parameter_list|)
block|{
name|bool
name|err_msg_format
init|=
name|false
decl_stmt|;
name|int
name|valid_len
decl_stmt|;
comment|/* Validate message length. */
switch|switch
condition|(
name|v_opcode
condition|)
block|{
case|case
name|I40E_VIRTCHNL_OP_VERSION
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_version_info
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_RESET_VF
case|:
name|valid_len
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_GET_VF_RESOURCES
case|:
comment|/* Valid length in api v1.0 is 0, v1.1 is 4 */
name|valid_len
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_TX_QUEUE
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_txq_info
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_RX_QUEUE
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_rxq_info
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vsi_queue_config_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|msglen
operator|>=
name|valid_len
condition|)
block|{
name|struct
name|i40e_virtchnl_vsi_queue_config_info
modifier|*
name|vqc
init|=
operator|(
expr|struct
name|i40e_virtchnl_vsi_queue_config_info
operator|*
operator|)
name|msg
decl_stmt|;
name|valid_len
operator|+=
operator|(
name|vqc
operator|->
name|num_queue_pairs
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_queue_pair_info
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|vqc
operator|->
name|num_queue_pairs
operator|==
literal|0
condition|)
name|err_msg_format
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_irq_map_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|msglen
operator|>=
name|valid_len
condition|)
block|{
name|struct
name|i40e_virtchnl_irq_map_info
modifier|*
name|vimi
init|=
operator|(
expr|struct
name|i40e_virtchnl_irq_map_info
operator|*
operator|)
name|msg
decl_stmt|;
name|valid_len
operator|+=
operator|(
name|vimi
operator|->
name|num_vectors
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vector_map
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|vimi
operator|->
name|num_vectors
operator|==
literal|0
condition|)
name|err_msg_format
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
case|:
case|case
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_queue_select
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
case|:
case|case
name|I40E_VIRTCHNL_OP_DEL_ETHER_ADDRESS
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|msglen
operator|>=
name|valid_len
condition|)
block|{
name|struct
name|i40e_virtchnl_ether_addr_list
modifier|*
name|veal
init|=
operator|(
expr|struct
name|i40e_virtchnl_ether_addr_list
operator|*
operator|)
name|msg
decl_stmt|;
name|valid_len
operator|+=
name|veal
operator|->
name|num_elements
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|veal
operator|->
name|num_elements
operator|==
literal|0
condition|)
name|err_msg_format
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_ADD_VLAN
case|:
case|case
name|I40E_VIRTCHNL_OP_DEL_VLAN
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vlan_filter_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|msglen
operator|>=
name|valid_len
condition|)
block|{
name|struct
name|i40e_virtchnl_vlan_filter_list
modifier|*
name|vfl
init|=
operator|(
expr|struct
name|i40e_virtchnl_vlan_filter_list
operator|*
operator|)
name|msg
decl_stmt|;
name|valid_len
operator|+=
name|vfl
operator|->
name|num_elements
operator|*
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
if|if
condition|(
name|vfl
operator|->
name|num_elements
operator|==
literal|0
condition|)
name|err_msg_format
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_promisc_info
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_GET_STATS
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_queue_select
argument_list|)
expr_stmt|;
break|break;
comment|/* These are always errors coming from the VF. */
case|case
name|I40E_VIRTCHNL_OP_EVENT
case|:
case|case
name|I40E_VIRTCHNL_OP_UNKNOWN
case|:
default|default:
return|return
name|EPERM
return|;
break|break;
block|}
comment|/* few more checks */
if|if
condition|(
operator|(
name|valid_len
operator|!=
name|msglen
operator|)
operator|||
operator|(
name|err_msg_format
operator|)
condition|)
return|return
name|EINVAL
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ** ixlv_send_pf_msg ** ** Send message to PF and print status if failure. */
end_comment

begin_function
specifier|static
name|int
name|ixlv_send_pf_msg
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|,
name|enum
name|i40e_virtchnl_ops
name|op
parameter_list|,
name|u8
modifier|*
name|msg
parameter_list|,
name|u16
name|len
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|sc
operator|->
name|hw
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|i40e_status
name|err
decl_stmt|;
ifdef|#
directive|ifdef
name|IXL_DEBUG
comment|/* 	** Pre-validating messages to the PF 	*/
name|int
name|val_err
decl_stmt|;
name|val_err
operator|=
name|ixl_vc_validate_vf_msg
argument_list|(
name|sc
argument_list|,
name|op
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|val_err
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Error validating msg to PF for op %d,"
literal|" msglen %d: error %d\n"
argument_list|,
name|op
argument_list|,
name|len
argument_list|,
name|val_err
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|err
operator|=
name|i40e_aq_send_msg_to_pf
argument_list|(
name|hw
argument_list|,
name|op
argument_list|,
name|I40E_SUCCESS
argument_list|,
name|msg
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to send opcode %s to PF, "
literal|"status %s, aq error %s\n"
argument_list|,
name|ixl_vc_opcode_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|i40e_stat_str
argument_list|(
name|hw
argument_list|,
name|err
argument_list|)
argument_list|,
name|i40e_aq_str
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_send_api_ver ** ** Send API version admin queue message to the PF. The reply is not checked ** in this function. Returns 0 if the message was successfully ** sent, or one of the I40E_ADMIN_QUEUE_ERROR_ statuses if not. */
end_comment

begin_function
name|int
name|ixlv_send_api_ver
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_version_info
name|vvi
decl_stmt|;
name|vvi
operator|.
name|major
operator|=
name|I40E_VIRTCHNL_VERSION_MAJOR
expr_stmt|;
name|vvi
operator|.
name|minor
operator|=
name|I40E_VIRTCHNL_VERSION_MINOR
expr_stmt|;
return|return
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_VERSION
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|vvi
argument_list|,
sizeof|sizeof
argument_list|(
name|vvi
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_verify_api_ver ** ** Compare API versions with the PF. Must be called after admin queue is ** initialized. Returns 0 if API versions match, EIO if ** they do not, or I40E_ERR_ADMIN_QUEUE_NO_WORK if the admin queue is empty. */
end_comment

begin_function
name|int
name|ixlv_verify_api_ver
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_version_info
modifier|*
name|pf_vvi
decl_stmt|;
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|sc
operator|->
name|hw
decl_stmt|;
name|struct
name|i40e_arq_event_info
name|event
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|i40e_status
name|err
decl_stmt|;
name|int
name|retries
init|=
literal|0
decl_stmt|;
name|event
operator|.
name|buf_len
operator|=
name|IXL_AQ_BUF_SZ
expr_stmt|;
name|event
operator|.
name|msg_buf
operator|=
name|malloc
argument_list|(
name|event
operator|.
name|buf_len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|event
operator|.
name|msg_buf
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|++
name|retries
operator|>
name|IXLV_AQ_MAX_ERR
condition|)
goto|goto
name|out_alloc
goto|;
comment|/* Initial delay here is necessary */
name|i40e_msec_pause
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|err
operator|=
name|i40e_clean_arq_element
argument_list|(
name|hw
argument_list|,
operator|&
name|event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|I40E_ERR_ADMIN_QUEUE_NO_WORK
condition|)
continue|continue;
elseif|else
if|if
condition|(
name|err
condition|)
block|{
name|err
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out_alloc
goto|;
block|}
if|if
condition|(
operator|(
expr|enum
name|i40e_virtchnl_ops
operator|)
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_high
argument_list|)
operator|!=
name|I40E_VIRTCHNL_OP_VERSION
condition|)
block|{
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"Received unexpected op response: %d\n"
argument_list|,
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_high
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Don't stop looking for expected response */
continue|continue;
block|}
name|err
operator|=
operator|(
name|i40e_status
operator|)
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_low
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|err
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out_alloc
goto|;
block|}
else|else
break|break;
block|}
name|pf_vvi
operator|=
operator|(
expr|struct
name|i40e_virtchnl_version_info
operator|*
operator|)
name|event
operator|.
name|msg_buf
expr_stmt|;
if|if
condition|(
operator|(
name|pf_vvi
operator|->
name|major
operator|>
name|I40E_VIRTCHNL_VERSION_MAJOR
operator|)
operator|||
operator|(
operator|(
name|pf_vvi
operator|->
name|major
operator|==
name|I40E_VIRTCHNL_VERSION_MAJOR
operator|)
operator|&&
operator|(
name|pf_vvi
operator|->
name|minor
operator|>
name|I40E_VIRTCHNL_VERSION_MINOR
operator|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Critical PF/VF API version mismatch!\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|EIO
expr_stmt|;
block|}
else|else
name|sc
operator|->
name|pf_version
operator|=
name|pf_vvi
operator|->
name|minor
expr_stmt|;
comment|/* Log PF/VF api versions */
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"PF API %d.%d / VF API %d.%d\n"
argument_list|,
name|pf_vvi
operator|->
name|major
argument_list|,
name|pf_vvi
operator|->
name|minor
argument_list|,
name|I40E_VIRTCHNL_VERSION_MAJOR
argument_list|,
name|I40E_VIRTCHNL_VERSION_MINOR
argument_list|)
expr_stmt|;
name|out_alloc
label|:
name|free
argument_list|(
name|event
operator|.
name|msg_buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|out
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_send_vf_config_msg ** ** Send VF configuration request admin queue message to the PF. The reply ** is not checked in this function. Returns 0 if the message was ** successfully sent, or one of the I40E_ADMIN_QUEUE_ERROR_ statuses if not. */
end_comment

begin_function
name|int
name|ixlv_send_vf_config_msg
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|u32
name|caps
decl_stmt|;
name|caps
operator|=
name|I40E_VIRTCHNL_VF_OFFLOAD_L2
operator||
name|I40E_VIRTCHNL_VF_OFFLOAD_RSS_PF
operator||
name|I40E_VIRTCHNL_VF_OFFLOAD_VLAN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|pf_version
operator|==
name|I40E_VIRTCHNL_VERSION_MINOR_NO_VF_CAPS
condition|)
return|return
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_GET_VF_RESOURCES
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
else|else
return|return
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_GET_VF_RESOURCES
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|caps
argument_list|,
sizeof|sizeof
argument_list|(
name|caps
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_get_vf_config ** ** Get VF configuration from PF and populate hw structure. Must be called after ** admin queue is initialized. Busy waits until response is received from PF, ** with maximum timeout. Response from PF is returned in the buffer for further ** processing by the caller. */
end_comment

begin_function
name|int
name|ixlv_get_vf_config
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|sc
operator|->
name|hw
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|struct
name|i40e_arq_event_info
name|event
decl_stmt|;
name|u16
name|len
decl_stmt|;
name|i40e_status
name|err
init|=
literal|0
decl_stmt|;
name|u32
name|retries
init|=
literal|0
decl_stmt|;
comment|/* Note this assumes a single VSI */
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vf_resource
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vsi_resource
argument_list|)
expr_stmt|;
name|event
operator|.
name|buf_len
operator|=
name|len
expr_stmt|;
name|event
operator|.
name|msg_buf
operator|=
name|malloc
argument_list|(
name|event
operator|.
name|buf_len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|event
operator|.
name|msg_buf
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|err
operator|=
name|i40e_clean_arq_element
argument_list|(
name|hw
argument_list|,
operator|&
name|event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|I40E_ERR_ADMIN_QUEUE_NO_WORK
condition|)
block|{
if|if
condition|(
operator|++
name|retries
operator|<=
name|IXLV_AQ_MAX_ERR
condition|)
name|i40e_msec_pause
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
expr|enum
name|i40e_virtchnl_ops
operator|)
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_high
argument_list|)
operator|!=
name|I40E_VIRTCHNL_OP_GET_VF_RESOURCES
condition|)
block|{
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"Received a response from PF,"
literal|" opcode %d, error %d"
argument_list|,
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_high
argument_list|)
argument_list|,
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_low
argument_list|)
argument_list|)
expr_stmt|;
name|retries
operator|++
expr_stmt|;
continue|continue;
block|}
else|else
block|{
name|err
operator|=
operator|(
name|i40e_status
operator|)
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_low
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Error returned from PF,"
literal|" opcode %d, error %d\n"
argument_list|,
name|__func__
argument_list|,
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_high
argument_list|)
argument_list|,
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_low
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out_alloc
goto|;
block|}
comment|/* We retrieved the config message, with no errors */
break|break;
block|}
if|if
condition|(
name|retries
operator|>
name|IXLV_AQ_MAX_ERR
condition|)
block|{
name|INIT_DBG_DEV
argument_list|(
name|dev
argument_list|,
literal|"Did not receive response after %d tries."
argument_list|,
name|retries
argument_list|)
expr_stmt|;
name|err
operator|=
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|out_alloc
goto|;
block|}
block|}
name|memcpy
argument_list|(
name|sc
operator|->
name|vf_res
argument_list|,
name|event
operator|.
name|msg_buf
argument_list|,
name|min
argument_list|(
name|event
operator|.
name|msg_len
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|i40e_vf_parse_hw_config
argument_list|(
name|hw
argument_list|,
name|sc
operator|->
name|vf_res
argument_list|)
expr_stmt|;
name|out_alloc
label|:
name|free
argument_list|(
name|event
operator|.
name|msg_buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_configure_queues ** ** Request that the PF set up our queues. */
end_comment

begin_function
name|void
name|ixlv_configure_queues
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|struct
name|ixl_vsi
modifier|*
name|vsi
init|=
operator|&
name|sc
operator|->
name|vsi
decl_stmt|;
name|struct
name|ixl_queue
modifier|*
name|que
init|=
name|vsi
operator|->
name|queues
decl_stmt|;
name|struct
name|tx_ring
modifier|*
name|txr
decl_stmt|;
name|struct
name|rx_ring
modifier|*
name|rxr
decl_stmt|;
name|int
name|len
decl_stmt|,
name|pairs
decl_stmt|;
name|struct
name|i40e_virtchnl_vsi_queue_config_info
modifier|*
name|vqci
decl_stmt|;
name|struct
name|i40e_virtchnl_queue_pair_info
modifier|*
name|vqpi
decl_stmt|;
name|pairs
operator|=
name|vsi
operator|->
name|num_queues
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vsi_queue_config_info
argument_list|)
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_queue_pair_info
argument_list|)
operator|*
name|pairs
operator|)
expr_stmt|;
name|vqci
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vqci
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: unable to allocate memory\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ixl_vc_schedule_retry
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|)
expr_stmt|;
return|return;
block|}
name|vqci
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|vqci
operator|->
name|num_queue_pairs
operator|=
name|pairs
expr_stmt|;
name|vqpi
operator|=
name|vqci
operator|->
name|qpair
expr_stmt|;
comment|/* Size check is not needed here - HW max is 16 queue pairs, and we 	 * can fit info for 31 of them into the AQ buffer before it overflows. 	 */
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|pairs
condition|;
name|i
operator|++
operator|,
name|que
operator|++
operator|,
name|vqpi
operator|++
control|)
block|{
name|txr
operator|=
operator|&
name|que
operator|->
name|txr
expr_stmt|;
name|rxr
operator|=
operator|&
name|que
operator|->
name|rxr
expr_stmt|;
name|vqpi
operator|->
name|txq
operator|.
name|vsi_id
operator|=
name|vqci
operator|->
name|vsi_id
expr_stmt|;
name|vqpi
operator|->
name|txq
operator|.
name|queue_id
operator|=
name|i
expr_stmt|;
name|vqpi
operator|->
name|txq
operator|.
name|ring_len
operator|=
name|que
operator|->
name|num_desc
expr_stmt|;
name|vqpi
operator|->
name|txq
operator|.
name|dma_ring_addr
operator|=
name|txr
operator|->
name|dma
operator|.
name|pa
expr_stmt|;
comment|/* Enable Head writeback */
name|vqpi
operator|->
name|txq
operator|.
name|headwb_enabled
operator|=
literal|1
expr_stmt|;
name|vqpi
operator|->
name|txq
operator|.
name|dma_headwb_addr
operator|=
name|txr
operator|->
name|dma
operator|.
name|pa
operator|+
operator|(
name|que
operator|->
name|num_desc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_tx_desc
argument_list|)
operator|)
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|vsi_id
operator|=
name|vqci
operator|->
name|vsi_id
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|queue_id
operator|=
name|i
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|ring_len
operator|=
name|que
operator|->
name|num_desc
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|dma_ring_addr
operator|=
name|rxr
operator|->
name|dma
operator|.
name|pa
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|max_pkt_size
operator|=
name|vsi
operator|->
name|max_frame_size
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|databuffer_size
operator|=
name|rxr
operator|->
name|mbuf_sz
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|splithdr_enabled
operator|=
literal|0
expr_stmt|;
block|}
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|vqci
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vqci
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** ixlv_enable_queues ** ** Request that the PF enable all of our queues. */
end_comment

begin_function
name|void
name|ixlv_enable_queues
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_queue_select
name|vqs
decl_stmt|;
name|vqs
operator|.
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|vqs
operator|.
name|tx_queues
operator|=
operator|(
literal|1
operator|<<
name|sc
operator|->
name|vsi_res
operator|->
name|num_queue_pairs
operator|)
operator|-
literal|1
expr_stmt|;
name|vqs
operator|.
name|rx_queues
operator|=
name|vqs
operator|.
name|tx_queues
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|vqs
argument_list|,
sizeof|sizeof
argument_list|(
name|vqs
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** ixlv_disable_queues ** ** Request that the PF disable all of our queues. */
end_comment

begin_function
name|void
name|ixlv_disable_queues
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_queue_select
name|vqs
decl_stmt|;
name|vqs
operator|.
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|vqs
operator|.
name|tx_queues
operator|=
operator|(
literal|1
operator|<<
name|sc
operator|->
name|vsi_res
operator|->
name|num_queue_pairs
operator|)
operator|-
literal|1
expr_stmt|;
name|vqs
operator|.
name|rx_queues
operator|=
name|vqs
operator|.
name|tx_queues
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|vqs
argument_list|,
sizeof|sizeof
argument_list|(
name|vqs
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** ixlv_map_queues ** ** Request that the PF map queues to interrupt vectors. Misc causes, including ** admin queue, are always mapped to vector 0. */
end_comment

begin_function
name|void
name|ixlv_map_queues
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_irq_map_info
modifier|*
name|vm
decl_stmt|;
name|int
name|i
decl_stmt|,
name|q
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|ixl_vsi
modifier|*
name|vsi
init|=
operator|&
name|sc
operator|->
name|vsi
decl_stmt|;
name|struct
name|ixl_queue
modifier|*
name|que
init|=
name|vsi
operator|->
name|queues
decl_stmt|;
comment|/* How many queue vectors, adminq uses one */
name|q
operator|=
name|sc
operator|->
name|msix
operator|-
literal|1
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_irq_map_info
argument_list|)
operator|+
operator|(
name|sc
operator|->
name|msix
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vector_map
argument_list|)
operator|)
expr_stmt|;
name|vm
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vm
condition|)
block|{
name|printf
argument_list|(
literal|"%s: unable to allocate memory\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ixl_vc_schedule_retry
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|)
expr_stmt|;
return|return;
block|}
name|vm
operator|->
name|num_vectors
operator|=
name|sc
operator|->
name|msix
expr_stmt|;
comment|/* Queue vectors first */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|q
condition|;
name|i
operator|++
operator|,
name|que
operator|++
control|)
block|{
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|vector_id
operator|=
name|i
operator|+
literal|1
expr_stmt|;
comment|/* first is adminq */
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|txq_map
operator|=
operator|(
literal|1
operator|<<
name|que
operator|->
name|me
operator|)
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|rxq_map
operator|=
operator|(
literal|1
operator|<<
name|que
operator|->
name|me
operator|)
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|rxitr_idx
operator|=
literal|0
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|txitr_idx
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Misc vector last - this is only for AdminQ messages */
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|vector_id
operator|=
literal|0
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|txq_map
operator|=
literal|0
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|rxq_map
operator|=
literal|0
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|rxitr_idx
operator|=
literal|0
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|txitr_idx
operator|=
literal|0
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|vm
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vm
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** Scan the Filter List looking for vlans that need ** to be added, then create the data to hand to the AQ ** for handling. */
end_comment

begin_function
name|void
name|ixlv_add_vlans
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_vlan_filter_list
modifier|*
name|v
decl_stmt|;
name|struct
name|ixlv_vlan_filter
modifier|*
name|f
decl_stmt|,
modifier|*
name|ftmp
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|int
name|len
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
comment|/* Get count of VLAN filters to add */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|sc->vlan_filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_ADD
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cnt
condition|)
block|{
comment|/* no work... */
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_ADD_VLAN_FILTER
argument_list|,
name|I40E_SUCCESS
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vlan_filter_list
argument_list|)
operator|+
operator|(
name|cnt
operator|*
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|IXL_AQ_BUF_SZ
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Exceeded Max AQ Buf size\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ixl_vc_schedule_retry
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|)
expr_stmt|;
return|return;
block|}
name|v
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|v
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: unable to allocate memory\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ixl_vc_schedule_retry
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|)
expr_stmt|;
return|return;
block|}
name|v
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|v
operator|->
name|num_elements
operator|=
name|cnt
expr_stmt|;
comment|/* Scan the filter array */
name|SLIST_FOREACH_SAFE
argument_list|(
argument|f
argument_list|,
argument|sc->vlan_filters
argument_list|,
argument|next
argument_list|,
argument|ftmp
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_ADD
condition|)
block|{
name|bcopy
argument_list|(
operator|&
name|f
operator|->
name|vlan
argument_list|,
operator|&
name|v
operator|->
name|vlan_id
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|->
name|flags
operator|=
name|IXL_FILTER_USED
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|cnt
condition|)
break|break;
block|}
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_VLAN
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|v
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|v
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
comment|/* add stats? */
block|}
end_function

begin_comment
comment|/* ** Scan the Filter Table looking for vlans that need ** to be removed, then create the data to hand to the AQ ** for handling. */
end_comment

begin_function
name|void
name|ixlv_del_vlans
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|struct
name|i40e_virtchnl_vlan_filter_list
modifier|*
name|v
decl_stmt|;
name|struct
name|ixlv_vlan_filter
modifier|*
name|f
decl_stmt|,
modifier|*
name|ftmp
decl_stmt|;
name|int
name|len
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
comment|/* Get count of VLAN filters to delete */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|sc->vlan_filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_DEL
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cnt
condition|)
block|{
comment|/* no work... */
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_DEL_VLAN_FILTER
argument_list|,
name|I40E_SUCCESS
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vlan_filter_list
argument_list|)
operator|+
operator|(
name|cnt
operator|*
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|IXL_AQ_BUF_SZ
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Exceeded Max AQ Buf size\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ixl_vc_schedule_retry
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|)
expr_stmt|;
return|return;
block|}
name|v
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|v
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: unable to allocate memory\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ixl_vc_schedule_retry
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|)
expr_stmt|;
return|return;
block|}
name|v
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|v
operator|->
name|num_elements
operator|=
name|cnt
expr_stmt|;
comment|/* Scan the filter array */
name|SLIST_FOREACH_SAFE
argument_list|(
argument|f
argument_list|,
argument|sc->vlan_filters
argument_list|,
argument|next
argument_list|,
argument|ftmp
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_DEL
condition|)
block|{
name|bcopy
argument_list|(
operator|&
name|f
operator|->
name|vlan
argument_list|,
operator|&
name|v
operator|->
name|vlan_id
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|SLIST_REMOVE
argument_list|(
name|sc
operator|->
name|vlan_filters
argument_list|,
name|f
argument_list|,
name|ixlv_vlan_filter
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|cnt
condition|)
break|break;
block|}
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_DEL_VLAN
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|v
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|v
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
comment|/* add stats? */
block|}
end_function

begin_comment
comment|/* ** This routine takes additions to the vsi filter ** table and creates an Admin Queue call to create ** the filters in the hardware. */
end_comment

begin_function
name|void
name|ixlv_add_ether_filters
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_ether_addr_list
modifier|*
name|a
decl_stmt|;
name|struct
name|ixlv_mac_filter
modifier|*
name|f
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|int
name|len
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
comment|/* Get count of MAC addresses to add */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|sc->mac_filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_ADD
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
block|{
comment|/* Should not happen... */
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"cnt == 0, exiting..."
argument_list|)
expr_stmt|;
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_ADD_MAC_FILTER
argument_list|,
name|I40E_SUCCESS
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr_list
argument_list|)
operator|+
operator|(
name|cnt
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr
argument_list|)
operator|)
expr_stmt|;
name|a
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Failed to get memory for "
literal|"virtchnl_ether_addr_list\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ixl_vc_schedule_retry
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|)
expr_stmt|;
return|return;
block|}
name|a
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi
operator|.
name|id
expr_stmt|;
name|a
operator|->
name|num_elements
operator|=
name|cnt
expr_stmt|;
comment|/* Scan the filter array */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|sc->mac_filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_ADD
condition|)
block|{
name|bcopy
argument_list|(
name|f
operator|->
name|macaddr
argument_list|,
name|a
operator|->
name|list
index|[
name|j
index|]
operator|.
name|addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|f
operator|->
name|flags
operator|&=
operator|~
name|IXL_FILTER_ADD
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"ADD: "
name|MAC_FORMAT
argument_list|,
name|MAC_FORMAT_ARGS
argument_list|(
name|f
operator|->
name|macaddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|j
operator|==
name|cnt
condition|)
break|break;
block|}
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"len %d, j %d, cnt %d"
argument_list|,
name|len
argument_list|,
name|j
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|a
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* add stats? */
name|free
argument_list|(
name|a
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* ** This routine takes filters flagged for deletion in the ** sc MAC filter list and creates an Admin Queue call ** to delete those filters in the hardware. */
end_comment

begin_function
name|void
name|ixlv_del_ether_filters
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_ether_addr_list
modifier|*
name|d
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|struct
name|ixlv_mac_filter
modifier|*
name|f
decl_stmt|,
modifier|*
name|f_temp
decl_stmt|;
name|int
name|len
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
comment|/* Get count of MAC addresses to delete */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|sc->mac_filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_DEL
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
block|{
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"cnt == 0, exiting..."
argument_list|)
expr_stmt|;
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_DEL_MAC_FILTER
argument_list|,
name|I40E_SUCCESS
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr_list
argument_list|)
operator|+
operator|(
name|cnt
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr
argument_list|)
operator|)
expr_stmt|;
name|d
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Failed to get memory for "
literal|"virtchnl_ether_addr_list\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ixl_vc_schedule_retry
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|)
expr_stmt|;
return|return;
block|}
name|d
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi
operator|.
name|id
expr_stmt|;
name|d
operator|->
name|num_elements
operator|=
name|cnt
expr_stmt|;
comment|/* Scan the filter array */
name|SLIST_FOREACH_SAFE
argument_list|(
argument|f
argument_list|,
argument|sc->mac_filters
argument_list|,
argument|next
argument_list|,
argument|f_temp
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_DEL
condition|)
block|{
name|bcopy
argument_list|(
name|f
operator|->
name|macaddr
argument_list|,
name|d
operator|->
name|list
index|[
name|j
index|]
operator|.
name|addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"DEL: "
name|MAC_FORMAT
argument_list|,
name|MAC_FORMAT_ARGS
argument_list|(
name|f
operator|->
name|macaddr
argument_list|)
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|SLIST_REMOVE
argument_list|(
name|sc
operator|->
name|mac_filters
argument_list|,
name|f
argument_list|,
name|ixlv_mac_filter
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|j
operator|==
name|cnt
condition|)
break|break;
block|}
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_DEL_ETHER_ADDRESS
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|d
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* add stats? */
name|free
argument_list|(
name|d
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* ** ixlv_request_reset ** Request that the PF reset this VF. No response is expected. */
end_comment

begin_function
name|void
name|ixlv_request_reset
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* 	** Set the reset status to "in progress" before 	** the request, this avoids any possibility of 	** a mistaken early detection of completion. 	*/
name|wr32
argument_list|(
operator|&
name|sc
operator|->
name|hw
argument_list|,
name|I40E_VFGEN_RSTAT
argument_list|,
name|I40E_VFR_INPROGRESS
argument_list|)
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_RESET_VF
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** ixlv_request_stats ** Request the statistics for this VF's VSI from PF. */
end_comment

begin_function
name|void
name|ixlv_request_stats
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_queue_select
name|vqs
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|vqs
operator|.
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
comment|/* Low priority, we don't need to error check */
name|error
operator|=
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_GET_STATS
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|vqs
argument_list|,
sizeof|sizeof
argument_list|(
name|vqs
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IXL_DEBUG
if|if
condition|(
name|error
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Error sending stats request to PF: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* ** Updates driver's stats counters with VSI stats returned from PF. */
end_comment

begin_function
name|void
name|ixlv_update_stats_counters
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|,
name|struct
name|i40e_eth_stats
modifier|*
name|es
parameter_list|)
block|{
name|struct
name|ixl_vsi
modifier|*
name|vsi
init|=
operator|&
name|sc
operator|->
name|vsi
decl_stmt|;
name|uint64_t
name|tx_discards
decl_stmt|;
name|tx_discards
operator|=
name|es
operator|->
name|tx_discards
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|vsi
operator|->
name|num_queues
condition|;
name|i
operator|++
control|)
name|tx_discards
operator|+=
name|sc
operator|->
name|vsi
operator|.
name|queues
index|[
name|i
index|]
operator|.
name|txr
operator|.
name|br
operator|->
name|br_drops
expr_stmt|;
comment|/* Update ifnet stats */
name|IXL_SET_IPACKETS
argument_list|(
name|vsi
argument_list|,
name|es
operator|->
name|rx_unicast
operator|+
name|es
operator|->
name|rx_multicast
operator|+
name|es
operator|->
name|rx_broadcast
argument_list|)
expr_stmt|;
name|IXL_SET_OPACKETS
argument_list|(
name|vsi
argument_list|,
name|es
operator|->
name|tx_unicast
operator|+
name|es
operator|->
name|tx_multicast
operator|+
name|es
operator|->
name|tx_broadcast
argument_list|)
expr_stmt|;
name|IXL_SET_IBYTES
argument_list|(
name|vsi
argument_list|,
name|es
operator|->
name|rx_bytes
argument_list|)
expr_stmt|;
name|IXL_SET_OBYTES
argument_list|(
name|vsi
argument_list|,
name|es
operator|->
name|tx_bytes
argument_list|)
expr_stmt|;
name|IXL_SET_IMCASTS
argument_list|(
name|vsi
argument_list|,
name|es
operator|->
name|rx_multicast
argument_list|)
expr_stmt|;
name|IXL_SET_OMCASTS
argument_list|(
name|vsi
argument_list|,
name|es
operator|->
name|tx_multicast
argument_list|)
expr_stmt|;
name|IXL_SET_OERRORS
argument_list|(
name|vsi
argument_list|,
name|es
operator|->
name|tx_errors
argument_list|)
expr_stmt|;
name|IXL_SET_IQDROPS
argument_list|(
name|vsi
argument_list|,
name|es
operator|->
name|rx_discards
argument_list|)
expr_stmt|;
name|IXL_SET_OQDROPS
argument_list|(
name|vsi
argument_list|,
name|tx_discards
argument_list|)
expr_stmt|;
name|IXL_SET_NOPROTO
argument_list|(
name|vsi
argument_list|,
name|es
operator|->
name|rx_unknown_protocol
argument_list|)
expr_stmt|;
name|IXL_SET_COLLISIONS
argument_list|(
name|vsi
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vsi
operator|->
name|eth_stats
operator|=
operator|*
name|es
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ixlv_config_rss_key
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_rss_key
modifier|*
name|rss_key_msg
decl_stmt|;
name|int
name|msg_len
decl_stmt|,
name|key_length
decl_stmt|;
name|u8
name|rss_seed
index|[
name|IXL_RSS_KEY_SIZE
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|RSS
comment|/* Fetch the configured RSS key */
name|rss_getkey
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|rss_seed
argument_list|)
expr_stmt|;
else|#
directive|else
name|ixl_get_default_rss_key
argument_list|(
operator|(
name|u32
operator|*
operator|)
name|rss_seed
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Send the fetched key */
name|key_length
operator|=
name|IXL_RSS_KEY_SIZE
expr_stmt|;
name|msg_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_rss_key
argument_list|)
operator|+
operator|(
sizeof|sizeof
argument_list|(
name|u8
argument_list|)
operator|*
name|key_length
operator|)
operator|-
literal|1
expr_stmt|;
name|rss_key_msg
operator|=
name|malloc
argument_list|(
name|msg_len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rss_key_msg
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unable to allocate msg memory for RSS key msg.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|rss_key_msg
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|rss_key_msg
operator|->
name|key_len
operator|=
name|key_length
expr_stmt|;
name|bcopy
argument_list|(
name|rss_seed
argument_list|,
operator|&
name|rss_key_msg
operator|->
name|key
index|[
literal|0
index|]
argument_list|,
name|key_length
argument_list|)
expr_stmt|;
name|DDPRINTF
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"config_rss: vsi_id %d, key_len %d"
argument_list|,
name|rss_key_msg
operator|->
name|vsi_id
argument_list|,
name|rss_key_msg
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_KEY
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|rss_key_msg
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rss_key_msg
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ixlv_set_rss_hena
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_rss_hena
name|hena
decl_stmt|;
name|hena
operator|.
name|hena
operator|=
name|IXL_DEFAULT_RSS_HENA_X722
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_SET_RSS_HENA
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|hena
argument_list|,
sizeof|sizeof
argument_list|(
name|hena
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ixlv_config_rss_lut
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_rss_lut
modifier|*
name|rss_lut_msg
decl_stmt|;
name|int
name|msg_len
decl_stmt|;
name|u16
name|lut_length
decl_stmt|;
name|u32
name|lut
decl_stmt|;
name|int
name|i
decl_stmt|,
name|que_id
decl_stmt|;
name|lut_length
operator|=
name|IXL_RSS_VSI_LUT_SIZE
expr_stmt|;
name|msg_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_rss_lut
argument_list|)
operator|+
operator|(
name|lut_length
operator|*
sizeof|sizeof
argument_list|(
name|u8
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
name|rss_lut_msg
operator|=
name|malloc
argument_list|(
name|msg_len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rss_lut_msg
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unable to allocate msg memory for RSS lut msg.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|rss_lut_msg
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
comment|/* Each LUT entry is a max of 1 byte, so this is easy */
name|rss_lut_msg
operator|->
name|lut_entries
operator|=
name|lut_length
expr_stmt|;
comment|/* Populate the LUT with max no. of queues in round robin fashion */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lut_length
condition|;
name|i
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|RSS
comment|/* 		 * Fetch the RSS bucket id for the given indirection entry. 		 * Cap it at the number of configured buckets (which is 		 * num_queues.) 		 */
name|que_id
operator|=
name|rss_get_indirection_to_bucket
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|que_id
operator|=
name|que_id
operator|%
name|sc
operator|->
name|vsi
operator|.
name|num_queues
expr_stmt|;
else|#
directive|else
name|que_id
operator|=
name|i
operator|%
name|sc
operator|->
name|vsi
operator|.
name|num_queues
expr_stmt|;
endif|#
directive|endif
name|lut
operator|=
name|que_id
operator|&
name|IXL_RSS_VSI_LUT_ENTRY_MASK
expr_stmt|;
name|rss_lut_msg
operator|->
name|lut
index|[
name|i
index|]
operator|=
name|lut
expr_stmt|;
block|}
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_LUT
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|rss_lut_msg
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rss_lut_msg
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** ixlv_vc_completion ** ** Asynchronous completion function for admin queue messages. Rather than busy ** wait, we fire off our requests and assume that no errors will be returned. ** This function handles the reply messages. */
end_comment

begin_function
name|void
name|ixlv_vc_completion
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|,
name|enum
name|i40e_virtchnl_ops
name|v_opcode
parameter_list|,
name|i40e_status
name|v_retval
parameter_list|,
name|u8
modifier|*
name|msg
parameter_list|,
name|u16
name|msglen
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|struct
name|ixl_vsi
modifier|*
name|vsi
init|=
operator|&
name|sc
operator|->
name|vsi
decl_stmt|;
if|if
condition|(
name|v_opcode
operator|==
name|I40E_VIRTCHNL_OP_EVENT
condition|)
block|{
name|struct
name|i40e_virtchnl_pf_event
modifier|*
name|vpe
init|=
operator|(
expr|struct
name|i40e_virtchnl_pf_event
operator|*
operator|)
name|msg
decl_stmt|;
switch|switch
condition|(
name|vpe
operator|->
name|event
condition|)
block|{
case|case
name|I40E_VIRTCHNL_EVENT_LINK_CHANGE
case|:
ifdef|#
directive|ifdef
name|IXL_DEBUG
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Link change: status %d, speed %d\n"
argument_list|,
name|vpe
operator|->
name|event_data
operator|.
name|link_event
operator|.
name|link_status
argument_list|,
name|vpe
operator|->
name|event_data
operator|.
name|link_event
operator|.
name|link_speed
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sc
operator|->
name|link_up
operator|=
name|vpe
operator|->
name|event_data
operator|.
name|link_event
operator|.
name|link_status
expr_stmt|;
name|sc
operator|->
name|link_speed
operator|=
name|vpe
operator|->
name|event_data
operator|.
name|link_event
operator|.
name|link_speed
expr_stmt|;
name|ixlv_update_link_status
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_EVENT_RESET_IMPENDING
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"PF initiated reset!\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|init_state
operator|=
name|IXLV_RESET_PENDING
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|ixlv_init
argument_list|(
name|vsi
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Unknown event %d from AQ\n"
argument_list|,
name|__func__
argument_list|,
name|vpe
operator|->
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
comment|/* Catch-all error response */
if|if
condition|(
name|v_retval
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: AQ returned error %s to our request %s!\n"
argument_list|,
name|__func__
argument_list|,
name|i40e_stat_str
argument_list|(
operator|&
name|sc
operator|->
name|hw
argument_list|,
name|v_retval
argument_list|)
argument_list|,
name|ixl_vc_opcode_str
argument_list|(
name|v_opcode
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|IXL_DEBUG
if|if
condition|(
name|v_opcode
operator|!=
name|I40E_VIRTCHNL_OP_GET_STATS
condition|)
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"opcode %d"
argument_list|,
name|v_opcode
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|v_opcode
condition|)
block|{
case|case
name|I40E_VIRTCHNL_OP_GET_STATS
case|:
name|ixlv_update_stats_counters
argument_list|(
name|sc
argument_list|,
operator|(
expr|struct
name|i40e_eth_stats
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_ADD_MAC_FILTER
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
if|if
condition|(
name|v_retval
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING: Error adding VF mac filter!\n"
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING: Device may not receive traffic!\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_DEL_ETHER_ADDRESS
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_DEL_MAC_FILTER
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_CONFIGURE_PROMISC
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ADD_VLAN
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_ADD_VLAN_FILTER
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_DEL_VLAN
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_DEL_VLAN_FILTER
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_ENABLE_QUEUES
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
if|if
condition|(
name|v_retval
operator|==
literal|0
condition|)
block|{
comment|/* Update link status */
name|ixlv_update_link_status
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Turn on all interrupts */
name|ixlv_enable_intr
argument_list|(
name|vsi
argument_list|)
expr_stmt|;
comment|/* And inform the stack we're ready */
name|vsi
operator|->
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
comment|/* TODO: Clear a state flag, so we know we're ready to run init again */
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_DISABLE_QUEUES
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
if|if
condition|(
name|v_retval
operator|==
literal|0
condition|)
block|{
comment|/* Turn off all interrupts */
name|ixlv_disable_intr
argument_list|(
name|vsi
argument_list|)
expr_stmt|;
comment|/* Tell the stack that the interface is no longer active */
name|vsi
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_CONFIGURE_QUEUES
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_MAP_VECTORS
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_RSS_KEY
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_CONFIG_RSS_KEY
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_SET_RSS_HENA
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_SET_RSS_HENA
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_RSS_LUT
case|:
name|ixl_vc_process_resp
argument_list|(
operator|&
name|sc
operator|->
name|vc_mgr
argument_list|,
name|IXLV_FLAG_AQ_CONFIG_RSS_LUT
argument_list|,
name|v_retval
argument_list|)
expr_stmt|;
break|break;
default|default:
ifdef|#
directive|ifdef
name|IXL_DEBUG
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Received unexpected message %s from PF.\n"
argument_list|,
name|__func__
argument_list|,
name|ixl_vc_opcode_str
argument_list|(
name|v_opcode
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vc_send_cmd
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|request
parameter_list|)
block|{
switch|switch
condition|(
name|request
condition|)
block|{
case|case
name|IXLV_FLAG_AQ_MAP_VECTORS
case|:
name|ixlv_map_queues
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXLV_FLAG_AQ_ADD_MAC_FILTER
case|:
name|ixlv_add_ether_filters
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXLV_FLAG_AQ_ADD_VLAN_FILTER
case|:
name|ixlv_add_vlans
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXLV_FLAG_AQ_DEL_MAC_FILTER
case|:
name|ixlv_del_ether_filters
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXLV_FLAG_AQ_DEL_VLAN_FILTER
case|:
name|ixlv_del_vlans
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXLV_FLAG_AQ_CONFIGURE_QUEUES
case|:
name|ixlv_configure_queues
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXLV_FLAG_AQ_DISABLE_QUEUES
case|:
name|ixlv_disable_queues
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXLV_FLAG_AQ_ENABLE_QUEUES
case|:
name|ixlv_enable_queues
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXLV_FLAG_AQ_CONFIG_RSS_KEY
case|:
name|ixlv_config_rss_key
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXLV_FLAG_AQ_SET_RSS_HENA
case|:
name|ixlv_set_rss_hena
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXLV_FLAG_AQ_CONFIG_RSS_LUT
case|:
name|ixlv_config_rss_lut
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|ixl_vc_init_mgr
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|,
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|)
block|{
name|mgr
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|mgr
operator|->
name|current
operator|=
name|NULL
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|mgr
operator|->
name|pending
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|mgr
operator|->
name|callout
argument_list|,
operator|&
name|sc
operator|->
name|mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vc_process_completion
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|,
name|enum
name|i40e_status_code
name|err
parameter_list|)
block|{
name|struct
name|ixl_vc_cmd
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|mgr
operator|->
name|current
expr_stmt|;
name|mgr
operator|->
name|current
operator|=
name|NULL
expr_stmt|;
name|cmd
operator|->
name|flags
operator|&=
operator|~
name|IXLV_VC_CMD_FLAG_BUSY
expr_stmt|;
name|cmd
operator|->
name|callback
argument_list|(
name|cmd
argument_list|,
name|cmd
operator|->
name|arg
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|ixl_vc_process_next
argument_list|(
name|mgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vc_process_resp
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|,
name|uint32_t
name|request
parameter_list|,
name|enum
name|i40e_status_code
name|err
parameter_list|)
block|{
name|struct
name|ixl_vc_cmd
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|mgr
operator|->
name|current
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
operator|||
name|cmd
operator|->
name|request
operator|!=
name|request
condition|)
return|return;
name|callout_stop
argument_list|(
operator|&
name|mgr
operator|->
name|callout
argument_list|)
expr_stmt|;
name|ixl_vc_process_completion
argument_list|(
name|mgr
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vc_cmd_timeout
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
init|=
operator|(
expr|struct
name|ixl_vc_mgr
operator|*
operator|)
name|arg
decl_stmt|;
name|IXLV_CORE_LOCK_ASSERT
argument_list|(
name|mgr
operator|->
name|sc
argument_list|)
expr_stmt|;
name|ixl_vc_process_completion
argument_list|(
name|mgr
argument_list|,
name|I40E_ERR_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vc_cmd_retry
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
init|=
operator|(
expr|struct
name|ixl_vc_mgr
operator|*
operator|)
name|arg
decl_stmt|;
name|IXLV_CORE_LOCK_ASSERT
argument_list|(
name|mgr
operator|->
name|sc
argument_list|)
expr_stmt|;
name|ixl_vc_send_current
argument_list|(
name|mgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vc_send_current
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|)
block|{
name|struct
name|ixl_vc_cmd
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|mgr
operator|->
name|current
expr_stmt|;
name|ixl_vc_send_cmd
argument_list|(
name|mgr
operator|->
name|sc
argument_list|,
name|cmd
operator|->
name|request
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|mgr
operator|->
name|callout
argument_list|,
name|IXLV_VC_TIMEOUT
argument_list|,
name|ixl_vc_cmd_timeout
argument_list|,
name|mgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vc_process_next
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|)
block|{
name|struct
name|ixl_vc_cmd
modifier|*
name|cmd
decl_stmt|;
if|if
condition|(
name|mgr
operator|->
name|current
operator|!=
name|NULL
condition|)
return|return;
if|if
condition|(
name|TAILQ_EMPTY
argument_list|(
operator|&
name|mgr
operator|->
name|pending
argument_list|)
condition|)
return|return;
name|cmd
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|mgr
operator|->
name|pending
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|mgr
operator|->
name|pending
argument_list|,
name|cmd
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|mgr
operator|->
name|current
operator|=
name|cmd
expr_stmt|;
name|ixl_vc_send_current
argument_list|(
name|mgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vc_schedule_retry
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|)
block|{
name|callout_reset
argument_list|(
operator|&
name|mgr
operator|->
name|callout
argument_list|,
name|howmany
argument_list|(
name|hz
argument_list|,
literal|100
argument_list|)
argument_list|,
name|ixl_vc_cmd_retry
argument_list|,
name|mgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ixl_vc_enqueue
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|,
name|struct
name|ixl_vc_cmd
modifier|*
name|cmd
parameter_list|,
name|uint32_t
name|req
parameter_list|,
name|ixl_vc_callback_t
modifier|*
name|callback
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|IXLV_CORE_LOCK_ASSERT
argument_list|(
name|mgr
operator|->
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|flags
operator|&
name|IXLV_VC_CMD_FLAG_BUSY
condition|)
block|{
if|if
condition|(
name|mgr
operator|->
name|current
operator|==
name|cmd
condition|)
name|mgr
operator|->
name|current
operator|=
name|NULL
expr_stmt|;
else|else
name|TAILQ_REMOVE
argument_list|(
operator|&
name|mgr
operator|->
name|pending
argument_list|,
name|cmd
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
name|cmd
operator|->
name|request
operator|=
name|req
expr_stmt|;
name|cmd
operator|->
name|callback
operator|=
name|callback
expr_stmt|;
name|cmd
operator|->
name|arg
operator|=
name|arg
expr_stmt|;
name|cmd
operator|->
name|flags
operator||=
name|IXLV_VC_CMD_FLAG_BUSY
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|mgr
operator|->
name|pending
argument_list|,
name|cmd
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|ixl_vc_process_next
argument_list|(
name|mgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ixl_vc_flush
parameter_list|(
name|struct
name|ixl_vc_mgr
modifier|*
name|mgr
parameter_list|)
block|{
name|struct
name|ixl_vc_cmd
modifier|*
name|cmd
decl_stmt|;
name|IXLV_CORE_LOCK_ASSERT
argument_list|(
name|mgr
operator|->
name|sc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|TAILQ_EMPTY
argument_list|(
operator|&
name|mgr
operator|->
name|pending
argument_list|)
operator|||
name|mgr
operator|->
name|current
operator|!=
name|NULL
argument_list|,
operator|(
literal|"ixlv: pending commands waiting but no command in progress"
operator|)
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|mgr
operator|->
name|current
expr_stmt|;
if|if
condition|(
name|cmd
operator|!=
name|NULL
condition|)
block|{
name|mgr
operator|->
name|current
operator|=
name|NULL
expr_stmt|;
name|cmd
operator|->
name|flags
operator|&=
operator|~
name|IXLV_VC_CMD_FLAG_BUSY
expr_stmt|;
name|cmd
operator|->
name|callback
argument_list|(
name|cmd
argument_list|,
name|cmd
operator|->
name|arg
argument_list|,
name|I40E_ERR_ADAPTER_STOPPED
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|cmd
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|mgr
operator|->
name|pending
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|mgr
operator|->
name|pending
argument_list|,
name|cmd
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|flags
operator|&=
operator|~
name|IXLV_VC_CMD_FLAG_BUSY
expr_stmt|;
name|cmd
operator|->
name|callback
argument_list|(
name|cmd
argument_list|,
name|cmd
operator|->
name|arg
argument_list|,
name|I40E_ERR_ADAPTER_STOPPED
argument_list|)
expr_stmt|;
block|}
name|callout_stop
argument_list|(
operator|&
name|mgr
operator|->
name|callout
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


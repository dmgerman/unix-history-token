begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2013-2014, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_comment
comment|/* **	Virtual Channel support **		These are support functions to communication **		between the VF and PF drivers. */
end_comment

begin_include
include|#
directive|include
file|"ixl.h"
end_include

begin_include
include|#
directive|include
file|"ixlv.h"
end_include

begin_include
include|#
directive|include
file|"i40e_prototype.h"
end_include

begin_comment
comment|/* busy wait delay in msec */
end_comment

begin_define
define|#
directive|define
name|IXLV_BUSY_WAIT_DELAY
value|10
end_define

begin_define
define|#
directive|define
name|IXLV_BUSY_WAIT_COUNT
value|50
end_define

begin_comment
comment|/* ** Validate VF messages */
end_comment

begin_function
specifier|static
name|int
name|ixl_vc_validate_vf_msg
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|,
name|u32
name|v_opcode
parameter_list|,
name|u8
modifier|*
name|msg
parameter_list|,
name|u16
name|msglen
parameter_list|)
block|{
name|bool
name|err_msg_format
init|=
name|false
decl_stmt|;
name|int
name|valid_len
decl_stmt|;
comment|/* Validate message length. */
switch|switch
condition|(
name|v_opcode
condition|)
block|{
case|case
name|I40E_VIRTCHNL_OP_VERSION
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_version_info
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_RESET_VF
case|:
case|case
name|I40E_VIRTCHNL_OP_GET_VF_RESOURCES
case|:
name|valid_len
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_TX_QUEUE
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_txq_info
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_RX_QUEUE
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_rxq_info
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vsi_queue_config_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|msglen
operator|>=
name|valid_len
condition|)
block|{
name|struct
name|i40e_virtchnl_vsi_queue_config_info
modifier|*
name|vqc
init|=
operator|(
expr|struct
name|i40e_virtchnl_vsi_queue_config_info
operator|*
operator|)
name|msg
decl_stmt|;
name|valid_len
operator|+=
operator|(
name|vqc
operator|->
name|num_queue_pairs
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_queue_pair_info
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|vqc
operator|->
name|num_queue_pairs
operator|==
literal|0
condition|)
name|err_msg_format
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_irq_map_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|msglen
operator|>=
name|valid_len
condition|)
block|{
name|struct
name|i40e_virtchnl_irq_map_info
modifier|*
name|vimi
init|=
operator|(
expr|struct
name|i40e_virtchnl_irq_map_info
operator|*
operator|)
name|msg
decl_stmt|;
name|valid_len
operator|+=
operator|(
name|vimi
operator|->
name|num_vectors
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vector_map
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|vimi
operator|->
name|num_vectors
operator|==
literal|0
condition|)
name|err_msg_format
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
case|:
case|case
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_queue_select
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
case|:
case|case
name|I40E_VIRTCHNL_OP_DEL_ETHER_ADDRESS
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|msglen
operator|>=
name|valid_len
condition|)
block|{
name|struct
name|i40e_virtchnl_ether_addr_list
modifier|*
name|veal
init|=
operator|(
expr|struct
name|i40e_virtchnl_ether_addr_list
operator|*
operator|)
name|msg
decl_stmt|;
name|valid_len
operator|+=
name|veal
operator|->
name|num_elements
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|veal
operator|->
name|num_elements
operator|==
literal|0
condition|)
name|err_msg_format
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_ADD_VLAN
case|:
case|case
name|I40E_VIRTCHNL_OP_DEL_VLAN
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vlan_filter_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|msglen
operator|>=
name|valid_len
condition|)
block|{
name|struct
name|i40e_virtchnl_vlan_filter_list
modifier|*
name|vfl
init|=
operator|(
expr|struct
name|i40e_virtchnl_vlan_filter_list
operator|*
operator|)
name|msg
decl_stmt|;
name|valid_len
operator|+=
name|vfl
operator|->
name|num_elements
operator|*
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
if|if
condition|(
name|vfl
operator|->
name|num_elements
operator|==
literal|0
condition|)
name|err_msg_format
operator|=
name|true
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_promisc_info
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_GET_STATS
case|:
name|valid_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_queue_select
argument_list|)
expr_stmt|;
break|break;
comment|/* These are always errors coming from the VF. */
case|case
name|I40E_VIRTCHNL_OP_EVENT
case|:
case|case
name|I40E_VIRTCHNL_OP_UNKNOWN
case|:
default|default:
return|return
name|EPERM
return|;
break|break;
block|}
comment|/* few more checks */
if|if
condition|(
operator|(
name|valid_len
operator|!=
name|msglen
operator|)
operator|||
operator|(
name|err_msg_format
operator|)
condition|)
return|return
name|EINVAL
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_send_pf_msg ** ** Send message to PF and print status if failure. */
end_comment

begin_function
specifier|static
name|int
name|ixlv_send_pf_msg
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|,
name|enum
name|i40e_virtchnl_ops
name|op
parameter_list|,
name|u8
modifier|*
name|msg
parameter_list|,
name|u16
name|len
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|sc
operator|->
name|hw
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|i40e_status
name|err
decl_stmt|;
name|int
name|val_err
decl_stmt|;
comment|/* 	** Pre-validating messages to the PF, this might be 	** removed for performance later? 	*/
name|val_err
operator|=
name|ixl_vc_validate_vf_msg
argument_list|(
name|sc
argument_list|,
name|op
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|val_err
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Error validating msg to PF for op %d,"
literal|" msglen %d: error %d\n"
argument_list|,
name|op
argument_list|,
name|len
argument_list|,
name|val_err
argument_list|)
expr_stmt|;
name|err
operator|=
name|i40e_aq_send_msg_to_pf
argument_list|(
name|hw
argument_list|,
name|op
argument_list|,
name|I40E_SUCCESS
argument_list|,
name|msg
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to send opcode %d to PF, "
literal|"error %d, aq status %d\n"
argument_list|,
name|op
argument_list|,
name|err
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_send_api_ver ** ** Send API version admin queue message to the PF. The reply is not checked ** in this function. Returns 0 if the message was successfully ** sent, or one of the I40E_ADMIN_QUEUE_ERROR_ statuses if not. */
end_comment

begin_function
name|int
name|ixlv_send_api_ver
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_version_info
name|vvi
decl_stmt|;
name|vvi
operator|.
name|major
operator|=
name|I40E_VIRTCHNL_VERSION_MAJOR
expr_stmt|;
name|vvi
operator|.
name|minor
operator|=
name|I40E_VIRTCHNL_VERSION_MINOR
expr_stmt|;
return|return
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_VERSION
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|vvi
argument_list|,
sizeof|sizeof
argument_list|(
name|vvi
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_verify_api_ver ** ** Compare API versions with the PF. Must be called after admin queue is ** initialized. Returns 0 if API versions match, EIO if ** they do not, or I40E_ERR_ADMIN_QUEUE_NO_WORK if the admin queue is empty. */
end_comment

begin_function
name|int
name|ixlv_verify_api_ver
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_version_info
modifier|*
name|pf_vvi
decl_stmt|;
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|sc
operator|->
name|hw
decl_stmt|;
name|struct
name|i40e_arq_event_info
name|event
decl_stmt|;
name|i40e_status
name|err
decl_stmt|;
name|int
name|retries
init|=
literal|0
decl_stmt|;
name|event
operator|.
name|buf_len
operator|=
name|IXL_AQ_BUFSZ
expr_stmt|;
name|event
operator|.
name|msg_buf
operator|=
name|malloc
argument_list|(
name|event
operator|.
name|buf_len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|event
operator|.
name|msg_buf
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
do|do
block|{
if|if
condition|(
operator|++
name|retries
operator|>
name|IXLV_AQ_MAX_ERR
condition|)
goto|goto
name|out_alloc
goto|;
comment|/* NOTE: initial delay is necessary */
name|i40e_msec_delay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|err
operator|=
name|i40e_clean_arq_element
argument_list|(
name|hw
argument_list|,
operator|&
name|event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|err
operator|==
name|I40E_ERR_ADMIN_QUEUE_NO_WORK
condition|)
do|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out_alloc
goto|;
name|err
operator|=
operator|(
name|i40e_status
operator|)
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_low
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|err
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out_alloc
goto|;
block|}
if|if
condition|(
operator|(
expr|enum
name|i40e_virtchnl_ops
operator|)
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_high
argument_list|)
operator|!=
name|I40E_VIRTCHNL_OP_VERSION
condition|)
block|{
name|err
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out_alloc
goto|;
block|}
name|pf_vvi
operator|=
operator|(
expr|struct
name|i40e_virtchnl_version_info
operator|*
operator|)
name|event
operator|.
name|msg_buf
expr_stmt|;
if|if
condition|(
operator|(
name|pf_vvi
operator|->
name|major
operator|!=
name|I40E_VIRTCHNL_VERSION_MAJOR
operator|)
operator|||
operator|(
name|pf_vvi
operator|->
name|minor
operator|!=
name|I40E_VIRTCHNL_VERSION_MINOR
operator|)
condition|)
name|err
operator|=
name|EIO
expr_stmt|;
name|out_alloc
label|:
name|free
argument_list|(
name|event
operator|.
name|msg_buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_send_vf_config_msg ** ** Send VF configuration request admin queue message to the PF. The reply ** is not checked in this function. Returns 0 if the message was ** successfully sent, or one of the I40E_ADMIN_QUEUE_ERROR_ statuses if not. */
end_comment

begin_function
name|int
name|ixlv_send_vf_config_msg
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
return|return
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_GET_VF_RESOURCES
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_get_vf_config ** ** Get VF configuration from PF and populate hw structure. Must be called after ** admin queue is initialized. Busy waits until response is received from PF, ** with maximum timeout. Response from PF is returned in the buffer for further ** processing by the caller. */
end_comment

begin_function
name|int
name|ixlv_get_vf_config
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|sc
operator|->
name|hw
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|struct
name|i40e_arq_event_info
name|event
decl_stmt|;
name|u16
name|len
decl_stmt|;
name|i40e_status
name|err
init|=
literal|0
decl_stmt|;
name|u32
name|retries
init|=
literal|0
decl_stmt|;
comment|/* Note this assumes a single VSI */
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vf_resource
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vsi_resource
argument_list|)
expr_stmt|;
name|event
operator|.
name|buf_len
operator|=
name|len
expr_stmt|;
name|event
operator|.
name|msg_buf
operator|=
name|malloc
argument_list|(
name|event
operator|.
name|buf_len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|event
operator|.
name|msg_buf
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
do|do
block|{
name|err
operator|=
name|i40e_clean_arq_element
argument_list|(
name|hw
argument_list|,
operator|&
name|event
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|I40E_ERR_ADMIN_QUEUE_NO_WORK
condition|)
block|{
if|if
condition|(
operator|++
name|retries
operator|<=
name|IXLV_AQ_MAX_ERR
condition|)
name|i40e_msec_delay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
expr|enum
name|i40e_virtchnl_ops
operator|)
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_high
argument_list|)
operator|!=
name|I40E_VIRTCHNL_OP_GET_VF_RESOURCES
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Received a response from PF,"
literal|" opcode %d, error %d\n"
argument_list|,
name|__func__
argument_list|,
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_high
argument_list|)
argument_list|,
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_low
argument_list|)
argument_list|)
expr_stmt|;
name|retries
operator|++
expr_stmt|;
continue|continue;
block|}
else|else
block|{
name|err
operator|=
operator|(
name|i40e_status
operator|)
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_low
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Error returned from PF,"
literal|" opcode %d, error %d\n"
argument_list|,
name|__func__
argument_list|,
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_high
argument_list|)
argument_list|,
name|le32toh
argument_list|(
name|event
operator|.
name|desc
operator|.
name|cookie_low
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out_alloc
goto|;
block|}
break|break;
block|}
if|if
condition|(
name|retries
operator|>
name|IXLV_AQ_MAX_ERR
condition|)
block|{
name|INIT_DBG_DEV
argument_list|(
name|dev
argument_list|,
literal|"Did not receive response after %d tries."
argument_list|,
name|retries
argument_list|)
expr_stmt|;
goto|goto
name|out_alloc
goto|;
block|}
block|}
do|while
condition|(
name|err
condition|)
do|;
name|memcpy
argument_list|(
name|sc
operator|->
name|vf_res
argument_list|,
name|event
operator|.
name|msg_buf
argument_list|,
name|min
argument_list|(
name|event
operator|.
name|msg_len
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|i40e_vf_parse_hw_config
argument_list|(
name|hw
argument_list|,
name|sc
operator|->
name|vf_res
argument_list|)
expr_stmt|;
name|out_alloc
label|:
name|free
argument_list|(
name|event
operator|.
name|msg_buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* ** ixlv_configure_queues ** ** Request that the PF set up our queues. */
end_comment

begin_function
name|void
name|ixlv_configure_queues
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|struct
name|ixl_vsi
modifier|*
name|vsi
init|=
operator|&
name|sc
operator|->
name|vsi
decl_stmt|;
name|struct
name|ixl_queue
modifier|*
name|que
init|=
name|vsi
operator|->
name|queues
decl_stmt|;
name|struct
name|tx_ring
modifier|*
name|txr
decl_stmt|;
name|struct
name|rx_ring
modifier|*
name|rxr
decl_stmt|;
name|int
name|len
decl_stmt|,
name|pairs
decl_stmt|;
empty_stmt|;
name|struct
name|i40e_virtchnl_vsi_queue_config_info
modifier|*
name|vqci
decl_stmt|;
name|struct
name|i40e_virtchnl_queue_pair_info
modifier|*
name|vqpi
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|current_op
operator|!=
name|I40E_VIRTCHNL_OP_UNKNOWN
condition|)
block|{
comment|/* bail because we already have a command pending */
ifdef|#
directive|ifdef
name|IXL_DEBUG
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: command %d pending\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|current_op
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|pairs
operator|=
name|vsi
operator|->
name|num_queues
expr_stmt|;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vsi_queue_config_info
argument_list|)
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_queue_pair_info
argument_list|)
operator|*
name|pairs
operator|)
expr_stmt|;
name|vqci
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vqci
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: unable to allocate memory\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|vqci
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|vqci
operator|->
name|num_queue_pairs
operator|=
name|pairs
expr_stmt|;
name|vqpi
operator|=
name|vqci
operator|->
name|qpair
expr_stmt|;
comment|/* Size check is not needed here - HW max is 16 queue pairs, and we 	 * can fit info for 31 of them into the AQ buffer before it overflows. 	 */
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|pairs
condition|;
name|i
operator|++
operator|,
name|que
operator|++
control|)
block|{
name|txr
operator|=
operator|&
name|que
operator|->
name|txr
expr_stmt|;
name|rxr
operator|=
operator|&
name|que
operator|->
name|rxr
expr_stmt|;
name|vqpi
operator|->
name|txq
operator|.
name|vsi_id
operator|=
name|vqci
operator|->
name|vsi_id
expr_stmt|;
name|vqpi
operator|->
name|txq
operator|.
name|queue_id
operator|=
name|i
expr_stmt|;
name|vqpi
operator|->
name|txq
operator|.
name|ring_len
operator|=
name|que
operator|->
name|num_desc
expr_stmt|;
name|vqpi
operator|->
name|txq
operator|.
name|dma_ring_addr
operator|=
name|txr
operator|->
name|dma
operator|.
name|pa
expr_stmt|;
comment|/* Enable Head writeback */
name|vqpi
operator|->
name|txq
operator|.
name|headwb_enabled
operator|=
literal|1
expr_stmt|;
name|vqpi
operator|->
name|txq
operator|.
name|dma_headwb_addr
operator|=
name|txr
operator|->
name|dma
operator|.
name|pa
operator|+
operator|(
name|que
operator|->
name|num_desc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_tx_desc
argument_list|)
operator|)
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|vsi_id
operator|=
name|vqci
operator|->
name|vsi_id
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|queue_id
operator|=
name|i
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|ring_len
operator|=
name|que
operator|->
name|num_desc
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|dma_ring_addr
operator|=
name|rxr
operator|->
name|dma
operator|.
name|pa
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|max_pkt_size
operator|=
name|vsi
operator|->
name|max_frame_size
expr_stmt|;
name|vqpi
operator|->
name|rxq
operator|.
name|databuffer_size
operator|=
name|rxr
operator|->
name|mbuf_sz
expr_stmt|;
name|vqpi
operator|++
expr_stmt|;
block|}
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|vqci
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vqci
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|aq_pending
operator||=
name|IXLV_FLAG_AQ_CONFIGURE_QUEUES
expr_stmt|;
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_CONFIGURE_QUEUES
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** ixlv_enable_queues ** ** Request that the PF enable all of our queues. */
end_comment

begin_function
name|void
name|ixlv_enable_queues
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_queue_select
name|vqs
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|current_op
operator|!=
name|I40E_VIRTCHNL_OP_UNKNOWN
condition|)
block|{
comment|/* we already have a command pending */
ifdef|#
directive|ifdef
name|IXL_DEBUG
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s: command %d pending\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|current_op
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
expr_stmt|;
name|vqs
operator|.
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|vqs
operator|.
name|tx_queues
operator|=
operator|(
literal|1
operator|<<
name|sc
operator|->
name|vsi_res
operator|->
name|num_queue_pairs
operator|)
operator|-
literal|1
expr_stmt|;
name|vqs
operator|.
name|rx_queues
operator|=
name|vqs
operator|.
name|tx_queues
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|vqs
argument_list|,
sizeof|sizeof
argument_list|(
name|vqs
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|aq_pending
operator||=
name|IXLV_FLAG_AQ_ENABLE_QUEUES
expr_stmt|;
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_ENABLE_QUEUES
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** ixlv_disable_queues ** ** Request that the PF disable all of our queues. */
end_comment

begin_function
name|void
name|ixlv_disable_queues
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_queue_select
name|vqs
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|current_op
operator|!=
name|I40E_VIRTCHNL_OP_UNKNOWN
condition|)
block|{
comment|/* we already have a command pending */
ifdef|#
directive|ifdef
name|IXL_DEBUG
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s: command %d pending\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|current_op
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
expr_stmt|;
name|vqs
operator|.
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|vqs
operator|.
name|tx_queues
operator|=
operator|(
literal|1
operator|<<
name|sc
operator|->
name|vsi_res
operator|->
name|num_queue_pairs
operator|)
operator|-
literal|1
expr_stmt|;
name|vqs
operator|.
name|rx_queues
operator|=
name|vqs
operator|.
name|tx_queues
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|vqs
argument_list|,
sizeof|sizeof
argument_list|(
name|vqs
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|aq_pending
operator||=
name|IXLV_FLAG_AQ_DISABLE_QUEUES
expr_stmt|;
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_DISABLE_QUEUES
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** ixlv_map_queues ** ** Request that the PF map queues to interrupt vectors. Misc causes, including ** admin queue, are always mapped to vector 0. */
end_comment

begin_function
name|void
name|ixlv_map_queues
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_irq_map_info
modifier|*
name|vm
decl_stmt|;
name|int
name|i
decl_stmt|,
name|q
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|ixl_vsi
modifier|*
name|vsi
init|=
operator|&
name|sc
operator|->
name|vsi
decl_stmt|;
name|struct
name|ixl_queue
modifier|*
name|que
init|=
name|vsi
operator|->
name|queues
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|current_op
operator|!=
name|I40E_VIRTCHNL_OP_UNKNOWN
condition|)
block|{
comment|/* we already have a command pending */
ifdef|#
directive|ifdef
name|IXL_DEBUG
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"%s: command %d pending\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|current_op
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
expr_stmt|;
comment|/* How many queue vectors, adminq uses one */
name|q
operator|=
name|sc
operator|->
name|msix
operator|-
literal|1
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_irq_map_info
argument_list|)
operator|+
operator|(
name|sc
operator|->
name|msix
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vector_map
argument_list|)
operator|)
expr_stmt|;
name|vm
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vm
condition|)
block|{
name|printf
argument_list|(
literal|"%s: unable to allocate memory\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|vm
operator|->
name|num_vectors
operator|=
name|sc
operator|->
name|msix
expr_stmt|;
comment|/* Queue vectors first */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|q
condition|;
name|i
operator|++
operator|,
name|que
operator|++
control|)
block|{
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|vector_id
operator|=
name|i
operator|+
literal|1
expr_stmt|;
comment|/* first is adminq */
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|txq_map
operator|=
operator|(
literal|1
operator|<<
name|que
operator|->
name|me
operator|)
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|rxq_map
operator|=
operator|(
literal|1
operator|<<
name|que
operator|->
name|me
operator|)
expr_stmt|;
block|}
comment|/* Misc vector last - this is only for AdminQ messages */
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|vector_id
operator|=
literal|0
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|txq_map
operator|=
literal|0
expr_stmt|;
name|vm
operator|->
name|vecmap
index|[
name|i
index|]
operator|.
name|rxq_map
operator|=
literal|0
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|vm
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vm
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|aq_pending
operator||=
name|IXLV_FLAG_AQ_MAP_VECTORS
expr_stmt|;
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_MAP_VECTORS
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** Scan the Filter List looking for vlans that need ** to be added, then create the data to hand to the AQ ** for handling. */
end_comment

begin_function
name|void
name|ixlv_add_vlans
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_vlan_filter_list
modifier|*
name|v
decl_stmt|;
name|struct
name|ixlv_vlan_filter
modifier|*
name|f
decl_stmt|,
modifier|*
name|ftmp
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|int
name|len
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|current_op
operator|!=
name|I40E_VIRTCHNL_OP_UNKNOWN
condition|)
return|return;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_ADD_VLAN
expr_stmt|;
comment|/* Get count of VLAN filters to add */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|sc->vlan_filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_ADD
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cnt
condition|)
block|{
comment|/* no work... */
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_ADD_VLAN_FILTER
expr_stmt|;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_UNKNOWN
expr_stmt|;
return|return;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vlan_filter_list
argument_list|)
operator|+
operator|(
name|cnt
operator|*
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|IXL_AQ_BUF_SZ
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Exceeded Max AQ Buf size\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|v
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|v
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: unable to allocate memory\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|v
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|v
operator|->
name|num_elements
operator|=
name|cnt
expr_stmt|;
comment|/* Scan the filter array */
name|SLIST_FOREACH_SAFE
argument_list|(
argument|f
argument_list|,
argument|sc->vlan_filters
argument_list|,
argument|next
argument_list|,
argument|ftmp
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_ADD
condition|)
block|{
name|bcopy
argument_list|(
operator|&
name|f
operator|->
name|vlan
argument_list|,
operator|&
name|v
operator|->
name|vlan_id
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|->
name|flags
operator|=
name|IXL_FILTER_USED
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|cnt
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
comment|/* Should not happen... */
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: i == 0?\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_VLAN
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|v
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|v
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
comment|/* add stats? */
name|sc
operator|->
name|aq_pending
operator||=
name|IXLV_FLAG_AQ_ADD_VLAN_FILTER
expr_stmt|;
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_ADD_VLAN_FILTER
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** Scan the Filter Table looking for vlans that need ** to be removed, then create the data to hand to the AQ ** for handling. */
end_comment

begin_function
name|void
name|ixlv_del_vlans
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|struct
name|i40e_virtchnl_vlan_filter_list
modifier|*
name|v
decl_stmt|;
name|struct
name|ixlv_vlan_filter
modifier|*
name|f
decl_stmt|,
modifier|*
name|ftmp
decl_stmt|;
name|int
name|len
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|current_op
operator|!=
name|I40E_VIRTCHNL_OP_UNKNOWN
condition|)
return|return;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_DEL_VLAN
expr_stmt|;
comment|/* Get count of VLAN filters to delete */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|sc->vlan_filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_DEL
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cnt
condition|)
block|{
comment|/* no work... */
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_DEL_VLAN_FILTER
expr_stmt|;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_UNKNOWN
expr_stmt|;
return|return;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_vlan_filter_list
argument_list|)
operator|+
operator|(
name|cnt
operator|*
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|IXL_AQ_BUF_SZ
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Exceeded Max AQ Buf size\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|v
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|v
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: unable to allocate memory\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|v
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|v
operator|->
name|num_elements
operator|=
name|cnt
expr_stmt|;
comment|/* Scan the filter array */
name|SLIST_FOREACH_SAFE
argument_list|(
argument|f
argument_list|,
argument|sc->vlan_filters
argument_list|,
argument|next
argument_list|,
argument|ftmp
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_DEL
condition|)
block|{
name|bcopy
argument_list|(
operator|&
name|f
operator|->
name|vlan
argument_list|,
operator|&
name|v
operator|->
name|vlan_id
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|SLIST_REMOVE
argument_list|(
name|sc
operator|->
name|vlan_filters
argument_list|,
name|f
argument_list|,
name|ixlv_vlan_filter
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|cnt
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
comment|/* Should not happen... */
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: i == 0?\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_DEL_VLAN
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|v
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|v
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
comment|/* add stats? */
name|sc
operator|->
name|aq_pending
operator||=
name|IXLV_FLAG_AQ_DEL_VLAN_FILTER
expr_stmt|;
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_DEL_VLAN_FILTER
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** This routine takes additions to the vsi filter ** table and creates an Admin Queue call to create ** the filters in the hardware. */
end_comment

begin_function
name|void
name|ixlv_add_ether_filters
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_ether_addr_list
modifier|*
name|a
decl_stmt|;
name|struct
name|ixlv_mac_filter
modifier|*
name|f
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|int
name|len
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|current_op
operator|!=
name|I40E_VIRTCHNL_OP_UNKNOWN
condition|)
return|return;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
expr_stmt|;
comment|/* Get count of MAC addresses to add */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|sc->mac_filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_ADD
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
block|{
comment|/* Should not happen... */
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"cnt == 0, exiting..."
argument_list|)
expr_stmt|;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_UNKNOWN
expr_stmt|;
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_ADD_MAC_FILTER
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|sc
operator|->
name|add_ether_done
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr_list
argument_list|)
operator|+
operator|(
name|cnt
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr
argument_list|)
operator|)
expr_stmt|;
name|a
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Failed to get memory for "
literal|"virtchnl_ether_addr_list\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|a
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi
operator|.
name|id
expr_stmt|;
name|a
operator|->
name|num_elements
operator|=
name|cnt
expr_stmt|;
comment|/* Scan the filter array */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|sc->mac_filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_ADD
condition|)
block|{
name|bcopy
argument_list|(
name|f
operator|->
name|macaddr
argument_list|,
name|a
operator|->
name|list
index|[
name|j
index|]
operator|.
name|addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|f
operator|->
name|flags
operator|&=
operator|~
name|IXL_FILTER_ADD
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"ADD: "
name|MAC_FORMAT
argument_list|,
name|MAC_FORMAT_ARGS
argument_list|(
name|f
operator|->
name|macaddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|j
operator|==
name|cnt
condition|)
break|break;
block|}
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"len %d, j %d, cnt %d"
argument_list|,
name|len
argument_list|,
name|j
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|a
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* add stats? */
name|free
argument_list|(
name|a
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|aq_pending
operator||=
name|IXLV_FLAG_AQ_ADD_MAC_FILTER
expr_stmt|;
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_ADD_MAC_FILTER
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* ** This routine takes filters flagged for deletion in the ** sc MAC filter list and creates an Admin Queue call ** to delete those filters in the hardware. */
end_comment

begin_function
name|void
name|ixlv_del_ether_filters
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_ether_addr_list
modifier|*
name|d
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|struct
name|ixlv_mac_filter
modifier|*
name|f
decl_stmt|,
modifier|*
name|f_temp
decl_stmt|;
name|int
name|len
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|current_op
operator|!=
name|I40E_VIRTCHNL_OP_UNKNOWN
condition|)
return|return;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_DEL_ETHER_ADDRESS
expr_stmt|;
comment|/* Get count of MAC addresses to delete */
name|SLIST_FOREACH
argument_list|(
argument|f
argument_list|,
argument|sc->mac_filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_DEL
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
block|{
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"cnt == 0, exiting..."
argument_list|)
expr_stmt|;
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_DEL_MAC_FILTER
expr_stmt|;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_UNKNOWN
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|sc
operator|->
name|del_ether_done
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr_list
argument_list|)
operator|+
operator|(
name|cnt
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_ether_addr
argument_list|)
operator|)
expr_stmt|;
name|d
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Failed to get memory for "
literal|"virtchnl_ether_addr_list\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|d
operator|->
name|vsi_id
operator|=
name|sc
operator|->
name|vsi
operator|.
name|id
expr_stmt|;
name|d
operator|->
name|num_elements
operator|=
name|cnt
expr_stmt|;
comment|/* Scan the filter array */
name|SLIST_FOREACH_SAFE
argument_list|(
argument|f
argument_list|,
argument|sc->mac_filters
argument_list|,
argument|next
argument_list|,
argument|f_temp
argument_list|)
block|{
if|if
condition|(
name|f
operator|->
name|flags
operator|&
name|IXL_FILTER_DEL
condition|)
block|{
name|bcopy
argument_list|(
name|f
operator|->
name|macaddr
argument_list|,
name|d
operator|->
name|list
index|[
name|j
index|]
operator|.
name|addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"DEL: "
name|MAC_FORMAT
argument_list|,
name|MAC_FORMAT_ARGS
argument_list|(
name|f
operator|->
name|macaddr
argument_list|)
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|SLIST_REMOVE
argument_list|(
name|sc
operator|->
name|mac_filters
argument_list|,
name|f
argument_list|,
name|ixlv_mac_filter
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|j
operator|==
name|cnt
condition|)
break|break;
block|}
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_DEL_ETHER_ADDRESS
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|d
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* add stats? */
name|free
argument_list|(
name|d
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|aq_pending
operator||=
name|IXLV_FLAG_AQ_DEL_MAC_FILTER
expr_stmt|;
name|sc
operator|->
name|aq_required
operator|&=
operator|~
name|IXLV_FLAG_AQ_DEL_MAC_FILTER
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* ** ixlv_request_reset ** Request that the PF reset this VF. No response is expected. */
end_comment

begin_function
name|void
name|ixlv_request_reset
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* 	** Set the reset status to "in progress" before 	** the request, this avoids any possibility of 	** a mistaken early detection of completion. 	*/
name|wr32
argument_list|(
operator|&
name|sc
operator|->
name|hw
argument_list|,
name|I40E_VFGEN_RSTAT
argument_list|,
name|I40E_VFR_INPROGRESS
argument_list|)
expr_stmt|;
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_RESET_VF
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_UNKNOWN
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** ixlv_request_stats ** Request the statistics for this VF's VSI from PF. */
end_comment

begin_function
name|void
name|ixlv_request_stats
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_queue_select
name|vqs
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|current_op
operator|!=
name|I40E_VIRTCHNL_OP_UNKNOWN
condition|)
return|return;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_GET_STATS
expr_stmt|;
name|vqs
operator|.
name|vsi_id
operator|=
name|sc
operator|->
name|vsi_res
operator|->
name|vsi_id
expr_stmt|;
name|error
operator|=
name|ixlv_send_pf_msg
argument_list|(
name|sc
argument_list|,
name|I40E_VIRTCHNL_OP_GET_STATS
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|vqs
argument_list|,
sizeof|sizeof
argument_list|(
name|vqs
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Low priority, ok if it fails */
if|if
condition|(
name|error
condition|)
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_UNKNOWN
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** Updates driver's stats counters with VSI stats returned from PF. */
end_comment

begin_function
name|void
name|ixlv_update_stats_counters
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|,
name|struct
name|i40e_eth_stats
modifier|*
name|es
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|vsi
operator|.
name|ifp
decl_stmt|;
name|ifp
operator|->
name|if_ipackets
operator|=
name|es
operator|->
name|rx_unicast
operator|+
name|es
operator|->
name|rx_multicast
operator|+
name|es
operator|->
name|rx_broadcast
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|=
name|es
operator|->
name|tx_unicast
operator|+
name|es
operator|->
name|tx_multicast
operator|+
name|es
operator|->
name|tx_broadcast
expr_stmt|;
name|ifp
operator|->
name|if_ibytes
operator|=
name|es
operator|->
name|rx_bytes
expr_stmt|;
name|ifp
operator|->
name|if_obytes
operator|=
name|es
operator|->
name|tx_bytes
expr_stmt|;
name|ifp
operator|->
name|if_imcasts
operator|=
name|es
operator|->
name|rx_multicast
expr_stmt|;
name|ifp
operator|->
name|if_omcasts
operator|=
name|es
operator|->
name|tx_multicast
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|=
name|es
operator|->
name|tx_errors
expr_stmt|;
name|ifp
operator|->
name|if_iqdrops
operator|=
name|es
operator|->
name|rx_discards
expr_stmt|;
name|ifp
operator|->
name|if_noproto
operator|=
name|es
operator|->
name|rx_unknown_protocol
expr_stmt|;
name|sc
operator|->
name|vsi
operator|.
name|eth_stats
operator|=
operator|*
name|es
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** ixlv_vc_completion ** ** Asynchronous completion function for admin queue messages. Rather than busy ** wait, we fire off our requests and assume that no errors will be returned. ** This function handles the reply messages. */
end_comment

begin_function
name|void
name|ixlv_vc_completion
parameter_list|(
name|struct
name|ixlv_sc
modifier|*
name|sc
parameter_list|,
name|enum
name|i40e_virtchnl_ops
name|v_opcode
parameter_list|,
name|i40e_status
name|v_retval
parameter_list|,
name|u8
modifier|*
name|msg
parameter_list|,
name|u16
name|msglen
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|sc
operator|->
name|dev
decl_stmt|;
name|struct
name|ixl_vsi
modifier|*
name|vsi
init|=
operator|&
name|sc
operator|->
name|vsi
decl_stmt|;
if|if
condition|(
name|v_opcode
operator|==
name|I40E_VIRTCHNL_OP_EVENT
condition|)
block|{
name|struct
name|i40e_virtchnl_pf_event
modifier|*
name|vpe
init|=
operator|(
expr|struct
name|i40e_virtchnl_pf_event
operator|*
operator|)
name|msg
decl_stmt|;
switch|switch
condition|(
name|vpe
operator|->
name|event
condition|)
block|{
case|case
name|I40E_VIRTCHNL_EVENT_LINK_CHANGE
case|:
name|vsi
operator|->
name|link_up
operator|=
name|vpe
operator|->
name|event_data
operator|.
name|link_event
operator|.
name|link_status
expr_stmt|;
name|vsi
operator|->
name|link_speed
operator|=
name|vpe
operator|->
name|event_data
operator|.
name|link_event
operator|.
name|link_speed
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_EVENT_RESET_IMPENDING
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"PF initiated reset!\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|init_state
operator|=
name|IXLV_RESET_PENDING
expr_stmt|;
name|ixlv_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Unknown event %d from AQ\n"
argument_list|,
name|__func__
argument_list|,
name|vpe
operator|->
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
if|if
condition|(
name|v_opcode
operator|!=
name|sc
operator|->
name|current_op
operator|&&
name|sc
operator|->
name|current_op
operator|!=
name|I40E_VIRTCHNL_OP_GET_STATS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Pending op is %d, received %d.\n"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|current_op
argument_list|,
name|v_opcode
argument_list|)
expr_stmt|;
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_UNKNOWN
expr_stmt|;
return|return;
block|}
comment|/* Catch-all error response */
if|if
condition|(
name|v_retval
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: AQ returned error %d to our request %d!\n"
argument_list|,
name|__func__
argument_list|,
name|v_retval
argument_list|,
name|v_opcode
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|IXL_DEBUG
if|if
condition|(
name|v_opcode
operator|!=
name|I40E_VIRTCHNL_OP_GET_STATS
condition|)
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"opcode %d"
argument_list|,
name|v_opcode
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|v_opcode
condition|)
block|{
case|case
name|I40E_VIRTCHNL_OP_GET_STATS
case|:
name|ixlv_update_stats_counters
argument_list|(
name|sc
argument_list|,
operator|(
expr|struct
name|i40e_eth_stats
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
case|:
name|sc
operator|->
name|aq_pending
operator|&=
operator|~
operator|(
name|IXLV_FLAG_AQ_ADD_MAC_FILTER
operator|)
expr_stmt|;
if|if
condition|(
name|v_retval
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING: Error adding VF mac filter!\n"
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING: Device may not receive traffic!\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_DEL_ETHER_ADDRESS
case|:
name|sc
operator|->
name|aq_pending
operator|&=
operator|~
operator|(
name|IXLV_FLAG_AQ_DEL_MAC_FILTER
operator|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
case|:
name|sc
operator|->
name|aq_pending
operator|&=
operator|~
operator|(
name|IXLV_FLAG_AQ_CONFIGURE_PROMISC
operator|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ADD_VLAN
case|:
name|sc
operator|->
name|aq_pending
operator|&=
operator|~
operator|(
name|IXLV_FLAG_AQ_ADD_VLAN_FILTER
operator|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_DEL_VLAN
case|:
name|sc
operator|->
name|aq_pending
operator|&=
operator|~
operator|(
name|IXLV_FLAG_AQ_DEL_VLAN_FILTER
operator|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
case|:
name|sc
operator|->
name|aq_pending
operator|&=
operator|~
operator|(
name|IXLV_FLAG_AQ_ENABLE_QUEUES
operator|)
expr_stmt|;
if|if
condition|(
name|v_retval
operator|==
literal|0
condition|)
block|{
comment|/* Turn on all interrupts */
name|ixlv_enable_intr
argument_list|(
name|vsi
argument_list|)
expr_stmt|;
comment|/* And inform the stack we're ready */
name|vsi
operator|->
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|vsi
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
case|:
name|sc
operator|->
name|aq_pending
operator|&=
operator|~
operator|(
name|IXLV_FLAG_AQ_DISABLE_QUEUES
operator|)
expr_stmt|;
if|if
condition|(
name|v_retval
operator|==
literal|0
condition|)
block|{
comment|/* Turn off all interrupts */
name|ixlv_disable_intr
argument_list|(
name|vsi
argument_list|)
expr_stmt|;
comment|/* Tell the stack that the interface is no longer active */
name|vsi
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
case|:
name|sc
operator|->
name|aq_pending
operator|&=
operator|~
operator|(
name|IXLV_FLAG_AQ_CONFIGURE_QUEUES
operator|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
case|:
name|sc
operator|->
name|aq_pending
operator|&=
operator|~
operator|(
name|IXLV_FLAG_AQ_MAP_VECTORS
operator|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Received unexpected message %d from PF.\n"
argument_list|,
name|__func__
argument_list|,
name|v_opcode
argument_list|)
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|current_op
operator|=
name|I40E_VIRTCHNL_OP_UNKNOWN
expr_stmt|;
return|return;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2013-2015, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"i40e_status.h"
end_include

begin_include
include|#
directive|include
file|"i40e_type.h"
end_include

begin_include
include|#
directive|include
file|"i40e_register.h"
end_include

begin_include
include|#
directive|include
file|"i40e_adminq.h"
end_include

begin_include
include|#
directive|include
file|"i40e_prototype.h"
end_include

begin_comment
comment|/**  * i40e_is_nvm_update_op - return TRUE if this is an NVM update operation  * @desc: API request descriptor  **/
end_comment

begin_function
specifier|static
name|INLINE
name|bool
name|i40e_is_nvm_update_op
parameter_list|(
name|struct
name|i40e_aq_desc
modifier|*
name|desc
parameter_list|)
block|{
return|return
operator|(
name|desc
operator|->
name|opcode
operator|==
name|CPU_TO_LE16
argument_list|(
name|i40e_aqc_opc_nvm_erase
argument_list|)
operator|||
name|desc
operator|->
name|opcode
operator|==
name|CPU_TO_LE16
argument_list|(
name|i40e_aqc_opc_nvm_update
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_adminq_init_regs - Initialize AdminQ registers  *  @hw: pointer to the hardware structure  *  *  This assumes the alloc_asq and alloc_arq functions have already been called  **/
end_comment

begin_function
specifier|static
name|void
name|i40e_adminq_init_regs
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
comment|/* set head and tail registers in our local struct */
if|if
condition|(
name|i40e_is_vf
argument_list|(
name|hw
argument_list|)
condition|)
block|{
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|tail
operator|=
name|I40E_VF_ATQT1
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|head
operator|=
name|I40E_VF_ATQH1
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|len
operator|=
name|I40E_VF_ATQLEN1
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|bal
operator|=
name|I40E_VF_ATQBAL1
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|bah
operator|=
name|I40E_VF_ATQBAH1
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|tail
operator|=
name|I40E_VF_ARQT1
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|head
operator|=
name|I40E_VF_ARQH1
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|len
operator|=
name|I40E_VF_ARQLEN1
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|bal
operator|=
name|I40E_VF_ARQBAL1
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|bah
operator|=
name|I40E_VF_ARQBAH1
expr_stmt|;
block|}
else|else
block|{
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|tail
operator|=
name|I40E_PF_ATQT
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|head
operator|=
name|I40E_PF_ATQH
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|len
operator|=
name|I40E_PF_ATQLEN
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|bal
operator|=
name|I40E_PF_ATQBAL
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|bah
operator|=
name|I40E_PF_ATQBAH
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|tail
operator|=
name|I40E_PF_ARQT
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|head
operator|=
name|I40E_PF_ARQH
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|len
operator|=
name|I40E_PF_ARQLEN
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|bal
operator|=
name|I40E_PF_ARQBAL
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|bah
operator|=
name|I40E_PF_ARQBAH
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  *  i40e_alloc_adminq_asq_ring - Allocate Admin Queue send rings  *  @hw: pointer to the hardware structure  **/
end_comment

begin_function
name|enum
name|i40e_status_code
name|i40e_alloc_adminq_asq_ring
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
decl_stmt|;
name|ret_code
operator|=
name|i40e_allocate_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|desc_buf
argument_list|,
name|i40e_mem_atq_ring
argument_list|,
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_aq_desc
argument_list|)
operator|)
argument_list|,
name|I40E_ADMINQ_DESC_ALIGNMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
condition|)
return|return
name|ret_code
return|;
name|ret_code
operator|=
name|i40e_allocate_virt_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|cmd_buf
argument_list|,
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_asq_cmd_details
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
condition|)
block|{
name|i40e_free_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|desc_buf
argument_list|)
expr_stmt|;
return|return
name|ret_code
return|;
block|}
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_alloc_adminq_arq_ring - Allocate Admin Queue receive rings  *  @hw: pointer to the hardware structure  **/
end_comment

begin_function
name|enum
name|i40e_status_code
name|i40e_alloc_adminq_arq_ring
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
decl_stmt|;
name|ret_code
operator|=
name|i40e_allocate_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|desc_buf
argument_list|,
name|i40e_mem_arq_ring
argument_list|,
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_aq_desc
argument_list|)
operator|)
argument_list|,
name|I40E_ADMINQ_DESC_ALIGNMENT
argument_list|)
expr_stmt|;
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_free_adminq_asq - Free Admin Queue send rings  *  @hw: pointer to the hardware structure  *  *  This assumes the posted send buffers have already been cleaned  *  and de-allocated  **/
end_comment

begin_function
name|void
name|i40e_free_adminq_asq
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|i40e_free_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|desc_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  i40e_free_adminq_arq - Free Admin Queue receive rings  *  @hw: pointer to the hardware structure  *  *  This assumes the posted receive buffers have already been cleaned  *  and de-allocated  **/
end_comment

begin_function
name|void
name|i40e_free_adminq_arq
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|i40e_free_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|desc_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  i40e_alloc_arq_bufs - Allocate pre-posted buffers for the receive queue  *  @hw: pointer to the hardware structure  **/
end_comment

begin_function
specifier|static
name|enum
name|i40e_status_code
name|i40e_alloc_arq_bufs
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
decl_stmt|;
name|struct
name|i40e_aq_desc
modifier|*
name|desc
decl_stmt|;
name|struct
name|i40e_dma_mem
modifier|*
name|bi
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* We'll be allocating the buffer info memory first, then we can 	 * allocate the mapped buffers for the event processing 	 */
comment|/* buffer_info structures do not need alignment */
name|ret_code
operator|=
name|i40e_allocate_virt_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|dma_head
argument_list|,
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_dma_mem
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
condition|)
goto|goto
name|alloc_arq_bufs
goto|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|r
operator|.
name|arq_bi
operator|=
operator|(
expr|struct
name|i40e_dma_mem
operator|*
operator|)
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|dma_head
operator|.
name|va
expr_stmt|;
comment|/* allocate the mapped buffers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
condition|;
name|i
operator|++
control|)
block|{
name|bi
operator|=
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|r
operator|.
name|arq_bi
index|[
name|i
index|]
expr_stmt|;
name|ret_code
operator|=
name|i40e_allocate_dma_mem
argument_list|(
name|hw
argument_list|,
name|bi
argument_list|,
name|i40e_mem_arq_buf
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq_buf_size
argument_list|,
name|I40E_ADMINQ_DESC_ALIGNMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
condition|)
goto|goto
name|unwind_alloc_arq_bufs
goto|;
comment|/* now configure the descriptors for use */
name|desc
operator|=
name|I40E_ADMINQ_DESC
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|arq
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|desc
operator|->
name|flags
operator|=
name|CPU_TO_LE16
argument_list|(
name|I40E_AQ_FLAG_BUF
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|arq_buf_size
operator|>
name|I40E_AQ_LARGE_BUF
condition|)
name|desc
operator|->
name|flags
operator||=
name|CPU_TO_LE16
argument_list|(
name|I40E_AQ_FLAG_LB
argument_list|)
expr_stmt|;
name|desc
operator|->
name|opcode
operator|=
literal|0
expr_stmt|;
comment|/* This is in accordance with Admin queue design, there is no 		 * register for buffer size configuration 		 */
name|desc
operator|->
name|datalen
operator|=
name|CPU_TO_LE16
argument_list|(
operator|(
name|u16
operator|)
name|bi
operator|->
name|size
argument_list|)
expr_stmt|;
name|desc
operator|->
name|retval
operator|=
literal|0
expr_stmt|;
name|desc
operator|->
name|cookie_high
operator|=
literal|0
expr_stmt|;
name|desc
operator|->
name|cookie_low
operator|=
literal|0
expr_stmt|;
name|desc
operator|->
name|params
operator|.
name|external
operator|.
name|addr_high
operator|=
name|CPU_TO_LE32
argument_list|(
name|I40E_HI_DWORD
argument_list|(
name|bi
operator|->
name|pa
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|params
operator|.
name|external
operator|.
name|addr_low
operator|=
name|CPU_TO_LE32
argument_list|(
name|I40E_LO_DWORD
argument_list|(
name|bi
operator|->
name|pa
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|params
operator|.
name|external
operator|.
name|param0
operator|=
literal|0
expr_stmt|;
name|desc
operator|->
name|params
operator|.
name|external
operator|.
name|param1
operator|=
literal|0
expr_stmt|;
block|}
name|alloc_arq_bufs
label|:
return|return
name|ret_code
return|;
name|unwind_alloc_arq_bufs
label|:
comment|/* don't try to free the one that failed... */
name|i
operator|--
expr_stmt|;
for|for
control|(
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|i40e_free_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|r
operator|.
name|arq_bi
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i40e_free_virt_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|dma_head
argument_list|)
expr_stmt|;
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_alloc_asq_bufs - Allocate empty buffer structs for the send queue  *  @hw: pointer to the hardware structure  **/
end_comment

begin_function
specifier|static
name|enum
name|i40e_status_code
name|i40e_alloc_asq_bufs
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
decl_stmt|;
name|struct
name|i40e_dma_mem
modifier|*
name|bi
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* No mapped memory needed yet, just the buffer info structures */
name|ret_code
operator|=
name|i40e_allocate_virt_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|dma_head
argument_list|,
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_dma_mem
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
condition|)
goto|goto
name|alloc_asq_bufs
goto|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|r
operator|.
name|asq_bi
operator|=
operator|(
expr|struct
name|i40e_dma_mem
operator|*
operator|)
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|dma_head
operator|.
name|va
expr_stmt|;
comment|/* allocate the mapped buffers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
condition|;
name|i
operator|++
control|)
block|{
name|bi
operator|=
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|r
operator|.
name|asq_bi
index|[
name|i
index|]
expr_stmt|;
name|ret_code
operator|=
name|i40e_allocate_dma_mem
argument_list|(
name|hw
argument_list|,
name|bi
argument_list|,
name|i40e_mem_asq_buf
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq_buf_size
argument_list|,
name|I40E_ADMINQ_DESC_ALIGNMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
condition|)
goto|goto
name|unwind_alloc_asq_bufs
goto|;
block|}
name|alloc_asq_bufs
label|:
return|return
name|ret_code
return|;
name|unwind_alloc_asq_bufs
label|:
comment|/* don't try to free the one that failed... */
name|i
operator|--
expr_stmt|;
for|for
control|(
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|i40e_free_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|r
operator|.
name|asq_bi
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i40e_free_virt_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|dma_head
argument_list|)
expr_stmt|;
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_free_arq_bufs - Free receive queue buffer info elements  *  @hw: pointer to the hardware structure  **/
end_comment

begin_function
specifier|static
name|void
name|i40e_free_arq_bufs
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* free descriptors */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
condition|;
name|i
operator|++
control|)
name|i40e_free_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|r
operator|.
name|arq_bi
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* free the descriptor memory */
name|i40e_free_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|desc_buf
argument_list|)
expr_stmt|;
comment|/* free the dma header */
name|i40e_free_virt_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|dma_head
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  i40e_free_asq_bufs - Free send queue buffer info elements  *  @hw: pointer to the hardware structure  **/
end_comment

begin_function
specifier|static
name|void
name|i40e_free_asq_bufs
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* only unmap if the address is non-NULL */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|r
operator|.
name|asq_bi
index|[
name|i
index|]
operator|.
name|pa
condition|)
name|i40e_free_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|r
operator|.
name|asq_bi
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* free the buffer info list */
name|i40e_free_virt_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|cmd_buf
argument_list|)
expr_stmt|;
comment|/* free the descriptor memory */
name|i40e_free_dma_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|desc_buf
argument_list|)
expr_stmt|;
comment|/* free the dma header */
name|i40e_free_virt_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|dma_head
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  i40e_config_asq_regs - configure ASQ registers  *  @hw: pointer to the hardware structure  *  *  Configure base address and length registers for the transmit queue  **/
end_comment

begin_function
specifier|static
name|enum
name|i40e_status_code
name|i40e_config_asq_regs
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
init|=
name|I40E_SUCCESS
decl_stmt|;
name|u32
name|reg
init|=
literal|0
decl_stmt|;
comment|/* Clear Head and Tail */
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|head
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|tail
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set starting point */
if|if
condition|(
operator|!
name|i40e_is_vf
argument_list|(
name|hw
argument_list|)
condition|)
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|len
argument_list|,
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
operator||
name|I40E_PF_ATQLEN_ATQENABLE_MASK
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i40e_is_vf
argument_list|(
name|hw
argument_list|)
condition|)
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|len
argument_list|,
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
operator||
name|I40E_VF_ATQLEN1_ATQENABLE_MASK
operator|)
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|bal
argument_list|,
name|I40E_LO_DWORD
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|desc_buf
operator|.
name|pa
argument_list|)
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|bah
argument_list|,
name|I40E_HI_DWORD
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|desc_buf
operator|.
name|pa
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check one register to verify that config was applied */
name|reg
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|bal
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|!=
name|I40E_LO_DWORD
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|desc_buf
operator|.
name|pa
argument_list|)
condition|)
name|ret_code
operator|=
name|I40E_ERR_ADMIN_QUEUE_ERROR
expr_stmt|;
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_config_arq_regs - ARQ register configuration  *  @hw: pointer to the hardware structure  *  * Configure base address and length registers for the receive (event queue)  **/
end_comment

begin_function
specifier|static
name|enum
name|i40e_status_code
name|i40e_config_arq_regs
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
init|=
name|I40E_SUCCESS
decl_stmt|;
name|u32
name|reg
init|=
literal|0
decl_stmt|;
comment|/* Clear Head and Tail */
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|head
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|tail
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set starting point */
if|if
condition|(
operator|!
name|i40e_is_vf
argument_list|(
name|hw
argument_list|)
condition|)
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|len
argument_list|,
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
operator||
name|I40E_PF_ARQLEN_ARQENABLE_MASK
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i40e_is_vf
argument_list|(
name|hw
argument_list|)
condition|)
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|len
argument_list|,
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
operator||
name|I40E_VF_ARQLEN1_ARQENABLE_MASK
operator|)
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|bal
argument_list|,
name|I40E_LO_DWORD
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|desc_buf
operator|.
name|pa
argument_list|)
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|bah
argument_list|,
name|I40E_HI_DWORD
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|desc_buf
operator|.
name|pa
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Update tail in the HW to post pre-allocated buffers */
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|tail
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Check one register to verify that config was applied */
name|reg
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|bal
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|!=
name|I40E_LO_DWORD
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|desc_buf
operator|.
name|pa
argument_list|)
condition|)
name|ret_code
operator|=
name|I40E_ERR_ADMIN_QUEUE_ERROR
expr_stmt|;
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_init_asq - main initialization routine for ASQ  *  @hw: pointer to the hardware structure  *  *  This is the main initialization routine for the Admin Send Queue  *  Prior to calling this function, drivers *MUST* set the following fields  *  in the hw->aq structure:  *     - hw->aq.num_asq_entries  *     - hw->aq.arq_buf_size  *  *  Do *NOT* hold the lock when calling this as the memory allocation routines  *  called are not going to be atomic context safe  **/
end_comment

begin_function
name|enum
name|i40e_status_code
name|i40e_init_asq
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
init|=
name|I40E_SUCCESS
decl_stmt|;
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|count
operator|>
literal|0
condition|)
block|{
comment|/* queue already initialized */
name|ret_code
operator|=
name|I40E_ERR_NOT_READY
expr_stmt|;
goto|goto
name|init_adminq_exit
goto|;
block|}
comment|/* verify input for valid configuration */
if|if
condition|(
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
operator|==
literal|0
operator|)
operator|||
operator|(
name|hw
operator|->
name|aq
operator|.
name|asq_buf_size
operator|==
literal|0
operator|)
condition|)
block|{
name|ret_code
operator|=
name|I40E_ERR_CONFIG
expr_stmt|;
goto|goto
name|init_adminq_exit
goto|;
block|}
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_use
operator|=
literal|0
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_clean
operator|=
literal|0
expr_stmt|;
comment|/* allocate the ring memory */
name|ret_code
operator|=
name|i40e_alloc_adminq_asq_ring
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|init_adminq_exit
goto|;
comment|/* allocate buffers in the rings */
name|ret_code
operator|=
name|i40e_alloc_asq_bufs
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|init_adminq_free_rings
goto|;
comment|/* initialize base registers */
name|ret_code
operator|=
name|i40e_config_asq_regs
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|init_adminq_free_rings
goto|;
comment|/* success! */
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|count
operator|=
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
expr_stmt|;
goto|goto
name|init_adminq_exit
goto|;
name|init_adminq_free_rings
label|:
name|i40e_free_adminq_asq
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|init_adminq_exit
label|:
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_init_arq - initialize ARQ  *  @hw: pointer to the hardware structure  *  *  The main initialization routine for the Admin Receive (Event) Queue.  *  Prior to calling this function, drivers *MUST* set the following fields  *  in the hw->aq structure:  *     - hw->aq.num_asq_entries  *     - hw->aq.arq_buf_size  *  *  Do *NOT* hold the lock when calling this as the memory allocation routines  *  called are not going to be atomic context safe  **/
end_comment

begin_function
name|enum
name|i40e_status_code
name|i40e_init_arq
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
init|=
name|I40E_SUCCESS
decl_stmt|;
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|count
operator|>
literal|0
condition|)
block|{
comment|/* queue already initialized */
name|ret_code
operator|=
name|I40E_ERR_NOT_READY
expr_stmt|;
goto|goto
name|init_adminq_exit
goto|;
block|}
comment|/* verify input for valid configuration */
if|if
condition|(
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
operator|==
literal|0
operator|)
operator|||
operator|(
name|hw
operator|->
name|aq
operator|.
name|arq_buf_size
operator|==
literal|0
operator|)
condition|)
block|{
name|ret_code
operator|=
name|I40E_ERR_CONFIG
expr_stmt|;
goto|goto
name|init_adminq_exit
goto|;
block|}
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|next_to_use
operator|=
literal|0
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|next_to_clean
operator|=
literal|0
expr_stmt|;
comment|/* allocate the ring memory */
name|ret_code
operator|=
name|i40e_alloc_adminq_arq_ring
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|init_adminq_exit
goto|;
comment|/* allocate buffers in the rings */
name|ret_code
operator|=
name|i40e_alloc_arq_bufs
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|init_adminq_free_rings
goto|;
comment|/* initialize base registers */
name|ret_code
operator|=
name|i40e_config_arq_regs
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|init_adminq_free_rings
goto|;
comment|/* success! */
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|count
operator|=
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
expr_stmt|;
goto|goto
name|init_adminq_exit
goto|;
name|init_adminq_free_rings
label|:
name|i40e_free_adminq_arq
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|init_adminq_exit
label|:
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_shutdown_asq - shutdown the ASQ  *  @hw: pointer to the hardware structure  *  *  The main shutdown routine for the Admin Send Queue  **/
end_comment

begin_function
name|enum
name|i40e_status_code
name|i40e_shutdown_asq
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
init|=
name|I40E_SUCCESS
decl_stmt|;
name|i40e_acquire_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|count
operator|==
literal|0
condition|)
block|{
name|ret_code
operator|=
name|I40E_ERR_NOT_READY
expr_stmt|;
goto|goto
name|shutdown_asq_out
goto|;
block|}
comment|/* Stop firmware AdminQ processing */
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|head
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|tail
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|bal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|bah
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|count
operator|=
literal|0
expr_stmt|;
comment|/* to indicate uninitialized queue */
comment|/* free ring buffers */
name|i40e_free_asq_bufs
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|shutdown_asq_out
label|:
name|i40e_release_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq_spinlock
argument_list|)
expr_stmt|;
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_shutdown_arq - shutdown ARQ  *  @hw: pointer to the hardware structure  *  *  The main shutdown routine for the Admin Receive Queue  **/
end_comment

begin_function
name|enum
name|i40e_status_code
name|i40e_shutdown_arq
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
init|=
name|I40E_SUCCESS
decl_stmt|;
name|i40e_acquire_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|count
operator|==
literal|0
condition|)
block|{
name|ret_code
operator|=
name|I40E_ERR_NOT_READY
expr_stmt|;
goto|goto
name|shutdown_arq_out
goto|;
block|}
comment|/* Stop firmware AdminQ processing */
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|head
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|tail
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|bal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|bah
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|count
operator|=
literal|0
expr_stmt|;
comment|/* to indicate uninitialized queue */
comment|/* free ring buffers */
name|i40e_free_arq_bufs
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|shutdown_arq_out
label|:
name|i40e_release_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq_spinlock
argument_list|)
expr_stmt|;
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_init_adminq - main initialization routine for Admin Queue  *  @hw: pointer to the hardware structure  *  *  Prior to calling this function, drivers *MUST* set the following fields  *  in the hw->aq structure:  *     - hw->aq.num_asq_entries  *     - hw->aq.num_arq_entries  *     - hw->aq.arq_buf_size  *     - hw->aq.asq_buf_size  **/
end_comment

begin_function
name|enum
name|i40e_status_code
name|i40e_init_adminq
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
decl_stmt|;
name|u16
name|eetrack_lo
decl_stmt|,
name|eetrack_hi
decl_stmt|;
name|u16
name|cfg_ptr
decl_stmt|,
name|oem_hi
decl_stmt|,
name|oem_lo
decl_stmt|;
name|int
name|retry
init|=
literal|0
decl_stmt|;
comment|/* verify input for valid configuration */
if|if
condition|(
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
operator|==
literal|0
operator|)
operator|||
operator|(
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
operator|==
literal|0
operator|)
operator|||
operator|(
name|hw
operator|->
name|aq
operator|.
name|arq_buf_size
operator|==
literal|0
operator|)
operator|||
operator|(
name|hw
operator|->
name|aq
operator|.
name|asq_buf_size
operator|==
literal|0
operator|)
condition|)
block|{
name|ret_code
operator|=
name|I40E_ERR_CONFIG
expr_stmt|;
goto|goto
name|init_adminq_exit
goto|;
block|}
comment|/* initialize spin locks */
name|i40e_init_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq_spinlock
argument_list|)
expr_stmt|;
name|i40e_init_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq_spinlock
argument_list|)
expr_stmt|;
comment|/* Set up register offsets */
name|i40e_adminq_init_regs
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* setup ASQ command write back timeout */
name|hw
operator|->
name|aq
operator|.
name|asq_cmd_timeout
operator|=
name|I40E_ASQ_CMD_TIMEOUT
expr_stmt|;
comment|/* allocate the ASQ */
name|ret_code
operator|=
name|i40e_init_asq
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|init_adminq_destroy_spinlocks
goto|;
comment|/* allocate the ARQ */
name|ret_code
operator|=
name|i40e_init_arq
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|init_adminq_free_asq
goto|;
comment|/* VF has no need of firmware */
if|if
condition|(
name|i40e_is_vf
argument_list|(
name|hw
argument_list|)
condition|)
goto|goto
name|init_adminq_exit
goto|;
comment|/* There are some cases where the firmware may not be quite ready 	 * for AdminQ operations, so we retry the AdminQ setup a few times 	 * if we see timeouts in this first AQ call. 	 */
do|do
block|{
name|ret_code
operator|=
name|i40e_aq_get_firmware_version
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|fw_maj_ver
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|fw_min_ver
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|fw_build
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|api_maj_ver
argument_list|,
operator|&
name|hw
operator|->
name|aq
operator|.
name|api_min_ver
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
operator|!=
name|I40E_ERR_ADMIN_QUEUE_TIMEOUT
condition|)
break|break;
name|retry
operator|++
expr_stmt|;
name|i40e_msec_delay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|i40e_resume_aq
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|retry
operator|<
literal|10
condition|)
do|;
if|if
condition|(
name|ret_code
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|init_adminq_free_arq
goto|;
comment|/* get the NVM version info */
name|i40e_read_nvm_word
argument_list|(
name|hw
argument_list|,
name|I40E_SR_NVM_DEV_STARTER_VERSION
argument_list|,
operator|&
name|hw
operator|->
name|nvm
operator|.
name|version
argument_list|)
expr_stmt|;
name|i40e_read_nvm_word
argument_list|(
name|hw
argument_list|,
name|I40E_SR_NVM_EETRACK_LO
argument_list|,
operator|&
name|eetrack_lo
argument_list|)
expr_stmt|;
name|i40e_read_nvm_word
argument_list|(
name|hw
argument_list|,
name|I40E_SR_NVM_EETRACK_HI
argument_list|,
operator|&
name|eetrack_hi
argument_list|)
expr_stmt|;
name|hw
operator|->
name|nvm
operator|.
name|eetrack
operator|=
operator|(
name|eetrack_hi
operator|<<
literal|16
operator|)
operator||
name|eetrack_lo
expr_stmt|;
name|i40e_read_nvm_word
argument_list|(
name|hw
argument_list|,
name|I40E_SR_BOOT_CONFIG_PTR
argument_list|,
operator|&
name|cfg_ptr
argument_list|)
expr_stmt|;
name|i40e_read_nvm_word
argument_list|(
name|hw
argument_list|,
operator|(
name|cfg_ptr
operator|+
name|I40E_NVM_OEM_VER_OFF
operator|)
argument_list|,
operator|&
name|oem_hi
argument_list|)
expr_stmt|;
name|i40e_read_nvm_word
argument_list|(
name|hw
argument_list|,
operator|(
name|cfg_ptr
operator|+
operator|(
name|I40E_NVM_OEM_VER_OFF
operator|+
literal|1
operator|)
operator|)
argument_list|,
operator|&
name|oem_lo
argument_list|)
expr_stmt|;
name|hw
operator|->
name|nvm
operator|.
name|oem_ver
operator|=
operator|(
operator|(
name|u32
operator|)
name|oem_hi
operator|<<
literal|16
operator|)
operator||
name|oem_lo
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|api_maj_ver
operator|>
name|I40E_FW_API_VERSION_MAJOR
condition|)
block|{
name|ret_code
operator|=
name|I40E_ERR_FIRMWARE_API_VERSION
expr_stmt|;
goto|goto
name|init_adminq_free_arq
goto|;
block|}
comment|/* pre-emptive resource lock release */
name|i40e_aq_release_resource
argument_list|(
name|hw
argument_list|,
name|I40E_NVM_RESOURCE_ID
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|nvm_release_on_done
operator|=
name|FALSE
expr_stmt|;
name|hw
operator|->
name|nvmupd_state
operator|=
name|I40E_NVMUPD_STATE_INIT
expr_stmt|;
name|ret_code
operator|=
name|i40e_aq_set_hmc_resource_profile
argument_list|(
name|hw
argument_list|,
name|I40E_HMC_PROFILE_DEFAULT
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret_code
operator|=
name|I40E_SUCCESS
expr_stmt|;
comment|/* success! */
goto|goto
name|init_adminq_exit
goto|;
name|init_adminq_free_arq
label|:
name|i40e_shutdown_arq
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|init_adminq_free_asq
label|:
name|i40e_shutdown_asq
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|init_adminq_destroy_spinlocks
label|:
name|i40e_destroy_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq_spinlock
argument_list|)
expr_stmt|;
name|i40e_destroy_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq_spinlock
argument_list|)
expr_stmt|;
name|init_adminq_exit
label|:
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_shutdown_adminq - shutdown routine for the Admin Queue  *  @hw: pointer to the hardware structure  **/
end_comment

begin_function
name|enum
name|i40e_status_code
name|i40e_shutdown_adminq
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
init|=
name|I40E_SUCCESS
decl_stmt|;
if|if
condition|(
name|i40e_check_asq_alive
argument_list|(
name|hw
argument_list|)
condition|)
name|i40e_aq_queue_shutdown
argument_list|(
name|hw
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|i40e_shutdown_asq
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|i40e_shutdown_arq
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* destroy the spinlocks */
name|i40e_destroy_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq_spinlock
argument_list|)
expr_stmt|;
name|i40e_destroy_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|nvm_buff
operator|.
name|va
condition|)
name|i40e_free_virt_mem
argument_list|(
name|hw
argument_list|,
operator|&
name|hw
operator|->
name|nvm_buff
argument_list|)
expr_stmt|;
return|return
name|ret_code
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_clean_asq - cleans Admin send queue  *  @hw: pointer to the hardware structure  *  *  returns the number of free desc  **/
end_comment

begin_function
name|u16
name|i40e_clean_asq
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|i40e_adminq_ring
modifier|*
name|asq
init|=
operator|&
operator|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|)
decl_stmt|;
name|struct
name|i40e_asq_cmd_details
modifier|*
name|details
decl_stmt|;
name|u16
name|ntc
init|=
name|asq
operator|->
name|next_to_clean
decl_stmt|;
name|struct
name|i40e_aq_desc
name|desc_cb
decl_stmt|;
name|struct
name|i40e_aq_desc
modifier|*
name|desc
decl_stmt|;
name|desc
operator|=
name|I40E_ADMINQ_DESC
argument_list|(
operator|*
name|asq
argument_list|,
name|ntc
argument_list|)
expr_stmt|;
name|details
operator|=
name|I40E_ADMINQ_DETAILS
argument_list|(
operator|*
name|asq
argument_list|,
name|ntc
argument_list|)
expr_stmt|;
while|while
condition|(
name|rd32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|head
argument_list|)
operator|!=
name|ntc
condition|)
block|{
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"ntc %d head %d.\n"
argument_list|,
name|ntc
argument_list|,
name|rd32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|head
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|details
operator|->
name|callback
condition|)
block|{
name|I40E_ADMINQ_CALLBACK
name|cb_func
init|=
operator|(
name|I40E_ADMINQ_CALLBACK
operator|)
name|details
operator|->
name|callback
decl_stmt|;
name|i40e_memcpy
argument_list|(
operator|&
name|desc_cb
argument_list|,
name|desc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_aq_desc
argument_list|)
argument_list|,
name|I40E_DMA_TO_DMA
argument_list|)
expr_stmt|;
name|cb_func
argument_list|(
name|hw
argument_list|,
operator|&
name|desc_cb
argument_list|)
expr_stmt|;
block|}
name|i40e_memset
argument_list|(
name|desc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|desc
argument_list|)
argument_list|,
name|I40E_DMA_MEM
argument_list|)
expr_stmt|;
name|i40e_memset
argument_list|(
name|details
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|details
argument_list|)
argument_list|,
name|I40E_NONDMA_MEM
argument_list|)
expr_stmt|;
name|ntc
operator|++
expr_stmt|;
if|if
condition|(
name|ntc
operator|==
name|asq
operator|->
name|count
condition|)
name|ntc
operator|=
literal|0
expr_stmt|;
name|desc
operator|=
name|I40E_ADMINQ_DESC
argument_list|(
operator|*
name|asq
argument_list|,
name|ntc
argument_list|)
expr_stmt|;
name|details
operator|=
name|I40E_ADMINQ_DETAILS
argument_list|(
operator|*
name|asq
argument_list|,
name|ntc
argument_list|)
expr_stmt|;
block|}
name|asq
operator|->
name|next_to_clean
operator|=
name|ntc
expr_stmt|;
return|return
name|I40E_DESC_UNUSED
argument_list|(
name|asq
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_asq_done - check if FW has processed the Admin Send Queue  *  @hw: pointer to the hw struct  *  *  Returns TRUE if the firmware has processed all descriptors on the  *  admin send queue. Returns FALSE if there are still requests pending.  **/
end_comment

begin_function
name|bool
name|i40e_asq_done
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
comment|/* AQ designers suggest use of head for better 	 * timing reliability than DD bit 	 */
return|return
name|rd32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|head
argument_list|)
operator|==
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_use
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_asq_send_command - send command to Admin Queue  *  @hw: pointer to the hw struct  *  @desc: prefilled descriptor describing the command (non DMA mem)  *  @buff: buffer to use for indirect commands  *  @buff_size: size of buffer for indirect commands  *  @cmd_details: pointer to command details structure  *  *  This is the main send command driver routine for the Admin Queue send  *  queue.  It runs the queue, cleans the queue, etc  **/
end_comment

begin_function
name|enum
name|i40e_status_code
name|i40e_asq_send_command
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|i40e_aq_desc
modifier|*
name|desc
parameter_list|,
name|void
modifier|*
name|buff
parameter_list|,
comment|/* can be NULL */
name|u16
name|buff_size
parameter_list|,
name|struct
name|i40e_asq_cmd_details
modifier|*
name|cmd_details
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|status
init|=
name|I40E_SUCCESS
decl_stmt|;
name|struct
name|i40e_dma_mem
modifier|*
name|dma_buff
init|=
name|NULL
decl_stmt|;
name|struct
name|i40e_asq_cmd_details
modifier|*
name|details
decl_stmt|;
name|struct
name|i40e_aq_desc
modifier|*
name|desc_on_ring
decl_stmt|;
name|bool
name|cmd_completed
init|=
name|FALSE
decl_stmt|;
name|u16
name|retval
init|=
literal|0
decl_stmt|;
name|u32
name|val
init|=
literal|0
decl_stmt|;
name|i40e_acquire_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq_spinlock
argument_list|)
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
operator|=
name|I40E_AQ_RC_OK
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|count
operator|==
literal|0
condition|)
block|{
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQTX: Admin queue not initialized.\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|I40E_ERR_QUEUE_EMPTY
expr_stmt|;
goto|goto
name|asq_send_command_error
goto|;
block|}
name|val
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|head
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>=
name|hw
operator|->
name|aq
operator|.
name|num_asq_entries
condition|)
block|{
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQTX: head overrun at %d\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|status
operator|=
name|I40E_ERR_QUEUE_EMPTY
expr_stmt|;
goto|goto
name|asq_send_command_error
goto|;
block|}
name|details
operator|=
name|I40E_ADMINQ_DETAILS
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|asq
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_use
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd_details
condition|)
block|{
name|i40e_memcpy
argument_list|(
name|details
argument_list|,
name|cmd_details
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_asq_cmd_details
argument_list|)
argument_list|,
name|I40E_NONDMA_TO_NONDMA
argument_list|)
expr_stmt|;
comment|/* If the cmd_details are defined copy the cookie.  The 		 * CPU_TO_LE32 is not needed here because the data is ignored 		 * by the FW, only used by the driver 		 */
if|if
condition|(
name|details
operator|->
name|cookie
condition|)
block|{
name|desc
operator|->
name|cookie_high
operator|=
name|CPU_TO_LE32
argument_list|(
name|I40E_HI_DWORD
argument_list|(
name|details
operator|->
name|cookie
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|cookie_low
operator|=
name|CPU_TO_LE32
argument_list|(
name|I40E_LO_DWORD
argument_list|(
name|details
operator|->
name|cookie
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|i40e_memset
argument_list|(
name|details
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_asq_cmd_details
argument_list|)
argument_list|,
name|I40E_NONDMA_MEM
argument_list|)
expr_stmt|;
block|}
comment|/* clear requested flags and then set additional flags if defined */
name|desc
operator|->
name|flags
operator|&=
operator|~
name|CPU_TO_LE16
argument_list|(
name|details
operator|->
name|flags_dis
argument_list|)
expr_stmt|;
name|desc
operator|->
name|flags
operator||=
name|CPU_TO_LE16
argument_list|(
name|details
operator|->
name|flags_ena
argument_list|)
expr_stmt|;
if|if
condition|(
name|buff_size
operator|>
name|hw
operator|->
name|aq
operator|.
name|asq_buf_size
condition|)
block|{
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQTX: Invalid buffer size: %d.\n"
argument_list|,
name|buff_size
argument_list|)
expr_stmt|;
name|status
operator|=
name|I40E_ERR_INVALID_SIZE
expr_stmt|;
goto|goto
name|asq_send_command_error
goto|;
block|}
if|if
condition|(
name|details
operator|->
name|postpone
operator|&&
operator|!
name|details
operator|->
name|async
condition|)
block|{
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQTX: Async flag not set along with postpone flag"
argument_list|)
expr_stmt|;
name|status
operator|=
name|I40E_ERR_PARAM
expr_stmt|;
goto|goto
name|asq_send_command_error
goto|;
block|}
comment|/* call clean and check queue available function to reclaim the 	 * descriptors that were processed by FW, the function returns the 	 * number of desc available 	 */
comment|/* the clean function called here could be called in a separate thread 	 * in case of asynchronous completions 	 */
if|if
condition|(
name|i40e_clean_asq
argument_list|(
name|hw
argument_list|)
operator|==
literal|0
condition|)
block|{
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQTX: Error queue is full.\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|I40E_ERR_ADMIN_QUEUE_FULL
expr_stmt|;
goto|goto
name|asq_send_command_error
goto|;
block|}
comment|/* initialize the temp desc pointer with the right desc */
name|desc_on_ring
operator|=
name|I40E_ADMINQ_DESC
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|asq
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_use
argument_list|)
expr_stmt|;
comment|/* if the desc is available copy the temp desc to the right place */
name|i40e_memcpy
argument_list|(
name|desc_on_ring
argument_list|,
name|desc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_aq_desc
argument_list|)
argument_list|,
name|I40E_NONDMA_TO_DMA
argument_list|)
expr_stmt|;
comment|/* if buff is not NULL assume indirect command */
if|if
condition|(
name|buff
operator|!=
name|NULL
condition|)
block|{
name|dma_buff
operator|=
operator|&
operator|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|r
operator|.
name|asq_bi
index|[
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_use
index|]
operator|)
expr_stmt|;
comment|/* copy the user buff into the respective DMA buff */
name|i40e_memcpy
argument_list|(
name|dma_buff
operator|->
name|va
argument_list|,
name|buff
argument_list|,
name|buff_size
argument_list|,
name|I40E_NONDMA_TO_DMA
argument_list|)
expr_stmt|;
name|desc_on_ring
operator|->
name|datalen
operator|=
name|CPU_TO_LE16
argument_list|(
name|buff_size
argument_list|)
expr_stmt|;
comment|/* Update the address values in the desc with the pa value 		 * for respective buffer 		 */
name|desc_on_ring
operator|->
name|params
operator|.
name|external
operator|.
name|addr_high
operator|=
name|CPU_TO_LE32
argument_list|(
name|I40E_HI_DWORD
argument_list|(
name|dma_buff
operator|->
name|pa
argument_list|)
argument_list|)
expr_stmt|;
name|desc_on_ring
operator|->
name|params
operator|.
name|external
operator|.
name|addr_low
operator|=
name|CPU_TO_LE32
argument_list|(
name|I40E_LO_DWORD
argument_list|(
name|dma_buff
operator|->
name|pa
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* bump the tail */
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQTX: desc and buffer:\n"
argument_list|)
expr_stmt|;
name|i40e_debug_aq
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_COMMAND
argument_list|,
operator|(
name|void
operator|*
operator|)
name|desc_on_ring
argument_list|,
name|buff
argument_list|,
name|buff_size
argument_list|)
expr_stmt|;
operator|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_use
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_use
operator|==
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|count
condition|)
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_use
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|details
operator|->
name|postpone
condition|)
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|tail
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_use
argument_list|)
expr_stmt|;
comment|/* if cmd_details are not defined or async flag is not set, 	 * we need to wait for desc write back 	 */
if|if
condition|(
operator|!
name|details
operator|->
name|async
operator|&&
operator|!
name|details
operator|->
name|postpone
condition|)
block|{
name|u32
name|total_delay
init|=
literal|0
decl_stmt|;
do|do
block|{
comment|/* AQ designers suggest use of head for better 			 * timing reliability than DD bit 			 */
if|if
condition|(
name|i40e_asq_done
argument_list|(
name|hw
argument_list|)
condition|)
break|break;
comment|/* ugh! delay while spin_lock */
name|i40e_msec_delay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|total_delay
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|total_delay
operator|<
name|hw
operator|->
name|aq
operator|.
name|asq_cmd_timeout
condition|)
do|;
block|}
comment|/* if ready, copy the desc back to temp */
if|if
condition|(
name|i40e_asq_done
argument_list|(
name|hw
argument_list|)
condition|)
block|{
name|i40e_memcpy
argument_list|(
name|desc
argument_list|,
name|desc_on_ring
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_aq_desc
argument_list|)
argument_list|,
name|I40E_DMA_TO_NONDMA
argument_list|)
expr_stmt|;
if|if
condition|(
name|buff
operator|!=
name|NULL
condition|)
name|i40e_memcpy
argument_list|(
name|buff
argument_list|,
name|dma_buff
operator|->
name|va
argument_list|,
name|buff_size
argument_list|,
name|I40E_DMA_TO_NONDMA
argument_list|)
expr_stmt|;
name|retval
operator|=
name|LE16_TO_CPU
argument_list|(
name|desc
operator|->
name|retval
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
block|{
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQTX: Command completed with error 0x%X.\n"
argument_list|,
name|retval
argument_list|)
expr_stmt|;
comment|/* strip off FW internal code */
name|retval
operator|&=
literal|0xff
expr_stmt|;
block|}
name|cmd_completed
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|(
expr|enum
name|i40e_admin_queue_err
operator|)
name|retval
operator|==
name|I40E_AQ_RC_OK
condition|)
name|status
operator|=
name|I40E_SUCCESS
expr_stmt|;
else|else
name|status
operator|=
name|I40E_ERR_ADMIN_QUEUE_ERROR
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
operator|=
operator|(
expr|enum
name|i40e_admin_queue_err
operator|)
name|retval
expr_stmt|;
block|}
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQTX: desc and buffer writeback:\n"
argument_list|)
expr_stmt|;
name|i40e_debug_aq
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_COMMAND
argument_list|,
operator|(
name|void
operator|*
operator|)
name|desc
argument_list|,
name|buff
argument_list|,
name|buff_size
argument_list|)
expr_stmt|;
comment|/* save writeback aq if requested */
if|if
condition|(
name|details
operator|->
name|wb_desc
condition|)
name|i40e_memcpy
argument_list|(
name|details
operator|->
name|wb_desc
argument_list|,
name|desc_on_ring
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_aq_desc
argument_list|)
argument_list|,
name|I40E_DMA_TO_NONDMA
argument_list|)
expr_stmt|;
comment|/* update the error if time out occurred */
if|if
condition|(
operator|(
operator|!
name|cmd_completed
operator|)
operator|&&
operator|(
operator|!
name|details
operator|->
name|async
operator|&&
operator|!
name|details
operator|->
name|postpone
operator|)
condition|)
block|{
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQTX: Writeback timeout.\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|I40E_ERR_ADMIN_QUEUE_TIMEOUT
expr_stmt|;
block|}
name|asq_send_command_error
label|:
name|i40e_release_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|asq_spinlock
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  i40e_fill_default_direct_cmd_desc - AQ descriptor helper function  *  @desc:     pointer to the temp descriptor (non DMA mem)  *  @opcode:   the opcode can be used to decide which flags to turn off or on  *  *  Fill the desc with default values  **/
end_comment

begin_function
name|void
name|i40e_fill_default_direct_cmd_desc
parameter_list|(
name|struct
name|i40e_aq_desc
modifier|*
name|desc
parameter_list|,
name|u16
name|opcode
parameter_list|)
block|{
comment|/* zero out the desc */
name|i40e_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|desc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_aq_desc
argument_list|)
argument_list|,
name|I40E_NONDMA_MEM
argument_list|)
expr_stmt|;
name|desc
operator|->
name|opcode
operator|=
name|CPU_TO_LE16
argument_list|(
name|opcode
argument_list|)
expr_stmt|;
name|desc
operator|->
name|flags
operator|=
name|CPU_TO_LE16
argument_list|(
name|I40E_AQ_FLAG_SI
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  i40e_clean_arq_element  *  @hw: pointer to the hw struct  *  @e: event info from the receive descriptor, includes any buffers  *  @pending: number of events that could be left to process  *  *  This function cleans one Admin Receive Queue element and returns  *  the contents through e.  It can also return how many events are  *  left to process through 'pending'  **/
end_comment

begin_function
name|enum
name|i40e_status_code
name|i40e_clean_arq_element
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|i40e_arq_event_info
modifier|*
name|e
parameter_list|,
name|u16
modifier|*
name|pending
parameter_list|)
block|{
name|enum
name|i40e_status_code
name|ret_code
init|=
name|I40E_SUCCESS
decl_stmt|;
name|u16
name|ntc
init|=
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|next_to_clean
decl_stmt|;
name|struct
name|i40e_aq_desc
modifier|*
name|desc
decl_stmt|;
name|struct
name|i40e_dma_mem
modifier|*
name|bi
decl_stmt|;
name|u16
name|desc_idx
decl_stmt|;
name|u16
name|datalen
decl_stmt|;
name|u16
name|flags
decl_stmt|;
name|u16
name|ntu
decl_stmt|;
comment|/* pre-clean the event info */
name|i40e_memset
argument_list|(
operator|&
name|e
operator|->
name|desc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|e
operator|->
name|desc
argument_list|)
argument_list|,
name|I40E_NONDMA_MEM
argument_list|)
expr_stmt|;
comment|/* take the lock before we start messing with the ring */
name|i40e_acquire_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|count
operator|==
literal|0
condition|)
block|{
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQRX: Admin queue not initialized.\n"
argument_list|)
expr_stmt|;
name|ret_code
operator|=
name|I40E_ERR_QUEUE_EMPTY
expr_stmt|;
goto|goto
name|clean_arq_element_err
goto|;
block|}
comment|/* set next_to_use to head */
if|if
condition|(
operator|!
name|i40e_is_vf
argument_list|(
name|hw
argument_list|)
condition|)
name|ntu
operator|=
operator|(
name|rd32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|head
argument_list|)
operator|&
name|I40E_PF_ARQH_ARQH_MASK
operator|)
expr_stmt|;
if|if
condition|(
name|i40e_is_vf
argument_list|(
name|hw
argument_list|)
condition|)
name|ntu
operator|=
operator|(
name|rd32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|head
argument_list|)
operator|&
name|I40E_VF_ARQH1_ARQH_MASK
operator|)
expr_stmt|;
if|if
condition|(
name|ntu
operator|==
name|ntc
condition|)
block|{
comment|/* nothing to do - shouldn't need to update ring's values */
name|ret_code
operator|=
name|I40E_ERR_ADMIN_QUEUE_NO_WORK
expr_stmt|;
goto|goto
name|clean_arq_element_out
goto|;
block|}
comment|/* now clean the next descriptor */
name|desc
operator|=
name|I40E_ADMINQ_DESC
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|arq
argument_list|,
name|ntc
argument_list|)
expr_stmt|;
name|desc_idx
operator|=
name|ntc
expr_stmt|;
name|flags
operator|=
name|LE16_TO_CPU
argument_list|(
name|desc
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|I40E_AQ_FLAG_ERR
condition|)
block|{
name|ret_code
operator|=
name|I40E_ERR_ADMIN_QUEUE_ERROR
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq_last_status
operator|=
operator|(
expr|enum
name|i40e_admin_queue_err
operator|)
name|LE16_TO_CPU
argument_list|(
name|desc
operator|->
name|retval
argument_list|)
expr_stmt|;
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQRX: Event received with error 0x%X.\n"
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq_last_status
argument_list|)
expr_stmt|;
block|}
name|i40e_memcpy
argument_list|(
operator|&
name|e
operator|->
name|desc
argument_list|,
name|desc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_aq_desc
argument_list|)
argument_list|,
name|I40E_DMA_TO_NONDMA
argument_list|)
expr_stmt|;
name|datalen
operator|=
name|LE16_TO_CPU
argument_list|(
name|desc
operator|->
name|datalen
argument_list|)
expr_stmt|;
name|e
operator|->
name|msg_len
operator|=
name|min
argument_list|(
name|datalen
argument_list|,
name|e
operator|->
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|msg_buf
operator|!=
name|NULL
operator|&&
operator|(
name|e
operator|->
name|msg_len
operator|!=
literal|0
operator|)
condition|)
name|i40e_memcpy
argument_list|(
name|e
operator|->
name|msg_buf
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|r
operator|.
name|arq_bi
index|[
name|desc_idx
index|]
operator|.
name|va
argument_list|,
name|e
operator|->
name|msg_len
argument_list|,
name|I40E_DMA_TO_NONDMA
argument_list|)
expr_stmt|;
name|i40e_debug
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_MESSAGE
argument_list|,
literal|"AQRX: desc and buffer:\n"
argument_list|)
expr_stmt|;
name|i40e_debug_aq
argument_list|(
name|hw
argument_list|,
name|I40E_DEBUG_AQ_COMMAND
argument_list|,
operator|(
name|void
operator|*
operator|)
name|desc
argument_list|,
name|e
operator|->
name|msg_buf
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq_buf_size
argument_list|)
expr_stmt|;
comment|/* Restore the original datalen and buffer address in the desc, 	 * FW updates datalen to indicate the event message 	 * size 	 */
name|bi
operator|=
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|r
operator|.
name|arq_bi
index|[
name|ntc
index|]
expr_stmt|;
name|i40e_memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|desc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_aq_desc
argument_list|)
argument_list|,
name|I40E_DMA_MEM
argument_list|)
expr_stmt|;
name|desc
operator|->
name|flags
operator|=
name|CPU_TO_LE16
argument_list|(
name|I40E_AQ_FLAG_BUF
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|arq_buf_size
operator|>
name|I40E_AQ_LARGE_BUF
condition|)
name|desc
operator|->
name|flags
operator||=
name|CPU_TO_LE16
argument_list|(
name|I40E_AQ_FLAG_LB
argument_list|)
expr_stmt|;
name|desc
operator|->
name|datalen
operator|=
name|CPU_TO_LE16
argument_list|(
operator|(
name|u16
operator|)
name|bi
operator|->
name|size
argument_list|)
expr_stmt|;
name|desc
operator|->
name|params
operator|.
name|external
operator|.
name|addr_high
operator|=
name|CPU_TO_LE32
argument_list|(
name|I40E_HI_DWORD
argument_list|(
name|bi
operator|->
name|pa
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|params
operator|.
name|external
operator|.
name|addr_low
operator|=
name|CPU_TO_LE32
argument_list|(
name|I40E_LO_DWORD
argument_list|(
name|bi
operator|->
name|pa
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set tail = the last cleaned desc index. */
name|wr32
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|tail
argument_list|,
name|ntc
argument_list|)
expr_stmt|;
comment|/* ntc is updated to tail + 1 */
name|ntc
operator|++
expr_stmt|;
if|if
condition|(
name|ntc
operator|==
name|hw
operator|->
name|aq
operator|.
name|num_arq_entries
condition|)
name|ntc
operator|=
literal|0
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|next_to_clean
operator|=
name|ntc
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|next_to_use
operator|=
name|ntu
expr_stmt|;
if|if
condition|(
name|i40e_is_nvm_update_op
argument_list|(
operator|&
name|e
operator|->
name|desc
argument_list|)
condition|)
block|{
if|if
condition|(
name|hw
operator|->
name|aq
operator|.
name|nvm_release_on_done
condition|)
block|{
name|i40e_release_nvm
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|nvm_release_on_done
operator|=
name|FALSE
expr_stmt|;
block|}
switch|switch
condition|(
name|hw
operator|->
name|nvmupd_state
condition|)
block|{
case|case
name|I40E_NVMUPD_STATE_INIT_WAIT
case|:
name|hw
operator|->
name|nvmupd_state
operator|=
name|I40E_NVMUPD_STATE_INIT
expr_stmt|;
break|break;
case|case
name|I40E_NVMUPD_STATE_WRITE_WAIT
case|:
name|hw
operator|->
name|nvmupd_state
operator|=
name|I40E_NVMUPD_STATE_WRITING
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|clean_arq_element_out
label|:
comment|/* Set pending if needed, unlock and return */
if|if
condition|(
name|pending
operator|!=
name|NULL
condition|)
operator|*
name|pending
operator|=
operator|(
name|ntc
operator|>
name|ntu
condition|?
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|count
else|:
literal|0
operator|)
operator|+
operator|(
name|ntu
operator|-
name|ntc
operator|)
expr_stmt|;
name|clean_arq_element_err
label|:
name|i40e_release_spinlock
argument_list|(
operator|&
name|hw
operator|->
name|aq
operator|.
name|arq_spinlock
argument_list|)
expr_stmt|;
return|return
name|ret_code
return|;
block|}
end_function

begin_function
name|void
name|i40e_resume_aq
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|)
block|{
comment|/* Registers are reset after PF reset */
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_use
operator|=
literal|0
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|asq
operator|.
name|next_to_clean
operator|=
literal|0
expr_stmt|;
name|i40e_config_asq_regs
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|next_to_use
operator|=
literal|0
expr_stmt|;
name|hw
operator|->
name|aq
operator|.
name|arq
operator|.
name|next_to_clean
operator|=
literal|0
expr_stmt|;
name|i40e_config_arq_regs
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2013-2014, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|"ixl.h"
end_include

begin_comment
comment|/********************************************************************  * Manage DMA'able memory.  *******************************************************************/
end_comment

begin_function
specifier|static
name|void
name|i40e_dmamap_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
if|if
condition|(
name|error
condition|)
return|return;
operator|*
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|i40e_status
name|i40e_allocate_virt
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|i40e_virt_mem
modifier|*
name|m
parameter_list|,
name|u32
name|size
parameter_list|)
block|{
name|m
operator|->
name|va
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
return|return
operator|(
name|m
operator|->
name|va
operator|==
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|i40e_status
name|i40e_free_virt
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|i40e_virt_mem
modifier|*
name|m
parameter_list|)
block|{
name|free
argument_list|(
name|m
operator|->
name|va
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|i40e_status
name|i40e_allocate_dma
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|i40e_dma_mem
modifier|*
name|dma
parameter_list|,
name|bus_size_t
name|size
parameter_list|,
name|u32
name|alignment
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
operator|(
expr|struct
name|i40e_osdep
operator|*
operator|)
name|hw
operator|->
name|back
operator|)
operator|->
name|dev
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
comment|/* parent */
name|alignment
argument_list|,
literal|0
argument_list|,
comment|/* alignment, bounds */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|size
argument_list|,
comment|/* maxsize */
literal|1
argument_list|,
comment|/* nsegments */
name|size
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
operator|&
name|dma
operator|->
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"i40e_allocate_dma: bus_dma_tag_create failed, "
literal|"error %u\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|fail_0
goto|;
block|}
name|err
operator|=
name|bus_dmamem_alloc
argument_list|(
name|dma
operator|->
name|tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|dma
operator|->
name|va
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|dma
operator|->
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"i40e_allocate_dma: bus_dmamem_alloc failed, "
literal|"error %u\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|fail_1
goto|;
block|}
name|err
operator|=
name|bus_dmamap_load
argument_list|(
name|dma
operator|->
name|tag
argument_list|,
name|dma
operator|->
name|map
argument_list|,
name|dma
operator|->
name|va
argument_list|,
name|size
argument_list|,
name|i40e_dmamap_cb
argument_list|,
operator|&
name|dma
operator|->
name|pa
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"i40e_allocate_dma: bus_dmamap_load failed, "
literal|"error %u\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|fail_2
goto|;
block|}
name|dma
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|dma
operator|->
name|tag
argument_list|,
name|dma
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail_2
label|:
name|bus_dmamem_free
argument_list|(
name|dma
operator|->
name|tag
argument_list|,
name|dma
operator|->
name|va
argument_list|,
name|dma
operator|->
name|map
argument_list|)
expr_stmt|;
name|fail_1
label|:
name|bus_dma_tag_destroy
argument_list|(
name|dma
operator|->
name|tag
argument_list|)
expr_stmt|;
name|fail_0
label|:
name|dma
operator|->
name|map
operator|=
name|NULL
expr_stmt|;
name|dma
operator|->
name|tag
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|i40e_status
name|i40e_free_dma
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|i40e_dma_mem
modifier|*
name|dma
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|dma
operator|->
name|tag
argument_list|,
name|dma
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|dma
operator|->
name|tag
argument_list|,
name|dma
operator|->
name|map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|dma
operator|->
name|tag
argument_list|,
name|dma
operator|->
name|va
argument_list|,
name|dma
operator|->
name|map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|dma
operator|->
name|tag
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|i40e_init_spinlock
parameter_list|(
name|struct
name|i40e_spinlock
modifier|*
name|lock
parameter_list|)
block|{
name|mtx_init
argument_list|(
operator|&
name|lock
operator|->
name|mutex
argument_list|,
literal|"mutex"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
operator||
name|MTX_DUPOK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|i40e_acquire_spinlock
parameter_list|(
name|struct
name|i40e_spinlock
modifier|*
name|lock
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|lock
operator|->
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|i40e_release_spinlock
parameter_list|(
name|struct
name|i40e_spinlock
modifier|*
name|lock
parameter_list|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|lock
operator|->
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|i40e_destroy_spinlock
parameter_list|(
name|struct
name|i40e_spinlock
modifier|*
name|lock
parameter_list|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|lock
operator|->
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** i40e_debug_d - OS dependent version of shared code debug printing */
end_comment

begin_function
name|void
name|i40e_debug_d
parameter_list|(
name|void
modifier|*
name|hw
parameter_list|,
name|u32
name|mask
parameter_list|,
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
name|va_list
name|args
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
operator|(
operator|(
expr|struct
name|i40e_hw
operator|*
operator|)
name|hw
operator|)
operator|->
name|debug_mask
operator|)
condition|)
return|return;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
comment|/* the debug string is already formatted with a newline */
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u16
name|i40e_read_pci_cfg
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|reg
parameter_list|)
block|{
name|u16
name|value
decl_stmt|;
name|value
operator|=
name|pci_read_config
argument_list|(
operator|(
operator|(
expr|struct
name|i40e_osdep
operator|*
operator|)
name|hw
operator|->
name|back
operator|)
operator|->
name|dev
argument_list|,
name|reg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
name|void
name|i40e_write_pci_cfg
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u16
name|value
parameter_list|)
block|{
name|pci_write_config
argument_list|(
operator|(
operator|(
expr|struct
name|i40e_osdep
operator|*
operator|)
name|hw
operator|->
name|back
operator|)
operator|->
name|dev
argument_list|,
name|reg
argument_list|,
name|value
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2013-2015, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"ixl_pf_iov.h"
end_include

begin_comment
comment|/* Private functions */
end_comment

begin_function_decl
specifier|static
name|void
name|ixl_vf_map_vsi_queue
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|int
name|qnum
parameter_list|,
name|uint32_t
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_disable_queue_intr
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|uint32_t
name|vfint_reg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_unregister_intr
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|uint32_t
name|vpint_reg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|ixl_zero_mac
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|ixl_bcast_mac
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ixl_vc_opcode_level
parameter_list|(
name|uint16_t
name|opcode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ixl_vf_mac_valid
parameter_list|(
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ixl_vf_alloc_vsi
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ixl_vf_setup_vsi
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_map_queues
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_vsi_release
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vsi
modifier|*
name|vsi
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_release_resources
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ixl_flush_pcie
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_reset_vf
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_reinit_vf
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_send_vf_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|uint16_t
name|op
parameter_list|,
name|enum
name|i40e_status_code
name|status
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_send_vf_ack
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|uint16_t
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_send_vf_nack_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|uint16_t
name|op
parameter_list|,
name|enum
name|i40e_status_code
name|status
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_version_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_reset_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_get_resources_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ixl_vf_config_tx_queue
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|struct
name|i40e_virtchnl_txq_info
modifier|*
name|info
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ixl_vf_config_rx_queue
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|struct
name|i40e_virtchnl_rxq_info
modifier|*
name|info
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_config_vsi_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_set_qctl
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
specifier|const
name|struct
name|i40e_virtchnl_vector_map
modifier|*
name|vector
parameter_list|,
name|enum
name|i40e_queue_type
name|cur_type
parameter_list|,
name|uint16_t
name|cur_queue
parameter_list|,
name|enum
name|i40e_queue_type
modifier|*
name|last_type
parameter_list|,
name|uint16_t
modifier|*
name|last_queue
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_config_vector
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
specifier|const
name|struct
name|i40e_virtchnl_vector_map
modifier|*
name|vector
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_config_irq_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_enable_queues_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_disable_queues_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_add_mac_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_del_mac_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|enum
name|i40e_status_code
name|ixl_vf_enable_vlan_strip
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_add_vlan_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_del_vlan_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_config_promisc_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_vf_get_stats_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ixl_vf_reserve_queues
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|int
name|num_queues
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ixl_adminq_err_to_errno
parameter_list|(
name|enum
name|i40e_admin_queue_err
name|err
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|ixl_initialize_sriov
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|pf
operator|->
name|dev
decl_stmt|;
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|nvlist_t
modifier|*
name|pf_schema
decl_stmt|,
modifier|*
name|vf_schema
decl_stmt|;
name|int
name|iov_error
decl_stmt|;
comment|/* SR-IOV is only supported when MSI-X is in use. */
if|if
condition|(
name|pf
operator|->
name|msix
operator|<=
literal|1
condition|)
return|return;
name|pf_schema
operator|=
name|pci_iov_schema_alloc_node
argument_list|()
expr_stmt|;
name|vf_schema
operator|=
name|pci_iov_schema_alloc_node
argument_list|()
expr_stmt|;
name|pci_iov_schema_add_unicast_mac
argument_list|(
name|vf_schema
argument_list|,
literal|"mac-addr"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pci_iov_schema_add_bool
argument_list|(
name|vf_schema
argument_list|,
literal|"mac-anti-spoof"
argument_list|,
name|IOV_SCHEMA_HASDEFAULT
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|pci_iov_schema_add_bool
argument_list|(
name|vf_schema
argument_list|,
literal|"allow-set-mac"
argument_list|,
name|IOV_SCHEMA_HASDEFAULT
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pci_iov_schema_add_bool
argument_list|(
name|vf_schema
argument_list|,
literal|"allow-promisc"
argument_list|,
name|IOV_SCHEMA_HASDEFAULT
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pci_iov_schema_add_uint16
argument_list|(
name|vf_schema
argument_list|,
literal|"num-queues"
argument_list|,
name|IOV_SCHEMA_HASDEFAULT
argument_list|,
name|max
argument_list|(
literal|1
argument_list|,
name|hw
operator|->
name|func_caps
operator|.
name|num_msix_vectors_vf
operator|-
literal|1
argument_list|)
operator|%
name|IXLV_MAX_QUEUES
argument_list|)
expr_stmt|;
name|iov_error
operator|=
name|pci_iov_attach
argument_list|(
name|dev
argument_list|,
name|pf_schema
argument_list|,
name|vf_schema
argument_list|)
expr_stmt|;
if|if
condition|(
name|iov_error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Failed to initialize SR-IOV (error=%d)\n"
argument_list|,
name|iov_error
argument_list|)
expr_stmt|;
block|}
else|else
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"SR-IOV ready\n"
argument_list|)
expr_stmt|;
name|pf
operator|->
name|vc_debug_lvl
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Allocate the VSI for a VF.  */
end_comment

begin_function
specifier|static
name|int
name|ixl_vf_alloc_vsi
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|ixl_vsi
modifier|*
name|vsi
decl_stmt|;
name|struct
name|i40e_vsi_context
name|vsi_ctx
decl_stmt|;
name|int
name|i
decl_stmt|;
name|enum
name|i40e_status_code
name|code
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|vsi
operator|=
operator|&
name|pf
operator|->
name|vsi
expr_stmt|;
name|dev
operator|=
name|pf
operator|->
name|dev
expr_stmt|;
name|vsi_ctx
operator|.
name|pf_num
operator|=
name|hw
operator|->
name|pf_id
expr_stmt|;
name|vsi_ctx
operator|.
name|uplink_seid
operator|=
name|pf
operator|->
name|veb_seid
expr_stmt|;
name|vsi_ctx
operator|.
name|connection_type
operator|=
name|IXL_VSI_DATA_PORT
expr_stmt|;
name|vsi_ctx
operator|.
name|vf_num
operator|=
name|hw
operator|->
name|func_caps
operator|.
name|vf_base_id
operator|+
name|vf
operator|->
name|vf_num
expr_stmt|;
name|vsi_ctx
operator|.
name|flags
operator|=
name|I40E_AQ_VSI_TYPE_VF
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|vsi_ctx
operator|.
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|vsi_ctx
operator|.
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|valid_sections
operator|=
name|htole16
argument_list|(
name|I40E_AQ_VSI_PROP_SWITCH_VALID
argument_list|)
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|switch_id
operator|=
name|htole16
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|valid_sections
operator||=
name|htole16
argument_list|(
name|I40E_AQ_VSI_PROP_SECURITY_VALID
argument_list|)
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|sec_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vf
operator|->
name|vf_flags
operator|&
name|VF_FLAG_MAC_ANTI_SPOOF
condition|)
name|vsi_ctx
operator|.
name|info
operator|.
name|sec_flags
operator||=
name|I40E_AQ_VSI_SEC_FLAG_ENABLE_MAC_CHK
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|valid_sections
operator||=
name|htole16
argument_list|(
name|I40E_AQ_VSI_PROP_VLAN_VALID
argument_list|)
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|port_vlan_flags
operator|=
name|I40E_AQ_VSI_PVLAN_MODE_ALL
operator||
name|I40E_AQ_VSI_PVLAN_EMOD_NOTHING
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|valid_sections
operator||=
name|htole16
argument_list|(
name|I40E_AQ_VSI_PROP_QUEUE_MAP_VALID
argument_list|)
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|mapping_flags
operator|=
name|htole16
argument_list|(
name|I40E_AQ_VSI_QUE_MAP_NONCONTIG
argument_list|)
expr_stmt|;
comment|/* ERJ: Only scattered allocation is supported for VFs right now */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vf
operator|->
name|qtag
operator|.
name|num_active
condition|;
name|i
operator|++
control|)
name|vsi_ctx
operator|.
name|info
operator|.
name|queue_mapping
index|[
name|i
index|]
operator|=
name|vf
operator|->
name|qtag
operator|.
name|qidx
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|nitems
argument_list|(
name|vsi_ctx
operator|.
name|info
operator|.
name|queue_mapping
argument_list|)
condition|;
name|i
operator|++
control|)
name|vsi_ctx
operator|.
name|info
operator|.
name|queue_mapping
index|[
name|i
index|]
operator|=
name|htole16
argument_list|(
name|I40E_AQ_VSI_QUEUE_MASK
argument_list|)
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|tc_mapping
index|[
literal|0
index|]
operator|=
name|htole16
argument_list|(
operator|(
literal|0
operator|<<
name|I40E_AQ_VSI_TC_QUE_OFFSET_SHIFT
operator|)
operator||
operator|(
name|bsrl
argument_list|(
name|vf
operator|->
name|qtag
operator|.
name|num_allocated
argument_list|)
operator|<<
name|I40E_AQ_VSI_TC_QUE_NUMBER_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|code
operator|=
name|i40e_aq_add_vsi
argument_list|(
name|hw
argument_list|,
operator|&
name|vsi_ctx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|!=
name|I40E_SUCCESS
condition|)
return|return
operator|(
name|ixl_adminq_err_to_errno
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
argument_list|)
operator|)
return|;
name|vf
operator|->
name|vsi
operator|.
name|seid
operator|=
name|vsi_ctx
operator|.
name|seid
expr_stmt|;
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
operator|=
name|vsi_ctx
operator|.
name|vsi_number
expr_stmt|;
comment|// vf->vsi.first_queue = vf->qtag.qidx[0];
name|vf
operator|->
name|vsi
operator|.
name|num_queues
operator|=
name|vf
operator|->
name|qtag
operator|.
name|num_active
expr_stmt|;
name|code
operator|=
name|i40e_aq_get_vsi_params
argument_list|(
name|hw
argument_list|,
operator|&
name|vsi_ctx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|!=
name|I40E_SUCCESS
condition|)
return|return
operator|(
name|ixl_adminq_err_to_errno
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
argument_list|)
operator|)
return|;
name|code
operator|=
name|i40e_aq_config_vsi_bw_limit
argument_list|(
name|hw
argument_list|,
name|vf
operator|->
name|vsi
operator|.
name|seid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|!=
name|I40E_SUCCESS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Failed to disable BW limit: %d\n"
argument_list|,
name|ixl_adminq_err_to_errno
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ixl_adminq_err_to_errno
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
argument_list|)
operator|)
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|vf
operator|->
name|vsi
operator|.
name|info
argument_list|,
operator|&
name|vsi_ctx
operator|.
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|vf
operator|->
name|vsi
operator|.
name|info
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ixl_vf_setup_vsi
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|int
name|error
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|error
operator|=
name|ixl_vf_alloc_vsi
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|vf
operator|->
name|vsi
operator|.
name|hw_filters_add
operator|=
literal|0
expr_stmt|;
name|vf
operator|->
name|vsi
operator|.
name|hw_filters_del
operator|=
literal|0
expr_stmt|;
name|ixl_add_filter
argument_list|(
operator|&
name|vf
operator|->
name|vsi
argument_list|,
name|ixl_bcast_addr
argument_list|,
name|IXL_VLAN_ANY
argument_list|)
expr_stmt|;
name|ixl_reconfigure_filters
argument_list|(
operator|&
name|vf
operator|->
name|vsi
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_map_vsi_queue
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|int
name|qnum
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|uint32_t
name|qtable
decl_stmt|;
name|int
name|index
decl_stmt|,
name|shift
decl_stmt|;
comment|/* 	 * Two queues are mapped in a single register, so we have to do some 	 * gymnastics to convert the queue number into a register index and 	 * shift. 	 */
name|index
operator|=
name|qnum
operator|/
literal|2
expr_stmt|;
name|shift
operator|=
operator|(
name|qnum
operator|%
literal|2
operator|)
operator|*
name|I40E_VSILAN_QTABLE_QINDEX_1_SHIFT
expr_stmt|;
name|qtable
operator|=
name|i40e_read_rx_ctl
argument_list|(
name|hw
argument_list|,
name|I40E_VSILAN_QTABLE
argument_list|(
name|index
argument_list|,
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
argument_list|)
argument_list|)
expr_stmt|;
name|qtable
operator|&=
operator|~
operator|(
name|I40E_VSILAN_QTABLE_QINDEX_0_MASK
operator|<<
name|shift
operator|)
expr_stmt|;
name|qtable
operator||=
name|val
operator|<<
name|shift
expr_stmt|;
name|i40e_write_rx_ctl
argument_list|(
name|hw
argument_list|,
name|I40E_VSILAN_QTABLE
argument_list|(
name|index
argument_list|,
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
argument_list|)
argument_list|,
name|qtable
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_map_queues
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|qtable
decl_stmt|;
name|int
name|i
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
comment|/* 	 * Contiguous mappings aren't actually supported by the hardware, 	 * so we have to use non-contiguous mappings. 	 */
name|i40e_write_rx_ctl
argument_list|(
name|hw
argument_list|,
name|I40E_VSILAN_QBASE
argument_list|(
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
argument_list|)
argument_list|,
name|I40E_VSILAN_QBASE_VSIQTABLE_ENA_MASK
argument_list|)
expr_stmt|;
comment|/* Enable LAN traffic on this VF */
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_VPLAN_MAPENA
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|,
name|I40E_VPLAN_MAPENA_TXRX_ENA_MASK
argument_list|)
expr_stmt|;
comment|/* Program index of each VF queue into PF queue space 	 * (This is only needed if QTABLE is enabled) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vf
operator|->
name|vsi
operator|.
name|num_queues
condition|;
name|i
operator|++
control|)
block|{
name|qtable
operator|=
name|ixl_pf_qidx_from_vsi_qidx
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|)
operator|<<
name|I40E_VPLAN_QTABLE_QINDEX_SHIFT
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_VPLAN_QTABLE
argument_list|(
name|i
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|,
name|qtable
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
name|IXL_MAX_VSI_QUEUES
condition|;
name|i
operator|++
control|)
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_VPLAN_QTABLE
argument_list|(
name|i
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|,
name|I40E_VPLAN_QTABLE_QINDEX_MASK
argument_list|)
expr_stmt|;
comment|/* Map queues allocated to VF to its VSI; 	 * This mapping matches the VF-wide mapping since the VF 	 * is only given a single VSI */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vf
operator|->
name|vsi
operator|.
name|num_queues
condition|;
name|i
operator|++
control|)
name|ixl_vf_map_vsi_queue
argument_list|(
name|hw
argument_list|,
name|vf
argument_list|,
name|i
argument_list|,
name|ixl_pf_qidx_from_vsi_qidx
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set rest of VSI queues as unused. */
for|for
control|(
init|;
name|i
operator|<
name|IXL_MAX_VSI_QUEUES
condition|;
name|i
operator|++
control|)
name|ixl_vf_map_vsi_queue
argument_list|(
name|hw
argument_list|,
name|vf
argument_list|,
name|i
argument_list|,
name|I40E_VSILAN_QTABLE_QINDEX_0_MASK
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_vsi_release
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vsi
modifier|*
name|vsi
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
if|if
condition|(
name|vsi
operator|->
name|seid
operator|==
literal|0
condition|)
return|return;
name|i40e_aq_delete_element
argument_list|(
name|hw
argument_list|,
name|vsi
operator|->
name|seid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_disable_queue_intr
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|uint32_t
name|vfint_reg
parameter_list|)
block|{
name|wr32
argument_list|(
name|hw
argument_list|,
name|vfint_reg
argument_list|,
name|I40E_VFINT_DYN_CTLN_CLEARPBA_MASK
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_unregister_intr
parameter_list|(
name|struct
name|i40e_hw
modifier|*
name|hw
parameter_list|,
name|uint32_t
name|vpint_reg
parameter_list|)
block|{
name|wr32
argument_list|(
name|hw
argument_list|,
name|vpint_reg
argument_list|,
name|I40E_VPINT_LNKLSTN_FIRSTQ_TYPE_MASK
operator||
name|I40E_VPINT_LNKLSTN_FIRSTQ_INDX_MASK
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_release_resources
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|vfint_reg
decl_stmt|,
name|vpint_reg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|ixl_vf_vsi_release
argument_list|(
name|pf
argument_list|,
operator|&
name|vf
operator|->
name|vsi
argument_list|)
expr_stmt|;
comment|/* Index 0 has a special register. */
name|ixl_vf_disable_queue_intr
argument_list|(
name|hw
argument_list|,
name|I40E_VFINT_DYN_CTL0
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|hw
operator|->
name|func_caps
operator|.
name|num_msix_vectors_vf
condition|;
name|i
operator|++
control|)
block|{
name|vfint_reg
operator|=
name|IXL_VFINT_DYN_CTLN_REG
argument_list|(
name|hw
argument_list|,
name|i
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
name|ixl_vf_disable_queue_intr
argument_list|(
name|hw
argument_list|,
name|vfint_reg
argument_list|)
expr_stmt|;
block|}
comment|/* Index 0 has a special register. */
name|ixl_vf_unregister_intr
argument_list|(
name|hw
argument_list|,
name|I40E_VPINT_LNKLST0
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|hw
operator|->
name|func_caps
operator|.
name|num_msix_vectors_vf
condition|;
name|i
operator|++
control|)
block|{
name|vpint_reg
operator|=
name|IXL_VPINT_LNKLSTN_REG
argument_list|(
name|hw
argument_list|,
name|i
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
name|ixl_vf_unregister_intr
argument_list|(
name|hw
argument_list|,
name|vpint_reg
argument_list|)
expr_stmt|;
block|}
name|vf
operator|->
name|vsi
operator|.
name|num_queues
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ixl_flush_pcie
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint16_t
name|global_vf_num
decl_stmt|;
name|uint32_t
name|ciad
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|global_vf_num
operator|=
name|hw
operator|->
name|func_caps
operator|.
name|vf_base_id
operator|+
name|vf
operator|->
name|vf_num
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_PF_PCI_CIAA
argument_list|,
name|IXL_PF_PCI_CIAA_VF_DEVICE_STATUS
operator||
operator|(
name|global_vf_num
operator|<<
name|I40E_PF_PCI_CIAA_VF_NUM_SHIFT
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXL_VF_RESET_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|ciad
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|I40E_PF_PCI_CIAD
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ciad
operator|&
name|IXL_PF_PCI_CIAD_VF_TRANS_PENDING_MASK
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_reset_vf
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|vfrtrig
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|vfrtrig
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|I40E_VPGEN_VFRTRIG
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|)
expr_stmt|;
name|vfrtrig
operator||=
name|I40E_VPGEN_VFRTRIG_VFSWR_MASK
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_VPGEN_VFRTRIG
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|,
name|vfrtrig
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|ixl_reinit_vf
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_reinit_vf
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|vfrstat
decl_stmt|,
name|vfrtrig
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|error
operator|=
name|ixl_flush_pcie
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"Timed out waiting for PCIe activity to stop on VF-%d\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXL_VF_RESET_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|vfrstat
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|I40E_VPGEN_VFRSTAT
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vfrstat
operator|&
name|I40E_VPGEN_VFRSTAT_VFRD_MASK
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|IXL_VF_RESET_TIMEOUT
condition|)
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d failed to reset\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_VFGEN_RSTAT1
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|,
name|I40E_VFR_COMPLETED
argument_list|)
expr_stmt|;
name|vfrtrig
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|I40E_VPGEN_VFRTRIG
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|)
expr_stmt|;
name|vfrtrig
operator|&=
operator|~
name|I40E_VPGEN_VFRTRIG_VFSWR_MASK
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_VPGEN_VFRTRIG
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|,
name|vfrtrig
argument_list|)
expr_stmt|;
if|if
condition|(
name|vf
operator|->
name|vsi
operator|.
name|seid
operator|!=
literal|0
condition|)
name|ixl_disable_rings
argument_list|(
operator|&
name|vf
operator|->
name|vsi
argument_list|)
expr_stmt|;
name|ixl_vf_release_resources
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|ixl_vf_setup_vsi
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|ixl_vf_map_queues
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_VFGEN_RSTAT1
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
argument_list|,
name|I40E_VFR_VFACTIVE
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ixl_vc_opcode_level
parameter_list|(
name|uint16_t
name|opcode
parameter_list|)
block|{
switch|switch
condition|(
name|opcode
condition|)
block|{
case|case
name|I40E_VIRTCHNL_OP_GET_STATS
case|:
return|return
operator|(
literal|10
operator|)
return|;
default|default:
return|return
operator|(
literal|5
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_send_vf_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|uint16_t
name|op
parameter_list|,
name|enum
name|i40e_status_code
name|status
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|len
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|int
name|global_vf_id
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|global_vf_id
operator|=
name|hw
operator|->
name|func_caps
operator|.
name|vf_base_id
operator|+
name|vf
operator|->
name|vf_num
expr_stmt|;
name|I40E_VC_DEBUG
argument_list|(
name|pf
argument_list|,
name|ixl_vc_opcode_level
argument_list|(
name|op
argument_list|)
argument_list|,
literal|"Sending msg (op=%s[%d], status=%d) to VF-%d\n"
argument_list|,
name|ixl_vc_opcode_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|op
argument_list|,
name|status
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
name|i40e_aq_send_msg_to_vf
argument_list|(
name|hw
argument_list|,
name|global_vf_id
argument_list|,
name|op
argument_list|,
name|status
argument_list|,
name|msg
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_send_vf_ack
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|uint16_t
name|op
parameter_list|)
block|{
name|ixl_send_vf_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|op
argument_list|,
name|I40E_SUCCESS
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_send_vf_nack_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|uint16_t
name|op
parameter_list|,
name|enum
name|i40e_status_code
name|status
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|I40E_VC_DEBUG
argument_list|(
name|pf
argument_list|,
literal|1
argument_list|,
literal|"Sending NACK (op=%s[%d], err=%s[%d]) to VF-%d from %s:%d\n"
argument_list|,
name|ixl_vc_opcode_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|op
argument_list|,
name|i40e_stat_str
argument_list|(
operator|&
name|pf
operator|->
name|hw
argument_list|,
name|status
argument_list|)
argument_list|,
name|status
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|ixl_send_vf_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|op
argument_list|,
name|status
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_version_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_version_info
name|reply
decl_stmt|;
if|if
condition|(
name|msg_size
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|i40e_virtchnl_version_info
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_VERSION
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|vf
operator|->
name|version
operator|=
operator|(
operator|(
expr|struct
name|i40e_virtchnl_version_info
operator|*
operator|)
name|msg
operator|)
operator|->
name|minor
expr_stmt|;
name|reply
operator|.
name|major
operator|=
name|I40E_VIRTCHNL_VERSION_MAJOR
expr_stmt|;
name|reply
operator|.
name|minor
operator|=
name|I40E_VIRTCHNL_VERSION_MINOR
expr_stmt|;
name|ixl_send_vf_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_VERSION
argument_list|,
name|I40E_SUCCESS
argument_list|,
operator|&
name|reply
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_reset_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
if|if
condition|(
name|msg_size
operator|!=
literal|0
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_RESET_VF
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|ixl_reset_vf
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
comment|/* No response to a reset message. */
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_get_resources_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_vf_resource
name|reply
decl_stmt|;
if|if
condition|(
operator|(
name|vf
operator|->
name|version
operator|==
literal|0
operator|&&
name|msg_size
operator|!=
literal|0
operator|)
operator|||
operator|(
name|vf
operator|->
name|version
operator|==
literal|1
operator|&&
name|msg_size
operator|!=
literal|4
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"Invalid GET_VF_RESOURCES message size,"
literal|" for VF version %d.%d\n"
argument_list|,
name|I40E_VIRTCHNL_VERSION_MAJOR
argument_list|,
name|vf
operator|->
name|version
argument_list|)
expr_stmt|;
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_GET_VF_RESOURCES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|bzero
argument_list|(
operator|&
name|reply
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vf
operator|->
name|version
operator|==
name|I40E_VIRTCHNL_VERSION_MINOR_NO_VF_CAPS
condition|)
name|reply
operator|.
name|vf_offload_flags
operator|=
name|I40E_VIRTCHNL_VF_OFFLOAD_L2
operator||
name|I40E_VIRTCHNL_VF_OFFLOAD_RSS_REG
operator||
name|I40E_VIRTCHNL_VF_OFFLOAD_VLAN
expr_stmt|;
else|else
comment|/* Force VF RSS setup by PF in 1.1+ VFs */
name|reply
operator|.
name|vf_offload_flags
operator|=
operator|*
operator|(
name|u32
operator|*
operator|)
name|msg
operator|&
operator|(
name|I40E_VIRTCHNL_VF_OFFLOAD_L2
operator||
name|I40E_VIRTCHNL_VF_OFFLOAD_RSS_PF
operator||
name|I40E_VIRTCHNL_VF_OFFLOAD_VLAN
operator|)
expr_stmt|;
name|reply
operator|.
name|num_vsis
operator|=
literal|1
expr_stmt|;
name|reply
operator|.
name|num_queue_pairs
operator|=
name|vf
operator|->
name|vsi
operator|.
name|num_queues
expr_stmt|;
name|reply
operator|.
name|max_vectors
operator|=
name|pf
operator|->
name|hw
operator|.
name|func_caps
operator|.
name|num_msix_vectors_vf
expr_stmt|;
name|reply
operator|.
name|rss_key_size
operator|=
literal|52
expr_stmt|;
name|reply
operator|.
name|rss_lut_size
operator|=
literal|64
expr_stmt|;
name|reply
operator|.
name|vsi_res
index|[
literal|0
index|]
operator|.
name|vsi_id
operator|=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
expr_stmt|;
name|reply
operator|.
name|vsi_res
index|[
literal|0
index|]
operator|.
name|vsi_type
operator|=
name|I40E_VSI_SRIOV
expr_stmt|;
name|reply
operator|.
name|vsi_res
index|[
literal|0
index|]
operator|.
name|num_queue_pairs
operator|=
name|vf
operator|->
name|vsi
operator|.
name|num_queues
expr_stmt|;
name|memcpy
argument_list|(
name|reply
operator|.
name|vsi_res
index|[
literal|0
index|]
operator|.
name|default_mac_addr
argument_list|,
name|vf
operator|->
name|mac
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|ixl_send_vf_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_GET_VF_RESOURCES
argument_list|,
name|I40E_SUCCESS
argument_list|,
operator|&
name|reply
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ixl_vf_config_tx_queue
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|struct
name|i40e_virtchnl_txq_info
modifier|*
name|info
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|i40e_hmc_obj_txq
name|txq
decl_stmt|;
name|uint16_t
name|global_queue_num
decl_stmt|,
name|global_vf_num
decl_stmt|;
name|enum
name|i40e_status_code
name|status
decl_stmt|;
name|uint32_t
name|qtx_ctl
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|global_queue_num
operator|=
name|ixl_pf_qidx_from_vsi_qidx
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|info
operator|->
name|queue_id
argument_list|)
expr_stmt|;
name|global_vf_num
operator|=
name|hw
operator|->
name|func_caps
operator|.
name|vf_base_id
operator|+
name|vf
operator|->
name|vf_num
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|txq
argument_list|,
sizeof|sizeof
argument_list|(
name|txq
argument_list|)
argument_list|)
expr_stmt|;
name|DDPRINTF
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: PF TX queue %d / VF TX queue %d (Global VF %d)\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|global_queue_num
argument_list|,
name|info
operator|->
name|queue_id
argument_list|,
name|global_vf_num
argument_list|)
expr_stmt|;
name|status
operator|=
name|i40e_clear_lan_tx_queue_context
argument_list|(
name|hw
argument_list|,
name|global_queue_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|txq
operator|.
name|base
operator|=
name|info
operator|->
name|dma_ring_addr
operator|/
name|IXL_TX_CTX_BASE_UNITS
expr_stmt|;
name|txq
operator|.
name|head_wb_ena
operator|=
name|info
operator|->
name|headwb_enabled
expr_stmt|;
name|txq
operator|.
name|head_wb_addr
operator|=
name|info
operator|->
name|dma_headwb_addr
expr_stmt|;
name|txq
operator|.
name|qlen
operator|=
name|info
operator|->
name|ring_len
expr_stmt|;
name|txq
operator|.
name|rdylist
operator|=
name|le16_to_cpu
argument_list|(
name|vf
operator|->
name|vsi
operator|.
name|info
operator|.
name|qs_handle
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|txq
operator|.
name|rdylist_act
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|i40e_set_lan_tx_queue_context
argument_list|(
name|hw
argument_list|,
name|global_queue_num
argument_list|,
operator|&
name|txq
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|qtx_ctl
operator|=
name|I40E_QTX_CTL_VF_QUEUE
operator||
operator|(
name|hw
operator|->
name|pf_id
operator|<<
name|I40E_QTX_CTL_PF_INDX_SHIFT
operator|)
operator||
operator|(
name|global_vf_num
operator|<<
name|I40E_QTX_CTL_VFVM_INDX_SHIFT
operator|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_QTX_CTL
argument_list|(
name|global_queue_num
argument_list|)
argument_list|,
name|qtx_ctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|ixl_pf_qmgr_mark_queue_configured
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|info
operator|->
name|queue_id
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ixl_vf_config_rx_queue
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|struct
name|i40e_virtchnl_rxq_info
modifier|*
name|info
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|i40e_hmc_obj_rxq
name|rxq
decl_stmt|;
name|uint16_t
name|global_queue_num
decl_stmt|;
name|enum
name|i40e_status_code
name|status
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|global_queue_num
operator|=
name|ixl_pf_qidx_from_vsi_qidx
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|info
operator|->
name|queue_id
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|rxq
argument_list|,
sizeof|sizeof
argument_list|(
name|rxq
argument_list|)
argument_list|)
expr_stmt|;
name|DDPRINTF
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: PF RX queue %d / VF RX queue %d\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|global_queue_num
argument_list|,
name|info
operator|->
name|queue_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|databuffer_size
operator|>
name|IXL_VF_MAX_BUFFER
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|info
operator|->
name|max_pkt_size
operator|>
name|IXL_VF_MAX_FRAME
operator|||
name|info
operator|->
name|max_pkt_size
operator|<
name|ETHER_MIN_LEN
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|info
operator|->
name|splithdr_enabled
condition|)
block|{
if|if
condition|(
name|info
operator|->
name|hdr_size
operator|>
name|IXL_VF_MAX_HDR_BUFFER
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|rxq
operator|.
name|hsplit_0
operator|=
name|info
operator|->
name|rx_split_pos
operator|&
operator|(
name|I40E_HMC_OBJ_RX_HSPLIT_0_SPLIT_L2
operator||
name|I40E_HMC_OBJ_RX_HSPLIT_0_SPLIT_IP
operator||
name|I40E_HMC_OBJ_RX_HSPLIT_0_SPLIT_TCP_UDP
operator||
name|I40E_HMC_OBJ_RX_HSPLIT_0_SPLIT_SCTP
operator|)
expr_stmt|;
name|rxq
operator|.
name|hbuff
operator|=
name|info
operator|->
name|hdr_size
operator|>>
name|I40E_RXQ_CTX_HBUFF_SHIFT
expr_stmt|;
name|rxq
operator|.
name|dtype
operator|=
literal|2
expr_stmt|;
block|}
name|status
operator|=
name|i40e_clear_lan_rx_queue_context
argument_list|(
name|hw
argument_list|,
name|global_queue_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|rxq
operator|.
name|base
operator|=
name|info
operator|->
name|dma_ring_addr
operator|/
name|IXL_RX_CTX_BASE_UNITS
expr_stmt|;
name|rxq
operator|.
name|qlen
operator|=
name|info
operator|->
name|ring_len
expr_stmt|;
name|rxq
operator|.
name|dbuff
operator|=
name|info
operator|->
name|databuffer_size
operator|>>
name|I40E_RXQ_CTX_DBUFF_SHIFT
expr_stmt|;
name|rxq
operator|.
name|dsize
operator|=
literal|1
expr_stmt|;
name|rxq
operator|.
name|crcstrip
operator|=
literal|1
expr_stmt|;
name|rxq
operator|.
name|l2tsel
operator|=
literal|1
expr_stmt|;
name|rxq
operator|.
name|rxmax
operator|=
name|info
operator|->
name|max_pkt_size
expr_stmt|;
name|rxq
operator|.
name|tphrdesc_ena
operator|=
literal|1
expr_stmt|;
name|rxq
operator|.
name|tphwdesc_ena
operator|=
literal|1
expr_stmt|;
name|rxq
operator|.
name|tphdata_ena
operator|=
literal|1
expr_stmt|;
name|rxq
operator|.
name|tphhead_ena
operator|=
literal|1
expr_stmt|;
name|rxq
operator|.
name|lrxqthresh
operator|=
literal|2
expr_stmt|;
name|rxq
operator|.
name|prefena
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|i40e_set_lan_rx_queue_context
argument_list|(
name|hw
argument_list|,
name|global_queue_num
argument_list|,
operator|&
name|rxq
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|ixl_pf_qmgr_mark_queue_configured
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|info
operator|->
name|queue_id
argument_list|,
name|false
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_config_vsi_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_vsi_queue_config_info
modifier|*
name|info
decl_stmt|;
name|struct
name|i40e_virtchnl_queue_pair_info
modifier|*
name|pair
decl_stmt|;
name|uint16_t
name|expected_msg_size
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|msg_size
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|info
operator|=
name|msg
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|num_queue_pairs
operator|==
literal|0
operator|||
name|info
operator|->
name|num_queue_pairs
operator|>
name|vf
operator|->
name|vsi
operator|.
name|num_queues
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: invalid # of qpairs (msg has %d, VSI has %d)\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|info
operator|->
name|num_queue_pairs
argument_list|,
name|vf
operator|->
name|vsi
operator|.
name|num_queues
argument_list|)
expr_stmt|;
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|expected_msg_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
operator|+
name|info
operator|->
name|num_queue_pairs
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|pair
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg_size
operator|!=
name|expected_msg_size
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: size of recvd message (%d) does not match expected size (%d)\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|msg_size
argument_list|,
name|expected_msg_size
argument_list|)
expr_stmt|;
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|info
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: VSI id in recvd message (%d) does not match expected id (%d)\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|info
operator|->
name|vsi_id
argument_list|,
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
argument_list|)
expr_stmt|;
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|info
operator|->
name|num_queue_pairs
condition|;
name|i
operator|++
control|)
block|{
name|pair
operator|=
operator|&
name|info
operator|->
name|qpair
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|pair
operator|->
name|txq
operator|.
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
operator|||
name|pair
operator|->
name|rxq
operator|.
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
operator|||
name|pair
operator|->
name|txq
operator|.
name|queue_id
operator|!=
name|pair
operator|->
name|rxq
operator|.
name|queue_id
operator|||
name|pair
operator|->
name|txq
operator|.
name|queue_id
operator|>=
name|vf
operator|->
name|vsi
operator|.
name|num_queues
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ixl_vf_config_tx_queue
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
operator|&
name|pair
operator|->
name|txq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ixl_vf_config_rx_queue
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
operator|&
name|pair
operator|->
name|rxq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_set_qctl
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
specifier|const
name|struct
name|i40e_virtchnl_vector_map
modifier|*
name|vector
parameter_list|,
name|enum
name|i40e_queue_type
name|cur_type
parameter_list|,
name|uint16_t
name|cur_queue
parameter_list|,
name|enum
name|i40e_queue_type
modifier|*
name|last_type
parameter_list|,
name|uint16_t
modifier|*
name|last_queue
parameter_list|)
block|{
name|uint32_t
name|offset
decl_stmt|,
name|qctl
decl_stmt|;
name|uint16_t
name|itr_indx
decl_stmt|;
if|if
condition|(
name|cur_type
operator|==
name|I40E_QUEUE_TYPE_RX
condition|)
block|{
name|offset
operator|=
name|I40E_QINT_RQCTL
argument_list|(
name|cur_queue
argument_list|)
expr_stmt|;
name|itr_indx
operator|=
name|vector
operator|->
name|rxitr_idx
expr_stmt|;
block|}
else|else
block|{
name|offset
operator|=
name|I40E_QINT_TQCTL
argument_list|(
name|cur_queue
argument_list|)
expr_stmt|;
name|itr_indx
operator|=
name|vector
operator|->
name|txitr_idx
expr_stmt|;
block|}
name|qctl
operator|=
name|htole32
argument_list|(
operator|(
name|vector
operator|->
name|vector_id
operator|<<
name|I40E_QINT_RQCTL_MSIX_INDX_SHIFT
operator|)
operator||
operator|(
operator|*
name|last_type
operator|<<
name|I40E_QINT_RQCTL_NEXTQ_TYPE_SHIFT
operator|)
operator||
operator|(
operator|*
name|last_queue
operator|<<
name|I40E_QINT_RQCTL_NEXTQ_INDX_SHIFT
operator|)
operator||
name|I40E_QINT_RQCTL_CAUSE_ENA_MASK
operator||
operator|(
name|itr_indx
operator|<<
name|I40E_QINT_RQCTL_ITR_INDX_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
operator|&
name|pf
operator|->
name|hw
argument_list|,
name|offset
argument_list|,
name|qctl
argument_list|)
expr_stmt|;
operator|*
name|last_type
operator|=
name|cur_type
expr_stmt|;
operator|*
name|last_queue
operator|=
name|cur_queue
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_config_vector
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
specifier|const
name|struct
name|i40e_virtchnl_vector_map
modifier|*
name|vector
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|u_int
name|qindex
decl_stmt|;
name|enum
name|i40e_queue_type
name|type
decl_stmt|,
name|last_type
decl_stmt|;
name|uint32_t
name|lnklst_reg
decl_stmt|;
name|uint16_t
name|rxq_map
decl_stmt|,
name|txq_map
decl_stmt|,
name|cur_queue
decl_stmt|,
name|last_queue
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|rxq_map
operator|=
name|vector
operator|->
name|rxq_map
expr_stmt|;
name|txq_map
operator|=
name|vector
operator|->
name|txq_map
expr_stmt|;
name|last_queue
operator|=
name|IXL_END_OF_INTR_LNKLST
expr_stmt|;
name|last_type
operator|=
name|I40E_QUEUE_TYPE_RX
expr_stmt|;
comment|/* 	 * The datasheet says to optimize performance, RX queues and TX queues 	 * should be interleaved in the interrupt linked list, so we process 	 * both at once here. 	 */
while|while
condition|(
operator|(
name|rxq_map
operator|!=
literal|0
operator|)
operator|||
operator|(
name|txq_map
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|txq_map
operator|!=
literal|0
condition|)
block|{
name|qindex
operator|=
name|ffs
argument_list|(
name|txq_map
argument_list|)
operator|-
literal|1
expr_stmt|;
name|type
operator|=
name|I40E_QUEUE_TYPE_TX
expr_stmt|;
name|cur_queue
operator|=
name|ixl_pf_qidx_from_vsi_qidx
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|qindex
argument_list|)
expr_stmt|;
name|ixl_vf_set_qctl
argument_list|(
name|pf
argument_list|,
name|vector
argument_list|,
name|type
argument_list|,
name|cur_queue
argument_list|,
operator|&
name|last_type
argument_list|,
operator|&
name|last_queue
argument_list|)
expr_stmt|;
name|txq_map
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|qindex
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|rxq_map
operator|!=
literal|0
condition|)
block|{
name|qindex
operator|=
name|ffs
argument_list|(
name|rxq_map
argument_list|)
operator|-
literal|1
expr_stmt|;
name|type
operator|=
name|I40E_QUEUE_TYPE_RX
expr_stmt|;
name|cur_queue
operator|=
name|ixl_pf_qidx_from_vsi_qidx
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|qindex
argument_list|)
expr_stmt|;
name|ixl_vf_set_qctl
argument_list|(
name|pf
argument_list|,
name|vector
argument_list|,
name|type
argument_list|,
name|cur_queue
argument_list|,
operator|&
name|last_type
argument_list|,
operator|&
name|last_queue
argument_list|)
expr_stmt|;
name|rxq_map
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|qindex
operator|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|vector
operator|->
name|vector_id
operator|==
literal|0
condition|)
name|lnklst_reg
operator|=
name|I40E_VPINT_LNKLST0
argument_list|(
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
else|else
name|lnklst_reg
operator|=
name|IXL_VPINT_LNKLSTN_REG
argument_list|(
name|hw
argument_list|,
name|vector
operator|->
name|vector_id
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|lnklst_reg
argument_list|,
operator|(
name|last_queue
operator|<<
name|I40E_VPINT_LNKLST0_FIRSTQ_INDX_SHIFT
operator|)
operator||
operator|(
name|last_type
operator|<<
name|I40E_VPINT_LNKLST0_FIRSTQ_TYPE_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_config_irq_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_irq_map_info
modifier|*
name|map
decl_stmt|;
name|struct
name|i40e_virtchnl_vector_map
modifier|*
name|vector
decl_stmt|;
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|int
name|i
decl_stmt|,
name|largest_txq
decl_stmt|,
name|largest_rxq
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
if|if
condition|(
name|msg_size
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|map
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|map
operator|=
name|msg
expr_stmt|;
if|if
condition|(
name|map
operator|->
name|num_vectors
operator|==
literal|0
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|msg_size
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|map
argument_list|)
operator|+
name|map
operator|->
name|num_vectors
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|vector
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|map
operator|->
name|num_vectors
condition|;
name|i
operator|++
control|)
block|{
name|vector
operator|=
operator|&
name|map
operator|->
name|vecmap
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|vector
operator|->
name|vector_id
operator|>=
name|hw
operator|->
name|func_caps
operator|.
name|num_msix_vectors_vf
operator|)
operator|||
name|vector
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|vector
operator|->
name|rxq_map
operator|!=
literal|0
condition|)
block|{
name|largest_rxq
operator|=
name|fls
argument_list|(
name|vector
operator|->
name|rxq_map
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|largest_rxq
operator|>=
name|vf
operator|->
name|vsi
operator|.
name|num_queues
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|vector
operator|->
name|txq_map
operator|!=
literal|0
condition|)
block|{
name|largest_txq
operator|=
name|fls
argument_list|(
name|vector
operator|->
name|txq_map
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|largest_txq
operator|>=
name|vf
operator|->
name|vsi
operator|.
name|num_queues
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|vector
operator|->
name|rxitr_idx
operator|>
name|IXL_MAX_ITR_IDX
operator|||
name|vector
operator|->
name|txitr_idx
operator|>
name|IXL_MAX_ITR_IDX
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|ixl_vf_config_vector
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|vector
argument_list|)
expr_stmt|;
block|}
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_enable_queues_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_queue_select
modifier|*
name|select
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|msg_size
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|select
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|select
operator|=
name|msg
expr_stmt|;
if|if
condition|(
name|select
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
operator|||
name|select
operator|->
name|rx_queues
operator|==
literal|0
operator|||
name|select
operator|->
name|tx_queues
operator|==
literal|0
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Enable TX rings selected by the VF */
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
literal|1
operator|<<
name|i
operator|)
operator|&
name|select
operator|->
name|tx_queues
condition|)
block|{
comment|/* Warn if queue is out of VF allocation range */
if|if
condition|(
name|i
operator|>=
name|vf
operator|->
name|vsi
operator|.
name|num_queues
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: TX ring %d is outside of VF VSI allocation!\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Skip this queue if it hasn't been configured */
if|if
condition|(
operator|!
name|ixl_pf_qmgr_is_queue_configured
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|true
argument_list|)
condition|)
continue|continue;
comment|/* Warn if this queue is already marked as enabled */
if|if
condition|(
name|ixl_pf_qmgr_is_queue_enabled
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|true
argument_list|)
condition|)
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: TX ring %d is already enabled!\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|error
operator|=
name|ixl_enable_tx_ring
argument_list|(
name|pf
argument_list|,
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
else|else
name|ixl_pf_qmgr_mark_queue_enabled
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Enable RX rings selected by the VF */
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
literal|1
operator|<<
name|i
operator|)
operator|&
name|select
operator|->
name|rx_queues
condition|)
block|{
comment|/* Warn if queue is out of VF allocation range */
if|if
condition|(
name|i
operator|>=
name|vf
operator|->
name|vsi
operator|.
name|num_queues
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: RX ring %d is outside of VF VSI allocation!\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Skip this queue if it hasn't been configured */
if|if
condition|(
operator|!
name|ixl_pf_qmgr_is_queue_configured
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|false
argument_list|)
condition|)
continue|continue;
comment|/* Warn if this queue is already marked as enabled */
if|if
condition|(
name|ixl_pf_qmgr_is_queue_enabled
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|false
argument_list|)
condition|)
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: RX ring %d is already enabled!\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|error
operator|=
name|ixl_enable_rx_ring
argument_list|(
name|pf
argument_list|,
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
else|else
name|ixl_pf_qmgr_mark_queue_enabled
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|error
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
argument_list|,
name|I40E_ERR_TIMEOUT
argument_list|)
expr_stmt|;
return|return;
block|}
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_disable_queues_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_queue_select
modifier|*
name|select
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|msg_size
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|select
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|select
operator|=
name|msg
expr_stmt|;
if|if
condition|(
name|select
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
operator|||
name|select
operator|->
name|rx_queues
operator|==
literal|0
operator|||
name|select
operator|->
name|tx_queues
operator|==
literal|0
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Disable TX rings selected by the VF */
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
literal|1
operator|<<
name|i
operator|)
operator|&
name|select
operator|->
name|tx_queues
condition|)
block|{
comment|/* Warn if queue is out of VF allocation range */
if|if
condition|(
name|i
operator|>=
name|vf
operator|->
name|vsi
operator|.
name|num_queues
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: TX ring %d is outside of VF VSI allocation!\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Skip this queue if it hasn't been configured */
if|if
condition|(
operator|!
name|ixl_pf_qmgr_is_queue_configured
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|true
argument_list|)
condition|)
continue|continue;
comment|/* Warn if this queue is already marked as disabled */
if|if
condition|(
operator|!
name|ixl_pf_qmgr_is_queue_enabled
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|true
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: TX ring %d is already disabled!\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|i
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|error
operator|=
name|ixl_disable_tx_ring
argument_list|(
name|pf
argument_list|,
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
else|else
name|ixl_pf_qmgr_mark_queue_disabled
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Enable RX rings selected by the VF */
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
literal|1
operator|<<
name|i
operator|)
operator|&
name|select
operator|->
name|rx_queues
condition|)
block|{
comment|/* Warn if queue is out of VF allocation range */
if|if
condition|(
name|i
operator|>=
name|vf
operator|->
name|vsi
operator|.
name|num_queues
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: RX ring %d is outside of VF VSI allocation!\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Skip this queue if it hasn't been configured */
if|if
condition|(
operator|!
name|ixl_pf_qmgr_is_queue_configured
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|false
argument_list|)
condition|)
continue|continue;
comment|/* Warn if this queue is already marked as disabled */
if|if
condition|(
operator|!
name|ixl_pf_qmgr_is_queue_enabled
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|false
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: RX ring %d is already disabled!\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|i
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|error
operator|=
name|ixl_disable_rx_ring
argument_list|(
name|pf
argument_list|,
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
else|else
name|ixl_pf_qmgr_mark_queue_disabled
argument_list|(
operator|&
name|vf
operator|->
name|qtag
argument_list|,
name|i
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|error
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
argument_list|,
name|I40E_ERR_TIMEOUT
argument_list|)
expr_stmt|;
return|return;
block|}
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ixl_zero_mac
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|uint8_t
name|zero
index|[
name|ETHER_ADDR_LEN
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
return|return
operator|(
name|cmp_etheraddr
argument_list|(
name|addr
argument_list|,
name|zero
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ixl_bcast_mac
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
return|return
operator|(
name|cmp_etheraddr
argument_list|(
name|addr
argument_list|,
name|ixl_bcast_addr
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ixl_vf_mac_valid
parameter_list|(
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|ixl_zero_mac
argument_list|(
name|addr
argument_list|)
operator|||
name|ixl_bcast_mac
argument_list|(
name|addr
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* 	 * If the VF is not allowed to change its MAC address, don't let it 	 * set a MAC filter for an address that is not a multicast address and 	 * is not its assigned MAC. 	 */
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|vf_flags
operator|&
name|VF_FLAG_SET_MAC_CAP
operator|)
operator|&&
operator|!
operator|(
name|ETHER_IS_MULTICAST
argument_list|(
name|addr
argument_list|)
operator|||
name|cmp_etheraddr
argument_list|(
name|addr
argument_list|,
name|vf
operator|->
name|mac
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_add_mac_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_ether_addr_list
modifier|*
name|addr_list
decl_stmt|;
name|struct
name|i40e_virtchnl_ether_addr
modifier|*
name|addr
decl_stmt|;
name|struct
name|ixl_vsi
modifier|*
name|vsi
decl_stmt|;
name|int
name|i
decl_stmt|;
name|size_t
name|expected_size
decl_stmt|;
name|vsi
operator|=
operator|&
name|vf
operator|->
name|vsi
expr_stmt|;
if|if
condition|(
name|msg_size
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|addr_list
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|addr_list
operator|=
name|msg
expr_stmt|;
name|expected_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|addr_list
argument_list|)
operator|+
name|addr_list
operator|->
name|num_elements
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr_list
operator|->
name|num_elements
operator|==
literal|0
operator|||
name|addr_list
operator|->
name|vsi_id
operator|!=
name|vsi
operator|->
name|vsi_num
operator|||
name|msg_size
operator|!=
name|expected_size
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addr_list
operator|->
name|num_elements
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ixl_vf_mac_valid
argument_list|(
name|vf
argument_list|,
name|addr_list
operator|->
name|list
index|[
name|i
index|]
operator|.
name|addr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addr_list
operator|->
name|num_elements
condition|;
name|i
operator|++
control|)
block|{
name|addr
operator|=
operator|&
name|addr_list
operator|->
name|list
index|[
name|i
index|]
expr_stmt|;
name|ixl_add_filter
argument_list|(
name|vsi
argument_list|,
name|addr
operator|->
name|addr
argument_list|,
name|IXL_VLAN_ANY
argument_list|)
expr_stmt|;
block|}
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_del_mac_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_ether_addr_list
modifier|*
name|addr_list
decl_stmt|;
name|struct
name|i40e_virtchnl_ether_addr
modifier|*
name|addr
decl_stmt|;
name|size_t
name|expected_size
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|msg_size
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|addr_list
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|addr_list
operator|=
name|msg
expr_stmt|;
name|expected_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|addr_list
argument_list|)
operator|+
name|addr_list
operator|->
name|num_elements
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr_list
operator|->
name|num_elements
operator|==
literal|0
operator|||
name|addr_list
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
operator|||
name|msg_size
operator|!=
name|expected_size
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addr_list
operator|->
name|num_elements
condition|;
name|i
operator|++
control|)
block|{
name|addr
operator|=
operator|&
name|addr_list
operator|->
name|list
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ixl_zero_mac
argument_list|(
name|addr
operator|->
name|addr
argument_list|)
operator|||
name|ixl_bcast_mac
argument_list|(
name|addr
operator|->
name|addr
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|addr_list
operator|->
name|num_elements
condition|;
name|i
operator|++
control|)
block|{
name|addr
operator|=
operator|&
name|addr_list
operator|->
name|list
index|[
name|i
index|]
expr_stmt|;
name|ixl_del_filter
argument_list|(
operator|&
name|vf
operator|->
name|vsi
argument_list|,
name|addr
operator|->
name|addr
argument_list|,
name|IXL_VLAN_ANY
argument_list|)
expr_stmt|;
block|}
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_DEL_ETHER_ADDRESS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|i40e_status_code
name|ixl_vf_enable_vlan_strip
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|i40e_vsi_context
name|vsi_ctx
decl_stmt|;
name|vsi_ctx
operator|.
name|seid
operator|=
name|vf
operator|->
name|vsi
operator|.
name|seid
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|vsi_ctx
operator|.
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|vsi_ctx
operator|.
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|valid_sections
operator|=
name|htole16
argument_list|(
name|I40E_AQ_VSI_PROP_VLAN_VALID
argument_list|)
expr_stmt|;
name|vsi_ctx
operator|.
name|info
operator|.
name|port_vlan_flags
operator|=
name|I40E_AQ_VSI_PVLAN_MODE_ALL
operator||
name|I40E_AQ_VSI_PVLAN_EMOD_STR_BOTH
expr_stmt|;
return|return
operator|(
name|i40e_aq_update_vsi_params
argument_list|(
operator|&
name|pf
operator|->
name|hw
argument_list|,
operator|&
name|vsi_ctx
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_add_vlan_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_vlan_filter_list
modifier|*
name|filter_list
decl_stmt|;
name|enum
name|i40e_status_code
name|code
decl_stmt|;
name|size_t
name|expected_size
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|msg_size
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|filter_list
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_VLAN
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|filter_list
operator|=
name|msg
expr_stmt|;
name|expected_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|filter_list
argument_list|)
operator|+
name|filter_list
operator|->
name|num_elements
operator|*
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|filter_list
operator|->
name|num_elements
operator|==
literal|0
operator|||
name|filter_list
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
operator|||
name|msg_size
operator|!=
name|expected_size
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_VLAN
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|vf_flags
operator|&
name|VF_FLAG_VLAN_CAP
operator|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_VLAN
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|filter_list
operator|->
name|num_elements
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|filter_list
operator|->
name|vlan_id
index|[
name|i
index|]
operator|>
name|EVL_VLID_MASK
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_VLAN
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|code
operator|=
name|ixl_vf_enable_vlan_strip
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|!=
name|I40E_SUCCESS
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_VLAN
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|filter_list
operator|->
name|num_elements
condition|;
name|i
operator|++
control|)
name|ixl_add_filter
argument_list|(
operator|&
name|vf
operator|->
name|vsi
argument_list|,
name|vf
operator|->
name|mac
argument_list|,
name|filter_list
operator|->
name|vlan_id
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_VLAN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_del_vlan_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_vlan_filter_list
modifier|*
name|filter_list
decl_stmt|;
name|int
name|i
decl_stmt|;
name|size_t
name|expected_size
decl_stmt|;
if|if
condition|(
name|msg_size
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|filter_list
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_DEL_VLAN
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|filter_list
operator|=
name|msg
expr_stmt|;
name|expected_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|filter_list
argument_list|)
operator|+
name|filter_list
operator|->
name|num_elements
operator|*
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|filter_list
operator|->
name|num_elements
operator|==
literal|0
operator|||
name|filter_list
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
operator|||
name|msg_size
operator|!=
name|expected_size
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_DEL_VLAN
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|filter_list
operator|->
name|num_elements
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|filter_list
operator|->
name|vlan_id
index|[
name|i
index|]
operator|>
name|EVL_VLID_MASK
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_VLAN
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|vf_flags
operator|&
name|VF_FLAG_VLAN_CAP
operator|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_ADD_VLAN
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|filter_list
operator|->
name|num_elements
condition|;
name|i
operator|++
control|)
name|ixl_del_filter
argument_list|(
operator|&
name|vf
operator|->
name|vsi
argument_list|,
name|vf
operator|->
name|mac
argument_list|,
name|filter_list
operator|->
name|vlan_id
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_DEL_VLAN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_config_promisc_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_promisc_info
modifier|*
name|info
decl_stmt|;
name|enum
name|i40e_status_code
name|code
decl_stmt|;
if|if
condition|(
name|msg_size
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|vf_flags
operator|&
name|VF_FLAG_PROMISC_CAP
operator|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|info
operator|=
name|msg
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|code
operator|=
name|i40e_aq_set_vsi_unicast_promiscuous
argument_list|(
operator|&
name|pf
operator|->
name|hw
argument_list|,
name|info
operator|->
name|vsi_id
argument_list|,
name|info
operator|->
name|flags
operator|&
name|I40E_FLAG_VF_UNICAST_PROMISC
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|!=
name|I40E_SUCCESS
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return;
block|}
name|code
operator|=
name|i40e_aq_set_vsi_multicast_promiscuous
argument_list|(
operator|&
name|pf
operator|->
name|hw
argument_list|,
name|info
operator|->
name|vsi_id
argument_list|,
name|info
operator|->
name|flags
operator|&
name|I40E_FLAG_VF_MULTICAST_PROMISC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|!=
name|I40E_SUCCESS
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return;
block|}
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_get_stats_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_virtchnl_queue_select
modifier|*
name|queue
decl_stmt|;
if|if
condition|(
name|msg_size
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|queue
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_GET_STATS
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|queue
operator|=
name|msg
expr_stmt|;
if|if
condition|(
name|queue
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_GET_STATS
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|ixl_update_eth_stats
argument_list|(
operator|&
name|vf
operator|->
name|vsi
argument_list|)
expr_stmt|;
name|ixl_send_vf_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_GET_STATS
argument_list|,
name|I40E_SUCCESS
argument_list|,
operator|&
name|vf
operator|->
name|vsi
operator|.
name|eth_stats
argument_list|,
sizeof|sizeof
argument_list|(
name|vf
operator|->
name|vsi
operator|.
name|eth_stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_config_rss_key_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|i40e_virtchnl_rss_key
modifier|*
name|key
decl_stmt|;
name|struct
name|i40e_aqc_get_set_rss_key_data
name|key_data
decl_stmt|;
name|enum
name|i40e_status_code
name|status
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
if|if
condition|(
name|msg_size
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|key
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_KEY
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|key
operator|=
name|msg
expr_stmt|;
if|if
condition|(
name|key
operator|->
name|key_len
operator|>
literal|52
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: Key size in msg (%d) is greater than max key size (%d)\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|key
operator|->
name|key_len
argument_list|,
literal|52
argument_list|)
expr_stmt|;
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_KEY
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|key
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: VSI id in recvd message (%d) does not match expected id (%d)\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|key
operator|->
name|vsi_id
argument_list|,
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
argument_list|)
expr_stmt|;
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_KEY
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Fill out hash using MAC-dependent method */
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
operator|==
name|I40E_MAC_X722
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|key_data
argument_list|,
sizeof|sizeof
argument_list|(
name|key_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|->
name|key_len
operator|<=
literal|40
condition|)
name|bcopy
argument_list|(
name|key
operator|->
name|key
argument_list|,
name|key_data
operator|.
name|standard_rss_key
argument_list|,
name|key
operator|->
name|key_len
argument_list|)
expr_stmt|;
else|else
block|{
name|bcopy
argument_list|(
name|key
operator|->
name|key
argument_list|,
name|key_data
operator|.
name|standard_rss_key
argument_list|,
literal|40
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|key
operator|->
name|key
index|[
literal|40
index|]
argument_list|,
name|key_data
operator|.
name|extended_hash_key
argument_list|,
name|key
operator|->
name|key_len
operator|-
literal|40
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|i40e_aq_set_rss_key
argument_list|(
name|hw
argument_list|,
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
argument_list|,
operator|&
name|key_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"i40e_aq_set_rss_key status %s, error %s\n"
argument_list|,
name|i40e_stat_str
argument_list|(
name|hw
argument_list|,
name|status
argument_list|)
argument_list|,
name|i40e_aq_str
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
argument_list|)
argument_list|)
expr_stmt|;
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_KEY
argument_list|,
name|I40E_ERR_ADMIN_QUEUE_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
operator|(
name|key
operator|->
name|key_len
operator|/
literal|4
operator|)
condition|;
name|i
operator|++
control|)
name|i40e_write_rx_ctl
argument_list|(
name|hw
argument_list|,
name|I40E_VFQF_HKEY1
argument_list|(
name|i
argument_list|,
name|IXL_GLOBAL_VF_NUM
argument_list|(
name|hw
argument_list|,
name|vf
argument_list|)
argument_list|)
argument_list|,
operator|(
operator|(
name|u32
operator|*
operator|)
name|key
operator|->
name|key
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|DDPRINTF
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: Programmed key starting with 0x%x ok!"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|key
operator|->
name|key
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_KEY
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_config_rss_lut_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|i40e_virtchnl_rss_lut
modifier|*
name|lut
decl_stmt|;
name|enum
name|i40e_status_code
name|status
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
if|if
condition|(
name|msg_size
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|lut
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_LUT
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|lut
operator|=
name|msg
expr_stmt|;
if|if
condition|(
name|lut
operator|->
name|lut_entries
operator|>
literal|64
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: # of LUT entries in msg (%d) is greater than max (%d)\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|lut
operator|->
name|lut_entries
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_LUT
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|lut
operator|->
name|vsi_id
operator|!=
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: VSI id in recvd message (%d) does not match expected id (%d)\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|lut
operator|->
name|vsi_id
argument_list|,
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
argument_list|)
expr_stmt|;
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_LUT
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Fill out LUT using MAC-dependent method */
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
operator|==
name|I40E_MAC_X722
condition|)
block|{
name|status
operator|=
name|i40e_aq_set_rss_lut
argument_list|(
name|hw
argument_list|,
name|vf
operator|->
name|vsi
operator|.
name|vsi_num
argument_list|,
name|false
argument_list|,
name|lut
operator|->
name|lut
argument_list|,
name|lut
operator|->
name|lut_entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"i40e_aq_set_rss_lut status %s, error %s\n"
argument_list|,
name|i40e_stat_str
argument_list|(
name|hw
argument_list|,
name|status
argument_list|)
argument_list|,
name|i40e_aq_str
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
argument_list|)
argument_list|)
expr_stmt|;
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_LUT
argument_list|,
name|I40E_ERR_ADMIN_QUEUE_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
operator|(
name|lut
operator|->
name|lut_entries
operator|/
literal|4
operator|)
condition|;
name|i
operator|++
control|)
name|i40e_write_rx_ctl
argument_list|(
name|hw
argument_list|,
name|I40E_VFQF_HLUT1
argument_list|(
name|i
argument_list|,
name|IXL_GLOBAL_VF_NUM
argument_list|(
name|hw
argument_list|,
name|vf
argument_list|)
argument_list|)
argument_list|,
operator|(
operator|(
name|u32
operator|*
operator|)
name|lut
operator|->
name|lut
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|DDPRINTF
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: Programmed LUT starting with 0x%x and length %d ok!"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|lut
operator|->
name|lut
index|[
literal|0
index|]
argument_list|,
name|lut
operator|->
name|lut_entries
argument_list|)
expr_stmt|;
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_CONFIG_RSS_LUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ixl_vf_set_rss_hena_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|uint16_t
name|msg_size
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|i40e_virtchnl_rss_hena
modifier|*
name|hena
decl_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
if|if
condition|(
name|msg_size
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hena
argument_list|)
condition|)
block|{
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_SET_RSS_HENA
argument_list|,
name|I40E_ERR_PARAM
argument_list|)
expr_stmt|;
return|return;
block|}
name|hena
operator|=
name|msg
expr_stmt|;
comment|/* Set HENA */
name|i40e_write_rx_ctl
argument_list|(
name|hw
argument_list|,
name|I40E_VFQF_HENA1
argument_list|(
literal|0
argument_list|,
name|IXL_GLOBAL_VF_NUM
argument_list|(
name|hw
argument_list|,
name|vf
argument_list|)
argument_list|)
argument_list|,
operator|(
name|u32
operator|)
name|hena
operator|->
name|hena
argument_list|)
expr_stmt|;
name|i40e_write_rx_ctl
argument_list|(
name|hw
argument_list|,
name|I40E_VFQF_HENA1
argument_list|(
literal|1
argument_list|,
name|IXL_GLOBAL_VF_NUM
argument_list|(
name|hw
argument_list|,
name|vf
argument_list|)
argument_list|)
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|hena
operator|->
name|hena
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|DDPRINTF
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"VF %d: Programmed HENA with 0x%016lx"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|hena
operator|->
name|hena
argument_list|)
expr_stmt|;
name|ixl_send_vf_ack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|I40E_VIRTCHNL_OP_SET_RSS_HENA
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ixl_handle_vf_msg
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|i40e_arq_event_info
modifier|*
name|event
parameter_list|)
block|{
name|struct
name|ixl_vf
modifier|*
name|vf
decl_stmt|;
name|void
modifier|*
name|msg
decl_stmt|;
name|uint16_t
name|vf_num
decl_stmt|,
name|msg_size
decl_stmt|;
name|uint32_t
name|opcode
decl_stmt|;
name|vf_num
operator|=
name|le16toh
argument_list|(
name|event
operator|->
name|desc
operator|.
name|retval
argument_list|)
operator|-
name|pf
operator|->
name|hw
operator|.
name|func_caps
operator|.
name|vf_base_id
expr_stmt|;
name|opcode
operator|=
name|le32toh
argument_list|(
name|event
operator|->
name|desc
operator|.
name|cookie_high
argument_list|)
expr_stmt|;
if|if
condition|(
name|vf_num
operator|>=
name|pf
operator|->
name|num_vfs
condition|)
block|{
name|device_printf
argument_list|(
name|pf
operator|->
name|dev
argument_list|,
literal|"Got msg from illegal VF: %d\n"
argument_list|,
name|vf_num
argument_list|)
expr_stmt|;
return|return;
block|}
name|vf
operator|=
operator|&
name|pf
operator|->
name|vfs
index|[
name|vf_num
index|]
expr_stmt|;
name|msg
operator|=
name|event
operator|->
name|msg_buf
expr_stmt|;
name|msg_size
operator|=
name|event
operator|->
name|msg_len
expr_stmt|;
name|I40E_VC_DEBUG
argument_list|(
name|pf
argument_list|,
name|ixl_vc_opcode_level
argument_list|(
name|opcode
argument_list|)
argument_list|,
literal|"Got msg %s(%d) from%sVF-%d of size %d\n"
argument_list|,
name|ixl_vc_opcode_str
argument_list|(
name|opcode
argument_list|)
argument_list|,
name|opcode
argument_list|,
operator|(
name|vf
operator|->
name|vf_flags
operator|&
name|VF_FLAG_ENABLED
operator|)
condition|?
literal|" "
else|:
literal|" disabled "
argument_list|,
name|vf_num
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
comment|/* This must be a stray msg from a previously destroyed VF. */
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|vf_flags
operator|&
name|VF_FLAG_ENABLED
operator|)
condition|)
return|return;
switch|switch
condition|(
name|opcode
condition|)
block|{
case|case
name|I40E_VIRTCHNL_OP_VERSION
case|:
name|ixl_vf_version_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_RESET_VF
case|:
name|ixl_vf_reset_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_GET_VF_RESOURCES
case|:
name|ixl_vf_get_resources_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_VSI_QUEUES
case|:
name|ixl_vf_config_vsi_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_IRQ_MAP
case|:
name|ixl_vf_config_irq_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ENABLE_QUEUES
case|:
name|ixl_vf_enable_queues_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_DISABLE_QUEUES
case|:
name|ixl_vf_disable_queues_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ADD_ETHER_ADDRESS
case|:
name|ixl_vf_add_mac_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_DEL_ETHER_ADDRESS
case|:
name|ixl_vf_del_mac_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_ADD_VLAN
case|:
name|ixl_vf_add_vlan_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_DEL_VLAN
case|:
name|ixl_vf_del_vlan_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_PROMISCUOUS_MODE
case|:
name|ixl_vf_config_promisc_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_GET_STATS
case|:
name|ixl_vf_get_stats_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_RSS_KEY
case|:
name|ixl_vf_config_rss_key_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_CONFIG_RSS_LUT
case|:
name|ixl_vf_config_rss_lut_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
case|case
name|I40E_VIRTCHNL_OP_SET_RSS_HENA
case|:
name|ixl_vf_set_rss_hena_msg
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
break|break;
comment|/* These two opcodes have been superseded by CONFIG_VSI_QUEUES. */
case|case
name|I40E_VIRTCHNL_OP_CONFIG_TX_QUEUE
case|:
case|case
name|I40E_VIRTCHNL_OP_CONFIG_RX_QUEUE
case|:
default|default:
name|i40e_send_vf_nack
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|opcode
argument_list|,
name|I40E_ERR_NOT_IMPLEMENTED
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Handle any VFs that have reset themselves via a Function Level Reset(FLR). */
end_comment

begin_function
name|void
name|ixl_handle_vflr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|ixl_pf
modifier|*
name|pf
decl_stmt|;
name|struct
name|ixl_vf
modifier|*
name|vf
decl_stmt|;
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|uint16_t
name|global_vf_num
decl_stmt|;
name|uint32_t
name|vflrstat_index
decl_stmt|,
name|vflrstat_mask
decl_stmt|,
name|vflrstat
decl_stmt|,
name|icr0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|pf
operator|=
name|arg
expr_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|IXL_PF_LOCK
argument_list|(
name|pf
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pf
operator|->
name|num_vfs
condition|;
name|i
operator|++
control|)
block|{
name|global_vf_num
operator|=
name|hw
operator|->
name|func_caps
operator|.
name|vf_base_id
operator|+
name|i
expr_stmt|;
name|vf
operator|=
operator|&
name|pf
operator|->
name|vfs
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|vf_flags
operator|&
name|VF_FLAG_ENABLED
operator|)
condition|)
continue|continue;
name|vflrstat_index
operator|=
name|IXL_GLGEN_VFLRSTAT_INDEX
argument_list|(
name|global_vf_num
argument_list|)
expr_stmt|;
name|vflrstat_mask
operator|=
name|IXL_GLGEN_VFLRSTAT_MASK
argument_list|(
name|global_vf_num
argument_list|)
expr_stmt|;
name|vflrstat
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|I40E_GLGEN_VFLRSTAT
argument_list|(
name|vflrstat_index
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflrstat
operator|&
name|vflrstat_mask
condition|)
block|{
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_GLGEN_VFLRSTAT
argument_list|(
name|vflrstat_index
argument_list|)
argument_list|,
name|vflrstat_mask
argument_list|)
expr_stmt|;
name|ixl_reinit_vf
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
block|}
block|}
name|icr0
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|I40E_PFINT_ICR0_ENA
argument_list|)
expr_stmt|;
name|icr0
operator||=
name|I40E_PFINT_ICR0_ENA_VFLR_MASK
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|I40E_PFINT_ICR0_ENA
argument_list|,
name|icr0
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|IXL_PF_UNLOCK
argument_list|(
name|pf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ixl_adminq_err_to_errno
parameter_list|(
name|enum
name|i40e_admin_queue_err
name|err
parameter_list|)
block|{
switch|switch
condition|(
name|err
condition|)
block|{
case|case
name|I40E_AQ_RC_EPERM
case|:
return|return
operator|(
name|EPERM
operator|)
return|;
case|case
name|I40E_AQ_RC_ENOENT
case|:
return|return
operator|(
name|ENOENT
operator|)
return|;
case|case
name|I40E_AQ_RC_ESRCH
case|:
return|return
operator|(
name|ESRCH
operator|)
return|;
case|case
name|I40E_AQ_RC_EINTR
case|:
return|return
operator|(
name|EINTR
operator|)
return|;
case|case
name|I40E_AQ_RC_EIO
case|:
return|return
operator|(
name|EIO
operator|)
return|;
case|case
name|I40E_AQ_RC_ENXIO
case|:
return|return
operator|(
name|ENXIO
operator|)
return|;
case|case
name|I40E_AQ_RC_E2BIG
case|:
return|return
operator|(
name|E2BIG
operator|)
return|;
case|case
name|I40E_AQ_RC_EAGAIN
case|:
return|return
operator|(
name|EAGAIN
operator|)
return|;
case|case
name|I40E_AQ_RC_ENOMEM
case|:
return|return
operator|(
name|ENOMEM
operator|)
return|;
case|case
name|I40E_AQ_RC_EACCES
case|:
return|return
operator|(
name|EACCES
operator|)
return|;
case|case
name|I40E_AQ_RC_EFAULT
case|:
return|return
operator|(
name|EFAULT
operator|)
return|;
case|case
name|I40E_AQ_RC_EBUSY
case|:
return|return
operator|(
name|EBUSY
operator|)
return|;
case|case
name|I40E_AQ_RC_EEXIST
case|:
return|return
operator|(
name|EEXIST
operator|)
return|;
case|case
name|I40E_AQ_RC_EINVAL
case|:
return|return
operator|(
name|EINVAL
operator|)
return|;
case|case
name|I40E_AQ_RC_ENOTTY
case|:
return|return
operator|(
name|ENOTTY
operator|)
return|;
case|case
name|I40E_AQ_RC_ENOSPC
case|:
return|return
operator|(
name|ENOSPC
operator|)
return|;
case|case
name|I40E_AQ_RC_ENOSYS
case|:
return|return
operator|(
name|ENOSYS
operator|)
return|;
case|case
name|I40E_AQ_RC_ERANGE
case|:
return|return
operator|(
name|ERANGE
operator|)
return|;
case|case
name|I40E_AQ_RC_EFLUSHED
case|:
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* No exact equivalent in errno.h */
case|case
name|I40E_AQ_RC_BAD_ADDR
case|:
return|return
operator|(
name|EFAULT
operator|)
return|;
case|case
name|I40E_AQ_RC_EMODE
case|:
return|return
operator|(
name|EPERM
operator|)
return|;
case|case
name|I40E_AQ_RC_EFBIG
case|:
return|return
operator|(
name|EFBIG
operator|)
return|;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
end_function

begin_function
name|int
name|ixl_iov_init
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint16_t
name|num_vfs
parameter_list|,
specifier|const
name|nvlist_t
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ixl_pf
modifier|*
name|pf
decl_stmt|;
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|ixl_vsi
modifier|*
name|pf_vsi
decl_stmt|;
name|enum
name|i40e_status_code
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|pf
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|pf_vsi
operator|=
operator|&
name|pf
operator|->
name|vsi
expr_stmt|;
name|IXL_PF_LOCK
argument_list|(
name|pf
argument_list|)
expr_stmt|;
name|pf
operator|->
name|vfs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ixl_vf
argument_list|)
operator|*
name|num_vfs
argument_list|,
name|M_IXL
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|pf
operator|->
name|vfs
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_vfs
condition|;
name|i
operator|++
control|)
name|sysctl_ctx_init
argument_list|(
operator|&
name|pf
operator|->
name|vfs
index|[
name|i
index|]
operator|.
name|ctx
argument_list|)
expr_stmt|;
name|ret
operator|=
name|i40e_aq_add_veb
argument_list|(
name|hw
argument_list|,
name|pf_vsi
operator|->
name|uplink_seid
argument_list|,
name|pf_vsi
operator|->
name|seid
argument_list|,
literal|1
argument_list|,
name|FALSE
argument_list|,
operator|&
name|pf
operator|->
name|veb_seid
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|I40E_SUCCESS
condition|)
block|{
name|error
operator|=
name|ixl_adminq_err_to_errno
argument_list|(
name|hw
operator|->
name|aq
operator|.
name|asq_last_status
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"add_veb failed; code=%d error=%d"
argument_list|,
name|ret
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|pf
operator|->
name|num_vfs
operator|=
name|num_vfs
expr_stmt|;
name|IXL_PF_UNLOCK
argument_list|(
name|pf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|free
argument_list|(
name|pf
operator|->
name|vfs
argument_list|,
name|M_IXL
argument_list|)
expr_stmt|;
name|pf
operator|->
name|vfs
operator|=
name|NULL
expr_stmt|;
name|IXL_PF_UNLOCK
argument_list|(
name|pf
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ixl_iov_uninit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ixl_pf
modifier|*
name|pf
decl_stmt|;
name|struct
name|i40e_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|ixl_vsi
modifier|*
name|vsi
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ixl_vf
modifier|*
name|vfs
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_vfs
decl_stmt|;
name|pf
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|hw
operator|=
operator|&
name|pf
operator|->
name|hw
expr_stmt|;
name|vsi
operator|=
operator|&
name|pf
operator|->
name|vsi
expr_stmt|;
name|ifp
operator|=
name|vsi
operator|->
name|ifp
expr_stmt|;
name|IXL_PF_LOCK
argument_list|(
name|pf
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pf
operator|->
name|num_vfs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pf
operator|->
name|vfs
index|[
name|i
index|]
operator|.
name|vsi
operator|.
name|seid
operator|!=
literal|0
condition|)
name|i40e_aq_delete_element
argument_list|(
name|hw
argument_list|,
name|pf
operator|->
name|vfs
index|[
name|i
index|]
operator|.
name|vsi
operator|.
name|seid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ixl_pf_qmgr_release
argument_list|(
operator|&
name|pf
operator|->
name|qmgr
argument_list|,
operator|&
name|pf
operator|->
name|vfs
index|[
name|i
index|]
operator|.
name|qtag
argument_list|)
expr_stmt|;
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"VF %d: %d released\n"
argument_list|,
name|i
argument_list|,
name|pf
operator|->
name|vfs
index|[
name|i
index|]
operator|.
name|qtag
operator|.
name|num_allocated
argument_list|)
expr_stmt|;
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"Unallocated total: %d\n"
argument_list|,
name|ixl_pf_qmgr_get_num_free
argument_list|(
operator|&
name|pf
operator|->
name|qmgr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pf
operator|->
name|veb_seid
operator|!=
literal|0
condition|)
block|{
name|i40e_aq_delete_element
argument_list|(
name|hw
argument_list|,
name|pf
operator|->
name|veb_seid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pf
operator|->
name|veb_seid
operator|=
literal|0
expr_stmt|;
block|}
name|vfs
operator|=
name|pf
operator|->
name|vfs
expr_stmt|;
name|num_vfs
operator|=
name|pf
operator|->
name|num_vfs
expr_stmt|;
name|pf
operator|->
name|vfs
operator|=
name|NULL
expr_stmt|;
name|pf
operator|->
name|num_vfs
operator|=
literal|0
expr_stmt|;
name|IXL_PF_UNLOCK
argument_list|(
name|pf
argument_list|)
expr_stmt|;
comment|/* Do this after the unlock as sysctl_ctx_free might sleep. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_vfs
condition|;
name|i
operator|++
control|)
name|sysctl_ctx_free
argument_list|(
operator|&
name|vfs
index|[
name|i
index|]
operator|.
name|ctx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vfs
argument_list|,
name|M_IXL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ixl_vf_reserve_queues
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|struct
name|ixl_vf
modifier|*
name|vf
parameter_list|,
name|int
name|num_queues
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|pf
operator|->
name|dev
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Validate, and clamp value if invalid */
if|if
condition|(
name|num_queues
operator|<
literal|1
operator|||
name|num_queues
operator|>
literal|16
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Invalid num-queues (%d) for VF %d\n"
argument_list|,
name|num_queues
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_queues
operator|<
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Setting VF %d num-queues to 1\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
name|num_queues
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|num_queues
operator|>
literal|16
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Setting VF %d num-queues to 16\n"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
name|num_queues
operator|=
literal|16
expr_stmt|;
block|}
name|error
operator|=
name|ixl_pf_qmgr_alloc_scattered
argument_list|(
operator|&
name|pf
operator|->
name|qmgr
argument_list|,
name|num_queues
argument_list|,
operator|&
name|vf
operator|->
name|qtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Error allocating %d queues for VF %d's VSI\n"
argument_list|,
name|num_queues
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOSPC
operator|)
return|;
block|}
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"VF %d: %d allocated, %d active"
argument_list|,
name|vf
operator|->
name|vf_num
argument_list|,
name|vf
operator|->
name|qtag
operator|.
name|num_allocated
argument_list|,
name|vf
operator|->
name|qtag
operator|.
name|num_active
argument_list|)
expr_stmt|;
name|DDPRINTF
argument_list|(
name|dev
argument_list|,
literal|"Unallocated total: %d"
argument_list|,
name|ixl_pf_qmgr_get_num_free
argument_list|(
operator|&
name|pf
operator|->
name|qmgr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ixl_add_vf
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint16_t
name|vfnum
parameter_list|,
specifier|const
name|nvlist_t
modifier|*
name|params
parameter_list|)
block|{
name|char
name|sysctl_name
index|[
name|QUEUE_NAME_LEN
index|]
decl_stmt|;
name|struct
name|ixl_pf
modifier|*
name|pf
decl_stmt|;
name|struct
name|ixl_vf
modifier|*
name|vf
decl_stmt|;
specifier|const
name|void
modifier|*
name|mac
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|vf_num_queues
decl_stmt|;
name|pf
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|vf
operator|=
operator|&
name|pf
operator|->
name|vfs
index|[
name|vfnum
index|]
expr_stmt|;
name|IXL_PF_LOCK
argument_list|(
name|pf
argument_list|)
expr_stmt|;
name|vf
operator|->
name|vf_num
operator|=
name|vfnum
expr_stmt|;
name|vf
operator|->
name|vsi
operator|.
name|back
operator|=
name|pf
expr_stmt|;
name|vf
operator|->
name|vf_flags
operator|=
name|VF_FLAG_ENABLED
expr_stmt|;
name|SLIST_INIT
argument_list|(
operator|&
name|vf
operator|->
name|vsi
operator|.
name|ftl
argument_list|)
expr_stmt|;
comment|/* Reserve queue allocation from PF */
name|vf_num_queues
operator|=
name|nvlist_get_number
argument_list|(
name|params
argument_list|,
literal|"num-queues"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ixl_vf_reserve_queues
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|,
name|vf_num_queues
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|error
operator|=
name|ixl_vf_setup_vsi
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|nvlist_exists_binary
argument_list|(
name|params
argument_list|,
literal|"mac-addr"
argument_list|)
condition|)
block|{
name|mac
operator|=
name|nvlist_get_binary
argument_list|(
name|params
argument_list|,
literal|"mac-addr"
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|mac
argument_list|,
name|vf
operator|->
name|mac
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvlist_get_bool
argument_list|(
name|params
argument_list|,
literal|"allow-set-mac"
argument_list|)
condition|)
name|vf
operator|->
name|vf_flags
operator||=
name|VF_FLAG_SET_MAC_CAP
expr_stmt|;
block|}
else|else
comment|/* 		 * If the administrator has not specified a MAC address then 		 * we must allow the VF to choose one. 		 */
name|vf
operator|->
name|vf_flags
operator||=
name|VF_FLAG_SET_MAC_CAP
expr_stmt|;
if|if
condition|(
name|nvlist_get_bool
argument_list|(
name|params
argument_list|,
literal|"mac-anti-spoof"
argument_list|)
condition|)
name|vf
operator|->
name|vf_flags
operator||=
name|VF_FLAG_MAC_ANTI_SPOOF
expr_stmt|;
if|if
condition|(
name|nvlist_get_bool
argument_list|(
name|params
argument_list|,
literal|"allow-promisc"
argument_list|)
condition|)
name|vf
operator|->
name|vf_flags
operator||=
name|VF_FLAG_PROMISC_CAP
expr_stmt|;
name|vf
operator|->
name|vf_flags
operator||=
name|VF_FLAG_VLAN_CAP
expr_stmt|;
name|ixl_reset_vf
argument_list|(
name|pf
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|out
label|:
name|IXL_PF_UNLOCK
argument_list|(
name|pf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|sysctl_name
argument_list|,
sizeof|sizeof
argument_list|(
name|sysctl_name
argument_list|)
argument_list|,
literal|"vf%d"
argument_list|,
name|vfnum
argument_list|)
expr_stmt|;
name|ixl_add_vsi_sysctls
argument_list|(
name|pf
argument_list|,
operator|&
name|vf
operator|->
name|vsi
argument_list|,
operator|&
name|vf
operator|->
name|ctx
argument_list|,
name|sysctl_name
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

end_unit


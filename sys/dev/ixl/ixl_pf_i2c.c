begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2013-2015, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"ixl_pf.h"
end_include

begin_define
define|#
directive|define
name|IXL_I2C_T_RISE
value|1
end_define

begin_define
define|#
directive|define
name|IXL_I2C_T_FALL
value|1
end_define

begin_define
define|#
directive|define
name|IXL_I2C_T_SU_DATA
value|1
end_define

begin_define
define|#
directive|define
name|IXL_I2C_T_SU_STA
value|5
end_define

begin_define
define|#
directive|define
name|IXL_I2C_T_SU_STO
value|4
end_define

begin_define
define|#
directive|define
name|IXL_I2C_T_HD_STA
value|4
end_define

begin_define
define|#
directive|define
name|IXL_I2C_T_LOW
value|5
end_define

begin_define
define|#
directive|define
name|IXL_I2C_T_HIGH
value|4
end_define

begin_define
define|#
directive|define
name|IXL_I2C_T_BUF
value|5
end_define

begin_define
define|#
directive|define
name|IXL_I2C_CLOCK_STRETCHING_TIMEOUT
value|500
end_define

begin_define
define|#
directive|define
name|IXL_I2C_REG
parameter_list|(
name|_hw
parameter_list|)
define|\
value|I40E_GLGEN_I2CPARAMS(((struct i40e_osdep *)(_hw)->back)->i2c_intfc_num)
end_define

begin_function_decl
specifier|static
name|s32
name|ixl_set_i2c_data
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u32
modifier|*
name|i2cctl
parameter_list|,
name|bool
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|ixl_get_i2c_data
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u32
modifier|*
name|i2cctl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_raise_i2c_clk
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u32
modifier|*
name|i2cctl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_lower_i2c_clk
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u32
modifier|*
name|i2cctl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixl_clock_out_i2c_bit
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|bool
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixl_get_i2c_ack
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixl_clock_out_i2c_byte
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u8
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixl_clock_in_i2c_bit
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|bool
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixl_clock_in_i2c_byte
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_i2c_bus_clear
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_i2c_start
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ixl_i2c_stop
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**  *  ixl_i2c_bus_clear - Clears the I2C bus  *  @hw: pointer to hardware structure  *  *  Clears the I2C bus by sending nine clock pulses.  *  Used when data line is stuck low.  **/
end_comment

begin_function
specifier|static
name|void
name|ixl_i2c_bus_clear
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|u32
name|i2cctl
init|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixl_i2c_bus_clear"
argument_list|)
expr_stmt|;
name|ixl_i2c_start
argument_list|(
name|pf
argument_list|)
expr_stmt|;
name|ixl_set_i2c_data
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
block|{
name|ixl_raise_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Min high period of clock is 4us */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_HIGH
argument_list|)
expr_stmt|;
name|ixl_lower_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Min low period of clock is 4.7us*/
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_LOW
argument_list|)
expr_stmt|;
block|}
name|ixl_i2c_start
argument_list|(
name|pf
argument_list|)
expr_stmt|;
comment|/* Put the i2c bus back to default state */
name|ixl_i2c_stop
argument_list|(
name|pf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  ixl_i2c_stop - Sets I2C stop condition  *  @hw: pointer to hardware structure  *  *  Sets I2C stop condition (Low -> High on SDA while SCL is High)  **/
end_comment

begin_function
specifier|static
name|void
name|ixl_i2c_stop
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|u32
name|i2cctl
init|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixl_i2c_stop"
argument_list|)
expr_stmt|;
comment|/* Stop condition must begin with data low and clock high */
name|ixl_set_i2c_data
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ixl_raise_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Setup time for stop condition (4us) */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_SU_STO
argument_list|)
expr_stmt|;
name|ixl_set_i2c_data
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* bus free time between stop and start (4.7us)*/
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_BUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  ixl_clock_in_i2c_byte - Clocks in one byte via I2C  *  @hw: pointer to hardware structure  *  @data: data byte to clock in  *  *  Clocks in one byte data via I2C data/clock  **/
end_comment

begin_function
specifier|static
name|s32
name|ixl_clock_in_i2c_byte
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|)
block|{
name|s32
name|i
decl_stmt|;
name|bool
name|bit
init|=
literal|0
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixl_clock_in_i2c_byte"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|7
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|ixl_clock_in_i2c_bit
argument_list|(
name|pf
argument_list|,
operator|&
name|bit
argument_list|)
expr_stmt|;
operator|*
name|data
operator||=
name|bit
operator|<<
name|i
expr_stmt|;
block|}
return|return
name|I40E_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixl_clock_in_i2c_bit - Clocks in one bit via I2C data/clock  *  @hw: pointer to hardware structure  *  @data: read data value  *  *  Clocks in one bit via I2C data/clock  **/
end_comment

begin_function
specifier|static
name|s32
name|ixl_clock_in_i2c_bit
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|bool
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|u32
name|i2cctl
init|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixl_clock_in_i2c_bit"
argument_list|)
expr_stmt|;
name|ixl_raise_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Minimum high period of clock is 4us */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_HIGH
argument_list|)
expr_stmt|;
name|i2cctl
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
expr_stmt|;
name|i2cctl
operator||=
name|I40E_GLGEN_I2CPARAMS_DATA_OE_N_MASK
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|,
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|i2cctl
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|data
operator|=
name|ixl_get_i2c_data
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_lower_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Minimum low period of clock is 4.7 us */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_LOW
argument_list|)
expr_stmt|;
return|return
name|I40E_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixl_get_i2c_ack - Polls for I2C ACK  *  @hw: pointer to hardware structure  *  *  Clocks in/out one bit via I2C data/clock  **/
end_comment

begin_function
specifier|static
name|s32
name|ixl_get_i2c_ack
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|s32
name|status
init|=
name|I40E_SUCCESS
decl_stmt|;
name|u32
name|i
init|=
literal|0
decl_stmt|;
name|u32
name|i2cctl
init|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
decl_stmt|;
name|u32
name|timeout
init|=
literal|10
decl_stmt|;
name|bool
name|ack
init|=
literal|1
decl_stmt|;
name|ixl_raise_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Minimum high period of clock is 4us */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_HIGH
argument_list|)
expr_stmt|;
name|i2cctl
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
expr_stmt|;
name|i2cctl
operator||=
name|I40E_GLGEN_I2CPARAMS_DATA_OE_N_MASK
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|,
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Poll for ACK.  Note that ACK in I2C spec is 	 * transition from 1 to 0 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|timeout
condition|;
name|i
operator|++
control|)
block|{
name|i2cctl
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
expr_stmt|;
name|ack
operator|=
name|ixl_get_i2c_data
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
name|i40e_usec_delay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ack
condition|)
break|break;
block|}
if|if
condition|(
name|ack
condition|)
block|{
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"I2C ack was not received.\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|I40E_ERR_PHY
expr_stmt|;
block|}
name|ixl_lower_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Minimum low period of clock is 4.7 us */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_LOW
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixl_clock_out_i2c_bit - Clocks in/out one bit via I2C data/clock  *  @hw: pointer to hardware structure  *  @data: data value to write  *  *  Clocks out one bit via I2C data/clock  **/
end_comment

begin_function
specifier|static
name|s32
name|ixl_clock_out_i2c_bit
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|bool
name|data
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|s32
name|status
decl_stmt|;
name|u32
name|i2cctl
init|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
decl_stmt|;
name|status
operator|=
name|ixl_set_i2c_data
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|I40E_SUCCESS
condition|)
block|{
name|ixl_raise_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Minimum high period of clock is 4us */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_HIGH
argument_list|)
expr_stmt|;
name|ixl_lower_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Minimum low period of clock is 4.7 us. 		 * This also takes care of the data hold time. 		 */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_LOW
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|I40E_ERR_PHY
expr_stmt|;
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"I2C data was not set to %#x\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixl_clock_out_i2c_byte - Clocks out one byte via I2C  *  @hw: pointer to hardware structure  *  @data: data byte clocked out  *  *  Clocks out one byte data via I2C data/clock  **/
end_comment

begin_function
specifier|static
name|s32
name|ixl_clock_out_i2c_byte
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u8
name|data
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|s32
name|status
init|=
name|I40E_SUCCESS
decl_stmt|;
name|s32
name|i
decl_stmt|;
name|u32
name|i2cctl
decl_stmt|;
name|bool
name|bit
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixl_clock_out_i2c_byte"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|7
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|bit
operator|=
operator|(
name|data
operator|>>
name|i
operator|)
operator|&
literal|0x1
expr_stmt|;
name|status
operator|=
name|ixl_clock_out_i2c_bit
argument_list|(
name|pf
argument_list|,
name|bit
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
break|break;
block|}
comment|/* Release SDA line (set high) */
name|i2cctl
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
expr_stmt|;
name|i2cctl
operator||=
name|I40E_GLGEN_I2CPARAMS_DATA_OUT_MASK
expr_stmt|;
name|i2cctl
operator|&=
operator|~
operator|(
name|I40E_GLGEN_I2CPARAMS_DATA_OE_N_MASK
operator|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|,
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixl_lower_i2c_clk - Lowers the I2C SCL clock  *  @hw: pointer to hardware structure  *  @i2cctl: Current value of I2CCTL register  *  *  Lowers the I2C clock line '1'->'0'  **/
end_comment

begin_function
specifier|static
name|void
name|ixl_lower_i2c_clk
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u32
modifier|*
name|i2cctl
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
operator|*
name|i2cctl
operator|&=
operator|~
operator|(
name|I40E_GLGEN_I2CPARAMS_CLK_MASK
operator|)
expr_stmt|;
operator|*
name|i2cctl
operator|&=
operator|~
operator|(
name|I40E_GLGEN_I2CPARAMS_CLK_OE_N_MASK
operator|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|,
operator|*
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* SCL fall time (300ns) */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_FALL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  ixl_raise_i2c_clk - Raises the I2C SCL clock  *  @hw: pointer to hardware structure  *  @i2cctl: Current value of I2CCTL register  *  *  Raises the I2C clock line '0'->'1'  **/
end_comment

begin_function
specifier|static
name|void
name|ixl_raise_i2c_clk
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u32
modifier|*
name|i2cctl
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|u32
name|i
init|=
literal|0
decl_stmt|;
name|u32
name|timeout
init|=
name|IXL_I2C_CLOCK_STRETCHING_TIMEOUT
decl_stmt|;
name|u32
name|i2cctl_r
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|timeout
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|i2cctl
operator||=
name|I40E_GLGEN_I2CPARAMS_CLK_MASK
expr_stmt|;
operator|*
name|i2cctl
operator|&=
operator|~
operator|(
name|I40E_GLGEN_I2CPARAMS_CLK_OE_N_MASK
operator|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|,
operator|*
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* SCL rise time (1000ns) */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_RISE
argument_list|)
expr_stmt|;
name|i2cctl_r
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2cctl_r
operator|&
name|I40E_GLGEN_I2CPARAMS_CLK_IN_MASK
condition|)
break|break;
block|}
block|}
end_function

begin_comment
comment|/**  *  ixl_get_i2c_data - Reads the I2C SDA data bit  *  @hw: pointer to hardware structure  *  @i2cctl: Current value of I2CCTL register  *  *  Returns the I2C data bit value  **/
end_comment

begin_function
specifier|static
name|bool
name|ixl_get_i2c_data
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u32
modifier|*
name|i2cctl
parameter_list|)
block|{
name|bool
name|data
decl_stmt|;
if|if
condition|(
operator|*
name|i2cctl
operator|&
name|I40E_GLGEN_I2CPARAMS_DATA_IN_MASK
condition|)
name|data
operator|=
literal|1
expr_stmt|;
else|else
name|data
operator|=
literal|0
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_comment
comment|/**  *  ixl_set_i2c_data - Sets the I2C data bit  *  @hw: pointer to hardware structure  *  @i2cctl: Current value of I2CCTL register  *  @data: I2C data value (0 or 1) to set  *  *  Sets the I2C data bit  **/
end_comment

begin_function
specifier|static
name|s32
name|ixl_set_i2c_data
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u32
modifier|*
name|i2cctl
parameter_list|,
name|bool
name|data
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|s32
name|status
init|=
name|I40E_SUCCESS
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixl_set_i2c_data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
operator|*
name|i2cctl
operator||=
name|I40E_GLGEN_I2CPARAMS_DATA_OUT_MASK
expr_stmt|;
else|else
operator|*
name|i2cctl
operator|&=
operator|~
operator|(
name|I40E_GLGEN_I2CPARAMS_DATA_OUT_MASK
operator|)
expr_stmt|;
operator|*
name|i2cctl
operator|&=
operator|~
operator|(
name|I40E_GLGEN_I2CPARAMS_DATA_OE_N_MASK
operator|)
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|,
operator|*
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Data rise/fall (1000ns/300ns) and set-up time (250ns) */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_RISE
operator|+
name|IXL_I2C_T_FALL
operator|+
name|IXL_I2C_T_SU_DATA
argument_list|)
expr_stmt|;
comment|/* Verify data was set correctly */
operator|*
name|i2cctl
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|ixl_get_i2c_data
argument_list|(
name|pf
argument_list|,
name|i2cctl
argument_list|)
condition|)
block|{
name|status
operator|=
name|I40E_ERR_PHY
expr_stmt|;
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"Error - I2C data was not set to %X.\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixl_i2c_start - Sets I2C start condition  *  Sets I2C start condition (High -> Low on SDA while SCL is High)  **/
end_comment

begin_function
specifier|static
name|void
name|ixl_i2c_start
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|u32
name|i2cctl
init|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixl_i2c_start"
argument_list|)
expr_stmt|;
comment|/* Start condition must begin with data and clock high */
name|ixl_set_i2c_data
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ixl_raise_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Setup time for start condition (4.7us) */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_SU_STA
argument_list|)
expr_stmt|;
name|ixl_set_i2c_data
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Hold time for start condition (4us) */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_HD_STA
argument_list|)
expr_stmt|;
name|ixl_lower_i2c_clk
argument_list|(
name|pf
argument_list|,
operator|&
name|i2cctl
argument_list|)
expr_stmt|;
comment|/* Minimum low period of clock is 4.7 us */
name|i40e_usec_delay
argument_list|(
name|IXL_I2C_T_LOW
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  ixl_read_i2c_byte - Reads 8 bit word over I2C  **/
end_comment

begin_function
name|s32
name|ixl_read_i2c_byte
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u8
name|byte_offset
parameter_list|,
name|u8
name|dev_addr
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|u32
name|max_retry
init|=
literal|10
decl_stmt|;
name|u32
name|retry
init|=
literal|0
decl_stmt|;
name|bool
name|nack
init|=
literal|1
decl_stmt|;
name|s32
name|status
decl_stmt|;
operator|*
name|data
operator|=
literal|0
expr_stmt|;
name|u32
name|i2cctl
init|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
decl_stmt|;
name|i2cctl
operator||=
name|I40E_GLGEN_I2CPARAMS_I2CBB_EN_MASK
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|,
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
do|do
block|{
name|ixl_i2c_start
argument_list|(
name|pf
argument_list|)
expr_stmt|;
comment|/* Device Address and write indication */
name|status
operator|=
name|ixl_clock_out_i2c_byte
argument_list|(
name|pf
argument_list|,
name|dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
block|{
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"dev_addr clock out error\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|status
operator|=
name|ixl_get_i2c_ack
argument_list|(
name|pf
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
block|{
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"dev_addr i2c ack error\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|status
operator|=
name|ixl_clock_out_i2c_byte
argument_list|(
name|pf
argument_list|,
name|byte_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
block|{
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"byte_offset clock out error\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|status
operator|=
name|ixl_get_i2c_ack
argument_list|(
name|pf
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
block|{
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"byte_offset i2c ack error\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ixl_i2c_start
argument_list|(
name|pf
argument_list|)
expr_stmt|;
comment|/* Device Address and read indication */
name|status
operator|=
name|ixl_clock_out_i2c_byte
argument_list|(
name|pf
argument_list|,
operator|(
name|dev_addr
operator||
literal|0x1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|status
operator|=
name|ixl_get_i2c_ack
argument_list|(
name|pf
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|status
operator|=
name|ixl_clock_in_i2c_byte
argument_list|(
name|pf
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|status
operator|=
name|ixl_clock_out_i2c_bit
argument_list|(
name|pf
argument_list|,
name|nack
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|ixl_i2c_stop
argument_list|(
name|pf
argument_list|)
expr_stmt|;
name|status
operator|=
name|I40E_SUCCESS
expr_stmt|;
goto|goto
name|done
goto|;
name|fail
label|:
name|ixl_i2c_bus_clear
argument_list|(
name|pf
argument_list|)
expr_stmt|;
name|i40e_msec_delay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|retry
operator|++
expr_stmt|;
if|if
condition|(
name|retry
operator|<
name|max_retry
condition|)
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"I2C byte read error - Retrying.\n"
argument_list|)
expr_stmt|;
else|else
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"I2C byte read error.\n"
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|retry
operator|<
name|max_retry
condition|)
do|;
name|done
label|:
name|i2cctl
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
expr_stmt|;
name|i2cctl
operator|&=
operator|~
name|I40E_GLGEN_I2CPARAMS_I2CBB_EN_MASK
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|,
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixl_write_i2c_byte - Writes 8 bit word over I2C  **/
end_comment

begin_function
name|s32
name|ixl_write_i2c_byte
parameter_list|(
name|struct
name|ixl_pf
modifier|*
name|pf
parameter_list|,
name|u8
name|byte_offset
parameter_list|,
name|u8
name|dev_addr
parameter_list|,
name|u8
name|data
parameter_list|)
block|{
name|struct
name|i40e_hw
modifier|*
name|hw
init|=
operator|&
name|pf
operator|->
name|hw
decl_stmt|;
name|s32
name|status
init|=
name|I40E_SUCCESS
decl_stmt|;
name|u32
name|max_retry
init|=
literal|1
decl_stmt|;
name|u32
name|retry
init|=
literal|0
decl_stmt|;
name|u32
name|i2cctl
init|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
decl_stmt|;
name|i2cctl
operator||=
name|I40E_GLGEN_I2CPARAMS_I2CBB_EN_MASK
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|,
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
do|do
block|{
name|ixl_i2c_start
argument_list|(
name|pf
argument_list|)
expr_stmt|;
name|status
operator|=
name|ixl_clock_out_i2c_byte
argument_list|(
name|pf
argument_list|,
name|dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|status
operator|=
name|ixl_get_i2c_ack
argument_list|(
name|pf
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|status
operator|=
name|ixl_clock_out_i2c_byte
argument_list|(
name|pf
argument_list|,
name|byte_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|status
operator|=
name|ixl_get_i2c_ack
argument_list|(
name|pf
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|status
operator|=
name|ixl_clock_out_i2c_byte
argument_list|(
name|pf
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|status
operator|=
name|ixl_get_i2c_ack
argument_list|(
name|pf
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|I40E_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|ixl_i2c_stop
argument_list|(
name|pf
argument_list|)
expr_stmt|;
goto|goto
name|write_byte_out
goto|;
name|fail
label|:
name|ixl_i2c_bus_clear
argument_list|(
name|pf
argument_list|)
expr_stmt|;
name|i40e_msec_delay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|retry
operator|++
expr_stmt|;
if|if
condition|(
name|retry
operator|<
name|max_retry
condition|)
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"I2C byte write error - Retrying.\n"
argument_list|)
expr_stmt|;
else|else
name|ixl_dbg
argument_list|(
name|pf
argument_list|,
name|IXL_DBG_I2C
argument_list|,
literal|"I2C byte write error.\n"
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|retry
operator|<
name|max_retry
condition|)
do|;
name|write_byte_out
label|:
name|i2cctl
operator|=
name|rd32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|)
expr_stmt|;
name|i2cctl
operator|&=
operator|~
name|I40E_GLGEN_I2CPARAMS_I2CBB_EN_MASK
expr_stmt|;
name|wr32
argument_list|(
name|hw
argument_list|,
name|IXL_I2C_REG
argument_list|(
name|hw
argument_list|)
argument_list|,
name|i2cctl
argument_list|)
expr_stmt|;
name|ixl_flush
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

end_unit


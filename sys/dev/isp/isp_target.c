begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  *  Copyright (c) 1997-2009 by Matthew Jacob  *  All rights reserved.  *  *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  *  THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND  *  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *  ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  *  DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  *  OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  *  HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  *  SUCH DAMAGE.  *  */
end_comment

begin_comment
comment|/*  * Machine and OS Independent Target Mode Code for the Qlogic SCSI/FC adapters.  */
end_comment

begin_comment
comment|/*  * Bug fixes gratefully acknowledged from:  *	Oded Kedem<oded@kashya.com>  */
end_comment

begin_comment
comment|/*  * Include header file appropriate for platform we're building on.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<dev/ic/isp_netbsd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/isp/isp_freebsd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__OpenBSD__
end_ifdef

begin_include
include|#
directive|include
file|<dev/ic/isp_openbsd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__linux__
end_ifdef

begin_include
include|#
directive|include
file|"isp_linux.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
end_ifdef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|atiocope
index|[]
init|=
literal|"ATIO returned for LUN %x because it was in the middle of Bus Device Reset on bus %d"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|atior
index|[]
init|=
literal|"ATIO returned for LUN %x from handle 0x%x because a Bus Reset occurred on bus %d"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rqo
index|[]
init|=
literal|"%s: Request Queue Overflow"
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|isp_got_msg_fc
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|in_fcentry_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_got_tmf_24xx
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|at7_entry_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_handle_abts
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|abts_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_handle_atio2
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|at2_entry_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_handle_ctio2
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|ct2_entry_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_handle_ctio7
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|ct7_entry_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_handle_notify
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|in_fcentry_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_handle_notify_24xx
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|in_fcentry_24xx_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * The Qlogic driver gets an interrupt to look at response queue entries.  * Some of these are status completions for initiatior mode commands, but  * if target mode is enabled, we get a whole wad of response queue entries  * to be handled here.  *  * Basically the split into 3 main groups: Lun Enable/Modification responses,  * SCSI Command processing, and Immediate Notification events.  *  * You start by writing a request queue entry to enable target mode (and  * establish some resource limitations which you can modify later).  * The f/w responds with a LUN ENABLE or LUN MODIFY response with  * the status of this action. If the enable was successful, you can expect...  *  * Response queue entries with SCSI commands encapsulate show up in an ATIO  * (Accept Target IO) type- sometimes with enough info to stop the command at  * this level. Ultimately the driver has to feed back to the f/w's request  * queue a sequence of CTIOs (continue target I/O) that describe data to  * be moved and/or status to be sent) and finally finishing with sending  * to the f/w's response queue an ATIO which then completes the handshake  * with the f/w for that command. There's a lot of variations on this theme,  * including flags you can set in the CTIO for the Qlogic 2X00 fibre channel  * cards that 'auto-replenish' the f/w's ATIO count, but this is the basic  * gist of it.  *  * The third group that can show up in the response queue are Immediate  * Notification events. These include things like notifications of SCSI bus  * resets, or Bus Device Reset messages or other messages received. This  * a classic oddbins area. It can get  a little weird because you then turn  * around and acknowledge the Immediate Notify by writing an entry onto the  * request queue and then the f/w turns around and gives you an acknowledgement  * to *your* acknowledgement on the response queue (the idea being to let  * the f/w tell you when the event is *really* over I guess).  *  */
end_comment

begin_comment
comment|/*  * A new response queue entry has arrived. The interrupt service code  * has already swizzled it into the platform dependent from canonical form.  *  * Because of the way this driver is designed, unfortunately most of the  * actual synchronization work has to be done in the platform specific  * code- we have no synchroniation primitives in the common code.  */
end_comment

begin_function
name|int
name|isp_target_notify
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|void
modifier|*
name|vptr
parameter_list|,
name|uint32_t
modifier|*
name|optrp
parameter_list|)
block|{
union|union
block|{
name|at2_entry_t
modifier|*
name|at2iop
decl_stmt|;
name|at2e_entry_t
modifier|*
name|at2eiop
decl_stmt|;
name|at7_entry_t
modifier|*
name|at7iop
decl_stmt|;
name|ct2_entry_t
modifier|*
name|ct2iop
decl_stmt|;
name|ct2e_entry_t
modifier|*
name|ct2eiop
decl_stmt|;
name|ct7_entry_t
modifier|*
name|ct7iop
decl_stmt|;
name|lun_entry_t
modifier|*
name|lunenp
decl_stmt|;
name|in_fcentry_t
modifier|*
name|inot_fcp
decl_stmt|;
name|in_fcentry_e_t
modifier|*
name|inote_fcp
decl_stmt|;
name|in_fcentry_24xx_t
modifier|*
name|inot_24xx
decl_stmt|;
name|na_fcentry_t
modifier|*
name|nack_fcp
decl_stmt|;
name|na_fcentry_e_t
modifier|*
name|nacke_fcp
decl_stmt|;
name|na_fcentry_24xx_t
modifier|*
name|nack_24xx
decl_stmt|;
name|isphdr_t
modifier|*
name|hp
decl_stmt|;
name|abts_t
modifier|*
name|abts
decl_stmt|;
name|abts_rsp_t
modifier|*
name|abts_rsp
decl_stmt|;
name|els_t
modifier|*
name|els
decl_stmt|;
name|void
modifier|*
modifier|*
name|vp
decl_stmt|;
define|#
directive|define
name|at2iop
value|unp.at2iop
define|#
directive|define
name|at2eiop
value|unp.at2eiop
define|#
directive|define
name|at7iop
value|unp.at7iop
define|#
directive|define
name|ct2iop
value|unp.ct2iop
define|#
directive|define
name|ct2eiop
value|unp.ct2eiop
define|#
directive|define
name|ct7iop
value|unp.ct7iop
define|#
directive|define
name|lunenp
value|unp.lunenp
define|#
directive|define
name|inot_fcp
value|unp.inot_fcp
define|#
directive|define
name|inote_fcp
value|unp.inote_fcp
define|#
directive|define
name|inot_24xx
value|unp.inot_24xx
define|#
directive|define
name|nack_fcp
value|unp.nack_fcp
define|#
directive|define
name|nacke_fcp
value|unp.nacke_fcp
define|#
directive|define
name|nack_24xx
value|unp.nack_24xx
define|#
directive|define
name|abts
value|unp.abts
define|#
directive|define
name|abts_rsp
value|unp.abts_rsp
define|#
directive|define
name|els
value|unp.els
define|#
directive|define
name|hdrp
value|unp.hp
block|}
name|unp
union|;
name|uint8_t
name|local
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
name|int
name|type
decl_stmt|,
name|len
decl_stmt|,
name|level
decl_stmt|,
name|rval
init|=
literal|1
decl_stmt|;
name|type
operator|=
name|isp_get_response_type
argument_list|(
name|isp
argument_list|,
operator|(
name|isphdr_t
operator|*
operator|)
name|vptr
argument_list|)
expr_stmt|;
name|unp
operator|.
name|vp
operator|=
name|vptr
expr_stmt|;
name|ISP_TDQE
argument_list|(
name|isp
argument_list|,
literal|"isp_target_notify"
argument_list|,
operator|(
name|int
operator|)
operator|*
name|optrp
argument_list|,
name|vptr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|RQSTYPE_ATIO
case|:
name|isp_get_atio7
argument_list|(
name|isp
argument_list|,
name|at7iop
argument_list|,
operator|(
name|at7_entry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
name|at7iop
operator|=
operator|(
name|at7_entry_t
operator|*
operator|)
name|local
expr_stmt|;
comment|/* 		 * Check for and do something with commands whose 		 * IULEN extends past a single queue entry. 		 */
name|len
operator|=
name|at7iop
operator|->
name|at_ta_len
operator|&
literal|0x0fff
expr_stmt|;
if|if
condition|(
name|len
operator|>
operator|(
name|QENTRY_LEN
operator|-
literal|8
operator|)
condition|)
block|{
name|len
operator|-=
operator|(
name|QENTRY_LEN
operator|-
literal|8
operator|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"long IU length (%d) ignored"
argument_list|,
name|len
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
operator|*
name|optrp
operator|=
name|ISP_NXT_QENTRY
argument_list|(
operator|*
name|optrp
argument_list|,
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|-=
name|QENTRY_LEN
expr_stmt|;
block|}
block|}
comment|/* 		 * Check for a task management function 		 */
if|if
condition|(
name|at7iop
operator|->
name|at_cmnd
operator|.
name|fcp_cmnd_task_management
condition|)
block|{
name|isp_got_tmf_24xx
argument_list|(
name|isp
argument_list|,
name|at7iop
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 		 * Just go straight to outer layer for this one. 		 */
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_ACTION
argument_list|,
name|local
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_ATIO2
case|:
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_get_atio2e
argument_list|(
name|isp
argument_list|,
name|at2eiop
argument_list|,
operator|(
name|at2e_entry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_get_atio2
argument_list|(
name|isp
argument_list|,
name|at2iop
argument_list|,
operator|(
name|at2_entry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
block|}
name|isp_handle_atio2
argument_list|(
name|isp
argument_list|,
operator|(
name|at2_entry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_CTIO3
case|:
case|case
name|RQSTYPE_CTIO2
case|:
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_get_ctio2e
argument_list|(
name|isp
argument_list|,
name|ct2eiop
argument_list|,
operator|(
name|ct2e_entry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_get_ctio2
argument_list|(
name|isp
argument_list|,
name|ct2iop
argument_list|,
operator|(
name|ct2_entry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
block|}
name|isp_handle_ctio2
argument_list|(
name|isp
argument_list|,
operator|(
name|ct2_entry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_CTIO7
case|:
name|isp_get_ctio7
argument_list|(
name|isp
argument_list|,
name|ct7iop
argument_list|,
operator|(
name|ct7_entry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
name|isp_handle_ctio7
argument_list|(
name|isp
argument_list|,
operator|(
name|ct7_entry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_NOTIFY
case|:
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_get_notify_24xx
argument_list|(
name|isp
argument_list|,
name|inot_24xx
argument_list|,
operator|(
name|in_fcentry_24xx_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
name|isp_handle_notify_24xx
argument_list|(
name|isp
argument_list|,
operator|(
name|in_fcentry_24xx_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
name|isp_get_notify_fc_e
argument_list|(
name|isp
argument_list|,
name|inote_fcp
argument_list|,
operator|(
name|in_fcentry_e_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
else|else
name|isp_get_notify_fc
argument_list|(
name|isp
argument_list|,
name|inot_fcp
argument_list|,
operator|(
name|in_fcentry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
name|isp_handle_notify
argument_list|(
name|isp
argument_list|,
operator|(
name|in_fcentry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_NOTIFY_ACK
case|:
comment|/* 		 * The ISP is acknowledging our acknowledgement of an 		 * Immediate Notify entry for some asynchronous event. 		 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_get_notify_ack_24xx
argument_list|(
name|isp
argument_list|,
name|nack_24xx
argument_list|,
operator|(
name|na_fcentry_24xx_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
name|nack_24xx
operator|=
operator|(
name|na_fcentry_24xx_t
operator|*
operator|)
name|local
expr_stmt|;
if|if
condition|(
name|nack_24xx
operator|->
name|na_status
operator|!=
name|NA_OK
condition|)
block|{
name|level
operator|=
name|ISP_LOGINFO
expr_stmt|;
block|}
else|else
block|{
name|level
operator|=
name|ISP_LOGTDEBUG1
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|level
argument_list|,
literal|"Notify Ack Status=0x%x; Subcode 0x%x seqid=0x%x"
argument_list|,
name|nack_24xx
operator|->
name|na_status
argument_list|,
name|nack_24xx
operator|->
name|na_status_subcode
argument_list|,
name|nack_24xx
operator|->
name|na_rxid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_get_notify_ack_fc_e
argument_list|(
name|isp
argument_list|,
name|nacke_fcp
argument_list|,
operator|(
name|na_fcentry_e_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_get_notify_ack_fc
argument_list|(
name|isp
argument_list|,
name|nack_fcp
argument_list|,
operator|(
name|na_fcentry_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
block|}
name|nack_fcp
operator|=
operator|(
name|na_fcentry_t
operator|*
operator|)
name|local
expr_stmt|;
if|if
condition|(
name|nack_fcp
operator|->
name|na_status
operator|!=
name|NA_OK
condition|)
block|{
name|level
operator|=
name|ISP_LOGINFO
expr_stmt|;
block|}
else|else
block|{
name|level
operator|=
name|ISP_LOGTDEBUG1
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|level
argument_list|,
literal|"Notify Ack Status=0x%x seqid 0x%x"
argument_list|,
name|nack_fcp
operator|->
name|na_status
argument_list|,
name|nack_fcp
operator|->
name|na_seqid
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RQSTYPE_ABTS_RCVD
case|:
name|isp_get_abts
argument_list|(
name|isp
argument_list|,
name|abts
argument_list|,
operator|(
name|abts_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
name|isp_handle_abts
argument_list|(
name|isp
argument_list|,
operator|(
name|abts_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_ABTS_RSP
case|:
name|isp_get_abts_rsp
argument_list|(
name|isp
argument_list|,
name|abts_rsp
argument_list|,
operator|(
name|abts_rsp_t
operator|*
operator|)
name|local
argument_list|)
expr_stmt|;
name|abts_rsp
operator|=
operator|(
name|abts_rsp_t
operator|*
operator|)
name|local
expr_stmt|;
if|if
condition|(
name|abts_rsp
operator|->
name|abts_rsp_status
condition|)
block|{
name|level
operator|=
name|ISP_LOGINFO
expr_stmt|;
block|}
else|else
block|{
name|level
operator|=
name|ISP_LOGTDEBUG0
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|level
argument_list|,
literal|"ABTS RSP response[0x%x]: status=0x%x sub=(0x%x 0x%x)"
argument_list|,
name|abts_rsp
operator|->
name|abts_rsp_rxid_task
argument_list|,
name|abts_rsp
operator|->
name|abts_rsp_status
argument_list|,
name|abts_rsp
operator|->
name|abts_rsp_payload
operator|.
name|rsp
operator|.
name|subcode1
argument_list|,
name|abts_rsp
operator|->
name|abts_rsp_payload
operator|.
name|rsp
operator|.
name|subcode2
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"%s: unknown entry type 0x%x"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|rval
operator|=
literal|0
expr_stmt|;
break|break;
block|}
undef|#
directive|undef
name|atiop
undef|#
directive|undef
name|at2iop
undef|#
directive|undef
name|at2eiop
undef|#
directive|undef
name|at7iop
undef|#
directive|undef
name|ctiop
undef|#
directive|undef
name|ct2iop
undef|#
directive|undef
name|ct2eiop
undef|#
directive|undef
name|ct7iop
undef|#
directive|undef
name|lunenp
undef|#
directive|undef
name|inotp
undef|#
directive|undef
name|inot_fcp
undef|#
directive|undef
name|inote_fcp
undef|#
directive|undef
name|inot_24xx
undef|#
directive|undef
name|nackp
undef|#
directive|undef
name|nack_fcp
undef|#
directive|undef
name|nacke_fcp
undef|#
directive|undef
name|hack_24xx
undef|#
directive|undef
name|abts
undef|#
directive|undef
name|abts_rsp
undef|#
directive|undef
name|els
undef|#
directive|undef
name|hdrp
return|return
operator|(
name|rval
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isp_target_put_entry
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|void
modifier|*
name|ap
parameter_list|)
block|{
name|void
modifier|*
name|outp
decl_stmt|;
name|uint8_t
name|etype
init|=
operator|(
operator|(
name|isphdr_t
operator|*
operator|)
name|ap
operator|)
operator|->
name|rqs_entry_type
decl_stmt|;
name|outp
operator|=
name|isp_getrqentry
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|outp
operator|==
name|NULL
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
name|rqo
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
switch|switch
condition|(
name|etype
condition|)
block|{
case|case
name|RQSTYPE_NOTIFY_ACK
case|:
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
name|isp_put_notify_24xx_ack
argument_list|(
name|isp
argument_list|,
operator|(
name|na_fcentry_24xx_t
operator|*
operator|)
name|ap
argument_list|,
operator|(
name|na_fcentry_24xx_t
operator|*
operator|)
name|outp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
name|isp_put_notify_ack_fc_e
argument_list|(
name|isp
argument_list|,
operator|(
name|na_fcentry_e_t
operator|*
operator|)
name|ap
argument_list|,
operator|(
name|na_fcentry_e_t
operator|*
operator|)
name|outp
argument_list|)
expr_stmt|;
else|else
name|isp_put_notify_ack_fc
argument_list|(
name|isp
argument_list|,
name|ap
argument_list|,
operator|(
name|na_fcentry_t
operator|*
operator|)
name|outp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_ATIO2
case|:
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
name|isp_put_atio2e
argument_list|(
name|isp
argument_list|,
operator|(
name|at2e_entry_t
operator|*
operator|)
name|ap
argument_list|,
operator|(
name|at2e_entry_t
operator|*
operator|)
name|outp
argument_list|)
expr_stmt|;
else|else
name|isp_put_atio2
argument_list|(
name|isp
argument_list|,
operator|(
name|at2_entry_t
operator|*
operator|)
name|ap
argument_list|,
operator|(
name|at2_entry_t
operator|*
operator|)
name|outp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_CTIO2
case|:
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
name|isp_put_ctio2e
argument_list|(
name|isp
argument_list|,
operator|(
name|ct2e_entry_t
operator|*
operator|)
name|ap
argument_list|,
operator|(
name|ct2e_entry_t
operator|*
operator|)
name|outp
argument_list|)
expr_stmt|;
else|else
name|isp_put_ctio2
argument_list|(
name|isp
argument_list|,
operator|(
name|ct2_entry_t
operator|*
operator|)
name|ap
argument_list|,
operator|(
name|ct2_entry_t
operator|*
operator|)
name|outp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_CTIO7
case|:
name|isp_put_ctio7
argument_list|(
name|isp
argument_list|,
operator|(
name|ct7_entry_t
operator|*
operator|)
name|ap
argument_list|,
operator|(
name|ct7_entry_t
operator|*
operator|)
name|outp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_ABTS_RSP
case|:
name|isp_put_abts_rsp
argument_list|(
name|isp
argument_list|,
operator|(
name|abts_rsp_t
operator|*
operator|)
name|ap
argument_list|,
operator|(
name|abts_rsp_t
operator|*
operator|)
name|outp
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"%s: Unknown type 0x%x"
argument_list|,
name|__func__
argument_list|,
name|etype
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ISP_TDQE
argument_list|(
name|isp
argument_list|,
name|__func__
argument_list|,
name|isp
operator|->
name|isp_reqidx
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|ISP_SYNC_REQUEST
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isp_target_put_atio
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|at2_entry_t
modifier|*
name|aep
init|=
name|arg
decl_stmt|;
union|union
block|{
name|at2_entry_t
name|_atio2
decl_stmt|;
name|at2e_entry_t
name|_atio2e
decl_stmt|;
block|}
name|atun
union|;
name|ISP_MEMZERO
argument_list|(
operator|&
name|atun
argument_list|,
sizeof|sizeof
name|atun
argument_list|)
expr_stmt|;
name|atun
operator|.
name|_atio2
operator|.
name|at_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_ATIO2
expr_stmt|;
name|atun
operator|.
name|_atio2
operator|.
name|at_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ISP_CAP_SCCFW
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|atun
operator|.
name|_atio2
operator|.
name|at_scclun
operator|=
name|aep
operator|->
name|at_scclun
expr_stmt|;
block|}
else|else
block|{
name|atun
operator|.
name|_atio2
operator|.
name|at_lun
operator|=
operator|(
name|uint8_t
operator|)
name|aep
operator|->
name|at_lun
expr_stmt|;
block|}
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|atun
operator|.
name|_atio2e
operator|.
name|at_iid
operator|=
operator|(
operator|(
name|at2e_entry_t
operator|*
operator|)
name|aep
operator|)
operator|->
name|at_iid
expr_stmt|;
block|}
else|else
block|{
name|atun
operator|.
name|_atio2
operator|.
name|at_iid
operator|=
name|aep
operator|->
name|at_iid
expr_stmt|;
block|}
name|atun
operator|.
name|_atio2
operator|.
name|at_rxid
operator|=
name|aep
operator|->
name|at_rxid
expr_stmt|;
name|atun
operator|.
name|_atio2
operator|.
name|at_status
operator|=
name|CT_OK
expr_stmt|;
return|return
operator|(
name|isp_target_put_entry
argument_list|(
name|isp
argument_list|,
operator|&
name|atun
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Command completion- both for handling cases of no resources or  * no blackhole driver, or other cases where we have to, inline,  * finish the command sanely, or for normal command completion.  *  * The 'completion' code value has the scsi status byte in the low 8 bits.  * If status is a CHECK CONDITION and bit 8 is nonzero, then bits 12..15 have  * the sense key and  bits 16..23 have the ASCQ and bits 24..31 have the ASC  * values.  *  * NB: the key, asc, ascq, cannot be used for parallel SCSI as it doesn't  * NB: inline SCSI sense reporting. As such, we lose this information. XXX.  *  * For both parallel&& fibre channel, we use the feature that does  * an automatic resource autoreplenish so we don't have then later do  * put of an atio to replenish the f/w's resource count.  */
end_comment

begin_function
name|int
name|isp_endcmd
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
modifier|...
parameter_list|)
block|{
name|uint32_t
name|code
decl_stmt|,
name|hdl
decl_stmt|;
name|uint8_t
name|sts
decl_stmt|;
union|union
block|{
name|ct2_entry_t
name|_ctio2
decl_stmt|;
name|ct2e_entry_t
name|_ctio2e
decl_stmt|;
name|ct7_entry_t
name|_ctio7
decl_stmt|;
block|}
name|un
union|;
name|va_list
name|ap
decl_stmt|;
name|int
name|vpidx
decl_stmt|,
name|nphdl
decl_stmt|;
name|ISP_MEMZERO
argument_list|(
operator|&
name|un
argument_list|,
sizeof|sizeof
name|un
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|at7_entry_t
modifier|*
name|aep
decl_stmt|;
name|ct7_entry_t
modifier|*
name|cto
init|=
operator|&
name|un
operator|.
name|_ctio7
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|isp
argument_list|)
expr_stmt|;
name|aep
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|at7_entry_t
operator|*
argument_list|)
expr_stmt|;
name|nphdl
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
comment|/* 		 * Note that vpidx may equal 0xff (unknown) here 		 */
name|vpidx
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|code
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|hdl
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"%s: [RX_ID 0x%x] chan %d code %x"
argument_list|,
name|__func__
argument_list|,
name|aep
operator|->
name|at_rxid
argument_list|,
name|vpidx
argument_list|,
name|code
argument_list|)
expr_stmt|;
name|sts
operator|=
name|code
operator|&
literal|0xff
expr_stmt|;
name|cto
operator|->
name|ct_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_CTIO7
expr_stmt|;
name|cto
operator|->
name|ct_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|cto
operator|->
name|ct_nphdl
operator|=
name|nphdl
expr_stmt|;
name|cto
operator|->
name|ct_rxid
operator|=
name|aep
operator|->
name|at_rxid
expr_stmt|;
name|cto
operator|->
name|ct_iid_lo
operator|=
operator|(
name|aep
operator|->
name|at_hdr
operator|.
name|s_id
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
name|aep
operator|->
name|at_hdr
operator|.
name|s_id
index|[
literal|2
index|]
expr_stmt|;
name|cto
operator|->
name|ct_iid_hi
operator|=
name|aep
operator|->
name|at_hdr
operator|.
name|s_id
index|[
literal|0
index|]
expr_stmt|;
name|cto
operator|->
name|ct_oxid
operator|=
name|aep
operator|->
name|at_hdr
operator|.
name|ox_id
expr_stmt|;
name|cto
operator|->
name|ct_scsi_status
operator|=
name|sts
expr_stmt|;
name|cto
operator|->
name|ct_vpidx
operator|=
name|vpidx
expr_stmt|;
name|cto
operator|->
name|ct_flags
operator|=
name|CT7_NOACK
expr_stmt|;
if|if
condition|(
name|code
operator|&
name|ECMD_TERMINATE
condition|)
block|{
name|cto
operator|->
name|ct_flags
operator||=
name|CT7_TERMINATE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|code
operator|&
name|ECMD_SVALID
condition|)
block|{
name|cto
operator|->
name|ct_flags
operator||=
name|CT7_FLAG_MODE1
operator||
name|CT7_SENDSTATUS
expr_stmt|;
name|cto
operator|->
name|ct_scsi_status
operator||=
operator|(
name|FCP_SNSLEN_VALID
operator|<<
literal|8
operator|)
expr_stmt|;
name|cto
operator|->
name|ct_senselen
operator|=
name|min
argument_list|(
literal|16
argument_list|,
name|MAXRESPLEN_24XX
argument_list|)
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
argument_list|,
sizeof|sizeof
argument_list|(
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
argument_list|)
argument_list|)
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|0
index|]
operator|=
literal|0xf0
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|2
index|]
operator|=
operator|(
name|code
operator|>>
literal|12
operator|)
operator|&
literal|0xf
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|7
index|]
operator|=
literal|8
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|12
index|]
operator|=
operator|(
name|code
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|13
index|]
operator|=
operator|(
name|code
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|code
operator|&
name|ECMD_RVALID
condition|)
block|{
name|cto
operator|->
name|ct_flags
operator||=
name|CT7_FLAG_MODE1
operator||
name|CT7_SENDSTATUS
expr_stmt|;
name|cto
operator|->
name|ct_scsi_status
operator||=
operator|(
name|FCP_RSPLEN_VALID
operator|<<
literal|8
operator|)
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resplen
operator|=
literal|4
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
argument_list|,
sizeof|sizeof
argument_list|(
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
argument_list|)
argument_list|)
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|0
index|]
operator|=
operator|(
name|code
operator|>>
literal|12
operator|)
operator|&
literal|0xf
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|1
index|]
operator|=
operator|(
name|code
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|2
index|]
operator|=
operator|(
name|code
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|cto
operator|->
name|ct_flags
operator||=
name|CT7_FLAG_MODE1
operator||
name|CT7_SENDSTATUS
expr_stmt|;
block|}
if|if
condition|(
name|aep
operator|->
name|at_cmnd
operator|.
name|cdb_dl
operator|.
name|sf
operator|.
name|fcp_cmnd_dl
operator|!=
literal|0
condition|)
block|{
name|cto
operator|->
name|ct_resid
operator|=
name|aep
operator|->
name|at_cmnd
operator|.
name|cdb_dl
operator|.
name|sf
operator|.
name|fcp_cmnd_dl
expr_stmt|;
name|cto
operator|->
name|ct_scsi_status
operator||=
operator|(
name|FCP_RESID_UNDERFLOW
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
name|cto
operator|->
name|ct_syshandle
operator|=
name|hdl
expr_stmt|;
block|}
else|else
block|{
name|at2_entry_t
modifier|*
name|aep
decl_stmt|;
name|ct2_entry_t
modifier|*
name|cto
init|=
operator|&
name|un
operator|.
name|_ctio2
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|isp
argument_list|)
expr_stmt|;
name|aep
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|at2_entry_t
operator|*
argument_list|)
expr_stmt|;
comment|/* nphdl and vpidx are unused here. */
name|nphdl
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|vpidx
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|code
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|hdl
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"%s: [RX_ID 0x%x] code %x"
argument_list|,
name|__func__
argument_list|,
name|aep
operator|->
name|at_rxid
argument_list|,
name|code
argument_list|)
expr_stmt|;
name|sts
operator|=
name|code
operator|&
literal|0xff
expr_stmt|;
name|cto
operator|->
name|ct_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_CTIO2
expr_stmt|;
name|cto
operator|->
name|ct_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ISP_CAP_SCCFW
argument_list|(
name|isp
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cto
operator|->
name|ct_lun
operator|=
name|aep
operator|->
name|at_lun
expr_stmt|;
block|}
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|un
operator|.
name|_ctio2e
operator|.
name|ct_iid
operator|=
operator|(
operator|(
name|at2e_entry_t
operator|*
operator|)
name|aep
operator|)
operator|->
name|at_iid
expr_stmt|;
block|}
else|else
block|{
name|cto
operator|->
name|ct_iid
operator|=
name|aep
operator|->
name|at_iid
expr_stmt|;
block|}
name|cto
operator|->
name|ct_rxid
operator|=
name|aep
operator|->
name|at_rxid
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_scsi_status
operator|=
name|sts
expr_stmt|;
name|cto
operator|->
name|ct_flags
operator|=
name|CT2_SENDSTATUS
operator||
name|CT2_NO_DATA
operator||
name|CT2_FLAG_MODE1
expr_stmt|;
if|if
condition|(
name|hdl
operator|==
literal|0
condition|)
block|{
name|cto
operator|->
name|ct_flags
operator||=
name|CT2_CCINCR
expr_stmt|;
block|}
if|if
condition|(
name|aep
operator|->
name|at_datalen
condition|)
block|{
name|cto
operator|->
name|ct_resid
operator|=
name|aep
operator|->
name|at_datalen
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_scsi_status
operator||=
name|CT2_DATA_UNDER
expr_stmt|;
block|}
if|if
condition|(
name|sts
operator|==
name|SCSI_CHECK
operator|&&
operator|(
name|code
operator|&
name|ECMD_SVALID
operator|)
condition|)
block|{
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|0
index|]
operator|=
literal|0xf0
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|2
index|]
operator|=
operator|(
name|code
operator|>>
literal|12
operator|)
operator|&
literal|0xf
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|7
index|]
operator|=
literal|8
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|12
index|]
operator|=
operator|(
name|code
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_resp
index|[
literal|13
index|]
operator|=
operator|(
name|code
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_senselen
operator|=
literal|16
expr_stmt|;
name|cto
operator|->
name|rsp
operator|.
name|m1
operator|.
name|ct_scsi_status
operator||=
name|CT2_SNSLEN_VALID
expr_stmt|;
block|}
name|cto
operator|->
name|ct_syshandle
operator|=
name|hdl
expr_stmt|;
block|}
return|return
operator|(
name|isp_target_put_entry
argument_list|(
name|isp
argument_list|,
operator|&
name|un
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * These are either broadcast events or specifically CTIO fast completion  */
end_comment

begin_function
name|void
name|isp_target_async
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|bus
parameter_list|,
name|int
name|event
parameter_list|)
block|{
name|isp_notify_t
name|notify
decl_stmt|;
name|ISP_MEMZERO
argument_list|(
operator|&
name|notify
argument_list|,
sizeof|sizeof
argument_list|(
name|isp_notify_t
argument_list|)
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_hba
operator|=
name|isp
expr_stmt|;
name|notify
operator|.
name|nt_wwn
operator|=
name|INI_ANY
expr_stmt|;
name|notify
operator|.
name|nt_nphdl
operator|=
name|NIL_HANDLE
expr_stmt|;
name|notify
operator|.
name|nt_sid
operator|=
name|PORT_ANY
expr_stmt|;
name|notify
operator|.
name|nt_did
operator|=
name|PORT_ANY
expr_stmt|;
name|notify
operator|.
name|nt_tgt
operator|=
name|TGT_ANY
expr_stmt|;
name|notify
operator|.
name|nt_channel
operator|=
name|bus
expr_stmt|;
name|notify
operator|.
name|nt_lun
operator|=
name|LUN_ANY
expr_stmt|;
name|notify
operator|.
name|nt_tagval
operator|=
name|TAG_ANY
expr_stmt|;
name|notify
operator|.
name|nt_tagval
operator||=
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|isp
operator|->
name|isp_serno
operator|++
argument_list|)
operator|)
operator|<<
literal|32
operator|)
expr_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|ASYNC_LOOP_UP
case|:
case|case
name|ASYNC_PTPMODE
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"%s: LOOP UP"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_LINK_UP
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_LOOP_DOWN
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"%s: LOOP DOWN"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_LINK_DOWN
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_LIP_ERROR
case|:
case|case
name|ASYNC_LIP_NOS_OLS_RECV
case|:
case|case
name|ASYNC_LIP_OCCURRED
case|:
case|case
name|ASYNC_LOOP_RESET
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"%s: LIP RESET"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_LIP_RESET
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_BUS_RESET
case|:
case|case
name|ASYNC_TIMEOUT_RESET
case|:
comment|/* XXX: where does this come from ? */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"%s: BUS RESET"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_BUS_RESET
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_DEVICE_RESET
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"%s: DEVICE RESET"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_TARGET_RESET
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_CTIO_DONE
case|:
block|{
name|uint8_t
name|storage
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"%s: CTIO DONE"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|storage
argument_list|,
literal|0
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ct7_entry_t
modifier|*
name|ct
init|=
operator|(
name|ct7_entry_t
operator|*
operator|)
name|storage
decl_stmt|;
name|ct
operator|->
name|ct_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_CTIO7
expr_stmt|;
name|ct
operator|->
name|ct_nphdl
operator|=
name|CT7_OK
expr_stmt|;
name|ct
operator|->
name|ct_syshandle
operator|=
name|bus
expr_stmt|;
name|ct
operator|->
name|ct_flags
operator|=
name|CT7_SENDSTATUS
expr_stmt|;
block|}
else|else
block|{
comment|/* This should also suffice for 2K login code */
name|ct2_entry_t
modifier|*
name|ct
init|=
operator|(
name|ct2_entry_t
operator|*
operator|)
name|storage
decl_stmt|;
name|ct
operator|->
name|ct_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_CTIO2
expr_stmt|;
name|ct
operator|->
name|ct_status
operator|=
name|CT_OK
expr_stmt|;
name|ct
operator|->
name|ct_syshandle
operator|=
name|bus
expr_stmt|;
name|ct
operator|->
name|ct_flags
operator|=
name|CT2_SENDSTATUS
operator||
name|CT2_FASTPOST
expr_stmt|;
block|}
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_ACTION
argument_list|,
name|storage
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"%s: unknown event 0x%x"
argument_list|,
name|__func__
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Synthesize a message from the task management flags in a FCP_CMND_IU.  */
end_comment

begin_function
specifier|static
name|void
name|isp_got_msg_fc
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|in_fcentry_t
modifier|*
name|inp
parameter_list|)
block|{
name|isp_notify_t
name|notify
decl_stmt|;
specifier|static
specifier|const
name|char
name|f1
index|[]
init|=
literal|"%s from N-port handle 0x%x lun %jx seq 0x%x"
decl_stmt|;
specifier|static
specifier|const
name|char
name|f2
index|[]
init|=
literal|"unknown %s 0x%x lun %jx N-Port handle 0x%x task flags 0x%x seq 0x%x\n"
decl_stmt|;
name|uint16_t
name|seqid
decl_stmt|,
name|nphdl
decl_stmt|;
name|ISP_MEMZERO
argument_list|(
operator|&
name|notify
argument_list|,
sizeof|sizeof
argument_list|(
name|isp_notify_t
argument_list|)
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_hba
operator|=
name|isp
expr_stmt|;
name|notify
operator|.
name|nt_wwn
operator|=
name|INI_ANY
expr_stmt|;
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|notify
operator|.
name|nt_nphdl
operator|=
operator|(
operator|(
name|in_fcentry_e_t
operator|*
operator|)
name|inp
operator|)
operator|->
name|in_iid
expr_stmt|;
name|nphdl
operator|=
operator|(
operator|(
name|in_fcentry_e_t
operator|*
operator|)
name|inp
operator|)
operator|->
name|in_iid
expr_stmt|;
name|seqid
operator|=
operator|(
operator|(
name|in_fcentry_e_t
operator|*
operator|)
name|inp
operator|)
operator|->
name|in_seqid
expr_stmt|;
block|}
else|else
block|{
name|notify
operator|.
name|nt_nphdl
operator|=
name|inp
operator|->
name|in_iid
expr_stmt|;
name|nphdl
operator|=
name|inp
operator|->
name|in_iid
expr_stmt|;
name|seqid
operator|=
name|inp
operator|->
name|in_seqid
expr_stmt|;
block|}
name|notify
operator|.
name|nt_sid
operator|=
name|PORT_ANY
expr_stmt|;
name|notify
operator|.
name|nt_did
operator|=
name|PORT_ANY
expr_stmt|;
comment|/* nt_tgt set in outer layers */
if|if
condition|(
name|ISP_CAP_SCCFW
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|notify
operator|.
name|nt_lun
operator|=
name|inp
operator|->
name|in_scclun
expr_stmt|;
block|}
else|else
block|{
name|notify
operator|.
name|nt_lun
operator|=
name|inp
operator|->
name|in_lun
expr_stmt|;
block|}
name|notify
operator|.
name|nt_tagval
operator|=
name|seqid
expr_stmt|;
name|notify
operator|.
name|nt_tagval
operator||=
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|isp
operator|->
name|isp_serno
operator|++
argument_list|)
operator|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|notify
operator|.
name|nt_need_ack
operator|=
literal|1
expr_stmt|;
name|notify
operator|.
name|nt_lreserved
operator|=
name|inp
expr_stmt|;
if|if
condition|(
name|inp
operator|->
name|in_status
operator|!=
name|IN_MSG_RECEIVED
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f2
argument_list|,
literal|"immediate notify status"
argument_list|,
name|inp
operator|->
name|in_status
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|nphdl
argument_list|,
name|inp
operator|->
name|in_task_flags
argument_list|,
name|inp
operator|->
name|in_seqid
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY_ACK
argument_list|,
name|inp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|inp
operator|->
name|in_task_flags
operator|&
name|TASK_FLAGS_ABORT_TASK_SET
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"ABORT TASK SET"
argument_list|,
name|nphdl
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|inp
operator|->
name|in_seqid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_ABORT_TASK_SET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|inp
operator|->
name|in_task_flags
operator|&
name|TASK_FLAGS_CLEAR_TASK_SET
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"CLEAR TASK SET"
argument_list|,
name|nphdl
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|inp
operator|->
name|in_seqid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_CLEAR_TASK_SET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|inp
operator|->
name|in_task_flags
operator|&
name|TASK_FLAGS_LUN_RESET
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"LUN RESET"
argument_list|,
name|nphdl
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|inp
operator|->
name|in_seqid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_LUN_RESET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|inp
operator|->
name|in_task_flags
operator|&
name|TASK_FLAGS_TARGET_RESET
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"TARGET RESET"
argument_list|,
name|nphdl
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|inp
operator|->
name|in_seqid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_TARGET_RESET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|inp
operator|->
name|in_task_flags
operator|&
name|TASK_FLAGS_CLEAR_ACA
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"CLEAR ACA"
argument_list|,
name|nphdl
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|inp
operator|->
name|in_seqid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_CLEAR_ACA
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
name|f2
argument_list|,
literal|"task flag"
argument_list|,
name|inp
operator|->
name|in_status
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|nphdl
argument_list|,
name|inp
operator|->
name|in_task_flags
argument_list|,
name|inp
operator|->
name|in_seqid
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY_ACK
argument_list|,
name|inp
argument_list|)
expr_stmt|;
return|return;
block|}
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_got_tmf_24xx
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|at7_entry_t
modifier|*
name|aep
parameter_list|)
block|{
name|isp_notify_t
name|notify
decl_stmt|;
specifier|static
specifier|const
name|char
name|f1
index|[]
init|=
literal|"%s from PortID 0x%06x lun %jx seq 0x%08x"
decl_stmt|;
specifier|static
specifier|const
name|char
name|f2
index|[]
init|=
literal|"unknown Task Flag 0x%x lun %jx PortID 0x%x tag 0x%08x"
decl_stmt|;
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
name|uint16_t
name|chan
decl_stmt|;
name|uint32_t
name|sid
decl_stmt|,
name|did
decl_stmt|;
name|ISP_MEMZERO
argument_list|(
operator|&
name|notify
argument_list|,
sizeof|sizeof
argument_list|(
name|isp_notify_t
argument_list|)
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_hba
operator|=
name|isp
expr_stmt|;
name|notify
operator|.
name|nt_wwn
operator|=
name|INI_ANY
expr_stmt|;
name|notify
operator|.
name|nt_lun
operator|=
name|CAM_EXTLUN_BYTE_SWIZZLE
argument_list|(
name|be64dec
argument_list|(
name|aep
operator|->
name|at_cmnd
operator|.
name|fcp_cmnd_lun
argument_list|)
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_tagval
operator|=
name|aep
operator|->
name|at_rxid
expr_stmt|;
name|notify
operator|.
name|nt_tagval
operator||=
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|isp
operator|->
name|isp_serno
operator|++
argument_list|)
operator|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|notify
operator|.
name|nt_lreserved
operator|=
name|aep
expr_stmt|;
name|sid
operator|=
operator|(
name|aep
operator|->
name|at_hdr
operator|.
name|s_id
index|[
literal|0
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|aep
operator|->
name|at_hdr
operator|.
name|s_id
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
name|aep
operator|->
name|at_hdr
operator|.
name|s_id
index|[
literal|2
index|]
expr_stmt|;
name|did
operator|=
operator|(
name|aep
operator|->
name|at_hdr
operator|.
name|d_id
index|[
literal|0
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|aep
operator|->
name|at_hdr
operator|.
name|d_id
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
name|aep
operator|->
name|at_hdr
operator|.
name|d_id
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|ISP_CAP_MULTI_ID
argument_list|(
name|isp
argument_list|)
operator|&&
name|isp
operator|->
name|isp_nchan
operator|>
literal|1
condition|)
block|{
comment|/* Channel has to be derived from D_ID */
name|isp_find_chan_by_did
argument_list|(
name|isp
argument_list|,
name|did
argument_list|,
operator|&
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|==
name|ISP_NOCHAN
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"%s: D_ID 0x%x not found on any channel"
argument_list|,
name|__func__
argument_list|,
name|did
argument_list|)
expr_stmt|;
name|isp_endcmd
argument_list|(
name|isp
argument_list|,
name|aep
argument_list|,
name|NIL_HANDLE
argument_list|,
name|ISP_NOCHAN
argument_list|,
name|ECMD_TERMINATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|chan
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|isp_find_pdb_by_portid
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|sid
argument_list|,
operator|&
name|lp
argument_list|)
condition|)
name|notify
operator|.
name|nt_nphdl
operator|=
name|lp
operator|->
name|handle
expr_stmt|;
else|else
name|notify
operator|.
name|nt_nphdl
operator|=
name|NIL_HANDLE
expr_stmt|;
name|notify
operator|.
name|nt_sid
operator|=
name|sid
expr_stmt|;
name|notify
operator|.
name|nt_did
operator|=
name|did
expr_stmt|;
name|notify
operator|.
name|nt_channel
operator|=
name|chan
expr_stmt|;
if|if
condition|(
name|aep
operator|->
name|at_cmnd
operator|.
name|fcp_cmnd_task_management
operator|&
name|FCP_CMND_TMF_QUERY_TASK_SET
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"QUERY TASK SET"
argument_list|,
name|sid
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|aep
operator|->
name|at_rxid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_QUERY_TASK_SET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|aep
operator|->
name|at_cmnd
operator|.
name|fcp_cmnd_task_management
operator|&
name|FCP_CMND_TMF_ABORT_TASK_SET
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"ABORT TASK SET"
argument_list|,
name|sid
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|aep
operator|->
name|at_rxid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_ABORT_TASK_SET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|aep
operator|->
name|at_cmnd
operator|.
name|fcp_cmnd_task_management
operator|&
name|FCP_CMND_TMF_CLEAR_TASK_SET
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"CLEAR TASK SET"
argument_list|,
name|sid
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|aep
operator|->
name|at_rxid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_CLEAR_TASK_SET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|aep
operator|->
name|at_cmnd
operator|.
name|fcp_cmnd_task_management
operator|&
name|FCP_CMND_TMF_QUERY_ASYNC_EVENT
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"QUERY ASYNC EVENT"
argument_list|,
name|sid
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|aep
operator|->
name|at_rxid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_QUERY_ASYNC_EVENT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|aep
operator|->
name|at_cmnd
operator|.
name|fcp_cmnd_task_management
operator|&
name|FCP_CMND_TMF_LUN_RESET
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"LUN RESET"
argument_list|,
name|sid
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|aep
operator|->
name|at_rxid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_LUN_RESET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|aep
operator|->
name|at_cmnd
operator|.
name|fcp_cmnd_task_management
operator|&
name|FCP_CMND_TMF_TGT_RESET
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"TARGET RESET"
argument_list|,
name|sid
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|aep
operator|->
name|at_rxid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_TARGET_RESET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|aep
operator|->
name|at_cmnd
operator|.
name|fcp_cmnd_task_management
operator|&
name|FCP_CMND_TMF_CLEAR_ACA
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
name|f1
argument_list|,
literal|"CLEAR ACA"
argument_list|,
name|sid
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|aep
operator|->
name|at_rxid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_CLEAR_ACA
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
name|f2
argument_list|,
name|aep
operator|->
name|at_cmnd
operator|.
name|fcp_cmnd_task_management
argument_list|,
name|notify
operator|.
name|nt_lun
argument_list|,
name|sid
argument_list|,
name|aep
operator|->
name|at_rxid
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_UNKNOWN
expr_stmt|;
name|isp_endcmd
argument_list|(
name|isp
argument_list|,
name|aep
argument_list|,
name|notify
operator|.
name|nt_nphdl
argument_list|,
name|chan
argument_list|,
name|ECMD_RVALID
operator||
operator|(
literal|0x4
operator|<<
literal|12
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|isp_notify_ack
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|char
name|storage
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
comment|/* 	 * This is in case a Task Management Function ends up here. 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
operator|(
name|isphdr_t
operator|*
operator|)
name|arg
operator|)
operator|->
name|rqs_entry_type
operator|==
name|RQSTYPE_ATIO
condition|)
block|{
name|at7_entry_t
modifier|*
name|aep
init|=
name|arg
decl_stmt|;
return|return
operator|(
name|isp_endcmd
argument_list|(
name|isp
argument_list|,
name|aep
argument_list|,
name|NIL_HANDLE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
name|ISP_MEMZERO
argument_list|(
name|storage
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|in_fcentry_24xx_t
modifier|*
name|in
init|=
name|arg
decl_stmt|;
name|na_fcentry_24xx_t
modifier|*
name|na
init|=
operator|(
name|na_fcentry_24xx_t
operator|*
operator|)
name|storage
decl_stmt|;
name|na
operator|->
name|na_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_NOTIFY_ACK
expr_stmt|;
name|na
operator|->
name|na_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|na
operator|->
name|na_nphdl
operator|=
name|in
operator|->
name|in_nphdl
expr_stmt|;
name|na
operator|->
name|na_flags
operator|=
name|in
operator|->
name|in_flags
expr_stmt|;
name|na
operator|->
name|na_status
operator|=
name|in
operator|->
name|in_status
expr_stmt|;
name|na
operator|->
name|na_status_subcode
operator|=
name|in
operator|->
name|in_status_subcode
expr_stmt|;
name|na
operator|->
name|na_fwhandle
operator|=
name|in
operator|->
name|in_fwhandle
expr_stmt|;
name|na
operator|->
name|na_rxid
operator|=
name|in
operator|->
name|in_rxid
expr_stmt|;
name|na
operator|->
name|na_oxid
operator|=
name|in
operator|->
name|in_oxid
expr_stmt|;
name|na
operator|->
name|na_vpidx
operator|=
name|in
operator|->
name|in_vpidx
expr_stmt|;
if|if
condition|(
name|in
operator|->
name|in_status
operator|==
name|IN24XX_SRR_RCVD
condition|)
block|{
name|na
operator|->
name|na_srr_rxid
operator|=
name|in
operator|->
name|in_srr_rxid
expr_stmt|;
name|na
operator|->
name|na_srr_reloff_hi
operator|=
name|in
operator|->
name|in_srr_reloff_hi
expr_stmt|;
name|na
operator|->
name|na_srr_reloff_lo
operator|=
name|in
operator|->
name|in_srr_reloff_lo
expr_stmt|;
name|na
operator|->
name|na_srr_iu
operator|=
name|in
operator|->
name|in_srr_iu
expr_stmt|;
comment|/* 			 * Whether we're accepting the SRR or rejecting 			 * it is determined by looking at the in_reserved 			 * field in the original notify structure. 			 */
if|if
condition|(
name|in
operator|->
name|in_reserved
condition|)
block|{
name|na
operator|->
name|na_srr_flags
operator|=
literal|1
expr_stmt|;
name|na
operator|->
name|na_srr_reject_vunique
operator|=
literal|0
expr_stmt|;
comment|/* Unable to perform this command at this time. */
name|na
operator|->
name|na_srr_reject_code
operator|=
literal|9
expr_stmt|;
comment|/* Unable to supply the requested data. */
name|na
operator|->
name|na_srr_reject_explanation
operator|=
literal|0x2a
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|in_fcentry_t
modifier|*
name|in
init|=
name|arg
decl_stmt|;
name|na_fcentry_t
modifier|*
name|na
init|=
operator|(
name|na_fcentry_t
operator|*
operator|)
name|storage
decl_stmt|;
name|int
name|iid
decl_stmt|;
name|ISP_MEMCPY
argument_list|(
name|storage
argument_list|,
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|isphdr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|iid
operator|=
operator|(
operator|(
name|in_fcentry_e_t
operator|*
operator|)
name|in
operator|)
operator|->
name|in_iid
expr_stmt|;
operator|(
operator|(
name|na_fcentry_e_t
operator|*
operator|)
name|na
operator|)
operator|->
name|na_iid
operator|=
name|iid
expr_stmt|;
block|}
else|else
block|{
name|iid
operator|=
name|in
operator|->
name|in_iid
expr_stmt|;
name|na
operator|->
name|na_iid
operator|=
name|iid
expr_stmt|;
block|}
name|na
operator|->
name|na_task_flags
operator|=
name|in
operator|->
name|in_task_flags
operator|&
name|TASK_FLAGS_RESERVED_MASK
expr_stmt|;
name|na
operator|->
name|na_seqid
operator|=
name|in
operator|->
name|in_seqid
expr_stmt|;
name|na
operator|->
name|na_status
operator|=
name|in
operator|->
name|in_status
expr_stmt|;
name|na
operator|->
name|na_flags
operator|=
name|NAFC_RCOUNT
expr_stmt|;
comment|/* We do not modify resource counts for LIP resets */
if|if
condition|(
name|in
operator|->
name|in_status
operator|==
name|IN_RESET
condition|)
name|na
operator|->
name|na_flags
operator|=
name|NAFC_RST_CLRD
expr_stmt|;
if|if
condition|(
name|in
operator|->
name|in_status
operator|==
name|IN_MSG_RECEIVED
condition|)
block|{
name|na
operator|->
name|na_flags
operator||=
name|NAFC_TVALID
expr_stmt|;
name|na
operator|->
name|na_response
operator|=
literal|0
expr_stmt|;
comment|/* XXX SUCCEEDED XXX */
block|}
name|na
operator|->
name|na_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_NOTIFY_ACK
expr_stmt|;
name|na
operator|->
name|na_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"notify ack handle %x seqid %x flags %x tflags %x response %x"
argument_list|,
name|iid
argument_list|,
name|na
operator|->
name|na_seqid
argument_list|,
name|na
operator|->
name|na_flags
argument_list|,
name|na
operator|->
name|na_task_flags
argument_list|,
name|na
operator|->
name|na_response
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|isp_target_put_entry
argument_list|(
name|isp
argument_list|,
operator|&
name|storage
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isp_acknak_abts
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|errno
parameter_list|)
block|{
name|char
name|storage
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
name|uint16_t
name|tmpw
decl_stmt|;
name|uint8_t
name|tmpb
decl_stmt|;
name|abts_t
modifier|*
name|abts
init|=
name|arg
decl_stmt|;
name|abts_rsp_t
modifier|*
name|rsp
init|=
operator|(
name|abts_rsp_t
operator|*
operator|)
name|storage
decl_stmt|;
if|if
condition|(
operator|!
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"%s: called for non-24XX card"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|abts
operator|->
name|abts_header
operator|.
name|rqs_entry_type
operator|!=
name|RQSTYPE_ABTS_RCVD
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"%s: called for non-ABTS entry (0x%x)"
argument_list|,
name|__func__
argument_list|,
name|abts
operator|->
name|abts_header
operator|.
name|rqs_entry_type
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ISP_MEMCPY
argument_list|(
name|rsp
argument_list|,
name|abts
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
name|rsp
operator|->
name|abts_rsp_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_ABTS_RSP
expr_stmt|;
comment|/* 	 * Swap destination and source for response. 	 */
name|rsp
operator|->
name|abts_rsp_r_ctl
operator|=
name|BA_ACC
expr_stmt|;
name|tmpw
operator|=
name|rsp
operator|->
name|abts_rsp_did_lo
expr_stmt|;
name|tmpb
operator|=
name|rsp
operator|->
name|abts_rsp_did_hi
expr_stmt|;
name|rsp
operator|->
name|abts_rsp_did_lo
operator|=
name|rsp
operator|->
name|abts_rsp_sid_lo
expr_stmt|;
name|rsp
operator|->
name|abts_rsp_did_hi
operator|=
name|rsp
operator|->
name|abts_rsp_sid_hi
expr_stmt|;
name|rsp
operator|->
name|abts_rsp_sid_lo
operator|=
name|tmpw
expr_stmt|;
name|rsp
operator|->
name|abts_rsp_sid_hi
operator|=
name|tmpb
expr_stmt|;
name|rsp
operator|->
name|abts_rsp_f_ctl_hi
operator|^=
literal|0x80
expr_stmt|;
comment|/* invert Exchange Context */
name|rsp
operator|->
name|abts_rsp_f_ctl_hi
operator|&=
operator|~
literal|0x7f
expr_stmt|;
comment|/* clear Sequence Initiator and other bits */
name|rsp
operator|->
name|abts_rsp_f_ctl_hi
operator||=
literal|0x10
expr_stmt|;
comment|/* abort the whole exchange */
name|rsp
operator|->
name|abts_rsp_f_ctl_hi
operator||=
literal|0x8
expr_stmt|;
comment|/* last data frame of sequence */
name|rsp
operator|->
name|abts_rsp_f_ctl_hi
operator||=
literal|0x1
expr_stmt|;
comment|/* transfer Sequence Initiative */
name|rsp
operator|->
name|abts_rsp_f_ctl_lo
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|errno
operator|==
literal|0
condition|)
block|{
name|uint16_t
name|rx_id
decl_stmt|,
name|ox_id
decl_stmt|;
name|rx_id
operator|=
name|rsp
operator|->
name|abts_rsp_rx_id
expr_stmt|;
name|ox_id
operator|=
name|rsp
operator|->
name|abts_rsp_ox_id
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
operator|&
name|rsp
operator|->
name|abts_rsp_payload
operator|.
name|ba_acc
argument_list|,
sizeof|sizeof
argument_list|(
name|rsp
operator|->
name|abts_rsp_payload
operator|.
name|ba_acc
argument_list|)
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTINFO
argument_list|,
literal|"[0x%x] ABTS of 0x%x being BA_ACC'd"
argument_list|,
name|rsp
operator|->
name|abts_rsp_rxid_abts
argument_list|,
name|rsp
operator|->
name|abts_rsp_rxid_task
argument_list|)
expr_stmt|;
name|rsp
operator|->
name|abts_rsp_payload
operator|.
name|ba_acc
operator|.
name|aborted_rx_id
operator|=
name|rx_id
expr_stmt|;
name|rsp
operator|->
name|abts_rsp_payload
operator|.
name|ba_acc
operator|.
name|aborted_ox_id
operator|=
name|ox_id
expr_stmt|;
name|rsp
operator|->
name|abts_rsp_payload
operator|.
name|ba_acc
operator|.
name|high_seq_cnt
operator|=
literal|0xffff
expr_stmt|;
block|}
else|else
block|{
name|ISP_MEMZERO
argument_list|(
operator|&
name|rsp
operator|->
name|abts_rsp_payload
operator|.
name|ba_rjt
argument_list|,
sizeof|sizeof
argument_list|(
name|rsp
operator|->
name|abts_rsp_payload
operator|.
name|ba_acc
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|errno
condition|)
block|{
case|case
name|ENOMEM
case|:
name|rsp
operator|->
name|abts_rsp_payload
operator|.
name|ba_rjt
operator|.
name|reason
operator|=
literal|5
expr_stmt|;
comment|/* Logical Unit Busy */
break|break;
default|default:
name|rsp
operator|->
name|abts_rsp_payload
operator|.
name|ba_rjt
operator|.
name|reason
operator|=
literal|9
expr_stmt|;
comment|/* Unable to perform command request */
break|break;
block|}
block|}
return|return
operator|(
name|isp_target_put_entry
argument_list|(
name|isp
argument_list|,
name|rsp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_handle_abts
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|abts_t
modifier|*
name|abts
parameter_list|)
block|{
name|isp_notify_t
name|notify
decl_stmt|,
modifier|*
name|nt
init|=
operator|&
name|notify
decl_stmt|;
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
name|uint16_t
name|chan
decl_stmt|;
name|uint32_t
name|sid
decl_stmt|,
name|did
decl_stmt|;
name|did
operator|=
operator|(
name|abts
operator|->
name|abts_did_hi
operator|<<
literal|16
operator|)
operator||
name|abts
operator|->
name|abts_did_lo
expr_stmt|;
name|sid
operator|=
operator|(
name|abts
operator|->
name|abts_sid_hi
operator|<<
literal|16
operator|)
operator||
name|abts
operator|->
name|abts_sid_lo
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|nt
argument_list|,
sizeof|sizeof
argument_list|(
name|isp_notify_t
argument_list|)
argument_list|)
expr_stmt|;
name|nt
operator|->
name|nt_hba
operator|=
name|isp
expr_stmt|;
name|nt
operator|->
name|nt_did
operator|=
name|did
expr_stmt|;
name|nt
operator|->
name|nt_nphdl
operator|=
name|abts
operator|->
name|abts_nphdl
expr_stmt|;
name|nt
operator|->
name|nt_sid
operator|=
name|sid
expr_stmt|;
name|isp_find_chan_by_did
argument_list|(
name|isp
argument_list|,
name|did
argument_list|,
operator|&
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|==
name|ISP_NOCHAN
condition|)
block|{
name|nt
operator|->
name|nt_tgt
operator|=
name|TGT_ANY
expr_stmt|;
block|}
else|else
block|{
name|nt
operator|->
name|nt_tgt
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_wwpn
expr_stmt|;
if|if
condition|(
name|isp_find_pdb_by_handle
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|abts
operator|->
name|abts_nphdl
argument_list|,
operator|&
name|lp
argument_list|)
condition|)
block|{
name|nt
operator|->
name|nt_wwn
operator|=
name|lp
operator|->
name|port_wwn
expr_stmt|;
block|}
else|else
block|{
name|nt
operator|->
name|nt_wwn
operator|=
name|INI_ANY
expr_stmt|;
block|}
block|}
name|nt
operator|->
name|nt_lun
operator|=
name|LUN_ANY
expr_stmt|;
name|nt
operator|->
name|nt_need_ack
operator|=
literal|1
expr_stmt|;
name|nt
operator|->
name|nt_tagval
operator|=
name|abts
operator|->
name|abts_rxid_task
expr_stmt|;
name|nt
operator|->
name|nt_tagval
operator||=
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|abts
operator|->
name|abts_rxid_abts
operator|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTINFO
argument_list|,
literal|"[0x%x] ABTS from N-Port handle 0x%x"
literal|" Port 0x%06x for task 0x%x (rx_id 0x%04x ox_id 0x%04x)"
argument_list|,
name|abts
operator|->
name|abts_rxid_abts
argument_list|,
name|abts
operator|->
name|abts_nphdl
argument_list|,
name|sid
argument_list|,
name|abts
operator|->
name|abts_rxid_task
argument_list|,
name|abts
operator|->
name|abts_rx_id
argument_list|,
name|abts
operator|->
name|abts_ox_id
argument_list|)
expr_stmt|;
name|nt
operator|->
name|nt_channel
operator|=
name|chan
expr_stmt|;
name|nt
operator|->
name|nt_ncode
operator|=
name|NT_ABORT_TASK
expr_stmt|;
name|nt
operator|->
name|nt_lreserved
operator|=
name|abts
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_handle_atio2
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|at2_entry_t
modifier|*
name|aep
parameter_list|)
block|{
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
name|int
name|lun
decl_stmt|,
name|iid
decl_stmt|;
if|if
condition|(
name|ISP_CAP_SCCFW
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|lun
operator|=
name|aep
operator|->
name|at_scclun
expr_stmt|;
block|}
else|else
block|{
name|lun
operator|=
name|aep
operator|->
name|at_lun
expr_stmt|;
block|}
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|iid
operator|=
operator|(
operator|(
name|at2e_entry_t
operator|*
operator|)
name|aep
operator|)
operator|->
name|at_iid
expr_stmt|;
block|}
else|else
block|{
name|iid
operator|=
name|aep
operator|->
name|at_iid
expr_stmt|;
block|}
comment|/* 	 * The firmware status (except for the QLTM_SVALID bit) indicates 	 * why this ATIO was sent to us. 	 * 	 * If QLTM_SVALID is set, the firware has recommended Sense Data. 	 * 	 * If the DISCONNECTS DISABLED bit is set in the flags field, 	 * we're still connected on the SCSI bus - i.e. the initiator 	 * did not set DiscPriv in the identify message. We don't care 	 * about this so it's ignored. 	 */
switch|switch
condition|(
name|aep
operator|->
name|at_status
operator|&
operator|~
name|QLTM_SVALID
condition|)
block|{
case|case
name|AT_PATH_INVALID
case|:
comment|/* 		 * ATIO rejected by the firmware due to disabled lun. 		 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"rejected ATIO2 for disabled lun %x"
argument_list|,
name|lun
argument_list|)
expr_stmt|;
break|break;
case|case
name|AT_NOCAP
case|:
comment|/* 		 * Requested Capability not available 		 * We sent an ATIO that overflowed the firmware's 		 * command resource count. 		 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"rejected ATIO2 for lun %x- command count overflow"
argument_list|,
name|lun
argument_list|)
expr_stmt|;
break|break;
case|case
name|AT_BDR_MSG
case|:
comment|/* 		 * If we send an ATIO to the firmware to increment 		 * its command resource count, and the firmware is 		 * recovering from a Bus Device Reset, it returns 		 * the ATIO with this status. We set the command 		 * resource count in the Enable Lun entry and no 		 * not increment it. Therefore we should never get 		 * this status here. 		 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|atiocope
argument_list|,
name|lun
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|AT_CDB
case|:
comment|/* Got a CDB */
comment|/* Make sure we have this inititor in port database. */
if|if
condition|(
operator|!
name|IS_2100
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
name|isp_find_pdb_by_handle
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|,
name|iid
argument_list|,
operator|&
name|lp
argument_list|)
operator|==
literal|0
operator|||
name|lp
operator|->
name|state
operator|==
name|FC_PORTDB_STATE_ZOMBIE
operator|)
condition|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|uint64_t
name|wwpn
init|=
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|aep
operator|->
name|at_wwpn
index|[
literal|0
index|]
operator|)
operator|<<
literal|48
operator|)
operator||
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|aep
operator|->
name|at_wwpn
index|[
literal|1
index|]
operator|)
operator|<<
literal|32
operator|)
operator||
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|aep
operator|->
name|at_wwpn
index|[
literal|2
index|]
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|aep
operator|->
name|at_wwpn
index|[
literal|3
index|]
operator|)
operator|<<
literal|0
operator|)
decl_stmt|;
name|isp_add_wwn_entry
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|,
name|wwpn
argument_list|,
name|INI_NONE
argument_list|,
name|iid
argument_list|,
name|PORT_ANY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|>
name|LOOP_LTEST_DONE
condition|)
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_LTEST_DONE
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_CHANGE_NOTIFY
argument_list|,
literal|0
argument_list|,
name|ISPASYNC_CHANGE_PDB
argument_list|,
name|iid
argument_list|,
literal|0x06
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
comment|/* Punt to platform specific layer. */
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_ACTION
argument_list|,
name|aep
argument_list|)
expr_stmt|;
break|break;
case|case
name|AT_RESET
case|:
comment|/* 		 * A bus reset came along an blew away this command. Why 		 * they do this in addition the async event code stuff, 		 * I dunno. 		 * 		 * Ignore it because the async event will clear things 		 * up for us. 		 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|atior
argument_list|,
name|lun
argument_list|,
name|iid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Unknown ATIO2 status 0x%x from handle %d for lun %x"
argument_list|,
name|aep
operator|->
name|at_status
argument_list|,
name|iid
argument_list|,
name|lun
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|isp_target_put_atio
argument_list|(
name|isp
argument_list|,
name|aep
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_handle_ctio2
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|ct2_entry_t
modifier|*
name|ct
parameter_list|)
block|{
name|void
modifier|*
name|xs
decl_stmt|;
name|int
name|pl
init|=
name|ISP_LOGTDEBUG2
decl_stmt|;
name|char
modifier|*
name|fmsg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|ct
operator|->
name|ct_syshandle
condition|)
block|{
name|xs
operator|=
name|isp_find_xs
argument_list|(
name|isp
argument_list|,
name|ct
operator|->
name|ct_syshandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|xs
operator|==
name|NULL
condition|)
block|{
name|pl
operator|=
name|ISP_LOGALL
expr_stmt|;
block|}
block|}
else|else
block|{
name|xs
operator|=
name|NULL
expr_stmt|;
block|}
switch|switch
condition|(
name|ct
operator|->
name|ct_status
operator|&
operator|~
name|QLTM_SVALID
condition|)
block|{
case|case
name|CT_BUS_ERROR
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"PCI DMA Bus Error"
argument_list|)
expr_stmt|;
comment|/* FALL Through */
case|case
name|CT_DATA_OVER
case|:
case|case
name|CT_DATA_UNDER
case|:
case|case
name|CT_OK
case|:
comment|/* 		 * There are generally 2 possibilities as to why we'd get 		 * this condition: 		 * 	We sent or received data. 		 * 	We sent status& command complete. 		 */
break|break;
case|case
name|CT_BDR_MSG
case|:
comment|/* 		 * Target Reset function received. 		 * 		 * The firmware generates an async mailbox interrupt to 		 * notify us of this and returns outstanding CTIOs with this 		 * status. These CTIOs are handled in that same way as 		 * CT_ABORTED ones, so just fall through here. 		 */
name|fmsg
operator|=
literal|"TARGET RESET"
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|CT_RESET
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
name|fmsg
operator|=
literal|"LIP Reset"
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|CT_ABORTED
case|:
comment|/* 		 * When an Abort message is received the firmware goes to 		 * Bus Free and returns all outstanding CTIOs with the status 		 * set, then sends us an Immediate Notify entry. 		 */
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
block|{
name|fmsg
operator|=
literal|"ABORT"
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"CTIO2 destroyed by %s: RX_ID=0x%x"
argument_list|,
name|fmsg
argument_list|,
name|ct
operator|->
name|ct_rxid
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_INVAL
case|:
comment|/* 		 * CTIO rejected by the firmware - invalid data direction. 		 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"CTIO2 had wrong data direction"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_RSELTMO
case|:
name|fmsg
operator|=
literal|"failure to reconnect to initiator"
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|CT_TIMEOUT
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
name|fmsg
operator|=
literal|"command"
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Firmware timed out on %s"
argument_list|,
name|fmsg
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_ERR
case|:
name|fmsg
operator|=
literal|"Completed with Error"
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|CT_LOGOUT
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
name|fmsg
operator|=
literal|"Port Logout"
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|CT_PORTUNAVAIL
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
name|fmsg
operator|=
literal|"Port not available"
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|CT_PORTCHANGED
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
name|fmsg
operator|=
literal|"Port Changed"
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|CT_NOACK
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
name|fmsg
operator|=
literal|"unacknowledged Immediate Notify pending"
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"CTIO returned by f/w- %s"
argument_list|,
name|fmsg
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_INVRXID
case|:
comment|/* 		 * CTIO rejected by the firmware because an invalid RX_ID. 		 * Just print a message. 		 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"CTIO2 completed with Invalid RX_ID 0x%x"
argument_list|,
name|ct
operator|->
name|ct_rxid
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Unknown CTIO2 status 0x%x"
argument_list|,
name|ct
operator|->
name|ct_status
operator|&
operator|~
name|QLTM_SVALID
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|xs
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * There may be more than one CTIO for a data transfer, 		 * or this may be a status CTIO we're not monitoring. 		 * 		 * The assumption is that they'll all be returned in the 		 * order we got them. 		 */
if|if
condition|(
name|ct
operator|->
name|ct_syshandle
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ct
operator|->
name|ct_flags
operator|&
name|CT2_SENDSTATUS
operator|)
operator|==
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|pl
argument_list|,
literal|"intermediate CTIO completed ok"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|pl
argument_list|,
literal|"unmonitored CTIO completed ok"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|pl
argument_list|,
literal|"NO xs for CTIO (handle 0x%x) status 0x%x"
argument_list|,
name|ct
operator|->
name|ct_syshandle
argument_list|,
name|ct
operator|->
name|ct_status
operator|&
operator|~
name|QLTM_SVALID
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ct
operator|->
name|ct_flags
operator|&
name|CT2_DATAMASK
operator|)
operator|!=
name|CT2_NO_DATA
condition|)
block|{
name|ISP_DMAFREE
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ct
operator|->
name|ct_syshandle
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ct
operator|->
name|ct_flags
operator|&
name|CT2_SENDSTATUS
condition|)
block|{
comment|/* 			 * Sent status and command complete. 			 * 			 * We're now really done with this command, so we 			 * punt to the platform dependent layers because 			 * only there can we do the appropriate command 			 * complete thread synchronization. 			 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|pl
argument_list|,
literal|"status CTIO complete"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Final CTIO completed. Release DMA resources and 			 * notify platform dependent layers. 			 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|pl
argument_list|,
literal|"data CTIO complete"
argument_list|)
expr_stmt|;
block|}
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_ACTION
argument_list|,
name|ct
argument_list|)
expr_stmt|;
comment|/* 		 * The platform layer will destroy the handle if appropriate. 		 */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_handle_ctio7
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|ct7_entry_t
modifier|*
name|ct
parameter_list|)
block|{
name|void
modifier|*
name|xs
decl_stmt|;
name|int
name|pl
init|=
name|ISP_LOGTDEBUG2
decl_stmt|;
name|char
modifier|*
name|fmsg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|ct
operator|->
name|ct_syshandle
condition|)
block|{
name|xs
operator|=
name|isp_find_xs
argument_list|(
name|isp
argument_list|,
name|ct
operator|->
name|ct_syshandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|xs
operator|==
name|NULL
condition|)
block|{
name|pl
operator|=
name|ISP_LOGALL
expr_stmt|;
block|}
block|}
else|else
block|{
name|xs
operator|=
name|NULL
expr_stmt|;
block|}
switch|switch
condition|(
name|ct
operator|->
name|ct_nphdl
condition|)
block|{
case|case
name|CT7_BUS_ERROR
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"PCI DMA Bus Error"
argument_list|)
expr_stmt|;
comment|/* FALL Through */
case|case
name|CT7_DATA_OVER
case|:
case|case
name|CT7_DATA_UNDER
case|:
case|case
name|CT7_OK
case|:
comment|/* 		 * There are generally 2 possibilities as to why we'd get 		 * this condition: 		 * 	We sent or received data. 		 * 	We sent status& command complete. 		 */
break|break;
case|case
name|CT7_RESET
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
block|{
name|fmsg
operator|=
literal|"LIP Reset"
expr_stmt|;
block|}
comment|/*FALLTHROUGH*/
case|case
name|CT7_ABORTED
case|:
comment|/* 		 * When an Abort message is received the firmware goes to 		 * Bus Free and returns all outstanding CTIOs with the status 		 * set, then sends us an Immediate Notify entry. 		 */
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
block|{
name|fmsg
operator|=
literal|"ABORT"
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"CTIO7 destroyed by %s: RX_ID=0x%x"
argument_list|,
name|fmsg
argument_list|,
name|ct
operator|->
name|ct_rxid
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT7_TIMEOUT
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
block|{
name|fmsg
operator|=
literal|"command"
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Firmware timed out on %s"
argument_list|,
name|fmsg
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT7_ERR
case|:
name|fmsg
operator|=
literal|"Completed with Error"
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|CT7_LOGOUT
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
block|{
name|fmsg
operator|=
literal|"Port Logout"
expr_stmt|;
block|}
comment|/*FALLTHROUGH*/
case|case
name|CT7_PORTUNAVAIL
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
block|{
name|fmsg
operator|=
literal|"Port not available"
expr_stmt|;
block|}
comment|/*FALLTHROUGH*/
case|case
name|CT7_PORTCHANGED
case|:
if|if
condition|(
name|fmsg
operator|==
name|NULL
condition|)
block|{
name|fmsg
operator|=
literal|"Port Changed"
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"CTIO returned by f/w- %s"
argument_list|,
name|fmsg
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT7_INVRXID
case|:
comment|/* 		 * CTIO rejected by the firmware because an invalid RX_ID. 		 * Just print a message. 		 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"CTIO7 completed with Invalid RX_ID 0x%x"
argument_list|,
name|ct
operator|->
name|ct_rxid
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT7_REASSY_ERR
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"reassembly error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT7_SRR
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"SRR received"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Unknown CTIO7 status 0x%x"
argument_list|,
name|ct
operator|->
name|ct_nphdl
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|xs
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * There may be more than one CTIO for a data transfer, 		 * or this may be a status CTIO we're not monitoring. 		 * 		 * The assumption is that they'll all be returned in the 		 * order we got them. 		 */
if|if
condition|(
name|ct
operator|->
name|ct_syshandle
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ct
operator|->
name|ct_flags
operator|&
name|CT7_TERMINATE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"termination of [RX_ID 0x%x] complete"
argument_list|,
name|ct
operator|->
name|ct_rxid
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ct
operator|->
name|ct_flags
operator|&
name|CT7_SENDSTATUS
operator|)
operator|==
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|pl
argument_list|,
literal|"intermediate CTIO completed ok"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|pl
argument_list|,
literal|"unmonitored CTIO completed ok"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|pl
argument_list|,
literal|"NO xs for CTIO (handle 0x%x) status 0x%x"
argument_list|,
name|ct
operator|->
name|ct_syshandle
argument_list|,
name|ct
operator|->
name|ct_nphdl
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ct
operator|->
name|ct_flags
operator|&
name|CT7_DATAMASK
operator|)
operator|!=
name|CT7_NO_DATA
condition|)
block|{
name|ISP_DMAFREE
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ct
operator|->
name|ct_syshandle
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ct
operator|->
name|ct_flags
operator|&
name|CT7_SENDSTATUS
condition|)
block|{
comment|/* 			 * Sent status and command complete. 			 * 			 * We're now really done with this command, so we 			 * punt to the platform dependent layers because 			 * only there can we do the appropriate command 			 * complete thread synchronization. 			 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|pl
argument_list|,
literal|"status CTIO complete"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Final CTIO completed. Release DMA resources and 			 * notify platform dependent layers. 			 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|pl
argument_list|,
literal|"data CTIO complete"
argument_list|)
expr_stmt|;
block|}
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_ACTION
argument_list|,
name|ct
argument_list|)
expr_stmt|;
comment|/* 		 * The platform layer will destroy the handle if appropriate. 		 */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_handle_notify
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|in_fcentry_t
modifier|*
name|inp
parameter_list|)
block|{
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
name|uint64_t
name|wwn
decl_stmt|;
name|uint32_t
name|sid
decl_stmt|;
name|uint16_t
name|nphdl
decl_stmt|,
name|status
decl_stmt|;
name|isp_notify_t
name|notify
decl_stmt|;
name|status
operator|=
name|inp
operator|->
name|in_status
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"Immediate Notify, status=0x%x seqid=0x%x"
argument_list|,
name|status
argument_list|,
name|inp
operator|->
name|in_seqid
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|IN_MSG_RECEIVED
case|:
case|case
name|IN_IDE_RECEIVED
case|:
name|isp_got_msg_fc
argument_list|(
name|isp
argument_list|,
name|inp
argument_list|)
expr_stmt|;
return|return;
case|case
name|IN_RSRC_UNAVAIL
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Firmware out of ATIOs"
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY_ACK
argument_list|,
name|inp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
name|nphdl
operator|=
operator|(
operator|(
name|in_fcentry_e_t
operator|*
operator|)
name|inp
operator|)
operator|->
name|in_iid
expr_stmt|;
else|else
name|nphdl
operator|=
name|inp
operator|->
name|in_iid
expr_stmt|;
if|if
condition|(
name|isp_find_pdb_by_handle
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|,
name|nphdl
argument_list|,
operator|&
name|lp
argument_list|)
condition|)
block|{
name|wwn
operator|=
name|lp
operator|->
name|port_wwn
expr_stmt|;
name|sid
operator|=
name|lp
operator|->
name|portid
expr_stmt|;
block|}
else|else
block|{
name|wwn
operator|=
name|INI_ANY
expr_stmt|;
name|sid
operator|=
name|PORT_ANY
expr_stmt|;
block|}
name|ISP_MEMZERO
argument_list|(
operator|&
name|notify
argument_list|,
sizeof|sizeof
argument_list|(
name|isp_notify_t
argument_list|)
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_hba
operator|=
name|isp
expr_stmt|;
name|notify
operator|.
name|nt_wwn
operator|=
name|wwn
expr_stmt|;
name|notify
operator|.
name|nt_tgt
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|isp_wwpn
expr_stmt|;
name|notify
operator|.
name|nt_nphdl
operator|=
name|nphdl
expr_stmt|;
name|notify
operator|.
name|nt_sid
operator|=
name|sid
expr_stmt|;
name|notify
operator|.
name|nt_did
operator|=
name|PORT_ANY
expr_stmt|;
if|if
condition|(
name|ISP_CAP_SCCFW
argument_list|(
name|isp
argument_list|)
condition|)
name|notify
operator|.
name|nt_lun
operator|=
name|inp
operator|->
name|in_scclun
expr_stmt|;
else|else
name|notify
operator|.
name|nt_lun
operator|=
name|inp
operator|->
name|in_lun
expr_stmt|;
name|notify
operator|.
name|nt_tagval
operator|=
name|inp
operator|->
name|in_seqid
expr_stmt|;
name|notify
operator|.
name|nt_tagval
operator||=
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|isp
operator|->
name|isp_serno
operator|++
argument_list|)
operator|)
operator|<<
literal|32
operator|)
expr_stmt|;
name|notify
operator|.
name|nt_need_ack
operator|=
literal|1
expr_stmt|;
name|notify
operator|.
name|nt_channel
operator|=
literal|0
expr_stmt|;
name|notify
operator|.
name|nt_lreserved
operator|=
name|inp
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|IN_RESET
case|:
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_BUS_RESET
expr_stmt|;
break|break;
case|case
name|IN_PORT_LOGOUT
case|:
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_LOGOUT
expr_stmt|;
break|break;
case|case
name|IN_ABORT_TASK
case|:
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_ABORT_TASK
expr_stmt|;
break|break;
case|case
name|IN_GLOBAL_LOGO
case|:
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_GLOBAL_LOGOUT
expr_stmt|;
break|break;
case|case
name|IN_PORT_CHANGED
case|:
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_CHANGED
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"%s: unhandled status (0x%x)"
argument_list|,
name|__func__
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY_ACK
argument_list|,
name|inp
argument_list|)
expr_stmt|;
return|return;
block|}
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_handle_notify_24xx
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|in_fcentry_24xx_t
modifier|*
name|inot
parameter_list|)
block|{
name|uint8_t
name|chan
decl_stmt|;
name|uint16_t
name|nphdl
decl_stmt|,
name|prli_options
init|=
literal|0
decl_stmt|;
name|uint32_t
name|portid
decl_stmt|;
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
name|char
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|uint8_t
modifier|*
name|ptr
init|=
operator|(
name|uint8_t
operator|*
operator|)
name|inot
decl_stmt|;
name|uint64_t
name|wwpn
init|=
name|INI_NONE
decl_stmt|,
name|wwnn
init|=
name|INI_NONE
decl_stmt|;
name|isp_notify_t
name|notify
decl_stmt|;
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|nphdl
operator|=
name|inot
operator|->
name|in_nphdl
expr_stmt|;
if|if
condition|(
name|nphdl
operator|!=
name|NIL_HANDLE
condition|)
block|{
name|portid
operator|=
name|inot
operator|->
name|in_portid_hi
operator|<<
literal|16
operator||
name|inot
operator|->
name|in_portid_lo
expr_stmt|;
block|}
else|else
block|{
name|portid
operator|=
name|PORT_ANY
expr_stmt|;
block|}
name|chan
operator|=
name|ISP_GET_VPIDX
argument_list|(
name|isp
argument_list|,
name|inot
operator|->
name|in_vpidx
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|>=
name|isp
operator|->
name|isp_nchan
operator|&&
name|inot
operator|->
name|in_status
operator|!=
name|IN24XX_LIP_RESET
operator|&&
name|inot
operator|->
name|in_status
operator|!=
name|IN24XX_LINK_RESET
operator|&&
name|inot
operator|->
name|in_status
operator|!=
name|IN24XX_LINK_FAILED
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"%s: Received INOT with status %x on VP %x"
argument_list|,
name|__func__
argument_list|,
name|inot
operator|->
name|in_status
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY_ACK
argument_list|,
name|inot
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|inot
operator|->
name|in_status
condition|)
block|{
case|case
name|IN24XX_ELS_RCVD
case|:
block|{
comment|/* 		 * Note that we're just getting notification that an ELS was 		 * received (possibly with some associated information sent 		 * upstream).  This is *not* the same as being given the ELS 		 * frame to accept or reject. 		 */
switch|switch
condition|(
name|inot
operator|->
name|in_status_subcode
condition|)
block|{
case|case
name|LOGO
case|:
name|msg
operator|=
literal|"LOGO"
expr_stmt|;
name|wwpn
operator|=
name|be64dec
argument_list|(
operator|&
name|ptr
index|[
name|IN24XX_PLOGI_WWPN_OFF
index|]
argument_list|)
expr_stmt|;
name|isp_del_wwn_entry
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|wwpn
argument_list|,
name|nphdl
argument_list|,
name|portid
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRLO
case|:
name|msg
operator|=
literal|"PRLO"
expr_stmt|;
break|break;
case|case
name|PLOGI
case|:
name|msg
operator|=
literal|"PLOGI"
expr_stmt|;
name|wwnn
operator|=
name|be64dec
argument_list|(
operator|&
name|ptr
index|[
name|IN24XX_PLOGI_WWNN_OFF
index|]
argument_list|)
expr_stmt|;
name|wwpn
operator|=
name|be64dec
argument_list|(
operator|&
name|ptr
index|[
name|IN24XX_PLOGI_WWPN_OFF
index|]
argument_list|)
expr_stmt|;
name|isp_add_wwn_entry
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|wwpn
argument_list|,
name|wwnn
argument_list|,
name|nphdl
argument_list|,
name|portid
argument_list|,
name|prli_options
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRLI
case|:
name|msg
operator|=
literal|"PRLI"
expr_stmt|;
name|prli_options
operator|=
name|inot
operator|->
name|in_prli_options
expr_stmt|;
if|if
condition|(
name|inot
operator|->
name|in_flags
operator|&
name|IN24XX_FLAG_PN_NN_VALID
condition|)
name|wwnn
operator|=
name|be64dec
argument_list|(
operator|&
name|ptr
index|[
name|IN24XX_PRLI_WWNN_OFF
index|]
argument_list|)
expr_stmt|;
name|wwpn
operator|=
name|be64dec
argument_list|(
operator|&
name|ptr
index|[
name|IN24XX_PRLI_WWPN_OFF
index|]
argument_list|)
expr_stmt|;
name|isp_add_wwn_entry
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|wwpn
argument_list|,
name|wwnn
argument_list|,
name|nphdl
argument_list|,
name|portid
argument_list|,
name|prli_options
argument_list|)
expr_stmt|;
break|break;
case|case
name|PDISC
case|:
name|msg
operator|=
literal|"PDISC"
expr_stmt|;
break|break;
case|case
name|ADISC
case|:
name|msg
operator|=
literal|"ADISC"
expr_stmt|;
break|break;
default|default:
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"ELS 0x%x"
argument_list|,
name|inot
operator|->
name|in_status_subcode
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buf
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|inot
operator|->
name|in_flags
operator|&
name|IN24XX_FLAG_PUREX_IOCB
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"%s Chan %d ELS N-port handle %x"
literal|" PortID 0x%06x marked as needing a PUREX response"
argument_list|,
name|msg
argument_list|,
name|chan
argument_list|,
name|nphdl
argument_list|,
name|portid
argument_list|)
expr_stmt|;
break|break;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"%s Chan %d ELS N-port handle %x"
literal|" PortID 0x%06x RX_ID 0x%x OX_ID 0x%x"
argument_list|,
name|msg
argument_list|,
name|chan
argument_list|,
name|nphdl
argument_list|,
name|portid
argument_list|,
name|inot
operator|->
name|in_rxid
argument_list|,
name|inot
operator|->
name|in_oxid
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY_ACK
argument_list|,
name|inot
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IN24XX_PORT_LOGOUT
case|:
name|msg
operator|=
literal|"PORT LOGOUT"
expr_stmt|;
if|if
condition|(
name|isp_find_pdb_by_handle
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|nphdl
argument_list|,
operator|&
name|lp
argument_list|)
condition|)
name|isp_del_wwn_entry
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|lp
operator|->
name|port_wwn
argument_list|,
name|nphdl
argument_list|,
name|lp
operator|->
name|portid
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|IN24XX_PORT_CHANGED
case|:
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
name|msg
operator|=
literal|"PORT CHANGED"
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|IN24XX_LIP_RESET
case|:
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
name|msg
operator|=
literal|"LIP RESET"
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Chan %d %s (sub-status 0x%x) for "
literal|"N-port handle 0x%x"
argument_list|,
name|chan
argument_list|,
name|msg
argument_list|,
name|inot
operator|->
name|in_status_subcode
argument_list|,
name|nphdl
argument_list|)
expr_stmt|;
comment|/* 		 * All subcodes here are irrelevant. What is relevant 		 * is that we need to terminate all active commands from 		 * this initiator (known by N-port handle). 		 */
comment|/* XXX IMPLEMENT XXX */
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY_ACK
argument_list|,
name|inot
argument_list|)
expr_stmt|;
break|break;
case|case
name|IN24XX_SRR_RCVD
case|:
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
name|ISP_MEMZERO
argument_list|(
operator|&
name|notify
argument_list|,
sizeof|sizeof
argument_list|(
name|isp_notify_t
argument_list|)
argument_list|)
expr_stmt|;
name|notify
operator|.
name|nt_hba
operator|=
name|isp
expr_stmt|;
name|notify
operator|.
name|nt_wwn
operator|=
name|INI_ANY
expr_stmt|;
name|notify
operator|.
name|nt_tgt
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_wwpn
expr_stmt|;
name|notify
operator|.
name|nt_nphdl
operator|=
name|nphdl
expr_stmt|;
name|notify
operator|.
name|nt_sid
operator|=
name|portid
expr_stmt|;
name|notify
operator|.
name|nt_did
operator|=
name|PORT_ANY
expr_stmt|;
name|notify
operator|.
name|nt_lun
operator|=
name|LUN_ANY
expr_stmt|;
name|notify
operator|.
name|nt_tagval
operator|=
name|inot
operator|->
name|in_rxid
expr_stmt|;
name|notify
operator|.
name|nt_tagval
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|inot
operator|->
name|in_srr_rxid
operator|<<
literal|32
operator|)
expr_stmt|;
name|notify
operator|.
name|nt_need_ack
operator|=
literal|1
expr_stmt|;
name|notify
operator|.
name|nt_channel
operator|=
name|chan
expr_stmt|;
name|notify
operator|.
name|nt_lreserved
operator|=
name|inot
expr_stmt|;
name|notify
operator|.
name|nt_ncode
operator|=
name|NT_SRR
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY
argument_list|,
operator|&
name|notify
argument_list|)
expr_stmt|;
break|break;
else|#
directive|else
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
name|msg
operator|=
literal|"SRR RCVD"
expr_stmt|;
comment|/* FALLTHROUGH */
endif|#
directive|endif
case|case
name|IN24XX_LINK_RESET
case|:
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
name|msg
operator|=
literal|"LINK RESET"
expr_stmt|;
case|case
name|IN24XX_LINK_FAILED
case|:
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
name|msg
operator|=
literal|"LINK FAILED"
expr_stmt|;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d %s"
argument_list|,
name|chan
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_TARGET_NOTIFY_ACK
argument_list|,
name|inot
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


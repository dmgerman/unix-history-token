begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  *  Copyright (c) 1997-2009 by Matthew Jacob  *  All rights reserved.  *  *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  *  THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND  *  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *  ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  *  DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  *  OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  *  HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  *  SUCH DAMAGE.  *  */
end_comment

begin_comment
comment|/*  * Machine and OS Independent (well, as best as possible)  * code for the Qlogic ISP SCSI and FC-SCSI adapters.  */
end_comment

begin_comment
comment|/*  * Inspiration and ideas about this driver are from Erik Moe's Linux driver  * (qlogicisp.c) and Dave Miller's SBus version of same (qlogicisp.c). Some  * ideas dredged from the Solaris driver.  */
end_comment

begin_comment
comment|/*  * Include header file appropriate for platform we're building on.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__KERNEL_RCSID
argument_list|(
literal|0
argument_list|,
literal|"$NetBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/ic/isp_netbsd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/isp/isp_freebsd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__OpenBSD__
end_ifdef

begin_include
include|#
directive|include
file|<dev/ic/isp_openbsd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__linux__
end_ifdef

begin_include
include|#
directive|include
file|"isp_linux.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__svr4__
end_ifdef

begin_include
include|#
directive|include
file|"isp_solaris.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * General defines  */
end_comment

begin_define
define|#
directive|define
name|MBOX_DELAY_COUNT
value|1000000 / 100
end_define

begin_define
define|#
directive|define
name|ISP_MARK_PORTDB
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
define|\
value|isp_prt(isp, ISP_LOG_SANCFG, 				\ 	"Chan %d ISP_MARK_PORTDB@LINE %d", b, __LINE__);	\     isp_mark_portdb(a, b, c)
end_define

begin_comment
comment|/*  * Local static data  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|fconf
index|[]
init|=
literal|"Chan %d PortDB[%d] changed:\n current =(0x%x@0x%06x 0x%08x%08x 0x%08x%08x)\n database=(0x%x@0x%06x 0x%08x%08x 0x%08x%08x)"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|notresp
index|[]
init|=
literal|"Not RESPONSE in RESPONSE Queue (type 0x%x) @ idx %d (next %d) nlooked %d"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|topology
index|[]
init|=
literal|"Chan %d WWPN 0x%08x%08x PortID 0x%06x N-Port Handle %d, Connection '%s'"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|bun
index|[]
init|=
literal|"bad underrun (count %d, resid %d, status %s)"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|lipd
index|[]
init|=
literal|"Chan %d LIP destroyed %d active commands"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|sacq
index|[]
init|=
literal|"unable to acquire scratch area"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint8_t
name|alpa_map
index|[]
init|=
block|{
literal|0xef
block|,
literal|0xe8
block|,
literal|0xe4
block|,
literal|0xe2
block|,
literal|0xe1
block|,
literal|0xe0
block|,
literal|0xdc
block|,
literal|0xda
block|,
literal|0xd9
block|,
literal|0xd6
block|,
literal|0xd5
block|,
literal|0xd4
block|,
literal|0xd3
block|,
literal|0xd2
block|,
literal|0xd1
block|,
literal|0xce
block|,
literal|0xcd
block|,
literal|0xcc
block|,
literal|0xcb
block|,
literal|0xca
block|,
literal|0xc9
block|,
literal|0xc7
block|,
literal|0xc6
block|,
literal|0xc5
block|,
literal|0xc3
block|,
literal|0xbc
block|,
literal|0xba
block|,
literal|0xb9
block|,
literal|0xb6
block|,
literal|0xb5
block|,
literal|0xb4
block|,
literal|0xb3
block|,
literal|0xb2
block|,
literal|0xb1
block|,
literal|0xae
block|,
literal|0xad
block|,
literal|0xac
block|,
literal|0xab
block|,
literal|0xaa
block|,
literal|0xa9
block|,
literal|0xa7
block|,
literal|0xa6
block|,
literal|0xa5
block|,
literal|0xa3
block|,
literal|0x9f
block|,
literal|0x9e
block|,
literal|0x9d
block|,
literal|0x9b
block|,
literal|0x98
block|,
literal|0x97
block|,
literal|0x90
block|,
literal|0x8f
block|,
literal|0x88
block|,
literal|0x84
block|,
literal|0x82
block|,
literal|0x81
block|,
literal|0x80
block|,
literal|0x7c
block|,
literal|0x7a
block|,
literal|0x79
block|,
literal|0x76
block|,
literal|0x75
block|,
literal|0x74
block|,
literal|0x73
block|,
literal|0x72
block|,
literal|0x71
block|,
literal|0x6e
block|,
literal|0x6d
block|,
literal|0x6c
block|,
literal|0x6b
block|,
literal|0x6a
block|,
literal|0x69
block|,
literal|0x67
block|,
literal|0x66
block|,
literal|0x65
block|,
literal|0x63
block|,
literal|0x5c
block|,
literal|0x5a
block|,
literal|0x59
block|,
literal|0x56
block|,
literal|0x55
block|,
literal|0x54
block|,
literal|0x53
block|,
literal|0x52
block|,
literal|0x51
block|,
literal|0x4e
block|,
literal|0x4d
block|,
literal|0x4c
block|,
literal|0x4b
block|,
literal|0x4a
block|,
literal|0x49
block|,
literal|0x47
block|,
literal|0x46
block|,
literal|0x45
block|,
literal|0x43
block|,
literal|0x3c
block|,
literal|0x3a
block|,
literal|0x39
block|,
literal|0x36
block|,
literal|0x35
block|,
literal|0x34
block|,
literal|0x33
block|,
literal|0x32
block|,
literal|0x31
block|,
literal|0x2e
block|,
literal|0x2d
block|,
literal|0x2c
block|,
literal|0x2b
block|,
literal|0x2a
block|,
literal|0x29
block|,
literal|0x27
block|,
literal|0x26
block|,
literal|0x25
block|,
literal|0x23
block|,
literal|0x1f
block|,
literal|0x1e
block|,
literal|0x1d
block|,
literal|0x1b
block|,
literal|0x18
block|,
literal|0x17
block|,
literal|0x10
block|,
literal|0x0f
block|,
literal|0x08
block|,
literal|0x04
block|,
literal|0x02
block|,
literal|0x01
block|,
literal|0x00
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Local function prototypes.  */
end_comment

begin_function_decl
specifier|static
name|int
name|isp_parse_async
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_parse_async_fc
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_handle_other_response
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|isphdr_t
modifier|*
parameter_list|,
name|uint32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_parse_status
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|ispstatusreq_t
modifier|*
parameter_list|,
name|XS_T
modifier|*
parameter_list|,
name|long
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_parse_status_24xx
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|isp24xx_statusreq_t
modifier|*
parameter_list|,
name|XS_T
modifier|*
parameter_list|,
name|long
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_fastpost_complete
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_mbox_continue
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_scsi_init
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_scsi_channel_init
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_fibre_init
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_fibre_init_2400
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_mark_portdb
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_plogx
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_port_login
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_port_logout
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_getpdb
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
parameter_list|,
name|isp_pdb_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_dump_chip_portdb
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint64_t
name|isp_get_wwn
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_fclink_test
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_pdb_sync
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_scan_loop
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_gid_ft_sns
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_gid_ft_ct_passthru
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_scan_fabric
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_login_device
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint32_t
parameter_list|,
name|isp_pdb_t
modifier|*
parameter_list|,
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_register_fc4_type
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_register_fc4_type_24xx
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|isp_nxt_handle
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_fw_state
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_mboxcmd_qnw
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|mbreg_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_mboxcmd
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|mbreg_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_spi_update
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_setdfltsdparm
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_setdfltfcparm
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_read_nvram
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_read_nvram_2400
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_rdnvram_word
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_rd_2400_nvram
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_parse_nvram_1020
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_parse_nvram_1080
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_parse_nvram_12160
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_parse_nvram_2100
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_parse_nvram_2400
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Reset Hardware.  *  * Hit the chip over the head, download new f/w if available and set it running.  *  * Locking done elsewhere.  */
end_comment

begin_function
name|void
name|isp_reset
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|do_load_defaults
parameter_list|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|uint64_t
name|fwt
decl_stmt|;
name|uint32_t
name|code_org
decl_stmt|,
name|val
decl_stmt|;
name|int
name|loops
decl_stmt|,
name|i
decl_stmt|,
name|dodnld
init|=
literal|1
decl_stmt|;
specifier|const
name|char
modifier|*
name|btype
init|=
literal|"????"
decl_stmt|;
specifier|static
specifier|const
name|char
name|dcrc
index|[]
init|=
literal|"Downloaded RISC Code Checksum Failure"
decl_stmt|;
name|isp
operator|->
name|isp_state
operator|=
name|ISP_NILSTATE
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dead
condition|)
block|{
name|isp_shutdown
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|ISP_DISABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Basic types (SCSI, FibreChannel and PCI or SBus) 	 * have been set in the MD code. We figure out more 	 * here. Possibly more refined types based upon PCI 	 * identification. Chip revision has been gathered. 	 * 	 * After we've fired this chip up, zero out the conf1 register 	 * for SCSI adapters and do other settings for the 2100. 	 */
name|ISP_DISABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
comment|/* 	 * Pick an initial maxcmds value which will be used 	 * to allocate xflist pointer space. It may be changed 	 * later by the firmware. 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp
operator|->
name|isp_maxcmds
operator|=
literal|4096
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_2322
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp
operator|->
name|isp_maxcmds
operator|=
literal|2048
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_23XX
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_2200
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp
operator|->
name|isp_maxcmds
operator|=
literal|1024
expr_stmt|;
block|}
else|else
block|{
name|isp
operator|->
name|isp_maxcmds
operator|=
literal|512
expr_stmt|;
block|}
comment|/* 	 * Set up DMA for the request and response queues. 	 * 	 * We do this now so we can use the request queue 	 * for dma to load firmware from. 	 */
if|if
condition|(
name|ISP_MBOXDMASETUP
argument_list|(
name|isp
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Cannot setup DMA"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Set up default request/response queue in-pointer/out-pointer 	 * register indices. 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp
operator|->
name|isp_rqstinrp
operator|=
name|BIU2400_REQINP
expr_stmt|;
name|isp
operator|->
name|isp_rqstoutrp
operator|=
name|BIU2400_REQOUTP
expr_stmt|;
name|isp
operator|->
name|isp_respinrp
operator|=
name|BIU2400_RSPINP
expr_stmt|;
name|isp
operator|->
name|isp_respoutrp
operator|=
name|BIU2400_RSPOUTP
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_23XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp
operator|->
name|isp_rqstinrp
operator|=
name|BIU_REQINP
expr_stmt|;
name|isp
operator|->
name|isp_rqstoutrp
operator|=
name|BIU_REQOUTP
expr_stmt|;
name|isp
operator|->
name|isp_respinrp
operator|=
name|BIU_RSPINP
expr_stmt|;
name|isp
operator|->
name|isp_respoutrp
operator|=
name|BIU_RSPOUTP
expr_stmt|;
block|}
else|else
block|{
name|isp
operator|->
name|isp_rqstinrp
operator|=
name|INMAILBOX4
expr_stmt|;
name|isp
operator|->
name|isp_rqstoutrp
operator|=
name|OUTMAILBOX4
expr_stmt|;
name|isp
operator|->
name|isp_respinrp
operator|=
name|OUTMAILBOX5
expr_stmt|;
name|isp
operator|->
name|isp_respoutrp
operator|=
name|INMAILBOX5
expr_stmt|;
block|}
comment|/* 	 * Put the board into PAUSE mode (so we can read the SXP registers 	 * or write FPM/FBM registers). 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_CLEAR_HOST_INT
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_CLEAR_RISC_INT
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_PAUSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_PAUSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|isp
operator|->
name|isp_type
condition|)
block|{
case|case
name|ISP_HA_FC_2100
case|:
name|btype
operator|=
literal|"2100"
expr_stmt|;
break|break;
case|case
name|ISP_HA_FC_2200
case|:
name|btype
operator|=
literal|"2200"
expr_stmt|;
break|break;
case|case
name|ISP_HA_FC_2300
case|:
name|btype
operator|=
literal|"2300"
expr_stmt|;
break|break;
case|case
name|ISP_HA_FC_2312
case|:
name|btype
operator|=
literal|"2312"
expr_stmt|;
break|break;
case|case
name|ISP_HA_FC_2322
case|:
name|btype
operator|=
literal|"2322"
expr_stmt|;
break|break;
case|case
name|ISP_HA_FC_2400
case|:
name|btype
operator|=
literal|"2422"
expr_stmt|;
break|break;
case|case
name|ISP_HA_FC_2500
case|:
name|btype
operator|=
literal|"2532"
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
operator|!
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* 			 * While we're paused, reset the FPM module and FBM 			 * fifos. 			 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|,
name|BIU2100_FPM0_REGS
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|FPM_DIAG_CONFIG
argument_list|,
name|FPM_SOFT_RESET
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|,
name|BIU2100_FB_REGS
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|FBM_CMD
argument_list|,
name|FBMCMD_FIFO_RESET_ALL
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|,
name|BIU2100_RISC_REGS
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|IS_1240
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|sdparam
modifier|*
name|sdp
decl_stmt|;
name|btype
operator|=
literal|"1240"
expr_stmt|;
name|isp
operator|->
name|isp_clock
operator|=
literal|60
expr_stmt|;
name|sdp
operator|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_ultramode
operator|=
literal|1
expr_stmt|;
name|sdp
operator|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_ultramode
operator|=
literal|1
expr_stmt|;
comment|/* 		 * XXX: Should probably do some bus sensing. 		 */
block|}
elseif|else
if|if
condition|(
name|IS_ULTRA3
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|sdparam
modifier|*
name|sdp
init|=
name|isp
operator|->
name|isp_param
decl_stmt|;
name|isp
operator|->
name|isp_clock
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|IS_10160
argument_list|(
name|isp
argument_list|)
condition|)
name|btype
operator|=
literal|"10160"
expr_stmt|;
elseif|else
if|if
condition|(
name|IS_12160
argument_list|(
name|isp
argument_list|)
condition|)
name|btype
operator|=
literal|"12160"
expr_stmt|;
else|else
name|btype
operator|=
literal|"<UNKLVD>"
expr_stmt|;
name|sdp
operator|->
name|isp_lvdmode
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|IS_DUALBUS
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|sdp
operator|++
expr_stmt|;
name|sdp
operator|->
name|isp_lvdmode
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|IS_ULTRA2
argument_list|(
name|isp
argument_list|)
condition|)
block|{
specifier|static
specifier|const
name|char
name|m
index|[]
init|=
literal|"bus %d is in %s Mode"
decl_stmt|;
name|uint16_t
name|l
decl_stmt|;
name|sdparam
modifier|*
name|sdp
init|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|isp
operator|->
name|isp_clock
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|IS_1280
argument_list|(
name|isp
argument_list|)
condition|)
name|btype
operator|=
literal|"1280"
expr_stmt|;
elseif|else
if|if
condition|(
name|IS_1080
argument_list|(
name|isp
argument_list|)
condition|)
name|btype
operator|=
literal|"1080"
expr_stmt|;
else|else
name|btype
operator|=
literal|"<UNKLVD>"
expr_stmt|;
name|l
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|SXP_PINS_DIFF
argument_list|)
operator|&
name|ISP1080_MODE_MASK
expr_stmt|;
switch|switch
condition|(
name|l
condition|)
block|{
case|case
name|ISP1080_LVD_MODE
case|:
name|sdp
operator|->
name|isp_lvdmode
operator|=
literal|1
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
name|m
argument_list|,
literal|0
argument_list|,
literal|"LVD"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISP1080_HVD_MODE
case|:
name|sdp
operator|->
name|isp_diffmode
operator|=
literal|1
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
name|m
argument_list|,
literal|0
argument_list|,
literal|"Differential"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISP1080_SE_MODE
case|:
name|sdp
operator|->
name|isp_ultramode
operator|=
literal|1
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
name|m
argument_list|,
literal|0
argument_list|,
literal|"Single-Ended"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"unknown mode on bus %d (0x%x)"
argument_list|,
literal|0
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|IS_DUALBUS
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|sdp
operator|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|l
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|SXP_PINS_DIFF
operator||
name|SXP_BANK1_SELECT
argument_list|)
expr_stmt|;
name|l
operator|&=
name|ISP1080_MODE_MASK
expr_stmt|;
switch|switch
condition|(
name|l
condition|)
block|{
case|case
name|ISP1080_LVD_MODE
case|:
name|sdp
operator|->
name|isp_lvdmode
operator|=
literal|1
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
name|m
argument_list|,
literal|1
argument_list|,
literal|"LVD"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISP1080_HVD_MODE
case|:
name|sdp
operator|->
name|isp_diffmode
operator|=
literal|1
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
name|m
argument_list|,
literal|1
argument_list|,
literal|"Differential"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISP1080_SE_MODE
case|:
name|sdp
operator|->
name|isp_ultramode
operator|=
literal|1
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
name|m
argument_list|,
literal|1
argument_list|,
literal|"Single-Ended"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"unknown mode on bus %d (0x%x)"
argument_list|,
literal|1
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
name|sdparam
modifier|*
name|sdp
init|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|i
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_CONF0
argument_list|)
operator|&
name|BIU_CONF0_HW_MASK
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGALL
argument_list|,
literal|"Unknown Chip Type 0x%x"
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
literal|1
case|:
name|btype
operator|=
literal|"1020"
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1020
expr_stmt|;
name|isp
operator|->
name|isp_clock
operator|=
literal|40
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* 			 * Some 1020A chips are Ultra Capable, but don't 			 * run the clock rate up for that unless told to 			 * do so by the Ultra Capable bits being set. 			 */
name|btype
operator|=
literal|"1020A"
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1020A
expr_stmt|;
name|isp
operator|->
name|isp_clock
operator|=
literal|40
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|btype
operator|=
literal|"1040"
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1040
expr_stmt|;
name|isp
operator|->
name|isp_clock
operator|=
literal|60
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|btype
operator|=
literal|"1040A"
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1040A
expr_stmt|;
name|isp
operator|->
name|isp_clock
operator|=
literal|60
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|btype
operator|=
literal|"1040B"
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1040B
expr_stmt|;
name|isp
operator|->
name|isp_clock
operator|=
literal|60
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|btype
operator|=
literal|"1040C"
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1040C
expr_stmt|;
name|isp
operator|->
name|isp_clock
operator|=
literal|60
expr_stmt|;
break|break;
block|}
comment|/* 		 * Now, while we're at it, gather info about ultra 		 * and/or differential mode. 		 */
if|if
condition|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|SXP_PINS_DIFF
argument_list|)
operator|&
name|SXP_PINS_DIFF_MODE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"Differential Mode"
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_diffmode
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sdp
operator|->
name|isp_diffmode
operator|=
literal|0
expr_stmt|;
block|}
name|i
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|RISC_PSR
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_bustype
operator|==
name|ISP_BT_SBUS
condition|)
block|{
name|i
operator|&=
name|RISC_PSR_SBUS_ULTRA
expr_stmt|;
block|}
else|else
block|{
name|i
operator|&=
name|RISC_PSR_PCI_ULTRA
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"Ultra Mode Capable"
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_ultramode
operator|=
literal|1
expr_stmt|;
comment|/* 			 * If we're in Ultra Mode, we have to be 60MHz clock- 			 * even for the SBus version. 			 */
name|isp
operator|->
name|isp_clock
operator|=
literal|60
expr_stmt|;
block|}
else|else
block|{
name|sdp
operator|->
name|isp_ultramode
operator|=
literal|0
expr_stmt|;
comment|/* 			 * Clock is known. Gronk. 			 */
block|}
comment|/* 		 * Machine dependent clock (if set) overrides 		 * our generic determinations. 		 */
if|if
condition|(
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_clock
condition|)
block|{
if|if
condition|(
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_clock
operator|<
name|isp
operator|->
name|isp_clock
condition|)
block|{
name|isp
operator|->
name|isp_clock
operator|=
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_clock
expr_stmt|;
block|}
block|}
block|}
comment|/* 	 * Clear instrumentation 	 */
name|isp
operator|->
name|isp_intcnt
operator|=
name|isp
operator|->
name|isp_intbogus
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Do MD specific pre initialization 	 */
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
comment|/* 	 * Hit the chip over the head with hammer, 	 * and give it a chance to recover. 	 */
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_ICR
argument_list|,
name|BIU_ICR_SOFT_RESET
argument_list|)
expr_stmt|;
comment|/* 		 * A slight delay... 		 */
name|ISP_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* 		 * Clear data&& control DMA engines. 		 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|CDMA_CONTROL
argument_list|,
name|DMA_CNTRL_CLEAR_CHAN
operator||
name|DMA_CNTRL_RESET_INT
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|DDMA_CONTROL
argument_list|,
name|DMA_CNTRL_CLEAR_CHAN
operator||
name|DMA_CNTRL_RESET_INT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* 		 * Stop DMA and wait for it to stop. 		 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_CSR
argument_list|,
name|BIU2400_DMA_STOP
operator||
operator|(
literal|3
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|val
operator|=
name|loops
operator|=
literal|0
init|;
name|loops
operator|<
literal|30000
condition|;
name|loops
operator|++
control|)
block|{
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|val
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU2400_CSR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|BIU2400_DMA_ACTIVE
operator|)
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|val
operator|&
name|BIU2400_DMA_ACTIVE
condition|)
block|{
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"DMA Failed to Stop on Reset"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * Hold it in SOFT_RESET and STOP state for 100us. 		 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_CSR
argument_list|,
name|BIU2400_SOFT_RESET
operator||
name|BIU2400_DMA_STOP
operator||
operator|(
literal|3
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|ISP_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
for|for
control|(
name|loops
operator|=
literal|0
init|;
name|loops
operator|<
literal|10000
condition|;
name|loops
operator|++
control|)
block|{
name|ISP_DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|val
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|val
operator|=
name|loops
operator|=
literal|0
init|;
name|loops
operator|<
literal|500000
condition|;
name|loops
operator|++
control|)
block|{
name|val
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU2400_CSR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|BIU2400_SOFT_RESET
operator|)
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|val
operator|&
name|BIU2400_SOFT_RESET
condition|)
block|{
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Failed to come out of reset"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|,
name|BIU2100_SOFT_RESET
argument_list|)
expr_stmt|;
comment|/* 		 * A slight delay... 		 */
name|ISP_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* 		 * Clear data&& control DMA engines. 		 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|CDMA2100_CONTROL
argument_list|,
name|DMA_CNTRL2100_CLEAR_CHAN
operator||
name|DMA_CNTRL2100_RESET_INT
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|TDMA2100_CONTROL
argument_list|,
name|DMA_CNTRL2100_CLEAR_CHAN
operator||
name|DMA_CNTRL2100_RESET_INT
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|RDMA2100_CONTROL
argument_list|,
name|DMA_CNTRL2100_CLEAR_CHAN
operator||
name|DMA_CNTRL2100_RESET_INT
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Wait for ISP to be ready to go... 	 */
name|loops
operator|=
name|MBOX_DELAY_COUNT
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_ICR
argument_list|)
operator|&
name|BIU_ICR_SOFT_RESET
operator|)
condition|)
block|{
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|)
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|)
operator|&
name|BIU2100_SOFT_RESET
operator|)
condition|)
break|break;
block|}
name|ISP_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|loops
operator|<
literal|0
condition|)
block|{
name|ISP_DUMPREGS
argument_list|(
name|isp
argument_list|,
literal|"chip reset timed out"
argument_list|)
expr_stmt|;
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* 	 * After we've fired this chip up, zero out the conf1 register 	 * for SCSI adapters and other settings for the 2100. 	 */
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Reset RISC Processor 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_RESET
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_RELEASE
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_CLEAR_RESET
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_RESET
argument_list|)
expr_stmt|;
name|ISP_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Post-RISC Reset stuff. 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
for|for
control|(
name|val
operator|=
name|loops
operator|=
literal|0
init|;
name|loops
operator|<
literal|5000000
condition|;
name|loops
operator|++
control|)
block|{
name|ISP_DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|val
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|val
operator|!=
literal|0
condition|)
block|{
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"reset didn't clear"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|uint16_t
name|tmp
init|=
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_conf1
decl_stmt|;
comment|/* 		 * Busted FIFO. Turn off all but burst enables. 		 */
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|==
name|ISP_HA_SCSI_1040A
condition|)
block|{
name|tmp
operator|&=
name|BIU_BURST_ENABLE
expr_stmt|;
block|}
name|ISP_SETBITS
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|BIU_BURST_ENABLE
condition|)
block|{
name|ISP_SETBITS
argument_list|(
name|isp
argument_list|,
name|CDMA_CONF
argument_list|,
name|DMA_ENABLE_BURST
argument_list|)
expr_stmt|;
name|ISP_SETBITS
argument_list|(
name|isp
argument_list|,
name|DDMA_CONF
argument_list|,
name|DMA_ENABLE_BURST
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|isp_ptisp
condition|)
block|{
if|if
condition|(
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|isp_ultramode
condition|)
block|{
while|while
condition|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|RISC_MTR
argument_list|)
operator|!=
literal|0x1313
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|RISC_MTR
argument_list|,
literal|0x1313
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_STEP
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|RISC_MTR
argument_list|,
literal|0x1212
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * PTI specific register 			 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|RISC_EMB
argument_list|,
name|DUAL_BANK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|RISC_MTR
argument_list|,
literal|0x1212
argument_list|)
expr_stmt|;
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_RELEASE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|RISC_MTR2100
argument_list|,
literal|0x1212
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_2200
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_23XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_2X00_DISABLE_PARITY_PAUSE
argument_list|)
expr_stmt|;
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_RELEASE
argument_list|)
expr_stmt|;
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_rqstinrp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_rqstoutrp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_respinrp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_respoutrp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_PRI_REQINP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_PRI_REQOUTP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_ATIO_RSPINP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_ATIO_RSPOUTP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Do MD specific post initialization 	 */
name|ISP_RESET1
argument_list|(
name|isp
argument_list|)
expr_stmt|;
comment|/* 	 * Wait for everything to finish firing up. 	 * 	 * Avoid doing this on early 2312s because you can generate a PCI 	 * parity error (chip breakage). 	 */
if|if
condition|(
name|IS_2312
argument_list|(
name|isp
argument_list|)
operator|&&
name|isp
operator|->
name|isp_revision
operator|<
literal|2
condition|)
block|{
name|ISP_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|loops
operator|=
name|MBOX_DELAY_COUNT
expr_stmt|;
while|while
condition|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|)
operator|==
name|MBOX_BUSY
condition|)
block|{
name|ISP_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|loops
operator|<
literal|0
condition|)
block|{
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"MBOX_BUSY never cleared on reset"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
comment|/* 	 * Up until this point we've done everything by just reading or 	 * setting registers. From this point on we rely on at least *some* 	 * kind of firmware running in the card. 	 */
comment|/* 	 * Do some sanity checking by running a NOP command. 	 * If it succeeds, the ROM firmware is now running. 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_NO_OP
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"NOP command failed (%x)"
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Do some operational tests 	 */
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
specifier|static
specifier|const
name|uint16_t
name|patterns
index|[
name|MAX_MAILBOX
index|]
init|=
block|{
literal|0x0000
block|,
literal|0xdead
block|,
literal|0xbeef
block|,
literal|0xffff
block|,
literal|0xa5a5
block|,
literal|0x5a5a
block|,
literal|0x7f7f
block|,
literal|0x7ff7
block|,
literal|0x3421
block|,
literal|0xabcd
block|,
literal|0xdcba
block|,
literal|0xfeef
block|,
literal|0xbead
block|,
literal|0xdebe
block|,
literal|0x2222
block|,
literal|0x3333
block|,
literal|0x5555
block|,
literal|0x6666
block|,
literal|0x7777
block|,
literal|0xaaaa
block|,
literal|0xffff
block|,
literal|0xdddd
block|,
literal|0x9999
block|,
literal|0x1fbc
block|,
literal|0x6666
block|,
literal|0x6677
block|,
literal|0x1122
block|,
literal|0x33ff
block|,
literal|0x0000
block|,
literal|0x0001
block|,
literal|0x1000
block|,
literal|0x1010
block|, 		}
decl_stmt|;
name|int
name|nmbox
init|=
name|ISP_NMBOX
argument_list|(
name|isp
argument_list|)
decl_stmt|;
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
name|nmbox
operator|=
literal|6
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_MAILBOX_REG_TEST
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|nmbox
condition|;
name|i
operator|++
control|)
block|{
name|mbs
operator|.
name|param
index|[
name|i
index|]
operator|=
name|patterns
index|[
name|i
index|]
expr_stmt|;
block|}
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|nmbox
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mbs
operator|.
name|param
index|[
name|i
index|]
operator|!=
name|patterns
index|[
name|i
index|]
condition|)
block|{
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Register Test Failed at Register %d: should have 0x%04x but got 0x%04x"
argument_list|,
name|i
argument_list|,
name|patterns
index|[
name|i
index|]
argument_list|,
name|mbs
operator|.
name|param
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
comment|/* 	 * Download new Firmware, unless requested not to do so. 	 * This is made slightly trickier in some cases where the 	 * firmware of the ROM revision is newer than the revision 	 * compiled into the driver. So, where we used to compare 	 * versions of our f/w and the ROM f/w, now we just see 	 * whether we have f/w at all and whether a config flag 	 * has disabled our download. 	 */
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_ispfw
operator|==
name|NULL
operator|)
operator|||
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_NORELOAD
operator|)
condition|)
block|{
name|dodnld
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|code_org
operator|=
name|ISP_CODE_ORG_2400
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_23XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|code_org
operator|=
name|ISP_CODE_ORG_2300
expr_stmt|;
block|}
else|else
block|{
name|code_org
operator|=
name|ISP_CODE_ORG
expr_stmt|;
block|}
if|if
condition|(
name|dodnld
operator|&&
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
specifier|const
name|uint32_t
modifier|*
name|ptr
init|=
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_ispfw
decl_stmt|;
name|int
name|wordload
decl_stmt|;
comment|/* 		 * Keep loading until we run out of f/w. 		 */
name|code_org
operator|=
name|ptr
index|[
literal|2
index|]
expr_stmt|;
comment|/* 1st load address is our start addr */
name|wordload
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|uint32_t
name|la
decl_stmt|,
name|wi
decl_stmt|,
name|wl
decl_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"load 0x%x words of code at load address 0x%x"
argument_list|,
name|ptr
index|[
literal|3
index|]
argument_list|,
name|ptr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|wi
operator|=
literal|0
expr_stmt|;
name|la
operator|=
name|ptr
index|[
literal|2
index|]
expr_stmt|;
name|wl
operator|=
name|ptr
index|[
literal|3
index|]
expr_stmt|;
while|while
condition|(
name|wi
operator|<
name|ptr
index|[
literal|3
index|]
condition|)
block|{
name|uint32_t
modifier|*
name|cp
decl_stmt|;
name|uint32_t
name|nw
decl_stmt|;
name|nw
operator|=
name|ISP_QUEUE_SIZE
argument_list|(
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
operator|>>
literal|2
expr_stmt|;
if|if
condition|(
name|nw
operator|>
name|wl
condition|)
block|{
name|nw
operator|=
name|wl
expr_stmt|;
block|}
name|cp
operator|=
name|isp
operator|->
name|isp_rquest
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nw
condition|;
name|i
operator|++
control|)
block|{
name|ISP_IOXPUT_32
argument_list|(
name|isp
argument_list|,
name|ptr
index|[
name|wi
operator|++
index|]
argument_list|,
operator|&
name|cp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|wl
operator|--
expr_stmt|;
block|}
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REQUEST
argument_list|,
literal|0
argument_list|,
name|ISP_QUEUE_SIZE
argument_list|(
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|again
label|:
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
literal|0
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|la
operator|<
literal|0x10000
operator|&&
name|nw
operator|<
literal|0x10000
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_LOAD_RISC_RAM_2100
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|la
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|=
name|nw
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"LOAD RISC RAM 2100 %u words at load address 0x%x"
argument_list|,
name|nw
argument_list|,
name|la
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wordload
condition|)
block|{
union|union
block|{
specifier|const
name|uint32_t
modifier|*
name|cp
decl_stmt|;
name|uint32_t
modifier|*
name|np
decl_stmt|;
block|}
name|ucd
union|;
name|ucd
operator|.
name|cp
operator|=
operator|(
specifier|const
name|uint32_t
operator|*
operator|)
name|cp
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_WRITE_RAM_WORD_EXTENDED
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|la
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
operator|(
operator|*
name|ucd
operator|.
name|np
operator|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
operator|(
operator|*
name|ucd
operator|.
name|np
operator|)
operator|>>
literal|16
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|8
index|]
operator|=
name|la
operator|>>
literal|16
expr_stmt|;
name|isp
operator|->
name|isp_mbxwrk0
operator|=
name|nw
operator|-
literal|1
expr_stmt|;
name|isp
operator|->
name|isp_mbxworkp
operator|=
name|ucd
operator|.
name|np
operator|+
literal|1
expr_stmt|;
name|isp
operator|->
name|isp_mbxwrk1
operator|=
operator|(
name|la
operator|+
literal|1
operator|)
expr_stmt|;
name|isp
operator|->
name|isp_mbxwrk8
operator|=
operator|(
name|la
operator|+
literal|1
operator|)
operator|>>
literal|16
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"WRITE RAM WORD EXTENDED %u words at load address 0x%x"
argument_list|,
name|nw
argument_list|,
name|la
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_LOAD_RISC_RAM
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|la
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|=
name|nw
operator|>>
literal|16
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|5
index|]
operator|=
name|nw
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|8
index|]
operator|=
name|la
operator|>>
literal|16
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"LOAD RISC RAM %u words at load address 0x%x"
argument_list|,
name|nw
argument_list|,
name|la
argument_list|)
expr_stmt|;
block|}
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|==
name|MBOX_HOST_INTERFACE_ERROR
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"switching to word load"
argument_list|)
expr_stmt|;
name|wordload
operator|=
literal|1
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"F/W Risc Ram Load Failed"
argument_list|)
expr_stmt|;
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
name|la
operator|+=
name|nw
expr_stmt|;
block|}
if|if
condition|(
name|ptr
index|[
literal|1
index|]
operator|==
literal|0
condition|)
block|{
break|break;
block|}
name|ptr
operator|+=
name|ptr
index|[
literal|3
index|]
expr_stmt|;
block|}
name|isp
operator|->
name|isp_loaded_fw
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dodnld
operator|&&
name|IS_23XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
specifier|const
name|uint16_t
modifier|*
name|ptr
init|=
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_ispfw
decl_stmt|;
name|uint16_t
name|wi
decl_stmt|,
name|wl
decl_stmt|,
name|segno
decl_stmt|;
name|uint32_t
name|la
decl_stmt|;
name|la
operator|=
name|code_org
expr_stmt|;
name|segno
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|uint32_t
name|nxtaddr
decl_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"load 0x%x words of code at load address 0x%x"
argument_list|,
name|ptr
index|[
literal|3
index|]
argument_list|,
name|la
argument_list|)
expr_stmt|;
name|wi
operator|=
literal|0
expr_stmt|;
name|wl
operator|=
name|ptr
index|[
literal|3
index|]
expr_stmt|;
while|while
condition|(
name|wi
operator|<
name|ptr
index|[
literal|3
index|]
condition|)
block|{
name|uint16_t
modifier|*
name|cp
decl_stmt|;
name|uint16_t
name|nw
decl_stmt|;
name|nw
operator|=
name|ISP_QUEUE_SIZE
argument_list|(
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|nw
operator|>
name|wl
condition|)
block|{
name|nw
operator|=
name|wl
expr_stmt|;
block|}
if|if
condition|(
name|nw
operator|>
operator|(
literal|1
operator|<<
literal|15
operator|)
condition|)
block|{
name|nw
operator|=
literal|1
operator|<<
literal|15
expr_stmt|;
block|}
name|cp
operator|=
name|isp
operator|->
name|isp_rquest
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nw
condition|;
name|i
operator|++
control|)
block|{
name|ISP_IOXPUT_16
argument_list|(
name|isp
argument_list|,
name|ptr
index|[
name|wi
operator|++
index|]
argument_list|,
operator|&
name|cp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|wl
operator|--
expr_stmt|;
block|}
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REQUEST
argument_list|,
literal|0
argument_list|,
name|ISP_QUEUE_SIZE
argument_list|(
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
literal|0
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|la
operator|<
literal|0x10000
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_LOAD_RISC_RAM_2100
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|la
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|=
name|nw
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"LOAD RISC RAM 2100 %u words at load address 0x%x\n"
argument_list|,
name|nw
argument_list|,
name|la
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_LOAD_RISC_RAM
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|la
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|=
name|nw
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|8
index|]
operator|=
name|la
operator|>>
literal|16
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"LOAD RISC RAM %u words at load address 0x%x\n"
argument_list|,
name|nw
argument_list|,
name|la
argument_list|)
expr_stmt|;
block|}
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"F/W Risc Ram Load Failed"
argument_list|)
expr_stmt|;
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
name|la
operator|+=
name|nw
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|IS_2322
argument_list|(
name|isp
argument_list|)
condition|)
block|{
break|break;
block|}
if|if
condition|(
operator|++
name|segno
operator|==
literal|3
condition|)
block|{
break|break;
block|}
comment|/* 			 * If we're a 2322, the firmware actually comes in 			 * three chunks. We loaded the first at the code_org 			 * address. The other two chunks, which follow right 			 * after each other in memory here, get loaded at 			 * addresses specfied at offset 0x9..0xB. 			 */
name|nxtaddr
operator|=
name|ptr
index|[
literal|3
index|]
expr_stmt|;
name|ptr
operator|=
operator|&
name|ptr
index|[
name|nxtaddr
index|]
expr_stmt|;
name|la
operator|=
name|ptr
index|[
literal|5
index|]
operator||
operator|(
operator|(
name|ptr
index|[
literal|4
index|]
operator|&
literal|0x3f
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
block|}
name|isp
operator|->
name|isp_loaded_fw
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dodnld
condition|)
block|{
union|union
block|{
specifier|const
name|uint16_t
modifier|*
name|cp
decl_stmt|;
name|uint16_t
modifier|*
name|np
decl_stmt|;
block|}
name|ucd
union|;
name|ucd
operator|.
name|cp
operator|=
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_ispfw
expr_stmt|;
name|isp
operator|->
name|isp_mbxworkp
operator|=
operator|&
name|ucd
operator|.
name|np
index|[
literal|1
index|]
expr_stmt|;
name|isp
operator|->
name|isp_mbxwrk0
operator|=
name|ucd
operator|.
name|np
index|[
literal|3
index|]
operator|-
literal|1
expr_stmt|;
name|isp
operator|->
name|isp_mbxwrk1
operator|=
name|code_org
operator|+
literal|1
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_WRITE_RAM_WORD
argument_list|,
name|MBLOGNONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|code_org
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|ucd
operator|.
name|np
index|[
literal|0
index|]
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"WRITE RAM %u words at load address 0x%x"
argument_list|,
name|ucd
operator|.
name|np
index|[
literal|3
index|]
argument_list|,
name|code_org
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"F/W download failed at word %d"
argument_list|,
name|isp
operator|->
name|isp_mbxwrk1
operator|-
name|code_org
argument_list|)
expr_stmt|;
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|isp
operator|->
name|isp_loaded_fw
operator|=
literal|0
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG2
argument_list|,
literal|"skipping f/w download"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * If we loaded firmware, verify its checksum 	 */
if|if
condition|(
name|isp
operator|->
name|isp_loaded_fw
condition|)
block|{
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_VERIFY_CHECKSUM
argument_list|,
name|MBLOGNONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_VERIFY_CHECKSUM
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|code_org
operator|>>
literal|16
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|code_org
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|code_org
expr_stmt|;
block|}
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|dcrc
argument_list|)
expr_stmt|;
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* 	 * Now start it rolling. 	 * 	 * If we didn't actually download f/w, 	 * we still need to (re)start it. 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_EXEC_FIRMWARE
argument_list|,
name|MBLOGALL
argument_list|,
literal|5000000
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|code_org
operator|>>
literal|16
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|code_org
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_loaded_fw
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|IS_25XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|ibits
operator||=
literal|0x10
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|IS_2322
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|code_org
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_loaded_fw
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|code_org
expr_stmt|;
block|}
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_2322
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* 	 * Give it a chance to finish starting up. 	 * Give the 24XX more time. 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_DELAY
argument_list|(
literal|500000
argument_list|)
expr_stmt|;
comment|/* 		 * Check to see if the 24XX firmware really started. 		 */
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|==
literal|0xdead
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"f/w didn't *really* start"
argument_list|)
expr_stmt|;
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|ISP_DELAY
argument_list|(
literal|250000
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* 			 * Set CLOCK RATE, but only if asked to. 			 */
if|if
condition|(
name|isp
operator|->
name|isp_clock
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_CLOCK_RATE
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|isp
operator|->
name|isp_clock
expr_stmt|;
name|mbs
operator|.
name|logval
operator|=
name|MBLOGNONE
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
comment|/* we will try not to care if this fails */
block|}
block|}
block|}
comment|/* 	 * Ask the chip for the current firmware version. 	 * This should prove that the new firmware is working. 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_ABOUT_FIRMWARE
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * The SBus firmware that we are using apparently does not return 	 * major, minor, micro revisions in the mailbox registers, which 	 * is really, really, annoying. 	 */
if|if
condition|(
name|ISP_SBUS_SUPPORTED
operator|&&
name|isp
operator|->
name|isp_bustype
operator|==
name|ISP_BT_SBUS
condition|)
block|{
if|if
condition|(
name|dodnld
condition|)
block|{
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
name|isp
operator|->
name|isp_fwrev
index|[
literal|0
index|]
operator|=
literal|7
expr_stmt|;
name|isp
operator|->
name|isp_fwrev
index|[
literal|1
index|]
operator|=
literal|55
expr_stmt|;
else|#
directive|else
name|isp
operator|->
name|isp_fwrev
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|isp
operator|->
name|isp_fwrev
index|[
literal|1
index|]
operator|=
literal|37
expr_stmt|;
endif|#
directive|endif
name|isp
operator|->
name|isp_fwrev
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|isp
operator|->
name|isp_fwrev
index|[
literal|0
index|]
operator|=
name|mbs
operator|.
name|param
index|[
literal|1
index|]
expr_stmt|;
name|isp
operator|->
name|isp_fwrev
index|[
literal|1
index|]
operator|=
name|mbs
operator|.
name|param
index|[
literal|2
index|]
expr_stmt|;
name|isp
operator|->
name|isp_fwrev
index|[
literal|2
index|]
operator|=
name|mbs
operator|.
name|param
index|[
literal|3
index|]
expr_stmt|;
block|}
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* 		 * We do not believe firmware attributes for 2100 code less 		 * than 1.17.0, unless it's the firmware we specifically 		 * are loading. 		 * 		 * Note that all 22XX and later f/w is greater than 1.X.0. 		 */
if|if
condition|(
operator|(
name|ISP_FW_OLDER_THAN
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|,
literal|17
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|USE_SMALLER_2100_FIRMWARE
name|isp
operator|->
name|isp_fwattr
operator|=
name|ISP_FW_ATTR_SCCLUN
expr_stmt|;
else|#
directive|else
name|isp
operator|->
name|isp_fwattr
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|isp
operator|->
name|isp_fwattr
operator|=
name|mbs
operator|.
name|param
index|[
literal|6
index|]
expr_stmt|;
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
name|isp
operator|->
name|isp_fwattr
operator|&
name|ISP2400_FW_ATTR_EXTNDED
operator|)
condition|)
block|{
name|isp
operator|->
name|isp_fwattr
operator||=
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|mbs
operator|.
name|param
index|[
literal|15
index|]
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|mbs
operator|.
name|param
index|[
literal|16
index|]
operator|)
operator|<<
literal|32
operator|)
operator||
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|mbs
operator|.
name|param
index|[
literal|17
index|]
operator|)
operator|<<
literal|48
operator|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
ifndef|#
directive|ifndef
name|ISP_TARGET_MODE
name|isp
operator|->
name|isp_fwattr
operator|=
name|ISP_FW_ATTR_TMODE
expr_stmt|;
else|#
directive|else
name|isp
operator|->
name|isp_fwattr
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"Board Type %s, Chip Revision 0x%x, %s F/W Revision %d.%d.%d"
argument_list|,
name|btype
argument_list|,
name|isp
operator|->
name|isp_revision
argument_list|,
name|dodnld
condition|?
literal|"loaded"
else|:
literal|"resident"
argument_list|,
name|isp
operator|->
name|isp_fwrev
index|[
literal|0
index|]
argument_list|,
name|isp
operator|->
name|isp_fwrev
index|[
literal|1
index|]
argument_list|,
name|isp
operator|->
name|isp_fwrev
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|fwt
operator|=
name|isp
operator|->
name|isp_fwattr
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|buf
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|isp_scratch
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
argument_list|,
literal|"Attributes:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwt
operator|&
name|ISP2400_FW_ATTR_CLASS2
condition|)
block|{
name|fwt
operator|^=
name|ISP2400_FW_ATTR_CLASS2
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Class2"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP2400_FW_ATTR_IP
condition|)
block|{
name|fwt
operator|^=
name|ISP2400_FW_ATTR_IP
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s IP"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP2400_FW_ATTR_MULTIID
condition|)
block|{
name|fwt
operator|^=
name|ISP2400_FW_ATTR_MULTIID
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s MultiID"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP2400_FW_ATTR_SB2
condition|)
block|{
name|fwt
operator|^=
name|ISP2400_FW_ATTR_SB2
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s SB2"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP2400_FW_ATTR_T10CRC
condition|)
block|{
name|fwt
operator|^=
name|ISP2400_FW_ATTR_T10CRC
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s T10CRC"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP2400_FW_ATTR_VI
condition|)
block|{
name|fwt
operator|^=
name|ISP2400_FW_ATTR_VI
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s VI"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP2400_FW_ATTR_VP0
condition|)
block|{
name|fwt
operator|^=
name|ISP2400_FW_ATTR_VP0
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s VP0_Decoupling"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP2400_FW_ATTR_EXPFW
condition|)
block|{
name|fwt
operator|^=
name|ISP2400_FW_ATTR_EXPFW
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s (Experimental)"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|fwt
operator|&=
operator|~
name|ISP2400_FW_ATTR_EXTNDED
expr_stmt|;
if|if
condition|(
name|fwt
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s (unknown 0x%08x%08x)"
argument_list|,
name|buf
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fwt
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|fwt
argument_list|)
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|buf
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|isp_scratch
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
argument_list|,
literal|"Attributes:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwt
operator|&
name|ISP_FW_ATTR_TMODE
condition|)
block|{
name|fwt
operator|^=
name|ISP_FW_ATTR_TMODE
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s TargetMode"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP_FW_ATTR_SCCLUN
condition|)
block|{
name|fwt
operator|^=
name|ISP_FW_ATTR_SCCLUN
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s SCC-Lun"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP_FW_ATTR_FABRIC
condition|)
block|{
name|fwt
operator|^=
name|ISP_FW_ATTR_FABRIC
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Fabric"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP_FW_ATTR_CLASS2
condition|)
block|{
name|fwt
operator|^=
name|ISP_FW_ATTR_CLASS2
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Class2"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP_FW_ATTR_FCTAPE
condition|)
block|{
name|fwt
operator|^=
name|ISP_FW_ATTR_FCTAPE
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s FC-Tape"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP_FW_ATTR_IP
condition|)
block|{
name|fwt
operator|^=
name|ISP_FW_ATTR_IP
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s IP"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP_FW_ATTR_VI
condition|)
block|{
name|fwt
operator|^=
name|ISP_FW_ATTR_VI
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s VI"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP_FW_ATTR_VI_SOLARIS
condition|)
block|{
name|fwt
operator|^=
name|ISP_FW_ATTR_VI_SOLARIS
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s VI_SOLARIS"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|&
name|ISP_FW_ATTR_2KLOGINS
condition|)
block|{
name|fwt
operator|^=
name|ISP_FW_ATTR_2KLOGINS
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s 2K-Login"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fwt
operator|!=
literal|0
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
name|ISP_FC_SCRLEN
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s (unknown 0x%08x%08x)"
argument_list|,
name|buf
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fwt
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|fwt
argument_list|)
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_GET_RESOURCE_COUNT
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_maxcmds
operator|>=
name|mbs
operator|.
name|param
index|[
literal|3
index|]
condition|)
block|{
name|isp
operator|->
name|isp_maxcmds
operator|=
name|mbs
operator|.
name|param
index|[
literal|3
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_GET_FIRMWARE_STATUS
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_maxcmds
operator|>=
name|mbs
operator|.
name|param
index|[
literal|2
index|]
condition|)
block|{
name|isp
operator|->
name|isp_maxcmds
operator|=
name|mbs
operator|.
name|param
index|[
literal|2
index|]
expr_stmt|;
block|}
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"%d max I/O command limit set"
argument_list|,
name|isp
operator|->
name|isp_maxcmds
argument_list|)
expr_stmt|;
comment|/* 	 * If we don't have Multi-ID f/w loaded, we need to restrict channels to one. 	 * Only make this check for non-SCSI cards (I'm not sure firmware attributes 	 * work for them). 	 */
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
operator|&&
name|isp
operator|->
name|isp_nchan
operator|>
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|ISP_CAP_MULTI_ID
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"non-MULTIID f/w loaded, only can enable 1 of %d channels"
argument_list|,
name|isp
operator|->
name|isp_nchan
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_nchan
operator|=
literal|1
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|i
operator|++
control|)
block|{
name|isp_fw_state
argument_list|(
name|isp
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_dead
condition|)
block|{
name|isp_shutdown
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|ISP_DISABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
name|isp
operator|->
name|isp_state
operator|=
name|ISP_RESETSTATE
expr_stmt|;
comment|/* 	 * Okay- now that we have new firmware running, we now (re)set our 	 * notion of how many luns we support. This is somewhat tricky because 	 * if we haven't loaded firmware, we sometimes do not have an easy way 	 * of knowing how many luns we support. 	 * 	 * Expanded lun firmware gives you 32 luns for SCSI cards and 	 * 16384 luns for Fibre Channel cards. 	 * 	 * It turns out that even for QLogic 2100s with ROM 1.10 and above 	 * we do get a firmware attributes word returned in mailbox register 6. 	 * 	 * Because the lun is in a different position in the Request Queue 	 * Entry structure for Fibre Channel with expanded lun firmware, we 	 * can only support one lun (lun zero) when we don't know what kind 	 * of firmware we're running. 	 */
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|dodnld
condition|)
block|{
if|if
condition|(
name|IS_ULTRA2
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_ULTRA3
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp
operator|->
name|isp_maxluns
operator|=
literal|32
expr_stmt|;
block|}
else|else
block|{
name|isp
operator|->
name|isp_maxluns
operator|=
literal|8
expr_stmt|;
block|}
block|}
else|else
block|{
name|isp
operator|->
name|isp_maxluns
operator|=
literal|8
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ISP_CAP_SCCFW
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp
operator|->
name|isp_maxluns
operator|=
literal|16384
expr_stmt|;
block|}
else|else
block|{
name|isp
operator|->
name|isp_maxluns
operator|=
literal|16
expr_stmt|;
block|}
block|}
comment|/* 	 * We get some default values established. As a side 	 * effect, NVRAM is read here (unless overriden by 	 * a configuration flag). 	 */
if|if
condition|(
name|do_load_defaults
condition|)
block|{
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_setdfltsdparm
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|i
operator|++
control|)
block|{
name|isp_setdfltfcparm
argument_list|(
name|isp
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Initialize Parameters of Hardware to a known state.  *  * Locks are held before coming here.  */
end_comment

begin_function
name|void
name|isp_init
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|)
block|{
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_fibre_init_2400
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_fibre_init
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|isp_scsi_init
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
name|GET_NANOTIME
argument_list|(
operator|&
name|isp
operator|->
name|isp_init_time
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_scsi_init
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|)
block|{
name|sdparam
modifier|*
name|sdp_chan0
decl_stmt|,
modifier|*
name|sdp_chan1
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
name|sdp_chan0
operator|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sdp_chan1
operator|=
name|sdp_chan0
expr_stmt|;
if|if
condition|(
name|IS_DUALBUS
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|sdp_chan1
operator|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* First do overall per-card settings. */
comment|/* 	 * If we have fast memory timing enabled, turn it on. 	 */
if|if
condition|(
name|sdp_chan0
operator|->
name|isp_fast_mttr
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|RISC_MTR
argument_list|,
literal|0x1313
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Set Retry Delay and Count. 	 * You set both channels at the same time. 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_RETRY_COUNT
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|sdp_chan0
operator|->
name|isp_retry_count
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdp_chan0
operator|->
name|isp_retry_delay
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|sdp_chan1
operator|->
name|isp_retry_count
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|sdp_chan1
operator|->
name|isp_retry_delay
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
comment|/* 	 * Set ASYNC DATA SETUP time. This is very important. 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_ASYNC_DATA_SETUP_TIME
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|sdp_chan0
operator|->
name|isp_async_data_setup
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdp_chan1
operator|->
name|isp_async_data_setup
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
comment|/* 	 * Set ACTIVE Negation State. 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_ACT_NEG_STATE
argument_list|,
name|MBLOGNONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|sdp_chan0
operator|->
name|isp_req_ack_active_neg
operator|<<
literal|4
operator|)
operator||
operator|(
name|sdp_chan0
operator|->
name|isp_data_line_active_neg
operator|<<
literal|5
operator|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
operator|(
name|sdp_chan1
operator|->
name|isp_req_ack_active_neg
operator|<<
literal|4
operator|)
operator||
operator|(
name|sdp_chan1
operator|->
name|isp_data_line_active_neg
operator|<<
literal|5
operator|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"failed to set active negation state (%d,%d), (%d,%d)"
argument_list|,
name|sdp_chan0
operator|->
name|isp_req_ack_active_neg
argument_list|,
name|sdp_chan0
operator|->
name|isp_data_line_active_neg
argument_list|,
name|sdp_chan1
operator|->
name|isp_req_ack_active_neg
argument_list|,
name|sdp_chan1
operator|->
name|isp_data_line_active_neg
argument_list|)
expr_stmt|;
comment|/* 		 * But don't return. 		 */
block|}
comment|/* 	 * Set the Tag Aging limit 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_TAG_AGE_LIMIT
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|sdp_chan0
operator|->
name|isp_tag_aging
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdp_chan1
operator|->
name|isp_tag_aging
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"failed to set tag age limit (%d,%d)"
argument_list|,
name|sdp_chan0
operator|->
name|isp_tag_aging
argument_list|,
name|sdp_chan1
operator|->
name|isp_tag_aging
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Set selection timeout. 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_SELECT_TIMEOUT
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|sdp_chan0
operator|->
name|isp_selection_timeout
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdp_chan1
operator|->
name|isp_selection_timeout
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
comment|/* now do per-channel settings */
name|isp_scsi_channel_init
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_DUALBUS
argument_list|(
name|isp
argument_list|)
condition|)
name|isp_scsi_channel_init
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Now enable request/response queues 	 */
if|if
condition|(
name|IS_ULTRA2
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_1240
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_INIT_RES_QUEUE_A64
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
name|isp
operator|->
name|isp_residx
operator|=
name|isp
operator|->
name|isp_resodx
operator|=
name|mbs
operator|.
name|param
index|[
literal|5
index|]
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_INIT_REQ_QUEUE_A64
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
name|isp
operator|->
name|isp_reqidx
operator|=
name|isp
operator|->
name|isp_reqodx
operator|=
name|mbs
operator|.
name|param
index|[
literal|4
index|]
expr_stmt|;
block|}
else|else
block|{
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_INIT_RES_QUEUE
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
name|isp
operator|->
name|isp_residx
operator|=
name|isp
operator|->
name|isp_resodx
operator|=
name|mbs
operator|.
name|param
index|[
literal|5
index|]
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_INIT_REQ_QUEUE
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
name|isp
operator|->
name|isp_reqidx
operator|=
name|isp
operator|->
name|isp_reqodx
operator|=
name|mbs
operator|.
name|param
index|[
literal|4
index|]
expr_stmt|;
block|}
comment|/* 	 * Turn on LVD transitions for ULTRA2 or better and other features 	 * 	 * Now that we have 32 bit handles, don't do any fast posting 	 * any more. For Ultra2/Ultra3 cards, we can turn on 32 bit RIO 	 * operation or use fast posting. To be conservative, we'll only 	 * do this for Ultra3 cards now because the other cards are so 	 * rare for this author to find and test with. 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_FW_FEATURES
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ULTRA2
argument_list|(
name|isp
argument_list|)
condition|)
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator||=
name|FW_FEATURE_LVD_NOTIFY
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_NO_RIO
if|if
condition|(
name|IS_ULTRA3
argument_list|(
name|isp
argument_list|)
condition|)
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator||=
name|FW_FEATURE_FAST_POST
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|IS_ULTRA3
argument_list|(
name|isp
argument_list|)
condition|)
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator||=
name|FW_FEATURE_RIO_32BIT
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
block|{
name|uint16_t
name|sfeat
init|=
name|mbs
operator|.
name|param
index|[
literal|1
index|]
decl_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|==
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Enabled FW features (0x%x)"
argument_list|,
name|sfeat
argument_list|)
expr_stmt|;
block|}
block|}
name|isp
operator|->
name|isp_state
operator|=
name|ISP_INITSTATE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_scsi_channel_init
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|sdparam
modifier|*
name|sdp
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
name|int
name|tgt
decl_stmt|;
name|sdp
operator|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
comment|/* 	 * Set (possibly new) Initiator ID. 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_INIT_SCSI_ID
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|chan
operator|<<
literal|7
operator|)
operator||
name|sdp
operator|->
name|isp_initiator_id
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Chan %d Initiator ID is %d"
argument_list|,
name|chan
argument_list|,
name|sdp
operator|->
name|isp_initiator_id
argument_list|)
expr_stmt|;
comment|/* 	 * Set current per-target parameters to an initial safe minimum. 	 */
for|for
control|(
name|tgt
operator|=
literal|0
init|;
name|tgt
operator|<
name|MAX_TARGETS
condition|;
name|tgt
operator|++
control|)
block|{
name|int
name|lun
decl_stmt|;
name|uint16_t
name|sdf
decl_stmt|;
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_enable
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
ifndef|#
directive|ifndef
name|ISP_TARGET_MODE
name|sdf
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_flags
expr_stmt|;
name|sdf
operator|&=
name|DPARM_SAFE_DFLT
expr_stmt|;
comment|/* 		 * It is not quite clear when this changed over so that 		 * we could force narrow and async for 1000/1020 cards, 		 * but assume that this is only the case for loaded 		 * firmware. 		 */
if|if
condition|(
name|isp
operator|->
name|isp_loaded_fw
condition|)
block|{
name|sdf
operator||=
name|DPARM_NARROW
operator||
name|DPARM_ASYNC
expr_stmt|;
block|}
else|#
directive|else
comment|/* 		 * The !$*!)$!$)* f/w uses the same index into some 		 * internal table to decide how to respond to negotiations, 		 * so if we've said "let's be safe" for ID X, and ID X 		 * selects *us*, the negotiations will back to 'safe' 		 * (as in narrow/async). What the f/w *should* do is 		 * use the initiator id settings to decide how to respond. 		 */
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_flags
operator|=
name|sdf
operator|=
name|DPARM_DEFAULT
expr_stmt|;
endif|#
directive|endif
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_TARGET_PARAMS
argument_list|,
name|MBLOGNONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|chan
operator|<<
literal|15
operator|)
operator||
operator|(
name|tgt
operator|<<
literal|8
operator|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdf
expr_stmt|;
if|if
condition|(
operator|(
name|sdf
operator|&
name|DPARM_SYNC
operator|)
operator|==
literal|0
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
operator|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_offset
operator|<<
literal|8
operator|)
operator||
operator|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_period
operator|)
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"Initial Settings bus%d tgt%d flags 0x%x off 0x%x per 0x%x"
argument_list|,
name|chan
argument_list|,
name|tgt
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|2
index|]
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|>>
literal|8
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|sdf
operator|=
name|DPARM_SAFE_DFLT
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_TARGET_PARAMS
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|tgt
operator|<<
literal|8
operator|)
operator||
operator|(
name|chan
operator|<<
literal|15
operator|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdf
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
continue|continue;
block|}
block|}
comment|/* 		 * We don't update any information directly from the f/w 		 * because we need to run at least one command to cause a 		 * new state to be latched up. So, we just assume that we 		 * converge to the values we just had set. 		 * 		 * Ensure that we don't believe tagged queuing is enabled yet. 		 * It turns out that sometimes the ISP just ignores our 		 * attempts to set parameters for devices that it hasn't 		 * seen yet. 		 */
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_flags
operator|=
name|sdf
operator|&
operator|~
name|DPARM_TQING
expr_stmt|;
for|for
control|(
name|lun
operator|=
literal|0
init|;
name|lun
operator|<
operator|(
name|int
operator|)
name|isp
operator|->
name|isp_maxluns
condition|;
name|lun
operator|++
control|)
block|{
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_DEV_QUEUE_PARAMS
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|chan
operator|<<
literal|15
operator|)
operator||
operator|(
name|tgt
operator|<<
literal|8
operator|)
operator||
name|lun
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdp
operator|->
name|isp_max_queue_depth
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|exc_throttle
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
break|break;
block|}
block|}
block|}
for|for
control|(
name|tgt
operator|=
literal|0
init|;
name|tgt
operator|<
name|MAX_TARGETS
condition|;
name|tgt
operator|++
control|)
block|{
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_refresh
condition|)
block|{
name|sdp
operator|->
name|sendmarker
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Fibre Channel specific initialization.  */
end_comment

begin_function
specifier|static
name|void
name|isp_fibre_init
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|)
block|{
name|fcparam
modifier|*
name|fcp
decl_stmt|;
name|isp_icb_t
name|local
decl_stmt|,
modifier|*
name|icbp
init|=
operator|&
name|local
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
name|int
name|ownloopid
decl_stmt|;
comment|/* 	 * We only support one channel on non-24XX cards 	 */
name|fcp
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|role
operator|==
name|ISP_ROLE_NONE
condition|)
block|{
name|isp
operator|->
name|isp_state
operator|=
name|ISP_INITSTATE
expr_stmt|;
return|return;
block|}
name|ISP_MEMZERO
argument_list|(
name|icbp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|icbp
argument_list|)
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_version
operator|=
name|ICB_VERSION1
expr_stmt|;
name|icbp
operator|->
name|icb_fwoptions
operator|=
name|fcp
operator|->
name|isp_fwoptions
expr_stmt|;
comment|/* 	 * Firmware Options are either retrieved from NVRAM or 	 * are patched elsewhere. We check them for sanity here 	 * and make changes based on board revision, but otherwise 	 * let others decide policy. 	 */
comment|/* 	 * If this is a 2100< revision 5, we have to turn off FAIRNESS. 	 */
if|if
condition|(
name|IS_2100
argument_list|(
name|isp
argument_list|)
operator|&&
name|isp
operator|->
name|isp_revision
operator|<
literal|5
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions
operator|&=
operator|~
name|ICBOPT_FAIRNESS
expr_stmt|;
block|}
comment|/* 	 * We have to use FULL LOGIN even though it resets the loop too much 	 * because otherwise port database entries don't get updated after 	 * a LIP- this is a known f/w bug for 2100 f/w less than 1.17.0. 	 */
if|if
condition|(
operator|!
name|ISP_FW_NEWER_THAN
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|,
literal|17
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions
operator||=
name|ICBOPT_FULL_LOGIN
expr_stmt|;
block|}
comment|/* 	 * Insist on Port Database Update Async notifications 	 */
name|icbp
operator|->
name|icb_fwoptions
operator||=
name|ICBOPT_PDBCHANGE_AE
expr_stmt|;
comment|/* 	 * Make sure that target role reflects into fwoptions. 	 */
if|if
condition|(
name|fcp
operator|->
name|role
operator|&
name|ISP_ROLE_TARGET
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions
operator||=
name|ICBOPT_TGT_ENABLE
expr_stmt|;
block|}
else|else
block|{
name|icbp
operator|->
name|icb_fwoptions
operator|&=
operator|~
name|ICBOPT_TGT_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|fcp
operator|->
name|role
operator|&
name|ISP_ROLE_INITIATOR
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions
operator|&=
operator|~
name|ICBOPT_INI_DISABLE
expr_stmt|;
block|}
else|else
block|{
name|icbp
operator|->
name|icb_fwoptions
operator||=
name|ICBOPT_INI_DISABLE
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_maxfrmlen
operator|=
name|DEFAULT_FRAMESIZE
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_maxfrmlen
operator|<
name|ICB_MIN_FRMLEN
operator|||
name|icbp
operator|->
name|icb_maxfrmlen
operator|>
name|ICB_MAX_FRMLEN
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad frame length (%d) from NVRAM- using %d"
argument_list|,
name|DEFAULT_FRAMESIZE
argument_list|(
name|isp
argument_list|)
argument_list|,
name|ICB_DFLT_FRMLEN
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_maxfrmlen
operator|=
name|ICB_DFLT_FRMLEN
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_maxalloc
operator|=
name|fcp
operator|->
name|isp_maxalloc
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_maxalloc
operator|<
literal|1
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad maximum allocation (%d)- using 16"
argument_list|,
name|fcp
operator|->
name|isp_maxalloc
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_maxalloc
operator|=
literal|16
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_execthrottle
operator|=
name|DEFAULT_EXEC_THROTTLE
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_execthrottle
operator|<
literal|1
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad execution throttle of %d- using %d"
argument_list|,
name|DEFAULT_EXEC_THROTTLE
argument_list|(
name|isp
argument_list|)
argument_list|,
name|ICB_DFLT_THROTTLE
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_execthrottle
operator|=
name|ICB_DFLT_THROTTLE
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_retry_delay
operator|=
name|fcp
operator|->
name|isp_retry_delay
expr_stmt|;
name|icbp
operator|->
name|icb_retry_count
operator|=
name|fcp
operator|->
name|isp_retry_count
expr_stmt|;
name|icbp
operator|->
name|icb_hardaddr
operator|=
name|fcp
operator|->
name|isp_loopid
expr_stmt|;
name|ownloopid
operator|=
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNLOOPID
operator|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_hardaddr
operator|>=
name|LOCAL_LOOP_LIM
condition|)
block|{
name|icbp
operator|->
name|icb_hardaddr
operator|=
literal|0
expr_stmt|;
name|ownloopid
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * Our life seems so much better with 2200s and later with 	 * the latest f/w if we set Hard Address. 	 */
if|if
condition|(
name|ownloopid
operator|||
name|ISP_FW_NEWER_THAN
argument_list|(
name|isp
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions
operator||=
name|ICBOPT_HARD_ADDRESS
expr_stmt|;
block|}
comment|/* 	 * Right now we just set extended options to prefer point-to-point 	 * over loop based upon some soft config options. 	 * 	 * NB: for the 2300, ICBOPT_EXTENDED is required. 	 */
if|if
condition|(
name|IS_2100
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* 		 * We can't have Fast Posting any more- we now 		 * have 32 bit handles. 		 */
name|icbp
operator|->
name|icb_fwoptions
operator|&=
operator|~
name|ICBOPT_FAST_POST
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_2200
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_23XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions
operator||=
name|ICBOPT_EXTENDED
expr_stmt|;
name|icbp
operator|->
name|icb_xfwoptions
operator|=
name|fcp
operator|->
name|isp_xfwoptions
expr_stmt|;
if|if
condition|(
name|ISP_CAP_FCTAPE
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_NOFCTAPE
condition|)
name|icbp
operator|->
name|icb_xfwoptions
operator|&=
operator|~
name|ICBXOPT_FCTAPE
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_FCTAPE
condition|)
name|icbp
operator|->
name|icb_xfwoptions
operator||=
name|ICBXOPT_FCTAPE
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_xfwoptions
operator|&
name|ICBXOPT_FCTAPE
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions
operator|&=
operator|~
name|ICBOPT_FULL_LOGIN
expr_stmt|;
comment|/* per documents */
name|icbp
operator|->
name|icb_xfwoptions
operator||=
name|ICBXOPT_FCTAPE_CCQ
operator||
name|ICBXOPT_FCTAPE_CONFIRM
expr_stmt|;
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|fctape_enabled
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|fctape_enabled
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|icbp
operator|->
name|icb_xfwoptions
operator|&=
operator|~
name|ICBXOPT_FCTAPE
expr_stmt|;
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|fctape_enabled
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 		 * Prefer or force Point-To-Point instead Loop? 		 */
switch|switch
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_PORT_PREF
condition|)
block|{
case|case
name|ISP_CFG_NPORT
case|:
name|icbp
operator|->
name|icb_xfwoptions
operator|&=
operator|~
name|ICBXOPT_TOPO_MASK
expr_stmt|;
name|icbp
operator|->
name|icb_xfwoptions
operator||=
name|ICBXOPT_PTP_2_LOOP
expr_stmt|;
break|break;
case|case
name|ISP_CFG_NPORT_ONLY
case|:
name|icbp
operator|->
name|icb_xfwoptions
operator|&=
operator|~
name|ICBXOPT_TOPO_MASK
expr_stmt|;
name|icbp
operator|->
name|icb_xfwoptions
operator||=
name|ICBXOPT_PTP_ONLY
expr_stmt|;
break|break;
case|case
name|ISP_CFG_LPORT_ONLY
case|:
name|icbp
operator|->
name|icb_xfwoptions
operator|&=
operator|~
name|ICBXOPT_TOPO_MASK
expr_stmt|;
name|icbp
operator|->
name|icb_xfwoptions
operator||=
name|ICBXOPT_LOOP_ONLY
expr_stmt|;
break|break;
default|default:
comment|/* 			 * Let NVRAM settings define it if they are sane 			 */
switch|switch
condition|(
name|icbp
operator|->
name|icb_xfwoptions
operator|&
name|ICBXOPT_TOPO_MASK
condition|)
block|{
case|case
name|ICBXOPT_PTP_2_LOOP
case|:
case|case
name|ICBXOPT_PTP_ONLY
case|:
case|case
name|ICBXOPT_LOOP_ONLY
case|:
case|case
name|ICBXOPT_LOOP_2_PTP
case|:
break|break;
default|default:
name|icbp
operator|->
name|icb_xfwoptions
operator|&=
operator|~
name|ICBXOPT_TOPO_MASK
expr_stmt|;
name|icbp
operator|->
name|icb_xfwoptions
operator||=
name|ICBXOPT_LOOP_2_PTP
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|IS_2200
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* 			 * We can't have Fast Posting any more- we now 			 * have 32 bit handles. 			 * 			 * RIO seemed to have to much breakage. 			 * 			 * Just opt for safety. 			 */
name|icbp
operator|->
name|icb_xfwoptions
operator|&=
operator|~
name|ICBXOPT_RIO_16BIT
expr_stmt|;
name|icbp
operator|->
name|icb_fwoptions
operator|&=
operator|~
name|ICBOPT_FAST_POST
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * QLogic recommends that FAST Posting be turned 			 * off for 23XX cards and instead allow the HBA 			 * to write response queue entries and interrupt 			 * after a delay (ZIO). 			 */
name|icbp
operator|->
name|icb_fwoptions
operator|&=
operator|~
name|ICBOPT_FAST_POST
expr_stmt|;
if|if
condition|(
operator|(
name|fcp
operator|->
name|isp_xfwoptions
operator|&
name|ICBXOPT_TIMER_MASK
operator|)
operator|==
name|ICBXOPT_ZIO
condition|)
block|{
name|icbp
operator|->
name|icb_xfwoptions
operator||=
name|ICBXOPT_ZIO
expr_stmt|;
name|icbp
operator|->
name|icb_idelaytimer
operator|=
literal|10
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_zfwoptions
operator|=
name|fcp
operator|->
name|isp_zfwoptions
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_ONEGB
condition|)
block|{
name|icbp
operator|->
name|icb_zfwoptions
operator|&=
operator|~
name|ICBZOPT_RATE_MASK
expr_stmt|;
name|icbp
operator|->
name|icb_zfwoptions
operator||=
name|ICBZOPT_RATE_ONEGB
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_TWOGB
condition|)
block|{
name|icbp
operator|->
name|icb_zfwoptions
operator|&=
operator|~
name|ICBZOPT_RATE_MASK
expr_stmt|;
name|icbp
operator|->
name|icb_zfwoptions
operator||=
name|ICBZOPT_RATE_TWOGB
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|icbp
operator|->
name|icb_zfwoptions
operator|&
name|ICBZOPT_RATE_MASK
condition|)
block|{
case|case
name|ICBZOPT_RATE_ONEGB
case|:
case|case
name|ICBZOPT_RATE_TWOGB
case|:
case|case
name|ICBZOPT_RATE_AUTO
case|:
break|break;
default|default:
name|icbp
operator|->
name|icb_zfwoptions
operator|&=
operator|~
name|ICBZOPT_RATE_MASK
expr_stmt|;
name|icbp
operator|->
name|icb_zfwoptions
operator||=
name|ICBZOPT_RATE_AUTO
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
comment|/* 	 * For 22XX> 2.1.26&& 23XX, set some options. 	 */
if|if
condition|(
name|ISP_FW_NEWER_THAN
argument_list|(
name|isp
argument_list|,
literal|2
argument_list|,
literal|26
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_FIRMWARE_OPTIONS
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|IFCOPT1_DISF7SWTCH
operator||
name|IFCOPT1_LIPASYNC
operator||
name|IFCOPT1_LIPF8
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ISP_FW_NEWER_THAN
argument_list|(
name|isp
argument_list|,
literal|3
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator||=
name|IFCOPT1_EQFQASYNC
operator||
name|IFCOPT1_CTIO_RETRY
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|role
operator|&
name|ISP_ROLE_TARGET
condition|)
block|{
if|if
condition|(
name|ISP_FW_NEWER_THAN
argument_list|(
name|isp
argument_list|,
literal|3
argument_list|,
literal|25
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator||=
name|IFCOPT1_ENAPURE
expr_stmt|;
block|}
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|IFCOPT3_NOPRLI
expr_stmt|;
block|}
block|}
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
block|}
name|icbp
operator|->
name|icb_logintime
operator|=
name|ICB_LOGIN_TOV
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|ISP_FW_NEWER_THAN
argument_list|(
name|isp
argument_list|,
literal|3
argument_list|,
literal|25
argument_list|,
literal|0
argument_list|)
operator|&&
operator|(
name|icbp
operator|->
name|icb_fwoptions
operator|&
name|ICBOPT_TGT_ENABLE
operator|)
condition|)
block|{
name|icbp
operator|->
name|icb_lunenables
operator|=
literal|0xffff
expr_stmt|;
name|icbp
operator|->
name|icb_ccnt
operator|=
name|DFLT_CMND_CNT
expr_stmt|;
name|icbp
operator|->
name|icb_icnt
operator|=
name|DFLT_INOT_CNT
expr_stmt|;
name|icbp
operator|->
name|icb_lunetimeout
operator|=
name|ICB_LUN_ENABLE_TOV
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|fcp
operator|->
name|isp_wwnn
operator|&&
name|fcp
operator|->
name|isp_wwpn
operator|&&
operator|(
name|fcp
operator|->
name|isp_wwnn
operator|>>
literal|60
operator|)
operator|!=
literal|2
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions
operator||=
name|ICBOPT_BOTH_WWNS
expr_stmt|;
name|MAKE_NODE_NAME_FROM_WWN
argument_list|(
name|icbp
operator|->
name|icb_nodename
argument_list|,
name|fcp
operator|->
name|isp_wwnn
argument_list|)
expr_stmt|;
name|MAKE_NODE_NAME_FROM_WWN
argument_list|(
name|icbp
operator|->
name|icb_portname
argument_list|,
name|fcp
operator|->
name|isp_wwpn
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"Setting ICB Node 0x%08x%08x Port 0x%08x%08x"
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwnn
operator|>>
literal|32
argument_list|)
operator|)
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwnn
argument_list|)
operator|)
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
operator|>>
literal|32
argument_list|)
operator|)
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fcp
operator|->
name|isp_wwpn
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions
operator|&=
operator|~
name|ICBOPT_BOTH_WWNS
expr_stmt|;
name|MAKE_NODE_NAME_FROM_WWN
argument_list|(
name|icbp
operator|->
name|icb_portname
argument_list|,
name|fcp
operator|->
name|isp_wwpn
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"Setting ICB Port 0x%08x%08x"
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
operator|>>
literal|32
argument_list|)
operator|)
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"No valid WWNs to use"
argument_list|)
expr_stmt|;
return|return;
block|}
name|icbp
operator|->
name|icb_rqstqlen
operator|=
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_rqstqlen
operator|<
literal|1
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad request queue length"
argument_list|)
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_rsltqlen
operator|=
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_rsltqlen
operator|<
literal|1
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad result queue length"
argument_list|)
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_rqstaddr
index|[
name|RQRSP_ADDR0015
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_rqstaddr
index|[
name|RQRSP_ADDR1631
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_rqstaddr
index|[
name|RQRSP_ADDR3247
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_rqstaddr
index|[
name|RQRSP_ADDR4863
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_respaddr
index|[
name|RQRSP_ADDR0015
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_respaddr
index|[
name|RQRSP_ADDR1631
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_respaddr
index|[
name|RQRSP_ADDR3247
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_respaddr
index|[
name|RQRSP_ADDR4863
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|FC_SCRATCH_ACQUIRE
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|sacq
argument_list|)
expr_stmt|;
return|return;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"isp_fibre_init: fwopt 0x%x xfwopt 0x%x zfwopt 0x%x"
argument_list|,
name|icbp
operator|->
name|icb_fwoptions
argument_list|,
name|icbp
operator|->
name|icb_xfwoptions
argument_list|,
name|icbp
operator|->
name|icb_zfwoptions
argument_list|)
expr_stmt|;
name|isp_put_icb
argument_list|(
name|isp
argument_list|,
name|icbp
argument_list|,
operator|(
name|isp_icb_t
operator|*
operator|)
name|fcp
operator|->
name|isp_scratch
argument_list|)
expr_stmt|;
comment|/* 	 * Init the firmware 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_INIT_FIRMWARE
argument_list|,
name|MBLOGALL
argument_list|,
literal|30000000
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|logval
operator|=
name|MBLOGALL
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"INIT F/W from %p (%08x%08x)"
argument_list|,
name|fcp
operator|->
name|isp_scratch
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint64_t
operator|)
name|fcp
operator|->
name|isp_scdma
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORDEV
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|icbp
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"isp_fibre_init"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|icbp
argument_list|)
argument_list|,
name|icbp
argument_list|)
expr_stmt|;
return|return;
block|}
name|isp
operator|->
name|isp_reqidx
operator|=
literal|0
expr_stmt|;
name|isp
operator|->
name|isp_reqodx
operator|=
literal|0
expr_stmt|;
name|isp
operator|->
name|isp_residx
operator|=
literal|0
expr_stmt|;
name|isp
operator|->
name|isp_resodx
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Whatever happens, we're now committed to being here. 	 */
name|isp
operator|->
name|isp_state
operator|=
name|ISP_INITSTATE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_fibre_init_2400
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|)
block|{
name|fcparam
modifier|*
name|fcp
decl_stmt|;
name|isp_icb_2400_t
name|local
decl_stmt|,
modifier|*
name|icbp
init|=
operator|&
name|local
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
name|int
name|chan
decl_stmt|;
name|int
name|ownloopid
init|=
literal|0
decl_stmt|;
comment|/* 	 * Check to see whether all channels have *some* kind of role 	 */
for|for
control|(
name|chan
operator|=
literal|0
init|;
name|chan
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|chan
operator|++
control|)
block|{
name|fcp
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|role
operator|!=
name|ISP_ROLE_NONE
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|chan
operator|==
name|isp
operator|->
name|isp_nchan
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"all %d channels with role 'none'"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_state
operator|=
name|ISP_INITSTATE
expr_stmt|;
return|return;
block|}
comment|/* 	 * Start with channel 0. 	 */
name|fcp
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Turn on LIP F8 async event (1) 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SET_FIRMWARE_OPTIONS
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
name|ISP_MEMZERO
argument_list|(
name|icbp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|icbp
argument_list|)
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_fwoptions1
operator|=
name|fcp
operator|->
name|isp_fwoptions
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|role
operator|&
name|ISP_ROLE_TARGET
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions1
operator||=
name|ICB2400_OPT1_TGT_ENABLE
expr_stmt|;
block|}
else|else
block|{
name|icbp
operator|->
name|icb_fwoptions1
operator|&=
operator|~
name|ICB2400_OPT1_TGT_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|fcp
operator|->
name|role
operator|&
name|ISP_ROLE_INITIATOR
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions1
operator|&=
operator|~
name|ICB2400_OPT1_INI_DISABLE
expr_stmt|;
block|}
else|else
block|{
name|icbp
operator|->
name|icb_fwoptions1
operator||=
name|ICB2400_OPT1_INI_DISABLE
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_version
operator|=
name|ICB_VERSION1
expr_stmt|;
name|icbp
operator|->
name|icb_maxfrmlen
operator|=
name|DEFAULT_FRAMESIZE
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_maxfrmlen
operator|<
name|ICB_MIN_FRMLEN
operator|||
name|icbp
operator|->
name|icb_maxfrmlen
operator|>
name|ICB_MAX_FRMLEN
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad frame length (%d) from NVRAM- using %d"
argument_list|,
name|DEFAULT_FRAMESIZE
argument_list|(
name|isp
argument_list|)
argument_list|,
name|ICB_DFLT_FRMLEN
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_maxfrmlen
operator|=
name|ICB_DFLT_FRMLEN
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_execthrottle
operator|=
name|DEFAULT_EXEC_THROTTLE
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_execthrottle
operator|<
literal|1
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad execution throttle of %d- using %d"
argument_list|,
name|DEFAULT_EXEC_THROTTLE
argument_list|(
name|isp
argument_list|)
argument_list|,
name|ICB_DFLT_THROTTLE
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_execthrottle
operator|=
name|ICB_DFLT_THROTTLE
expr_stmt|;
block|}
comment|/* 	 * Set target exchange count. Take half if we are supporting both roles. 	 */
if|if
condition|(
name|icbp
operator|->
name|icb_fwoptions1
operator|&
name|ICB2400_OPT1_TGT_ENABLE
condition|)
block|{
name|icbp
operator|->
name|icb_xchgcnt
operator|=
name|isp
operator|->
name|isp_maxcmds
expr_stmt|;
if|if
condition|(
operator|(
name|icbp
operator|->
name|icb_fwoptions1
operator|&
name|ICB2400_OPT1_INI_DISABLE
operator|)
operator|==
literal|0
condition|)
name|icbp
operator|->
name|icb_xchgcnt
operator|>>=
literal|1
expr_stmt|;
block|}
name|ownloopid
operator|=
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNLOOPID
operator|)
operator|!=
literal|0
expr_stmt|;
name|icbp
operator|->
name|icb_hardaddr
operator|=
name|fcp
operator|->
name|isp_loopid
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_hardaddr
operator|>=
name|LOCAL_LOOP_LIM
condition|)
block|{
name|icbp
operator|->
name|icb_hardaddr
operator|=
literal|0
expr_stmt|;
name|ownloopid
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ownloopid
condition|)
name|icbp
operator|->
name|icb_fwoptions1
operator||=
name|ICB2400_OPT1_HARD_ADDRESS
expr_stmt|;
name|icbp
operator|->
name|icb_fwoptions2
operator|=
name|fcp
operator|->
name|isp_xfwoptions
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_NOFCTAPE
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions2
operator|&=
operator|~
name|ICB2400_OPT2_FCTAPE
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_FCTAPE
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions2
operator||=
name|ICB2400_OPT2_FCTAPE
expr_stmt|;
block|}
if|if
condition|(
name|icbp
operator|->
name|icb_fwoptions2
operator|&
name|ICB2400_OPT2_FCTAPE
condition|)
block|{
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|fctape_enabled
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|fctape_enabled
operator|=
literal|0
expr_stmt|;
block|}
switch|switch
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_PORT_PREF
condition|)
block|{
case|case
name|ISP_CFG_NPORT_ONLY
case|:
name|icbp
operator|->
name|icb_fwoptions2
operator|&=
operator|~
name|ICB2400_OPT2_TOPO_MASK
expr_stmt|;
name|icbp
operator|->
name|icb_fwoptions2
operator||=
name|ICB2400_OPT2_PTP_ONLY
expr_stmt|;
break|break;
case|case
name|ISP_CFG_LPORT_ONLY
case|:
name|icbp
operator|->
name|icb_fwoptions2
operator|&=
operator|~
name|ICB2400_OPT2_TOPO_MASK
expr_stmt|;
name|icbp
operator|->
name|icb_fwoptions2
operator||=
name|ICB2400_OPT2_LOOP_ONLY
expr_stmt|;
break|break;
default|default:
comment|/* ISP_CFG_PTP_2_LOOP not available in 24XX/25XX */
name|icbp
operator|->
name|icb_fwoptions2
operator|&=
operator|~
name|ICB2400_OPT2_TOPO_MASK
expr_stmt|;
name|icbp
operator|->
name|icb_fwoptions2
operator||=
name|ICB2400_OPT2_LOOP_2_PTP
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|icbp
operator|->
name|icb_fwoptions2
operator|&
name|ICB2400_OPT2_TIMER_MASK
condition|)
block|{
case|case
name|ICB2400_OPT2_ZIO
case|:
case|case
name|ICB2400_OPT2_ZIO1
case|:
name|icbp
operator|->
name|icb_idelaytimer
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0
case|:
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"bad value %x in fwopt2 timer field"
argument_list|,
name|icbp
operator|->
name|icb_fwoptions2
operator|&
name|ICB2400_OPT2_TIMER_MASK
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_fwoptions2
operator|&=
operator|~
name|ICB2400_OPT2_TIMER_MASK
expr_stmt|;
break|break;
block|}
name|icbp
operator|->
name|icb_fwoptions3
operator|=
name|fcp
operator|->
name|isp_zfwoptions
expr_stmt|;
if|if
condition|(
operator|(
name|icbp
operator|->
name|icb_fwoptions3
operator|&
name|ICB2400_OPT3_RSPSZ_MASK
operator|)
operator|==
literal|0
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions3
operator||=
name|ICB2400_OPT3_RSPSZ_24
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_fwoptions3
operator|&=
operator|~
name|ICB2400_OPT3_RATE_AUTO
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_ONEGB
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions3
operator||=
name|ICB2400_OPT3_RATE_ONEGB
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_TWOGB
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions3
operator||=
name|ICB2400_OPT3_RATE_TWOGB
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_FOURGB
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions3
operator||=
name|ICB2400_OPT3_RATE_FOURGB
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_25XX
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_EIGHTGB
operator|)
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions3
operator||=
name|ICB2400_OPT3_RATE_EIGHTGB
expr_stmt|;
block|}
else|else
block|{
name|icbp
operator|->
name|icb_fwoptions3
operator||=
name|ICB2400_OPT3_RATE_AUTO
expr_stmt|;
block|}
if|if
condition|(
name|ownloopid
operator|==
literal|0
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions3
operator||=
name|ICB2400_OPT3_SOFTID
expr_stmt|;
block|}
name|icbp
operator|->
name|icb_logintime
operator|=
name|ICB_LOGIN_TOV
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_wwnn
operator|&&
name|fcp
operator|->
name|isp_wwpn
operator|&&
operator|(
name|fcp
operator|->
name|isp_wwnn
operator|>>
literal|60
operator|)
operator|!=
literal|2
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions1
operator||=
name|ICB2400_OPT1_BOTH_WWNS
expr_stmt|;
name|MAKE_NODE_NAME_FROM_WWN
argument_list|(
name|icbp
operator|->
name|icb_portname
argument_list|,
name|fcp
operator|->
name|isp_wwpn
argument_list|)
expr_stmt|;
name|MAKE_NODE_NAME_FROM_WWN
argument_list|(
name|icbp
operator|->
name|icb_nodename
argument_list|,
name|fcp
operator|->
name|isp_wwnn
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"Setting ICB Node 0x%08x%08x Port 0x%08x%08x"
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwnn
operator|>>
literal|32
argument_list|)
operator|)
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwnn
argument_list|)
operator|)
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
operator|>>
literal|32
argument_list|)
operator|)
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fcp
operator|->
name|isp_wwpn
condition|)
block|{
name|icbp
operator|->
name|icb_fwoptions1
operator|&=
operator|~
name|ICB2400_OPT1_BOTH_WWNS
expr_stmt|;
name|MAKE_NODE_NAME_FROM_WWN
argument_list|(
name|icbp
operator|->
name|icb_portname
argument_list|,
name|fcp
operator|->
name|isp_wwpn
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"Setting ICB Node to be same as Port 0x%08x%08x"
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
operator|>>
literal|32
argument_list|)
operator|)
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"No valid WWNs to use"
argument_list|)
expr_stmt|;
return|return;
block|}
name|icbp
operator|->
name|icb_retry_count
operator|=
name|fcp
operator|->
name|isp_retry_count
expr_stmt|;
name|icbp
operator|->
name|icb_rqstqlen
operator|=
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_rqstqlen
operator|<
literal|8
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad request queue length %d"
argument_list|,
name|icbp
operator|->
name|icb_rqstqlen
argument_list|)
expr_stmt|;
return|return;
block|}
name|icbp
operator|->
name|icb_rsltqlen
operator|=
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_rsltqlen
operator|<
literal|8
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad result queue length %d"
argument_list|,
name|icbp
operator|->
name|icb_rsltqlen
argument_list|)
expr_stmt|;
return|return;
block|}
name|icbp
operator|->
name|icb_rqstaddr
index|[
name|RQRSP_ADDR0015
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_rqstaddr
index|[
name|RQRSP_ADDR1631
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_rqstaddr
index|[
name|RQRSP_ADDR3247
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_rqstaddr
index|[
name|RQRSP_ADDR4863
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_respaddr
index|[
name|RQRSP_ADDR0015
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_respaddr
index|[
name|RQRSP_ADDR1631
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_respaddr
index|[
name|RQRSP_ADDR3247
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_respaddr
index|[
name|RQRSP_ADDR4863
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
comment|/* unconditionally set up the ATIO queue if we support target mode */
name|icbp
operator|->
name|icb_atioqlen
operator|=
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|icbp
operator|->
name|icb_atioqlen
operator|<
literal|8
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad ATIO queue length %d"
argument_list|,
name|icbp
operator|->
name|icb_atioqlen
argument_list|)
expr_stmt|;
return|return;
block|}
name|icbp
operator|->
name|icb_atioqaddr
index|[
name|RQRSP_ADDR0015
index|]
operator|=
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_atioq_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_atioqaddr
index|[
name|RQRSP_ADDR1631
index|]
operator|=
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_atioq_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_atioqaddr
index|[
name|RQRSP_ADDR3247
index|]
operator|=
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_atioq_dma
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_atioqaddr
index|[
name|RQRSP_ADDR4863
index|]
operator|=
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_atioq_dma
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"isp_fibre_init_2400: atioq %04x%04x%04x%04x"
argument_list|,
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_atioq_dma
argument_list|)
argument_list|,
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_atioq_dma
argument_list|)
argument_list|,
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_atioq_dma
argument_list|)
argument_list|,
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_atioq_dma
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"isp_fibre_init_2400: fwopt1 0x%x fwopt2 0x%x fwopt3 0x%x"
argument_list|,
name|icbp
operator|->
name|icb_fwoptions1
argument_list|,
name|icbp
operator|->
name|icb_fwoptions2
argument_list|,
name|icbp
operator|->
name|icb_fwoptions3
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"isp_fibre_init_2400: rqst %04x%04x%04x%04x rsp %04x%04x%04x%04x"
argument_list|,
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
argument_list|,
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
argument_list|,
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
argument_list|,
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
argument_list|)
argument_list|,
name|DMA_WD3
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
argument_list|,
name|DMA_WD2
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
argument_list|,
name|DMA_WD1
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
argument_list|,
name|DMA_WD0
argument_list|(
name|isp
operator|->
name|isp_result_dma
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"isp_fibre_init_2400"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|icbp
argument_list|)
argument_list|,
name|icbp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FC_SCRATCH_ACQUIRE
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|sacq
argument_list|)
expr_stmt|;
return|return;
block|}
name|ISP_MEMZERO
argument_list|(
name|fcp
operator|->
name|isp_scratch
argument_list|,
name|ISP_FC_SCRLEN
argument_list|)
expr_stmt|;
name|isp_put_icb_2400
argument_list|(
name|isp
argument_list|,
name|icbp
argument_list|,
name|fcp
operator|->
name|isp_scratch
argument_list|)
expr_stmt|;
comment|/* 	 * Now fill in information about any additional channels 	 */
if|if
condition|(
name|isp
operator|->
name|isp_nchan
operator|>
literal|1
condition|)
block|{
name|isp_icb_2400_vpinfo_t
name|vpinfo
decl_stmt|,
modifier|*
name|vdst
decl_stmt|;
name|vp_port_info_t
name|pi
decl_stmt|,
modifier|*
name|pdst
decl_stmt|;
name|size_t
name|amt
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|off
decl_stmt|;
name|vpinfo
operator|.
name|vp_count
operator|=
name|isp
operator|->
name|isp_nchan
operator|-
literal|1
expr_stmt|;
name|vpinfo
operator|.
name|vp_global_options
operator|=
literal|0
expr_stmt|;
name|off
operator|=
name|fcp
operator|->
name|isp_scratch
expr_stmt|;
name|off
operator|+=
name|ICB2400_VPINFO_OFF
expr_stmt|;
name|vdst
operator|=
operator|(
name|isp_icb_2400_vpinfo_t
operator|*
operator|)
name|off
expr_stmt|;
name|isp_put_icb_2400_vpinfo
argument_list|(
name|isp
argument_list|,
operator|&
name|vpinfo
argument_list|,
name|vdst
argument_list|)
expr_stmt|;
name|amt
operator|=
name|ICB2400_VPINFO_OFF
operator|+
sizeof|sizeof
argument_list|(
name|isp_icb_2400_vpinfo_t
argument_list|)
expr_stmt|;
for|for
control|(
name|chan
operator|=
literal|1
init|;
name|chan
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|chan
operator|++
control|)
block|{
name|fcparam
modifier|*
name|fcp2
decl_stmt|;
name|ISP_MEMZERO
argument_list|(
operator|&
name|pi
argument_list|,
sizeof|sizeof
argument_list|(
name|pi
argument_list|)
argument_list|)
expr_stmt|;
name|fcp2
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcp2
operator|->
name|role
operator|!=
name|ISP_ROLE_NONE
condition|)
block|{
name|pi
operator|.
name|vp_port_options
operator|=
name|ICB2400_VPOPT_ENABLED
expr_stmt|;
if|if
condition|(
name|fcp2
operator|->
name|role
operator|&
name|ISP_ROLE_INITIATOR
condition|)
block|{
name|pi
operator|.
name|vp_port_options
operator||=
name|ICB2400_VPOPT_INI_ENABLE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fcp2
operator|->
name|role
operator|&
name|ISP_ROLE_TARGET
operator|)
operator|==
literal|0
condition|)
block|{
name|pi
operator|.
name|vp_port_options
operator||=
name|ICB2400_VPOPT_TGT_DISABLE
expr_stmt|;
block|}
name|MAKE_NODE_NAME_FROM_WWN
argument_list|(
name|pi
operator|.
name|vp_port_portname
argument_list|,
name|fcp2
operator|->
name|isp_wwpn
argument_list|)
expr_stmt|;
name|MAKE_NODE_NAME_FROM_WWN
argument_list|(
name|pi
operator|.
name|vp_port_nodename
argument_list|,
name|fcp2
operator|->
name|isp_wwnn
argument_list|)
expr_stmt|;
block|}
name|off
operator|=
name|fcp
operator|->
name|isp_scratch
expr_stmt|;
name|off
operator|+=
name|ICB2400_VPINFO_PORT_OFF
argument_list|(
name|chan
argument_list|)
expr_stmt|;
name|pdst
operator|=
operator|(
name|vp_port_info_t
operator|*
operator|)
name|off
expr_stmt|;
name|isp_put_vp_port_info
argument_list|(
name|isp
argument_list|,
operator|&
name|pi
argument_list|,
name|pdst
argument_list|)
expr_stmt|;
name|amt
operator|+=
name|ICB2400_VPOPT_WRITE_SIZE
expr_stmt|;
block|}
block|}
comment|/* 	 * Init the firmware 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
literal|0
argument_list|,
name|MBLOGALL
argument_list|,
literal|30000000
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_nchan
operator|>
literal|1
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_INIT_FIRMWARE_MULTI_ID
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_INIT_FIRMWARE
expr_stmt|;
block|}
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"INIT F/W from %04x%04x%04x%04x"
argument_list|,
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
argument_list|,
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
argument_list|,
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
argument_list|,
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORDEV
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|icbp
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return;
block|}
name|isp
operator|->
name|isp_reqidx
operator|=
literal|0
expr_stmt|;
name|isp
operator|->
name|isp_reqodx
operator|=
literal|0
expr_stmt|;
name|isp
operator|->
name|isp_residx
operator|=
literal|0
expr_stmt|;
name|isp
operator|->
name|isp_resodx
operator|=
literal|0
expr_stmt|;
name|isp
operator|->
name|isp_atioodx
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Whatever happens, we're now committed to being here. 	 */
name|isp
operator|->
name|isp_state
operator|=
name|ISP_INITSTATE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_mark_portdb
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|disposition
parameter_list|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|chan
operator|<
literal|0
operator|||
name|chan
operator|>=
name|isp
operator|->
name|isp_nchan
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"isp_mark_portdb: bad channel %d"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_FC_TARG
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
operator|.
name|target_mode
condition|)
block|{
if|if
condition|(
name|disposition
operator|<
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTINFO
argument_list|,
literal|"isp_mark_portdb: Chan %d zeroing handle 0x"
literal|"%04x port 0x%06x"
argument_list|,
name|chan
argument_list|,
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
operator|.
name|handle
argument_list|,
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
operator|.
name|portid
argument_list|)
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
operator|&
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|fcportdb_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|disposition
operator|==
literal|0
condition|)
block|{
name|ISP_MEMZERO
argument_list|(
operator|&
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|fcportdb_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
operator|.
name|state
condition|)
block|{
case|case
name|FC_PORTDB_STATE_CHANGED
case|:
case|case
name|FC_PORTDB_STATE_PENDING_VALID
case|:
case|case
name|FC_PORTDB_STATE_VALID
case|:
case|case
name|FC_PORTDB_STATE_PROBATIONAL
case|:
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
operator|.
name|state
operator|=
name|FC_PORTDB_STATE_PROBATIONAL
expr_stmt|;
break|break;
case|case
name|FC_PORTDB_STATE_ZOMBIE
case|:
break|break;
case|case
name|FC_PORTDB_STATE_NIL
case|:
default|default:
name|ISP_MEMZERO
argument_list|(
operator|&
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|fcportdb_t
argument_list|)
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
operator|.
name|state
operator|=
name|FC_PORTDB_STATE_NIL
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Perform an IOCB PLOGI or LOGO via EXECUTE IOCB A64 for 24XX cards  * or via FABRIC LOGIN/FABRIC LOGOUT for other cards.  */
end_comment

begin_function
specifier|static
name|int
name|isp_plogx
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|,
name|uint16_t
name|handle
parameter_list|,
name|uint32_t
name|portid
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|gs
parameter_list|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|uint8_t
name|q
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
name|isp_plogx_t
modifier|*
name|plp
decl_stmt|;
name|fcparam
modifier|*
name|fcp
decl_stmt|;
name|uint8_t
modifier|*
name|scp
decl_stmt|;
name|uint32_t
name|sst
decl_stmt|,
name|parm1
decl_stmt|;
name|int
name|rval
decl_stmt|,
name|lev
decl_stmt|;
specifier|const
name|char
modifier|*
name|msg
decl_stmt|;
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|int
name|action
init|=
name|flags
operator|&
name|PLOGX_FLG_CMD_MASK
decl_stmt|;
if|if
condition|(
name|action
operator|==
name|PLOGX_FLG_CMD_PLOGI
condition|)
block|{
return|return
operator|(
name|isp_port_login
argument_list|(
name|isp
argument_list|,
name|handle
argument_list|,
name|portid
argument_list|)
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|action
operator|==
name|PLOGX_FLG_CMD_LOGO
condition|)
block|{
return|return
operator|(
name|isp_port_logout
argument_list|(
name|isp
argument_list|,
name|handle
argument_list|,
name|portid
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|MBOX_INVALID_COMMAND
operator|)
return|;
block|}
block|}
name|ISP_MEMZERO
argument_list|(
name|q
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
name|plp
operator|=
operator|(
name|isp_plogx_t
operator|*
operator|)
name|q
expr_stmt|;
name|plp
operator|->
name|plogx_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|plp
operator|->
name|plogx_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_LOGIN
expr_stmt|;
name|plp
operator|->
name|plogx_handle
operator|=
literal|0xffffffff
expr_stmt|;
name|plp
operator|->
name|plogx_nphdl
operator|=
name|handle
expr_stmt|;
name|plp
operator|->
name|plogx_vphdl
operator|=
name|chan
expr_stmt|;
name|plp
operator|->
name|plogx_portlo
operator|=
name|portid
expr_stmt|;
name|plp
operator|->
name|plogx_rspsz_porthi
operator|=
operator|(
name|portid
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|plp
operator|->
name|plogx_flags
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"IOCB LOGX"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|plp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gs
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|FC_SCRATCH_ACQUIRE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|sacq
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|fcp
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|scp
operator|=
name|fcp
operator|->
name|isp_scratch
expr_stmt|;
name|isp_put_plogx
argument_list|(
name|isp
argument_list|,
name|plp
argument_list|,
operator|(
name|isp_plogx_t
operator|*
operator|)
name|scp
argument_list|)
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_EXEC_COMMAND_IOCB_A64
argument_list|,
name|MBLOGALL
argument_list|,
literal|500000
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|QENTRY_LEN
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORDEV
argument_list|,
literal|0
argument_list|,
name|QENTRY_LEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|rval
operator|=
name|mbs
operator|.
name|param
index|[
literal|0
index|]
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORCPU
argument_list|,
name|QENTRY_LEN
argument_list|,
name|QENTRY_LEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|scp
operator|+=
name|QENTRY_LEN
expr_stmt|;
name|isp_get_plogx
argument_list|(
name|isp
argument_list|,
operator|(
name|isp_plogx_t
operator|*
operator|)
name|scp
argument_list|,
name|plp
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"IOCB LOGX response"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|plp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|plp
operator|->
name|plogx_status
operator|==
name|PLOGX_STATUS_OK
condition|)
block|{
name|rval
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|plp
operator|->
name|plogx_status
operator|!=
name|PLOGX_STATUS_IOCBERR
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"status 0x%x on port login IOCB channel %d"
argument_list|,
name|plp
operator|->
name|plogx_status
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|rval
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|sst
operator|=
name|plp
operator|->
name|plogx_ioparm
index|[
literal|0
index|]
operator|.
name|lo16
operator||
operator|(
name|plp
operator|->
name|plogx_ioparm
index|[
literal|0
index|]
operator|.
name|hi16
operator|<<
literal|16
operator|)
expr_stmt|;
name|parm1
operator|=
name|plp
operator|->
name|plogx_ioparm
index|[
literal|1
index|]
operator|.
name|lo16
operator||
operator|(
name|plp
operator|->
name|plogx_ioparm
index|[
literal|1
index|]
operator|.
name|hi16
operator|<<
literal|16
operator|)
expr_stmt|;
name|rval
operator|=
operator|-
literal|1
expr_stmt|;
name|lev
operator|=
name|ISP_LOGERR
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|sst
condition|)
block|{
case|case
name|PLOGX_IOCBERR_NOLINK
case|:
name|msg
operator|=
literal|"no link"
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_NOIOCB
case|:
name|msg
operator|=
literal|"no IOCB buffer"
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_NOXGHG
case|:
name|msg
operator|=
literal|"no Exchange Control Block"
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_FAILED
case|:
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"reason 0x%x (last LOGIN state 0x%x)"
argument_list|,
name|parm1
operator|&
literal|0xff
argument_list|,
operator|(
name|parm1
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buf
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_NOFABRIC
case|:
name|msg
operator|=
literal|"no fabric"
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_NOTREADY
case|:
name|msg
operator|=
literal|"firmware not ready"
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_NOLOGIN
case|:
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"not logged in (last state 0x%x)"
argument_list|,
name|parm1
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buf
expr_stmt|;
name|rval
operator|=
name|MBOX_NOT_LOGGED_IN
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_REJECT
case|:
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"LS_RJT = 0x%x"
argument_list|,
name|parm1
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buf
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_NOPCB
case|:
name|msg
operator|=
literal|"no PCB allocated"
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_EINVAL
case|:
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"invalid parameter at offset 0x%x"
argument_list|,
name|parm1
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buf
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_PORTUSED
case|:
name|lev
operator|=
name|ISP_LOG_SANCFG
operator||
name|ISP_LOG_WARN1
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"already logged in with N-Port handle 0x%x"
argument_list|,
name|parm1
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buf
expr_stmt|;
name|rval
operator|=
name|MBOX_PORT_ID_USED
operator||
operator|(
name|parm1
operator|<<
literal|16
operator|)
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_HNDLUSED
case|:
name|lev
operator|=
name|ISP_LOG_SANCFG
operator||
name|ISP_LOG_WARN1
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"handle already used for PortID 0x%06x"
argument_list|,
name|parm1
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buf
expr_stmt|;
name|rval
operator|=
name|MBOX_LOOP_ID_USED
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_NOHANDLE
case|:
name|msg
operator|=
literal|"no handle allocated"
expr_stmt|;
break|break;
case|case
name|PLOGX_IOCBERR_NOFLOGI
case|:
name|msg
operator|=
literal|"no FLOGI_ACC"
expr_stmt|;
break|break;
default|default:
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"status %x from %x"
argument_list|,
name|plp
operator|->
name|plogx_status
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buf
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|msg
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Chan %d PLOGX PortID 0x%06x to N-Port handle 0x%x: %s"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|,
name|handle
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
name|out
label|:
if|if
condition|(
name|gs
operator|==
literal|0
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isp_port_login
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint16_t
name|handle
parameter_list|,
name|uint32_t
name|portid
parameter_list|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_FABRIC_LOGIN
argument_list|,
name|MBLOGNONE
argument_list|,
literal|500000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|handle
expr_stmt|;
name|mbs
operator|.
name|ibits
operator|=
operator|(
literal|1
operator|<<
literal|10
operator|)
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|handle
operator|<<
literal|8
expr_stmt|;
block|}
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|portid
operator|>>
literal|16
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|portid
expr_stmt|;
name|mbs
operator|.
name|logval
operator|=
name|MBLOGNONE
expr_stmt|;
name|mbs
operator|.
name|timeout
operator|=
literal|500000
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
condition|)
block|{
case|case
name|MBOX_PORT_ID_USED
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
operator||
name|ISP_LOG_WARN1
argument_list|,
literal|"isp_port_login: portid 0x%06x already logged in as %u"
argument_list|,
name|portid
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|MBOX_PORT_ID_USED
operator||
operator|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
operator|)
return|;
case|case
name|MBOX_LOOP_ID_USED
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
operator||
name|ISP_LOG_WARN1
argument_list|,
literal|"isp_port_login: handle 0x%04x in use for port id 0x%02xXXXX"
argument_list|,
name|handle
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
return|return
operator|(
name|MBOX_LOOP_ID_USED
operator|)
return|;
case|case
name|MBOX_COMMAND_COMPLETE
case|:
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|MBOX_COMMAND_ERROR
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
operator||
name|ISP_LOG_WARN1
argument_list|,
literal|"isp_port_login: error 0x%x in PLOGI to port 0x%06x"
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|1
index|]
argument_list|,
name|portid
argument_list|)
expr_stmt|;
return|return
operator|(
name|MBOX_COMMAND_ERROR
operator|)
return|;
case|case
name|MBOX_ALL_IDS_USED
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
operator||
name|ISP_LOG_WARN1
argument_list|,
literal|"isp_port_login: all IDs used for fabric login"
argument_list|)
expr_stmt|;
return|return
operator|(
name|MBOX_ALL_IDS_USED
operator|)
return|;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"isp_port_login: error 0x%x on port login of 0x%06x@0x%0x"
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|0
index|]
argument_list|,
name|portid
argument_list|,
name|handle
argument_list|)
expr_stmt|;
return|return
operator|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Pre-24XX fabric port logout  *  * Note that portid is not used  */
end_comment

begin_function
specifier|static
name|int
name|isp_port_logout
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint16_t
name|handle
parameter_list|,
name|uint32_t
name|portid
parameter_list|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_FABRIC_LOGOUT
argument_list|,
name|MBLOGNONE
argument_list|,
literal|500000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|handle
expr_stmt|;
name|mbs
operator|.
name|ibits
operator|=
operator|(
literal|1
operator|<<
literal|10
operator|)
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|handle
operator|<<
literal|8
expr_stmt|;
block|}
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
return|return
operator|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|==
name|MBOX_COMMAND_COMPLETE
condition|?
literal|0
else|:
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isp_getpdb
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|,
name|uint16_t
name|id
parameter_list|,
name|isp_pdb_t
modifier|*
name|pdb
parameter_list|,
name|int
name|dolock
parameter_list|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
union|union
block|{
name|isp_pdb_21xx_t
name|fred
decl_stmt|;
name|isp_pdb_24xx_t
name|bill
decl_stmt|;
block|}
name|un
union|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_GET_PORT_DB
argument_list|,
name|MBLOGALL
operator|&
operator|~
name|MBOX_COMMAND_PARAM_ERROR
argument_list|,
literal|250000
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|ibits
operator|=
operator|(
literal|1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|1
operator|<<
literal|10
operator|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|id
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|9
index|]
operator|=
name|chan
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|id
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|id
operator|<<
literal|8
expr_stmt|;
block|}
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
if|if
condition|(
name|dolock
condition|)
block|{
if|if
condition|(
name|FC_SCRATCH_ACQUIRE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|sacq
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORDEV
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|un
argument_list|)
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
if|if
condition|(
name|dolock
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|)
return|;
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_get_pdb_24xx
argument_list|(
name|isp
argument_list|,
name|fcp
operator|->
name|isp_scratch
argument_list|,
operator|&
name|un
operator|.
name|bill
argument_list|)
expr_stmt|;
name|pdb
operator|->
name|handle
operator|=
name|un
operator|.
name|bill
operator|.
name|pdb_handle
expr_stmt|;
name|pdb
operator|->
name|prli_word3
operator|=
name|un
operator|.
name|bill
operator|.
name|pdb_prli_svc3
expr_stmt|;
name|pdb
operator|->
name|portid
operator|=
name|BITS2WORD_24XX
argument_list|(
name|un
operator|.
name|bill
operator|.
name|pdb_portid_bits
argument_list|)
expr_stmt|;
name|ISP_MEMCPY
argument_list|(
name|pdb
operator|->
name|portname
argument_list|,
name|un
operator|.
name|bill
operator|.
name|pdb_portname
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ISP_MEMCPY
argument_list|(
name|pdb
operator|->
name|nodename
argument_list|,
name|un
operator|.
name|bill
operator|.
name|pdb_nodename
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Port 0x%06x flags 0x%x curstate %x"
argument_list|,
name|chan
argument_list|,
name|pdb
operator|->
name|portid
argument_list|,
name|un
operator|.
name|bill
operator|.
name|pdb_flags
argument_list|,
name|un
operator|.
name|bill
operator|.
name|pdb_curstate
argument_list|)
expr_stmt|;
if|if
condition|(
name|un
operator|.
name|bill
operator|.
name|pdb_curstate
operator|<
name|PDB2400_STATE_PLOGI_DONE
operator|||
name|un
operator|.
name|bill
operator|.
name|pdb_curstate
operator|>
name|PDB2400_STATE_LOGGED_IN
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_NOT_LOGGED_IN
expr_stmt|;
if|if
condition|(
name|dolock
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|)
return|;
block|}
block|}
else|else
block|{
name|isp_get_pdb_21xx
argument_list|(
name|isp
argument_list|,
name|fcp
operator|->
name|isp_scratch
argument_list|,
operator|&
name|un
operator|.
name|fred
argument_list|)
expr_stmt|;
name|pdb
operator|->
name|handle
operator|=
name|un
operator|.
name|fred
operator|.
name|pdb_loopid
expr_stmt|;
name|pdb
operator|->
name|prli_word3
operator|=
name|un
operator|.
name|fred
operator|.
name|pdb_prli_svc3
expr_stmt|;
name|pdb
operator|->
name|portid
operator|=
name|BITS2WORD
argument_list|(
name|un
operator|.
name|fred
operator|.
name|pdb_portid_bits
argument_list|)
expr_stmt|;
name|ISP_MEMCPY
argument_list|(
name|pdb
operator|->
name|portname
argument_list|,
name|un
operator|.
name|fred
operator|.
name|pdb_portname
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ISP_MEMCPY
argument_list|(
name|pdb
operator|->
name|nodename
argument_list|,
name|un
operator|.
name|fred
operator|.
name|pdb_nodename
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dolock
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_dump_chip_portdb
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|dolock
parameter_list|)
block|{
name|isp_pdb_t
name|pdb
decl_stmt|;
name|int
name|lim
decl_stmt|,
name|loopid
decl_stmt|;
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|lim
operator|=
name|NPH_MAX_2K
expr_stmt|;
block|}
else|else
block|{
name|lim
operator|=
name|NPH_MAX
expr_stmt|;
block|}
for|for
control|(
name|loopid
operator|=
literal|0
init|;
name|loopid
operator|!=
name|lim
condition|;
name|loopid
operator|++
control|)
block|{
if|if
condition|(
name|isp_getpdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|loopid
argument_list|,
operator|&
name|pdb
argument_list|,
name|dolock
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
operator||
name|ISP_LOGINFO
argument_list|,
literal|"Chan %d Loopid 0x%04x "
literal|"PortID 0x%06x WWPN 0x%02x%02x%02x%02x%02x%02x%02x%02x"
argument_list|,
name|chan
argument_list|,
name|loopid
argument_list|,
name|pdb
operator|.
name|portid
argument_list|,
name|pdb
operator|.
name|portname
index|[
literal|0
index|]
argument_list|,
name|pdb
operator|.
name|portname
index|[
literal|1
index|]
argument_list|,
name|pdb
operator|.
name|portname
index|[
literal|2
index|]
argument_list|,
name|pdb
operator|.
name|portname
index|[
literal|3
index|]
argument_list|,
name|pdb
operator|.
name|portname
index|[
literal|4
index|]
argument_list|,
name|pdb
operator|.
name|portname
index|[
literal|5
index|]
argument_list|,
name|pdb
operator|.
name|portname
index|[
literal|6
index|]
argument_list|,
name|pdb
operator|.
name|portname
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|isp_get_wwn
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|loopid
parameter_list|,
name|int
name|nodename
parameter_list|)
block|{
name|uint64_t
name|wwn
init|=
name|INI_NONE
decl_stmt|;
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_fwstate
operator|<
name|FW_READY
operator|||
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_PDB_RCVD
condition|)
block|{
return|return
operator|(
name|wwn
operator|)
return|;
block|}
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_GET_PORT_NAME
argument_list|,
name|MBLOGALL
operator|&
operator|~
name|MBOX_COMMAND_PARAM_ERROR
argument_list|,
literal|500000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|loopid
expr_stmt|;
if|if
condition|(
name|nodename
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|10
index|]
operator|=
literal|1
expr_stmt|;
block|}
name|mbs
operator|.
name|param
index|[
literal|9
index|]
operator|=
name|chan
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|ibitm
operator|=
literal|3
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|loopid
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|nodename
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator||=
literal|1
expr_stmt|;
block|}
block|}
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return
operator|(
name|wwn
operator|)
return|;
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|wwn
operator|=
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|>>
literal|8
argument_list|)
operator|)
operator|<<
literal|56
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|48
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|>>
literal|8
argument_list|)
operator|)
operator|<<
literal|40
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|32
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|>>
literal|8
argument_list|)
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|>>
literal|8
argument_list|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|&
literal|0xff
argument_list|)
operator|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|wwn
operator|=
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|56
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|>>
literal|8
argument_list|)
operator|)
operator|<<
literal|48
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|40
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|>>
literal|8
argument_list|)
operator|)
operator|<<
literal|32
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|>>
literal|8
argument_list|)
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|&
literal|0xff
argument_list|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|>>
literal|8
argument_list|)
operator|)
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|wwn
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Make sure we have good FC link.  */
end_comment

begin_function
specifier|static
name|int
name|isp_fclink_test
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|usdelay
parameter_list|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|int
name|count
decl_stmt|,
name|check_for_fabric
decl_stmt|,
name|r
decl_stmt|;
name|uint8_t
name|lwfs
decl_stmt|;
name|int
name|loopid
decl_stmt|;
name|fcparam
modifier|*
name|fcp
decl_stmt|;
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
name|isp_pdb_t
name|pdb
decl_stmt|;
name|fcp
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC Link Test Entry"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Wait up to N microseconds for F/W to go to a ready state. 	 */
name|lwfs
operator|=
name|FW_CONFIG_WAIT
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|count
operator|<
name|usdelay
condition|)
block|{
name|uint64_t
name|enano
decl_stmt|;
name|uint32_t
name|wrk
decl_stmt|;
name|NANOTIME_T
name|hra
decl_stmt|,
name|hrb
decl_stmt|;
name|GET_NANOTIME
argument_list|(
operator|&
name|hra
argument_list|)
expr_stmt|;
name|isp_fw_state
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwfs
operator|!=
name|fcp
operator|->
name|isp_fwstate
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
operator||
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Firmware State<%s->%s>"
argument_list|,
name|chan
argument_list|,
name|isp_fc_fw_statename
argument_list|(
operator|(
name|int
operator|)
name|lwfs
argument_list|)
argument_list|,
name|isp_fc_fw_statename
argument_list|(
operator|(
name|int
operator|)
name|fcp
operator|->
name|isp_fwstate
argument_list|)
argument_list|)
expr_stmt|;
name|lwfs
operator|=
name|fcp
operator|->
name|isp_fwstate
expr_stmt|;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_fwstate
operator|==
name|FW_READY
condition|)
block|{
break|break;
block|}
name|GET_NANOTIME
argument_list|(
operator|&
name|hrb
argument_list|)
expr_stmt|;
comment|/* 		 * Get the elapsed time in nanoseconds. 		 * Always guaranteed to be non-zero. 		 */
name|enano
operator|=
name|NANOTIME_SUB
argument_list|(
operator|&
name|hrb
argument_list|,
operator|&
name|hra
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"usec%d: 0x%lx->0x%lx enano 0x%x%08x"
argument_list|,
name|count
argument_list|,
operator|(
name|long
operator|)
name|GET_NANOSEC
argument_list|(
operator|&
name|hra
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|GET_NANOSEC
argument_list|(
operator|&
name|hrb
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|enano
operator|>>
literal|32
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|enano
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * If the elapsed time is less than 1 millisecond, 		 * delay a period of time up to that millisecond of 		 * waiting. 		 * 		 * This peculiar code is an attempt to try and avoid 		 * invoking uint64_t math support functions for some 		 * platforms where linkage is a problem. 		 */
if|if
condition|(
name|enano
operator|<
operator|(
literal|1000
operator|*
literal|1000
operator|)
condition|)
block|{
name|count
operator|+=
literal|1000
expr_stmt|;
name|enano
operator|=
operator|(
literal|1000
operator|*
literal|1000
operator|)
operator|-
name|enano
expr_stmt|;
while|while
condition|(
name|enano
operator|>
operator|(
name|uint64_t
operator|)
literal|4000000000U
condition|)
block|{
name|ISP_SLEEP
argument_list|(
name|isp
argument_list|,
literal|4000000
argument_list|)
expr_stmt|;
name|enano
operator|-=
operator|(
name|uint64_t
operator|)
literal|4000000000U
expr_stmt|;
block|}
name|wrk
operator|=
name|enano
expr_stmt|;
name|wrk
operator|/=
literal|1000
expr_stmt|;
name|ISP_SLEEP
argument_list|(
name|isp
argument_list|,
name|wrk
argument_list|)
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|enano
operator|>
operator|(
name|uint64_t
operator|)
literal|4000000000U
condition|)
block|{
name|count
operator|+=
literal|4000000
expr_stmt|;
name|enano
operator|-=
operator|(
name|uint64_t
operator|)
literal|4000000000U
expr_stmt|;
block|}
name|wrk
operator|=
name|enano
expr_stmt|;
name|count
operator|+=
operator|(
name|wrk
operator|/
literal|1000
operator|)
expr_stmt|;
block|}
block|}
comment|/* 	 * If we haven't gone to 'ready' state, return. 	 */
if|if
condition|(
name|fcp
operator|->
name|isp_fwstate
operator|!=
name|FW_READY
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"%s: chan %d not at FW_READY state"
argument_list|,
name|__func__
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Get our Loop ID and Port ID. 	 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_GET_LOOP_ID
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|9
index|]
operator|=
name|chan
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|fcp
operator|->
name|isp_loopid
operator|=
name|mbs
operator|.
name|param
index|[
literal|1
index|]
expr_stmt|;
block|}
else|else
block|{
name|fcp
operator|->
name|isp_loopid
operator|=
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|&
literal|0xff
expr_stmt|;
block|}
if|if
condition|(
name|IS_2100
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|fcp
operator|->
name|isp_topo
operator|=
name|TOPO_NL_PORT
expr_stmt|;
block|}
else|else
block|{
name|int
name|topo
init|=
operator|(
name|int
operator|)
name|mbs
operator|.
name|param
index|[
literal|6
index|]
decl_stmt|;
if|if
condition|(
name|topo
operator|<
name|TOPO_NL_PORT
operator|||
name|topo
operator|>
name|TOPO_PTP_STUB
condition|)
block|{
name|topo
operator|=
name|TOPO_PTP_STUB
expr_stmt|;
block|}
name|fcp
operator|->
name|isp_topo
operator|=
name|topo
expr_stmt|;
block|}
name|fcp
operator|->
name|isp_portid
operator|=
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator||
operator|(
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|IS_2100
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* 		 * Don't bother with fabric if we are using really old 		 * 2100 firmware. It's just not worth it. 		 */
if|if
condition|(
name|ISP_FW_NEWER_THAN
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|,
literal|15
argument_list|,
literal|37
argument_list|)
condition|)
block|{
name|check_for_fabric
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|check_for_fabric
operator|=
literal|0
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_FL_PORT
operator|||
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_F_PORT
condition|)
block|{
name|check_for_fabric
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|check_for_fabric
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * Check to make sure we got a valid loopid 	 * The 24XX seems to mess this up for multiple channels. 	 */
if|if
condition|(
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_FL_PORT
operator|||
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_NL_PORT
condition|)
block|{
name|uint8_t
name|alpa
init|=
name|fcp
operator|->
name|isp_portid
decl_stmt|;
if|if
condition|(
name|alpa
operator|==
literal|0
condition|)
block|{
comment|/* "Cannot Happen" */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Zero AL_PA for Loop Topology?"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|alpa_map
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|alpa_map
index|[
name|i
index|]
operator|==
name|alpa
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|alpa_map
index|[
name|i
index|]
operator|&&
name|fcp
operator|->
name|isp_loopid
operator|!=
name|i
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d deriving loopid %d from AL_PA map (AL_PA 0x%x) and ignoring returned value %d (AL_PA 0x%x)"
argument_list|,
name|chan
argument_list|,
name|i
argument_list|,
name|alpa_map
index|[
name|i
index|]
argument_list|,
name|fcp
operator|->
name|isp_loopid
argument_list|,
name|alpa
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_loopid
operator|=
name|i
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* XXX SHOULDN'T THIS BE FOR 2K F/W? XXX */
name|loopid
operator|=
name|NPH_FL_ID
expr_stmt|;
block|}
else|else
block|{
name|loopid
operator|=
name|FL_ID
expr_stmt|;
block|}
if|if
condition|(
name|check_for_fabric
condition|)
block|{
name|r
operator|=
name|isp_getpdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|loopid
argument_list|,
operator|&
name|pdb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&&
operator|(
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_F_PORT
operator|||
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_FL_PORT
operator|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"fabric topology but cannot get info about fabric controller (0x%x)"
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_topo
operator|=
name|TOPO_PTP_STUB
expr_stmt|;
block|}
block|}
else|else
block|{
name|r
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|IS_2100
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|fcp
operator|->
name|isp_topo
operator|=
name|TOPO_FL_PORT
expr_stmt|;
block|}
if|if
condition|(
name|pdb
operator|.
name|portid
operator|==
literal|0
condition|)
block|{
comment|/* 			 * Crock. 			 */
name|fcp
operator|->
name|isp_topo
operator|=
name|TOPO_NL_PORT
expr_stmt|;
goto|goto
name|not_on_fabric
goto|;
block|}
comment|/* 		 * Save the Fabric controller's port database entry. 		 */
name|lp
operator|=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|FL_ID
index|]
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_PENDING_VALID
expr_stmt|;
name|MAKE_WWN_FROM_NODE_NAME
argument_list|(
name|lp
operator|->
name|node_wwn
argument_list|,
name|pdb
operator|.
name|nodename
argument_list|)
expr_stmt|;
name|MAKE_WWN_FROM_NODE_NAME
argument_list|(
name|lp
operator|->
name|port_wwn
argument_list|,
name|pdb
operator|.
name|portname
argument_list|)
expr_stmt|;
name|lp
operator|->
name|prli_word3
operator|=
name|pdb
operator|.
name|prli_word3
expr_stmt|;
name|lp
operator|->
name|portid
operator|=
name|pdb
operator|.
name|portid
expr_stmt|;
name|lp
operator|->
name|handle
operator|=
name|pdb
operator|.
name|handle
expr_stmt|;
name|lp
operator|->
name|new_portid
operator|=
name|lp
operator|->
name|portid
expr_stmt|;
name|lp
operator|->
name|new_prli_word3
operator|=
name|lp
operator|->
name|prli_word3
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|check_for_fabric
condition|)
block|{
comment|/* 				 * The mbs is still hanging out from the MBOX_GET_LOOP_ID above. 				 */
name|fcp
operator|->
name|isp_fabric_params
operator|=
name|mbs
operator|.
name|param
index|[
literal|7
index|]
expr_stmt|;
block|}
else|else
block|{
name|fcp
operator|->
name|isp_fabric_params
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|chan
condition|)
block|{
name|fcp
operator|->
name|isp_sns_hdl
operator|=
name|NPH_SNS_HDLBASE
operator|+
name|chan
expr_stmt|;
name|r
operator|=
name|isp_plogx
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|fcp
operator|->
name|isp_sns_hdl
argument_list|,
name|SNS_PORT_ID
argument_list|,
name|PLOGX_FLG_CMD_PLOGI
operator||
name|PLOGX_FLG_COND_PLOGI
operator||
name|PLOGX_FLG_SKIP_PRLI
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"%s: Chan %d cannot log into SNS"
argument_list|,
name|__func__
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
name|fcp
operator|->
name|isp_sns_hdl
operator|=
name|NPH_SNS_ID
expr_stmt|;
block|}
name|r
operator|=
name|isp_register_fc4_type_24xx
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fcp
operator|->
name|isp_sns_hdl
operator|=
name|SNS_ID
expr_stmt|;
name|r
operator|=
name|isp_register_fc4_type
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
operator||
name|ISP_LOG_SANCFG
argument_list|,
literal|"%s: register fc4 type failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
name|not_on_fabric
label|:
name|fcp
operator|->
name|portdb
index|[
name|FL_ID
index|]
operator|.
name|state
operator|=
name|FC_PORTDB_STATE_NIL
expr_stmt|;
block|}
name|fcp
operator|->
name|isp_gbspeed
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|IS_23XX
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_GET_SET_DATA_RATE
argument_list|,
name|MBLOGALL
argument_list|,
literal|3000000
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|MBGSD_GET_RATE
expr_stmt|;
comment|/* mbs.param[2] undefined if we're just getting rate */
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|==
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|==
name|MBGSD_EIGHTGB
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Chan %d 8Gb link speed"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_gbspeed
operator|=
literal|8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|==
name|MBGSD_FOURGB
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Chan %d 4Gb link speed"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_gbspeed
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|==
name|MBGSD_TWOGB
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Chan %d 2Gb link speed"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_gbspeed
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|==
name|MBGSD_ONEGB
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Chan %d 1Gb link speed"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_gbspeed
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
comment|/* 	 * Announce ourselves, too. 	 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
operator||
name|ISP_LOGCONFIG
argument_list|,
name|topology
argument_list|,
name|chan
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|fcp
operator|->
name|isp_wwpn
argument_list|,
name|fcp
operator|->
name|isp_portid
argument_list|,
name|fcp
operator|->
name|isp_loopid
argument_list|,
name|isp_fc_toponame
argument_list|(
name|fcp
argument_list|)
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC Link Test Complete"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Complete the synchronization of our Port Database.  *  * At this point, we've scanned the local loop (if any) and the fabric  * and performed fabric logins on all new devices.  *  * Our task here is to go through our port database and remove any entities  * that are still marked probational (issuing PLOGO for ones which we had  * PLOGI'd into) or are dead.  *  * Our task here is to also check policy to decide whether devices which  * have *changed* in some way should still be kept active. For example,  * if a device has just changed PortID, we can either elect to treat it  * as an old device or as a newly arrived device (and notify the outer  * layer appropriately).  *  * We also do initiator map target id assignment here for new initiator  * devices and refresh old ones ot make sure that they point to the correct  * entities.  */
end_comment

begin_function
specifier|static
name|int
name|isp_pdb_sync
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
name|uint16_t
name|dbidx
decl_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|==
name|LOOP_READY
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Make sure we're okay for doing this right now. 	 */
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|!=
name|LOOP_PDB_RCVD
operator|&&
name|fcp
operator|->
name|isp_loopstate
operator|!=
name|LOOP_FSCAN_DONE
operator|&&
name|fcp
operator|->
name|isp_loopstate
operator|!=
name|LOOP_LSCAN_DONE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"isp_pdb_sync: bad loopstate %d"
argument_list|,
name|fcp
operator|->
name|isp_loopstate
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_FL_PORT
operator|||
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_NL_PORT
operator|||
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_N_PORT
condition|)
block|{
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_LSCAN_DONE
condition|)
block|{
if|if
condition|(
name|isp_scan_loop
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"isp_pdb_sync: isp_scan_loop failed"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_F_PORT
operator|||
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_FL_PORT
condition|)
block|{
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_FSCAN_DONE
condition|)
block|{
if|if
condition|(
name|isp_scan_fabric
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"isp_pdb_sync: isp_scan_fabric failed"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Synchronizing PDBs"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_SYNCING_PDB
expr_stmt|;
for|for
control|(
name|dbidx
operator|=
literal|0
init|;
name|dbidx
operator|<
name|MAX_FC_TARG
condition|;
name|dbidx
operator|++
control|)
block|{
name|lp
operator|=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|dbidx
index|]
expr_stmt|;
if|if
condition|(
name|lp
operator|->
name|state
operator|==
name|FC_PORTDB_STATE_NIL
operator|||
name|lp
operator|->
name|target_mode
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|lp
operator|->
name|state
operator|==
name|FC_PORTDB_STATE_VALID
condition|)
block|{
if|if
condition|(
name|dbidx
operator|!=
name|FL_ID
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"portdb idx %d already valid"
argument_list|,
name|dbidx
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
switch|switch
condition|(
name|lp
operator|->
name|state
condition|)
block|{
case|case
name|FC_PORTDB_STATE_PROBATIONAL
case|:
case|case
name|FC_PORTDB_STATE_DEAD
case|:
comment|/* 			 * It's up to the outer layers to clear isp_dev_map. 			 */
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_NIL
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_DEV_GONE
argument_list|,
name|chan
argument_list|,
name|lp
argument_list|)
expr_stmt|;
if|if
condition|(
name|lp
operator|->
name|autologin
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|isp_plogx
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|lp
operator|->
name|handle
argument_list|,
name|lp
operator|->
name|portid
argument_list|,
name|PLOGX_FLG_CMD_LOGO
operator||
name|PLOGX_FLG_IMPLICIT
operator||
name|PLOGX_FLG_FREE_NPHDL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lp
operator|->
name|autologin
operator|=
literal|0
expr_stmt|;
block|}
name|lp
operator|->
name|new_prli_word3
operator|=
literal|0
expr_stmt|;
name|lp
operator|->
name|new_portid
operator|=
literal|0
expr_stmt|;
comment|/* 			 * Note that we might come out of this with our state 			 * set to FC_PORTDB_STATE_ZOMBIE. 			 */
break|break;
case|case
name|FC_PORTDB_STATE_NEW
case|:
comment|/* 			 * It's up to the outer layers to assign a virtual 			 * target id in isp_dev_map (if any). 			 */
name|lp
operator|->
name|portid
operator|=
name|lp
operator|->
name|new_portid
expr_stmt|;
name|lp
operator|->
name|prli_word3
operator|=
name|lp
operator|->
name|new_prli_word3
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_VALID
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_DEV_ARRIVED
argument_list|,
name|chan
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|lp
operator|->
name|new_prli_word3
operator|=
literal|0
expr_stmt|;
name|lp
operator|->
name|new_portid
operator|=
literal|0
expr_stmt|;
name|lp
operator|->
name|announced
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|FC_PORTDB_STATE_CHANGED
case|:
comment|/*  * XXXX FIX THIS  */
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_VALID
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_DEV_CHANGED
argument_list|,
name|chan
argument_list|,
name|lp
argument_list|)
expr_stmt|;
name|lp
operator|->
name|new_prli_word3
operator|=
literal|0
expr_stmt|;
name|lp
operator|->
name|new_portid
operator|=
literal|0
expr_stmt|;
name|lp
operator|->
name|announced
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|FC_PORTDB_STATE_PENDING_VALID
case|:
name|lp
operator|->
name|portid
operator|=
name|lp
operator|->
name|new_portid
expr_stmt|;
name|lp
operator|->
name|prli_word3
operator|=
name|lp
operator|->
name|new_prli_word3
expr_stmt|;
if|if
condition|(
name|lp
operator|->
name|dev_map_idx
condition|)
block|{
name|int
name|t
init|=
name|lp
operator|->
name|dev_map_idx
operator|-
literal|1
decl_stmt|;
name|fcp
operator|->
name|isp_dev_map
index|[
name|t
index|]
operator|=
name|dbidx
operator|+
literal|1
expr_stmt|;
block|}
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_VALID
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_DEV_STAYED
argument_list|,
name|chan
argument_list|,
name|lp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbidx
operator|!=
name|FL_ID
condition|)
block|{
name|lp
operator|->
name|new_prli_word3
operator|=
literal|0
expr_stmt|;
name|lp
operator|->
name|new_portid
operator|=
literal|0
expr_stmt|;
block|}
name|lp
operator|->
name|announced
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|FC_PORTDB_STATE_ZOMBIE
case|:
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"isp_scan_loop: state %d for idx %d"
argument_list|,
name|lp
operator|->
name|state
argument_list|,
name|dbidx
argument_list|)
expr_stmt|;
name|isp_dump_portdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * If we get here, we've for sure seen not only a valid loop 	 * but know what is or isn't on it, so mark this for usage 	 * in isp_start. 	 */
name|fcp
operator|->
name|loop_seen_once
operator|=
literal|1
expr_stmt|;
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_READY
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Scan local loop for devices.  */
end_comment

begin_function
specifier|static
name|int
name|isp_scan_loop
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|fcportdb_t
modifier|*
name|lp
decl_stmt|,
name|tmp
decl_stmt|;
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|isp_pdb_t
name|pdb
decl_stmt|;
name|uint16_t
name|handle
decl_stmt|,
name|lim
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_fwstate
operator|<
name|FW_READY
operator|||
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_PDB_RCVD
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|>
name|LOOP_SCANNING_LOOP
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Check our connection topology. 	 * 	 * If we're a public or private loop, we scan 0..125 as handle values. 	 * The firmware has (typically) peformed a PLOGI for us. We skip this 	 * step if we're a ISP_24XX in NP-IV mode. 	 * 	 * If we're a N-port connection, we treat this is a short loop (0..1). 	 */
switch|switch
condition|(
name|fcp
operator|->
name|isp_topo
condition|)
block|{
case|case
name|TOPO_NL_PORT
case|:
name|lim
operator|=
name|LOCAL_LOOP_LIM
expr_stmt|;
break|break;
case|case
name|TOPO_FL_PORT
case|:
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
operator|&&
name|isp
operator|->
name|isp_nchan
operator|>
literal|1
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Skipping Local Loop Scan"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_LSCAN_DONE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|lim
operator|=
name|LOCAL_LOOP_LIM
expr_stmt|;
break|break;
case|case
name|TOPO_N_PORT
case|:
name|lim
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d no loop topology to scan"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_LSCAN_DONE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_SCANNING_LOOP
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC scan loop 0..%d"
argument_list|,
name|chan
argument_list|,
name|lim
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Run through the list and get the port database info for each one. 	 */
for|for
control|(
name|handle
operator|=
literal|0
init|;
name|handle
operator|<
name|lim
condition|;
name|handle
operator|++
control|)
block|{
name|int
name|r
decl_stmt|;
comment|/* 		 * Don't scan "special" ids. 		 */
if|if
condition|(
name|handle
operator|>=
name|FL_ID
operator|&&
name|handle
operator|<=
name|SNS_ID
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|handle
operator|>=
name|NPH_RESERVED
operator|&&
name|handle
operator|<=
name|NPH_FL_ID
condition|)
block|{
continue|continue;
block|}
block|}
comment|/* 		 * In older cards with older f/w GET_PORT_DATABASE has been 		 * known to hang. This trick gets around that problem. 		 */
if|if
condition|(
name|IS_2100
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_2200
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|uint64_t
name|node_wwn
init|=
name|isp_get_wwn
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_SCANNING_LOOP
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC scan loop DONE (bad)"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|node_wwn
operator|==
name|INI_NONE
condition|)
block|{
continue|continue;
block|}
block|}
comment|/* 		 * Get the port database entity for this index. 		 */
name|r
operator|=
name|isp_getpdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|,
operator|&
name|pdb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"Chan %d FC scan loop handle %d returned %x"
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|,
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_SCANNING_LOOP
condition|)
block|{
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC scan loop DONE (bad)"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
continue|continue;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_SCANNING_LOOP
condition|)
block|{
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC scan loop DONE (bad)"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 		 * On *very* old 2100 firmware we would end up sometimes 		 * with the firmware returning the port database entry 		 * for something else. We used to restart this, but 		 * now we just punt. 		 */
if|if
condition|(
name|IS_2100
argument_list|(
name|isp
argument_list|)
operator|&&
name|pdb
operator|.
name|handle
operator|!=
name|handle
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d cannot synchronize port database"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC scan loop DONE (bad)"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 		 * Save the pertinent info locally. 		 */
name|MAKE_WWN_FROM_NODE_NAME
argument_list|(
name|tmp
operator|.
name|node_wwn
argument_list|,
name|pdb
operator|.
name|nodename
argument_list|)
expr_stmt|;
name|MAKE_WWN_FROM_NODE_NAME
argument_list|(
name|tmp
operator|.
name|port_wwn
argument_list|,
name|pdb
operator|.
name|portname
argument_list|)
expr_stmt|;
name|tmp
operator|.
name|prli_word3
operator|=
name|pdb
operator|.
name|prli_word3
expr_stmt|;
name|tmp
operator|.
name|portid
operator|=
name|pdb
operator|.
name|portid
expr_stmt|;
name|tmp
operator|.
name|handle
operator|=
name|pdb
operator|.
name|handle
expr_stmt|;
comment|/* 		 * Check to make sure it's still a valid entry. The 24XX seems 		 * to return a portid but not a WWPN/WWNN or role for devices 		 * which shift on a loop. 		 */
if|if
condition|(
name|tmp
operator|.
name|node_wwn
operator|==
literal|0
operator|||
name|tmp
operator|.
name|port_wwn
operator|==
literal|0
operator|||
name|tmp
operator|.
name|portid
operator|==
literal|0
condition|)
block|{
name|int
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
name|a
operator|=
operator|(
name|tmp
operator|.
name|node_wwn
operator|==
literal|0
operator|)
expr_stmt|;
name|b
operator|=
operator|(
name|tmp
operator|.
name|port_wwn
operator|==
literal|0
operator|)
expr_stmt|;
name|c
operator|=
operator|(
name|tmp
operator|.
name|portid
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|a
operator|==
literal|0
operator|&&
name|b
operator|==
literal|0
condition|)
block|{
name|tmp
operator|.
name|node_wwn
operator|=
name|isp_get_wwn
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp
operator|.
name|port_wwn
operator|=
name|isp_get_wwn
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|.
name|node_wwn
operator|&&
name|tmp
operator|.
name|port_wwn
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"DODGED!"
argument_list|)
expr_stmt|;
goto|goto
name|cont
goto|;
block|}
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d bad pdb (%1d%1d%1d) @ handle 0x%x"
argument_list|,
name|chan
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|handle
argument_list|)
expr_stmt|;
name|isp_dump_portdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|cont
label|:
comment|/* 		 * Now search the entire port database 		 * for the same Port and Node WWN. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_FC_TARG
condition|;
name|i
operator|++
control|)
block|{
name|lp
operator|=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|lp
operator|->
name|state
operator|==
name|FC_PORTDB_STATE_NIL
operator|||
name|lp
operator|->
name|target_mode
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|lp
operator|->
name|node_wwn
operator|!=
name|tmp
operator|.
name|node_wwn
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|lp
operator|->
name|port_wwn
operator|!=
name|tmp
operator|.
name|port_wwn
condition|)
block|{
continue|continue;
block|}
comment|/* 			 * Okay- we've found a non-nil entry that matches. 			 * Check to make sure it's probational or a zombie. 			 */
if|if
condition|(
name|lp
operator|->
name|state
operator|!=
name|FC_PORTDB_STATE_PROBATIONAL
operator|&&
name|lp
operator|->
name|state
operator|!=
name|FC_PORTDB_STATE_ZOMBIE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Chan %d [%d] not probational/zombie (0x%x)"
argument_list|,
name|chan
argument_list|,
name|i
argument_list|,
name|lp
operator|->
name|state
argument_list|)
expr_stmt|;
name|isp_dump_portdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC scan loop DONE (bad)"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 			 * Mark the device as something the f/w logs into 			 * automatically. 			 */
name|lp
operator|->
name|autologin
operator|=
literal|1
expr_stmt|;
comment|/* 			 * Check to make see if really still the same 			 * device. If it is, we mark it pending valid. 			 */
if|if
condition|(
name|lp
operator|->
name|portid
operator|==
name|tmp
operator|.
name|portid
operator|&&
name|lp
operator|->
name|handle
operator|==
name|tmp
operator|.
name|handle
operator|&&
name|lp
operator|->
name|prli_word3
operator|==
name|tmp
operator|.
name|prli_word3
condition|)
block|{
name|lp
operator|->
name|new_portid
operator|=
name|tmp
operator|.
name|portid
expr_stmt|;
name|lp
operator|->
name|new_prli_word3
operator|=
name|tmp
operator|.
name|prli_word3
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_PENDING_VALID
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Loop Port 0x%06x@0x%04x Pending Valid"
argument_list|,
name|chan
argument_list|,
name|tmp
operator|.
name|portid
argument_list|,
name|tmp
operator|.
name|handle
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 			 * We can wipe out the old handle value 			 * here because it's no longer valid. 			 */
name|lp
operator|->
name|handle
operator|=
name|tmp
operator|.
name|handle
expr_stmt|;
comment|/* 			 * Claim that this has changed and let somebody else 			 * decide what to do. 			 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Loop Port 0x%06x@0x%04x changed"
argument_list|,
name|chan
argument_list|,
name|tmp
operator|.
name|portid
argument_list|,
name|tmp
operator|.
name|handle
argument_list|)
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_CHANGED
expr_stmt|;
name|lp
operator|->
name|new_portid
operator|=
name|tmp
operator|.
name|portid
expr_stmt|;
name|lp
operator|->
name|new_prli_word3
operator|=
name|tmp
operator|.
name|prli_word3
expr_stmt|;
break|break;
block|}
comment|/* 		 * Did we find and update an old entry? 		 */
if|if
condition|(
name|i
operator|<
name|MAX_FC_TARG
condition|)
block|{
continue|continue;
block|}
comment|/* 		 * Ah. A new device entry. Find an empty slot 		 * for it and save info for later disposition. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_FC_TARG
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
operator|.
name|target_mode
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
operator|.
name|state
operator|==
name|FC_PORTDB_STATE_NIL
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|MAX_FC_TARG
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Chan %d out of portdb entries"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|lp
operator|=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|i
index|]
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|lp
argument_list|,
sizeof|sizeof
argument_list|(
name|fcportdb_t
argument_list|)
argument_list|)
expr_stmt|;
name|lp
operator|->
name|autologin
operator|=
literal|1
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_NEW
expr_stmt|;
name|lp
operator|->
name|new_portid
operator|=
name|tmp
operator|.
name|portid
expr_stmt|;
name|lp
operator|->
name|new_prli_word3
operator|=
name|tmp
operator|.
name|prli_word3
expr_stmt|;
name|lp
operator|->
name|handle
operator|=
name|tmp
operator|.
name|handle
expr_stmt|;
name|lp
operator|->
name|port_wwn
operator|=
name|tmp
operator|.
name|port_wwn
expr_stmt|;
name|lp
operator|->
name|node_wwn
operator|=
name|tmp
operator|.
name|node_wwn
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Loop Port 0x%06x@0x%04x is New Entry"
argument_list|,
name|chan
argument_list|,
name|tmp
operator|.
name|portid
argument_list|,
name|tmp
operator|.
name|handle
argument_list|)
expr_stmt|;
block|}
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_LSCAN_DONE
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC scan loop DONE"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Scan the fabric for devices and add them to our port database.  *  * Use the GID_FT command to get all Port IDs for FC4 SCSI devices it knows.  *  * For 2100-23XX cards, we can use the SNS mailbox command to pass simple  * name server commands to the switch management server via the QLogic f/w.  *  * For the 24XX card, we have to use CT-Pass through run via the Execute IOCB  * mailbox command.  *  * The net result is to leave the list of Port IDs setting untranslated in  * offset IGPOFF of the FC scratch area, whereupon we'll canonicalize it to  * host order at OGPOFF.  */
end_comment

begin_comment
comment|/*  * Take less than half of our scratch area to store Port IDs  */
end_comment

begin_define
define|#
directive|define
name|GIDLEN
value|((ISP_FC_SCRLEN>> 1) - 16 - SNS_GID_FT_REQ_SIZE)
end_define

begin_define
define|#
directive|define
name|NGENT
value|((GIDLEN - 16)>> 2)
end_define

begin_define
define|#
directive|define
name|IGPOFF
value|(2 * QENTRY_LEN)
end_define

begin_define
define|#
directive|define
name|OGPOFF
value|(ISP_FC_SCRLEN>> 1)
end_define

begin_define
define|#
directive|define
name|ZTXOFF
value|(ISP_FC_SCRLEN - (1 * QENTRY_LEN))
end_define

begin_define
define|#
directive|define
name|CTXOFF
value|(ISP_FC_SCRLEN - (2 * QENTRY_LEN))
end_define

begin_define
define|#
directive|define
name|XTXOFF
value|(ISP_FC_SCRLEN - (3 * QENTRY_LEN))
end_define

begin_function
specifier|static
name|int
name|isp_gid_ft_sns
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
union|union
block|{
name|sns_gid_ft_req_t
name|_x
decl_stmt|;
name|uint8_t
name|_y
index|[
name|SNS_GID_FT_REQ_SIZE
index|]
decl_stmt|;
block|}
name|un
union|;
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|sns_gid_ft_req_t
modifier|*
name|rq
init|=
operator|&
name|un
operator|.
name|_x
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"Chan %d scanning fabric (GID_FT) via SNS"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|rq
argument_list|,
name|SNS_GID_FT_REQ_SIZE
argument_list|)
expr_stmt|;
name|rq
operator|->
name|snscb_rblen
operator|=
name|GIDLEN
operator|>>
literal|1
expr_stmt|;
name|rq
operator|->
name|snscb_addr
index|[
name|RQRSP_ADDR0015
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|IGPOFF
argument_list|)
expr_stmt|;
name|rq
operator|->
name|snscb_addr
index|[
name|RQRSP_ADDR1631
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|IGPOFF
argument_list|)
expr_stmt|;
name|rq
operator|->
name|snscb_addr
index|[
name|RQRSP_ADDR3247
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|IGPOFF
argument_list|)
expr_stmt|;
name|rq
operator|->
name|snscb_addr
index|[
name|RQRSP_ADDR4863
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|IGPOFF
argument_list|)
expr_stmt|;
name|rq
operator|->
name|snscb_sblen
operator|=
literal|6
expr_stmt|;
name|rq
operator|->
name|snscb_cmd
operator|=
name|SNS_GID_FT
expr_stmt|;
name|rq
operator|->
name|snscb_mword_div_2
operator|=
name|NGENT
expr_stmt|;
name|rq
operator|->
name|snscb_fc4_type
operator|=
name|FC4_SCSI
expr_stmt|;
name|isp_put_gid_ft_request
argument_list|(
name|isp
argument_list|,
name|rq
argument_list|,
name|fcp
operator|->
name|isp_scratch
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORDEV
argument_list|,
literal|0
argument_list|,
name|SNS_GID_FT_REQ_SIZE
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SEND_SNS
argument_list|,
name|MBLOGALL
argument_list|,
literal|10000000
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SEND_SNS
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|SNS_GID_FT_REQ_SIZE
operator|>>
literal|1
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|==
name|MBOX_INVALID_COMMAND
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isp_gid_ft_ct_passthru
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
union|union
block|{
name|isp_ct_pt_t
name|plocal
decl_stmt|;
name|ct_hdr_t
name|clocal
decl_stmt|;
name|uint8_t
name|q
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
block|}
name|un
union|;
name|isp_ct_pt_t
modifier|*
name|pt
decl_stmt|;
name|ct_hdr_t
modifier|*
name|ct
decl_stmt|;
name|uint32_t
modifier|*
name|rp
decl_stmt|;
name|uint8_t
modifier|*
name|scp
init|=
name|fcp
operator|->
name|isp_scratch
decl_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"Chan %d scanning fabric (GID_FT) via CT"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* 	 * Build a Passthrough IOCB in memory. 	 */
name|pt
operator|=
operator|&
name|un
operator|.
name|plocal
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|un
operator|.
name|q
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|pt
operator|->
name|ctp_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_CT_PASSTHRU
expr_stmt|;
name|pt
operator|->
name|ctp_handle
operator|=
literal|0xffffffff
expr_stmt|;
name|pt
operator|->
name|ctp_nphdl
operator|=
name|fcp
operator|->
name|isp_sns_hdl
expr_stmt|;
name|pt
operator|->
name|ctp_cmd_cnt
operator|=
literal|1
expr_stmt|;
name|pt
operator|->
name|ctp_vpidx
operator|=
name|ISP_GET_VPIDX
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_time
operator|=
literal|30
expr_stmt|;
name|pt
operator|->
name|ctp_rsp_cnt
operator|=
literal|1
expr_stmt|;
name|pt
operator|->
name|ctp_rsp_bcnt
operator|=
name|GIDLEN
expr_stmt|;
name|pt
operator|->
name|ctp_cmd_bcnt
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ct
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|0
index|]
operator|.
name|ds_base
operator|=
name|DMA_LO32
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|XTXOFF
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|0
index|]
operator|.
name|ds_basehi
operator|=
name|DMA_HI32
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|XTXOFF
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|0
index|]
operator|.
name|ds_count
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ct
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|1
index|]
operator|.
name|ds_base
operator|=
name|DMA_LO32
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|IGPOFF
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|1
index|]
operator|.
name|ds_basehi
operator|=
name|DMA_HI32
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|IGPOFF
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|1
index|]
operator|.
name|ds_count
operator|=
name|GIDLEN
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"ct IOCB"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|pt
argument_list|)
expr_stmt|;
block|}
name|isp_put_ct_pt
argument_list|(
name|isp
argument_list|,
name|pt
argument_list|,
operator|(
name|isp_ct_pt_t
operator|*
operator|)
operator|&
name|scp
index|[
name|CTXOFF
index|]
argument_list|)
expr_stmt|;
comment|/* 	 * Build the CT header and command in memory. 	 * 	 * Note that the CT header has to end up as Big Endian format in memory. 	 */
name|ct
operator|=
operator|&
name|un
operator|.
name|clocal
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|ct
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ct
argument_list|)
argument_list|)
expr_stmt|;
name|ct
operator|->
name|ct_revision
operator|=
name|CT_REVISION
expr_stmt|;
name|ct
operator|->
name|ct_fcs_type
operator|=
name|CT_FC_TYPE_FC
expr_stmt|;
name|ct
operator|->
name|ct_fcs_subtype
operator|=
name|CT_FC_SUBTYPE_NS
expr_stmt|;
name|ct
operator|->
name|ct_cmd_resp
operator|=
name|SNS_GID_FT
expr_stmt|;
name|ct
operator|->
name|ct_bcnt_resid
operator|=
operator|(
name|GIDLEN
operator|-
literal|16
operator|)
operator|>>
literal|2
expr_stmt|;
name|isp_put_ct_hdr
argument_list|(
name|isp
argument_list|,
name|ct
argument_list|,
operator|(
name|ct_hdr_t
operator|*
operator|)
operator|&
name|scp
index|[
name|XTXOFF
index|]
argument_list|)
expr_stmt|;
name|rp
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|scp
index|[
name|XTXOFF
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ct
argument_list|)
index|]
expr_stmt|;
name|ISP_IOZPUT_32
argument_list|(
name|isp
argument_list|,
name|FC4_SCSI
argument_list|,
name|rp
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"CT HDR + payload after put"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ct
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
operator|&
name|scp
index|[
name|XTXOFF
index|]
argument_list|)
expr_stmt|;
block|}
name|ISP_MEMZERO
argument_list|(
operator|&
name|scp
index|[
name|ZTXOFF
index|]
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_EXEC_COMMAND_IOCB_A64
argument_list|,
name|MBLOGALL
argument_list|,
literal|500000
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|QENTRY_LEN
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|CTXOFF
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|CTXOFF
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|CTXOFF
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|CTXOFF
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORDEV
argument_list|,
name|XTXOFF
argument_list|,
literal|2
operator|*
name|QENTRY_LEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORCPU
argument_list|,
name|ZTXOFF
argument_list|,
name|QENTRY_LEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|pt
operator|=
operator|&
name|un
operator|.
name|plocal
expr_stmt|;
name|isp_get_ct_pt
argument_list|(
name|isp
argument_list|,
operator|(
name|isp_ct_pt_t
operator|*
operator|)
operator|&
name|scp
index|[
name|ZTXOFF
index|]
argument_list|,
name|pt
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"IOCB response"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|pt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pt
operator|->
name|ctp_status
operator|&&
name|pt
operator|->
name|ctp_status
operator|!=
name|RQCS_DATA_UNDERRUN
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d ISP GID FT CT Passthrough returned 0x%x"
argument_list|,
name|chan
argument_list|,
name|pt
operator|->
name|ctp_status
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORCPU
argument_list|,
name|IGPOFF
argument_list|,
name|GIDLEN
operator|+
literal|16
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"CT response"
argument_list|,
name|GIDLEN
operator|+
literal|16
argument_list|,
operator|&
name|scp
index|[
name|IGPOFF
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isp_scan_fabric
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|uint32_t
name|portid
decl_stmt|;
name|uint16_t
name|handle
decl_stmt|,
name|oldhandle
decl_stmt|,
name|loopid
decl_stmt|;
name|isp_pdb_t
name|pdb
decl_stmt|;
name|int
name|portidx
decl_stmt|,
name|portlim
decl_stmt|,
name|r
decl_stmt|;
name|sns_gid_ft_rsp_t
modifier|*
name|rs0
decl_stmt|,
modifier|*
name|rs1
decl_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC Scan Fabric"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_fwstate
operator|!=
name|FW_READY
operator|||
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_LSCAN_DONE
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|>
name|LOOP_SCANNING_FABRIC
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_topo
operator|!=
name|TOPO_FL_PORT
operator|&&
name|fcp
operator|->
name|isp_topo
operator|!=
name|TOPO_F_PORT
condition|)
block|{
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_FSCAN_DONE
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC Scan Fabric Done (no fabric)"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_SCANNING_FABRIC
expr_stmt|;
if|if
condition|(
name|FC_SCRATCH_ACQUIRE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|sacq
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_SCANNING_FABRIC
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Make sure we still are logged into the fabric controller. 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* XXX SHOULDN'T THIS BE TRUE FOR 2K F/W? XXX */
name|loopid
operator|=
name|NPH_FL_ID
expr_stmt|;
block|}
else|else
block|{
name|loopid
operator|=
name|FL_ID
expr_stmt|;
block|}
name|r
operator|=
name|isp_getpdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|loopid
argument_list|,
operator|&
name|pdb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|MBOX_NOT_LOGGED_IN
condition|)
block|{
name|isp_dump_chip_portdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
condition|)
block|{
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_PDB_RCVD
expr_stmt|;
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|r
operator|=
name|isp_gid_ft_ct_passthru
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|isp_gid_ft_sns
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_SCANNING_FABRIC
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|r
operator|>
literal|0
condition|)
block|{
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_FSCAN_DONE
expr_stmt|;
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|r
operator|<
literal|0
condition|)
block|{
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_PDB_RCVD
expr_stmt|;
comment|/* try again */
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORCPU
argument_list|,
name|IGPOFF
argument_list|,
name|GIDLEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|rs0
operator|=
operator|(
name|sns_gid_ft_rsp_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|fcp
operator|->
name|isp_scratch
operator|+
name|IGPOFF
operator|)
expr_stmt|;
name|rs1
operator|=
operator|(
name|sns_gid_ft_rsp_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|fcp
operator|->
name|isp_scratch
operator|+
name|OGPOFF
operator|)
expr_stmt|;
name|isp_get_gid_ft_response
argument_list|(
name|isp
argument_list|,
name|rs0
argument_list|,
name|rs1
argument_list|,
name|NGENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|<
name|LOOP_SCANNING_FABRIC
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|rs1
operator|->
name|snscb_cthdr
operator|.
name|ct_cmd_resp
operator|!=
name|LS_ACC
condition|)
block|{
name|int
name|level
decl_stmt|;
if|if
condition|(
name|rs1
operator|->
name|snscb_cthdr
operator|.
name|ct_reason
operator|==
literal|9
operator|&&
name|rs1
operator|->
name|snscb_cthdr
operator|.
name|ct_explanation
operator|==
literal|7
condition|)
block|{
name|level
operator|=
name|ISP_LOG_SANCFG
expr_stmt|;
block|}
else|else
block|{
name|level
operator|=
name|ISP_LOGWARN
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|level
argument_list|,
literal|"Chan %d Fabric Nameserver rejected GID_FT"
literal|" (Reason=0x%x Expl=0x%x)"
argument_list|,
name|chan
argument_list|,
name|rs1
operator|->
name|snscb_cthdr
operator|.
name|ct_reason
argument_list|,
name|rs1
operator|->
name|snscb_cthdr
operator|.
name|ct_explanation
argument_list|)
expr_stmt|;
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_FSCAN_DONE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * If we get this far, we certainly still have the fabric controller. 	 */
name|fcp
operator|->
name|portdb
index|[
name|FL_ID
index|]
operator|.
name|state
operator|=
name|FC_PORTDB_STATE_PENDING_VALID
expr_stmt|;
comment|/* 	 * Prime the handle we will start using. 	 */
name|oldhandle
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|isp_lasthdl
expr_stmt|;
comment|/* 	 * Go through the list and remove duplicate port ids. 	 */
name|portlim
operator|=
literal|0
expr_stmt|;
name|portidx
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|portidx
operator|=
literal|0
init|;
name|portidx
operator|<
name|NGENT
operator|-
literal|1
condition|;
name|portidx
operator|++
control|)
block|{
if|if
condition|(
name|rs1
operator|->
name|snscb_ports
index|[
name|portidx
index|]
operator|.
name|control
operator|&
literal|0x80
condition|)
block|{
break|break;
block|}
block|}
comment|/* 	 * If we're not at the last entry, our list wasn't big enough. 	 */
if|if
condition|(
operator|(
name|rs1
operator|->
name|snscb_ports
index|[
name|portidx
index|]
operator|.
name|control
operator|&
literal|0x80
operator|)
operator|==
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"fabric too big for scratch area: increase ISP_FC_SCRLEN"
argument_list|)
expr_stmt|;
block|}
name|portlim
operator|=
name|portidx
operator|+
literal|1
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d got %d ports back from name server"
argument_list|,
name|chan
argument_list|,
name|portlim
argument_list|)
expr_stmt|;
for|for
control|(
name|portidx
operator|=
literal|0
init|;
name|portidx
operator|<
name|portlim
condition|;
name|portidx
operator|++
control|)
block|{
name|int
name|npidx
decl_stmt|;
name|portid
operator|=
operator|(
operator|(
name|rs1
operator|->
name|snscb_ports
index|[
name|portidx
index|]
operator|.
name|portid
index|[
literal|0
index|]
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|rs1
operator|->
name|snscb_ports
index|[
name|portidx
index|]
operator|.
name|portid
index|[
literal|1
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|rs1
operator|->
name|snscb_ports
index|[
name|portidx
index|]
operator|.
name|portid
index|[
literal|2
index|]
operator|)
operator|)
expr_stmt|;
for|for
control|(
name|npidx
operator|=
name|portidx
operator|+
literal|1
init|;
name|npidx
operator|<
name|portlim
condition|;
name|npidx
operator|++
control|)
block|{
name|uint32_t
name|new_portid
init|=
operator|(
operator|(
name|rs1
operator|->
name|snscb_ports
index|[
name|npidx
index|]
operator|.
name|portid
index|[
literal|0
index|]
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|rs1
operator|->
name|snscb_ports
index|[
name|npidx
index|]
operator|.
name|portid
index|[
literal|1
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|rs1
operator|->
name|snscb_ports
index|[
name|npidx
index|]
operator|.
name|portid
index|[
literal|2
index|]
operator|)
operator|)
decl_stmt|;
if|if
condition|(
name|new_portid
operator|==
name|portid
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|npidx
operator|<
name|portlim
condition|)
block|{
name|rs1
operator|->
name|snscb_ports
index|[
name|npidx
index|]
operator|.
name|portid
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|rs1
operator|->
name|snscb_ports
index|[
name|npidx
index|]
operator|.
name|portid
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|rs1
operator|->
name|snscb_ports
index|[
name|npidx
index|]
operator|.
name|portid
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d removing duplicate PortID 0x%06x entry from list"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * We now have a list of Port IDs for all FC4 SCSI devices 	 * that the Fabric Name server knows about. 	 * 	 * For each entry on this list go through our port database looking 	 * for probational entries- if we find one, then an old entry is 	 * maybe still this one. We get some information to find out. 	 * 	 * Otherwise, it's a new fabric device, and we log into it 	 * (unconditionally). After searching the entire database 	 * again to make sure that we never ever ever ever have more 	 * than one entry that has the same PortID or the same 	 * WWNN/WWPN duple, we enter the device into our database. 	 */
for|for
control|(
name|portidx
operator|=
literal|0
init|;
name|portidx
operator|<
name|portlim
condition|;
name|portidx
operator|++
control|)
block|{
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
name|uint64_t
name|wwnn
decl_stmt|,
name|wwpn
decl_stmt|;
name|int
name|dbidx
decl_stmt|,
name|nr
decl_stmt|;
name|portid
operator|=
operator|(
operator|(
name|rs1
operator|->
name|snscb_ports
index|[
name|portidx
index|]
operator|.
name|portid
index|[
literal|0
index|]
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|rs1
operator|->
name|snscb_ports
index|[
name|portidx
index|]
operator|.
name|portid
index|[
literal|1
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|rs1
operator|->
name|snscb_ports
index|[
name|portidx
index|]
operator|.
name|portid
index|[
literal|2
index|]
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|portid
operator|==
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d skipping null PortID at idx %d"
argument_list|,
name|chan
argument_list|,
name|portidx
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * Skip ourselves here and on other channels. If we're 		 * multi-id, we can't check the portids in other FCPARAM 		 * arenas because the resolutions here aren't synchronized. 		 * The best way to do this is to exclude looking at portids 		 * that have the same domain and area code as our own 		 * portid. 		 */
if|if
condition|(
name|ISP_CAP_MULTI_ID
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|portid
operator|>>
literal|8
operator|)
operator|==
operator|(
name|fcp
operator|->
name|isp_portid
operator|>>
literal|8
operator|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d skip PortID 0x%06x"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
elseif|else
if|if
condition|(
name|portid
operator|==
name|fcp
operator|->
name|isp_portid
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d skip ourselves on @ PortID 0x%06x"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Checking Fabric Port 0x%06x"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
comment|/* 		 * We now search our Port Database for any 		 * probational entries with this PortID. We don't 		 * look for zombies here- only probational 		 * entries (we've already logged out of zombies). 		 */
for|for
control|(
name|dbidx
operator|=
literal|0
init|;
name|dbidx
operator|<
name|MAX_FC_TARG
condition|;
name|dbidx
operator|++
control|)
block|{
name|lp
operator|=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|dbidx
index|]
expr_stmt|;
if|if
condition|(
name|lp
operator|->
name|state
operator|!=
name|FC_PORTDB_STATE_PROBATIONAL
operator|||
name|lp
operator|->
name|target_mode
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|lp
operator|->
name|portid
operator|==
name|portid
condition|)
block|{
break|break;
block|}
block|}
comment|/* 		 * We found a probational entry with this Port ID. 		 */
if|if
condition|(
name|dbidx
operator|<
name|MAX_FC_TARG
condition|)
block|{
name|int
name|handle_changed
init|=
literal|0
decl_stmt|;
name|lp
operator|=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|dbidx
index|]
expr_stmt|;
comment|/* 			 * See if we're still logged into it. 			 * 			 * If we aren't, mark it as a dead device and 			 * leave the new portid in the database entry 			 * for somebody further along to decide what to 			 * do (policy choice). 			 * 			 * If we are, check to see if it's the same 			 * device still (it should be). If for some 			 * reason it isn't, mark it as a changed device 			 * and leave the new portid and role in the 			 * database entry for somebody further along to 			 * decide what to do (policy choice). 			 * 			 */
name|r
operator|=
name|isp_getpdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|lp
operator|->
name|handle
argument_list|,
operator|&
name|pdb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|r
operator|!=
literal|0
condition|)
block|{
name|lp
operator|->
name|new_portid
operator|=
name|portid
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_DEAD
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Fabric Port 0x%06x is dead"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 			 * Check to make sure that handle, portid, WWPN and 			 * WWNN agree. If they don't, then the association 			 * between this PortID and the stated handle has been 			 * broken by the firmware. 			 */
name|MAKE_WWN_FROM_NODE_NAME
argument_list|(
name|wwnn
argument_list|,
name|pdb
operator|.
name|nodename
argument_list|)
expr_stmt|;
name|MAKE_WWN_FROM_NODE_NAME
argument_list|(
name|wwpn
argument_list|,
name|pdb
operator|.
name|portname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdb
operator|.
name|handle
operator|!=
name|lp
operator|->
name|handle
operator|||
name|pdb
operator|.
name|portid
operator|!=
name|portid
operator|||
name|wwpn
operator|!=
name|lp
operator|->
name|port_wwn
operator|||
name|wwnn
operator|!=
name|lp
operator|->
name|node_wwn
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
name|fconf
argument_list|,
name|chan
argument_list|,
name|dbidx
argument_list|,
name|pdb
operator|.
name|handle
argument_list|,
name|pdb
operator|.
name|portid
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|wwnn
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|wwnn
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|wwpn
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|wwpn
argument_list|,
name|lp
operator|->
name|handle
argument_list|,
name|portid
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|lp
operator|->
name|node_wwn
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|lp
operator|->
name|node_wwn
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|lp
operator|->
name|port_wwn
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|lp
operator|->
name|port_wwn
argument_list|)
expr_stmt|;
comment|/* 				 * Try to re-login to this device using a 				 * new handle. If that fails, mark it dead. 				 * 				 * isp_login_device will check for handle and 				 * portid consistency after re-login. 				 * 				 */
if|if
condition|(
name|isp_login_device
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|,
operator|&
name|pdb
argument_list|,
operator|&
name|oldhandle
argument_list|)
condition|)
block|{
name|lp
operator|->
name|new_portid
operator|=
name|portid
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_DEAD
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
continue|continue;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|isp_lasthdl
operator|=
name|oldhandle
expr_stmt|;
name|MAKE_WWN_FROM_NODE_NAME
argument_list|(
name|wwnn
argument_list|,
name|pdb
operator|.
name|nodename
argument_list|)
expr_stmt|;
name|MAKE_WWN_FROM_NODE_NAME
argument_list|(
name|wwpn
argument_list|,
name|pdb
operator|.
name|portname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wwpn
operator|!=
name|lp
operator|->
name|port_wwn
operator|||
name|wwnn
operator|!=
name|lp
operator|->
name|node_wwn
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"changed WWN"
literal|" after relogin"
argument_list|)
expr_stmt|;
name|lp
operator|->
name|new_portid
operator|=
name|portid
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_DEAD
expr_stmt|;
continue|continue;
block|}
name|lp
operator|->
name|handle
operator|=
name|pdb
operator|.
name|handle
expr_stmt|;
name|handle_changed
operator|++
expr_stmt|;
block|}
name|nr
operator|=
name|pdb
operator|.
name|prli_word3
expr_stmt|;
comment|/* 			 * Check to see whether the portid and roles have 			 * stayed the same. If they have stayed the same, 			 * we believe that this is the same device and it 			 * hasn't become disconnected and reconnected, so 			 * mark it as pending valid. 			 * 			 * If they aren't the same, mark the device as a 			 * changed device and save the new port id and role 			 * and let somebody else decide. 			 */
name|lp
operator|->
name|new_portid
operator|=
name|portid
expr_stmt|;
name|lp
operator|->
name|new_prli_word3
operator|=
name|nr
expr_stmt|;
if|if
condition|(
name|pdb
operator|.
name|portid
operator|!=
name|lp
operator|->
name|portid
operator|||
name|nr
operator|!=
name|lp
operator|->
name|prli_word3
operator|||
name|handle_changed
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Fabric Port 0x%06x changed"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_CHANGED
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Fabric Port 0x%06x Now Pending Valid"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_PENDING_VALID
expr_stmt|;
block|}
continue|continue;
block|}
comment|/* 		 * Ah- a new entry. Search the database again for all non-NIL 		 * entries to make sure we never ever make a new database entry 		 * with the same port id. While we're at it, mark where the 		 * last free entry was. 		 */
name|dbidx
operator|=
name|MAX_FC_TARG
expr_stmt|;
for|for
control|(
name|lp
operator|=
name|fcp
operator|->
name|portdb
init|;
name|lp
operator|<
operator|&
name|fcp
operator|->
name|portdb
index|[
name|MAX_FC_TARG
index|]
condition|;
name|lp
operator|++
control|)
block|{
if|if
condition|(
name|lp
operator|>=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|FL_ID
index|]
operator|&&
name|lp
operator|<=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|SNS_ID
index|]
condition|)
block|{
continue|continue;
block|}
comment|/* 			 * Skip any target mode entries. 			 */
if|if
condition|(
name|lp
operator|->
name|target_mode
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|lp
operator|->
name|state
operator|==
name|FC_PORTDB_STATE_NIL
condition|)
block|{
if|if
condition|(
name|dbidx
operator|==
name|MAX_FC_TARG
condition|)
block|{
name|dbidx
operator|=
name|lp
operator|-
name|fcp
operator|->
name|portdb
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|lp
operator|->
name|state
operator|==
name|FC_PORTDB_STATE_ZOMBIE
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|lp
operator|->
name|portid
operator|==
name|portid
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|lp
operator|<
operator|&
name|fcp
operator|->
name|portdb
index|[
name|MAX_FC_TARG
index|]
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d PortID 0x%06x "
literal|"already at %d handle %d state %d"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|,
name|dbidx
argument_list|,
name|lp
operator|->
name|handle
argument_list|,
name|lp
operator|->
name|state
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * We should have the index of the first free entry seen. 		 */
if|if
condition|(
name|dbidx
operator|==
name|MAX_FC_TARG
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"port database too small to login PortID 0x%06x"
literal|"- increase MAX_FC_TARG"
argument_list|,
name|portid
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * Otherwise, point to our new home. 		 */
name|lp
operator|=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|dbidx
index|]
expr_stmt|;
comment|/* 		 * Try to see if we are logged into this device, 		 * and maybe log into it. 		 * 		 * isp_login_device will check for handle and 		 * portid consistency after login. 		 */
if|if
condition|(
name|isp_login_device
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|,
operator|&
name|pdb
argument_list|,
operator|&
name|oldhandle
argument_list|)
condition|)
block|{
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
continue|continue;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|isp_lasthdl
operator|=
name|oldhandle
expr_stmt|;
name|handle
operator|=
name|pdb
operator|.
name|handle
expr_stmt|;
name|MAKE_WWN_FROM_NODE_NAME
argument_list|(
name|wwnn
argument_list|,
name|pdb
operator|.
name|nodename
argument_list|)
expr_stmt|;
name|MAKE_WWN_FROM_NODE_NAME
argument_list|(
name|wwpn
argument_list|,
name|pdb
operator|.
name|portname
argument_list|)
expr_stmt|;
name|nr
operator|=
name|pdb
operator|.
name|prli_word3
expr_stmt|;
comment|/* 		 * And go through the database *one* more time to make sure 		 * that we do not make more than one entry that has the same 		 * WWNN/WWPN duple 		 */
for|for
control|(
name|dbidx
operator|=
literal|0
init|;
name|dbidx
operator|<
name|MAX_FC_TARG
condition|;
name|dbidx
operator|++
control|)
block|{
if|if
condition|(
name|dbidx
operator|>=
name|FL_ID
operator|&&
name|dbidx
operator|<=
name|SNS_ID
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|fcp
operator|->
name|portdb
index|[
name|dbidx
index|]
operator|.
name|target_mode
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|fcp
operator|->
name|portdb
index|[
name|dbidx
index|]
operator|.
name|node_wwn
operator|==
name|wwnn
operator|&&
name|fcp
operator|->
name|portdb
index|[
name|dbidx
index|]
operator|.
name|port_wwn
operator|==
name|wwpn
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|dbidx
operator|==
name|MAX_FC_TARG
condition|)
block|{
name|ISP_MEMZERO
argument_list|(
name|lp
argument_list|,
sizeof|sizeof
argument_list|(
name|fcportdb_t
argument_list|)
argument_list|)
expr_stmt|;
name|lp
operator|->
name|handle
operator|=
name|handle
expr_stmt|;
name|lp
operator|->
name|node_wwn
operator|=
name|wwnn
expr_stmt|;
name|lp
operator|->
name|port_wwn
operator|=
name|wwpn
expr_stmt|;
name|lp
operator|->
name|new_portid
operator|=
name|portid
expr_stmt|;
name|lp
operator|->
name|new_prli_word3
operator|=
name|nr
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_NEW
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Fabric Port 0x%06x is a New Entry"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|fcp
operator|->
name|portdb
index|[
name|dbidx
index|]
operator|.
name|state
operator|!=
name|FC_PORTDB_STATE_ZOMBIE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d PortID 0x%x 0x%08x%08x/0x%08x%08x %ld "
literal|"already at idx %d, state 0x%x"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|wwnn
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|wwnn
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|wwpn
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|wwpn
argument_list|,
call|(
name|long
call|)
argument_list|(
name|lp
operator|-
name|fcp
operator|->
name|portdb
argument_list|)
argument_list|,
name|dbidx
argument_list|,
name|fcp
operator|->
name|portdb
index|[
name|dbidx
index|]
operator|.
name|state
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * We found a zombie entry that matches us. 		 * Revive it. We know that WWN and WWPN 		 * are the same. For fabric devices, we 		 * don't care that handle is different 		 * as we assign that. If role or portid 		 * are different, it maybe a changed device. 		 */
name|lp
operator|=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|dbidx
index|]
expr_stmt|;
name|lp
operator|->
name|handle
operator|=
name|handle
expr_stmt|;
name|lp
operator|->
name|new_portid
operator|=
name|portid
expr_stmt|;
name|lp
operator|->
name|new_prli_word3
operator|=
name|nr
expr_stmt|;
if|if
condition|(
name|lp
operator|->
name|portid
operator|!=
name|portid
operator|||
name|lp
operator|->
name|prli_word3
operator|!=
name|nr
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Zombie Fabric Port 0x%06x Now Changed"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_CHANGED
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Zombie Fabric Port 0x%06x Now Pending Valid"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
name|lp
operator|->
name|state
operator|=
name|FC_PORTDB_STATE_PENDING_VALID
expr_stmt|;
block|}
block|}
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_FSCAN_DONE
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d FC Scan Fabric Done"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find an unused handle and try and use to login to a port.  */
end_comment

begin_function
specifier|static
name|int
name|isp_login_device
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|,
name|uint32_t
name|portid
parameter_list|,
name|isp_pdb_t
modifier|*
name|p
parameter_list|,
name|uint16_t
modifier|*
name|ohp
parameter_list|)
block|{
name|int
name|lim
decl_stmt|,
name|i
decl_stmt|,
name|r
decl_stmt|;
name|uint16_t
name|handle
decl_stmt|;
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|lim
operator|=
name|NPH_MAX_2K
expr_stmt|;
block|}
else|else
block|{
name|lim
operator|=
name|NPH_MAX
expr_stmt|;
block|}
name|handle
operator|=
name|isp_nxt_handle
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
operator|*
name|ohp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lim
condition|;
name|i
operator|++
control|)
block|{
comment|/* 		 * See if we're still logged into something with 		 * this handle and that something agrees with this 		 * port id. 		 */
name|r
operator|=
name|isp_getpdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
literal|0
operator|&&
name|p
operator|->
name|portid
operator|!=
name|portid
condition|)
block|{
operator|(
name|void
operator|)
name|isp_plogx
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|,
name|portid
argument_list|,
name|PLOGX_FLG_CMD_LOGO
operator||
name|PLOGX_FLG_IMPLICIT
operator||
name|PLOGX_FLG_FREE_NPHDL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r
operator|==
literal|0
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 		 * Now try and log into the device 		 */
name|r
operator|=
name|isp_plogx
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|,
name|portid
argument_list|,
name|PLOGX_FLG_CMD_PLOGI
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|r
operator|==
literal|0
condition|)
block|{
operator|*
name|ohp
operator|=
name|handle
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
operator|(
name|r
operator|&
literal|0xffff
operator|)
operator|==
name|MBOX_PORT_ID_USED
condition|)
block|{
comment|/* 			 * If we get here, then the firmwware still thinks we're logged into this device, but with a different 			 * handle. We need to break that association. We used to try and just substitute the handle, but then 			 * failed to get any data via isp_getpdb (below). 			 */
if|if
condition|(
name|isp_plogx
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|r
operator|>>
literal|16
argument_list|,
name|portid
argument_list|,
name|PLOGX_FLG_CMD_LOGO
operator||
name|PLOGX_FLG_IMPLICIT
operator||
name|PLOGX_FLG_FREE_NPHDL
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"baw... logout of %x failed"
argument_list|,
name|r
operator|>>
literal|16
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|r
operator|=
name|isp_plogx
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|,
name|portid
argument_list|,
name|PLOGX_FLG_CMD_PLOGI
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|r
operator|==
literal|0
condition|)
block|{
operator|*
name|ohp
operator|=
name|handle
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|lim
expr_stmt|;
block|}
break|break;
block|}
elseif|else
if|if
condition|(
operator|(
name|r
operator|&
literal|0xffff
operator|)
operator|==
name|MBOX_LOOP_ID_USED
condition|)
block|{
comment|/* 			 * Try the next loop id. 			 */
operator|*
name|ohp
operator|=
name|handle
expr_stmt|;
name|handle
operator|=
name|isp_nxt_handle
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Give up. 			 */
name|i
operator|=
name|lim
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|lim
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d PLOGI 0x%06x failed"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * If we successfully logged into it, get the PDB for it 	 * so we can crosscheck that it is still what we think it 	 * is and that we also have the role it plays 	 */
name|r
operator|=
name|isp_getpdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_loopstate
operator|!=
name|LOOP_SCANNING_FABRIC
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|r
operator|!=
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Chan %d new device 0x%06x@0x%x disappeared"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|,
name|handle
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|p
operator|->
name|handle
operator|!=
name|handle
operator|||
name|p
operator|->
name|portid
operator|!=
name|portid
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Chan %d new device 0x%06x@0x%x changed (0x%06x@0x%0x)"
argument_list|,
name|chan
argument_list|,
name|portid
argument_list|,
name|handle
argument_list|,
name|p
operator|->
name|portid
argument_list|,
name|p
operator|->
name|handle
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isp_register_fc4_type
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|uint8_t
name|local
index|[
name|SNS_RFT_ID_REQ_SIZE
index|]
decl_stmt|;
name|sns_screq_t
modifier|*
name|reqp
init|=
operator|(
name|sns_screq_t
operator|*
operator|)
name|local
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
name|ISP_MEMZERO
argument_list|(
operator|(
name|void
operator|*
operator|)
name|reqp
argument_list|,
name|SNS_RFT_ID_REQ_SIZE
argument_list|)
expr_stmt|;
name|reqp
operator|->
name|snscb_rblen
operator|=
name|SNS_RFT_ID_RESP_SIZE
operator|>>
literal|1
expr_stmt|;
name|reqp
operator|->
name|snscb_addr
index|[
name|RQRSP_ADDR0015
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
literal|0x100
argument_list|)
expr_stmt|;
name|reqp
operator|->
name|snscb_addr
index|[
name|RQRSP_ADDR1631
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
literal|0x100
argument_list|)
expr_stmt|;
name|reqp
operator|->
name|snscb_addr
index|[
name|RQRSP_ADDR3247
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
literal|0x100
argument_list|)
expr_stmt|;
name|reqp
operator|->
name|snscb_addr
index|[
name|RQRSP_ADDR4863
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
literal|0x100
argument_list|)
expr_stmt|;
name|reqp
operator|->
name|snscb_sblen
operator|=
literal|22
expr_stmt|;
name|reqp
operator|->
name|snscb_data
index|[
literal|0
index|]
operator|=
name|SNS_RFT_ID
expr_stmt|;
name|reqp
operator|->
name|snscb_data
index|[
literal|4
index|]
operator|=
name|fcp
operator|->
name|isp_portid
operator|&
literal|0xffff
expr_stmt|;
name|reqp
operator|->
name|snscb_data
index|[
literal|5
index|]
operator|=
operator|(
name|fcp
operator|->
name|isp_portid
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|reqp
operator|->
name|snscb_data
index|[
literal|6
index|]
operator|=
operator|(
literal|1
operator|<<
name|FC4_SCSI
operator|)
expr_stmt|;
if|if
condition|(
name|FC_SCRATCH_ACQUIRE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|sacq
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|isp_put_sns_request
argument_list|(
name|isp
argument_list|,
name|reqp
argument_list|,
operator|(
name|sns_screq_t
operator|*
operator|)
name|fcp
operator|->
name|isp_scratch
argument_list|)
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_SEND_SNS
argument_list|,
name|MBLOGALL
argument_list|,
literal|1000000
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|SNS_RFT_ID_REQ_SIZE
operator|>>
literal|1
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORDEV
argument_list|,
literal|0
argument_list|,
name|SNS_RFT_ID_REQ_SIZE
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|==
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|isp_register_fc4_type_24xx
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
union|union
block|{
name|isp_ct_pt_t
name|plocal
decl_stmt|;
name|rft_id_t
name|clocal
decl_stmt|;
name|uint8_t
name|q
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
block|}
name|un
union|;
name|isp_ct_pt_t
modifier|*
name|pt
decl_stmt|;
name|ct_hdr_t
modifier|*
name|ct
decl_stmt|;
name|rft_id_t
modifier|*
name|rp
decl_stmt|;
name|uint8_t
modifier|*
name|scp
init|=
name|fcp
operator|->
name|isp_scratch
decl_stmt|;
if|if
condition|(
name|FC_SCRATCH_ACQUIRE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|sacq
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Build a Passthrough IOCB in memory. 	 */
name|ISP_MEMZERO
argument_list|(
name|un
operator|.
name|q
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
name|pt
operator|=
operator|&
name|un
operator|.
name|plocal
expr_stmt|;
name|pt
operator|->
name|ctp_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|pt
operator|->
name|ctp_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_CT_PASSTHRU
expr_stmt|;
name|pt
operator|->
name|ctp_handle
operator|=
literal|0xffffffff
expr_stmt|;
name|pt
operator|->
name|ctp_nphdl
operator|=
name|fcp
operator|->
name|isp_sns_hdl
expr_stmt|;
name|pt
operator|->
name|ctp_cmd_cnt
operator|=
literal|1
expr_stmt|;
name|pt
operator|->
name|ctp_vpidx
operator|=
name|ISP_GET_VPIDX
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_time
operator|=
literal|1
expr_stmt|;
name|pt
operator|->
name|ctp_rsp_cnt
operator|=
literal|1
expr_stmt|;
name|pt
operator|->
name|ctp_rsp_bcnt
operator|=
sizeof|sizeof
argument_list|(
name|ct_hdr_t
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_cmd_bcnt
operator|=
sizeof|sizeof
argument_list|(
name|rft_id_t
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|0
index|]
operator|.
name|ds_base
operator|=
name|DMA_LO32
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|XTXOFF
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|0
index|]
operator|.
name|ds_basehi
operator|=
name|DMA_HI32
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|XTXOFF
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|0
index|]
operator|.
name|ds_count
operator|=
sizeof|sizeof
argument_list|(
name|rft_id_t
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|1
index|]
operator|.
name|ds_base
operator|=
name|DMA_LO32
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|IGPOFF
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|1
index|]
operator|.
name|ds_basehi
operator|=
name|DMA_HI32
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|IGPOFF
argument_list|)
expr_stmt|;
name|pt
operator|->
name|ctp_dataseg
index|[
literal|1
index|]
operator|.
name|ds_count
operator|=
sizeof|sizeof
argument_list|(
name|ct_hdr_t
argument_list|)
expr_stmt|;
name|isp_put_ct_pt
argument_list|(
name|isp
argument_list|,
name|pt
argument_list|,
operator|(
name|isp_ct_pt_t
operator|*
operator|)
operator|&
name|scp
index|[
name|CTXOFF
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"IOCB CT Request"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|pt
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Build the CT header and command in memory. 	 * 	 * Note that the CT header has to end up as Big Endian format in memory. 	 */
name|ISP_MEMZERO
argument_list|(
operator|&
name|un
operator|.
name|clocal
argument_list|,
sizeof|sizeof
argument_list|(
name|un
operator|.
name|clocal
argument_list|)
argument_list|)
expr_stmt|;
name|ct
operator|=
operator|&
name|un
operator|.
name|clocal
operator|.
name|rftid_hdr
expr_stmt|;
name|ct
operator|->
name|ct_revision
operator|=
name|CT_REVISION
expr_stmt|;
name|ct
operator|->
name|ct_fcs_type
operator|=
name|CT_FC_TYPE_FC
expr_stmt|;
name|ct
operator|->
name|ct_fcs_subtype
operator|=
name|CT_FC_SUBTYPE_NS
expr_stmt|;
name|ct
operator|->
name|ct_cmd_resp
operator|=
name|SNS_RFT_ID
expr_stmt|;
name|ct
operator|->
name|ct_bcnt_resid
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|rft_id_t
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|ct_hdr_t
argument_list|)
operator|)
operator|>>
literal|2
expr_stmt|;
name|rp
operator|=
operator|&
name|un
operator|.
name|clocal
expr_stmt|;
name|rp
operator|->
name|rftid_portid
index|[
literal|0
index|]
operator|=
name|fcp
operator|->
name|isp_portid
operator|>>
literal|16
expr_stmt|;
name|rp
operator|->
name|rftid_portid
index|[
literal|1
index|]
operator|=
name|fcp
operator|->
name|isp_portid
operator|>>
literal|8
expr_stmt|;
name|rp
operator|->
name|rftid_portid
index|[
literal|2
index|]
operator|=
name|fcp
operator|->
name|isp_portid
expr_stmt|;
name|rp
operator|->
name|rftid_fc4types
index|[
name|FC4_SCSI
operator|>>
literal|5
index|]
operator|=
literal|1
operator|<<
operator|(
name|FC4_SCSI
operator|&
literal|0x1f
operator|)
expr_stmt|;
name|isp_put_rft_id
argument_list|(
name|isp
argument_list|,
name|rp
argument_list|,
operator|(
name|rft_id_t
operator|*
operator|)
operator|&
name|scp
index|[
name|XTXOFF
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"CT Header"
argument_list|,
name|QENTRY_LEN
argument_list|,
operator|&
name|scp
index|[
name|XTXOFF
index|]
argument_list|)
expr_stmt|;
block|}
name|ISP_MEMZERO
argument_list|(
operator|&
name|scp
index|[
name|ZTXOFF
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ct_hdr_t
argument_list|)
argument_list|)
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_EXEC_COMMAND_IOCB_A64
argument_list|,
name|MBLOGALL
argument_list|,
literal|1000000
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|QENTRY_LEN
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|CTXOFF
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|CTXOFF
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|CTXOFF
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|+
name|CTXOFF
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORDEV
argument_list|,
name|XTXOFF
argument_list|,
literal|2
operator|*
name|QENTRY_LEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORCPU
argument_list|,
name|ZTXOFF
argument_list|,
name|QENTRY_LEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|pt
operator|=
operator|&
name|un
operator|.
name|plocal
expr_stmt|;
name|isp_get_ct_pt
argument_list|(
name|isp
argument_list|,
operator|(
name|isp_ct_pt_t
operator|*
operator|)
operator|&
name|scp
index|[
name|ZTXOFF
index|]
argument_list|,
name|pt
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"IOCB response"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|pt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pt
operator|->
name|ctp_status
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d Register FC4 Type CT Passthrough returned 0x%x"
argument_list|,
name|chan
argument_list|,
name|pt
operator|->
name|ctp_status
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|isp_get_ct_hdr
argument_list|(
name|isp
argument_list|,
operator|(
name|ct_hdr_t
operator|*
operator|)
operator|&
name|scp
index|[
name|IGPOFF
index|]
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|ct
operator|->
name|ct_cmd_resp
operator|==
name|LS_RJT
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
operator||
name|ISP_LOG_WARN1
argument_list|,
literal|"Chan %d Register FC4 Type rejected"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|ct
operator|->
name|ct_cmd_resp
operator|==
name|LS_ACC
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_SANCFG
argument_list|,
literal|"Chan %d Register FC4 Type accepted"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d Register FC4 Type: 0x%x"
argument_list|,
name|chan
argument_list|,
name|ct
operator|->
name|ct_cmd_resp
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|isp_nxt_handle
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|,
name|uint16_t
name|handle
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|handle
operator|==
name|NIL_HANDLE
condition|)
block|{
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_topo
operator|==
name|TOPO_F_PORT
condition|)
block|{
name|handle
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|handle
operator|=
name|SNS_ID
operator|+
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|handle
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|handle
operator|>=
name|FL_ID
operator|&&
name|handle
operator|<=
name|SNS_ID
condition|)
block|{
name|handle
operator|=
name|SNS_ID
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|handle
operator|>=
name|NPH_RESERVED
operator|&&
name|handle
operator|<=
name|NPH_FL_ID
condition|)
block|{
name|handle
operator|=
name|NPH_FL_ID
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|handle
operator|==
name|NPH_MAX_2K
condition|)
block|{
name|handle
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|handle
operator|==
name|NPH_MAX
condition|)
block|{
name|handle
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|handle
operator|==
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_loopid
condition|)
block|{
return|return
operator|(
name|isp_nxt_handle
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|)
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_FC_TARG
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|portdb
index|[
name|i
index|]
operator|.
name|state
operator|==
name|FC_PORTDB_STATE_NIL
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|portdb
index|[
name|i
index|]
operator|.
name|handle
operator|==
name|handle
condition|)
block|{
return|return
operator|(
name|isp_nxt_handle
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|handle
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|handle
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Start a command. Locking is assumed done in the caller.  */
end_comment

begin_function
name|int
name|isp_start
parameter_list|(
name|XS_T
modifier|*
name|xs
parameter_list|)
block|{
name|ispsoftc_t
modifier|*
name|isp
decl_stmt|;
name|uint32_t
name|handle
decl_stmt|,
name|cdblen
decl_stmt|;
name|uint8_t
name|local
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
name|ispreq_t
modifier|*
name|reqp
decl_stmt|;
name|void
modifier|*
name|cdbp
decl_stmt|,
modifier|*
name|qep
decl_stmt|;
name|uint16_t
modifier|*
name|tptr
decl_stmt|;
name|int
name|target
decl_stmt|,
name|dmaresult
decl_stmt|,
name|hdlidx
init|=
literal|0
decl_stmt|;
name|XS_INITERR
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|isp
operator|=
name|XS_ISP
argument_list|(
name|xs
argument_list|)
expr_stmt|;
comment|/* 	 * Now make sure we're running. 	 */
if|if
condition|(
name|isp
operator|->
name|isp_state
operator|!=
name|ISP_RUNSTATE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Adapter not at RUNSTATE"
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
comment|/* 	 * Check command CDB length, etc.. We really are limited to 16 bytes 	 * for Fibre Channel, but can do up to 44 bytes in parallel SCSI, 	 * but probably only if we're running fairly new firmware (we'll 	 * let the old f/w choke on an extended command queue entry). 	 */
if|if
condition|(
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
operator|>
operator|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|?
literal|16
else|:
literal|44
operator|)
operator|||
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
operator|==
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"unsupported cdb length (%d, CDB[0]=0x%x)"
argument_list|,
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
comment|/* 	 * Translate the target to device handle as appropriate, checking 	 * for correct device state as well. 	 */
name|target
operator|=
name|XS_TGT
argument_list|(
name|xs
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|fcp
operator|->
name|role
operator|&
name|ISP_ROLE_INITIATOR
operator|)
operator|==
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"%d.%d.%d I am not an initiator"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|target
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
comment|/* 		 * Try again later. 		 */
if|if
condition|(
name|fcp
operator|->
name|isp_fwstate
operator|!=
name|FW_READY
operator|||
name|fcp
operator|->
name|isp_loopstate
operator|!=
name|LOOP_READY
condition|)
block|{
return|return
operator|(
name|CMD_RQLATER
operator|)
return|;
block|}
if|if
condition|(
name|XS_TGT
argument_list|(
name|xs
argument_list|)
operator|>=
name|MAX_FC_TARG
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"%d.%d.%d target too big"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|target
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
name|hdlidx
operator|=
name|fcp
operator|->
name|isp_dev_map
index|[
name|XS_TGT
argument_list|(
name|xs
argument_list|)
index|]
operator|-
literal|1
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG2
argument_list|,
literal|"XS_TGT(xs)=%d- hdlidx value %d"
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|,
name|hdlidx
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdlidx
operator|<
literal|0
operator|||
name|hdlidx
operator|>=
name|MAX_FC_TARG
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
if|if
condition|(
name|fcp
operator|->
name|portdb
index|[
name|hdlidx
index|]
operator|.
name|state
operator|==
name|FC_PORTDB_STATE_ZOMBIE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"%d.%d.%d target zombie"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|target
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_RQLATER
operator|)
return|;
block|}
if|if
condition|(
name|fcp
operator|->
name|portdb
index|[
name|hdlidx
index|]
operator|.
name|state
operator|!=
name|FC_PORTDB_STATE_VALID
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"%d.%d.%d bad db port state 0x%x"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|target
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|fcp
operator|->
name|portdb
index|[
name|hdlidx
index|]
operator|.
name|state
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
name|target
operator|=
name|fcp
operator|->
name|portdb
index|[
name|hdlidx
index|]
operator|.
name|handle
expr_stmt|;
name|fcp
operator|->
name|portdb
index|[
name|hdlidx
index|]
operator|.
name|dirty
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sdparam
modifier|*
name|sdp
init|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|sdp
operator|->
name|role
operator|&
name|ISP_ROLE_INITIATOR
operator|)
operator|==
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"%d.%d.%d I am not an initiator"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|target
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
if|if
condition|(
name|sdp
operator|->
name|update
condition|)
block|{
name|isp_spi_update
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|start_again
label|:
name|qep
operator|=
name|isp_getrqentry
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|qep
operator|==
name|NULL
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"Request Queue Overflow"
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_EAGAIN
operator|)
return|;
block|}
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
comment|/* 	 * Now see if we need to synchronize the ISP with respect to anything. 	 * We do dual duty here (cough) for synchronizing for busses other 	 * than which we got here to send a command to. 	 */
name|reqp
operator|=
operator|(
name|ispreq_t
operator|*
operator|)
name|local
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|local
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISP_TST_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_marker_24xx_t
modifier|*
name|m
init|=
operator|(
name|isp_marker_24xx_t
operator|*
operator|)
name|reqp
decl_stmt|;
name|m
operator|->
name|mrk_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|m
operator|->
name|mrk_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_MARKER
expr_stmt|;
name|m
operator|->
name|mrk_modifier
operator|=
name|SYNC_ALL
expr_stmt|;
name|isp_put_marker_24xx
argument_list|(
name|isp
argument_list|,
name|m
argument_list|,
name|qep
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_marker_t
modifier|*
name|m
init|=
operator|(
name|isp_marker_t
operator|*
operator|)
name|reqp
decl_stmt|;
name|m
operator|->
name|mrk_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|m
operator|->
name|mrk_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_MARKER
expr_stmt|;
name|m
operator|->
name|mrk_target
operator|=
operator|(
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
operator|<<
literal|7
operator|)
expr_stmt|;
comment|/* bus # */
name|m
operator|->
name|mrk_modifier
operator|=
name|SYNC_ALL
expr_stmt|;
name|isp_put_marker
argument_list|(
name|isp
argument_list|,
name|m
argument_list|,
name|qep
argument_list|)
expr_stmt|;
block|}
name|ISP_SYNC_REQUEST
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|start_again
goto|;
block|}
name|reqp
operator|->
name|req_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Select and install Header Code. 	 * Note that it might be overridden before going out 	 * if we're on a 64 bit platform. The lower level 	 * code (isp_send_cmd) will select the appropriate 	 * 64 bit variant if it needs to. 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|reqp
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_T7RQS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|reqp
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_T2RQS
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
operator|>
literal|12
condition|)
block|{
name|reqp
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_CMDONLY
expr_stmt|;
block|}
else|else
block|{
name|reqp
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_REQUEST
expr_stmt|;
block|}
block|}
comment|/* 	 * Set task attributes 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|int
name|ttype
decl_stmt|;
if|if
condition|(
name|XS_TAG_P
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|ttype
operator|=
name|XS_TAG_TYPE
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
index|[
literal|0
index|]
operator|==
literal|0x3
condition|)
block|{
name|ttype
operator|=
name|REQFLAG_HTAG
expr_stmt|;
block|}
else|else
block|{
name|ttype
operator|=
name|REQFLAG_STAG
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ttype
operator|==
name|REQFLAG_OTAG
condition|)
block|{
name|ttype
operator|=
name|FCP_CMND_TASK_ATTR_ORDERED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ttype
operator|==
name|REQFLAG_HTAG
condition|)
block|{
name|ttype
operator|=
name|FCP_CMND_TASK_ATTR_HEAD
expr_stmt|;
block|}
else|else
block|{
name|ttype
operator|=
name|FCP_CMND_TASK_ATTR_SIMPLE
expr_stmt|;
block|}
operator|(
operator|(
name|ispreqt7_t
operator|*
operator|)
name|reqp
operator|)
operator|->
name|req_task_attribute
operator|=
name|ttype
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* 		 * See comment in isp_intr 		 */
comment|/* XS_SET_RESID(xs, 0); */
comment|/* 		 * Fibre Channel always requires some kind of tag. 		 * The Qlogic drivers seem be happy not to use a tag, 		 * but this breaks for some devices (IBM drives). 		 */
if|if
condition|(
name|XS_TAG_P
argument_list|(
name|xs
argument_list|)
condition|)
block|{
operator|(
operator|(
name|ispreqt2_t
operator|*
operator|)
name|reqp
operator|)
operator|->
name|req_flags
operator|=
name|XS_TAG_TYPE
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * If we don't know what tag to use, use HEAD OF QUEUE 			 * for Request Sense or Simple. 			 */
if|if
condition|(
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
index|[
literal|0
index|]
operator|==
literal|0x3
condition|)
comment|/* REQUEST SENSE */
operator|(
operator|(
name|ispreqt2_t
operator|*
operator|)
name|reqp
operator|)
operator|->
name|req_flags
operator|=
name|REQFLAG_HTAG
expr_stmt|;
else|else
operator|(
operator|(
name|ispreqt2_t
operator|*
operator|)
name|reqp
operator|)
operator|->
name|req_flags
operator|=
name|REQFLAG_STAG
expr_stmt|;
block|}
block|}
else|else
block|{
name|sdparam
modifier|*
name|sdp
init|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|sdp
operator|->
name|isp_devparam
index|[
name|target
index|]
operator|.
name|actv_flags
operator|&
name|DPARM_TQING
operator|)
operator|&&
name|XS_TAG_P
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|reqp
operator|->
name|req_flags
operator|=
name|XS_TAG_TYPE
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
block|}
name|tptr
operator|=
operator|&
name|reqp
operator|->
name|req_time
expr_stmt|;
comment|/* 	 * NB: we do not support long CDBs (yet) 	 */
name|cdblen
operator|=
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|cdblen
operator|>
sizeof|sizeof
argument_list|(
name|reqp
operator|->
name|req_cdb
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Command Length %u too long for this chip"
argument_list|,
name|cdblen
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
name|reqp
operator|->
name|req_target
operator|=
name|target
operator||
operator|(
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
operator|<<
literal|7
operator|)
expr_stmt|;
name|reqp
operator|->
name|req_lun_trn
operator|=
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|cdbp
operator|=
name|reqp
operator|->
name|req_cdb
expr_stmt|;
name|reqp
operator|->
name|req_cdblen
operator|=
name|cdblen
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ispreqt7_t
modifier|*
name|t7
init|=
operator|(
name|ispreqt7_t
operator|*
operator|)
name|local
decl_stmt|;
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
if|if
condition|(
name|cdblen
operator|>
sizeof|sizeof
argument_list|(
name|t7
operator|->
name|req_cdb
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Command Length %u too long for this chip"
argument_list|,
name|cdblen
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
name|lp
operator|=
operator|&
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
operator|->
name|portdb
index|[
name|hdlidx
index|]
expr_stmt|;
name|t7
operator|->
name|req_nphdl
operator|=
name|target
expr_stmt|;
name|t7
operator|->
name|req_tidlo
operator|=
name|lp
operator|->
name|portid
expr_stmt|;
name|t7
operator|->
name|req_tidhi
operator|=
name|lp
operator|->
name|portid
operator|>>
literal|16
expr_stmt|;
name|t7
operator|->
name|req_vpidx
operator|=
name|ISP_GET_VPIDX
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_LUN
argument_list|(
name|xs
argument_list|)
operator|>
literal|256
condition|)
block|{
name|t7
operator|->
name|req_lun
index|[
literal|0
index|]
operator|=
name|XS_LUN
argument_list|(
name|xs
argument_list|)
operator|>>
literal|8
expr_stmt|;
name|t7
operator|->
name|req_lun
index|[
literal|0
index|]
operator||=
literal|0x40
expr_stmt|;
block|}
name|t7
operator|->
name|req_lun
index|[
literal|1
index|]
operator|=
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
operator|->
name|fctape_enabled
operator|&&
operator|(
name|lp
operator|->
name|prli_word3
operator|&
name|PRLI_WD3_RETRY
operator|)
condition|)
block|{
if|if
condition|(
name|FCP_NEXT_CRN
argument_list|(
name|isp
argument_list|,
operator|&
name|t7
operator|->
name|req_crn
argument_list|,
name|xs
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"%d.%d.%d cannot generate next CRN"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|target
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_EAGAIN
operator|)
return|;
block|}
block|}
name|tptr
operator|=
operator|&
name|t7
operator|->
name|req_time
expr_stmt|;
name|cdbp
operator|=
name|t7
operator|->
name|req_cdb
expr_stmt|;
block|}
else|else
block|{
name|ispreqt2_t
modifier|*
name|t2
init|=
operator|(
name|ispreqt2_t
operator|*
operator|)
name|local
decl_stmt|;
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
if|if
condition|(
name|cdblen
operator|>
sizeof|sizeof
name|t2
operator|->
name|req_cdb
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Command Length %u too long for this chip"
argument_list|,
name|cdblen
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
name|lp
operator|=
operator|&
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
operator|->
name|portdb
index|[
name|hdlidx
index|]
expr_stmt|;
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
operator|->
name|fctape_enabled
operator|&&
operator|(
name|lp
operator|->
name|prli_word3
operator|&
name|PRLI_WD3_RETRY
operator|)
condition|)
block|{
if|if
condition|(
name|FCP_NEXT_CRN
argument_list|(
name|isp
argument_list|,
operator|&
name|t2
operator|->
name|req_crn
argument_list|,
name|xs
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"%d.%d.%d cannot generate next CRN"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|target
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_EAGAIN
operator|)
return|;
block|}
block|}
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ispreqt2e_t
modifier|*
name|t2e
init|=
operator|(
name|ispreqt2e_t
operator|*
operator|)
name|local
decl_stmt|;
name|t2e
operator|->
name|req_target
operator|=
name|target
expr_stmt|;
name|t2e
operator|->
name|req_scclun
operator|=
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|cdbp
operator|=
name|t2e
operator|->
name|req_cdb
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ISP_CAP_SCCFW
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ispreqt2_t
modifier|*
name|t2
init|=
operator|(
name|ispreqt2_t
operator|*
operator|)
name|local
decl_stmt|;
name|t2
operator|->
name|req_target
operator|=
name|target
expr_stmt|;
name|t2
operator|->
name|req_scclun
operator|=
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|cdbp
operator|=
name|t2
operator|->
name|req_cdb
expr_stmt|;
block|}
else|else
block|{
name|t2
operator|->
name|req_target
operator|=
name|target
expr_stmt|;
name|t2
operator|->
name|req_lun_trn
operator|=
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|cdbp
operator|=
name|t2
operator|->
name|req_cdb
expr_stmt|;
block|}
block|}
name|ISP_MEMCPY
argument_list|(
name|cdbp
argument_list|,
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
argument_list|,
name|cdblen
argument_list|)
expr_stmt|;
operator|*
name|tptr
operator|=
name|XS_TIME
argument_list|(
name|xs
argument_list|)
operator|/
literal|1000
expr_stmt|;
if|if
condition|(
operator|*
name|tptr
operator|==
literal|0
operator|&&
name|XS_TIME
argument_list|(
name|xs
argument_list|)
condition|)
block|{
operator|*
name|tptr
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
operator|&&
operator|*
name|tptr
operator|>
literal|0x1999
condition|)
block|{
operator|*
name|tptr
operator|=
literal|0x1999
expr_stmt|;
block|}
if|if
condition|(
name|isp_allocate_xs
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
operator|&
name|handle
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"out of xflist pointers"
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_EAGAIN
operator|)
return|;
block|}
comment|/* Whew. Thankfully the same for type 7 requests */
name|reqp
operator|->
name|req_handle
operator|=
name|handle
expr_stmt|;
comment|/* 	 * Set up DMA and/or do any platform dependent swizzling of the request entry 	 * so that the Qlogic F/W understands what is being asked of it. 	 * 	 * The callee is responsible for adding all requests at this point. 	 */
name|dmaresult
operator|=
name|ISP_DMASETUP
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|reqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmaresult
operator|!=
name|CMD_QUEUED
condition|)
block|{
name|isp_destroy_handle
argument_list|(
name|isp
argument_list|,
name|handle
argument_list|)
expr_stmt|;
comment|/* 		 * dmasetup sets actual error in packet, and 		 * return what we were given to return. 		 */
return|return
operator|(
name|dmaresult
operator|)
return|;
block|}
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"START cmd cdb[0]=0x%x datalen %ld"
argument_list|,
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
index|[
literal|0
index|]
argument_list|,
operator|(
name|long
operator|)
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_nactive
operator|++
expr_stmt|;
return|return
operator|(
name|CMD_QUEUED
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * isp control  * Locks (ints blocked) assumed held.  */
end_comment

begin_function
name|int
name|isp_control
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|ispctl_t
name|ctl
parameter_list|,
modifier|...
parameter_list|)
block|{
name|XS_T
modifier|*
name|xs
decl_stmt|;
name|mbreg_t
modifier|*
name|mbr
decl_stmt|,
name|mbs
decl_stmt|;
name|int
name|chan
decl_stmt|,
name|tgt
decl_stmt|;
name|uint32_t
name|handle
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
switch|switch
condition|(
name|ctl
condition|)
block|{
case|case
name|ISPCTL_RESET_BUS
case|:
comment|/* 		 * Issue a bus reset. 		 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"BUS RESET NOT IMPLEMENTED"
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
literal|10
expr_stmt|;
name|chan
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|chan
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_bus_reset_delay
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|<
literal|2
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
block|}
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|chan
expr_stmt|;
block|}
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_BUS_RESET
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
break|break;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"driver initiated bus reset of bus %d"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|ISPCTL_RESET_DEV
case|:
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|chan
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|tgt
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|uint8_t
name|local
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
name|isp24xx_tmf_t
modifier|*
name|tmf
decl_stmt|;
name|isp24xx_statusreq_t
modifier|*
name|sp
decl_stmt|;
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
name|int
name|hdlidx
decl_stmt|;
name|hdlidx
operator|=
name|fcp
operator|->
name|isp_dev_map
index|[
name|tgt
index|]
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|hdlidx
operator|<
literal|0
operator|||
name|hdlidx
operator|>=
name|MAX_FC_TARG
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d bad handle %d trying to reset target %d"
argument_list|,
name|chan
argument_list|,
name|hdlidx
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
break|break;
block|}
name|lp
operator|=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|hdlidx
index|]
expr_stmt|;
if|if
condition|(
name|lp
operator|->
name|state
operator|!=
name|FC_PORTDB_STATE_VALID
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d handle %d for abort of target %d no longer valid"
argument_list|,
name|chan
argument_list|,
name|hdlidx
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
break|break;
block|}
name|tmf
operator|=
operator|(
name|isp24xx_tmf_t
operator|*
operator|)
name|local
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|tmf
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
name|tmf
operator|->
name|tmf_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_TSK_MGMT
expr_stmt|;
name|tmf
operator|->
name|tmf_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|tmf
operator|->
name|tmf_nphdl
operator|=
name|lp
operator|->
name|handle
expr_stmt|;
name|tmf
operator|->
name|tmf_delay
operator|=
literal|2
expr_stmt|;
name|tmf
operator|->
name|tmf_timeout
operator|=
literal|2
expr_stmt|;
name|tmf
operator|->
name|tmf_flags
operator|=
name|ISP24XX_TMF_TARGET_RESET
expr_stmt|;
name|tmf
operator|->
name|tmf_tidlo
operator|=
name|lp
operator|->
name|portid
expr_stmt|;
name|tmf
operator|->
name|tmf_tidhi
operator|=
name|lp
operator|->
name|portid
operator|>>
literal|16
expr_stmt|;
name|tmf
operator|->
name|tmf_vpidx
operator|=
name|ISP_GET_VPIDX
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGALL
argument_list|,
literal|"Chan %d Reset N-Port Handle 0x%04x @ Port 0x%06x"
argument_list|,
name|chan
argument_list|,
name|lp
operator|->
name|handle
argument_list|,
name|lp
operator|->
name|portid
argument_list|)
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_EXEC_COMMAND_IOCB_A64
argument_list|,
name|MBLOGALL
argument_list|,
literal|5000000
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|QENTRY_LEN
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
if|if
condition|(
name|FC_SCRATCH_ACQUIRE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|sacq
argument_list|)
expr_stmt|;
break|break;
block|}
name|isp_put_24xx_tmf
argument_list|(
name|isp
argument_list|,
name|tmf
argument_list|,
name|fcp
operator|->
name|isp_scratch
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORDEV
argument_list|,
literal|0
argument_list|,
name|QENTRY_LEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|sendmarker
operator|=
literal|1
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
break|break;
block|}
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORCPU
argument_list|,
name|QENTRY_LEN
argument_list|,
name|QENTRY_LEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|sp
operator|=
operator|(
name|isp24xx_statusreq_t
operator|*
operator|)
name|local
expr_stmt|;
name|isp_get_24xx_response
argument_list|(
name|isp
argument_list|,
operator|&
operator|(
operator|(
name|isp24xx_statusreq_t
operator|*
operator|)
name|fcp
operator|->
name|isp_scratch
operator|)
index|[
literal|1
index|]
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_completion_status
operator|==
literal|0
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d reset of target %d returned 0x%x"
argument_list|,
name|chan
argument_list|,
name|tgt
argument_list|,
name|sp
operator|->
name|req_completion_status
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|tgt
expr_stmt|;
name|mbs
operator|.
name|ibits
operator|=
operator|(
literal|1
operator|<<
literal|10
operator|)
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|tgt
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|chan
operator|<<
literal|15
operator|)
operator||
operator|(
name|tgt
operator|<<
literal|8
operator|)
expr_stmt|;
block|}
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_ABORT_TARGET
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
literal|3
expr_stmt|;
comment|/* 'delay', in seconds */
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
break|break;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Target %d on Bus %d Reset Succeeded"
argument_list|,
name|tgt
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|ISPCTL_ABORT_CMD
case|:
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|xs
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|XS_T
operator|*
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|tgt
operator|=
name|XS_TGT
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|chan
operator|=
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|handle
operator|=
name|isp_find_handle
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|==
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"cannot find handle for command to abort"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp24xx_abrt_t
name|local
decl_stmt|,
modifier|*
name|ab
init|=
operator|&
name|local
decl_stmt|,
modifier|*
name|ab2
decl_stmt|;
name|fcparam
modifier|*
name|fcp
decl_stmt|;
name|fcportdb_t
modifier|*
name|lp
decl_stmt|;
name|int
name|hdlidx
decl_stmt|;
name|fcp
operator|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|hdlidx
operator|=
name|fcp
operator|->
name|isp_dev_map
index|[
name|tgt
index|]
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|hdlidx
operator|<
literal|0
operator|||
name|hdlidx
operator|>=
name|MAX_FC_TARG
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d bad handle %d trying to abort target %d"
argument_list|,
name|chan
argument_list|,
name|hdlidx
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
break|break;
block|}
name|lp
operator|=
operator|&
name|fcp
operator|->
name|portdb
index|[
name|hdlidx
index|]
expr_stmt|;
if|if
condition|(
name|lp
operator|->
name|state
operator|!=
name|FC_PORTDB_STATE_VALID
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d handle %d for abort of target %d no longer valid"
argument_list|,
name|chan
argument_list|,
name|hdlidx
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
break|break;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGALL
argument_list|,
literal|"Chan %d Abort Cmd for N-Port 0x%04x @ Port 0x%06x"
argument_list|,
name|chan
argument_list|,
name|lp
operator|->
name|handle
argument_list|,
name|lp
operator|->
name|portid
argument_list|)
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|ab
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
name|ab
operator|->
name|abrt_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_ABORT_IO
expr_stmt|;
name|ab
operator|->
name|abrt_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|ab
operator|->
name|abrt_handle
operator|=
name|lp
operator|->
name|handle
expr_stmt|;
name|ab
operator|->
name|abrt_cmd_handle
operator|=
name|handle
expr_stmt|;
name|ab
operator|->
name|abrt_tidlo
operator|=
name|lp
operator|->
name|portid
expr_stmt|;
name|ab
operator|->
name|abrt_tidhi
operator|=
name|lp
operator|->
name|portid
operator|>>
literal|16
expr_stmt|;
name|ab
operator|->
name|abrt_vpidx
operator|=
name|ISP_GET_VPIDX
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
operator|&
name|mbs
argument_list|,
sizeof|sizeof
argument_list|(
name|mbs
argument_list|)
argument_list|)
expr_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_EXEC_COMMAND_IOCB_A64
argument_list|,
name|MBLOGALL
argument_list|,
literal|5000000
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|QENTRY_LEN
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DMA_WD1
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|DMA_WD0
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|DMA_WD3
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
name|DMA_WD2
argument_list|(
name|fcp
operator|->
name|isp_scdma
argument_list|)
expr_stmt|;
if|if
condition|(
name|FC_SCRATCH_ACQUIRE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|sacq
argument_list|)
expr_stmt|;
break|break;
block|}
name|isp_put_24xx_abrt
argument_list|(
name|isp
argument_list|,
name|ab
argument_list|,
name|fcp
operator|->
name|isp_scratch
argument_list|)
expr_stmt|;
name|ab2
operator|=
operator|(
name|isp24xx_abrt_t
operator|*
operator|)
operator|&
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|fcp
operator|->
name|isp_scratch
operator|)
index|[
name|QENTRY_LEN
index|]
expr_stmt|;
name|ab2
operator|->
name|abrt_nphdl
operator|=
literal|0xdeaf
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORDEV
argument_list|,
literal|0
argument_list|,
literal|2
operator|*
name|QENTRY_LEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
break|break;
block|}
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_SFORCPU
argument_list|,
name|QENTRY_LEN
argument_list|,
name|QENTRY_LEN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_get_24xx_abrt
argument_list|(
name|isp
argument_list|,
name|ab2
argument_list|,
name|ab
argument_list|)
expr_stmt|;
name|FC_SCRATCH_RELEASE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|ab
operator|->
name|abrt_nphdl
operator|==
name|ISP24XX_ABRT_OKAY
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Chan %d handle %d abort returned 0x%x"
argument_list|,
name|chan
argument_list|,
name|hdlidx
argument_list|,
name|ab
operator|->
name|abrt_nphdl
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|ISP_CAP_SCCFW
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|tgt
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|tgt
operator|<<
literal|8
expr_stmt|;
block|}
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|tgt
operator|<<
literal|8
operator||
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|chan
operator|<<
literal|15
operator|)
operator||
operator|(
name|tgt
operator|<<
literal|8
operator|)
operator||
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_ABORT
argument_list|,
name|MBLOGALL
operator|&
operator|~
name|MBOX_COMMAND_ERROR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|handle
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|ISPCTL_UPDATE_PARAMS
case|:
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|chan
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|isp_spi_update
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|ISPCTL_FCLINK_TEST
case|:
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|int
name|usdelay
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|chan
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|usdelay
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|usdelay
operator|==
literal|0
condition|)
block|{
name|usdelay
operator|=
literal|250000
expr_stmt|;
block|}
return|return
operator|(
name|isp_fclink_test
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|usdelay
argument_list|)
operator|)
return|;
block|}
break|break;
case|case
name|ISPCTL_SCAN_FABRIC
case|:
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|chan
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
operator|(
name|isp_scan_fabric
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|)
return|;
block|}
break|break;
case|case
name|ISPCTL_SCAN_LOOP
case|:
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|chan
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
operator|(
name|isp_scan_loop
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|)
return|;
block|}
break|break;
case|case
name|ISPCTL_PDB_SYNC
case|:
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|chan
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
operator|(
name|isp_pdb_sync
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|)
return|;
block|}
break|break;
case|case
name|ISPCTL_SEND_LIP
case|:
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
operator|&&
operator|!
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_INIT_LIP
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|ibits
operator|=
operator|(
literal|1
operator|<<
literal|10
operator|)
expr_stmt|;
block|}
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|==
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
break|break;
case|case
name|ISPCTL_GET_PDB
case|:
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_pdb_t
modifier|*
name|pdb
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|chan
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|tgt
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|pdb
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|isp_pdb_t
operator|*
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
operator|(
name|isp_getpdb
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|tgt
argument_list|,
name|pdb
argument_list|,
literal|1
argument_list|)
operator|)
return|;
block|}
break|break;
case|case
name|ISPCTL_GET_NAMES
case|:
block|{
name|uint64_t
modifier|*
name|wwnn
decl_stmt|,
modifier|*
name|wwnp
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|chan
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|tgt
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|wwnn
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint64_t
operator|*
argument_list|)
expr_stmt|;
name|wwnp
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|uint64_t
operator|*
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|wwnn
operator|==
name|NULL
operator|&&
name|wwnp
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|wwnn
condition|)
block|{
operator|*
name|wwnn
operator|=
name|isp_get_wwn
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|tgt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|wwnn
operator|==
name|INI_NONE
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|wwnp
condition|)
block|{
operator|*
name|wwnp
operator|=
name|isp_get_wwn
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|tgt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|wwnp
operator|==
name|INI_NONE
condition|)
block|{
break|break;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|ISPCTL_RUN_MBOXCMD
case|:
block|{
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|mbr
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|mbreg_t
operator|*
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
name|mbr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|ISPCTL_PLOGX
case|:
block|{
name|isp_plcmd_t
modifier|*
name|p
decl_stmt|;
name|int
name|r
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
name|p
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|isp_plcmd_t
operator|*
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|flags
operator|&
name|PLOGX_FLG_CMD_MASK
operator|)
operator|!=
name|PLOGX_FLG_CMD_PLOGI
operator|||
operator|(
name|p
operator|->
name|handle
operator|!=
name|NIL_HANDLE
operator|)
condition|)
block|{
return|return
operator|(
name|isp_plogx
argument_list|(
name|isp
argument_list|,
name|p
operator|->
name|channel
argument_list|,
name|p
operator|->
name|handle
argument_list|,
name|p
operator|->
name|portid
argument_list|,
name|p
operator|->
name|flags
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
do|do
block|{
name|p
operator|->
name|handle
operator|=
name|isp_nxt_handle
argument_list|(
name|isp
argument_list|,
name|p
operator|->
name|channel
argument_list|,
name|p
operator|->
name|handle
argument_list|)
expr_stmt|;
name|r
operator|=
name|isp_plogx
argument_list|(
name|isp
argument_list|,
name|p
operator|->
name|channel
argument_list|,
name|p
operator|->
name|handle
argument_list|,
name|p
operator|->
name|portid
argument_list|,
name|p
operator|->
name|flags
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|&
literal|0xffff
operator|)
operator|==
name|MBOX_PORT_ID_USED
condition|)
block|{
name|p
operator|->
name|handle
operator|=
name|r
operator|>>
literal|16
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
operator|(
name|r
operator|&
literal|0xffff
operator|)
operator|==
name|MBOX_LOOP_ID_USED
condition|)
do|;
return|return
operator|(
name|r
operator|)
return|;
block|}
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Unknown Control Opcode 0x%x"
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Interrupt Service Routine(s).  *  * External (OS) framework has done the appropriate locking,  * and the locking will be held throughout this function.  */
end_comment

begin_comment
comment|/*  * Limit our stack depth by sticking with the max likely number  * of completions on a request queue at any one time.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|MAX_REQUESTQ_COMPLETIONS
end_ifndef

begin_define
define|#
directive|define
name|MAX_REQUESTQ_COMPLETIONS
value|32
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|isp_intr
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint32_t
name|isr
parameter_list|,
name|uint16_t
name|sema
parameter_list|,
name|uint16_t
name|mbox
parameter_list|)
block|{
name|XS_T
modifier|*
name|complist
index|[
name|MAX_REQUESTQ_COMPLETIONS
index|]
decl_stmt|,
modifier|*
name|xs
decl_stmt|;
name|uint32_t
name|iptr
decl_stmt|,
name|optr
decl_stmt|,
name|junk
decl_stmt|;
name|int
name|i
decl_stmt|,
name|nlooked
init|=
literal|0
decl_stmt|,
name|ndone
init|=
literal|0
decl_stmt|,
name|continuations_expected
init|=
literal|0
decl_stmt|;
name|int
name|etype
decl_stmt|,
name|last_etype
init|=
literal|0
decl_stmt|;
name|again
label|:
comment|/* 	 * Is this a mailbox related interrupt? 	 * The mailbox semaphore will be nonzero if so. 	 */
if|if
condition|(
name|sema
condition|)
block|{
name|fmbox
label|:
if|if
condition|(
name|mbox
operator|&
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp
operator|->
name|isp_intmboxc
operator|++
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_mboxbsy
condition|)
block|{
name|int
name|obits
init|=
name|isp
operator|->
name|isp_obits
decl_stmt|;
name|isp
operator|->
name|isp_mboxtmp
index|[
literal|0
index|]
operator|=
name|mbox
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|ISP_NMBOX
argument_list|(
name|isp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|obits
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
name|isp
operator|->
name|isp_mboxtmp
index|[
name|i
index|]
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|MBOX_OFF
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_mbxwrk0
condition|)
block|{
if|if
condition|(
name|isp_mbox_continue
argument_list|(
name|isp
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return;
block|}
block|}
name|MBOX_NOTIFY_COMPLETE
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"mailbox cmd (0x%x) with no waiters"
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|i
operator|=
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|?
name|isp_parse_async_fc
argument_list|(
name|isp
argument_list|,
name|mbox
argument_list|)
else|:
name|isp_parse_async
argument_list|(
name|isp
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
return|return;
block|}
block|}
if|if
condition|(
operator|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
operator|&&
name|mbox
operator|!=
name|ASYNC_RIOZIO_STALL
operator|)
operator|||
name|isp
operator|->
name|isp_state
operator|!=
name|ISP_RUNSTATE
condition|)
block|{
goto|goto
name|out
goto|;
block|}
block|}
comment|/* 	 * We can't be getting this now. 	 */
if|if
condition|(
name|isp
operator|->
name|isp_state
operator|!=
name|ISP_RUNSTATE
condition|)
block|{
comment|/* 		 * This seems to happen to 23XX and 24XX cards- don't know why. 		 */
if|if
condition|(
name|isp
operator|->
name|isp_mboxbsy
operator|&&
name|isp
operator|->
name|isp_lastmbxcmd
operator|==
name|MBOX_ABOUT_FIRMWARE
condition|)
block|{
goto|goto
name|fmbox
goto|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"interrupt (ISR=%x SEMA=%x) when not ready"
argument_list|,
name|isr
argument_list|,
name|sema
argument_list|)
expr_stmt|;
comment|/* 		 * Thank you very much!  *Burrrp*! 		 */
name|isp
operator|->
name|isp_residx
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_respinrp
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_resodx
operator|=
name|isp
operator|->
name|isp_residx
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_respoutrp
argument_list|,
name|isp
operator|->
name|isp_resodx
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_DISABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
goto|goto
name|out
goto|;
block|}
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
comment|/* 	 * Check for ATIO Queue entries. 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
operator|(
name|isr
operator|&
name|BIU2400_R2HST_ISTAT_MASK
operator|)
operator|==
name|ISP2400R2HST_ATIO_RSPQ_UPDATE
operator|||
operator|(
name|isr
operator|&
name|BIU2400_R2HST_ISTAT_MASK
operator|)
operator|==
name|ISP2400R2HST_ATIO_RQST_UPDATE
operator|)
condition|)
block|{
name|iptr
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU2400_ATIO_RSPINP
argument_list|)
expr_stmt|;
name|optr
operator|=
name|isp
operator|->
name|isp_atioodx
expr_stmt|;
while|while
condition|(
name|optr
operator|!=
name|iptr
condition|)
block|{
name|uint8_t
name|qe
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
name|isphdr_t
modifier|*
name|hp
decl_stmt|;
name|uint32_t
name|oop
decl_stmt|;
name|void
modifier|*
name|addr
decl_stmt|;
name|oop
operator|=
name|optr
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_ATIOQ
argument_list|,
name|oop
argument_list|,
name|QENTRY_LEN
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|addr
operator|=
name|ISP_QUEUE_ENTRY
argument_list|(
name|isp
operator|->
name|isp_atioq
argument_list|,
name|oop
argument_list|)
expr_stmt|;
name|isp_get_hdr
argument_list|(
name|isp
argument_list|,
name|addr
argument_list|,
operator|(
name|isphdr_t
operator|*
operator|)
name|qe
argument_list|)
expr_stmt|;
name|hp
operator|=
operator|(
name|isphdr_t
operator|*
operator|)
name|qe
expr_stmt|;
switch|switch
condition|(
name|hp
operator|->
name|rqs_entry_type
condition|)
block|{
case|case
name|RQSTYPE_NOTIFY
case|:
case|case
name|RQSTYPE_ATIO
case|:
operator|(
name|void
operator|)
name|isp_target_notify
argument_list|(
name|isp
argument_list|,
name|addr
argument_list|,
operator|&
name|oop
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_print_qentry
argument_list|(
name|isp
argument_list|,
literal|"?ATIOQ entry?"
argument_list|,
name|oop
argument_list|,
name|addr
argument_list|)
expr_stmt|;
break|break;
block|}
name|optr
operator|=
name|ISP_NXT_QENTRY
argument_list|(
name|oop
argument_list|,
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_atioodx
operator|!=
name|optr
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_ATIO_RSPOUTP
argument_list|,
name|optr
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_atioodx
operator|=
name|optr
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* 	 * Get the current Response Queue Out Pointer. 	 * 	 * If we're a 2300 or 2400, we can ask what hardware what it thinks. 	 */
if|#
directive|if
literal|0
block|if (IS_23XX(isp) || IS_24XX(isp)) { 		optr = ISP_READ(isp, isp->isp_respoutrp);
comment|/* 		 * Debug: to be taken out eventually 		 */
block|if (isp->isp_resodx != optr) { 			isp_prt(isp, ISP_LOGINFO, "isp_intr: hard optr=%x, soft optr %x", optr, isp->isp_resodx); 			isp->isp_resodx = optr; 		} 	} else
endif|#
directive|endif
name|optr
operator|=
name|isp
operator|->
name|isp_resodx
expr_stmt|;
comment|/* 	 * You *must* read the Response Queue In Pointer 	 * prior to clearing the RISC interrupt. 	 * 	 * Debounce the 2300 if revision less than 2. 	 */
if|if
condition|(
name|IS_2100
argument_list|(
name|isp
argument_list|)
operator|||
operator|(
name|IS_2300
argument_list|(
name|isp
argument_list|)
operator|&&
name|isp
operator|->
name|isp_revision
operator|<
literal|2
operator|)
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|iptr
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_respinrp
argument_list|)
expr_stmt|;
name|junk
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_respinrp
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|junk
operator|!=
name|iptr
operator|&&
operator|++
name|i
operator|<
literal|1000
condition|)
do|;
if|if
condition|(
name|iptr
operator|!=
name|junk
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Response Queue Out Pointer Unstable (%x, %x)"
argument_list|,
name|iptr
argument_list|,
name|junk
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
name|iptr
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_respinrp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|optr
operator|==
name|iptr
operator|&&
name|sema
operator|==
literal|0
condition|)
block|{
comment|/* 		 * There are a lot of these- reasons unknown- mostly on 		 * faster Alpha machines. 		 * 		 * I tried delaying after writing HCCR_CMD_CLEAR_RISC_INT to 		 * make sure the old interrupt went away (to avoid 'ringing' 		 * effects), but that didn't stop this from occurring. 		 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|junk
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_23XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|iptr
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_respinrp
argument_list|)
expr_stmt|;
name|junk
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_R2HSTSLO
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|junk
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_ISR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|optr
operator|==
name|iptr
condition|)
block|{
if|if
condition|(
name|IS_23XX
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
else|else
block|{
name|sema
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|)
expr_stmt|;
name|mbox
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sema
operator|&
literal|0x3
operator|)
operator|&&
operator|(
name|mbox
operator|&
literal|0x8000
operator|)
condition|)
block|{
goto|goto
name|again
goto|;
block|}
block|}
name|isp
operator|->
name|isp_intbogus
operator|++
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG1
argument_list|,
literal|"bogus intr- isr %x (%x) iptr %x optr %x"
argument_list|,
name|isr
argument_list|,
name|junk
argument_list|,
name|iptr
argument_list|,
name|optr
argument_list|)
expr_stmt|;
block|}
block|}
name|isp
operator|->
name|isp_residx
operator|=
name|iptr
expr_stmt|;
while|while
condition|(
name|optr
operator|!=
name|iptr
condition|)
block|{
name|uint8_t
name|qe
index|[
name|QENTRY_LEN
index|]
decl_stmt|;
name|ispstatusreq_t
modifier|*
name|sp
init|=
operator|(
name|ispstatusreq_t
operator|*
operator|)
name|qe
decl_stmt|;
name|isphdr_t
modifier|*
name|hp
decl_stmt|;
name|int
name|buddaboom
decl_stmt|,
name|scsi_status
decl_stmt|,
name|completion_status
decl_stmt|;
name|int
name|req_status_flags
decl_stmt|,
name|req_state_flags
decl_stmt|;
name|uint8_t
modifier|*
name|snsp
decl_stmt|,
modifier|*
name|resp
decl_stmt|;
name|uint32_t
name|rlen
decl_stmt|,
name|slen
decl_stmt|,
name|totslen
decl_stmt|;
name|long
name|resid
decl_stmt|;
name|uint16_t
name|oop
decl_stmt|;
name|hp
operator|=
operator|(
name|isphdr_t
operator|*
operator|)
name|ISP_QUEUE_ENTRY
argument_list|(
name|isp
operator|->
name|isp_result
argument_list|,
name|optr
argument_list|)
expr_stmt|;
name|oop
operator|=
name|optr
expr_stmt|;
name|optr
operator|=
name|ISP_NXT_QENTRY
argument_list|(
name|optr
argument_list|,
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|nlooked
operator|++
expr_stmt|;
name|read_again
label|:
name|buddaboom
operator|=
name|req_status_flags
operator|=
name|req_state_flags
operator|=
literal|0
expr_stmt|;
name|resid
operator|=
literal|0L
expr_stmt|;
comment|/* 		 * Synchronize our view of this response queue entry. 		 */
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_RESULT
argument_list|,
name|oop
argument_list|,
name|QENTRY_LEN
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|isp_get_hdr
argument_list|(
name|isp
argument_list|,
name|hp
argument_list|,
operator|&
name|sp
operator|->
name|req_header
argument_list|)
expr_stmt|;
name|etype
operator|=
name|sp
operator|->
name|req_header
operator|.
name|rqs_entry_type
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
operator|&&
name|etype
operator|==
name|RQSTYPE_RESPONSE
condition|)
block|{
name|isp24xx_statusreq_t
modifier|*
name|sp2
init|=
operator|(
name|isp24xx_statusreq_t
operator|*
operator|)
name|qe
decl_stmt|;
name|isp_get_24xx_response
argument_list|(
name|isp
argument_list|,
operator|(
name|isp24xx_statusreq_t
operator|*
operator|)
name|hp
argument_list|,
name|sp2
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"Response Queue Entry"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|sp2
argument_list|)
expr_stmt|;
block|}
name|scsi_status
operator|=
name|sp2
operator|->
name|req_scsi_status
expr_stmt|;
name|completion_status
operator|=
name|sp2
operator|->
name|req_completion_status
expr_stmt|;
name|req_state_flags
operator|=
literal|0
expr_stmt|;
name|resid
operator|=
name|sp2
operator|->
name|req_resid
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|etype
operator|==
name|RQSTYPE_RESPONSE
condition|)
block|{
name|isp_get_response
argument_list|(
name|isp
argument_list|,
operator|(
name|ispstatusreq_t
operator|*
operator|)
name|hp
argument_list|,
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"Response Queue Entry"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|sp
argument_list|)
expr_stmt|;
block|}
name|scsi_status
operator|=
name|sp
operator|->
name|req_scsi_status
expr_stmt|;
name|completion_status
operator|=
name|sp
operator|->
name|req_completion_status
expr_stmt|;
name|req_status_flags
operator|=
name|sp
operator|->
name|req_status_flags
expr_stmt|;
name|req_state_flags
operator|=
name|sp
operator|->
name|req_state_flags
expr_stmt|;
name|resid
operator|=
name|sp
operator|->
name|req_resid
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|etype
operator|==
name|RQSTYPE_RIO1
condition|)
block|{
name|isp_rio1_t
modifier|*
name|rio
init|=
operator|(
name|isp_rio1_t
operator|*
operator|)
name|qe
decl_stmt|;
name|isp_get_rio1
argument_list|(
name|isp
argument_list|,
operator|(
name|isp_rio1_t
operator|*
operator|)
name|hp
argument_list|,
name|rio
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|&
name|ISP_LOGDEBUG1
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"Response Queue Entry"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|rio
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rio
operator|->
name|req_header
operator|.
name|rqs_seqno
condition|;
name|i
operator|++
control|)
block|{
name|isp_fastpost_complete
argument_list|(
name|isp
argument_list|,
name|rio
operator|->
name|req_handles
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_fpcchiwater
operator|<
name|rio
operator|->
name|req_header
operator|.
name|rqs_seqno
condition|)
block|{
name|isp
operator|->
name|isp_fpcchiwater
operator|=
name|rio
operator|->
name|req_header
operator|.
name|rqs_seqno
expr_stmt|;
block|}
name|ISP_MEMZERO
argument_list|(
name|hp
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
comment|/* PERF */
name|last_etype
operator|=
name|etype
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|etype
operator|==
name|RQSTYPE_RIO2
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"dropping RIO2 response"
argument_list|)
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|hp
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
comment|/* PERF */
name|last_etype
operator|=
name|etype
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|etype
operator|==
name|RQSTYPE_STATUS_CONT
condition|)
block|{
name|isp_get_cont_response
argument_list|(
name|isp
argument_list|,
operator|(
name|ispstatus_cont_t
operator|*
operator|)
name|hp
argument_list|,
operator|(
name|ispstatus_cont_t
operator|*
operator|)
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|last_etype
operator|==
name|RQSTYPE_RESPONSE
operator|&&
name|continuations_expected
operator|&&
name|ndone
operator|>
literal|0
operator|&&
operator|(
name|xs
operator|=
name|complist
index|[
name|ndone
operator|-
literal|1
index|]
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ispstatus_cont_t
modifier|*
name|scp
init|=
operator|(
name|ispstatus_cont_t
operator|*
operator|)
name|sp
decl_stmt|;
name|XS_SENSE_APPEND
argument_list|(
name|xs
argument_list|,
name|scp
operator|->
name|req_sense_data
argument_list|,
sizeof|sizeof
argument_list|(
name|scp
operator|->
name|req_sense_data
argument_list|)
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
operator||
name|ISP_LOG_CWARN
argument_list|,
literal|"%d more Status Continuations expected"
argument_list|,
operator|--
name|continuations_expected
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"Ignored Continuation Response"
argument_list|)
expr_stmt|;
block|}
name|ISP_MEMZERO
argument_list|(
name|hp
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
comment|/* PERF */
continue|continue;
block|}
else|else
block|{
comment|/* 			 * Somebody reachable via isp_handle_other_response 			 * may have updated the response queue pointers for 			 * us, so we reload our goal index. 			 */
name|int
name|r
decl_stmt|;
name|uint32_t
name|tsto
init|=
name|oop
decl_stmt|;
name|r
operator|=
name|isp_handle_other_response
argument_list|(
name|isp
argument_list|,
name|etype
argument_list|,
name|hp
argument_list|,
operator|&
name|tsto
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|<
literal|0
condition|)
block|{
goto|goto
name|read_again
goto|;
block|}
comment|/* 			 * If somebody updated the output pointer, then reset 			 * optr to be one more than the updated amount. 			 */
while|while
condition|(
name|tsto
operator|!=
name|oop
condition|)
block|{
name|optr
operator|=
name|ISP_NXT_QENTRY
argument_list|(
name|tsto
argument_list|,
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|>
literal|0
condition|)
block|{
name|ISP_MEMZERO
argument_list|(
name|hp
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
comment|/* PERF */
name|last_etype
operator|=
name|etype
expr_stmt|;
continue|continue;
block|}
comment|/* 			 * After this point, we'll just look at the header as 			 * we don't know how to deal with the rest of the 			 * response. 			 */
comment|/* 			 * It really has to be a bounced request just copied 			 * from the request queue to the response queue. If 			 * not, something bad has happened. 			 */
if|if
condition|(
name|etype
operator|!=
name|RQSTYPE_REQUEST
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|notresp
argument_list|,
name|etype
argument_list|,
name|oop
argument_list|,
name|optr
argument_list|,
name|nlooked
argument_list|)
expr_stmt|;
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"Request Queue Entry"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|hp
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
comment|/* PERF */
name|last_etype
operator|=
name|etype
expr_stmt|;
continue|continue;
block|}
name|buddaboom
operator|=
literal|1
expr_stmt|;
name|scsi_status
operator|=
name|sp
operator|->
name|req_scsi_status
expr_stmt|;
name|completion_status
operator|=
name|sp
operator|->
name|req_completion_status
expr_stmt|;
name|req_status_flags
operator|=
name|sp
operator|->
name|req_status_flags
expr_stmt|;
name|req_state_flags
operator|=
name|sp
operator|->
name|req_state_flags
expr_stmt|;
name|resid
operator|=
name|sp
operator|->
name|req_resid
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
name|RQSFLAG_MASK
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
name|RQSFLAG_CONTINUATION
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"unexpected continuation segment"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|last_etype
operator|=
name|etype
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
name|RQSFLAG_FULL
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"internal queues full"
argument_list|)
expr_stmt|;
comment|/* 				 * We'll synthesize a QUEUE FULL message below. 				 */
block|}
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
name|RQSFLAG_BADHEADER
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"bad header flag"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|buddaboom
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
name|RQSFLAG_BADPACKET
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"bad request packet"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|buddaboom
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
name|RQSFLAG_BADCOUNT
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"invalid entry count"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|buddaboom
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
name|RQSFLAG_BADORDER
condition|)
block|{
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"invalid IOCB ordering"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|last_etype
operator|=
name|etype
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
operator|!
name|ISP_VALID_HANDLE
argument_list|(
name|isp
argument_list|,
name|sp
operator|->
name|req_handle
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"bad request handle 0x%x (iocb type 0x%x)"
argument_list|,
name|sp
operator|->
name|req_handle
argument_list|,
name|etype
argument_list|)
expr_stmt|;
name|ISP_MEMZERO
argument_list|(
name|hp
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
comment|/* PERF */
name|last_etype
operator|=
name|etype
expr_stmt|;
continue|continue;
block|}
name|xs
operator|=
name|isp_find_xs
argument_list|(
name|isp
argument_list|,
name|sp
operator|->
name|req_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|xs
operator|==
name|NULL
condition|)
block|{
name|uint8_t
name|ts
init|=
name|completion_status
operator|&
literal|0xff
decl_stmt|;
comment|/* 			 * Only whine if this isn't the expected fallout of 			 * aborting the command or resetting the target. 			 */
if|if
condition|(
name|etype
operator|!=
name|RQSTYPE_RESPONSE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"cannot find handle 0x%x (type 0x%x)"
argument_list|,
name|sp
operator|->
name|req_handle
argument_list|,
name|etype
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ts
operator|!=
name|RQCS_ABORTED
operator|&&
name|ts
operator|!=
name|RQCS_RESET_OCCURRED
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"cannot find handle 0x%x (status 0x%x)"
argument_list|,
name|sp
operator|->
name|req_handle
argument_list|,
name|ts
argument_list|)
expr_stmt|;
block|}
name|ISP_MEMZERO
argument_list|(
name|hp
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
comment|/* PERF */
name|last_etype
operator|=
name|etype
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|req_status_flags
operator|&
name|RQSTF_BUS_RESET
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"%d.%d.%d bus was reset"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BUSRESET
argument_list|)
expr_stmt|;
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|buddaboom
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"%d.%d.%d buddaboom"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
name|resp
operator|=
name|NULL
expr_stmt|;
name|rlen
operator|=
literal|0
expr_stmt|;
name|snsp
operator|=
name|NULL
expr_stmt|;
name|totslen
operator|=
name|slen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
name|scsi_status
operator|&
operator|(
name|RQCS_RV
operator||
name|RQCS_SV
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|resp
operator|=
operator|(
operator|(
name|isp24xx_statusreq_t
operator|*
operator|)
name|sp
operator|)
operator|->
name|req_rsp_sense
expr_stmt|;
name|rlen
operator|=
operator|(
operator|(
name|isp24xx_statusreq_t
operator|*
operator|)
name|sp
operator|)
operator|->
name|req_response_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
name|scsi_status
operator|&
name|RQCS_RV
operator|)
operator|!=
literal|0
condition|)
block|{
name|resp
operator|=
name|sp
operator|->
name|req_response
expr_stmt|;
name|rlen
operator|=
name|sp
operator|->
name|req_response_len
expr_stmt|;
block|}
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
name|scsi_status
operator|&
name|RQCS_SV
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* 			 * Fibre Channel F/W doesn't say we got status 			 * if there's Sense Data instead. I guess they 			 * think it goes w/o saying. 			 */
name|req_state_flags
operator||=
name|RQSF_GOT_STATUS
operator||
name|RQSF_GOT_SENSE
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|snsp
operator|=
operator|(
operator|(
name|isp24xx_statusreq_t
operator|*
operator|)
name|sp
operator|)
operator|->
name|req_rsp_sense
expr_stmt|;
name|snsp
operator|+=
name|rlen
expr_stmt|;
name|totslen
operator|=
operator|(
operator|(
name|isp24xx_statusreq_t
operator|*
operator|)
name|sp
operator|)
operator|->
name|req_sense_len
expr_stmt|;
name|slen
operator|=
operator|(
sizeof|sizeof
argument_list|(
operator|(
operator|(
name|isp24xx_statusreq_t
operator|*
operator|)
name|sp
operator|)
operator|->
name|req_rsp_sense
argument_list|)
operator|)
operator|-
name|rlen
expr_stmt|;
if|if
condition|(
name|totslen
operator|<
name|slen
condition|)
name|slen
operator|=
name|totslen
expr_stmt|;
block|}
else|else
block|{
name|snsp
operator|=
name|sp
operator|->
name|req_sense_data
expr_stmt|;
name|totslen
operator|=
name|sp
operator|->
name|req_sense_len
expr_stmt|;
name|slen
operator|=
sizeof|sizeof
argument_list|(
name|sp
operator|->
name|req_sense_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|totslen
operator|<
name|slen
condition|)
name|slen
operator|=
name|totslen
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
name|req_state_flags
operator|&
name|RQSF_GOT_SENSE
operator|)
condition|)
block|{
name|snsp
operator|=
name|sp
operator|->
name|req_sense_data
expr_stmt|;
name|totslen
operator|=
name|sp
operator|->
name|req_sense_len
expr_stmt|;
name|slen
operator|=
sizeof|sizeof
argument_list|(
name|sp
operator|->
name|req_sense_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|totslen
operator|<
name|slen
condition|)
name|slen
operator|=
name|totslen
expr_stmt|;
block|}
if|if
condition|(
name|req_state_flags
operator|&
name|RQSF_GOT_STATUS
condition|)
block|{
operator|*
name|XS_STSP
argument_list|(
name|xs
argument_list|)
operator|=
name|scsi_status
operator|&
literal|0xff
expr_stmt|;
block|}
switch|switch
condition|(
name|etype
condition|)
block|{
case|case
name|RQSTYPE_RESPONSE
case|:
if|if
condition|(
name|resp
operator|&&
name|rlen
operator|>=
literal|4
operator|&&
name|resp
index|[
name|FCP_RSPNS_CODE_OFFSET
index|]
operator|!=
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
name|lb
index|[
literal|64
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|rnames
index|[
literal|6
index|]
init|=
block|{
literal|"Task Management Function Done"
block|,
literal|"Data Length Differs From Burst Length"
block|,
literal|"Invalid FCP Cmnd"
block|,
literal|"FCP DATA RO mismatch with FCP DATA_XFR_RDY RO"
block|,
literal|"Task Management Function Rejected"
block|,
literal|"Task Management Function Failed"
block|, 				}
decl_stmt|;
if|if
condition|(
name|resp
index|[
name|FCP_RSPNS_CODE_OFFSET
index|]
operator|>
literal|5
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|lb
argument_list|,
sizeof|sizeof
name|lb
argument_list|,
literal|"Unknown FCP Response Code 0x%x"
argument_list|,
name|resp
index|[
name|FCP_RSPNS_CODE_OFFSET
index|]
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|lb
expr_stmt|;
block|}
else|else
block|{
name|ptr
operator|=
name|rnames
index|[
name|resp
index|[
name|FCP_RSPNS_CODE_OFFSET
index|]
index|]
expr_stmt|;
block|}
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"FCP RESPONSE, LENGTH %u: %s CDB0=0x%02x"
argument_list|,
name|rlen
argument_list|,
name|ptr
argument_list|,
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
index|[
name|FCP_RSPNS_CODE_OFFSET
index|]
operator|!=
literal|0
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_parse_status_24xx
argument_list|(
name|isp
argument_list|,
operator|(
name|isp24xx_statusreq_t
operator|*
operator|)
name|sp
argument_list|,
name|xs
argument_list|,
operator|&
name|resid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_parse_status
argument_list|(
name|isp
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sp
argument_list|,
name|xs
argument_list|,
operator|&
name|resid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
operator|||
name|XS_ERR
argument_list|(
name|xs
argument_list|)
operator|==
name|HBA_NOERROR
operator|)
operator|&&
operator|(
operator|*
name|XS_STSP
argument_list|(
name|xs
argument_list|)
operator|==
name|SCSI_BUSY
operator|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_TGTBSY
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|XS_SET_RESID
argument_list|(
name|xs
argument_list|,
name|resid
argument_list|)
expr_stmt|;
comment|/* 				 * A new synchronous rate was negotiated for 				 * this target. Mark state such that we'll go 				 * look up that which has changed later. 				 */
if|if
condition|(
name|req_status_flags
operator|&
name|RQSTF_NEGOTIATION
condition|)
block|{
name|int
name|t
init|=
name|XS_TGT
argument_list|(
name|xs
argument_list|)
decl_stmt|;
name|sdparam
modifier|*
name|sdp
init|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
decl_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|t
index|]
operator|.
name|dev_refresh
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|update
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|req_status_flags
operator|&
name|RQSF_XFER_COMPLETE
condition|)
block|{
name|XS_SET_RESID
argument_list|(
name|xs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|scsi_status
operator|&
name|RQCS_RESID
condition|)
block|{
name|XS_SET_RESID
argument_list|(
name|xs
argument_list|,
name|resid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|XS_SET_RESID
argument_list|(
name|xs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|snsp
operator|&&
name|slen
condition|)
block|{
if|if
condition|(
name|totslen
operator|>
name|slen
condition|)
block|{
name|continuations_expected
operator|+=
operator|(
operator|(
name|totslen
operator|-
name|slen
operator|+
name|QENTRY_LEN
operator|-
literal|5
operator|)
operator|/
operator|(
name|QENTRY_LEN
operator|-
literal|4
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ndone
operator|>
operator|(
name|MAX_REQUESTQ_COMPLETIONS
operator|-
name|continuations_expected
operator|-
literal|1
operator|)
condition|)
block|{
comment|/* we'll lose some stats, but that's a small price to pay */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndone
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|complist
index|[
name|i
index|]
condition|)
block|{
name|isp
operator|->
name|isp_rsltccmplt
operator|++
expr_stmt|;
name|isp_done
argument_list|(
name|complist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|ndone
operator|=
literal|0
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
operator||
name|ISP_LOG_CWARN
argument_list|,
literal|"Expecting %d more Status Continuations for total sense length of %u"
argument_list|,
name|continuations_expected
argument_list|,
name|totslen
argument_list|)
expr_stmt|;
block|}
name|XS_SAVE_SENSE
argument_list|(
name|xs
argument_list|,
name|snsp
argument_list|,
name|totslen
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|req_status_flags
operator|&
name|RQSF_GOT_STATUS
operator|)
operator|&&
operator|(
name|scsi_status
operator|&
literal|0xff
operator|)
operator|==
name|SCSI_CHECK
operator|&&
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"CHECK CONDITION w/o sense data for CDB=0x%x"
argument_list|,
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"CC with no Sense"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|qe
argument_list|)
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG2
argument_list|,
literal|"asked for %ld got raw resid %ld settled for %ld"
argument_list|,
operator|(
name|long
operator|)
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|resid
argument_list|,
operator|(
name|long
operator|)
name|XS_GET_RESID
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQSTYPE_REQUEST
case|:
case|case
name|RQSTYPE_A64
case|:
case|case
name|RQSTYPE_T2RQS
case|:
case|case
name|RQSTYPE_T3RQS
case|:
case|case
name|RQSTYPE_T7RQS
case|:
if|if
condition|(
operator|!
name|IS_24XX
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
name|RQSFLAG_FULL
operator|)
condition|)
block|{
comment|/* 				 * Force Queue Full status. 				 */
operator|*
name|XS_STSP
argument_list|(
name|xs
argument_list|)
operator|=
name|SCSI_QFULL
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"%d.%d.%d badness at %s:%u"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
name|XS_SET_RESID
argument_list|(
name|xs
argument_list|,
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_print_bytes
argument_list|(
name|isp
argument_list|,
literal|"Unhandled Response Type"
argument_list|,
name|QENTRY_LEN
argument_list|,
name|qe
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
comment|/* 		 * Free any DMA resources. As a side effect, this may 		 * also do any cache flushing necessary for data coherence. 		 */
if|if
condition|(
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|ISP_DMAFREE
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|sp
operator|->
name|req_handle
argument_list|)
expr_stmt|;
block|}
name|isp_destroy_handle
argument_list|(
name|isp
argument_list|,
name|sp
operator|->
name|req_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_nactive
operator|>
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_nactive
operator|--
expr_stmt|;
block|}
name|complist
index|[
name|ndone
operator|++
index|]
operator|=
name|xs
expr_stmt|;
comment|/* defer completion call until later */
name|ISP_MEMZERO
argument_list|(
name|hp
argument_list|,
name|QENTRY_LEN
argument_list|)
expr_stmt|;
comment|/* PERF */
name|last_etype
operator|=
name|etype
expr_stmt|;
if|if
condition|(
name|ndone
operator|==
name|MAX_REQUESTQ_COMPLETIONS
condition|)
block|{
break|break;
block|}
block|}
comment|/* 	 * If we looked at any commands, then it's valid to find out 	 * what the outpointer is. It also is a trigger to update the 	 * ISP's notion of what we've seen so far. 	 */
if|if
condition|(
name|nlooked
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_respoutrp
argument_list|,
name|optr
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_resodx
operator|=
name|optr
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_rscchiwater
operator|<
name|ndone
condition|)
name|isp
operator|->
name|isp_rscchiwater
operator|=
name|ndone
expr_stmt|;
block|}
name|out
label|:
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_CLEAR_RISC_INT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_CLEAR_RISC_INT
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndone
condition|;
name|i
operator|++
control|)
block|{
name|xs
operator|=
name|complist
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|xs
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|isp
operator|->
name|isp_dblev
operator|&
operator|(
name|ISP_LOGDEBUG1
operator||
name|ISP_LOGDEBUG2
operator||
name|ISP_LOGDEBUG3
operator|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|isp
operator|->
name|isp_dblev
operator|&
operator|(
name|ISP_LOGDEBUG0
operator||
name|ISP_LOG_CWARN
operator|)
operator|&&
operator|(
operator|(
operator|!
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
operator|)
operator|||
operator|(
operator|*
name|XS_STSP
argument_list|(
name|xs
argument_list|)
operator|!=
name|SCSI_GOOD
operator|)
operator|)
operator|)
operator|)
condition|)
block|{
name|isp_prt_endcmd
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|)
expr_stmt|;
block|}
name|isp
operator|->
name|isp_rsltccmplt
operator|++
expr_stmt|;
name|isp_done
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Support routines.  */
end_comment

begin_function
name|void
name|isp_prt_endcmd
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|XS_T
modifier|*
name|xs
parameter_list|)
block|{
name|char
name|cdbstr
index|[
literal|16
operator|*
literal|5
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|lim
decl_stmt|;
name|lim
operator|=
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
operator|>
literal|16
condition|?
literal|16
else|:
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|cdbstr
argument_list|,
sizeof|sizeof
argument_list|(
name|cdbstr
argument_list|)
argument_list|,
literal|"0x%02x "
argument_list|,
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|lim
condition|;
name|i
operator|++
control|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|cdbstr
argument_list|,
sizeof|sizeof
argument_list|(
name|cdbstr
argument_list|)
argument_list|,
literal|"%s0x%02x "
argument_list|,
name|cdbstr
argument_list|,
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|XS_SENSE_VALID
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGALL
argument_list|,
literal|"FIN dl%d resid %ld CDB=%s SenseLength=%u/%u KEY/ASC/ASCQ=0x%02x/0x%02x/0x%02x"
argument_list|,
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|XS_GET_RESID
argument_list|(
name|xs
argument_list|)
argument_list|,
name|cdbstr
argument_list|,
name|XS_CUR_SNSLEN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_TOT_SNSLEN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_SNSKEY
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_SNSASC
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_SNSASCQ
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGALL
argument_list|,
literal|"FIN dl%d resid %ld CDB=%s STS 0x%x XS_ERR=0x%x"
argument_list|,
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|XS_GET_RESID
argument_list|(
name|xs
argument_list|)
argument_list|,
name|cdbstr
argument_list|,
operator|*
name|XS_STSP
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_ERR
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Parse an ASYNC mailbox complete  *  * Return non-zero if the event has been acknowledged.  */
end_comment

begin_function
specifier|static
name|int
name|isp_parse_async
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint16_t
name|mbox
parameter_list|)
block|{
name|int
name|acked
init|=
literal|0
decl_stmt|;
name|uint32_t
name|h1
init|=
literal|0
decl_stmt|,
name|h2
init|=
literal|0
decl_stmt|;
name|uint16_t
name|chan
init|=
literal|0
decl_stmt|;
comment|/* 	 * Pick up the channel, but not if this is a ASYNC_RIO32_2, 	 * where Mailboxes 6/7 have the second handle. 	 */
if|if
condition|(
name|mbox
operator|!=
name|ASYNC_RIO32_2
condition|)
block|{
if|if
condition|(
name|IS_DUALBUS
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|chan
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX6
argument_list|)
expr_stmt|;
block|}
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG2
argument_list|,
literal|"Async Mbox 0x%x"
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mbox
condition|)
block|{
case|case
name|ASYNC_BUS_RESET
case|:
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|isp_target_async
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|mbox
argument_list|)
condition|)
block|{
name|acked
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_BUS_RESET
argument_list|,
name|chan
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_SYSTEM_ERROR
case|:
name|isp
operator|->
name|isp_dead
operator|=
literal|1
expr_stmt|;
name|isp
operator|->
name|isp_state
operator|=
name|ISP_CRASHED
expr_stmt|;
comment|/* 		 * Were we waiting for a mailbox command to complete? 		 * If so, it's dead, so wake up the waiter. 		 */
if|if
condition|(
name|isp
operator|->
name|isp_mboxbsy
condition|)
block|{
name|isp
operator|->
name|isp_obits
operator|=
literal|1
expr_stmt|;
name|isp
operator|->
name|isp_mboxtmp
index|[
literal|0
index|]
operator|=
name|MBOX_HOST_INTERFACE_ERROR
expr_stmt|;
name|MBOX_NOTIFY_COMPLETE
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * It's up to the handler for isp_async to reinit stuff and 		 * restart the firmware 		 */
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_FW_CRASH
argument_list|)
expr_stmt|;
name|acked
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ASYNC_RQS_XFER_ERR
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Request Queue Transfer Error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_RSP_XFER_ERR
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Response Queue Transfer Error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_QWAKEUP
case|:
comment|/* 		 * We've just been notified that the Queue has woken up. 		 * We don't need to be chatty about this- just unlatch things 		 * and move on. 		 */
name|mbox
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|isp
operator|->
name|isp_rqstoutrp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_TIMEOUT_RESET
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"timeout initiated SCSI bus reset of chan %d"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|isp_target_async
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|mbox
argument_list|)
condition|)
block|{
name|acked
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
break|break;
case|case
name|ASYNC_DEVICE_RESET
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"device reset on chan %d"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|isp_target_async
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|mbox
argument_list|)
condition|)
block|{
name|acked
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
break|break;
case|case
name|ASYNC_EXTMSG_UNDERRUN
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"extended message underrun"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_SCAM_INT
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"SCAM interrupt"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_HUNG_SCSI
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"stalled SCSI Bus after DATA Overrun"
argument_list|)
expr_stmt|;
comment|/* XXX: Need to issue SCSI reset at this point */
break|break;
case|case
name|ASYNC_KILLED_BUS
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"SCSI Bus reset after DATA Overrun"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_BUS_TRANSIT
case|:
name|mbox
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX2
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mbox
operator|&
name|SXP_PINS_MODE_MASK
condition|)
block|{
case|case
name|SXP_PINS_LVD_MODE
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Transition to LVD mode"
argument_list|)
expr_stmt|;
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_diffmode
operator|=
literal|0
expr_stmt|;
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_ultramode
operator|=
literal|0
expr_stmt|;
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_lvdmode
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SXP_PINS_HVD_MODE
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Transition to Differential mode"
argument_list|)
expr_stmt|;
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_diffmode
operator|=
literal|1
expr_stmt|;
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_ultramode
operator|=
literal|0
expr_stmt|;
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_lvdmode
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SXP_PINS_SE_MODE
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Transition to Single Ended mode"
argument_list|)
expr_stmt|;
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_diffmode
operator|=
literal|0
expr_stmt|;
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_ultramode
operator|=
literal|1
expr_stmt|;
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_lvdmode
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Transition to Unknown Mode 0x%x"
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 		 * XXX: Set up to renegotiate again! 		 */
comment|/* Can only be for a 1080... */
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_CMD_CMPLT
case|:
case|case
name|ASYNC_RIO32_1
case|:
if|if
condition|(
operator|!
name|IS_ULTRA3
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"unexpected fast posting completion"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* FALLTHROUGH */
name|h1
operator|=
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX2
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX1
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_RIO32_2
case|:
name|h1
operator|=
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX2
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX1
argument_list|)
expr_stmt|;
name|h2
operator|=
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX7
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX6
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_RIO16_5
case|:
case|case
name|ASYNC_RIO16_4
case|:
case|case
name|ASYNC_RIO16_3
case|:
case|case
name|ASYNC_RIO16_2
case|:
case|case
name|ASYNC_RIO16_1
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"unexpected 16 bit RIO handle"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"%s: unhandled async code 0x%x"
argument_list|,
name|__func__
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|h1
operator|||
name|h2
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG3
argument_list|,
literal|"fast post/rio completion of 0x%08x"
argument_list|,
name|h1
argument_list|)
expr_stmt|;
name|isp_fastpost_complete
argument_list|(
name|isp
argument_list|,
name|h1
argument_list|)
expr_stmt|;
if|if
condition|(
name|h2
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG3
argument_list|,
literal|"fast post/rio completion of 0x%08x"
argument_list|,
name|h2
argument_list|)
expr_stmt|;
name|isp_fastpost_complete
argument_list|(
name|isp
argument_list|,
name|h2
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_fpcchiwater
operator|<
literal|2
condition|)
block|{
name|isp
operator|->
name|isp_fpcchiwater
operator|=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|isp
operator|->
name|isp_fpcchiwater
operator|<
literal|1
condition|)
block|{
name|isp
operator|->
name|isp_fpcchiwater
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|isp
operator|->
name|isp_intoasync
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|acked
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|GET_24XX_BUS
parameter_list|(
name|isp
parameter_list|,
name|chan
parameter_list|,
name|msg
parameter_list|)
define|\
value|if (IS_24XX(isp)) {											\ 		chan = ISP_READ(isp, OUTMAILBOX3)& 0xff;							\ 		if (chan>= isp->isp_nchan) {									\ 			isp_prt(isp, ISP_LOGERR, "bogus channel %u for %s at line %d",	chan, msg, __LINE__);	\ 			break;											\ 		}												\ 	}
end_define

begin_function
specifier|static
name|int
name|isp_parse_async_fc
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint16_t
name|mbox
parameter_list|)
block|{
name|int
name|acked
init|=
literal|0
decl_stmt|;
name|uint16_t
name|chan
decl_stmt|;
if|if
condition|(
name|IS_DUALBUS
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|chan
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX6
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|chan
operator|=
literal|0
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG2
argument_list|,
literal|"Async Mbox 0x%x"
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mbox
condition|)
block|{
case|case
name|ASYNC_SYSTEM_ERROR
case|:
name|isp
operator|->
name|isp_dead
operator|=
literal|1
expr_stmt|;
name|isp
operator|->
name|isp_state
operator|=
name|ISP_CRASHED
expr_stmt|;
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_loopstate
operator|=
name|LOOP_NIL
expr_stmt|;
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_fwstate
operator|=
name|FW_CONFIG_WAIT
expr_stmt|;
comment|/* 		 * Were we waiting for a mailbox command to complete? 		 * If so, it's dead, so wake up the waiter. 		 */
if|if
condition|(
name|isp
operator|->
name|isp_mboxbsy
condition|)
block|{
name|isp
operator|->
name|isp_obits
operator|=
literal|1
expr_stmt|;
name|isp
operator|->
name|isp_mboxtmp
index|[
literal|0
index|]
operator|=
name|MBOX_HOST_INTERFACE_ERROR
expr_stmt|;
name|MBOX_NOTIFY_COMPLETE
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * It's up to the handler for isp_async to reinit stuff and 		 * restart the firmware 		 */
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_FW_CRASH
argument_list|)
expr_stmt|;
name|acked
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ASYNC_RQS_XFER_ERR
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Request Queue Transfer Error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_RSP_XFER_ERR
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Response Queue Transfer Error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_QWAKEUP
case|:
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"ATIO Queue Transfer Error"
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"%s: unexpected ASYNC_QWAKEUP code"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_CMD_CMPLT
case|:
name|isp_fastpost_complete
argument_list|(
name|isp
argument_list|,
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX2
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_fpcchiwater
operator|<
literal|1
condition|)
block|{
name|isp
operator|->
name|isp_fpcchiwater
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|ASYNC_RIOZIO_STALL
case|:
break|break;
case|case
name|ASYNC_CTIO_DONE
case|:
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|isp_target_async
argument_list|(
name|isp
argument_list|,
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX2
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX1
argument_list|)
argument_list|,
name|mbox
argument_list|)
condition|)
block|{
name|acked
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|isp
operator|->
name|isp_fphccmplt
operator|++
expr_stmt|;
block|}
else|#
directive|else
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"unexpected ASYNC CTIO done"
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|ASYNC_LIP_ERROR
case|:
case|case
name|ASYNC_LIP_F8
case|:
case|case
name|ASYNC_LIP_OCCURRED
case|:
case|case
name|ASYNC_PTPMODE
case|:
comment|/* 		 * These are broadcast events that have to be sent across 		 * all active channels. 		 */
for|for
control|(
name|chan
operator|=
literal|0
init|;
name|chan
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|chan
operator|++
control|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|int
name|topo
init|=
name|fcp
operator|->
name|isp_topo
decl_stmt|;
if|if
condition|(
name|fcp
operator|->
name|role
operator|==
name|ISP_ROLE_NONE
condition|)
block|{
continue|continue;
block|}
name|fcp
operator|->
name|isp_fwstate
operator|=
name|FW_CONFIG_WAIT
expr_stmt|;
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_LIP_RCVD
expr_stmt|;
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_LIP
argument_list|,
name|chan
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|isp_target_async
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|mbox
argument_list|)
condition|)
block|{
name|acked
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* 			 * We've had problems with data corruption occuring on 			 * commands that complete (with no apparent error) after 			 * we receive a LIP. This has been observed mostly on 			 * Local Loop topologies. To be safe, let's just mark 			 * all active initiator commands as dead. 			 */
if|if
condition|(
name|topo
operator|==
name|TOPO_NL_PORT
operator|||
name|topo
operator|==
name|TOPO_FL_PORT
condition|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|isp
operator|->
name|isp_maxcmds
condition|;
name|i
operator|++
control|)
block|{
name|XS_T
modifier|*
name|xs
decl_stmt|;
name|isp_hdl_t
modifier|*
name|hdp
decl_stmt|;
name|hdp
operator|=
operator|&
name|isp
operator|->
name|isp_xflist
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ISP_H2HT
argument_list|(
name|hdp
operator|->
name|handle
argument_list|)
operator|!=
name|ISP_HANDLE_INITIATOR
condition|)
block|{
continue|continue;
block|}
name|xs
operator|=
name|hdp
operator|->
name|cmd
expr_stmt|;
if|if
condition|(
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
operator|!=
name|chan
condition|)
block|{
continue|continue;
block|}
name|j
operator|++
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"%d.%d.%d bus reset set at %s:%u"
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BUSRESET
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|j
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
name|lipd
argument_list|,
name|chan
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
case|case
name|ASYNC_LOOP_UP
case|:
comment|/* 		 * This is a broadcast event that has to be sent across 		 * all active channels. 		 */
for|for
control|(
name|chan
operator|=
literal|0
init|;
name|chan
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|chan
operator|++
control|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
if|if
condition|(
name|fcp
operator|->
name|role
operator|==
name|ISP_ROLE_NONE
condition|)
block|{
continue|continue;
block|}
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_fwstate
operator|=
name|FW_CONFIG_WAIT
expr_stmt|;
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_LIP_RCVD
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_LOOP_UP
argument_list|,
name|chan
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|isp_target_async
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|mbox
argument_list|)
condition|)
block|{
name|acked
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
block|}
break|break;
case|case
name|ASYNC_LOOP_DOWN
case|:
comment|/* 		 * This is a broadcast event that has to be sent across 		 * all active channels. 		 */
for|for
control|(
name|chan
operator|=
literal|0
init|;
name|chan
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|chan
operator|++
control|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
if|if
condition|(
name|fcp
operator|->
name|role
operator|==
name|ISP_ROLE_NONE
condition|)
block|{
continue|continue;
block|}
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_fwstate
operator|=
name|FW_CONFIG_WAIT
expr_stmt|;
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_NIL
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_LOOP_DOWN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|isp_target_async
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|mbox
argument_list|)
condition|)
block|{
name|acked
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
block|}
break|break;
case|case
name|ASYNC_LOOP_RESET
case|:
comment|/* 		 * This is a broadcast event that has to be sent across 		 * all active channels. 		 */
for|for
control|(
name|chan
operator|=
literal|0
init|;
name|chan
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|chan
operator|++
control|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
if|if
condition|(
name|fcp
operator|->
name|role
operator|==
name|ISP_ROLE_NONE
condition|)
block|{
continue|continue;
block|}
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_fwstate
operator|=
name|FW_CONFIG_WAIT
expr_stmt|;
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_NIL
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_LOOP_RESET
argument_list|,
name|chan
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|isp_target_async
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
name|mbox
argument_list|)
condition|)
block|{
name|acked
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
block|}
break|break;
case|case
name|ASYNC_PDB_CHANGED
case|:
block|{
name|int
name|nphdl
decl_stmt|,
name|nlstate
decl_stmt|,
name|reason
decl_stmt|;
comment|/* 		 * We *should* get a channel out of the 24XX, but we don't seem 		 * to get more than a PDB CHANGED on channel 0, so turn it into 		 * a broadcast event. 		 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|nphdl
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX1
argument_list|)
expr_stmt|;
name|nlstate
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX2
argument_list|)
expr_stmt|;
name|reason
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX3
argument_list|)
operator|>>
literal|8
expr_stmt|;
block|}
else|else
block|{
name|nphdl
operator|=
name|NIL_HANDLE
expr_stmt|;
name|nlstate
operator|=
name|reason
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|chan
operator|=
literal|0
init|;
name|chan
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|chan
operator|++
control|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
if|if
condition|(
name|fcp
operator|->
name|role
operator|==
name|ISP_ROLE_NONE
condition|)
block|{
continue|continue;
block|}
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_PDB_RCVD
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_CHANGE_NOTIFY
argument_list|,
name|chan
argument_list|,
name|ISPASYNC_CHANGE_PDB
argument_list|,
name|nphdl
argument_list|,
name|nlstate
argument_list|,
name|reason
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|ASYNC_CHANGE_NOTIFY
case|:
block|{
name|int
name|lochan
decl_stmt|,
name|hichan
decl_stmt|;
if|if
condition|(
name|ISP_FW_NEWER_THAN
argument_list|(
name|isp
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
literal|25
argument_list|)
operator|&&
name|ISP_CAP_MULTI_ID
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|GET_24XX_BUS
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|"ASYNC_CHANGE_NOTIFY"
argument_list|)
expr_stmt|;
name|lochan
operator|=
name|chan
expr_stmt|;
name|hichan
operator|=
name|chan
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|lochan
operator|=
literal|0
expr_stmt|;
name|hichan
operator|=
name|isp
operator|->
name|isp_nchan
expr_stmt|;
block|}
for|for
control|(
name|chan
operator|=
name|lochan
init|;
name|chan
operator|<
name|hichan
condition|;
name|chan
operator|++
control|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
if|if
condition|(
name|fcp
operator|->
name|role
operator|==
name|ISP_ROLE_NONE
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_topo
operator|==
name|TOPO_F_PORT
condition|)
block|{
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_LSCAN_DONE
expr_stmt|;
block|}
else|else
block|{
name|fcp
operator|->
name|isp_loopstate
operator|=
name|LOOP_PDB_RCVD
expr_stmt|;
block|}
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_CHANGE_NOTIFY
argument_list|,
name|chan
argument_list|,
name|ISPASYNC_CHANGE_SNS
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|ASYNC_CONNMODE
case|:
comment|/* 		 * This only applies to 2100 amd 2200 cards 		 */
if|if
condition|(
operator|!
name|IS_2200
argument_list|(
name|isp
argument_list|)
operator|&&
operator|!
name|IS_2100
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"bad card for ASYNC_CONNMODE event"
argument_list|)
expr_stmt|;
break|break;
block|}
name|chan
operator|=
literal|0
expr_stmt|;
name|mbox
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX1
argument_list|)
expr_stmt|;
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mbox
condition|)
block|{
case|case
name|ISP_CONN_LOOP
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Point-to-Point -> Loop mode"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISP_CONN_PTP
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Loop -> Point-to-Point mode"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISP_CONN_BADLIP
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Point-to-Point -> Loop mode (BAD LIP)"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISP_CONN_FATAL
case|:
name|isp
operator|->
name|isp_dead
operator|=
literal|1
expr_stmt|;
name|isp
operator|->
name|isp_state
operator|=
name|ISP_CRASHED
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"FATAL CONNECTION ERROR"
argument_list|)
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_FW_CRASH
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
case|case
name|ISP_CONN_LOOPBACK
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Looped Back in Point-to-Point mode"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Unknown connection mode (0x%x)"
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
break|break;
block|}
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_CHANGE_NOTIFY
argument_list|,
name|chan
argument_list|,
name|ISPASYNC_CHANGE_OTHER
argument_list|)
expr_stmt|;
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|sendmarker
operator|=
literal|1
expr_stmt|;
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_fwstate
operator|=
name|FW_CONFIG_WAIT
expr_stmt|;
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|isp_loopstate
operator|=
name|LOOP_LIP_RCVD
expr_stmt|;
break|break;
case|case
name|ASYNC_RCV_ERR
case|:
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Receive Error"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"unexpected ASYNC_RCV_ERR"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ASYNC_RJT_SENT
case|:
comment|/* same as ASYNC_QFULL_SENT */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"LS_RJT sent"
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|IS_2200
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGTDEBUG0
argument_list|,
literal|"QFULL sent"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* FALLTHROUGH */
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Unknown Async Code 0x%x"
argument_list|,
name|mbox
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|mbox
operator|!=
name|ASYNC_CTIO_DONE
operator|&&
name|mbox
operator|!=
name|ASYNC_CMD_CMPLT
condition|)
block|{
name|isp
operator|->
name|isp_intoasync
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|acked
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Handle other response entries. A pointer to the request queue output  * index is here in case we want to eat several entries at once, although  * this is not used currently.  */
end_comment

begin_function
specifier|static
name|int
name|isp_handle_other_response
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|type
parameter_list|,
name|isphdr_t
modifier|*
name|hp
parameter_list|,
name|uint32_t
modifier|*
name|optrp
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|RQSTYPE_STATUS_CONT
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"Ignored Continuation Response"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|RQSTYPE_MARKER
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"Marker Response"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|RQSTYPE_ATIO
case|:
case|case
name|RQSTYPE_CTIO
case|:
case|case
name|RQSTYPE_ENABLE_LUN
case|:
case|case
name|RQSTYPE_MODIFY_LUN
case|:
case|case
name|RQSTYPE_NOTIFY
case|:
case|case
name|RQSTYPE_NOTIFY_ACK
case|:
case|case
name|RQSTYPE_CTIO1
case|:
case|case
name|RQSTYPE_ATIO2
case|:
case|case
name|RQSTYPE_CTIO2
case|:
case|case
name|RQSTYPE_CTIO3
case|:
case|case
name|RQSTYPE_CTIO7
case|:
case|case
name|RQSTYPE_ABTS_RCVD
case|:
case|case
name|RQSTYPE_ABTS_RSP
case|:
name|isp
operator|->
name|isp_rsltccmplt
operator|++
expr_stmt|;
comment|/* count as a response completion */
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|isp_target_notify
argument_list|(
name|isp
argument_list|,
operator|(
name|ispstatusreq_t
operator|*
operator|)
name|hp
argument_list|,
name|optrp
argument_list|)
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
endif|#
directive|endif
comment|/* FALLTHROUGH */
case|case
name|RQSTYPE_RPT_ID_ACQ
case|:
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_ridacq_t
name|rid
decl_stmt|;
name|isp_get_ridacq
argument_list|(
name|isp
argument_list|,
operator|(
name|isp_ridacq_t
operator|*
operator|)
name|hp
argument_list|,
operator|&
name|rid
argument_list|)
expr_stmt|;
if|if
condition|(
name|rid
operator|.
name|ridacq_format
operator|==
literal|0
condition|)
block|{ 			}
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* FALLTHROUGH */
case|case
name|RQSTYPE_REQUEST
case|:
default|default:
name|ISP_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|isp_get_response_type
argument_list|(
name|isp
argument_list|,
name|hp
argument_list|)
condition|)
block|{
comment|/* 			 * This is questionable- we're just papering over 			 * something we've seen on SMP linux in target 			 * mode- we don't really know what's happening 			 * here that causes us to think we've gotten 			 * an entry, but that either the entry isn't 			 * filled out yet or our CPU read data is stale. 			 */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"unstable type in response queue"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Unhandled Response Type 0x%x"
argument_list|,
name|isp_get_response_type
argument_list|(
name|isp
argument_list|,
name|hp
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_parse_status
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|ispstatusreq_t
modifier|*
name|sp
parameter_list|,
name|XS_T
modifier|*
name|xs
parameter_list|,
name|long
modifier|*
name|rp
parameter_list|)
block|{
switch|switch
condition|(
name|sp
operator|->
name|req_completion_status
operator|&
literal|0xff
condition|)
block|{
case|case
name|RQCS_COMPLETE
case|:
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_INCOMPLETE
case|:
if|if
condition|(
operator|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_TARGET
operator|)
operator|==
literal|0
condition|)
block|{
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"Selection Timeout @ %s:%d"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
operator|*
name|rp
operator|=
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Command Incomplete, state 0x%x"
argument_list|,
name|sp
operator|->
name|req_state_flags
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_DMA_ERROR
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"DMA Error"
argument_list|)
expr_stmt|;
operator|*
name|rp
operator|=
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_TRANSPORT_ERROR
case|:
block|{
name|char
name|buf
index|[
literal|172
index|]
decl_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"states=>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_BUS
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s GOT_BUS"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_TARGET
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s GOT_TGT"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_SENT_CDB
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s SENT_CDB"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_XFRD_DATA
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s XFRD_DATA"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_STATUS
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s GOT_STS"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_SENSE
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s GOT_SNS"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_XFER_COMPLETE
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s XFR_CMPLT"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s\nstatus=>"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_DISCONNECT
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Disconnect"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_SYNCHRONOUS
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Sync_xfr"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_PARITY_ERROR
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Parity"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_BUS_RESET
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Bus_Reset"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_DEVICE_RESET
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Device_Reset"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_ABORTED
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Aborted"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_TIMEOUT
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Timeout"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_NEGOTIATION
condition|)
block|{
name|ISP_SNPRINTF
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s Negotiation"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Transport Error: %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|*
name|rp
operator|=
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|RQCS_RESET_OCCURRED
case|:
block|{
name|int
name|chan
decl_stmt|;
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Bus Reset destroyed command"
argument_list|)
expr_stmt|;
for|for
control|(
name|chan
operator|=
literal|0
init|;
name|chan
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|chan
operator|++
control|)
block|{
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|sendmarker
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BUSRESET
argument_list|)
expr_stmt|;
block|}
operator|*
name|rp
operator|=
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
return|return;
block|}
case|case
name|RQCS_ABORTED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Command Aborted"
argument_list|)
expr_stmt|;
name|ISP_SET_SENDMARKER
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_ABORTED
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_TIMEOUT
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Command timed out"
argument_list|)
expr_stmt|;
comment|/* 	 	 * XXX: Check to see if we logged out of the device. 		 */
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_CMDTIMEOUT
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_DATA_OVERRUN
case|:
name|XS_SET_RESID
argument_list|(
name|xs
argument_list|,
name|sp
operator|->
name|req_resid
argument_list|)
expr_stmt|;
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"data overrun (%ld)"
argument_list|,
operator|(
name|long
operator|)
name|XS_GET_RESID
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_DATAOVR
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_COMMAND_OVERRUN
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"command overrun"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_STATUS_OVERRUN
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"status overrun"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_BAD_MESSAGE
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"msg not COMMAND COMPLETE after status"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_NO_MESSAGE_OUT
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"No MESSAGE OUT phase after selection"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_EXT_ID_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"EXTENDED IDENTIFY failed"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_IDE_MSG_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"INITIATOR DETECTED ERROR rejected"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_ABORT_MSG_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"ABORT OPERATION rejected"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_REJECT_MSG_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"MESSAGE REJECT rejected"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_NOP_MSG_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"NOP rejected"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_PARITY_ERROR_MSG_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"MESSAGE PARITY ERROR rejected"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_DEVICE_RESET_MSG_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"BUS DEVICE RESET rejected"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_ID_MSG_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"IDENTIFY rejected"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_UNEXP_BUS_FREE
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Unexpected Bus Free"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_DATA_UNDERRUN
case|:
block|{
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|int
name|ru_marked
init|=
operator|(
name|sp
operator|->
name|req_scsi_status
operator|&
name|RQCS_RU
operator|)
operator|!=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|ru_marked
operator|||
name|sp
operator|->
name|req_resid
operator|>
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGWARN
argument_list|,
name|bun
argument_list|,
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|sp
operator|->
name|req_resid
argument_list|,
operator|(
name|ru_marked
operator|)
condition|?
literal|"marked"
else|:
literal|"not marked"
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
block|}
name|XS_SET_RESID
argument_list|(
name|xs
argument_list|,
name|sp
operator|->
name|req_resid
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
case|case
name|RQCS_XACT_ERR1
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"HBA attempted queued transaction with disconnect not set"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_XACT_ERR2
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"HBA attempted queued transaction to target routine %d"
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_XACT_ERR3
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"HBA attempted queued cmd when queueing disabled"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_BAD_ENTRY
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Invalid IOCB entry type detected"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_QUEUE_FULL
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"internal queues full status 0x%x"
argument_list|,
operator|*
name|XS_STSP
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * If QFULL or some other status byte is set, then this 		 * isn't an error, per se. 		 * 		 * Unfortunately, some QLogic f/w writers have, in 		 * some cases, ommitted to *set* status to QFULL. 		 */
if|#
directive|if
literal|0
block|if (*XS_STSP(xs) != SCSI_GOOD&& XS_NOERR(xs)) { 			XS_SETERR(xs, HBA_NOERROR); 			return; 		}
endif|#
directive|endif
operator|*
name|XS_STSP
argument_list|(
name|xs
argument_list|)
operator|=
name|SCSI_QFULL
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
return|return;
case|case
name|RQCS_PHASE_SKIPPED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"SCSI phase skipped"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_ARQS_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Auto Request Sense Failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_ARQFAIL
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_WIDE_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Wide Negotiation Failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|sdparam
modifier|*
name|sdp
init|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
decl_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|XS_TGT
argument_list|(
name|xs
argument_list|)
index|]
operator|.
name|goal_flags
operator|&=
operator|~
name|DPARM_WIDE
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|XS_TGT
argument_list|(
name|xs
argument_list|)
index|]
operator|.
name|dev_update
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|update
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_SYNCXFER_FAILED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"SDTR Message Failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|sdparam
modifier|*
name|sdp
init|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
argument_list|)
decl_stmt|;
name|sdp
operator|+=
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|XS_TGT
argument_list|(
name|xs
argument_list|)
index|]
operator|.
name|goal_flags
operator|&=
operator|~
name|DPARM_SYNC
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|XS_TGT
argument_list|(
name|xs
argument_list|)
index|]
operator|.
name|dev_update
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|update
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|RQCS_LVD_BUSERR
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Bad LVD condition"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_PORT_UNAVAILABLE
case|:
comment|/* 		 * No such port on the loop. Moral equivalent of SELTIMEO 		 */
case|case
name|RQCS_PORT_LOGGED_OUT
case|:
block|{
specifier|const
name|char
modifier|*
name|reason
decl_stmt|;
name|uint8_t
name|sts
init|=
name|sp
operator|->
name|req_completion_status
operator|&
literal|0xff
decl_stmt|;
comment|/* 		 * It was there (maybe)- treat as a selection timeout. 		 */
if|if
condition|(
name|sts
operator|==
name|RQCS_PORT_UNAVAILABLE
condition|)
block|{
name|reason
operator|=
literal|"unavailable"
expr_stmt|;
block|}
else|else
block|{
name|reason
operator|=
literal|"logout"
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"port %s for target %d"
argument_list|,
name|reason
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * If we're on a local loop, force a LIP (which is overkill) 		 * to force a re-login of this unit. If we're on fabric, 		 * then we'll have to log in again as a matter of course. 		 */
if|if
condition|(
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|isp_topo
operator|==
name|TOPO_NL_PORT
operator|||
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|isp_topo
operator|==
name|TOPO_FL_PORT
condition|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_INIT_LIP
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISP_CAP_2KLOGIN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbs
operator|.
name|ibits
operator|=
operator|(
literal|1
operator|<<
literal|10
operator|)
expr_stmt|;
block|}
name|isp_mboxcmd_qnw
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
case|case
name|RQCS_PORT_CHANGED
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"port changed for target %d"
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_PORT_BUSY
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"port busy for target %d"
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_TGTBSY
argument_list|)
expr_stmt|;
block|}
return|return;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Unknown Completion Status 0x%x"
argument_list|,
name|sp
operator|->
name|req_completion_status
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_parse_status_24xx
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|isp24xx_statusreq_t
modifier|*
name|sp
parameter_list|,
name|XS_T
modifier|*
name|xs
parameter_list|,
name|long
modifier|*
name|rp
parameter_list|)
block|{
name|int
name|ru_marked
decl_stmt|,
name|sv_marked
decl_stmt|;
name|int
name|chan
init|=
name|XS_CHANNEL
argument_list|(
name|xs
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|sp
operator|->
name|req_completion_status
condition|)
block|{
case|case
name|RQCS_COMPLETE
case|:
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_DMA_ERROR
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"DMA error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_TRANSPORT_ERROR
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Transport Error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_RESET_OCCURRED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"reset destroyed command"
argument_list|)
expr_stmt|;
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|sendmarker
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BUSRESET
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_ABORTED
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Command Aborted"
argument_list|)
expr_stmt|;
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|sendmarker
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_ABORTED
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_TIMEOUT
case|:
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Command Timed Out"
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_CMDTIMEOUT
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_DATA_OVERRUN
case|:
name|XS_SET_RESID
argument_list|(
name|xs
argument_list|,
name|sp
operator|->
name|req_resid
argument_list|)
expr_stmt|;
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Data Overrun"
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_DATAOVR
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_24XX_DRE
case|:
comment|/* data reassembly error */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Chan %d data reassembly error for target %d"
argument_list|,
name|chan
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_ABORTED
argument_list|)
expr_stmt|;
block|}
operator|*
name|rp
operator|=
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
return|return;
case|case
name|RQCS_24XX_TABORT
case|:
comment|/* aborted by target */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Chan %d target %d sent ABTS"
argument_list|,
name|chan
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_ABORTED
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_DATA_UNDERRUN
case|:
name|ru_marked
operator|=
operator|(
name|sp
operator|->
name|req_scsi_status
operator|&
name|RQCS_RU
operator|)
operator|!=
literal|0
expr_stmt|;
comment|/* 		 * We can get an underrun w/o things being marked 		 * if we got a non-zero status. 		 */
name|sv_marked
operator|=
operator|(
name|sp
operator|->
name|req_scsi_status
operator|&
operator|(
name|RQCS_SV
operator||
name|RQCS_RV
operator|)
operator|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ru_marked
operator|==
literal|0
operator|&&
name|sv_marked
operator|==
literal|0
operator|)
operator|||
operator|(
name|sp
operator|->
name|req_resid
operator|>
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
operator|)
condition|)
block|{
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOGWARN
argument_list|,
name|bun
argument_list|,
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|sp
operator|->
name|req_resid
argument_list|,
operator|(
name|ru_marked
operator|)
condition|?
literal|"marked"
else|:
literal|"not marked"
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|XS_SET_RESID
argument_list|(
name|xs
argument_list|,
name|sp
operator|->
name|req_resid
argument_list|)
expr_stmt|;
name|isp_xs_prt
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|ISP_LOG_WARN1
argument_list|,
literal|"Data Underrun (%d) for command 0x%x"
argument_list|,
name|sp
operator|->
name|req_resid
argument_list|,
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_PORT_UNAVAILABLE
case|:
comment|/* 		 * No such port on the loop. Moral equivalent of SELTIMEO 		 */
case|case
name|RQCS_PORT_LOGGED_OUT
case|:
block|{
specifier|const
name|char
modifier|*
name|reason
decl_stmt|;
name|uint8_t
name|sts
init|=
name|sp
operator|->
name|req_completion_status
operator|&
literal|0xff
decl_stmt|;
comment|/* 		 * It was there (maybe)- treat as a selection timeout. 		 */
if|if
condition|(
name|sts
operator|==
name|RQCS_PORT_UNAVAILABLE
condition|)
block|{
name|reason
operator|=
literal|"unavailable"
expr_stmt|;
block|}
else|else
block|{
name|reason
operator|=
literal|"logout"
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGINFO
argument_list|,
literal|"Chan %d port %s for target %d"
argument_list|,
name|chan
argument_list|,
name|reason
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * There is no MBOX_INIT_LIP for the 24XX. 		 */
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
case|case
name|RQCS_PORT_CHANGED
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"port changed for target %d chan %d"
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_24XX_ENOMEM
case|:
comment|/* f/w resource unavailable */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"f/w resource unavailable for target %d chan %d"
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
operator|*
name|XS_STSP
argument_list|(
name|xs
argument_list|)
operator|=
name|SCSI_BUSY
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_TGTBSY
argument_list|)
expr_stmt|;
block|}
return|return;
case|case
name|RQCS_24XX_TMO
case|:
comment|/* task management overrun */
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"command for target %d overlapped task management for chan %d"
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
operator|*
name|XS_STSP
argument_list|(
name|xs
argument_list|)
operator|=
name|SCSI_BUSY
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_TGTBSY
argument_list|)
expr_stmt|;
block|}
return|return;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Unknown Completion Status 0x%x on chan %d"
argument_list|,
name|sp
operator|->
name|req_completion_status
argument_list|,
name|chan
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_fastpost_complete
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint32_t
name|fph
parameter_list|)
block|{
name|XS_T
modifier|*
name|xs
decl_stmt|;
if|if
condition|(
name|fph
operator|==
literal|0
condition|)
block|{
return|return;
block|}
name|xs
operator|=
name|isp_find_xs
argument_list|(
name|isp
argument_list|,
name|fph
argument_list|)
expr_stmt|;
if|if
condition|(
name|xs
operator|==
name|NULL
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"Command for fast post handle 0x%x not found"
argument_list|,
name|fph
argument_list|)
expr_stmt|;
return|return;
block|}
name|isp_destroy_handle
argument_list|(
name|isp
argument_list|,
name|fph
argument_list|)
expr_stmt|;
comment|/* 	 * Since we don't have a result queue entry item, 	 * we must believe that SCSI status is zero and 	 * that all data transferred. 	 */
name|XS_SET_RESID
argument_list|(
name|xs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|XS_STSP
argument_list|(
name|xs
argument_list|)
operator|=
name|SCSI_GOOD
expr_stmt|;
if|if
condition|(
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|ISP_DMAFREE
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|fph
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_nactive
condition|)
block|{
name|isp
operator|->
name|isp_nactive
operator|--
expr_stmt|;
block|}
name|isp
operator|->
name|isp_fphccmplt
operator|++
expr_stmt|;
name|isp_done
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|isp_mbox_continue
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|uint16_t
modifier|*
name|ptr
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
switch|switch
condition|(
name|isp
operator|->
name|isp_lastmbxcmd
condition|)
block|{
case|case
name|MBOX_WRITE_RAM_WORD
case|:
case|case
name|MBOX_READ_RAM_WORD
case|:
case|case
name|MBOX_WRITE_RAM_WORD_EXTENDED
case|:
case|case
name|MBOX_READ_RAM_WORD_EXTENDED
case|:
break|break;
default|default:
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_mboxtmp
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp
operator|->
name|isp_mbxwrk0
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Clear the previous interrupt. 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_CLEAR_RISC_INT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_CLEAR_RISC_INT
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Continue with next word. 	 */
name|ISP_MEMZERO
argument_list|(
operator|&
name|mbs
argument_list|,
sizeof|sizeof
argument_list|(
name|mbs
argument_list|)
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|isp
operator|->
name|isp_mbxworkp
expr_stmt|;
switch|switch
condition|(
name|isp
operator|->
name|isp_lastmbxcmd
condition|)
block|{
case|case
name|MBOX_WRITE_RAM_WORD
case|:
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|isp
operator|->
name|isp_mbxwrk1
operator|++
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
break|break;
case|case
name|MBOX_READ_RAM_WORD
case|:
operator|*
name|ptr
operator|++
operator|=
name|isp
operator|->
name|isp_mboxtmp
index|[
literal|2
index|]
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|isp
operator|->
name|isp_mbxwrk1
operator|++
expr_stmt|;
break|break;
case|case
name|MBOX_WRITE_RAM_WORD_EXTENDED
case|:
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|uint32_t
modifier|*
name|lptr
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|ptr
decl_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|lptr
index|[
literal|0
index|]
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|lptr
index|[
literal|0
index|]
operator|>>
literal|16
expr_stmt|;
name|lptr
operator|++
expr_stmt|;
name|ptr
operator|=
operator|(
name|uint16_t
operator|*
operator|)
name|lptr
expr_stmt|;
block|}
else|else
block|{
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
block|}
name|offset
operator|=
name|isp
operator|->
name|isp_mbxwrk1
expr_stmt|;
name|offset
operator||=
name|isp
operator|->
name|isp_mbxwrk8
operator|<<
literal|16
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|offset
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|8
index|]
operator|=
name|offset
operator|>>
literal|16
expr_stmt|;
name|offset
operator|++
expr_stmt|;
name|isp
operator|->
name|isp_mbxwrk1
operator|=
name|offset
expr_stmt|;
name|isp
operator|->
name|isp_mbxwrk8
operator|=
name|offset
operator|>>
literal|16
expr_stmt|;
break|break;
case|case
name|MBOX_READ_RAM_WORD_EXTENDED
case|:
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|uint32_t
modifier|*
name|lptr
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|ptr
decl_stmt|;
name|uint32_t
name|val
init|=
name|isp
operator|->
name|isp_mboxtmp
index|[
literal|2
index|]
decl_stmt|;
name|val
operator||=
operator|(
name|isp
operator|->
name|isp_mboxtmp
index|[
literal|3
index|]
operator|)
operator|<<
literal|16
expr_stmt|;
operator|*
name|lptr
operator|++
operator|=
name|val
expr_stmt|;
name|ptr
operator|=
operator|(
name|uint16_t
operator|*
operator|)
name|lptr
expr_stmt|;
block|}
else|else
block|{
operator|*
name|ptr
operator|++
operator|=
name|isp
operator|->
name|isp_mboxtmp
index|[
literal|2
index|]
expr_stmt|;
block|}
name|offset
operator|=
name|isp
operator|->
name|isp_mbxwrk1
expr_stmt|;
name|offset
operator||=
name|isp
operator|->
name|isp_mbxwrk8
operator|<<
literal|16
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|offset
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|8
index|]
operator|=
name|offset
operator|>>
literal|16
expr_stmt|;
name|offset
operator|++
expr_stmt|;
name|isp
operator|->
name|isp_mbxwrk1
operator|=
name|offset
expr_stmt|;
name|isp
operator|->
name|isp_mbxwrk8
operator|=
name|offset
operator|>>
literal|16
expr_stmt|;
break|break;
block|}
name|isp
operator|->
name|isp_mbxworkp
operator|=
name|ptr
expr_stmt|;
name|isp
operator|->
name|isp_mbxwrk0
operator|--
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|isp
operator|->
name|isp_lastmbxcmd
expr_stmt|;
name|mbs
operator|.
name|logval
operator|=
name|MBLOGALL
expr_stmt|;
name|isp_mboxcmd_qnw
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ISP_SCSI_IBITS
parameter_list|(
name|op
parameter_list|)
value|(mbpscsi[((op)<<1)])
end_define

begin_define
define|#
directive|define
name|ISP_SCSI_OBITS
parameter_list|(
name|op
parameter_list|)
value|(mbpscsi[((op)<<1) + 1])
end_define

begin_define
define|#
directive|define
name|ISP_SCSI_OPMAP
parameter_list|(
name|in
parameter_list|,
name|out
parameter_list|)
value|in, out
end_define

begin_decl_stmt
specifier|static
specifier|const
name|uint8_t
name|mbpscsi
index|[]
init|=
block|{
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x00: MBOX_NO_OP */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x1f
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x01: MBOX_LOAD_RAM */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x02: MBOX_EXEC_FIRMWARE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x1f
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x03: MBOX_DUMP_RAM */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x04: MBOX_WRITE_RAM_WORD */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x05: MBOX_READ_RAM_WORD */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x3f
argument_list|,
literal|0x3f
argument_list|)
block|,
comment|/* 0x06: MBOX_MAILBOX_REG_TEST */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x07: MBOX_VERIFY_CHECKSUM	*/
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x0f
argument_list|)
block|,
comment|/* 0x08: MBOX_ABOUT_FIRMWARE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x09: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x0a: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x0b: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x0c: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x0d: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x05
argument_list|)
block|,
comment|/* 0x0e: MBOX_CHECK_FIRMWARE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x0f: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x1f
argument_list|,
literal|0x1f
argument_list|)
block|,
comment|/* 0x10: MBOX_INIT_REQ_QUEUE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x3f
argument_list|,
literal|0x3f
argument_list|)
block|,
comment|/* 0x11: MBOX_INIT_RES_QUEUE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x0f
argument_list|)
block|,
comment|/* 0x12: MBOX_EXECUTE_IOCB */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x13: MBOX_WAKE_UP	*/
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x3f
argument_list|)
block|,
comment|/* 0x14: MBOX_STOP_FIRMWARE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x0f
argument_list|)
block|,
comment|/* 0x15: MBOX_ABORT */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x16: MBOX_ABORT_DEVICE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x17: MBOX_ABORT_TARGET */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x18: MBOX_BUS_RESET */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x19: MBOX_STOP_QUEUE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x1a: MBOX_START_QUEUE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x1b: MBOX_SINGLE_STEP_QUEUE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x1c: MBOX_ABORT_QUEUE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x4f
argument_list|)
block|,
comment|/* 0x1d: MBOX_GET_DEV_QUEUE_STATUS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x1e: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x1f: MBOX_GET_FIRMWARE_STATUS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x20: MBOX_GET_INIT_SCSI_ID */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x21: MBOX_GET_SELECT_TIMEOUT */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0xc7
argument_list|)
block|,
comment|/* 0x22: MBOX_GET_RETRY_COUNT	*/
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x23: MBOX_GET_TAG_AGE_LIMIT */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x24: MBOX_GET_CLOCK_RATE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x25: MBOX_GET_ACT_NEG_STATE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x26: MBOX_GET_ASYNC_DATA_SETUP_TIME */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x27: MBOX_GET_PCI_PARAMS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x4f
argument_list|)
block|,
comment|/* 0x28: MBOX_GET_TARGET_PARAMS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x0f
argument_list|)
block|,
comment|/* 0x29: MBOX_GET_DEV_QUEUE_PARAMS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x2a: MBOX_GET_RESET_DELAY_PARAMS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2b: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2c: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2d: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2e: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2f: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x30: MBOX_SET_INIT_SCSI_ID */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x31: MBOX_SET_SELECT_TIMEOUT */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0xc7
argument_list|,
literal|0xc7
argument_list|)
block|,
comment|/* 0x32: MBOX_SET_RETRY_COUNT	*/
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x33: MBOX_SET_TAG_AGE_LIMIT */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x34: MBOX_SET_CLOCK_RATE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x35: MBOX_SET_ACT_NEG_STATE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x36: MBOX_SET_ASYNC_DATA_SETUP_TIME */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x37: MBOX_SET_PCI_CONTROL_PARAMS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x4f
argument_list|,
literal|0x4f
argument_list|)
block|,
comment|/* 0x38: MBOX_SET_TARGET_PARAMS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x0f
argument_list|)
block|,
comment|/* 0x39: MBOX_SET_DEV_QUEUE_PARAMS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x3a: MBOX_SET_RESET_DELAY_PARAMS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3b: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3c: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3d: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3e: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3f: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x40: MBOX_RETURN_BIOS_BLOCK_ADDR */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x3f
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x41: MBOX_WRITE_FOUR_RAM_WORDS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x42: MBOX_EXEC_BIOS_IOCB */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x43: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x44: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x45: SET SYSTEM PARAMETER */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x46: GET SYSTEM PARAMETER */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x47: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0xcf
argument_list|)
block|,
comment|/* 0x48: GET SCAM CONFIGURATION */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0xcf
argument_list|,
literal|0xcf
argument_list|)
block|,
comment|/* 0x49: SET SCAM CONFIGURATION */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x4a: MBOX_SET_FIRMWARE_FEATURES */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x4b: MBOX_GET_FIRMWARE_FEATURES */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x4c: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x4d: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x4e: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x4f: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0xdf
argument_list|,
literal|0xdf
argument_list|)
block|,
comment|/* 0x50: LOAD RAM A64 */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0xdf
argument_list|,
literal|0xdf
argument_list|)
block|,
comment|/* 0x51: DUMP RAM A64 */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0xdf
argument_list|,
literal|0xff
argument_list|)
block|,
comment|/* 0x52: INITIALIZE REQUEST QUEUE A64 */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0xef
argument_list|,
literal|0xff
argument_list|)
block|,
comment|/* 0x53: INITIALIZE RESPONSE QUEUE A64 */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0xcf
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x54: EXECUCUTE COMMAND IOCB A64 */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x55: ENABLE TARGET MODE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x0f
argument_list|)
block|,
comment|/* 0x56: GET TARGET STATUS */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x57: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x58: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x59: */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x5a: SET DATA OVERRUN RECOVERY MODE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x5b: GET DATA OVERRUN RECOVERY MODE */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x0f
argument_list|)
block|,
comment|/* 0x5c: SET HOST DATA */
name|ISP_SCSI_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x01
argument_list|)
comment|/* 0x5d: GET NOST DATA */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MAX_SCSI_OPCODE
value|0x5d
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|scsi_mbcmd_names
index|[]
init|=
block|{
literal|"NO-OP"
block|,
literal|"LOAD RAM"
block|,
literal|"EXEC FIRMWARE"
block|,
literal|"DUMP RAM"
block|,
literal|"WRITE RAM WORD"
block|,
literal|"READ RAM WORD"
block|,
literal|"MAILBOX REG TEST"
block|,
literal|"VERIFY CHECKSUM"
block|,
literal|"ABOUT FIRMWARE"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"CHECK FIRMWARE"
block|,
name|NULL
block|,
literal|"INIT REQUEST QUEUE"
block|,
literal|"INIT RESULT QUEUE"
block|,
literal|"EXECUTE IOCB"
block|,
literal|"WAKE UP"
block|,
literal|"STOP FIRMWARE"
block|,
literal|"ABORT"
block|,
literal|"ABORT DEVICE"
block|,
literal|"ABORT TARGET"
block|,
literal|"BUS RESET"
block|,
literal|"STOP QUEUE"
block|,
literal|"START QUEUE"
block|,
literal|"SINGLE STEP QUEUE"
block|,
literal|"ABORT QUEUE"
block|,
literal|"GET DEV QUEUE STATUS"
block|,
name|NULL
block|,
literal|"GET FIRMWARE STATUS"
block|,
literal|"GET INIT SCSI ID"
block|,
literal|"GET SELECT TIMEOUT"
block|,
literal|"GET RETRY COUNT"
block|,
literal|"GET TAG AGE LIMIT"
block|,
literal|"GET CLOCK RATE"
block|,
literal|"GET ACT NEG STATE"
block|,
literal|"GET ASYNC DATA SETUP TIME"
block|,
literal|"GET PCI PARAMS"
block|,
literal|"GET TARGET PARAMS"
block|,
literal|"GET DEV QUEUE PARAMS"
block|,
literal|"GET RESET DELAY PARAMS"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"SET INIT SCSI ID"
block|,
literal|"SET SELECT TIMEOUT"
block|,
literal|"SET RETRY COUNT"
block|,
literal|"SET TAG AGE LIMIT"
block|,
literal|"SET CLOCK RATE"
block|,
literal|"SET ACT NEG STATE"
block|,
literal|"SET ASYNC DATA SETUP TIME"
block|,
literal|"SET PCI CONTROL PARAMS"
block|,
literal|"SET TARGET PARAMS"
block|,
literal|"SET DEV QUEUE PARAMS"
block|,
literal|"SET RESET DELAY PARAMS"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"RETURN BIOS BLOCK ADDR"
block|,
literal|"WRITE FOUR RAM WORDS"
block|,
literal|"EXEC BIOS IOCB"
block|,
name|NULL
block|,
name|NULL
block|,
literal|"SET SYSTEM PARAMETER"
block|,
literal|"GET SYSTEM PARAMETER"
block|,
name|NULL
block|,
literal|"GET SCAM CONFIGURATION"
block|,
literal|"SET SCAM CONFIGURATION"
block|,
literal|"SET FIRMWARE FEATURES"
block|,
literal|"GET FIRMWARE FEATURES"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"LOAD RAM A64"
block|,
literal|"DUMP RAM A64"
block|,
literal|"INITIALIZE REQUEST QUEUE A64"
block|,
literal|"INITIALIZE RESPONSE QUEUE A64"
block|,
literal|"EXECUTE IOCB A64"
block|,
literal|"ENABLE TARGET MODE"
block|,
literal|"GET TARGET MODE STATE"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"SET DATA OVERRUN RECOVERY MODE"
block|,
literal|"GET DATA OVERRUN RECOVERY MODE"
block|,
literal|"SET HOST DATA"
block|,
literal|"GET NOST DATA"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ISP_FC_IBITS
parameter_list|(
name|op
parameter_list|)
value|((mbpfc[((op)<<3) + 0]<< 24) | (mbpfc[((op)<<3) + 1]<< 16) | (mbpfc[((op)<<3) + 2]<< 8) | (mbpfc[((op)<<3) + 3]))
end_define

begin_define
define|#
directive|define
name|ISP_FC_OBITS
parameter_list|(
name|op
parameter_list|)
value|((mbpfc[((op)<<3) + 4]<< 24) | (mbpfc[((op)<<3) + 5]<< 16) | (mbpfc[((op)<<3) + 6]<< 8) | (mbpfc[((op)<<3) + 7]))
end_define

begin_define
define|#
directive|define
name|ISP_FC_OPMAP
parameter_list|(
name|in0
parameter_list|,
name|out0
parameter_list|)
value|0,   0,   0, in0,    0,    0,    0, out0
end_define

begin_define
define|#
directive|define
name|ISP_FC_OPMAP_HALF
parameter_list|(
name|in1
parameter_list|,
name|in0
parameter_list|,
name|out1
parameter_list|,
name|out0
parameter_list|)
value|0,   0, in1, in0,    0,    0, out1, out0
end_define

begin_define
define|#
directive|define
name|ISP_FC_OPMAP_FULL
parameter_list|(
name|in3
parameter_list|,
name|in2
parameter_list|,
name|in1
parameter_list|,
name|in0
parameter_list|,
name|out3
parameter_list|,
name|out2
parameter_list|,
name|out1
parameter_list|,
name|out0
parameter_list|)
value|in3, in2, in1, in0, out3, out2, out1, out0
end_define

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|mbpfc
index|[]
init|=
block|{
name|ISP_FC_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x00: MBOX_NO_OP */
name|ISP_FC_OPMAP
argument_list|(
literal|0x1f
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x01: MBOX_LOAD_RAM */
name|ISP_FC_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x02: MBOX_EXEC_FIRMWARE */
name|ISP_FC_OPMAP
argument_list|(
literal|0xdf
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x03: MBOX_DUMP_RAM */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x04: MBOX_WRITE_RAM_WORD */
name|ISP_FC_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x05: MBOX_READ_RAM_WORD */
name|ISP_FC_OPMAP_FULL
argument_list|(
literal|0xff
argument_list|,
literal|0xff
argument_list|,
literal|0xff
argument_list|,
literal|0xff
argument_list|,
literal|0xff
argument_list|,
literal|0xff
argument_list|,
literal|0xff
argument_list|,
literal|0xff
argument_list|)
block|,
comment|/* 0x06: MBOX_MAILBOX_REG_TEST */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x07: MBOX_VERIFY_CHECKSUM	*/
name|ISP_FC_OPMAP_FULL
argument_list|(
literal|0x0
argument_list|,
literal|0x0
argument_list|,
literal|0x0
argument_list|,
literal|0x01
argument_list|,
literal|0x0
argument_list|,
literal|0x3
argument_list|,
literal|0x80
argument_list|,
literal|0x7f
argument_list|)
block|,
comment|/* 0x08: MBOX_ABOUT_FIRMWARE */
name|ISP_FC_OPMAP
argument_list|(
literal|0xdf
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x09: MBOX_LOAD_RISC_RAM_2100 */
name|ISP_FC_OPMAP
argument_list|(
literal|0xdf
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x0a: DUMP RAM */
name|ISP_FC_OPMAP_HALF
argument_list|(
literal|0x1
argument_list|,
literal|0xff
argument_list|,
literal|0x0
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x0b: MBOX_LOAD_RISC_RAM */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x0c: */
name|ISP_FC_OPMAP_HALF
argument_list|(
literal|0x1
argument_list|,
literal|0x0f
argument_list|,
literal|0x0
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x0d: MBOX_WRITE_RAM_WORD_EXTENDED */
name|ISP_FC_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x05
argument_list|)
block|,
comment|/* 0x0e: MBOX_CHECK_FIRMWARE */
name|ISP_FC_OPMAP_HALF
argument_list|(
literal|0x1
argument_list|,
literal|0x03
argument_list|,
literal|0x0
argument_list|,
literal|0x0d
argument_list|)
block|,
comment|/* 0x0f: MBOX_READ_RAM_WORD_EXTENDED */
name|ISP_FC_OPMAP
argument_list|(
literal|0x1f
argument_list|,
literal|0x11
argument_list|)
block|,
comment|/* 0x10: MBOX_INIT_REQ_QUEUE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x2f
argument_list|,
literal|0x21
argument_list|)
block|,
comment|/* 0x11: MBOX_INIT_RES_QUEUE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x12: MBOX_EXECUTE_IOCB */
name|ISP_FC_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x13: MBOX_WAKE_UP	*/
name|ISP_FC_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0xff
argument_list|)
block|,
comment|/* 0x14: MBOX_STOP_FIRMWARE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x4f
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x15: MBOX_ABORT */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x16: MBOX_ABORT_DEVICE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x17: MBOX_ABORT_TARGET */
name|ISP_FC_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x18: MBOX_BUS_RESET */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x05
argument_list|)
block|,
comment|/* 0x19: MBOX_STOP_QUEUE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x05
argument_list|)
block|,
comment|/* 0x1a: MBOX_START_QUEUE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x05
argument_list|)
block|,
comment|/* 0x1b: MBOX_SINGLE_STEP_QUEUE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x05
argument_list|)
block|,
comment|/* 0x1c: MBOX_ABORT_QUEUE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x1d: MBOX_GET_DEV_QUEUE_STATUS */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x1e: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x1f: MBOX_GET_FIRMWARE_STATUS */
name|ISP_FC_OPMAP_HALF
argument_list|(
literal|0x2
argument_list|,
literal|0x01
argument_list|,
literal|0x0
argument_list|,
literal|0xcf
argument_list|)
block|,
comment|/* 0x20: MBOX_GET_LOOP_ID */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x21: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x22: MBOX_GET_RETRY_COUNT	*/
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x23: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x24: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x25: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x26: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x27: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x28: MBOX_GET_FIRMWARE_OPTIONS */
name|ISP_FC_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x29: MBOX_GET_PORT_QUEUE_PARAMS */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2a: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2b: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2c: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2d: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2e: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x2f: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x30: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x31: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x32: MBOX_SET_RETRY_COUNT	*/
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x33: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x34: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x35: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x36: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x37: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x38: MBOX_SET_FIRMWARE_OPTIONS */
name|ISP_FC_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x39: MBOX_SET_PORT_QUEUE_PARAMS */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3a: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3b: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3c: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3d: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3e: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x3f: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x40: MBOX_LOOP_PORT_BYPASS */
name|ISP_FC_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x41: MBOX_LOOP_PORT_ENABLE */
name|ISP_FC_OPMAP_HALF
argument_list|(
literal|0x0
argument_list|,
literal|0x01
argument_list|,
literal|0x3
argument_list|,
literal|0xcf
argument_list|)
block|,
comment|/* 0x42: MBOX_GET_RESOURCE_COUNT */
name|ISP_FC_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x43: MBOX_REQUEST_OFFLINE_MODE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x44: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x45: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x46: */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcf
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x47: GET PORT_DATABASE ENHANCED */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcd
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x48: MBOX_INIT_FIRMWARE_MULTI_ID */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcd
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x49: MBOX_GET_VP_DATABASE */
name|ISP_FC_OPMAP_HALF
argument_list|(
literal|0x2
argument_list|,
literal|0xcd
argument_list|,
literal|0x0
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x4a: MBOX_GET_VP_DATABASE_ENTRY */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x4b: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x4c: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x4d: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x4e: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x4f: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x50: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x51: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x52: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x53: */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcf
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x54: EXECUTE IOCB A64 */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x55: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x56: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x57: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x58: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x59: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x5a: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x5b: MBOX_DRIVER_HEARTBEAT */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcf
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x5c: MBOX_FW_HEARTBEAT */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x5d: MBOX_GET_SET_DATA_RATE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x5e: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x5f: */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcd
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x60: MBOX_INIT_FIRMWARE */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x61: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x62: MBOX_INIT_LIP */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcd
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x63: MBOX_GET_FC_AL_POSITION_MAP */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcf
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x64: MBOX_GET_PORT_DB */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x65: MBOX_CLEAR_ACA */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x66: MBOX_TARGET_RESET */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x67: MBOX_CLEAR_TASK_SET */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x68: MBOX_ABORT_TASK_SET */
name|ISP_FC_OPMAP
argument_list|(
literal|0x01
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x69: MBOX_GET_FW_STATE */
name|ISP_FC_OPMAP_HALF
argument_list|(
literal|0x6
argument_list|,
literal|0x03
argument_list|,
literal|0x0
argument_list|,
literal|0xcf
argument_list|)
block|,
comment|/* 0x6a: MBOX_GET_PORT_NAME */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcf
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x6b: MBOX_GET_LINK_STATUS */
name|ISP_FC_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x6c: MBOX_INIT_LIP_RESET */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x6d: */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcf
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x6e: MBOX_SEND_SNS */
name|ISP_FC_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x07
argument_list|)
block|,
comment|/* 0x6f: MBOX_FABRIC_LOGIN */
name|ISP_FC_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x70: MBOX_SEND_CHANGE_REQUEST */
name|ISP_FC_OPMAP
argument_list|(
literal|0x03
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x71: MBOX_FABRIC_LOGOUT */
name|ISP_FC_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x0f
argument_list|)
block|,
comment|/* 0x72: MBOX_INIT_LIP_LOGIN */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x73: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x07
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x74: LOGIN LOOP PORT */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcf
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x75: GET PORT/NODE NAME LIST */
name|ISP_FC_OPMAP
argument_list|(
literal|0x4f
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x76: SET VENDOR ID */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcd
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x77: INITIALIZE IP MAILBOX */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x78: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x79: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x7a: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|)
block|,
comment|/* 0x7b: */
name|ISP_FC_OPMAP
argument_list|(
literal|0x4f
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* 0x7c: Get ID List */
name|ISP_FC_OPMAP
argument_list|(
literal|0xcf
argument_list|,
literal|0x01
argument_list|)
block|,
comment|/* 0x7d: SEND LFA */
name|ISP_FC_OPMAP
argument_list|(
literal|0x0f
argument_list|,
literal|0x01
argument_list|)
comment|/* 0x7e: LUN RESET */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MAX_FC_OPCODE
value|0x7e
end_define

begin_comment
comment|/*  * Footnotes  *  * (1): this sets bits 21..16 in mailbox register #8, which we nominally  *	do not access at this time in the core driver. The caller is  *	responsible for setting this register first (Gross!). The assumption  *	is that we won't overflow.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|fc_mbcmd_names
index|[]
init|=
block|{
literal|"NO-OP"
block|,
literal|"LOAD RAM"
block|,
literal|"EXEC FIRMWARE"
block|,
literal|"DUMP RAM"
block|,
literal|"WRITE RAM WORD"
block|,
literal|"READ RAM WORD"
block|,
literal|"MAILBOX REG TEST"
block|,
literal|"VERIFY CHECKSUM"
block|,
literal|"ABOUT FIRMWARE"
block|,
literal|"LOAD RAM (2100)"
block|,
literal|"DUMP RAM"
block|,
literal|"LOAD RISC RAM"
block|,
name|NULL
block|,
literal|"WRITE RAM WORD EXTENDED"
block|,
literal|"CHECK FIRMWARE"
block|,
literal|"READ RAM WORD EXTENDED"
block|,
literal|"INIT REQUEST QUEUE"
block|,
literal|"INIT RESULT QUEUE"
block|,
literal|"EXECUTE IOCB"
block|,
literal|"WAKE UP"
block|,
literal|"STOP FIRMWARE"
block|,
literal|"ABORT"
block|,
literal|"ABORT DEVICE"
block|,
literal|"ABORT TARGET"
block|,
literal|"BUS RESET"
block|,
literal|"STOP QUEUE"
block|,
literal|"START QUEUE"
block|,
literal|"SINGLE STEP QUEUE"
block|,
literal|"ABORT QUEUE"
block|,
literal|"GET DEV QUEUE STATUS"
block|,
name|NULL
block|,
literal|"GET FIRMWARE STATUS"
block|,
literal|"GET LOOP ID"
block|,
name|NULL
block|,
literal|"GET RETRY COUNT"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"GET FIRMWARE OPTIONS"
block|,
literal|"GET PORT QUEUE PARAMS"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"SET RETRY COUNT"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"SET FIRMWARE OPTIONS"
block|,
literal|"SET PORT QUEUE PARAMS"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"LOOP PORT BYPASS"
block|,
literal|"LOOP PORT ENABLE"
block|,
literal|"GET RESOURCE COUNT"
block|,
literal|"REQUEST NON PARTICIPATING MODE"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"GET PORT DATABASE ENHANCED"
block|,
literal|"INIT FIRMWARE MULTI ID"
block|,
literal|"GET VP DATABASE"
block|,
literal|"GET VP DATABASE ENTRY"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"EXECUTE IOCB A64"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"DRIVER HEARTBEAT"
block|,
name|NULL
block|,
literal|"GET/SET DATA RATE"
block|,
name|NULL
block|,
name|NULL
block|,
literal|"INIT FIRMWARE"
block|,
name|NULL
block|,
literal|"INIT LIP"
block|,
literal|"GET FC-AL POSITION MAP"
block|,
literal|"GET PORT DATABASE"
block|,
literal|"CLEAR ACA"
block|,
literal|"TARGET RESET"
block|,
literal|"CLEAR TASK SET"
block|,
literal|"ABORT TASK SET"
block|,
literal|"GET FW STATE"
block|,
literal|"GET PORT NAME"
block|,
literal|"GET LINK STATUS"
block|,
literal|"INIT LIP RESET"
block|,
name|NULL
block|,
literal|"SEND SNS"
block|,
literal|"FABRIC LOGIN"
block|,
literal|"SEND CHANGE REQUEST"
block|,
literal|"FABRIC LOGOUT"
block|,
literal|"INIT LIP LOGIN"
block|,
name|NULL
block|,
literal|"LOGIN LOOP PORT"
block|,
literal|"GET PORT/NODE NAME LIST"
block|,
literal|"SET VENDOR ID"
block|,
literal|"INITIALIZE IP MAILBOX"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"Get ID List"
block|,
literal|"SEND LFA"
block|,
literal|"Lun RESET"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|isp_mboxcmd_qnw
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|mbreg_t
modifier|*
name|mbp
parameter_list|,
name|int
name|nodelay
parameter_list|)
block|{
name|unsigned
name|int
name|ibits
decl_stmt|,
name|obits
decl_stmt|,
name|box
decl_stmt|,
name|opcode
decl_stmt|;
name|opcode
operator|=
name|mbp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ibits
operator|=
name|ISP_FC_IBITS
argument_list|(
name|opcode
argument_list|)
expr_stmt|;
name|obits
operator|=
name|ISP_FC_OBITS
argument_list|(
name|opcode
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ibits
operator|=
name|ISP_SCSI_IBITS
argument_list|(
name|opcode
argument_list|)
expr_stmt|;
name|obits
operator|=
name|ISP_SCSI_OBITS
argument_list|(
name|opcode
argument_list|)
expr_stmt|;
block|}
name|ibits
operator||=
name|mbp
operator|->
name|ibits
expr_stmt|;
name|obits
operator||=
name|mbp
operator|->
name|obits
expr_stmt|;
for|for
control|(
name|box
operator|=
literal|0
init|;
name|box
operator|<
name|ISP_NMBOX
argument_list|(
name|isp
argument_list|)
condition|;
name|box
operator|++
control|)
block|{
if|if
condition|(
name|ibits
operator|&
operator|(
literal|1
operator|<<
name|box
operator|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|MBOX_OFF
argument_list|(
name|box
argument_list|)
argument_list|,
name|mbp
operator|->
name|param
index|[
name|box
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nodelay
operator|==
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_mboxtmp
index|[
name|box
index|]
operator|=
name|mbp
operator|->
name|param
index|[
name|box
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nodelay
operator|==
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_lastmbxcmd
operator|=
name|opcode
expr_stmt|;
name|isp
operator|->
name|isp_obits
operator|=
name|obits
expr_stmt|;
name|isp
operator|->
name|isp_mboxbsy
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_SET_HOST_INT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_SET_HOST_INT
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Oddly enough, if we're not delaying for an answer, 	 * delay a bit to give the f/w a chance to pick up the 	 * command. 	 */
if|if
condition|(
name|nodelay
condition|)
block|{
name|ISP_DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_mboxcmd
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|mbreg_t
modifier|*
name|mbp
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cname
decl_stmt|,
modifier|*
name|xname
decl_stmt|;
name|char
name|tname
index|[
literal|16
index|]
decl_stmt|,
name|mname
index|[
literal|16
index|]
decl_stmt|;
name|unsigned
name|int
name|ibits
decl_stmt|,
name|obits
decl_stmt|,
name|box
decl_stmt|,
name|opcode
decl_stmt|;
name|opcode
operator|=
name|mbp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|opcode
operator|>
name|MAX_FC_OPCODE
condition|)
block|{
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_INVALID_COMMAND
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Unknown Command 0x%x"
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
return|return;
block|}
name|ibits
operator|=
name|ISP_FC_IBITS
argument_list|(
name|opcode
argument_list|)
expr_stmt|;
name|obits
operator|=
name|ISP_FC_OBITS
argument_list|(
name|opcode
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|opcode
operator|>
name|MAX_SCSI_OPCODE
condition|)
block|{
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_INVALID_COMMAND
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Unknown Command 0x%x"
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
return|return;
block|}
name|ibits
operator|=
name|ISP_SCSI_IBITS
argument_list|(
name|opcode
argument_list|)
expr_stmt|;
name|obits
operator|=
name|ISP_SCSI_OBITS
argument_list|(
name|opcode
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Pick up any additional bits that the caller might have set. 	 */
name|ibits
operator||=
name|mbp
operator|->
name|ibits
expr_stmt|;
name|obits
operator||=
name|mbp
operator|->
name|obits
expr_stmt|;
comment|/* 	 * Mask any bits that the caller wants us to mask 	 */
name|ibits
operator|&=
name|mbp
operator|->
name|ibitm
expr_stmt|;
name|obits
operator|&=
name|mbp
operator|->
name|obitm
expr_stmt|;
if|if
condition|(
name|ibits
operator|==
literal|0
operator|&&
name|obits
operator|==
literal|0
condition|)
block|{
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_COMMAND_PARAM_ERROR
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"no parameters for 0x%x"
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Get exclusive usage of mailbox registers. 	 */
if|if
condition|(
name|MBOX_ACQUIRE
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_REGS_BUSY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|box
operator|=
literal|0
init|;
name|box
operator|<
name|ISP_NMBOX
argument_list|(
name|isp
argument_list|)
condition|;
name|box
operator|++
control|)
block|{
if|if
condition|(
name|ibits
operator|&
operator|(
literal|1
operator|<<
name|box
operator|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG3
argument_list|,
literal|"IN mbox %d = 0x%04x"
argument_list|,
name|box
argument_list|,
name|mbp
operator|->
name|param
index|[
name|box
index|]
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|MBOX_OFF
argument_list|(
name|box
argument_list|)
argument_list|,
name|mbp
operator|->
name|param
index|[
name|box
index|]
argument_list|)
expr_stmt|;
block|}
name|isp
operator|->
name|isp_mboxtmp
index|[
name|box
index|]
operator|=
name|mbp
operator|->
name|param
index|[
name|box
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|isp
operator|->
name|isp_lastmbxcmd
operator|=
name|opcode
expr_stmt|;
comment|/* 	 * We assume that we can't overwrite a previous command. 	 */
name|isp
operator|->
name|isp_obits
operator|=
name|obits
expr_stmt|;
name|isp
operator|->
name|isp_mboxbsy
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Set Host Interrupt condition so that RISC will pick up mailbox regs. 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_SET_HOST_INT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_SET_HOST_INT
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * While we haven't finished the command, spin our wheels here. 	 */
name|MBOX_WAIT_COMPLETE
argument_list|(
name|isp
argument_list|,
name|mbp
argument_list|)
expr_stmt|;
comment|/* 	 * Did the command time out? 	 */
if|if
condition|(
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|==
name|MBOX_TIMEOUT
condition|)
block|{
name|isp
operator|->
name|isp_mboxbsy
operator|=
literal|0
expr_stmt|;
name|MBOX_RELEASE
argument_list|(
name|isp
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Copy back output registers. 	 */
for|for
control|(
name|box
operator|=
literal|0
init|;
name|box
operator|<
name|ISP_NMBOX
argument_list|(
name|isp
argument_list|)
condition|;
name|box
operator|++
control|)
block|{
if|if
condition|(
name|obits
operator|&
operator|(
literal|1
operator|<<
name|box
operator|)
condition|)
block|{
name|mbp
operator|->
name|param
index|[
name|box
index|]
operator|=
name|isp
operator|->
name|isp_mboxtmp
index|[
name|box
index|]
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG3
argument_list|,
literal|"OUT mbox %d = 0x%04x"
argument_list|,
name|box
argument_list|,
name|mbp
operator|->
name|param
index|[
name|box
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|isp
operator|->
name|isp_mboxbsy
operator|=
literal|0
expr_stmt|;
name|MBOX_RELEASE
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|mbp
operator|->
name|logval
operator|==
literal|0
operator|||
name|opcode
operator|==
name|MBOX_EXEC_FIRMWARE
condition|)
block|{
return|return;
block|}
name|cname
operator|=
operator|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
operator|)
condition|?
name|fc_mbcmd_names
index|[
name|opcode
index|]
else|:
name|scsi_mbcmd_names
index|[
name|opcode
index|]
expr_stmt|;
if|if
condition|(
name|cname
operator|==
name|NULL
condition|)
block|{
name|cname
operator|=
name|tname
expr_stmt|;
name|ISP_SNPRINTF
argument_list|(
name|tname
argument_list|,
sizeof|sizeof
name|tname
argument_list|,
literal|"opcode %x"
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Just to be chatty here... 	 */
name|xname
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|mbp
operator|->
name|param
index|[
literal|0
index|]
condition|)
block|{
case|case
name|MBOX_COMMAND_COMPLETE
case|:
break|break;
case|case
name|MBOX_INVALID_COMMAND
case|:
if|if
condition|(
name|mbp
operator|->
name|logval
operator|&
name|MBLOGMASK
argument_list|(
name|MBOX_COMMAND_COMPLETE
argument_list|)
condition|)
block|{
name|xname
operator|=
literal|"INVALID COMMAND"
expr_stmt|;
block|}
break|break;
case|case
name|MBOX_HOST_INTERFACE_ERROR
case|:
if|if
condition|(
name|mbp
operator|->
name|logval
operator|&
name|MBLOGMASK
argument_list|(
name|MBOX_HOST_INTERFACE_ERROR
argument_list|)
condition|)
block|{
name|xname
operator|=
literal|"HOST INTERFACE ERROR"
expr_stmt|;
block|}
break|break;
case|case
name|MBOX_TEST_FAILED
case|:
if|if
condition|(
name|mbp
operator|->
name|logval
operator|&
name|MBLOGMASK
argument_list|(
name|MBOX_TEST_FAILED
argument_list|)
condition|)
block|{
name|xname
operator|=
literal|"TEST FAILED"
expr_stmt|;
block|}
break|break;
case|case
name|MBOX_COMMAND_ERROR
case|:
if|if
condition|(
name|mbp
operator|->
name|logval
operator|&
name|MBLOGMASK
argument_list|(
name|MBOX_COMMAND_ERROR
argument_list|)
condition|)
block|{
name|xname
operator|=
literal|"COMMAND ERROR"
expr_stmt|;
block|}
break|break;
case|case
name|MBOX_COMMAND_PARAM_ERROR
case|:
if|if
condition|(
name|mbp
operator|->
name|logval
operator|&
name|MBLOGMASK
argument_list|(
name|MBOX_COMMAND_PARAM_ERROR
argument_list|)
condition|)
block|{
name|xname
operator|=
literal|"COMMAND PARAMETER ERROR"
expr_stmt|;
block|}
break|break;
case|case
name|MBOX_LOOP_ID_USED
case|:
if|if
condition|(
name|mbp
operator|->
name|logval
operator|&
name|MBLOGMASK
argument_list|(
name|MBOX_LOOP_ID_USED
argument_list|)
condition|)
block|{
name|xname
operator|=
literal|"LOOP ID ALREADY IN USE"
expr_stmt|;
block|}
break|break;
case|case
name|MBOX_PORT_ID_USED
case|:
if|if
condition|(
name|mbp
operator|->
name|logval
operator|&
name|MBLOGMASK
argument_list|(
name|MBOX_PORT_ID_USED
argument_list|)
condition|)
block|{
name|xname
operator|=
literal|"PORT ID ALREADY IN USE"
expr_stmt|;
block|}
break|break;
case|case
name|MBOX_ALL_IDS_USED
case|:
if|if
condition|(
name|mbp
operator|->
name|logval
operator|&
name|MBLOGMASK
argument_list|(
name|MBOX_ALL_IDS_USED
argument_list|)
condition|)
block|{
name|xname
operator|=
literal|"ALL LOOP IDS IN USE"
expr_stmt|;
block|}
break|break;
case|case
name|MBOX_REGS_BUSY
case|:
name|xname
operator|=
literal|"REGISTERS BUSY"
expr_stmt|;
break|break;
case|case
name|MBOX_TIMEOUT
case|:
name|xname
operator|=
literal|"TIMEOUT"
expr_stmt|;
break|break;
default|default:
name|ISP_SNPRINTF
argument_list|(
name|mname
argument_list|,
sizeof|sizeof
name|mname
argument_list|,
literal|"error 0x%x"
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|xname
operator|=
name|mname
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|xname
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGALL
argument_list|,
literal|"Mailbox Command '%s' failed (%s)"
argument_list|,
name|cname
argument_list|,
name|xname
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_fw_state
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_GET_FW_STATE
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|==
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|fcp
operator|->
name|isp_fwstate
operator|=
name|mbs
operator|.
name|param
index|[
literal|1
index|]
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_spi_update
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|int
name|tgt
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
name|sdparam
modifier|*
name|sdp
decl_stmt|;
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* 		 * There are no 'per-bus' settings for Fibre Channel. 		 */
return|return;
block|}
name|sdp
operator|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|update
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|tgt
operator|=
literal|0
init|;
name|tgt
operator|<
name|MAX_TARGETS
condition|;
name|tgt
operator|++
control|)
block|{
name|uint16_t
name|flags
decl_stmt|,
name|period
decl_stmt|,
name|offset
decl_stmt|;
name|int
name|get
decl_stmt|;
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_enable
operator|==
literal|0
condition|)
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_update
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_refresh
operator|=
literal|0
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"skipping target %d bus %d update"
argument_list|,
name|tgt
argument_list|,
name|chan
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * If the goal is to update the status of the device, 		 * take what's in goal_flags and try and set the device 		 * toward that. Otherwise, if we're just refreshing the 		 * current device state, get the current parameters. 		 */
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
literal|0
argument_list|,
name|MBLOGALL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 		 * Refresh overrides set 		 */
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_refresh
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_GET_TARGET_PARAMS
expr_stmt|;
name|get
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_update
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_TARGET_PARAMS
expr_stmt|;
comment|/* 			 * Make sure goal_flags has "Renegotiate on Error" 			 * on and "Freeze Queue on Error" off. 			 */
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_flags
operator||=
name|DPARM_RENEG
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_flags
operator|&=
operator|~
name|DPARM_QFRZ
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_flags
expr_stmt|;
comment|/* 			 * Insist that PARITY must be enabled 			 * if SYNC or WIDE is enabled. 			 */
if|if
condition|(
operator|(
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|&
operator|(
name|DPARM_SYNC
operator||
name|DPARM_WIDE
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator||=
name|DPARM_PARITY
expr_stmt|;
block|}
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|&
name|DPARM_SYNC
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
operator|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_offset
operator|<<
literal|8
operator|)
operator||
operator|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_period
operator|)
expr_stmt|;
block|}
comment|/* 			 * A command completion later that has 			 * RQSTF_NEGOTIATION set can cause 			 * the dev_refresh/announce cycle also. 			 * 			 * Note: It is really important to update our current 			 * flags with at least the state of TAG capabilities- 			 * otherwise we might try and send a tagged command 			 * when we have it all turned off. So change it here 			 * to say that current already matches goal. 			 */
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_flags
operator|&=
operator|~
name|DPARM_TQING
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_flags
operator||=
operator|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_flags
operator|&
name|DPARM_TQING
operator|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"bus %d set tgt %d flags 0x%x off 0x%x period 0x%x"
argument_list|,
name|chan
argument_list|,
name|tgt
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|2
index|]
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|>>
literal|8
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|get
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
continue|continue;
block|}
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|chan
operator|<<
literal|15
operator|)
operator||
operator|(
name|tgt
operator|<<
literal|8
operator|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|get
operator|==
literal|0
condition|)
block|{
name|sdp
operator|->
name|sendmarker
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_update
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_refresh
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_refresh
operator|=
literal|0
expr_stmt|;
name|flags
operator|=
name|mbs
operator|.
name|param
index|[
literal|2
index|]
expr_stmt|;
name|period
operator|=
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|&
literal|0xff
expr_stmt|;
name|offset
operator|=
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|>>
literal|8
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_flags
operator|=
name|flags
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_period
operator|=
name|period
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_offset
operator|=
name|offset
expr_stmt|;
name|isp_async
argument_list|(
name|isp
argument_list|,
name|ISPASYNC_NEW_TGT_PARAMS
argument_list|,
name|chan
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|tgt
operator|=
literal|0
init|;
name|tgt
operator|<
name|MAX_TARGETS
condition|;
name|tgt
operator|++
control|)
block|{
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_update
operator|||
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_refresh
condition|)
block|{
name|sdp
operator|->
name|update
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_setdfltsdparm
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|)
block|{
name|int
name|tgt
decl_stmt|;
name|sdparam
modifier|*
name|sdp
decl_stmt|,
modifier|*
name|sdp1
decl_stmt|;
name|sdp
operator|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|role
operator|=
name|GET_DEFAULT_ROLE
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_DUALBUS
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|sdp1
operator|=
name|sdp
operator|+
literal|1
expr_stmt|;
name|sdp1
operator|->
name|role
operator|=
name|GET_DEFAULT_ROLE
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sdp1
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* 	 * Establish some default parameters. 	 */
name|sdp
operator|->
name|isp_cmd_dma_burst_enable
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_data_dma_burst_enabl
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|isp_fifo_threshold
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_initiator_id
operator|=
name|DEFAULT_IID
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|>=
name|ISP_HA_SCSI_1040
condition|)
block|{
name|sdp
operator|->
name|isp_async_data_setup
operator|=
literal|9
expr_stmt|;
block|}
else|else
block|{
name|sdp
operator|->
name|isp_async_data_setup
operator|=
literal|6
expr_stmt|;
block|}
name|sdp
operator|->
name|isp_selection_timeout
operator|=
literal|250
expr_stmt|;
name|sdp
operator|->
name|isp_max_queue_depth
operator|=
name|MAXISPREQUEST
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_tag_aging
operator|=
literal|8
expr_stmt|;
name|sdp
operator|->
name|isp_bus_reset_delay
operator|=
literal|5
expr_stmt|;
comment|/* 	 * Don't retry selection, busy or queue full automatically- reflect 	 * these back to us. 	 */
name|sdp
operator|->
name|isp_retry_count
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_retry_delay
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|tgt
operator|=
literal|0
init|;
name|tgt
operator|<
name|MAX_TARGETS
condition|;
name|tgt
operator|++
control|)
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|exc_throttle
operator|=
name|ISP_EXEC_THROTTLE
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_enable
operator|=
literal|1
expr_stmt|;
block|}
comment|/* 	 * The trick here is to establish a default for the default (honk!) 	 * state (goal_flags). Then try and get the current status from 	 * the card to fill in the current state. We don't, in fact, set 	 * the default to the SAFE default state- that's not the goal state. 	 */
for|for
control|(
name|tgt
operator|=
literal|0
init|;
name|tgt
operator|<
name|MAX_TARGETS
condition|;
name|tgt
operator|++
control|)
block|{
name|uint8_t
name|off
decl_stmt|,
name|per
decl_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_offset
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_period
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_flags
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_flags
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator|=
name|DPARM_DEFAULT
expr_stmt|;
comment|/* 		 * We default to Wide/Fast for versions less than a 1040 		 * (unless it's SBus). 		 */
if|if
condition|(
name|IS_ULTRA3
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|off
operator|=
name|ISP_80M_SYNCPARMS
operator|>>
literal|8
expr_stmt|;
name|per
operator|=
name|ISP_80M_SYNCPARMS
operator|&
literal|0xff
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_ULTRA2
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|off
operator|=
name|ISP_40M_SYNCPARMS
operator|>>
literal|8
expr_stmt|;
name|per
operator|=
name|ISP_40M_SYNCPARMS
operator|&
literal|0xff
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_1240
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|off
operator|=
name|ISP_20M_SYNCPARMS
operator|>>
literal|8
expr_stmt|;
name|per
operator|=
name|ISP_20M_SYNCPARMS
operator|&
literal|0xff
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_bustype
operator|==
name|ISP_BT_SBUS
operator|&&
name|isp
operator|->
name|isp_type
operator|<
name|ISP_HA_SCSI_1020A
operator|)
operator|||
operator|(
name|isp
operator|->
name|isp_bustype
operator|==
name|ISP_BT_PCI
operator|&&
name|isp
operator|->
name|isp_type
operator|<
name|ISP_HA_SCSI_1040
operator|)
operator|||
operator|(
name|isp
operator|->
name|isp_clock
operator|&&
name|isp
operator|->
name|isp_clock
operator|<
literal|60
operator|)
operator|||
operator|(
name|sdp
operator|->
name|isp_ultramode
operator|==
literal|0
operator|)
condition|)
block|{
name|off
operator|=
name|ISP_10M_SYNCPARMS
operator|>>
literal|8
expr_stmt|;
name|per
operator|=
name|ISP_10M_SYNCPARMS
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
block|{
name|off
operator|=
name|ISP_20M_SYNCPARMS_1040
operator|>>
literal|8
expr_stmt|;
name|per
operator|=
name|ISP_20M_SYNCPARMS_1040
operator|&
literal|0xff
expr_stmt|;
block|}
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_offset
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
operator|=
name|off
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_period
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_period
operator|=
name|per
expr_stmt|;
block|}
comment|/* 	 * If we're a dual bus card, just copy the data over 	 */
if|if
condition|(
name|sdp1
condition|)
block|{
operator|*
name|sdp1
operator|=
operator|*
name|sdp
expr_stmt|;
name|sdp1
operator|->
name|isp_initiator_id
operator|=
name|DEFAULT_IID
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * If we've not been told to avoid reading NVRAM, try and read it. 	 * If we're successful reading it, we can then return because NVRAM 	 * will tell us what the desired settings are. Otherwise, we establish 	 * some reasonable 'fake' nvram and goal defaults. 	 */
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_NONVRAM
operator|)
operator|==
literal|0
condition|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
if|if
condition|(
name|isp_read_nvram
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|IS_DUALBUS
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|isp_read_nvram
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return;
block|}
block|}
block|}
name|MBSINIT
argument_list|(
operator|&
name|mbs
argument_list|,
name|MBOX_GET_ACT_NEG_STATE
argument_list|,
name|MBLOGNONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|sdp
operator|->
name|isp_req_ack_active_neg
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|isp_data_line_active_neg
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sdp1
condition|)
block|{
name|sdp1
operator|->
name|isp_req_ack_active_neg
operator|=
literal|1
expr_stmt|;
name|sdp1
operator|->
name|isp_data_line_active_neg
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|sdp
operator|->
name|isp_req_ack_active_neg
operator|=
operator|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0x1
expr_stmt|;
name|sdp
operator|->
name|isp_data_line_active_neg
operator|=
operator|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|>>
literal|5
operator|)
operator|&
literal|0x1
expr_stmt|;
if|if
condition|(
name|sdp1
condition|)
block|{
name|sdp1
operator|->
name|isp_req_ack_active_neg
operator|=
operator|(
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0x1
expr_stmt|;
name|sdp1
operator|->
name|isp_data_line_active_neg
operator|=
operator|(
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|>>
literal|5
operator|)
operator|&
literal|0x1
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_setdfltfcparm
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
decl_stmt|;
comment|/* 	 * Establish some default parameters. 	 */
name|fcp
operator|->
name|role
operator|=
name|GET_DEFAULT_ROLE
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_maxalloc
operator|=
name|ICB_DFLT_ALLOC
expr_stmt|;
name|fcp
operator|->
name|isp_retry_delay
operator|=
name|ICB_DFLT_RDELAY
expr_stmt|;
name|fcp
operator|->
name|isp_retry_count
operator|=
name|ICB_DFLT_RCOUNT
expr_stmt|;
name|fcp
operator|->
name|isp_loopid
operator|=
name|DEFAULT_LOOPID
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_wwnn_nvram
operator|=
name|DEFAULT_NODEWWN
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_wwpn_nvram
operator|=
name|DEFAULT_PORTWWN
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_fwoptions
operator|=
literal|0
expr_stmt|;
name|fcp
operator|->
name|isp_lasthdl
operator|=
name|NIL_HANDLE
expr_stmt|;
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|fcp
operator|->
name|isp_fwoptions
operator||=
name|ICB2400_OPT1_FAIRNESS
expr_stmt|;
name|fcp
operator|->
name|isp_fwoptions
operator||=
name|ICB2400_OPT1_HARD_ADDRESS
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_FULL_DUPLEX
condition|)
block|{
name|fcp
operator|->
name|isp_fwoptions
operator||=
name|ICB2400_OPT1_FULL_DUPLEX
expr_stmt|;
block|}
name|fcp
operator|->
name|isp_fwoptions
operator||=
name|ICB2400_OPT1_BOTH_WWNS
expr_stmt|;
block|}
else|else
block|{
name|fcp
operator|->
name|isp_fwoptions
operator||=
name|ICBOPT_FAIRNESS
expr_stmt|;
name|fcp
operator|->
name|isp_fwoptions
operator||=
name|ICBOPT_PDBCHANGE_AE
expr_stmt|;
name|fcp
operator|->
name|isp_fwoptions
operator||=
name|ICBOPT_HARD_ADDRESS
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_FULL_DUPLEX
condition|)
block|{
name|fcp
operator|->
name|isp_fwoptions
operator||=
name|ICBOPT_FULL_DUPLEX
expr_stmt|;
block|}
comment|/* 		 * Make sure this is turned off now until we get 		 * extended options from NVRAM 		 */
name|fcp
operator|->
name|isp_fwoptions
operator|&=
operator|~
name|ICBOPT_EXTENDED
expr_stmt|;
block|}
comment|/* 	 * Now try and read NVRAM unless told to not do so. 	 * This will set fcparam's isp_wwnn_nvram&& isp_wwpn_nvram. 	 */
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_NONVRAM
operator|)
operator|==
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|;
comment|/* 		 * Give a couple of tries at reading NVRAM. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|j
operator|=
name|isp_read_nvram
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|j
condition|)
block|{
name|isp
operator|->
name|isp_confopts
operator||=
name|ISP_CFG_NONVRAM
expr_stmt|;
block|}
block|}
name|fcp
operator|->
name|isp_wwnn
operator|=
name|ACTIVE_NODEWWN
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_wwpn
operator|=
name|ACTIVE_PORTWWN
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"Chan %d 0x%08x%08x/0x%08x%08x Role %s"
argument_list|,
name|chan
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwnn
operator|>>
literal|32
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwnn
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
operator|>>
literal|32
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn
argument_list|)
argument_list|,
name|isp_class3_roles
index|[
name|fcp
operator|->
name|role
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Re-initialize the ISP and complete all orphaned commands  * with a 'botched' notice. The reset/init routines should  * not disturb an already active list of commands.  */
end_comment

begin_function
name|void
name|isp_reinit
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|do_load_defaults
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|isp_reset
argument_list|(
name|isp
argument_list|,
name|do_load_defaults
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_state
operator|!=
name|ISP_RESETSTATE
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"%s: cannot reset card"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ISP_DISABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|isp_init
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_state
operator|==
name|ISP_INITSTATE
condition|)
block|{
name|isp
operator|->
name|isp_state
operator|=
name|ISP_RUNSTATE
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_state
operator|!=
name|ISP_RUNSTATE
condition|)
block|{
ifndef|#
directive|ifndef
name|ISP_TARGET_MODE
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"%s: not at runstate"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ISP_DISABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* 			 * If we're in ISP_ROLE_NONE, turn off the lasers. 			 */
if|if
condition|(
operator|!
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|,
name|BIU2100_FPM0_REGS
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|FPM_DIAG_CONFIG
argument_list|,
name|FPM_SOFT_RESET
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|,
name|BIU2100_FB_REGS
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|FBM_CMD
argument_list|,
name|FBMCMD_FIFO_RESET_ALL
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|,
name|BIU2100_RISC_REGS
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|cleanup
label|:
name|isp
operator|->
name|isp_nactive
operator|=
literal|0
expr_stmt|;
name|isp_clear_commands
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|i
operator|++
control|)
block|{
name|ISP_MARK_PORTDB
argument_list|(
name|isp
argument_list|,
name|i
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * NVRAM Routines  */
end_comment

begin_function
specifier|static
name|int
name|isp_read_nvram
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|bus
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|amt
decl_stmt|,
name|retval
decl_stmt|;
name|uint8_t
name|csum
decl_stmt|,
name|minversion
decl_stmt|;
union|union
block|{
name|uint8_t
name|_x
index|[
name|ISP2400_NVRAM_SIZE
index|]
decl_stmt|;
name|uint16_t
name|_s
index|[
name|ISP2400_NVRAM_SIZE
operator|>>
literal|1
index|]
expr_stmt|;
block|}
name|_n
union|;
define|#
directive|define
name|nvram_data
value|_n._x
define|#
directive|define
name|nvram_words
value|_n._s
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
return|return
operator|(
name|isp_read_nvram_2400
argument_list|(
name|isp
argument_list|,
name|nvram_data
argument_list|)
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|amt
operator|=
name|ISP2100_NVRAM_SIZE
expr_stmt|;
name|minversion
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_ULTRA2
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|amt
operator|=
name|ISP1080_NVRAM_SIZE
expr_stmt|;
name|minversion
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|amt
operator|=
name|ISP_NVRAM_SIZE
expr_stmt|;
name|minversion
operator|=
literal|2
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|amt
operator|>>
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|isp_rdnvram_word
argument_list|(
name|isp
argument_list|,
name|i
argument_list|,
operator|&
name|nvram_words
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nvram_data
index|[
literal|0
index|]
operator|!=
literal|'I'
operator|||
name|nvram_data
index|[
literal|1
index|]
operator|!=
literal|'S'
operator|||
name|nvram_data
index|[
literal|2
index|]
operator|!=
literal|'P'
condition|)
block|{
if|if
condition|(
name|isp
operator|->
name|isp_bustype
operator|!=
name|ISP_BT_SBUS
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"invalid NVRAM header"
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"%x %x %x"
argument_list|,
name|nvram_data
index|[
literal|0
index|]
argument_list|,
name|nvram_data
index|[
literal|1
index|]
argument_list|,
name|nvram_data
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
name|retval
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|csum
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|amt
condition|;
name|i
operator|++
control|)
block|{
name|csum
operator|+=
name|nvram_data
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|csum
operator|!=
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"invalid NVRAM checksum"
argument_list|)
expr_stmt|;
name|retval
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ISP_NVRAM_VERSION
argument_list|(
name|nvram_data
argument_list|)
operator|<
name|minversion
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"version %d NVRAM not understood"
argument_list|,
name|ISP_NVRAM_VERSION
argument_list|(
name|nvram_data
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|IS_ULTRA3
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_parse_nvram_12160
argument_list|(
name|isp
argument_list|,
name|bus
argument_list|,
name|nvram_data
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_1080
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_parse_nvram_1080
argument_list|(
name|isp
argument_list|,
name|bus
argument_list|,
name|nvram_data
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_1280
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_1240
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_parse_nvram_1080
argument_list|(
name|isp
argument_list|,
name|bus
argument_list|,
name|nvram_data
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp_parse_nvram_1020
argument_list|(
name|isp
argument_list|,
name|nvram_data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_parse_nvram_2100
argument_list|(
name|isp
argument_list|,
name|nvram_data
argument_list|)
expr_stmt|;
block|}
name|retval
operator|=
literal|0
expr_stmt|;
name|out
label|:
return|return
operator|(
name|retval
operator|)
return|;
undef|#
directive|undef
name|nvram_data
undef|#
directive|undef
name|nvram_words
block|}
end_function

begin_function
specifier|static
name|int
name|isp_read_nvram_2400
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint8_t
modifier|*
name|nvram_data
parameter_list|)
block|{
name|int
name|retval
init|=
literal|0
decl_stmt|;
name|uint32_t
name|addr
decl_stmt|,
name|csum
decl_stmt|,
name|lwrds
decl_stmt|,
modifier|*
name|dptr
decl_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_port
condition|)
block|{
name|addr
operator|=
name|ISP2400_NVRAM_PORT1_ADDR
expr_stmt|;
block|}
else|else
block|{
name|addr
operator|=
name|ISP2400_NVRAM_PORT0_ADDR
expr_stmt|;
block|}
name|dptr
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|nvram_data
expr_stmt|;
for|for
control|(
name|lwrds
operator|=
literal|0
init|;
name|lwrds
operator|<
name|ISP2400_NVRAM_SIZE
operator|>>
literal|2
condition|;
name|lwrds
operator|++
control|)
block|{
name|isp_rd_2400_nvram
argument_list|(
name|isp
argument_list|,
name|addr
operator|++
argument_list|,
name|dptr
operator|++
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nvram_data
index|[
literal|0
index|]
operator|!=
literal|'I'
operator|||
name|nvram_data
index|[
literal|1
index|]
operator|!=
literal|'S'
operator|||
name|nvram_data
index|[
literal|2
index|]
operator|!=
literal|'P'
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"invalid NVRAM header (%x %x %x)"
argument_list|,
name|nvram_data
index|[
literal|0
index|]
argument_list|,
name|nvram_data
index|[
literal|1
index|]
argument_list|,
name|nvram_data
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|retval
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dptr
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|nvram_data
expr_stmt|;
for|for
control|(
name|csum
operator|=
literal|0
operator|,
name|lwrds
operator|=
literal|0
init|;
name|lwrds
operator|<
name|ISP2400_NVRAM_SIZE
operator|>>
literal|2
condition|;
name|lwrds
operator|++
control|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|ISP_IOXGET_32
argument_list|(
name|isp
argument_list|,
operator|&
name|dptr
index|[
name|lwrds
index|]
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|csum
operator|+=
name|tmp
expr_stmt|;
block|}
if|if
condition|(
name|csum
operator|!=
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"invalid NVRAM checksum"
argument_list|)
expr_stmt|;
name|retval
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|isp_parse_nvram_2400
argument_list|(
name|isp
argument_list|,
name|nvram_data
argument_list|)
expr_stmt|;
name|out
label|:
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_rdnvram_word
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|wo
parameter_list|,
name|uint16_t
modifier|*
name|rp
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cbits
decl_stmt|;
name|uint16_t
name|bit
decl_stmt|,
name|rqst
decl_stmt|,
name|junk
decl_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|,
name|BIU_NVRAM_SELECT
argument_list|)
expr_stmt|;
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|,
name|BIU_NVRAM_SELECT
operator||
name|BIU_NVRAM_CLOCK
argument_list|)
expr_stmt|;
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|wo
operator|&=
operator|(
operator|(
name|ISP2100_NVRAM_SIZE
operator|>>
literal|1
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|IS_2312
argument_list|(
name|isp
argument_list|)
operator|&&
name|isp
operator|->
name|isp_port
condition|)
block|{
name|wo
operator|+=
literal|128
expr_stmt|;
block|}
name|rqst
operator|=
operator|(
name|ISP_NVRAM_READ
operator|<<
literal|8
operator|)
operator||
name|wo
expr_stmt|;
name|cbits
operator|=
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_ULTRA2
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|wo
operator|&=
operator|(
operator|(
name|ISP1080_NVRAM_SIZE
operator|>>
literal|1
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|rqst
operator|=
operator|(
name|ISP_NVRAM_READ
operator|<<
literal|8
operator|)
operator||
name|wo
expr_stmt|;
name|cbits
operator|=
literal|10
expr_stmt|;
block|}
else|else
block|{
name|wo
operator|&=
operator|(
operator|(
name|ISP_NVRAM_SIZE
operator|>>
literal|1
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|rqst
operator|=
operator|(
name|ISP_NVRAM_READ
operator|<<
literal|6
operator|)
operator||
name|wo
expr_stmt|;
name|cbits
operator|=
literal|8
expr_stmt|;
block|}
comment|/* 	 * Clock the word select request out... 	 */
for|for
control|(
name|i
operator|=
name|cbits
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|rqst
operator|>>
name|i
operator|)
operator|&
literal|1
condition|)
block|{
name|bit
operator|=
name|BIU_NVRAM_SELECT
operator||
name|BIU_NVRAM_DATAOUT
expr_stmt|;
block|}
else|else
block|{
name|bit
operator|=
name|BIU_NVRAM_SELECT
expr_stmt|;
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|,
name|bit
argument_list|)
expr_stmt|;
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|junk
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|)
expr_stmt|;
comment|/* force PCI flush */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|,
name|bit
operator||
name|BIU_NVRAM_CLOCK
argument_list|)
expr_stmt|;
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|junk
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|)
expr_stmt|;
comment|/* force PCI flush */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|,
name|bit
argument_list|)
expr_stmt|;
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|junk
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|)
expr_stmt|;
comment|/* force PCI flush */
block|}
comment|/* 	 * Now read the result back in (bits come back in MSB format). 	 */
operator|*
name|rp
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|uint16_t
name|rv
decl_stmt|;
operator|*
name|rp
operator|<<=
literal|1
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|,
name|BIU_NVRAM_SELECT
operator||
name|BIU_NVRAM_CLOCK
argument_list|)
expr_stmt|;
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|rv
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|&
name|BIU_NVRAM_DATAIN
condition|)
block|{
operator|*
name|rp
operator||=
literal|1
expr_stmt|;
block|}
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|,
name|BIU_NVRAM_SELECT
argument_list|)
expr_stmt|;
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|junk
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|)
expr_stmt|;
comment|/* force PCI flush */
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|junk
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_NVRAM
argument_list|)
expr_stmt|;
comment|/* force PCI flush */
name|ISP_SWIZZLE_NVRAM_WORD
argument_list|(
name|isp
argument_list|,
name|rp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_rd_2400_nvram
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint32_t
modifier|*
name|rp
parameter_list|)
block|{
name|int
name|loops
init|=
literal|0
decl_stmt|;
name|uint32_t
name|base
init|=
literal|0x7ffe0000
decl_stmt|;
name|uint32_t
name|tmp
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|IS_25XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|base
operator|=
literal|0x7ff00000
operator||
literal|0x48000
expr_stmt|;
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_FLASH_ADDR
argument_list|,
name|base
operator||
name|addr
argument_list|)
expr_stmt|;
for|for
control|(
name|loops
operator|=
literal|0
init|;
name|loops
operator|<
literal|5000
condition|;
name|loops
operator|++
control|)
block|{
name|ISP_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU2400_FLASH_ADDR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
operator|(
literal|1U
operator|<<
literal|31
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|tmp
operator|&
operator|(
literal|1U
operator|<<
literal|31
operator|)
condition|)
block|{
operator|*
name|rp
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU2400_FLASH_DATA
argument_list|)
expr_stmt|;
name|ISP_SWIZZLE_NVRAM_LONG
argument_list|(
name|isp
argument_list|,
name|rp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|rp
operator|=
literal|0xffffffff
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_parse_nvram_1020
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint8_t
modifier|*
name|nvram_data
parameter_list|)
block|{
name|sdparam
modifier|*
name|sdp
init|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|int
name|tgt
decl_stmt|;
name|sdp
operator|->
name|isp_fifo_threshold
operator|=
name|ISP_NVRAM_FIFO_THRESHOLD
argument_list|(
name|nvram_data
argument_list|)
operator||
operator|(
name|ISP_NVRAM_FIFO_THRESHOLD_128
argument_list|(
name|nvram_data
argument_list|)
operator|<<
literal|2
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNLOOPID
operator|)
operator|==
literal|0
condition|)
name|sdp
operator|->
name|isp_initiator_id
operator|=
name|ISP_NVRAM_INITIATOR_ID
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_bus_reset_delay
operator|=
name|ISP_NVRAM_BUS_RESET_DELAY
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_retry_count
operator|=
name|ISP_NVRAM_BUS_RETRY_COUNT
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_retry_delay
operator|=
name|ISP_NVRAM_BUS_RETRY_DELAY
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_async_data_setup
operator|=
name|ISP_NVRAM_ASYNC_DATA_SETUP_TIME
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|>=
name|ISP_HA_SCSI_1040
condition|)
block|{
if|if
condition|(
name|sdp
operator|->
name|isp_async_data_setup
operator|<
literal|9
condition|)
block|{
name|sdp
operator|->
name|isp_async_data_setup
operator|=
literal|9
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|sdp
operator|->
name|isp_async_data_setup
operator|!=
literal|6
condition|)
block|{
name|sdp
operator|->
name|isp_async_data_setup
operator|=
literal|6
expr_stmt|;
block|}
block|}
name|sdp
operator|->
name|isp_req_ack_active_neg
operator|=
name|ISP_NVRAM_REQ_ACK_ACTIVE_NEGATION
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_data_line_active_neg
operator|=
name|ISP_NVRAM_DATA_LINE_ACTIVE_NEGATION
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_data_dma_burst_enabl
operator|=
name|ISP_NVRAM_DATA_DMA_BURST_ENABLE
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_cmd_dma_burst_enable
operator|=
name|ISP_NVRAM_CMD_DMA_BURST_ENABLE
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_tag_aging
operator|=
name|ISP_NVRAM_TAG_AGE_LIMIT
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_selection_timeout
operator|=
name|ISP_NVRAM_SELECTION_TIMEOUT
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_max_queue_depth
operator|=
name|ISP_NVRAM_MAX_QUEUE_DEPTH
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_fast_mttr
operator|=
name|ISP_NVRAM_FAST_MTTR_ENABLE
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
for|for
control|(
name|tgt
operator|=
literal|0
init|;
name|tgt
operator|<
name|MAX_TARGETS
condition|;
name|tgt
operator|++
control|)
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_enable
operator|=
name|ISP_NVRAM_TGT_DEVICE_ENABLE
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|exc_throttle
operator|=
name|ISP_NVRAM_TGT_EXEC_THROTTLE
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
operator|=
name|ISP_NVRAM_TGT_SYNC_OFFSET
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_period
operator|=
name|ISP_NVRAM_TGT_SYNC_PERIOD
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|)
expr_stmt|;
comment|/* 		 * We probably shouldn't lie about this, but it 		 * it makes it much safer if we limit NVRAM values 		 * to sanity. 		 */
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|<
name|ISP_HA_SCSI_1040
condition|)
block|{
comment|/* 			 * If we're not ultra, we can't possibly 			 * be a shorter period than this. 			 */
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_period
operator|<
literal|0x19
condition|)
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_period
operator|=
literal|0x19
expr_stmt|;
block|}
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
operator|>
literal|0xc
condition|)
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
operator|=
literal|0x0c
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
operator|>
literal|0x8
condition|)
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
operator|=
literal|0x8
expr_stmt|;
block|}
block|}
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ISP_NVRAM_TGT_RENEG
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_RENEG
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_ARQ
expr_stmt|;
if|if
condition|(
name|ISP_NVRAM_TGT_TQING
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_TQING
expr_stmt|;
if|if
condition|(
name|ISP_NVRAM_TGT_SYNC
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_SYNC
expr_stmt|;
if|if
condition|(
name|ISP_NVRAM_TGT_WIDE
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_WIDE
expr_stmt|;
if|if
condition|(
name|ISP_NVRAM_TGT_PARITY
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_PARITY
expr_stmt|;
if|if
condition|(
name|ISP_NVRAM_TGT_DISC
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_DISC
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_flags
operator|=
literal|0
expr_stmt|;
comment|/* we don't know */
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_offset
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_period
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_period
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_flags
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_parse_nvram_1080
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|bus
parameter_list|,
name|uint8_t
modifier|*
name|nvram_data
parameter_list|)
block|{
name|sdparam
modifier|*
name|sdp
init|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|bus
argument_list|)
decl_stmt|;
name|int
name|tgt
decl_stmt|;
name|sdp
operator|->
name|isp_fifo_threshold
operator|=
name|ISP1080_NVRAM_FIFO_THRESHOLD
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNLOOPID
operator|)
operator|==
literal|0
condition|)
name|sdp
operator|->
name|isp_initiator_id
operator|=
name|ISP1080_NVRAM_INITIATOR_ID
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_bus_reset_delay
operator|=
name|ISP1080_NVRAM_BUS_RESET_DELAY
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_retry_count
operator|=
name|ISP1080_NVRAM_BUS_RETRY_COUNT
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_retry_delay
operator|=
name|ISP1080_NVRAM_BUS_RETRY_DELAY
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_async_data_setup
operator|=
name|ISP1080_NVRAM_ASYNC_DATA_SETUP_TIME
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_req_ack_active_neg
operator|=
name|ISP1080_NVRAM_REQ_ACK_ACTIVE_NEGATION
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_data_line_active_neg
operator|=
name|ISP1080_NVRAM_DATA_LINE_ACTIVE_NEGATION
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_data_dma_burst_enabl
operator|=
name|ISP1080_NVRAM_BURST_ENABLE
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_cmd_dma_burst_enable
operator|=
name|ISP1080_NVRAM_BURST_ENABLE
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_selection_timeout
operator|=
name|ISP1080_NVRAM_SELECTION_TIMEOUT
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_max_queue_depth
operator|=
name|ISP1080_NVRAM_MAX_QUEUE_DEPTH
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
for|for
control|(
name|tgt
operator|=
literal|0
init|;
name|tgt
operator|<
name|MAX_TARGETS
condition|;
name|tgt
operator|++
control|)
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_enable
operator|=
name|ISP1080_NVRAM_TGT_DEVICE_ENABLE
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|exc_throttle
operator|=
name|ISP1080_NVRAM_TGT_EXEC_THROTTLE
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
operator|=
name|ISP1080_NVRAM_TGT_SYNC_OFFSET
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_period
operator|=
name|ISP1080_NVRAM_TGT_SYNC_PERIOD
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ISP1080_NVRAM_TGT_RENEG
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_RENEG
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_ARQ
expr_stmt|;
if|if
condition|(
name|ISP1080_NVRAM_TGT_TQING
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_TQING
expr_stmt|;
if|if
condition|(
name|ISP1080_NVRAM_TGT_SYNC
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_SYNC
expr_stmt|;
if|if
condition|(
name|ISP1080_NVRAM_TGT_WIDE
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_WIDE
expr_stmt|;
if|if
condition|(
name|ISP1080_NVRAM_TGT_PARITY
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_PARITY
expr_stmt|;
if|if
condition|(
name|ISP1080_NVRAM_TGT_DISC
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_DISC
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_flags
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_offset
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_period
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_period
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_flags
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_parse_nvram_12160
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|bus
parameter_list|,
name|uint8_t
modifier|*
name|nvram_data
parameter_list|)
block|{
name|sdparam
modifier|*
name|sdp
init|=
name|SDPARAM
argument_list|(
name|isp
argument_list|,
name|bus
argument_list|)
decl_stmt|;
name|int
name|tgt
decl_stmt|;
name|sdp
operator|->
name|isp_fifo_threshold
operator|=
name|ISP12160_NVRAM_FIFO_THRESHOLD
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNLOOPID
operator|)
operator|==
literal|0
condition|)
name|sdp
operator|->
name|isp_initiator_id
operator|=
name|ISP12160_NVRAM_INITIATOR_ID
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_bus_reset_delay
operator|=
name|ISP12160_NVRAM_BUS_RESET_DELAY
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_retry_count
operator|=
name|ISP12160_NVRAM_BUS_RETRY_COUNT
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_retry_delay
operator|=
name|ISP12160_NVRAM_BUS_RETRY_DELAY
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_async_data_setup
operator|=
name|ISP12160_NVRAM_ASYNC_DATA_SETUP_TIME
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_req_ack_active_neg
operator|=
name|ISP12160_NVRAM_REQ_ACK_ACTIVE_NEGATION
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_data_line_active_neg
operator|=
name|ISP12160_NVRAM_DATA_LINE_ACTIVE_NEGATION
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_data_dma_burst_enabl
operator|=
name|ISP12160_NVRAM_BURST_ENABLE
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_cmd_dma_burst_enable
operator|=
name|ISP12160_NVRAM_BURST_ENABLE
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_selection_timeout
operator|=
name|ISP12160_NVRAM_SELECTION_TIMEOUT
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_max_queue_depth
operator|=
name|ISP12160_NVRAM_MAX_QUEUE_DEPTH
argument_list|(
name|nvram_data
argument_list|,
name|bus
argument_list|)
expr_stmt|;
for|for
control|(
name|tgt
operator|=
literal|0
init|;
name|tgt
operator|<
name|MAX_TARGETS
condition|;
name|tgt
operator|++
control|)
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|dev_enable
operator|=
name|ISP12160_NVRAM_TGT_DEVICE_ENABLE
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|exc_throttle
operator|=
name|ISP12160_NVRAM_TGT_EXEC_THROTTLE
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
operator|=
name|ISP12160_NVRAM_TGT_SYNC_OFFSET
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_period
operator|=
name|ISP12160_NVRAM_TGT_SYNC_PERIOD
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ISP12160_NVRAM_TGT_RENEG
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_RENEG
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_ARQ
expr_stmt|;
if|if
condition|(
name|ISP12160_NVRAM_TGT_TQING
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_TQING
expr_stmt|;
if|if
condition|(
name|ISP12160_NVRAM_TGT_SYNC
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_SYNC
expr_stmt|;
if|if
condition|(
name|ISP12160_NVRAM_TGT_WIDE
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_WIDE
expr_stmt|;
if|if
condition|(
name|ISP12160_NVRAM_TGT_PARITY
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_PARITY
expr_stmt|;
if|if
condition|(
name|ISP12160_NVRAM_TGT_DISC
argument_list|(
name|nvram_data
argument_list|,
name|tgt
argument_list|,
name|bus
argument_list|)
condition|)
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
operator||=
name|DPARM_DISC
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|actv_flags
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_offset
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_offset
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_period
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_period
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|goal_flags
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|tgt
index|]
operator|.
name|nvrm_flags
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_parse_nvram_2100
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint8_t
modifier|*
name|nvram_data
parameter_list|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|uint64_t
name|wwn
decl_stmt|;
comment|/* 	 * There is NVRAM storage for both Port and Node entities- 	 * but the Node entity appears to be unused on all the cards 	 * I can find. However, we should account for this being set 	 * at some point in the future. 	 * 	 * Qlogic WWNs have an NAA of 2, but usually nothing shows up in 	 * bits 48..60. In the case of the 2202, it appears that they do 	 * use bit 48 to distinguish between the two instances on the card. 	 * The 2204, which I've never seen, *probably* extends this method. 	 */
name|wwn
operator|=
name|ISP2100_NVRAM_PORT_NAME
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|wwn
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"NVRAM Port WWN 0x%08x%08x"
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|wwn
operator|>>
literal|32
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|wwn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wwn
operator|>>
literal|60
operator|)
operator|==
literal|0
condition|)
block|{
name|wwn
operator||=
operator|(
operator|(
operator|(
name|uint64_t
operator|)
literal|2
operator|)
operator|<<
literal|60
operator|)
expr_stmt|;
block|}
block|}
name|fcp
operator|->
name|isp_wwpn_nvram
operator|=
name|wwn
expr_stmt|;
if|if
condition|(
name|IS_2200
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_23XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|wwn
operator|=
name|ISP2100_NVRAM_NODE_NAME
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|wwn
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"NVRAM Node WWN 0x%08x%08x"
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|wwn
operator|>>
literal|32
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|wwn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wwn
operator|>>
literal|60
operator|)
operator|==
literal|0
condition|)
block|{
name|wwn
operator||=
operator|(
operator|(
operator|(
name|uint64_t
operator|)
literal|2
operator|)
operator|<<
literal|60
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|wwn
operator|=
name|fcp
operator|->
name|isp_wwpn_nvram
operator|&
operator|~
operator|(
operator|(
name|uint64_t
operator|)
literal|0xfff
operator|<<
literal|48
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|wwn
operator|&=
operator|~
operator|(
operator|(
name|uint64_t
operator|)
literal|0xfff
operator|<<
literal|48
operator|)
expr_stmt|;
block|}
name|fcp
operator|->
name|isp_wwnn_nvram
operator|=
name|wwn
expr_stmt|;
name|fcp
operator|->
name|isp_maxalloc
operator|=
name|ISP2100_NVRAM_MAXIOCBALLOCATION
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNFSZ
operator|)
operator|==
literal|0
condition|)
block|{
name|DEFAULT_FRAMESIZE
argument_list|(
name|isp
argument_list|)
operator|=
name|ISP2100_NVRAM_MAXFRAMELENGTH
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
block|}
name|fcp
operator|->
name|isp_retry_delay
operator|=
name|ISP2100_NVRAM_RETRY_DELAY
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_retry_count
operator|=
name|ISP2100_NVRAM_RETRY_COUNT
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNLOOPID
operator|)
operator|==
literal|0
condition|)
block|{
name|fcp
operator|->
name|isp_loopid
operator|=
name|ISP2100_NVRAM_HARDLOOPID
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNEXCTHROTTLE
operator|)
operator|==
literal|0
condition|)
block|{
name|DEFAULT_EXEC_THROTTLE
argument_list|(
name|isp
argument_list|)
operator|=
name|ISP2100_NVRAM_EXECUTION_THROTTLE
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
block|}
name|fcp
operator|->
name|isp_fwoptions
operator|=
name|ISP2100_NVRAM_OPTIONS
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"NVRAM 0x%08x%08x 0x%08x%08x maxalloc %d maxframelen %d"
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwnn_nvram
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|fcp
operator|->
name|isp_wwnn_nvram
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_wwpn_nvram
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|fcp
operator|->
name|isp_wwpn_nvram
argument_list|,
name|ISP2100_NVRAM_MAXIOCBALLOCATION
argument_list|(
name|nvram_data
argument_list|)
argument_list|,
name|ISP2100_NVRAM_MAXFRAMELENGTH
argument_list|(
name|nvram_data
argument_list|)
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"execthrottle %d fwoptions 0x%x hardloop %d tov %d"
argument_list|,
name|ISP2100_NVRAM_EXECUTION_THROTTLE
argument_list|(
name|nvram_data
argument_list|)
argument_list|,
name|ISP2100_NVRAM_OPTIONS
argument_list|(
name|nvram_data
argument_list|)
argument_list|,
name|ISP2100_NVRAM_HARDLOOPID
argument_list|(
name|nvram_data
argument_list|)
argument_list|,
name|ISP2100_NVRAM_TOV
argument_list|(
name|nvram_data
argument_list|)
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_xfwoptions
operator|=
name|ISP2100_XFW_OPTIONS
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_zfwoptions
operator|=
name|ISP2100_ZFW_OPTIONS
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"xfwoptions 0x%x zfw options 0x%x"
argument_list|,
name|ISP2100_XFW_OPTIONS
argument_list|(
name|nvram_data
argument_list|)
argument_list|,
name|ISP2100_ZFW_OPTIONS
argument_list|(
name|nvram_data
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_parse_nvram_2400
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint8_t
modifier|*
name|nvram_data
parameter_list|)
block|{
name|fcparam
modifier|*
name|fcp
init|=
name|FCPARAM
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|uint64_t
name|wwn
decl_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"NVRAM 0x%08x%08x 0x%08x%08x exchg_cnt %d maxframelen %d"
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|ISP2400_NVRAM_NODE_NAME
argument_list|(
name|nvram_data
argument_list|)
operator|>>
literal|32
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|ISP2400_NVRAM_NODE_NAME
argument_list|(
name|nvram_data
argument_list|)
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|ISP2400_NVRAM_PORT_NAME
argument_list|(
name|nvram_data
argument_list|)
operator|>>
literal|32
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|ISP2400_NVRAM_PORT_NAME
argument_list|(
name|nvram_data
argument_list|)
argument_list|)
argument_list|,
name|ISP2400_NVRAM_EXCHANGE_COUNT
argument_list|(
name|nvram_data
argument_list|)
argument_list|,
name|ISP2400_NVRAM_MAXFRAMELENGTH
argument_list|(
name|nvram_data
argument_list|)
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG0
argument_list|,
literal|"NVRAM execthr %d loopid %d fwopt1 0x%x fwopt2 0x%x fwopt3 0x%x"
argument_list|,
name|ISP2400_NVRAM_EXECUTION_THROTTLE
argument_list|(
name|nvram_data
argument_list|)
argument_list|,
name|ISP2400_NVRAM_HARDLOOPID
argument_list|(
name|nvram_data
argument_list|)
argument_list|,
name|ISP2400_NVRAM_FIRMWARE_OPTIONS1
argument_list|(
name|nvram_data
argument_list|)
argument_list|,
name|ISP2400_NVRAM_FIRMWARE_OPTIONS2
argument_list|(
name|nvram_data
argument_list|)
argument_list|,
name|ISP2400_NVRAM_FIRMWARE_OPTIONS3
argument_list|(
name|nvram_data
argument_list|)
argument_list|)
expr_stmt|;
name|wwn
operator|=
name|ISP2400_NVRAM_PORT_NAME
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_wwpn_nvram
operator|=
name|wwn
expr_stmt|;
name|wwn
operator|=
name|ISP2400_NVRAM_NODE_NAME
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|wwn
condition|)
block|{
if|if
condition|(
operator|(
name|wwn
operator|>>
literal|60
operator|)
operator|!=
literal|2
operator|&&
operator|(
name|wwn
operator|>>
literal|60
operator|)
operator|!=
literal|5
condition|)
block|{
name|wwn
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wwn
operator|==
literal|0
operator|&&
operator|(
name|fcp
operator|->
name|isp_wwpn_nvram
operator|>>
literal|60
operator|)
operator|==
literal|2
condition|)
block|{
name|wwn
operator|=
name|fcp
operator|->
name|isp_wwpn_nvram
expr_stmt|;
name|wwn
operator|&=
operator|~
operator|(
operator|(
name|uint64_t
operator|)
literal|0xfff
operator|<<
literal|48
operator|)
expr_stmt|;
block|}
name|fcp
operator|->
name|isp_wwnn_nvram
operator|=
name|wwn
expr_stmt|;
if|if
condition|(
name|ISP2400_NVRAM_EXCHANGE_COUNT
argument_list|(
name|nvram_data
argument_list|)
condition|)
block|{
name|fcp
operator|->
name|isp_maxalloc
operator|=
name|ISP2400_NVRAM_EXCHANGE_COUNT
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNFSZ
operator|)
operator|==
literal|0
condition|)
block|{
name|DEFAULT_FRAMESIZE
argument_list|(
name|isp
argument_list|)
operator|=
name|ISP2400_NVRAM_MAXFRAMELENGTH
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNLOOPID
operator|)
operator|==
literal|0
condition|)
block|{
name|fcp
operator|->
name|isp_loopid
operator|=
name|ISP2400_NVRAM_HARDLOOPID
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_OWNEXCTHROTTLE
operator|)
operator|==
literal|0
condition|)
block|{
name|DEFAULT_EXEC_THROTTLE
argument_list|(
name|isp
argument_list|)
operator|=
name|ISP2400_NVRAM_EXECUTION_THROTTLE
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
block|}
name|fcp
operator|->
name|isp_fwoptions
operator|=
name|ISP2400_NVRAM_FIRMWARE_OPTIONS1
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_xfwoptions
operator|=
name|ISP2400_NVRAM_FIRMWARE_OPTIONS2
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
name|fcp
operator|->
name|isp_zfwoptions
operator|=
name|ISP2400_NVRAM_FIRMWARE_OPTIONS3
argument_list|(
name|nvram_data
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


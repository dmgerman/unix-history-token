begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Id: isp.c,v 1.6 1998/04/14 17:43:45 mjacob Exp $ */
end_comment

begin_comment
comment|/*  * Machine Independent (well, as best as possible)  * code for the Qlogic ISP SCSI adapters.  *  *---------------------------------------  * Copyright (c) 1997, 1998 by Matthew Jacob  * NASA/Ames Research Center  * All rights reserved.  *---------------------------------------  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice immediately at the beginning of the file, without modification,  *    this list of conditions, and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Inspiration and ideas about this driver are from Erik Moe's Linux driver  * (qlogicisp.c) and Dave Miller's SBus version of same (qlogicisp.c). Some  * ideas dredged from the Solaris driver.  */
end_comment

begin_comment
comment|/*  * Include header file appropriate for platform we're building on.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<dev/ic/isp_netbsd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<dev/isp/isp_freebsd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__linux__
end_ifdef

begin_include
include|#
directive|include
file|<isp_linux.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * General defines  */
end_comment

begin_define
define|#
directive|define
name|MBOX_DELAY_COUNT
value|1000000 / 100
end_define

begin_comment
comment|/*  * Function prototypes.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|isp_poll
name|__P
argument_list|(
operator|(
expr|struct
name|ispsoftc
operator|*
operator|,
name|ISP_SCSI_XFER_T
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|isp_parse_status
name|__P
argument_list|(
operator|(
expr|struct
name|ispsoftc
operator|*
operator|,
name|ispstatusreq_t
operator|*
operator|,
name|ISP_SCSI_XFER_T
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|isp_lostcmd
name|__P
argument_list|(
operator|(
expr|struct
name|ispsoftc
operator|*
operator|,
name|ISP_SCSI_XFER_T
operator|*
operator|,
name|ispreq_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|isp_fibre_init
name|__P
argument_list|(
operator|(
expr|struct
name|ispsoftc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|isp_fw_state
name|__P
argument_list|(
operator|(
expr|struct
name|ispsoftc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|isp_dumpregs
name|__P
argument_list|(
operator|(
expr|struct
name|ispsoftc
operator|*
operator|,
specifier|const
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|isp_setdparm
name|__P
argument_list|(
operator|(
expr|struct
name|ispsoftc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|isp_prtstst
name|__P
argument_list|(
operator|(
name|ispstatusreq_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|isp_mboxcmd
name|__P
argument_list|(
operator|(
expr|struct
name|ispsoftc
operator|*
operator|,
name|mbreg_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Reset Hardware.  */
end_comment

begin_function
name|void
name|isp_reset
parameter_list|(
name|isp
parameter_list|)
name|struct
name|ispsoftc
modifier|*
name|isp
decl_stmt|;
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|int
name|loops
decl_stmt|,
name|i
decl_stmt|,
name|dodnld
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|revname
decl_stmt|;
name|ISP_LOCKVAL_DECL
expr_stmt|;
name|revname
operator|=
literal|"(unknown)"
expr_stmt|;
name|isp
operator|->
name|isp_state
operator|=
name|ISP_NILSTATE
expr_stmt|;
comment|/* 	 * Basic types have been set in the MD code. 	 * See if we can't figure out more here. 	 */
name|isp
operator|->
name|isp_dblev
operator|=
name|DFLT_DBLEVEL
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
name|revname
operator|=
literal|"2100"
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_CONF0
argument_list|)
operator|&
name|BIU_CONF0_HW_MASK
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
default|default:
name|PRINTF
argument_list|(
literal|"%s: unknown ISP type %x- assuming 1020\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1020
expr_stmt|;
break|break;
case|case
literal|1
case|:
case|case
literal|2
case|:
name|revname
operator|=
literal|"1020"
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1020
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|revname
operator|=
literal|"1040A"
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1040A
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|revname
operator|=
literal|"1040B"
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1040B
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Do MD specific pre initialization 	 */
name|ISP_LOCK
expr_stmt|;
name|ISP_RESET0
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_setdparm
argument_list|(
name|isp
argument_list|)
expr_stmt|;
comment|/* 	 * Hit the chip over the head with hammer, 	 * and give the ISP a chance to recover. 	 */
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_ICR
argument_list|,
name|BIU_ICR_SOFT_RESET
argument_list|)
expr_stmt|;
comment|/* 		 * A slight delay... 		 */
name|SYS_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* 		 * Clear data&& control DMA engines. 		 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|CDMA_CONTROL
argument_list|,
name|DMA_CNTRL_CLEAR_CHAN
operator||
name|DMA_CNTRL_RESET_INT
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|DDMA_CONTROL
argument_list|,
name|DMA_CNTRL_CLEAR_CHAN
operator||
name|DMA_CNTRL_RESET_INT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|,
name|BIU2100_SOFT_RESET
argument_list|)
expr_stmt|;
comment|/* 		 * A slight delay... 		 */
name|SYS_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|CDMA2100_CONTROL
argument_list|,
name|DMA_CNTRL2100_CLEAR_CHAN
operator||
name|DMA_CNTRL2100_RESET_INT
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|TDMA2100_CONTROL
argument_list|,
name|DMA_CNTRL2100_CLEAR_CHAN
operator||
name|DMA_CNTRL2100_RESET_INT
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|RDMA2100_CONTROL
argument_list|,
name|DMA_CNTRL2100_CLEAR_CHAN
operator||
name|DMA_CNTRL2100_RESET_INT
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Wait for ISP to be ready to go... 	 */
name|loops
operator|=
name|MBOX_DELAY_COUNT
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_ICR
argument_list|)
operator|&
name|BIU_ICR_SOFT_RESET
operator|)
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|)
operator|&
name|BIU2100_SOFT_RESET
operator|)
condition|)
break|break;
block|}
name|SYS_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|loops
operator|<
literal|0
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"chip reset timed out"
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
return|return;
block|}
block|}
comment|/* 	 * More initialization 	 */
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|RISC_MTR2100
argument_list|,
literal|0x1212
argument_list|)
expr_stmt|;
comment|/* FM */
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_RESET
argument_list|)
expr_stmt|;
name|SYS_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
block|{
name|ISP_SETBITS
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|,
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_conf1
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_conf1
operator|&
name|BIU_BURST_ENABLE
condition|)
block|{
name|ISP_SETBITS
argument_list|(
name|isp
argument_list|,
name|CDMA_CONF
argument_list|,
name|DMA_ENABLE_BURST
argument_list|)
expr_stmt|;
name|ISP_SETBITS
argument_list|(
name|isp
argument_list|,
name|DDMA_CONF
argument_list|,
name|DMA_ENABLE_BURST
argument_list|)
expr_stmt|;
block|}
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_RELEASE
argument_list|)
expr_stmt|;
comment|/* release paused processor */
comment|/* 	 * Do MD specific post initialization 	 */
name|ISP_RESET1
argument_list|(
name|isp
argument_list|)
expr_stmt|;
comment|/* 	 * Enable interrupts 	 */
name|ENABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
comment|/* 	 * Do some sanity checking. 	 */
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_NO_OP
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"NOP test failed"
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_MAILBOX_REG_TEST
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
literal|0xdead
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
literal|0xbeef
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
literal|0xffff
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|=
literal|0x1111
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|5
index|]
operator|=
literal|0xa5a5
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"Mailbox Register test didn't complete"
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|!=
literal|0xdead
operator|||
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|!=
literal|0xbeef
operator|||
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|!=
literal|0xffff
operator|||
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|!=
literal|0x1111
operator|||
name|mbs
operator|.
name|param
index|[
literal|5
index|]
operator|!=
literal|0xa5a5
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"Register Test Failed"
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
return|return;
block|}
block|}
comment|/* 	 * Download new Firmware, unless requested not to do so. 	 * This is made slightly trickier in some cases where the 	 * firmware of the ROM revision is newer than the revision 	 * compiled into the driver. So, where we used to compare 	 * versions of our f/w and the ROM f/w, now we just see 	 * whether we have f/w at all and whether a config flag 	 * has disabled our download. 	 */
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_fwlen
operator|==
literal|0
operator|)
operator|||
operator|(
name|isp
operator|->
name|isp_confopts
operator|&
name|ISP_CFG_NORELOAD
operator|)
condition|)
block|{
name|dodnld
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|dodnld
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_fwlen
condition|;
name|i
operator|++
control|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_WRITE_RAM_WORD
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_codeorg
operator|+
name|i
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_ispfw
index|[
name|i
index|]
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"f/w download failed"
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_fwlen
condition|)
block|{
comment|/* 			 * Verify that it downloaded correctly. 			 */
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_VERIFY_CHECKSUM
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_codeorg
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"ram checksum failure"
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
return|return;
block|}
block|}
block|}
else|else
block|{
name|IDPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"%s: skipping f/w download\n"
operator|,
name|isp
operator|->
name|isp_name
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Now start it rolling. 	 * 	 * If we didn't actually download f/w, 	 * we still need to (re)start it. 	 */
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_EXEC_FIRMWARE
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_codeorg
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
block|{
comment|/* 		 * Set CLOCK RATE 		 */
if|if
condition|(
operator|(
operator|(
name|sdparam
operator|*
operator|)
name|isp
operator|->
name|isp_param
operator|)
operator|->
name|isp_clock
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_CLOCK_RATE
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|sdparam
operator|*
operator|)
name|isp
operator|->
name|isp_param
operator|)
operator|->
name|isp_clock
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"failed to set CLOCKRATE"
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
return|return;
block|}
block|}
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_ABOUT_FIRMWARE
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"ABOUT FIRMWARE command failed"
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
return|return;
block|}
name|PRINTF
argument_list|(
literal|"%s: Board Revision %s, %s F/W Revision %d.%d\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|revname
argument_list|,
name|dodnld
condition|?
literal|"loaded"
else|:
literal|"ROM"
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|1
index|]
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|isp_fw_state
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_state
operator|=
name|ISP_RESETSTATE
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Abort an executing command.  * Locks (ints blocked) assumed held.  */
end_comment

begin_function
name|int
name|isp_abortcmd
parameter_list|(
name|isp
parameter_list|,
name|xidx
parameter_list|)
name|struct
name|ispsoftc
modifier|*
name|isp
decl_stmt|;
name|int
name|xidx
decl_stmt|;
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|ISP_SCSI_XFER_T
modifier|*
name|xs
decl_stmt|;
name|xs
operator|=
operator|(
name|ISP_SCSI_XFER_T
operator|*
operator|)
name|isp
operator|->
name|isp_xflist
index|[
name|xidx
index|]
expr_stmt|;
if|if
condition|(
name|xs
operator|==
name|NULL
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: isp_abortcmd - NULL xs\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_ABORT
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|XS_TGT
argument_list|(
name|xs
argument_list|)
operator||
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
operator|(
name|xidx
operator|+
literal|1
operator|)
operator|>>
literal|16
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
operator|(
name|xidx
operator|+
literal|1
operator|)
operator|&
literal|0xffff
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: isp_abort failure (code %x)\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Initialize Hardware to known state  */
end_comment

begin_function
name|void
name|isp_init
parameter_list|(
name|isp
parameter_list|)
name|struct
name|ispsoftc
modifier|*
name|isp
decl_stmt|;
block|{
name|sdparam
modifier|*
name|sdp
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
name|int
name|i
decl_stmt|,
name|l
decl_stmt|;
name|ISP_LOCKVAL_DECL
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
name|isp_fibre_init
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return;
block|}
name|sdp
operator|=
name|isp
operator|->
name|isp_param
expr_stmt|;
comment|/* 	 * Try and figure out if we're connected to a differential bus. 	 * You have to pause the RISC processor to read SXP registers. 	 * 	 * This, by the way, is likely broken in that it should be 	 * getting this info from NVRAM settings too. 	 */
name|ISP_LOCK
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_PAUSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|SXP_PINS_DIFF
argument_list|)
operator|&
name|SXP_PINS_DIFF_SENSE
condition|)
block|{
name|sdp
operator|->
name|isp_diffmode
operator|=
literal|1
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s: Differential Mode\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Force pullups on. 		 */
name|sdp
operator|->
name|isp_req_ack_active_neg
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|isp_data_line_active_neg
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|isp_diffmode
operator|=
literal|0
expr_stmt|;
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_RELEASE
argument_list|)
expr_stmt|;
comment|/* release paused processor */
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_GET_INIT_SCSI_ID
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"failed to get initiator id"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|!=
name|sdp
operator|->
name|isp_initiator_id
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: setting Initiator ID to %d\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|sdp
operator|->
name|isp_initiator_id
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_INIT_SCSI_ID
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|sdp
operator|->
name|isp_initiator_id
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"failed to set initiator id"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|IDPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"%s: leaving Initiator ID at %d\n"
operator|,
name|isp
operator|->
name|isp_name
operator|,
name|sdp
operator|->
name|isp_initiator_id
operator|)
argument_list|)
expr_stmt|;
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_RETRY_COUNT
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|sdp
operator|->
name|isp_retry_count
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdp
operator|->
name|isp_retry_delay
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"failed to set retry count and delay"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_ASYNC_DATA_SETUP_TIME
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|sdp
operator|->
name|isp_async_data_setup
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"failed to set async data setup time"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_ACTIVE_NEG_STATE
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|sdp
operator|->
name|isp_req_ack_active_neg
operator|<<
literal|4
operator|)
operator||
operator|(
name|sdp
operator|->
name|isp_data_line_active_neg
operator|<<
literal|5
operator|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"failed to set active neg state"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_TAG_AGE_LIMIT
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|sdp
operator|->
name|isp_tag_aging
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"failed to set tag age limit"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_SELECT_TIMEOUT
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|sdp
operator|->
name|isp_selection_timeout
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"failed to set selection timeout"
argument_list|)
expr_stmt|;
return|return;
block|}
name|IDPRINTF
argument_list|(
literal|2
argument_list|,
operator|(
literal|"%s: devparm, W=wide, S=sync, T=Tag\n"
operator|,
name|isp
operator|->
name|isp_name
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_TARGETS
condition|;
name|i
operator|++
control|)
block|{
name|char
name|bz
index|[
literal|9
index|]
decl_stmt|;
name|u_int16_t
name|cj
init|=
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_period
decl_stmt|;
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|dev_flags
operator|&
name|DPARM_SYNC
condition|)
block|{
name|u_int16_t
name|x
decl_stmt|;
if|if
condition|(
name|cj
operator|==
operator|(
name|ISP_20M_SYNCPARMS
operator|&
literal|0xff
operator|)
condition|)
block|{
name|x
operator|=
literal|20
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cj
operator|==
operator|(
name|ISP_10M_SYNCPARMS
operator|&
literal|0xff
operator|)
condition|)
block|{
name|x
operator|=
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cj
operator|==
operator|(
name|ISP_08M_SYNCPARMS
operator|&
literal|0xff
operator|)
condition|)
block|{
name|x
operator|=
literal|8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cj
operator|==
operator|(
name|ISP_05M_SYNCPARMS
operator|&
literal|0xff
operator|)
condition|)
block|{
name|x
operator|=
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cj
operator|==
operator|(
name|ISP_04M_SYNCPARMS
operator|&
literal|0xff
operator|)
condition|)
block|{
name|x
operator|=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|x
condition|)
name|sprintf
argument_list|(
name|bz
argument_list|,
literal|"%02dMHz:"
argument_list|,
name|x
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|bz
argument_list|,
literal|"?%04x:"
argument_list|,
name|cj
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sprintf
argument_list|(
name|bz
argument_list|,
literal|"Async:"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|dev_flags
operator|&
name|DPARM_WIDE
condition|)
name|bz
index|[
literal|6
index|]
operator|=
literal|'W'
expr_stmt|;
else|else
name|bz
index|[
literal|6
index|]
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|dev_flags
operator|&
name|DPARM_TQING
condition|)
name|bz
index|[
literal|7
index|]
operator|=
literal|'T'
expr_stmt|;
else|else
name|bz
index|[
literal|7
index|]
operator|=
literal|' '
expr_stmt|;
name|bz
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
name|IDPRINTF
argument_list|(
literal|2
argument_list|,
operator|(
literal|" id%x:%s"
operator|,
name|i
operator|,
name|bz
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|&
literal|0x3
operator|)
operator|==
literal|0
condition|)
name|IDPRINTF
argument_list|(
literal|2
argument_list|,
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|dev_enable
operator|==
literal|0
condition|)
continue|continue;
comment|/* 		 * It is not safe to run the 1020 in ultra mode. 		 */
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|==
name|ISP_HA_SCSI_1020
operator|&&
name|cj
operator|==
operator|(
name|ISP_20M_SYNCPARMS
operator|&
literal|0xff
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: an ISP1020 set to Ultra Speed- derating.\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_offset
operator|=
name|ISP_10M_SYNCPARMS
operator|>>
literal|8
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_period
operator|=
name|ISP_10M_SYNCPARMS
operator|&
literal|0xff
expr_stmt|;
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_TARGET_PARAMS
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|i
operator|<<
literal|8
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|dev_flags
operator|<<
literal|8
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
operator|(
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_offset
operator|<<
literal|8
operator|)
operator||
operator|(
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_period
operator|)
expr_stmt|;
name|IDPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"\n%s: target %d flags %x offset %x period %x\n"
operator|,
name|isp
operator|->
name|isp_name
operator|,
name|i
operator|,
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|dev_flags
operator|,
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_offset
operator|,
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_period
operator|)
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: failed to set parameters for target %d\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s: flags %x offset %x period %x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|dev_flags
argument_list|,
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_offset
argument_list|,
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_period
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_TARGET_PARAMS
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|i
operator|<<
literal|8
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|DPARM_DEFAULT
operator|<<
literal|8
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|ISP_10M_SYNCPARMS
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s: failed even to set defaults\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
for|for
control|(
name|l
operator|=
literal|0
init|;
name|l
operator|<
name|MAX_LUNS
condition|;
name|l
operator|++
control|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_DEV_QUEUE_PARAMS
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
operator|(
name|i
operator|<<
literal|8
operator|)
operator||
name|l
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|sdp
operator|->
name|isp_max_queue_depth
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|exc_throttle
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"failed to set device queue "
literal|"parameters"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
comment|/* 	 * Set up DMA for the request and result mailboxes. 	 */
if|if
condition|(
name|ISP_MBOXDMASETUP
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s: can't setup dma mailboxes\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
return|return;
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_INIT_RES_QUEUE
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|isp
operator|->
name|isp_result_dma
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|isp
operator|->
name|isp_result_dma
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"set of response queue failed"
argument_list|)
expr_stmt|;
return|return;
block|}
name|isp
operator|->
name|isp_residx
operator|=
literal|0
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_INIT_REQ_QUEUE
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"set of request queue failed"
argument_list|)
expr_stmt|;
return|return;
block|}
name|isp
operator|->
name|isp_reqidx
operator|=
literal|0
expr_stmt|;
comment|/*	 	 * Unfortunately, this is the only way right now for 	 * forcing a sync renegotiation. If we boot off of 	 * an Alpha, it's put the chip in SYNC mode, but we 	 * haven't necessarily set up the parameters the 	 * same, so we'll have to yank the reset line to 	 * get everyone to renegotiate. 	 */
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_BUS_RESET
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"SCSI bus reset failed"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * This is really important to have set after a bus reset. 	 */
name|isp
operator|->
name|isp_sendmarker
operator|=
literal|1
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
name|isp
operator|->
name|isp_state
operator|=
name|ISP_INITSTATE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_fibre_init
parameter_list|(
name|isp
parameter_list|)
name|struct
name|ispsoftc
modifier|*
name|isp
decl_stmt|;
block|{
name|fcparam
modifier|*
name|fcp
decl_stmt|;
name|isp_icb_t
modifier|*
name|icbp
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
name|int
name|count
decl_stmt|;
name|u_int8_t
name|lwfs
decl_stmt|;
name|ISP_LOCKVAL_DECL
expr_stmt|;
name|fcp
operator|=
name|isp
operator|->
name|isp_param
expr_stmt|;
name|fcp
operator|->
name|isp_retry_count
operator|=
literal|0
expr_stmt|;
name|fcp
operator|->
name|isp_retry_delay
operator|=
literal|1
expr_stmt|;
name|ISP_LOCK
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_RETRY_COUNT
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|fcp
operator|->
name|isp_retry_count
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
name|fcp
operator|->
name|isp_retry_delay
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"failed to set retry count and delay"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ISP_MBOXDMASETUP
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s: can't setup DMA for mailboxes\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
return|return;
block|}
name|icbp
operator|=
operator|(
name|isp_icb_t
operator|*
operator|)
name|fcp
operator|->
name|isp_scratch
expr_stmt|;
name|bzero
argument_list|(
name|icbp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|icbp
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|icbp->icb_maxfrmlen = ICB_DFLT_FRMLEN; 	MAKE_NODE_NAME(isp, icbp); 	icbp->icb_rqstqlen = RQUEST_QUEUE_LEN(isp); 	icbp->icb_rsltqlen = RESULT_QUEUE_LEN(isp); 	icbp->icb_rqstaddr[0] = (u_int16_t) (isp->isp_rquest_dma& 0xffff); 	icbp->icb_rqstaddr[1] = (u_int16_t) (isp->isp_rquest_dma>> 16); 	icbp->icb_respaddr[0] = (u_int16_t) (isp->isp_result_dma& 0xffff); 	icbp->icb_respaddr[1] = (u_int16_t) (isp->isp_result_dma>> 16);
endif|#
directive|endif
name|icbp
operator|->
name|icb_version
operator|=
literal|1
expr_stmt|;
name|icbp
operator|->
name|icb_maxfrmlen
operator|=
name|ICB_DFLT_FRMLEN
expr_stmt|;
name|icbp
operator|->
name|icb_maxalloc
operator|=
literal|256
expr_stmt|;
name|icbp
operator|->
name|icb_execthrottle
operator|=
literal|16
expr_stmt|;
name|icbp
operator|->
name|icb_retry_delay
operator|=
literal|5
expr_stmt|;
name|icbp
operator|->
name|icb_retry_count
operator|=
literal|0
expr_stmt|;
name|MAKE_NODE_NAME
argument_list|(
name|isp
argument_list|,
name|icbp
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_rqstqlen
operator|=
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_rsltqlen
operator|=
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_rqstaddr
index|[
literal|0
index|]
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_rqstaddr
index|[
literal|1
index|]
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|isp
operator|->
name|isp_rquest_dma
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_respaddr
index|[
literal|0
index|]
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|isp
operator|->
name|isp_result_dma
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|icbp
operator|->
name|icb_respaddr
index|[
literal|1
index|]
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|isp
operator|->
name|isp_result_dma
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_INIT_FIRMWARE
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|fcp
operator|->
name|isp_scdma
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"INIT FIRMWARE failed"
argument_list|)
expr_stmt|;
return|return;
block|}
name|isp
operator|->
name|isp_reqidx
operator|=
literal|0
expr_stmt|;
name|isp
operator|->
name|isp_residx
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Wait up to 3 seconds for FW to go to READY state. 	 * 	 * This is all very much not right. The problem here 	 * is that the cable may not be plugged in, or there 	 * may be many many members of the loop that haven't 	 * been logged into. 	 * 	 * This model of doing things doesn't support dynamic 	 * attachment, so we just plain lose (for now). 	 */
name|lwfs
operator|=
name|FW_CONFIG_WAIT
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
literal|3000
condition|;
name|count
operator|++
control|)
block|{
name|isp_fw_state
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwfs
operator|!=
name|fcp
operator|->
name|isp_fwstate
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: Firmware State %s -> %s\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|fw_statename
argument_list|(
name|lwfs
argument_list|)
argument_list|,
name|fw_statename
argument_list|(
name|fcp
operator|->
name|isp_fwstate
argument_list|)
argument_list|)
expr_stmt|;
name|lwfs
operator|=
name|fcp
operator|->
name|isp_fwstate
expr_stmt|;
block|}
if|if
condition|(
name|fcp
operator|->
name|isp_fwstate
operator|==
name|FW_READY
condition|)
block|{
break|break;
block|}
name|SYS_DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* wait one millisecond */
block|}
name|isp
operator|->
name|isp_sendmarker
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Get our Loop ID 	 * (if possible) 	 */
if|if
condition|(
name|fcp
operator|->
name|isp_fwstate
operator|==
name|FW_READY
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_GET_LOOP_ID
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"GET LOOP ID failed"
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
return|return;
block|}
name|fcp
operator|->
name|isp_loopid
operator|=
name|mbs
operator|.
name|param
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|fcp
operator|->
name|isp_loopid
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: Loop ID 0x%x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|fcp
operator|->
name|isp_loopid
argument_list|)
expr_stmt|;
block|}
name|isp
operator|->
name|isp_state
operator|=
name|ISP_INITSTATE
expr_stmt|;
block|}
name|ISP_UNLOCK
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Free any associated resources prior to decommissioning.  */
end_comment

begin_function
name|void
name|isp_uninit
parameter_list|(
name|isp
parameter_list|)
name|struct
name|ispsoftc
modifier|*
name|isp
decl_stmt|;
block|{
name|STOP_WATCHDOG
argument_list|(
name|isp_watch
argument_list|,
name|isp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * start an xfer  */
end_comment

begin_function
name|int32_t
name|ispscsicmd
parameter_list|(
name|xs
parameter_list|)
name|ISP_SCSI_XFER_T
modifier|*
name|xs
decl_stmt|;
block|{
name|struct
name|ispsoftc
modifier|*
name|isp
decl_stmt|;
name|u_int8_t
name|iptr
decl_stmt|,
name|optr
decl_stmt|;
union|union
block|{
name|ispreq_t
modifier|*
name|_reqp
decl_stmt|;
name|ispreqt2_t
modifier|*
name|_t2reqp
decl_stmt|;
block|}
name|_u
union|;
define|#
directive|define
name|reqp
value|_u._reqp
define|#
directive|define
name|t2reqp
value|_u._t2reqp
define|#
directive|define
name|UZSIZE
value|max(sizeof (ispreq_t), sizeof (ispreqt2_t))
name|int
name|i
decl_stmt|;
name|ISP_LOCKVAL_DECL
expr_stmt|;
name|XS_INITERR
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|isp
operator|=
name|XS_ISP
argument_list|(
name|xs
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
if|if
condition|(
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
operator|>
literal|12
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: unsupported cdb length for fibre (%d)\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
block|}
name|optr
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX4
argument_list|)
expr_stmt|;
name|iptr
operator|=
name|isp
operator|->
name|isp_reqidx
expr_stmt|;
name|reqp
operator|=
operator|(
name|ispreq_t
operator|*
operator|)
name|ISP_QUEUE_ENTRY
argument_list|(
name|isp
operator|->
name|isp_rquest
argument_list|,
name|iptr
argument_list|)
expr_stmt|;
name|iptr
operator|=
operator|(
name|iptr
operator|+
literal|1
operator|)
operator|&
operator|(
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|iptr
operator|==
name|optr
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: Request Queue Overflow\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_EAGAIN
operator|)
return|;
block|}
name|ISP_LOCK
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
name|DISABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_sendmarker
condition|)
block|{
name|ispmarkreq_t
modifier|*
name|marker
init|=
operator|(
name|ispmarkreq_t
operator|*
operator|)
name|reqp
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|marker
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|marker
argument_list|)
argument_list|)
expr_stmt|;
name|marker
operator|->
name|req_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
name|marker
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_MARKER
expr_stmt|;
name|marker
operator|->
name|req_modifier
operator|=
name|SYNC_ALL
expr_stmt|;
name|isp
operator|->
name|isp_sendmarker
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|iptr
operator|+
literal|1
operator|)
operator|&
operator|(
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
operator|-
literal|1
operator|)
operator|)
operator|==
name|optr
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX4
argument_list|,
name|iptr
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_reqidx
operator|=
name|iptr
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
name|ENABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s: Request Queue Overflow+\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_EAGAIN
operator|)
return|;
block|}
name|reqp
operator|=
operator|(
name|ispreq_t
operator|*
operator|)
name|ISP_QUEUE_ENTRY
argument_list|(
name|isp
operator|->
name|isp_rquest
argument_list|,
name|iptr
argument_list|)
expr_stmt|;
name|iptr
operator|=
operator|(
name|iptr
operator|+
literal|1
operator|)
operator|&
operator|(
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|reqp
argument_list|,
name|UZSIZE
argument_list|)
expr_stmt|;
name|reqp
operator|->
name|req_header
operator|.
name|rqs_entry_count
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
name|reqp
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_T2RQS
expr_stmt|;
block|}
else|else
block|{
name|reqp
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_REQUEST
expr_stmt|;
block|}
name|reqp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|=
literal|0
expr_stmt|;
name|reqp
operator|->
name|req_header
operator|.
name|rqs_seqno
operator|=
name|isp
operator|->
name|isp_seqno
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isp
operator|->
name|isp_xflist
index|[
name|i
index|]
operator|==
name|NULL
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
name|ENABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s: ran out of xflist pointers?????\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_EAGAIN
operator|)
return|;
block|}
else|else
block|{
comment|/* 		 * Never have a handle that is zero, so 		 * set req_handle off by one. 		 */
name|isp
operator|->
name|isp_xflist
index|[
name|i
index|]
operator|=
name|xs
expr_stmt|;
name|reqp
operator|->
name|req_handle
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
comment|/* 		 * See comment in isp_intr 		 */
name|XS_RESID
argument_list|(
name|xs
argument_list|)
operator|=
literal|0
expr_stmt|;
comment|/* 		 * Fibre Channel always requires some kind of tag. 		 */
if|if
condition|(
name|XS_POLLDCMD
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|t2reqp
operator|->
name|req_flags
operator|=
name|REQFLAG_STAG
expr_stmt|;
block|}
else|else
block|{
name|t2reqp
operator|->
name|req_flags
operator|=
name|REQFLAG_OTAG
expr_stmt|;
block|}
block|}
else|else
block|{
name|sdparam
modifier|*
name|sdp
init|=
operator|(
name|sdparam
operator|*
operator|)
name|isp
operator|->
name|isp_param
decl_stmt|;
if|if
condition|(
operator|(
name|sdp
operator|->
name|isp_devparam
index|[
name|XS_TGT
argument_list|(
name|xs
argument_list|)
index|]
operator|.
name|dev_flags
operator|&
name|DPARM_TQING
operator|)
operator|&&
operator|(
name|XS_POLLDCMD
argument_list|(
name|xs
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|reqp
operator|->
name|req_flags
operator|=
name|REQFLAG_OTAG
expr_stmt|;
block|}
else|else
block|{
name|reqp
operator|->
name|req_flags
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|reqp
operator|->
name|req_lun_trn
operator|=
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|reqp
operator|->
name|req_target
operator|=
name|XS_TGT
argument_list|(
name|xs
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
block|{
name|reqp
operator|->
name|req_cdblen
operator|=
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
name|bcopy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
argument_list|,
name|reqp
operator|->
name|req_cdb
argument_list|,
name|XS_CDBLEN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|IDPRINTF
argument_list|(
literal|6
argument_list|,
operator|(
literal|"%s(%d.%d): START%d cmd 0x%x datalen %d\n"
operator|,
name|isp
operator|->
name|isp_name
operator|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
operator|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
operator|,
name|reqp
operator|->
name|req_header
operator|.
name|rqs_seqno
operator|,
operator|*
operator|(
name|u_char
operator|*
operator|)
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
operator|,
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|reqp
operator|->
name|req_time
operator|=
name|XS_TIME
argument_list|(
name|xs
argument_list|)
operator|/
literal|1000
expr_stmt|;
if|if
condition|(
name|reqp
operator|->
name|req_time
operator|==
literal|0
operator|&&
name|XS_TIME
argument_list|(
name|xs
argument_list|)
condition|)
name|reqp
operator|->
name|req_time
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ISP_DMASETUP
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|reqp
argument_list|,
operator|&
name|iptr
argument_list|,
name|optr
argument_list|)
condition|)
block|{
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
name|ENABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
block|}
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX4
argument_list|,
name|iptr
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_reqidx
operator|=
name|iptr
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
name|ENABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_nactive
operator|++
expr_stmt|;
if|if
condition|(
name|XS_POLLDCMD
argument_list|(
name|xs
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ISP_UNLOCK
expr_stmt|;
return|return
operator|(
name|CMD_QUEUED
operator|)
return|;
block|}
comment|/* 	 * If we can't use interrupts, poll on completion. 	 */
if|if
condition|(
name|isp_poll
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|XS_TIME
argument_list|(
name|xs
argument_list|)
argument_list|)
condition|)
block|{
comment|/* 		 * If no other error occurred but we didn't finish, 		 * something bad happened. 		 */
if|if
condition|(
name|XS_IS_CMD_DONE
argument_list|(
name|xs
argument_list|)
operator|==
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_nactive
operator|--
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_nactive
operator|<
literal|0
condition|)
name|isp
operator|->
name|isp_nactive
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|isp_lostcmd
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|reqp
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ISP_UNLOCK
expr_stmt|;
return|return
operator|(
name|CMD_COMPLETE
operator|)
return|;
undef|#
directive|undef
name|reqp
undef|#
directive|undef
name|t2reqp
block|}
end_function

begin_comment
comment|/*  * Interrupt Service Routine(s)  */
end_comment

begin_function
name|int
name|isp_poll
parameter_list|(
name|isp
parameter_list|,
name|xs
parameter_list|,
name|mswait
parameter_list|)
name|struct
name|ispsoftc
modifier|*
name|isp
decl_stmt|;
name|ISP_SCSI_XFER_T
modifier|*
name|xs
decl_stmt|;
name|int
name|mswait
decl_stmt|;
block|{
while|while
condition|(
name|mswait
condition|)
block|{
comment|/* Try the interrupt handling routine */
operator|(
name|void
operator|)
name|isp_intr
argument_list|(
operator|(
name|void
operator|*
operator|)
name|isp
argument_list|)
expr_stmt|;
comment|/* See if the xs is now done */
if|if
condition|(
name|XS_IS_CMD_DONE
argument_list|(
name|xs
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|SYS_DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* wait one millisecond */
name|mswait
operator|--
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|isp_intr
parameter_list|(
name|arg
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|ISP_SCSI_XFER_T
modifier|*
name|xs
decl_stmt|;
name|struct
name|ispsoftc
modifier|*
name|isp
init|=
name|arg
decl_stmt|;
name|u_int16_t
name|iptr
decl_stmt|,
name|optr
decl_stmt|,
name|isr
decl_stmt|;
name|isr
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_ISR
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
if|if
condition|(
name|isr
operator|==
literal|0
operator|||
operator|(
name|isr
operator|&
name|BIU2100_ISR_RISC_INT
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|isr
condition|)
block|{
name|IDPRINTF
argument_list|(
literal|4
argument_list|,
operator|(
literal|"%s: isp_intr isr=%x\n"
operator|,
name|isp
operator|->
name|isp_name
operator|,
name|isr
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|isr
operator|==
literal|0
operator|||
operator|(
name|isr
operator|&
name|BIU_ISR_RISC_INT
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|isr
condition|)
block|{
name|IDPRINTF
argument_list|(
literal|4
argument_list|,
operator|(
literal|"%s: isp_intr isr=%x\n"
operator|,
name|isp
operator|->
name|isp_name
operator|,
name|isr
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|optr
operator|=
name|isp
operator|->
name|isp_residx
expr_stmt|;
if|if
condition|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|)
operator|&
literal|1
condition|)
block|{
name|u_int16_t
name|mbox0
init|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|mbox0
condition|)
block|{
case|case
name|ASYNC_BUS_RESET
case|:
case|case
name|ASYNC_TIMEOUT_RESET
case|:
name|PRINTF
argument_list|(
literal|"%s: bus or timeout reset\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_sendmarker
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ASYNC_LIP_OCCURRED
case|:
name|PRINTF
argument_list|(
literal|"%s: LIP occurred\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_LOOP_UP
case|:
name|PRINTF
argument_list|(
literal|"%s: Loop UP\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_LOOP_DOWN
case|:
name|PRINTF
argument_list|(
literal|"%s: Loop DOWN\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_LOOP_RESET
case|:
name|PRINTF
argument_list|(
literal|"%s: Loop RESET\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
break|break;
default|default:
name|PRINTF
argument_list|(
literal|"%s: async %x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|mbox0
argument_list|)
expr_stmt|;
break|break;
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_CLEAR_RISC_INT
argument_list|)
expr_stmt|;
name|iptr
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX5
argument_list|)
expr_stmt|;
if|if
condition|(
name|optr
operator|==
name|iptr
condition|)
block|{
name|IDPRINTF
argument_list|(
literal|4
argument_list|,
operator|(
literal|"why intr? isr %x iptr %x optr %x\n"
operator|,
name|isr
operator|,
name|optr
operator|,
name|iptr
operator|)
argument_list|)
expr_stmt|;
block|}
name|ENABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
while|while
condition|(
name|optr
operator|!=
name|iptr
condition|)
block|{
name|ispstatusreq_t
modifier|*
name|sp
decl_stmt|;
name|int
name|buddaboom
init|=
literal|0
decl_stmt|;
name|sp
operator|=
operator|(
name|ispstatusreq_t
operator|*
operator|)
name|ISP_QUEUE_ENTRY
argument_list|(
name|isp
operator|->
name|isp_result
argument_list|,
name|optr
argument_list|)
expr_stmt|;
name|optr
operator|=
operator|(
name|optr
operator|+
literal|1
operator|)
operator|&
operator|(
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|!=
name|RQSTYPE_RESPONSE
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: not RESPONSE in RESPONSE Queue (0x%x)\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|sp
operator|->
name|req_header
operator|.
name|rqs_entry_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|!=
name|RQSTYPE_REQUEST
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX5
argument_list|,
name|optr
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|buddaboom
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
literal|0xf
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
name|RQSFLAG_CONTINUATION
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX5
argument_list|,
name|optr
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|PRINTF
argument_list|(
literal|"%s: rqs_flags=%x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|sp
operator|->
name|req_header
operator|.
name|rqs_flags
operator|&
literal|0xf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_handle
operator|>
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
operator|||
name|sp
operator|->
name|req_handle
operator|<
literal|1
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: bad request handle %d\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|sp
operator|->
name|req_handle
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX5
argument_list|,
name|optr
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|xs
operator|=
operator|(
name|ISP_SCSI_XFER_T
operator|*
operator|)
name|isp
operator|->
name|isp_xflist
index|[
name|sp
operator|->
name|req_handle
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|xs
operator|==
name|NULL
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: NULL xs in xflist\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX5
argument_list|,
name|optr
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|isp
operator|->
name|isp_xflist
index|[
name|sp
operator|->
name|req_handle
operator|-
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_BUS_RESET
condition|)
block|{
name|isp
operator|->
name|isp_sendmarker
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|buddaboom
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
name|XS_STS
argument_list|(
name|xs
argument_list|)
operator|=
name|sp
operator|->
name|req_scsi_status
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
block|{
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_SENSE
condition|)
block|{
name|bcopy
argument_list|(
name|sp
operator|->
name|req_sense_data
argument_list|,
name|XS_SNSP
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_SNSLEN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|XS_SNS_IS_VALID
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|XS_STS
argument_list|(
name|xs
argument_list|)
operator|==
name|SCSI_CHECK
condition|)
block|{
name|XS_SNS_IS_VALID
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sp
operator|->
name|req_sense_data
argument_list|,
name|XS_SNSP
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_SNSLEN
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|->
name|req_state_flags
operator||=
name|RQSF_GOT_SENSE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
operator|&&
name|XS_STS
argument_list|(
name|xs
argument_list|)
operator|==
name|SCSI_BUSY
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_TGTBSY
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sp
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|==
name|RQSTYPE_RESPONSE
condition|)
block|{
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
operator|&&
name|sp
operator|->
name|req_completion_status
condition|)
name|isp_parse_status
argument_list|(
name|isp
argument_list|,
name|sp
argument_list|,
name|xs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PRINTF
argument_list|(
literal|"%s: unknown return %x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|sp
operator|->
name|req_header
operator|.
name|rqs_entry_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
condition|)
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
block|{
name|XS_RESID
argument_list|(
name|xs
argument_list|)
operator|=
name|sp
operator|->
name|req_resid
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sp
operator|->
name|req_scsi_status
operator|&
name|RQCS_RU
condition|)
block|{
name|XS_RESID
argument_list|(
name|xs
argument_list|)
operator|=
name|sp
operator|->
name|req_resid
expr_stmt|;
name|IDPRINTF
argument_list|(
literal|4
argument_list|,
operator|(
literal|"%s: cnt %d rsd %d\n"
operator|,
name|isp
operator|->
name|isp_name
operator|,
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
operator|,
name|sp
operator|->
name|req_resid
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
condition|)
block|{
name|ISP_DMAFREE
argument_list|(
name|isp
argument_list|,
name|xs
argument_list|,
name|sp
operator|->
name|req_handle
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_dblev
operator|>=
literal|5
operator|)
operator|||
operator|(
name|isp
operator|->
name|isp_dblev
operator|>
literal|2
operator|&&
operator|!
name|XS_NOERR
argument_list|(
name|xs
argument_list|)
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s(%d.%d): FIN%d cmd0x%x len%d resid%d STS %x"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|sp
operator|->
name|req_header
operator|.
name|rqs_seqno
argument_list|,
operator|*
operator|(
name|u_char
operator|*
operator|)
name|XS_CDBP
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_RESID
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_STS
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_SENSE
condition|)
block|{
name|PRINTF
argument_list|(
literal|" Skey: %x"
argument_list|,
name|XS_SNSKEY
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|XS_IS_SNS_VALID
argument_list|(
name|xs
argument_list|)
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|" BUT NOT SET"
argument_list|)
expr_stmt|;
block|}
block|}
name|PRINTF
argument_list|(
literal|" XS_ERR(xs) %d\n"
argument_list|,
name|XS_ERR
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX5
argument_list|,
name|optr
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_nactive
operator|--
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_nactive
operator|<
literal|0
condition|)
name|isp
operator|->
name|isp_nactive
operator|=
literal|0
expr_stmt|;
name|XS_CMD_DONE
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
name|isp
operator|->
name|isp_residx
operator|=
name|optr
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Support routines.  */
end_comment

begin_function
specifier|static
name|void
name|isp_parse_status
parameter_list|(
name|isp
parameter_list|,
name|sp
parameter_list|,
name|xs
parameter_list|)
name|struct
name|ispsoftc
modifier|*
name|isp
decl_stmt|;
name|ispstatusreq_t
modifier|*
name|sp
decl_stmt|;
name|ISP_SCSI_XFER_T
modifier|*
name|xs
decl_stmt|;
block|{
switch|switch
condition|(
name|sp
operator|->
name|req_completion_status
condition|)
block|{
case|case
name|RQCS_COMPLETE
case|:
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
return|return;
case|case
name|RQCS_INCOMPLETE
case|:
if|if
condition|(
operator|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_TARGET
operator|)
operator|==
literal|0
condition|)
block|{
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
return|return;
block|}
name|PRINTF
argument_list|(
literal|"%s: incomplete, state %x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|sp
operator|->
name|req_state_flags
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_TRANSPORT_ERROR
case|:
name|PRINTF
argument_list|(
literal|"%s: transport error\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
name|isp_prtstst
argument_list|(
name|sp
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_DATA_OVERRUN
case|:
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
name|XS_RESID
argument_list|(
name|xs
argument_list|)
operator|=
name|sp
operator|->
name|req_resid
expr_stmt|;
break|break;
block|}
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
return|return;
case|case
name|RQCS_DATA_UNDERRUN
case|:
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
name|XS_RESID
argument_list|(
name|xs
argument_list|)
operator|=
name|sp
operator|->
name|req_resid
expr_stmt|;
comment|/* an UNDERRUN is not a botch ??? */
block|}
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_NOERROR
argument_list|)
expr_stmt|;
return|return;
case|case
name|RQCS_TIMEOUT
case|:
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_CMDTIMEOUT
argument_list|)
expr_stmt|;
return|return;
case|case
name|RQCS_RESET_OCCURRED
case|:
name|PRINTF
argument_list|(
literal|"%s: reset occurred, %d active\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|isp
operator|->
name|isp_nactive
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_sendmarker
operator|=
literal|1
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BUSRESET
argument_list|)
expr_stmt|;
return|return;
case|case
name|RQCS_ABORTED
case|:
name|PRINTF
argument_list|(
literal|"%s: command aborted\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_sendmarker
operator|=
literal|1
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_ABORTED
argument_list|)
expr_stmt|;
return|return;
case|case
name|RQCS_PORT_UNAVAILABLE
case|:
comment|/* 		 * No such port on the loop. Moral equivalent of SELTIMEO 		 */
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_SELTIMEOUT
argument_list|)
expr_stmt|;
return|return;
case|case
name|RQCS_PORT_LOGGED_OUT
case|:
name|PRINTF
argument_list|(
literal|"%s: port logout for target %d\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_PORT_CHANGED
case|:
name|PRINTF
argument_list|(
literal|"%s: port changed for target %d\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RQCS_PORT_BUSY
case|:
name|PRINTF
argument_list|(
literal|"%s: port busy for target %d\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_TGTBSY
argument_list|)
expr_stmt|;
return|return;
default|default:
name|PRINTF
argument_list|(
literal|"%s: comp status %x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|sp
operator|->
name|req_completion_status
argument_list|)
expr_stmt|;
break|break;
block|}
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|HINIB
parameter_list|(
name|x
parameter_list|)
value|((x)>> 0x4)
end_define

begin_define
define|#
directive|define
name|LONIB
parameter_list|(
name|x
parameter_list|)
value|((x)& 0xf)
end_define

begin_define
define|#
directive|define
name|MAKNIB
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(((a)<< 4) | (b))
end_define

begin_decl_stmt
specifier|static
name|u_int8_t
name|mbpcnt
index|[]
init|=
block|{
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 0x00: MBOX_NO_OP */
name|MAKNIB
argument_list|(
literal|5
argument_list|,
literal|5
argument_list|)
block|,
comment|/* 0x01: MBOX_LOAD_RAM */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x02: MBOX_EXEC_FIRMWARE */
name|MAKNIB
argument_list|(
literal|5
argument_list|,
literal|5
argument_list|)
block|,
comment|/* 0x03: MBOX_DUMP_RAM */
name|MAKNIB
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x04: MBOX_WRITE_RAM_WORD */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x05: MBOX_READ_RAM_WORD */
name|MAKNIB
argument_list|(
literal|6
argument_list|,
literal|6
argument_list|)
block|,
comment|/* 0x06: MBOX_MAILBOX_REG_TEST */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x07: MBOX_VERIFY_CHECKSUM	*/
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x08: MBOX_ABOUT_FIRMWARE */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x09: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x0a: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x0b: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x0c: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x0d: */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x0e: MBOX_CHECK_FIRMWARE */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x0f: */
name|MAKNIB
argument_list|(
literal|5
argument_list|,
literal|5
argument_list|)
block|,
comment|/* 0x10: MBOX_INIT_REQ_QUEUE */
name|MAKNIB
argument_list|(
literal|6
argument_list|,
literal|6
argument_list|)
block|,
comment|/* 0x11: MBOX_INIT_RES_QUEUE */
name|MAKNIB
argument_list|(
literal|4
argument_list|,
literal|4
argument_list|)
block|,
comment|/* 0x12: MBOX_EXECUTE_IOCB */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x13: MBOX_WAKE_UP	*/
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|6
argument_list|)
block|,
comment|/* 0x14: MBOX_STOP_FIRMWARE */
name|MAKNIB
argument_list|(
literal|4
argument_list|,
literal|4
argument_list|)
block|,
comment|/* 0x15: MBOX_ABORT */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x16: MBOX_ABORT_DEVICE */
name|MAKNIB
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x17: MBOX_ABORT_TARGET */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x18: MBOX_BUS_RESET */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x19: MBOX_STOP_QUEUE */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x1a: MBOX_START_QUEUE */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x1b: MBOX_SINGLE_STEP_QUEUE */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x1c: MBOX_ABORT_QUEUE */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|4
argument_list|)
block|,
comment|/* 0x1d: MBOX_GET_DEV_QUEUE_STATUS */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x1e: */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x1f: MBOX_GET_FIRMWARE_STATUS */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x20: MBOX_GET_INIT_SCSI_ID */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x21: MBOX_GET_SELECT_TIMEOUT */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x22: MBOX_GET_RETRY_COUNT	*/
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x23: MBOX_GET_TAG_AGE_LIMIT */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x24: MBOX_GET_CLOCK_RATE */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x25: MBOX_GET_ACT_NEG_STATE */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x26: MBOX_GET_ASYNC_DATA_SETUP_TIME */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x27: MBOX_GET_PCI_PARAMS */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|4
argument_list|)
block|,
comment|/* 0x28: MBOX_GET_TARGET_PARAMS */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|4
argument_list|)
block|,
comment|/* 0x29: MBOX_GET_DEV_QUEUE_PARAMS */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x2a: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x2b: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x2c: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x2d: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x2e: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x2f: */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x30: MBOX_SET_INIT_SCSI_ID */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x31: MBOX_SET_SELECT_TIMEOUT */
name|MAKNIB
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x32: MBOX_SET_RETRY_COUNT	*/
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x33: MBOX_SET_TAG_AGE_LIMIT */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x34: MBOX_SET_CLOCK_RATE */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x35: MBOX_SET_ACTIVE_NEG_STATE */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x36: MBOX_SET_ASYNC_DATA_SETUP_TIME */
name|MAKNIB
argument_list|(
literal|3
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x37: MBOX_SET_PCI_CONTROL_PARAMS */
name|MAKNIB
argument_list|(
literal|4
argument_list|,
literal|4
argument_list|)
block|,
comment|/* 0x38: MBOX_SET_TARGET_PARAMS */
name|MAKNIB
argument_list|(
literal|4
argument_list|,
literal|4
argument_list|)
block|,
comment|/* 0x39: MBOX_SET_DEV_QUEUE_PARAMS */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x3a: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x3b: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x3c: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x3d: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x3e: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x3f: */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|)
block|,
comment|/* 0x40: MBOX_RETURN_BIOS_BLOCK_ADDR */
name|MAKNIB
argument_list|(
literal|6
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 0x41: MBOX_WRITE_FOUR_RAM_WORDS */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|3
argument_list|)
block|,
comment|/* 0x42: MBOX_EXEC_BIOS_IOCB */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x43: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x44: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x45: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x46: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x47: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x48: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x49: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x4a: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x4b: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x4c: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x4d: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x4e: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x4f: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x50: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x51: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x52: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x53: */
name|MAKNIB
argument_list|(
literal|8
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x54: MBOX_EXEC_COMMAND_IOCB_A64 */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x55: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x56: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x57: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x58: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x59: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x5a: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x5b: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x5c: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x5d: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x5e: */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x5f: */
name|MAKNIB
argument_list|(
literal|8
argument_list|,
literal|6
argument_list|)
block|,
comment|/* 0x60: MBOX_INIT_FIRMWARE */
name|MAKNIB
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 0x60: MBOX_GET_INIT_CONTROL_BLOCK  (FORMAT?) */
name|MAKNIB
argument_list|(
literal|2
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 0x62: MBOX_INIT_LIP */
name|MAKNIB
argument_list|(
literal|8
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 0x63: MBOX_GET_FC_AL_POSITION_MAP */
name|MAKNIB
argument_list|(
literal|8
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 0x64: MBOX_GET_PORT_DB */
name|MAKNIB
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 0x65: MBOX_CLEAR_ACA */
name|MAKNIB
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 0x66: MBOX_TARGET_RESET */
name|MAKNIB
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 0x67: MBOX_CLEAR_TASK_SET */
name|MAKNIB
argument_list|(
literal|3
argument_list|,
literal|1
argument_list|)
block|,
comment|/* 0x69: MBOX_ABORT_TASK_SET */
name|MAKNIB
argument_list|(
literal|1
argument_list|,
literal|2
argument_list|)
comment|/* 0x69: MBOX_GET_FW_STATE */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NMBCOM
value|(sizeof (mbpcnt) / sizeof (mbpcnt[0]))
end_define

begin_function
specifier|static
name|void
name|isp_mboxcmd
parameter_list|(
name|isp
parameter_list|,
name|mbp
parameter_list|)
name|struct
name|ispsoftc
modifier|*
name|isp
decl_stmt|;
name|mbreg_t
modifier|*
name|mbp
decl_stmt|;
block|{
name|int
name|outparam
decl_stmt|,
name|inparam
decl_stmt|;
name|int
name|loops
decl_stmt|;
name|u_int8_t
name|opcode
decl_stmt|;
if|if
condition|(
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|==
name|ISP2100_SET_PCI_PARAM
condition|)
block|{
name|opcode
operator|=
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_SET_PCI_PARAMETERS
expr_stmt|;
name|inparam
operator|=
literal|4
expr_stmt|;
name|outparam
operator|=
literal|4
expr_stmt|;
goto|goto
name|command_known
goto|;
block|}
elseif|else
if|if
condition|(
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|>
name|NMBCOM
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: bad command %x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|opcode
operator|=
name|mbp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
name|inparam
operator|=
name|HINIB
argument_list|(
name|mbpcnt
index|[
name|mbp
operator|->
name|param
index|[
literal|0
index|]
index|]
argument_list|)
expr_stmt|;
name|outparam
operator|=
name|LONIB
argument_list|(
name|mbpcnt
index|[
name|mbp
operator|->
name|param
index|[
literal|0
index|]
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|inparam
operator|==
literal|0
operator|&&
name|outparam
operator|==
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: no parameters for %x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|command_known
label|:
comment|/* 	 * Make sure we can send some words.. 	 */
name|loops
operator|=
name|MBOX_DELAY_COUNT
expr_stmt|;
while|while
condition|(
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|)
operator|&
name|HCCR_HOST_INT
operator|)
operator|!=
literal|0
condition|)
block|{
name|SYS_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|loops
operator|<
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: isp_mboxcmd timeout #1\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* 	 * Write input parameters 	 */
switch|switch
condition|(
name|inparam
condition|)
block|{
case|case
literal|8
case|:
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX7
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|mbp
operator|->
name|param
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
case|case
literal|7
case|:
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX6
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|mbp
operator|->
name|param
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
case|case
literal|6
case|:
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX5
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|mbp
operator|->
name|param
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
case|case
literal|5
case|:
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX4
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|mbp
operator|->
name|param
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
case|case
literal|4
case|:
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX3
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|mbp
operator|->
name|param
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
case|case
literal|3
case|:
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX2
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|mbp
operator|->
name|param
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
case|case
literal|2
case|:
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX1
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|mbp
operator|->
name|param
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
case|case
literal|1
case|:
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|INMAILBOX0
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * Clear semaphore on mailbox registers 	 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Clear RISC int condition. 	 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_CLEAR_RISC_INT
argument_list|)
expr_stmt|;
comment|/* 	 * Set Host Interrupt condition so that RISC will pick up mailbox regs. 	 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_SET_HOST_INT
argument_list|)
expr_stmt|;
comment|/* 	 * Wait until RISC int is set, except 2100 	 */
if|if
condition|(
operator|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
operator|)
operator|==
literal|0
condition|)
block|{
name|loops
operator|=
name|MBOX_DELAY_COUNT
expr_stmt|;
while|while
condition|(
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_ISR
argument_list|)
operator|&
name|BIU_ISR_RISC_INT
operator|)
operator|==
literal|0
condition|)
block|{
name|SYS_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|loops
operator|<
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: isp_mboxcmd timeout #2\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
comment|/* 	 * Check to make sure that the semaphore has been set. 	 */
name|loops
operator|=
name|MBOX_DELAY_COUNT
expr_stmt|;
while|while
condition|(
operator|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|)
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|SYS_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|loops
operator|<
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: isp_mboxcmd timeout #3\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* 	 * Make sure that the MBOX_BUSY has gone away 	 */
name|loops
operator|=
name|MBOX_DELAY_COUNT
expr_stmt|;
while|while
condition|(
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|)
operator|==
name|MBOX_BUSY
condition|)
block|{
name|SYS_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|loops
operator|<
literal|0
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: isp_mboxcmd timeout #4\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* 	 * Pick up output parameters. 	 */
switch|switch
condition|(
name|outparam
condition|)
block|{
case|case
literal|8
case|:
name|mbp
operator|->
name|param
index|[
literal|7
index|]
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX7
argument_list|)
expr_stmt|;
case|case
literal|7
case|:
name|mbp
operator|->
name|param
index|[
literal|6
index|]
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX6
argument_list|)
expr_stmt|;
case|case
literal|6
case|:
name|mbp
operator|->
name|param
index|[
literal|5
index|]
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX5
argument_list|)
expr_stmt|;
case|case
literal|5
case|:
name|mbp
operator|->
name|param
index|[
literal|4
index|]
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX4
argument_list|)
expr_stmt|;
case|case
literal|4
case|:
name|mbp
operator|->
name|param
index|[
literal|3
index|]
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX3
argument_list|)
expr_stmt|;
case|case
literal|3
case|:
name|mbp
operator|->
name|param
index|[
literal|2
index|]
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX2
argument_list|)
expr_stmt|;
case|case
literal|2
case|:
name|mbp
operator|->
name|param
index|[
literal|1
index|]
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX1
argument_list|)
expr_stmt|;
case|case
literal|1
case|:
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Clear RISC int. 	 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_CLEAR_RISC_INT
argument_list|)
expr_stmt|;
comment|/* 	 * Release semaphore on mailbox registers 	 */
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Just to be chatty here... 	 */
switch|switch
condition|(
name|mbp
operator|->
name|param
index|[
literal|0
index|]
condition|)
block|{
case|case
name|MBOX_COMMAND_COMPLETE
case|:
break|break;
case|case
name|MBOX_INVALID_COMMAND
case|:
comment|/* 		 * GET_CLOCK_RATE can fail a lot 		 * So can a couple of other commands. 		 */
if|if
condition|(
name|isp
operator|->
name|isp_dblev
operator|>
literal|2
operator|&&
name|opcode
operator|!=
name|MBOX_GET_CLOCK_RATE
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: mbox cmd %x failed with INVALID_COMMAND\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MBOX_HOST_INTERFACE_ERROR
case|:
name|PRINTF
argument_list|(
literal|"%s: mbox cmd %x failed with HOST_INTERFACE_ERROR\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
break|break;
case|case
name|MBOX_TEST_FAILED
case|:
name|PRINTF
argument_list|(
literal|"%s: mbox cmd %x failed with TEST_FAILED\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
break|break;
case|case
name|MBOX_COMMAND_ERROR
case|:
name|PRINTF
argument_list|(
literal|"%s: mbox cmd %x failed with COMMAND_ERROR\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
break|break;
case|case
name|MBOX_COMMAND_PARAM_ERROR
case|:
name|PRINTF
argument_list|(
literal|"%s: mbox cmd %x failed with COMMAND_PARAM_ERROR\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASYNC_LIP_OCCURRED
case|:
break|break;
default|default:
comment|/* 		 * The expected return of EXEC_FIRMWARE is zero. 		 */
if|if
condition|(
operator|(
name|opcode
operator|==
name|MBOX_EXEC_FIRMWARE
operator|&&
name|mbp
operator|->
name|param
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|opcode
operator|!=
name|MBOX_EXEC_FIRMWARE
operator|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: mbox cmd %x failed with error %x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|opcode
argument_list|,
name|mbp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_lostcmd
parameter_list|(
name|struct
name|ispsoftc
modifier|*
name|isp
parameter_list|,
name|ISP_SCSI_XFER_T
modifier|*
name|xs
parameter_list|,
name|ispreq_t
modifier|*
name|req
parameter_list|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_GET_FIRMWARE_STATUS
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"couldn't GET FIRMWARE STATUS"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: %d commands on completion queue\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|XS_NULL
argument_list|(
name|xs
argument_list|)
condition|)
return|return;
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_GET_DEV_QUEUE_STATUS
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|XS_TGT
argument_list|(
name|xs
argument_list|)
operator|<<
literal|8
operator||
name|XS_LUN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"couldn't GET DEVICE QUEUE STATUS"
argument_list|)
expr_stmt|;
return|return;
block|}
name|PRINTF
argument_list|(
literal|"%s: lost command for target %d lun %d, %d active of %d, "
literal|"Queue State: %x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|XS_TGT
argument_list|(
name|xs
argument_list|)
argument_list|,
name|XS_LUN
argument_list|(
name|xs
argument_list|)
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|2
index|]
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|3
index|]
argument_list|,
name|mbs
operator|.
name|param
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"lost command"
argument_list|)
expr_stmt|;
comment|/* 	 * XXX: Need to try and do something to recover. 	 */
block|}
end_function

begin_function
specifier|static
name|void
name|isp_dumpregs
parameter_list|(
name|struct
name|ispsoftc
modifier|*
name|isp
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|PRINTF
argument_list|(
literal|"%s: %s\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
name|PRINTF
argument_list|(
literal|"    biu_conf1=%x"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|PRINTF
argument_list|(
literal|"    biu_csr=%x"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|" biu_icr=%x biu_isr=%x biu_sema=%x "
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_ICR
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_ISR
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"risc_hccr=%x\n"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_SCSI
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_PAUSE
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"    cdma_conf=%x cdma_sts=%x cdma_fifostat=%x\n"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|CDMA_CONF
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|CDMA_STATUS
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|CDMA_FIFO_STS
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"    ddma_conf=%x ddma_sts=%x ddma_fifostat=%x\n"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|DDMA_CONF
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|DDMA_STATUS
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|DDMA_FIFO_STS
argument_list|)
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"    sxp_int=%x sxp_gross=%x sxp(scsi_ctrl)=%x\n"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|SXP_INTERRUPT
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|SXP_GROSS_ERR
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|SXP_PINS_CONTROL
argument_list|)
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_RELEASE
argument_list|)
expr_stmt|;
block|}
name|ISP_DUMPREGS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_fw_state
parameter_list|(
name|struct
name|ispsoftc
modifier|*
name|isp
parameter_list|)
block|{
name|mbreg_t
name|mbs
decl_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
name|int
name|once
init|=
literal|0
decl_stmt|;
name|fcparam
modifier|*
name|fcp
init|=
name|isp
operator|->
name|isp_param
decl_stmt|;
name|again
label|:
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_GET_FW_STATE
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|==
name|ASYNC_LIP_OCCURRED
condition|)
block|{
if|if
condition|(
operator|!
name|once
operator|++
condition|)
block|{
goto|goto
name|again
goto|;
block|}
block|}
name|isp_dumpregs
argument_list|(
name|isp
argument_list|,
literal|"GET FIRMWARE STATE failed"
argument_list|)
expr_stmt|;
return|return;
block|}
name|fcp
operator|->
name|isp_fwstate
operator|=
name|mbs
operator|.
name|param
index|[
literal|1
index|]
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_setdparm
parameter_list|(
name|struct
name|ispsoftc
modifier|*
name|isp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|mbreg_t
name|mbs
decl_stmt|;
name|sdparam
modifier|*
name|sdp
decl_stmt|;
name|isp
operator|->
name|isp_fwrev
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
comment|/* 		 * ROM in 2100 doesn't appear to support ABOUT_FIRMWARE 		 */
return|return;
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_ABOUT_FIRMWARE
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|IDPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"1st ABOUT FIRMWARE command failed"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp
operator|->
name|isp_fwrev
operator|=
operator|(
operator|(
operator|(
name|u_int16_t
operator|)
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|)
operator|<<
literal|10
operator|)
operator|+
name|mbs
operator|.
name|param
index|[
literal|2
index|]
expr_stmt|;
block|}
name|sdp
operator|=
operator|(
name|sdparam
operator|*
operator|)
name|isp
operator|->
name|isp_param
expr_stmt|;
comment|/* 	 * Try and get old clock rate out before we hit the 	 * chip over the head- but if and only if we don't 	 * know our desired clock rate. 	 */
if|if
condition|(
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_clock
operator|==
literal|0
condition|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_GET_CLOCK_RATE
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|==
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|sdp
operator|->
name|isp_clock
operator|=
name|mbs
operator|.
name|param
index|[
literal|1
index|]
expr_stmt|;
name|PRINTF
argument_list|(
literal|"%s: using board clock 0x%x\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|,
name|sdp
operator|->
name|isp_clock
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|sdp
operator|->
name|isp_clock
operator|=
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_clock
expr_stmt|;
block|}
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_GET_ACT_NEG_STATE
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|IDPRINTF
argument_list|(
literal|2
argument_list|,
operator|(
literal|"could not GET ACT NEG STATE\n"
operator|)
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_req_ack_active_neg
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|isp_data_line_active_neg
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sdp
operator|->
name|isp_req_ack_active_neg
operator|=
operator|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0x1
expr_stmt|;
name|sdp
operator|->
name|isp_data_line_active_neg
operator|=
operator|(
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|>>
literal|5
operator|)
operator|&
literal|0x1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_TARGETS
condition|;
name|i
operator|++
control|)
block|{
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|=
name|MBOX_GET_TARGET_PARAMS
expr_stmt|;
name|mbs
operator|.
name|param
index|[
literal|1
index|]
operator|=
name|i
operator|<<
literal|8
expr_stmt|;
name|isp_mboxcmd
argument_list|(
name|isp
argument_list|,
operator|&
name|mbs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbs
operator|.
name|param
index|[
literal|0
index|]
operator|!=
name|MBOX_COMMAND_COMPLETE
condition|)
block|{
name|IDPRINTF
argument_list|(
literal|2
argument_list|,
operator|(
literal|"cannot get params for target %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_period
operator|=
name|ISP_10M_SYNCPARMS
operator|&
literal|0xff
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_offset
operator|=
name|ISP_10M_SYNCPARMS
operator|>>
literal|8
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|dev_flags
operator|=
name|DPARM_DEFAULT
expr_stmt|;
block|}
else|else
block|{
name|IDPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"\%s: target %d - flags 0x%x, sync %x\n"
operator|,
name|isp
operator|->
name|isp_name
operator|,
name|i
operator|,
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|,
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|dev_flags
operator|=
name|mbs
operator|.
name|param
index|[
literal|2
index|]
operator|>>
literal|8
expr_stmt|;
comment|/* 			 * The maximum period we can really see 			 * here is 100 (decimal), or 400 ns. 			 * For some unknown reason we sometimes 			 * get back wildass numbers from the 			 * boot device's paramaters. 			 */
if|if
condition|(
operator|(
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|&
literal|0xff
operator|)
operator|<=
literal|0x64
condition|)
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_period
operator|=
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|&
literal|0xff
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|sync_offset
operator|=
name|mbs
operator|.
name|param
index|[
literal|3
index|]
operator|>>
literal|8
expr_stmt|;
block|}
block|}
block|}
comment|/* 	 * Set Default Host Adapter Parameters 	 * XXX: Should try and get them out of NVRAM 	 */
name|sdp
operator|->
name|isp_adapter_enabled
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|isp_cmd_dma_burst_enable
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|isp_data_dma_burst_enabl
operator|=
literal|1
expr_stmt|;
name|sdp
operator|->
name|isp_fifo_threshold
operator|=
literal|2
expr_stmt|;
name|sdp
operator|->
name|isp_initiator_id
operator|=
literal|7
expr_stmt|;
name|sdp
operator|->
name|isp_async_data_setup
operator|=
literal|6
expr_stmt|;
name|sdp
operator|->
name|isp_selection_timeout
operator|=
literal|250
expr_stmt|;
name|sdp
operator|->
name|isp_max_queue_depth
operator|=
literal|128
expr_stmt|;
name|sdp
operator|->
name|isp_tag_aging
operator|=
literal|8
expr_stmt|;
name|sdp
operator|->
name|isp_bus_reset_delay
operator|=
literal|3
expr_stmt|;
name|sdp
operator|->
name|isp_retry_count
operator|=
literal|0
expr_stmt|;
name|sdp
operator|->
name|isp_retry_delay
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_TARGETS
condition|;
name|i
operator|++
control|)
block|{
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|exc_throttle
operator|=
literal|16
expr_stmt|;
name|sdp
operator|->
name|isp_devparam
index|[
name|i
index|]
operator|.
name|dev_enable
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_phoenix
parameter_list|(
name|struct
name|ispsoftc
modifier|*
name|isp
parameter_list|)
block|{
name|ISP_SCSI_XFER_T
modifier|*
name|tlist
index|[
name|MAXISPREQUEST
index|]
decl_stmt|,
modifier|*
name|xs
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|tlist
index|[
name|i
index|]
operator|=
operator|(
name|ISP_SCSI_XFER_T
operator|*
operator|)
name|isp
operator|->
name|isp_xflist
index|[
name|i
index|]
expr_stmt|;
block|}
name|isp_reset
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_init
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_state
operator|=
name|ISP_RUNSTATE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|xs
operator|=
name|tlist
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|XS_NULL
argument_list|(
name|xs
argument_list|)
condition|)
continue|continue;
name|isp
operator|->
name|isp_nactive
operator|--
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_nactive
operator|<
literal|0
condition|)
name|isp
operator|->
name|isp_nactive
operator|=
literal|0
expr_stmt|;
name|XS_RESID
argument_list|(
name|xs
argument_list|)
operator|=
name|XS_XFRLEN
argument_list|(
name|xs
argument_list|)
expr_stmt|;
name|XS_SETERR
argument_list|(
name|xs
argument_list|,
name|HBA_BOTCH
argument_list|)
expr_stmt|;
name|XS_CMD_DONE
argument_list|(
name|xs
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|isp_watch
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|ispsoftc
modifier|*
name|isp
init|=
name|arg
decl_stmt|;
name|ISP_SCSI_XFER_T
modifier|*
name|xs
decl_stmt|;
name|ISP_LOCKVAL_DECL
expr_stmt|;
comment|/* 	 * Look for completely dead commands (but not polled ones). 	 */
name|ISP_LOCK
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|xs
operator|=
operator|(
name|ISP_SCSI_XFER_T
operator|*
operator|)
name|isp
operator|->
name|isp_xflist
index|[
name|i
index|]
operator|)
operator|==
name|NULL
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|XS_POLLDCMD
argument_list|(
name|xs
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|XS_TIME
argument_list|(
name|xs
argument_list|)
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
name|XS_TIME
argument_list|(
name|xs
argument_list|)
operator|-=
operator|(
name|WATCH_INTERVAL
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* 		 * Avoid later thinking that this 		 * transaction is not being timed. 		 * Then give ourselves to watchdog 		 * periods of grace. 		 */
if|if
condition|(
name|XS_TIME
argument_list|(
name|xs
argument_list|)
operator|==
literal|0
condition|)
name|XS_TIME
argument_list|(
name|xs
argument_list|)
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|XS_TIME
argument_list|(
name|xs
argument_list|)
operator|>
operator|-
operator|(
literal|2
operator|*
name|WATCH_INTERVAL
operator|*
literal|1000
operator|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|isp_abortcmd
argument_list|(
name|isp
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|PRINTF
argument_list|(
literal|"%s: isp_watch failed to abort command\n"
argument_list|,
name|isp
operator|->
name|isp_name
argument_list|)
expr_stmt|;
name|isp_phoenix
argument_list|(
name|isp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|ISP_UNLOCK
expr_stmt|;
name|RESTART_WATCHDOG
argument_list|(
name|isp_watch
argument_list|,
name|isp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_prtstst
parameter_list|(
name|ispstatusreq_t
modifier|*
name|sp
parameter_list|)
block|{
name|PRINTF
argument_list|(
literal|"states->"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_BUS
condition|)
name|PRINTF
argument_list|(
literal|"GOT_BUS "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_TARGET
condition|)
name|PRINTF
argument_list|(
literal|"GOT_TGT "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_SENT_CDB
condition|)
name|PRINTF
argument_list|(
literal|"SENT_CDB "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_XFRD_DATA
condition|)
name|PRINTF
argument_list|(
literal|"XFRD_DATA "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_STATUS
condition|)
name|PRINTF
argument_list|(
literal|"GOT_STS "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_GOT_SENSE
condition|)
name|PRINTF
argument_list|(
literal|"GOT_SNS "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_state_flags
operator|&
name|RQSF_XFER_COMPLETE
condition|)
name|PRINTF
argument_list|(
literal|"XFR_CMPLT "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"status->"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_DISCONNECT
condition|)
name|PRINTF
argument_list|(
literal|"Disconnect "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_SYNCHRONOUS
condition|)
name|PRINTF
argument_list|(
literal|"Sync_xfr "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_PARITY_ERROR
condition|)
name|PRINTF
argument_list|(
literal|"Parity "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_BUS_RESET
condition|)
name|PRINTF
argument_list|(
literal|"Bus_Reset "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_DEVICE_RESET
condition|)
name|PRINTF
argument_list|(
literal|"Device_Reset "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_ABORTED
condition|)
name|PRINTF
argument_list|(
literal|"Aborted "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_TIMEOUT
condition|)
name|PRINTF
argument_list|(
literal|"Timeout "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|req_status_flags
operator|&
name|RQSTF_NEGOTIATION
condition|)
name|PRINTF
argument_list|(
literal|"Negotiation "
argument_list|)
expr_stmt|;
name|PRINTF
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


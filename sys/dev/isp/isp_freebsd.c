begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/* $Id: isp_freebsd.c,v 1.1 1998/04/22 17:54:50 mjacob Exp $ */
end_comment

begin_comment
comment|/*  * Platform (FreeBSD) dependent common attachment code for Qlogic adapters.  *  *---------------------------------------  * Copyright (c) 1997, 1998 by Matthew Jacob  * NASA/Ames Research Center  * All rights reserved.  *---------------------------------------  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice immediately at the beginning of the file, without modification,  *    this list of conditions, and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<dev/isp/isp_freebsd.h>
end_include

begin_decl_stmt
specifier|static
name|void
name|ispminphys
name|__P
argument_list|(
operator|(
expr|struct
name|buf
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int32_t
name|isp_adapter_info
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scsi_adapter
name|isp_switch
init|=
block|{
name|ispscsicmd
block|,
name|ispminphys
block|,
literal|0
block|,
literal|0
block|,
name|isp_adapter_info
block|,
literal|"isp"
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scsi_device
name|isp_dev
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"isp"
block|,
literal|0
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Complete attachment of hardware, include subdevices.  */
end_comment

begin_function
name|void
name|isp_attach
parameter_list|(
name|isp
parameter_list|)
name|struct
name|ispsoftc
modifier|*
name|isp
decl_stmt|;
block|{
name|struct
name|scsibus_data
modifier|*
name|scbus
decl_stmt|;
name|scbus
operator|=
name|scsi_alloc_bus
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|scbus
condition|)
block|{
return|return;
block|}
name|isp
operator|->
name|isp_state
operator|=
name|ISP_RUNSTATE
expr_stmt|;
name|isp
operator|->
name|isp_osinfo
operator|.
name|_link
operator|.
name|adapter_unit
operator|=
name|isp
operator|->
name|isp_osinfo
operator|.
name|unit
expr_stmt|;
name|isp
operator|->
name|isp_osinfo
operator|.
name|_link
operator|.
name|adapter_softc
operator|=
name|isp
expr_stmt|;
name|isp
operator|->
name|isp_osinfo
operator|.
name|_link
operator|.
name|adapter
operator|=
operator|&
name|isp_switch
expr_stmt|;
name|isp
operator|->
name|isp_osinfo
operator|.
name|_link
operator|.
name|device
operator|=
operator|&
name|isp_dev
expr_stmt|;
name|isp
operator|->
name|isp_osinfo
operator|.
name|_link
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_type
operator|&
name|ISP_HA_FC
condition|)
block|{
name|isp
operator|->
name|isp_osinfo
operator|.
name|_link
operator|.
name|adapter_targ
operator|=
literal|0xff
expr_stmt|;
if|#
directive|if
literal|0
block|isp->isp_osinfo._link.openings = 			RQUEST_QUEUE_LEN(isp) / (MAX_FC_TARG-1);
endif|#
directive|endif
name|scbus
operator|->
name|maxtarg
operator|=
name|MAX_FC_TARG
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|isp
operator|->
name|isp_osinfo
operator|.
name|_link
operator|.
name|adapter_targ
operator|=
operator|(
operator|(
name|sdparam
operator|*
operator|)
name|isp
operator|->
name|isp_param
operator|)
operator|->
name|isp_initiator_id
expr_stmt|;
if|#
directive|if
literal|0
block|isp->isp_osinfo._link.openings = 			RQUEST_QUEUE_LEN(isp) / (MAX_TARGETS-1);
endif|#
directive|endif
name|scbus
operator|->
name|maxtarg
operator|=
name|MAX_TARGETS
operator|-
literal|1
expr_stmt|;
block|}
comment|/* 	 * Prepare the scsibus_data area for the upperlevel scsi code. 	 */
name|scbus
operator|->
name|adapter_link
operator|=
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|_link
expr_stmt|;
comment|/* 	 * ask the adapter what subunits are present 	 */
name|scsi_attachdevs
argument_list|(
name|scbus
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * minphys our xfers  *  * Unfortunately, the buffer pointer describes the target device- not the  * adapter device, so we can't use the pointer to find out what kind of  * adapter we are and adjust accordingly.  */
end_comment

begin_function
specifier|static
name|void
name|ispminphys
parameter_list|(
name|bp
parameter_list|)
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
block|{
comment|/* 	 * XX: Only the 1020 has a 24 bit limit. 	 */
if|if
condition|(
name|bp
operator|->
name|b_bcount
operator|>=
operator|(
literal|1
operator|<<
literal|24
operator|)
condition|)
block|{
name|bp
operator|->
name|b_bcount
operator|=
operator|(
literal|1
operator|<<
literal|24
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|isp_adapter_info
parameter_list|(
name|unit
parameter_list|)
name|int
name|unit
decl_stmt|;
block|{
comment|/*  	 * XXX: FIND ISP BASED UPON UNIT AND GET REAL QUEUE LIMIT FROM THAT 	 */
return|return
operator|(
literal|2
operator|)
return|;
block|}
end_function

end_unit


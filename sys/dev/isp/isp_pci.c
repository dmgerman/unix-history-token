begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1997-2008 by Matthew Jacob  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice immediately at the beginning of the file, without modification,  *    this list of conditions, and the following disclaimer.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * PCI specific probe and attach routines for Qlogic ISP SCSI adapters.  * FreeBSD Version.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/stdint.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<dev/isp/isp_freebsd.h>
end_include

begin_function_decl
specifier|static
name|uint32_t
name|isp_pci_rd_reg
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_pci_wr_reg
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|isp_pci_rd_reg_1080
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_pci_wr_reg_1080
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|isp_pci_rd_reg_2400
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_pci_wr_reg_2400
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_pci_rd_isr
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint32_t
modifier|*
parameter_list|,
name|uint16_t
modifier|*
parameter_list|,
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_pci_rd_isr_2300
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint32_t
modifier|*
parameter_list|,
name|uint16_t
modifier|*
parameter_list|,
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_pci_rd_isr_2400
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|uint32_t
modifier|*
parameter_list|,
name|uint16_t
modifier|*
parameter_list|,
name|uint16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_pci_mbxdma
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_pci_dmasetup
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
name|XS_T
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_pci_reset0
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_pci_reset1
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|isp_pci_dumpregs
parameter_list|(
name|ispsoftc_t
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|ispmdvec
name|mdvec
init|=
block|{
name|isp_pci_rd_isr
block|,
name|isp_pci_rd_reg
block|,
name|isp_pci_wr_reg
block|,
name|isp_pci_mbxdma
block|,
name|isp_pci_dmasetup
block|,
name|isp_common_dmateardown
block|,
name|isp_pci_reset0
block|,
name|isp_pci_reset1
block|,
name|isp_pci_dumpregs
block|,
name|NULL
block|,
name|BIU_BURST_ENABLE
operator||
name|BIU_PCI_CONF1_FIFO_64
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ispmdvec
name|mdvec_1080
init|=
block|{
name|isp_pci_rd_isr
block|,
name|isp_pci_rd_reg_1080
block|,
name|isp_pci_wr_reg_1080
block|,
name|isp_pci_mbxdma
block|,
name|isp_pci_dmasetup
block|,
name|isp_common_dmateardown
block|,
name|isp_pci_reset0
block|,
name|isp_pci_reset1
block|,
name|isp_pci_dumpregs
block|,
name|NULL
block|,
name|BIU_BURST_ENABLE
operator||
name|BIU_PCI_CONF1_FIFO_64
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ispmdvec
name|mdvec_12160
init|=
block|{
name|isp_pci_rd_isr
block|,
name|isp_pci_rd_reg_1080
block|,
name|isp_pci_wr_reg_1080
block|,
name|isp_pci_mbxdma
block|,
name|isp_pci_dmasetup
block|,
name|isp_common_dmateardown
block|,
name|isp_pci_reset0
block|,
name|isp_pci_reset1
block|,
name|isp_pci_dumpregs
block|,
name|NULL
block|,
name|BIU_BURST_ENABLE
operator||
name|BIU_PCI_CONF1_FIFO_64
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ispmdvec
name|mdvec_2100
init|=
block|{
name|isp_pci_rd_isr
block|,
name|isp_pci_rd_reg
block|,
name|isp_pci_wr_reg
block|,
name|isp_pci_mbxdma
block|,
name|isp_pci_dmasetup
block|,
name|isp_common_dmateardown
block|,
name|isp_pci_reset0
block|,
name|isp_pci_reset1
block|,
name|isp_pci_dumpregs
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ispmdvec
name|mdvec_2200
init|=
block|{
name|isp_pci_rd_isr
block|,
name|isp_pci_rd_reg
block|,
name|isp_pci_wr_reg
block|,
name|isp_pci_mbxdma
block|,
name|isp_pci_dmasetup
block|,
name|isp_common_dmateardown
block|,
name|isp_pci_reset0
block|,
name|isp_pci_reset1
block|,
name|isp_pci_dumpregs
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ispmdvec
name|mdvec_2300
init|=
block|{
name|isp_pci_rd_isr_2300
block|,
name|isp_pci_rd_reg
block|,
name|isp_pci_wr_reg
block|,
name|isp_pci_mbxdma
block|,
name|isp_pci_dmasetup
block|,
name|isp_common_dmateardown
block|,
name|isp_pci_reset0
block|,
name|isp_pci_reset1
block|,
name|isp_pci_dumpregs
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ispmdvec
name|mdvec_2400
init|=
block|{
name|isp_pci_rd_isr_2400
block|,
name|isp_pci_rd_reg_2400
block|,
name|isp_pci_wr_reg_2400
block|,
name|isp_pci_mbxdma
block|,
name|isp_pci_dmasetup
block|,
name|isp_common_dmateardown
block|,
name|isp_pci_reset0
block|,
name|isp_pci_reset1
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ispmdvec
name|mdvec_2500
init|=
block|{
name|isp_pci_rd_isr_2400
block|,
name|isp_pci_rd_reg_2400
block|,
name|isp_pci_wr_reg_2400
block|,
name|isp_pci_mbxdma
block|,
name|isp_pci_dmasetup
block|,
name|isp_common_dmateardown
block|,
name|isp_pci_reset0
block|,
name|isp_pci_reset1
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|PCIM_CMD_INVEN
end_ifndef

begin_define
define|#
directive|define
name|PCIM_CMD_INVEN
value|0x10
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCIM_CMD_BUSMASTEREN
end_ifndef

begin_define
define|#
directive|define
name|PCIM_CMD_BUSMASTEREN
value|0x0004
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCIM_CMD_PERRESPEN
end_ifndef

begin_define
define|#
directive|define
name|PCIM_CMD_PERRESPEN
value|0x0040
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCIM_CMD_SEREN
end_ifndef

begin_define
define|#
directive|define
name|PCIM_CMD_SEREN
value|0x0100
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCIM_CMD_INTX_DISABLE
end_ifndef

begin_define
define|#
directive|define
name|PCIM_CMD_INTX_DISABLE
value|0x0400
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCIR_COMMAND
end_ifndef

begin_define
define|#
directive|define
name|PCIR_COMMAND
value|0x04
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCIR_CACHELNSZ
end_ifndef

begin_define
define|#
directive|define
name|PCIR_CACHELNSZ
value|0x0c
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCIR_LATTIMER
end_ifndef

begin_define
define|#
directive|define
name|PCIR_LATTIMER
value|0x0d
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCIR_ROMADDR
end_ifndef

begin_define
define|#
directive|define
name|PCIR_ROMADDR
value|0x30
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_VENDOR_QLOGIC
end_ifndef

begin_define
define|#
directive|define
name|PCI_VENDOR_QLOGIC
value|0x1077
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP1020
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP1020
value|0x1020
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP1080
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP1080
value|0x1080
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP10160
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP10160
value|0x1016
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP12160
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP12160
value|0x1216
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP1240
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP1240
value|0x1240
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP1280
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP1280
value|0x1280
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP2100
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP2100
value|0x2100
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP2200
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP2200
value|0x2200
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP2300
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP2300
value|0x2300
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP2312
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP2312
value|0x2312
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP2322
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP2322
value|0x2322
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP2422
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP2422
value|0x2422
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP2432
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP2432
value|0x2432
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP2532
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP2532
value|0x2532
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP6312
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP6312
value|0x6312
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP6322
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP6322
value|0x6322
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP1020
define|\
value|((PCI_PRODUCT_QLOGIC_ISP1020<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP1080
define|\
value|((PCI_PRODUCT_QLOGIC_ISP1080<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP10160
define|\
value|((PCI_PRODUCT_QLOGIC_ISP10160<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP12160
define|\
value|((PCI_PRODUCT_QLOGIC_ISP12160<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP1240
define|\
value|((PCI_PRODUCT_QLOGIC_ISP1240<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP1280
define|\
value|((PCI_PRODUCT_QLOGIC_ISP1280<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP2100
define|\
value|((PCI_PRODUCT_QLOGIC_ISP2100<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP2200
define|\
value|((PCI_PRODUCT_QLOGIC_ISP2200<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP2300
define|\
value|((PCI_PRODUCT_QLOGIC_ISP2300<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP2312
define|\
value|((PCI_PRODUCT_QLOGIC_ISP2312<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP2322
define|\
value|((PCI_PRODUCT_QLOGIC_ISP2322<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP2422
define|\
value|((PCI_PRODUCT_QLOGIC_ISP2422<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP2432
define|\
value|((PCI_PRODUCT_QLOGIC_ISP2432<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP2532
define|\
value|((PCI_PRODUCT_QLOGIC_ISP2532<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP6312
define|\
value|((PCI_PRODUCT_QLOGIC_ISP6312<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP6322
define|\
value|((PCI_PRODUCT_QLOGIC_ISP6322<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_comment
comment|/*  * Odd case for some AMI raid cards... We need to *not* attach to this.  */
end_comment

begin_define
define|#
directive|define
name|AMI_RAID_SUBVENDOR_ID
value|0x101e
end_define

begin_define
define|#
directive|define
name|IO_MAP_REG
value|0x10
end_define

begin_define
define|#
directive|define
name|MEM_MAP_REG
value|0x14
end_define

begin_define
define|#
directive|define
name|PCI_DFLT_LTNCY
value|0x40
end_define

begin_define
define|#
directive|define
name|PCI_DFLT_LNSZ
value|0x10
end_define

begin_function_decl
specifier|static
name|int
name|isp_pci_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_pci_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isp_pci_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|ISP_PCD
parameter_list|(
name|isp
parameter_list|)
value|((struct isp_pcisoftc *)isp)->pci_dev
end_define

begin_struct
struct|struct
name|isp_pcisoftc
block|{
name|ispsoftc_t
name|pci_isp
decl_stmt|;
name|device_t
name|pci_dev
decl_stmt|;
name|struct
name|resource
modifier|*
name|pci_reg
decl_stmt|;
name|void
modifier|*
name|ih
decl_stmt|;
name|int16_t
name|pci_poff
index|[
name|_NREG_BLKS
index|]
decl_stmt|;
name|bus_dma_tag_t
name|dmat
decl_stmt|;
name|int
name|msicount
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|device_method_t
name|isp_pci_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|isp_pci_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|isp_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|isp_pci_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|isp_pci_driver
init|=
block|{
literal|"isp"
block|,
name|isp_pci_methods
block|,
expr|sizeof
operator|(
expr|struct
name|isp_pcisoftc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|isp_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|isp
argument_list|,
name|pci
argument_list|,
name|isp_pci_driver
argument_list|,
name|isp_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|isp_pci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
switch|switch
condition|(
operator|(
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|)
condition|)
block|{
case|case
name|PCI_QLOGIC_ISP1020
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 1020/1040 PCI SCSI Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP1080
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 1080 PCI SCSI Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP1240
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 1240 PCI SCSI Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP1280
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 1280 PCI SCSI Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP10160
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 10160 PCI SCSI Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP12160
case|:
if|if
condition|(
name|pci_get_subvendor
argument_list|(
name|dev
argument_list|)
operator|==
name|AMI_RAID_SUBVENDOR_ID
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 12160 PCI SCSI Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2100
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 2100 PCI FC-AL Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2200
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 2200 PCI FC-AL Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2300
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 2300 PCI FC-AL Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2312
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 2312 PCI FC-AL Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2322
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 2322 PCI FC-AL Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2422
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 2422 PCI FC-AL Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2432
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 2432 PCI FC-AL Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2532
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 2532 PCI FC-AL Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP6312
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 6312 PCI FC-AL Adapter"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP6322
case|:
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Qlogic ISP 6322 PCI FC-AL Adapter"
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|isp_announced
operator|==
literal|0
operator|&&
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"Qlogic ISP Driver, FreeBSD Version %d.%d, "
literal|"Core Version %d.%d\n"
argument_list|,
name|ISP_PLATFORM_VERSION_MAJOR
argument_list|,
name|ISP_PLATFORM_VERSION_MINOR
argument_list|,
name|ISP_CORE_VERSION_MAJOR
argument_list|,
name|ISP_CORE_VERSION_MINOR
argument_list|)
expr_stmt|;
name|isp_announced
operator|++
expr_stmt|;
block|}
comment|/* 	 * XXXX: Here is where we might load the f/w module 	 * XXXX: (or increase a reference count to it). 	 */
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_get_generic_options
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
modifier|*
name|nvp
parameter_list|)
block|{
name|int
name|tval
decl_stmt|;
comment|/* 	 * Figure out if we're supposed to skip this one. 	 */
name|tval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"disable"
argument_list|,
operator|&
name|tval
argument_list|)
operator|==
literal|0
operator|&&
name|tval
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"disabled at user request\n"
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_osinfo
operator|.
name|disabled
operator|=
literal|1
expr_stmt|;
return|return;
block|}
name|tval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"fwload_disable"
argument_list|,
operator|&
name|tval
argument_list|)
operator|==
literal|0
operator|&&
name|tval
operator|!=
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_confopts
operator||=
name|ISP_CFG_NORELOAD
expr_stmt|;
block|}
name|tval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"ignore_nvram"
argument_list|,
operator|&
name|tval
argument_list|)
operator|==
literal|0
operator|&&
name|tval
operator|!=
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_confopts
operator||=
name|ISP_CFG_NONVRAM
expr_stmt|;
block|}
name|tval
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"debug"
argument_list|,
operator|&
name|tval
argument_list|)
expr_stmt|;
if|if
condition|(
name|tval
condition|)
block|{
name|isp
operator|->
name|isp_dblev
operator|=
name|tval
expr_stmt|;
block|}
else|else
block|{
name|isp
operator|->
name|isp_dblev
operator|=
name|ISP_LOGWARN
operator||
name|ISP_LOGERR
expr_stmt|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|isp
operator|->
name|isp_dblev
operator||=
name|ISP_LOGCONFIG
operator||
name|ISP_LOGINFO
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"vports"
argument_list|,
operator|&
name|tval
argument_list|)
expr_stmt|;
if|if
condition|(
name|tval
operator|>
literal|0
operator|&&
name|tval
operator|<
literal|127
condition|)
block|{
operator|*
name|nvp
operator|=
name|tval
expr_stmt|;
block|}
else|else
block|{
operator|*
name|nvp
operator|=
literal|0
expr_stmt|;
block|}
name|tval
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"autoconfig"
argument_list|,
operator|&
name|tval
argument_list|)
expr_stmt|;
name|isp_autoconfig
operator|=
name|tval
expr_stmt|;
name|tval
operator|=
literal|7
expr_stmt|;
operator|(
name|void
operator|)
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"quickboot_time"
argument_list|,
operator|&
name|tval
argument_list|)
expr_stmt|;
name|isp_quickboot_time
operator|=
name|tval
expr_stmt|;
name|tval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"forcemulti"
argument_list|,
operator|&
name|tval
argument_list|)
operator|==
literal|0
operator|&&
name|tval
operator|!=
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_osinfo
operator|.
name|forcemulti
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_get_pci_options
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
modifier|*
name|m1
parameter_list|,
name|int
modifier|*
name|m2
parameter_list|)
block|{
name|int
name|tval
decl_stmt|;
comment|/* 	 * Which we should try first - memory mapping or i/o mapping? 	 * 	 * We used to try memory first followed by i/o on alpha, otherwise 	 * the reverse, but we should just try memory first all the time now. 	 */
operator|*
name|m1
operator|=
name|PCIM_CMD_MEMEN
expr_stmt|;
operator|*
name|m2
operator|=
name|PCIM_CMD_PORTEN
expr_stmt|;
name|tval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"prefer_iomap"
argument_list|,
operator|&
name|tval
argument_list|)
operator|==
literal|0
operator|&&
name|tval
operator|!=
literal|0
condition|)
block|{
operator|*
name|m1
operator|=
name|PCIM_CMD_PORTEN
expr_stmt|;
operator|*
name|m2
operator|=
name|PCIM_CMD_MEMEN
expr_stmt|;
block|}
name|tval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"prefer_memmap"
argument_list|,
operator|&
name|tval
argument_list|)
operator|==
literal|0
operator|&&
name|tval
operator|!=
literal|0
condition|)
block|{
operator|*
name|m1
operator|=
name|PCIM_CMD_MEMEN
expr_stmt|;
operator|*
name|m2
operator|=
name|PCIM_CMD_PORTEN
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|isp_get_specific_options
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|chan
parameter_list|,
name|ispsoftc_t
modifier|*
name|isp
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sptr
decl_stmt|;
name|int
name|tval
decl_stmt|;
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"iid"
argument_list|,
operator|&
name|tval
argument_list|)
condition|)
block|{
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|default_id
operator|=
literal|109
operator|-
name|chan
expr_stmt|;
block|}
else|else
block|{
name|ISP_SPI_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|iid
operator|=
literal|7
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|default_id
operator|=
name|tval
operator|-
name|chan
expr_stmt|;
block|}
else|else
block|{
name|ISP_SPI_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|iid
operator|=
name|tval
expr_stmt|;
block|}
name|isp
operator|->
name|isp_confopts
operator||=
name|ISP_CFG_OWNLOOPID
expr_stmt|;
block|}
name|tval
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"role"
argument_list|,
operator|&
name|tval
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|tval
condition|)
block|{
case|case
name|ISP_ROLE_NONE
case|:
case|case
name|ISP_ROLE_INITIATOR
case|:
case|case
name|ISP_ROLE_TARGET
case|:
case|case
name|ISP_ROLE_INITIATOR
operator||
name|ISP_ROLE_TARGET
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"setting role to 0x%x\n"
argument_list|,
name|tval
argument_list|)
expr_stmt|;
break|break;
default|default:
name|tval
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|tval
operator|==
operator|-
literal|1
condition|)
block|{
name|tval
operator|=
name|ISP_DEFAULT_ROLES
expr_stmt|;
block|}
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_SPI_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|role
operator|=
name|tval
expr_stmt|;
return|return;
block|}
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|role
operator|=
name|tval
expr_stmt|;
name|tval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"fullduplex"
argument_list|,
operator|&
name|tval
argument_list|)
operator|==
literal|0
operator|&&
name|tval
operator|!=
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_confopts
operator||=
name|ISP_CFG_FULL_DUPLEX
expr_stmt|;
block|}
name|sptr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|resource_string_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"topology"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
operator|&
name|sptr
argument_list|)
operator|==
literal|0
operator|&&
name|sptr
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|sptr
argument_list|,
literal|"lport"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_confopts
operator||=
name|ISP_CFG_LPORT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|sptr
argument_list|,
literal|"nport"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_confopts
operator||=
name|ISP_CFG_NPORT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|sptr
argument_list|,
literal|"lport-only"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_confopts
operator||=
name|ISP_CFG_LPORT_ONLY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|sptr
argument_list|,
literal|"nport-only"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|isp
operator|->
name|isp_confopts
operator||=
name|ISP_CFG_NPORT_ONLY
expr_stmt|;
block|}
block|}
comment|/* 	 * Because the resource_*_value functions can neither return 	 * 64 bit integer values, nor can they be directly coerced 	 * to interpret the right hand side of the assignment as 	 * you want them to interpret it, we have to force WWN 	 * hint replacement to specify WWN strings with a leading 	 * 'w' (e..g w50000000aaaa0001). Sigh. 	 */
name|sptr
operator|=
literal|0
expr_stmt|;
name|tval
operator|=
name|resource_string_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"portwwn"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
operator|&
name|sptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tval
operator|==
literal|0
operator|&&
name|sptr
operator|!=
literal|0
operator|&&
operator|*
name|sptr
operator|++
operator|==
literal|'w'
condition|)
block|{
name|char
modifier|*
name|eptr
init|=
literal|0
decl_stmt|;
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|def_wwpn
operator|=
name|strtouq
argument_list|(
name|sptr
argument_list|,
operator|&
name|eptr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|eptr
operator|<
name|sptr
operator|+
literal|16
operator|||
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|def_wwpn
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"mangled portwwn hint '%s'\n"
argument_list|,
name|sptr
argument_list|)
expr_stmt|;
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|def_wwpn
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|sptr
operator|=
literal|0
expr_stmt|;
name|tval
operator|=
name|resource_string_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"nodewwn"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
operator|&
name|sptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tval
operator|==
literal|0
operator|&&
name|sptr
operator|!=
literal|0
operator|&&
operator|*
name|sptr
operator|++
operator|==
literal|'w'
condition|)
block|{
name|char
modifier|*
name|eptr
init|=
literal|0
decl_stmt|;
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|def_wwnn
operator|=
name|strtouq
argument_list|(
name|sptr
argument_list|,
operator|&
name|eptr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|eptr
operator|<
name|sptr
operator|+
literal|16
operator|||
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|def_wwnn
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"mangled nodewwn hint '%s'\n"
argument_list|,
name|sptr
argument_list|)
expr_stmt|;
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|def_wwnn
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|tval
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"hysteresis"
argument_list|,
operator|&
name|tval
argument_list|)
expr_stmt|;
if|if
condition|(
name|tval
operator|>=
literal|0
operator|&&
name|tval
operator|<
literal|256
condition|)
block|{
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|hysteresis
operator|=
name|tval
expr_stmt|;
block|}
else|else
block|{
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|hysteresis
operator|=
name|isp_fabric_hysteresis
expr_stmt|;
block|}
name|tval
operator|=
operator|-
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"loop_down_limit"
argument_list|,
operator|&
name|tval
argument_list|)
expr_stmt|;
if|if
condition|(
name|tval
operator|>=
literal|0
operator|&&
name|tval
operator|<
literal|0xffff
condition|)
block|{
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|loop_down_limit
operator|=
name|tval
expr_stmt|;
block|}
else|else
block|{
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|loop_down_limit
operator|=
name|isp_loop_down_limit
expr_stmt|;
block|}
name|tval
operator|=
operator|-
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"gone_device_time"
argument_list|,
operator|&
name|tval
argument_list|)
expr_stmt|;
if|if
condition|(
name|tval
operator|>=
literal|0
operator|&&
name|tval
operator|<
literal|0xffff
condition|)
block|{
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|gone_device_time
operator|=
name|tval
expr_stmt|;
block|}
else|else
block|{
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|chan
argument_list|)
operator|->
name|gone_device_time
operator|=
name|isp_gone_device_time
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|isp_pci_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|resource
modifier|*
name|regs
decl_stmt|,
modifier|*
name|irq
decl_stmt|;
name|int
name|rtp
decl_stmt|,
name|rgd
decl_stmt|,
name|iqd
decl_stmt|,
name|i
decl_stmt|,
name|m1
decl_stmt|,
name|m2
decl_stmt|,
name|locksetup
init|=
literal|0
decl_stmt|;
name|int
name|isp_nvports
init|=
literal|0
decl_stmt|;
name|uint32_t
name|data
decl_stmt|,
name|cmd
decl_stmt|,
name|linesz
decl_stmt|,
name|did
decl_stmt|;
name|struct
name|isp_pcisoftc
modifier|*
name|pcs
decl_stmt|;
name|ispsoftc_t
modifier|*
name|isp
init|=
name|NULL
decl_stmt|;
name|size_t
name|psize
decl_stmt|,
name|xsize
decl_stmt|;
name|char
name|fwname
index|[
literal|32
index|]
decl_stmt|;
name|pcs
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcs
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot get softc\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|memset
argument_list|(
name|pcs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pcs
argument_list|)
argument_list|)
expr_stmt|;
name|pcs
operator|->
name|pci_dev
operator|=
name|dev
expr_stmt|;
name|isp
operator|=
operator|&
name|pcs
operator|->
name|pci_isp
expr_stmt|;
name|isp
operator|->
name|isp_dev
operator|=
name|dev
expr_stmt|;
name|isp
operator|->
name|isp_nchan
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Get Generic Options 	 */
name|isp_get_generic_options
argument_list|(
name|dev
argument_list|,
name|isp
argument_list|,
operator|&
name|isp_nvports
argument_list|)
expr_stmt|;
comment|/* 	 * Check to see if options have us disabled 	 */
if|if
condition|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|disabled
condition|)
block|{
comment|/* 		 * But return zero to preserve unit numbering 		 */
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Get PCI options- which in this case are just mapping preferences. 	 */
name|isp_get_pci_options
argument_list|(
name|dev
argument_list|,
operator|&
name|m1
argument_list|,
operator|&
name|m2
argument_list|)
expr_stmt|;
name|linesz
operator|=
name|PCI_DFLT_LNSZ
expr_stmt|;
name|irq
operator|=
name|regs
operator|=
name|NULL
expr_stmt|;
name|rgd
operator|=
name|rtp
operator|=
name|iqd
operator|=
literal|0
expr_stmt|;
name|cmd
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|&
name|m1
condition|)
block|{
name|rtp
operator|=
operator|(
name|m1
operator|==
name|PCIM_CMD_MEMEN
operator|)
condition|?
name|SYS_RES_MEMORY
else|:
name|SYS_RES_IOPORT
expr_stmt|;
name|rgd
operator|=
operator|(
name|m1
operator|==
name|PCIM_CMD_MEMEN
operator|)
condition|?
name|MEM_MAP_REG
else|:
name|IO_MAP_REG
expr_stmt|;
name|regs
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|rtp
argument_list|,
operator|&
name|rgd
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|regs
operator|==
name|NULL
operator|&&
operator|(
name|cmd
operator|&
name|m2
operator|)
condition|)
block|{
name|rtp
operator|=
operator|(
name|m2
operator|==
name|PCIM_CMD_MEMEN
operator|)
condition|?
name|SYS_RES_MEMORY
else|:
name|SYS_RES_IOPORT
expr_stmt|;
name|rgd
operator|=
operator|(
name|m2
operator|==
name|PCIM_CMD_MEMEN
operator|)
condition|?
name|MEM_MAP_REG
else|:
name|IO_MAP_REG
expr_stmt|;
name|regs
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|rtp
argument_list|,
operator|&
name|rgd
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|regs
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map any ports\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"using %s space register mapping\n"
argument_list|,
operator|(
name|rgd
operator|==
name|IO_MAP_REG
operator|)
condition|?
literal|"I/O"
else|:
literal|"Memory"
argument_list|)
expr_stmt|;
block|}
name|isp
operator|->
name|isp_bus_tag
operator|=
name|rman_get_bustag
argument_list|(
name|regs
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_bus_handle
operator|=
name|rman_get_bushandle
argument_list|(
name|regs
argument_list|)
expr_stmt|;
name|pcs
operator|->
name|pci_dev
operator|=
name|dev
expr_stmt|;
name|pcs
operator|->
name|pci_reg
operator|=
name|regs
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|BIU_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|BIU_REGS_OFF
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|MBOX_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|PCI_MBOX_REGS_OFF
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|SXP_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|PCI_SXP_REGS_OFF
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|RISC_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|PCI_RISC_REGS_OFF
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|DMA_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|DMA_REGS_OFF
expr_stmt|;
switch|switch
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
condition|)
block|{
case|case
name|PCI_QLOGIC_ISP1020
case|:
name|did
operator|=
literal|0x1040
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_UNKNOWN
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP1080
case|:
name|did
operator|=
literal|0x1080
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_1080
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1080
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|DMA_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|ISP1080_DMA_REGS_OFF
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP1240
case|:
name|did
operator|=
literal|0x1080
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_1080
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1240
expr_stmt|;
name|isp
operator|->
name|isp_nchan
operator|=
literal|2
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|DMA_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|ISP1080_DMA_REGS_OFF
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP1280
case|:
name|did
operator|=
literal|0x1080
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_1080
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_1280
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|DMA_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|ISP1080_DMA_REGS_OFF
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP10160
case|:
name|did
operator|=
literal|0x12160
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_12160
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_10160
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|DMA_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|ISP1080_DMA_REGS_OFF
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP12160
case|:
name|did
operator|=
literal|0x12160
expr_stmt|;
name|isp
operator|->
name|isp_nchan
operator|=
literal|2
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_12160
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_SCSI_12160
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|DMA_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|ISP1080_DMA_REGS_OFF
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2100
case|:
name|did
operator|=
literal|0x2100
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_2100
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_FC_2100
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|MBOX_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|PCI_MBOX_REGS2100_OFF
expr_stmt|;
if|if
condition|(
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
operator|<
literal|3
condition|)
block|{
comment|/* 			 * XXX: Need to get the actual revision 			 * XXX: number of the 2100 FB. At any rate, 			 * XXX: lower cache line size for early revision 			 * XXX; boards. 			 */
name|linesz
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|PCI_QLOGIC_ISP2200
case|:
name|did
operator|=
literal|0x2200
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_2200
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_FC_2200
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|MBOX_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|PCI_MBOX_REGS2100_OFF
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2300
case|:
name|did
operator|=
literal|0x2300
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_2300
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_FC_2300
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|MBOX_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|PCI_MBOX_REGS2300_OFF
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2312
case|:
case|case
name|PCI_QLOGIC_ISP6312
case|:
name|did
operator|=
literal|0x2300
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_2300
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_FC_2312
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|MBOX_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|PCI_MBOX_REGS2300_OFF
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2322
case|:
case|case
name|PCI_QLOGIC_ISP6322
case|:
name|did
operator|=
literal|0x2322
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_2300
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_FC_2322
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|MBOX_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|PCI_MBOX_REGS2300_OFF
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2422
case|:
case|case
name|PCI_QLOGIC_ISP2432
case|:
name|did
operator|=
literal|0x2400
expr_stmt|;
name|isp
operator|->
name|isp_nchan
operator|+=
name|isp_nvports
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_2400
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_FC_2400
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|MBOX_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|PCI_MBOX_REGS2400_OFF
expr_stmt|;
break|break;
case|case
name|PCI_QLOGIC_ISP2532
case|:
name|did
operator|=
literal|0x2500
expr_stmt|;
name|isp
operator|->
name|isp_nchan
operator|+=
name|isp_nvports
expr_stmt|;
name|isp
operator|->
name|isp_mdvec
operator|=
operator|&
name|mdvec_2500
expr_stmt|;
name|isp
operator|->
name|isp_type
operator|=
name|ISP_HA_FC_2500
expr_stmt|;
name|pcs
operator|->
name|pci_poff
index|[
name|MBOX_BLOCK
operator|>>
name|_BLK_REG_SHFT
index|]
operator|=
name|PCI_MBOX_REGS2400_OFF
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unknown device type\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
break|break;
block|}
name|isp
operator|->
name|isp_revision
operator|=
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|psize
operator|=
sizeof|sizeof
argument_list|(
name|fcparam
argument_list|)
expr_stmt|;
name|xsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|isp_fc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|psize
operator|=
sizeof|sizeof
argument_list|(
name|sdparam
argument_list|)
expr_stmt|;
name|xsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|isp_spi
argument_list|)
expr_stmt|;
block|}
name|psize
operator|*=
name|isp
operator|->
name|isp_nchan
expr_stmt|;
name|xsize
operator|*=
name|isp
operator|->
name|isp_nchan
expr_stmt|;
name|isp
operator|->
name|isp_param
operator|=
name|malloc
argument_list|(
name|psize
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_param
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate parameter data\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|isp
operator|->
name|isp_osinfo
operator|.
name|pc
operator|.
name|ptr
operator|=
name|malloc
argument_list|(
name|xsize
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|pc
operator|.
name|ptr
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate parameter data\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* 	 * Now that we know who we are (roughly) get/set specific options 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|i
operator|++
control|)
block|{
name|isp_get_specific_options
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
name|isp
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * The 'it' suffix really only matters for SCSI cards in target mode. 	 */
name|isp
operator|->
name|isp_osinfo
operator|.
name|fw
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
name|ISP_SPI_PC
argument_list|(
name|isp
argument_list|,
literal|0
argument_list|)
operator|->
name|role
operator|&
name|ISP_ROLE_TARGET
operator|)
condition|)
block|{
name|snprintf
argument_list|(
name|fwname
argument_list|,
sizeof|sizeof
argument_list|(
name|fwname
argument_list|)
argument_list|,
literal|"isp_%04x_it"
argument_list|,
name|did
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_osinfo
operator|.
name|fw
operator|=
name|firmware_get
argument_list|(
name|fwname
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
operator|&&
operator|(
name|isp
operator|->
name|isp_nchan
operator|>
literal|1
operator|||
name|isp
operator|->
name|isp_osinfo
operator|.
name|forcemulti
operator|)
condition|)
block|{
name|snprintf
argument_list|(
name|fwname
argument_list|,
sizeof|sizeof
argument_list|(
name|fwname
argument_list|)
argument_list|,
literal|"isp_%04x_multi"
argument_list|,
name|did
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_osinfo
operator|.
name|fw
operator|=
name|firmware_get
argument_list|(
name|fwname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|fw
operator|==
name|NULL
condition|)
block|{
name|snprintf
argument_list|(
name|fwname
argument_list|,
sizeof|sizeof
argument_list|(
name|fwname
argument_list|)
argument_list|,
literal|"isp_%04x"
argument_list|,
name|did
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_osinfo
operator|.
name|fw
operator|=
name|firmware_get
argument_list|(
name|fwname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|fw
operator|!=
name|NULL
condition|)
block|{
name|isp
operator|->
name|isp_mdvec
operator|->
name|dv_ispfw
operator|=
name|isp
operator|->
name|isp_osinfo
operator|.
name|fw
operator|->
name|data
expr_stmt|;
block|}
comment|/* 	 * Make sure that SERR, PERR, WRITE INVALIDATE and BUSMASTER 	 * are set. 	 */
name|cmd
operator||=
name|PCIM_CMD_SEREN
operator||
name|PCIM_CMD_PERRESPEN
operator||
name|PCIM_CMD_BUSMASTEREN
operator||
name|PCIM_CMD_INVEN
expr_stmt|;
if|if
condition|(
name|IS_2300
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* per QLogic errata */
name|cmd
operator|&=
operator|~
name|PCIM_CMD_INVEN
expr_stmt|;
block|}
if|if
condition|(
name|IS_2322
argument_list|(
name|isp
argument_list|)
operator|||
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|PCI_QLOGIC_ISP6312
condition|)
block|{
name|cmd
operator|&=
operator|~
name|PCIM_CMD_INTX_DISABLE
expr_stmt|;
block|}
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|cmd
operator|&=
operator|~
name|PCIM_CMD_INTX_DISABLE
expr_stmt|;
block|}
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
name|cmd
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* 	 * Make sure the Cache Line Size register is set sensibly. 	 */
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_CACHELNSZ
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
literal|0
operator|||
operator|(
name|linesz
operator|!=
name|PCI_DFLT_LNSZ
operator|&&
name|data
operator|!=
name|linesz
operator|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"set PCI line size to %d from %d"
argument_list|,
name|linesz
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|linesz
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_CACHELNSZ
argument_list|,
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Make sure the Latency Timer is sane. 	 */
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_LATTIMER
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|<
name|PCI_DFLT_LTNCY
condition|)
block|{
name|data
operator|=
name|PCI_DFLT_LTNCY
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGCONFIG
argument_list|,
literal|"set PCI latency to %d"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_LATTIMER
argument_list|,
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Make sure we've disabled the ROM. 	 */
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_ROMADDR
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
literal|1
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_ROMADDR
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* 	 * Do MSI 	 * 	 * NB: MSI-X needs to be disabled for the 2432 (PCI-Express) 	 */
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_2322
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|pcs
operator|->
name|msicount
operator|=
name|pci_msi_count
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcs
operator|->
name|msicount
operator|>
literal|1
condition|)
block|{
name|pcs
operator|->
name|msicount
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|pci_alloc_msi
argument_list|(
name|dev
argument_list|,
operator|&
name|pcs
operator|->
name|msicount
argument_list|)
operator|==
literal|0
condition|)
block|{
name|iqd
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|iqd
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|iqd
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|irq
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* Make sure the lock is set up. */
name|mtx_init
argument_list|(
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|lock
argument_list|,
literal|"isp"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|locksetup
operator|++
expr_stmt|;
if|if
condition|(
name|isp_setup_intr
argument_list|(
name|dev
argument_list|,
name|irq
argument_list|,
name|ISP_IFLAGS
argument_list|,
name|NULL
argument_list|,
name|isp_platform_intr
argument_list|,
name|isp
argument_list|,
operator|&
name|pcs
operator|->
name|ih
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not setup interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* 	 * Last minute checks... 	 */
if|if
condition|(
name|IS_23XX
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|isp
operator|->
name|isp_port
operator|=
name|pci_get_function
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Make sure we're in reset state. 	 */
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_reset
argument_list|(
name|isp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_state
operator|!=
name|ISP_RESETSTATE
condition|)
block|{
name|ISP_UNLOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|isp_init
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_state
operator|==
name|ISP_INITSTATE
condition|)
block|{
name|isp
operator|->
name|isp_state
operator|=
name|ISP_RUNSTATE
expr_stmt|;
block|}
name|ISP_UNLOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp_attach
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_uninit
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|ISP_UNLOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|bad
label|:
if|if
condition|(
name|pcs
operator|&&
name|pcs
operator|->
name|ih
condition|)
block|{
operator|(
name|void
operator|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|irq
argument_list|,
name|pcs
operator|->
name|ih
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|locksetup
operator|&&
name|isp
condition|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|lock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|irq
condition|)
block|{
operator|(
name|void
operator|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|iqd
argument_list|,
name|irq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pcs
operator|&&
name|pcs
operator|->
name|msicount
condition|)
block|{
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|regs
condition|)
block|{
operator|(
name|void
operator|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|rtp
argument_list|,
name|rgd
argument_list|,
name|regs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pcs
condition|)
block|{
if|if
condition|(
name|pcs
operator|->
name|pci_isp
operator|.
name|isp_param
condition|)
block|{
name|free
argument_list|(
name|pcs
operator|->
name|pci_isp
operator|.
name|isp_param
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|pcs
operator|->
name|pci_isp
operator|.
name|isp_param
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|pcs
operator|->
name|pci_isp
operator|.
name|isp_osinfo
operator|.
name|pc
operator|.
name|ptr
condition|)
block|{
name|free
argument_list|(
name|pcs
operator|->
name|pci_isp
operator|.
name|isp_osinfo
operator|.
name|pc
operator|.
name|ptr
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|pcs
operator|->
name|pci_isp
operator|.
name|isp_osinfo
operator|.
name|pc
operator|.
name|ptr
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isp_pci_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|isp_pcisoftc
modifier|*
name|pcs
decl_stmt|;
name|ispsoftc_t
modifier|*
name|isp
decl_stmt|;
name|pcs
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcs
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|isp
operator|=
operator|(
name|ispsoftc_t
operator|*
operator|)
name|pcs
expr_stmt|;
name|ISP_DISABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|IspVirt2Off
parameter_list|(
name|a
parameter_list|,
name|x
parameter_list|)
define|\
value|(((struct isp_pcisoftc *)a)->pci_poff[((x)& _BLK_REG_MASK)>> \ 	_BLK_REG_SHFT] + ((x)& 0xfff))
end_define

begin_define
define|#
directive|define
name|BXR2
parameter_list|(
name|isp
parameter_list|,
name|off
parameter_list|)
define|\
value|bus_space_read_2(isp->isp_bus_tag, isp->isp_bus_handle, off)
end_define

begin_define
define|#
directive|define
name|BXW2
parameter_list|(
name|isp
parameter_list|,
name|off
parameter_list|,
name|v
parameter_list|)
define|\
value|bus_space_write_2(isp->isp_bus_tag, isp->isp_bus_handle, off, v)
end_define

begin_define
define|#
directive|define
name|BXR4
parameter_list|(
name|isp
parameter_list|,
name|off
parameter_list|)
define|\
value|bus_space_read_4(isp->isp_bus_tag, isp->isp_bus_handle, off)
end_define

begin_define
define|#
directive|define
name|BXW4
parameter_list|(
name|isp
parameter_list|,
name|off
parameter_list|,
name|v
parameter_list|)
define|\
value|bus_space_write_4(isp->isp_bus_tag, isp->isp_bus_handle, off, v)
end_define

begin_function
specifier|static
name|ISP_INLINE
name|int
name|isp_pci_rd_debounced
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|off
parameter_list|,
name|uint16_t
modifier|*
name|rp
parameter_list|)
block|{
name|uint32_t
name|val0
decl_stmt|,
name|val1
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
do|do
block|{
name|val0
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|off
argument_list|)
argument_list|)
expr_stmt|;
name|val1
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|off
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|val0
operator|!=
name|val1
operator|&&
operator|++
name|i
operator|<
literal|1000
condition|)
do|;
if|if
condition|(
name|val0
operator|!=
name|val1
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
operator|*
name|rp
operator|=
name|val0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isp_pci_rd_isr
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint32_t
modifier|*
name|isrp
parameter_list|,
name|uint16_t
modifier|*
name|semap
parameter_list|,
name|uint16_t
modifier|*
name|mbp
parameter_list|)
block|{
name|uint16_t
name|isr
decl_stmt|,
name|sema
decl_stmt|;
if|if
condition|(
name|IS_2100
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|isp_pci_rd_debounced
argument_list|(
name|isp
argument_list|,
name|BIU_ISR
argument_list|,
operator|&
name|isr
argument_list|)
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|isp_pci_rd_debounced
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|,
operator|&
name|sema
argument_list|)
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|else
block|{
name|isr
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_ISR
argument_list|)
argument_list|)
expr_stmt|;
name|sema
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG3
argument_list|,
literal|"ISR 0x%x SEMA 0x%x"
argument_list|,
name|isr
argument_list|,
name|sema
argument_list|)
expr_stmt|;
name|isr
operator|&=
name|INT_PENDING_MASK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|sema
operator|&=
name|BIU_SEMA_LOCK
expr_stmt|;
if|if
condition|(
name|isr
operator|==
literal|0
operator|&&
name|sema
operator|==
literal|0
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
name|isrp
operator|=
name|isr
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|semap
operator|=
name|sema
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|IS_2100
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
name|isp_pci_rd_debounced
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|,
name|mbp
argument_list|)
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|else
block|{
operator|*
name|mbp
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|isp_pci_rd_isr_2300
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint32_t
modifier|*
name|isrp
parameter_list|,
name|uint16_t
modifier|*
name|semap
parameter_list|,
name|uint16_t
modifier|*
name|mbox0p
parameter_list|)
block|{
name|uint32_t
name|hccr
decl_stmt|;
name|uint32_t
name|r2hisr
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_ISR
argument_list|)
operator|&
name|BIU2100_ISR_RISC_INT
argument_list|)
operator|)
condition|)
block|{
operator|*
name|isrp
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|r2hisr
operator|=
name|BXR4
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_R2HSTSLO
argument_list|)
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG3
argument_list|,
literal|"RISC2HOST ISR 0x%x"
argument_list|,
name|r2hisr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r2hisr
operator|&
name|BIU_R2HST_INTR
operator|)
operator|==
literal|0
condition|)
block|{
operator|*
name|isrp
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
switch|switch
condition|(
name|r2hisr
operator|&
name|BIU_R2HST_ISTAT_MASK
condition|)
block|{
case|case
name|ISPR2HST_ROM_MBX_OK
case|:
case|case
name|ISPR2HST_ROM_MBX_FAIL
case|:
case|case
name|ISPR2HST_MBX_OK
case|:
case|case
name|ISPR2HST_MBX_FAIL
case|:
case|case
name|ISPR2HST_ASYNC_EVENT
case|:
operator|*
name|isrp
operator|=
name|r2hisr
operator|&
literal|0xffff
expr_stmt|;
operator|*
name|mbox0p
operator|=
operator|(
name|r2hisr
operator|>>
literal|16
operator|)
expr_stmt|;
operator|*
name|semap
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|ISPR2HST_RIO_16
case|:
operator|*
name|isrp
operator|=
name|r2hisr
operator|&
literal|0xffff
expr_stmt|;
operator|*
name|mbox0p
operator|=
name|ASYNC_RIO1
expr_stmt|;
operator|*
name|semap
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|ISPR2HST_FPOST
case|:
operator|*
name|isrp
operator|=
name|r2hisr
operator|&
literal|0xffff
expr_stmt|;
operator|*
name|mbox0p
operator|=
name|ASYNC_CMD_CMPLT
expr_stmt|;
operator|*
name|semap
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|ISPR2HST_FPOST_CTIO
case|:
operator|*
name|isrp
operator|=
name|r2hisr
operator|&
literal|0xffff
expr_stmt|;
operator|*
name|mbox0p
operator|=
name|ASYNC_CTIO_DONE
expr_stmt|;
operator|*
name|semap
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|ISPR2HST_RSPQ_UPDATE
case|:
operator|*
name|isrp
operator|=
name|r2hisr
operator|&
literal|0xffff
expr_stmt|;
operator|*
name|mbox0p
operator|=
literal|0
expr_stmt|;
operator|*
name|semap
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
default|default:
name|hccr
operator|=
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|)
expr_stmt|;
if|if
condition|(
name|hccr
operator|&
name|HCCR_PAUSE
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_RESET
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"RISC paused at interrupt (%x->%x)"
argument_list|,
name|hccr
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|)
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU_ICR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"unknown interrupt 0x%x\n"
argument_list|,
name|r2hisr
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|isp_pci_rd_isr_2400
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|uint32_t
modifier|*
name|isrp
parameter_list|,
name|uint16_t
modifier|*
name|semap
parameter_list|,
name|uint16_t
modifier|*
name|mbox0p
parameter_list|)
block|{
name|uint32_t
name|r2hisr
decl_stmt|;
name|r2hisr
operator|=
name|BXR4
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU2400_R2HSTSLO
argument_list|)
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGDEBUG3
argument_list|,
literal|"RISC2HOST ISR 0x%x"
argument_list|,
name|r2hisr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r2hisr
operator|&
name|BIU2400_R2HST_INTR
operator|)
operator|==
literal|0
condition|)
block|{
operator|*
name|isrp
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
switch|switch
condition|(
name|r2hisr
operator|&
name|BIU2400_R2HST_ISTAT_MASK
condition|)
block|{
case|case
name|ISP2400R2HST_ROM_MBX_OK
case|:
case|case
name|ISP2400R2HST_ROM_MBX_FAIL
case|:
case|case
name|ISP2400R2HST_MBX_OK
case|:
case|case
name|ISP2400R2HST_MBX_FAIL
case|:
case|case
name|ISP2400R2HST_ASYNC_EVENT
case|:
operator|*
name|isrp
operator|=
name|r2hisr
operator|&
literal|0xffff
expr_stmt|;
operator|*
name|mbox0p
operator|=
operator|(
name|r2hisr
operator|>>
literal|16
operator|)
expr_stmt|;
operator|*
name|semap
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|ISP2400R2HST_RSPQ_UPDATE
case|:
case|case
name|ISP2400R2HST_ATIO_RSPQ_UPDATE
case|:
case|case
name|ISP2400R2HST_ATIO_RQST_UPDATE
case|:
operator|*
name|isrp
operator|=
name|r2hisr
operator|&
literal|0xffff
expr_stmt|;
operator|*
name|mbox0p
operator|=
literal|0
expr_stmt|;
operator|*
name|semap
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
default|default:
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|BIU2400_HCCR
argument_list|,
name|HCCR_2400_CMD_CLEAR_RISC_INT
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"unknown interrupt 0x%x\n"
argument_list|,
name|r2hisr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|isp_pci_rd_reg
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|regoff
parameter_list|)
block|{
name|uint16_t
name|rv
decl_stmt|;
name|int
name|oldconf
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|regoff
operator|&
name|_BLK_REG_MASK
operator|)
operator|==
name|SXP_BLOCK
condition|)
block|{
comment|/* 		 * We will assume that someone has paused the RISC processor. 		 */
name|oldconf
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|)
expr_stmt|;
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
name|oldconf
operator||
name|BIU_PCI_CONF1_SXP
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regoff
operator|&
name|_BLK_REG_MASK
operator|)
operator|==
name|SXP_BLOCK
condition|)
block|{
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
name|oldconf
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_pci_wr_reg
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|regoff
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|int
name|oldconf
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|regoff
operator|&
name|_BLK_REG_MASK
operator|)
operator|==
name|SXP_BLOCK
condition|)
block|{
comment|/* 		 * We will assume that someone has paused the RISC processor. 		 */
name|oldconf
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|)
expr_stmt|;
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
name|oldconf
operator||
name|BIU_PCI_CONF1_SXP
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regoff
operator|&
name|_BLK_REG_MASK
operator|)
operator|==
name|SXP_BLOCK
condition|)
block|{
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
name|oldconf
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|isp_pci_rd_reg_1080
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|regoff
parameter_list|)
block|{
name|uint32_t
name|rv
decl_stmt|,
name|oc
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|regoff
operator|&
name|_BLK_REG_MASK
operator|)
operator|==
name|SXP_BLOCK
operator|||
operator|(
name|regoff
operator|&
name|_BLK_REG_MASK
operator|)
operator|==
operator|(
name|SXP_BLOCK
operator||
name|SXP_BANK1_SELECT
operator|)
condition|)
block|{
name|uint32_t
name|tc
decl_stmt|;
comment|/* 		 * We will assume that someone has paused the RISC processor. 		 */
name|oc
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|)
expr_stmt|;
name|tc
operator|=
name|oc
operator|&
operator|~
name|BIU_PCI1080_CONF1_DMA
expr_stmt|;
if|if
condition|(
name|regoff
operator|&
name|SXP_BANK1_SELECT
condition|)
name|tc
operator||=
name|BIU_PCI1080_CONF1_SXP1
expr_stmt|;
else|else
name|tc
operator||=
name|BIU_PCI1080_CONF1_SXP0
expr_stmt|;
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|regoff
operator|&
name|_BLK_REG_MASK
operator|)
operator|==
name|DMA_BLOCK
condition|)
block|{
name|oc
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|)
expr_stmt|;
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
name|oc
operator||
name|BIU_PCI1080_CONF1_DMA
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oc
condition|)
block|{
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
name|oc
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_pci_wr_reg_1080
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|regoff
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|int
name|oc
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|regoff
operator|&
name|_BLK_REG_MASK
operator|)
operator|==
name|SXP_BLOCK
operator|||
operator|(
name|regoff
operator|&
name|_BLK_REG_MASK
operator|)
operator|==
operator|(
name|SXP_BLOCK
operator||
name|SXP_BANK1_SELECT
operator|)
condition|)
block|{
name|uint32_t
name|tc
decl_stmt|;
comment|/* 		 * We will assume that someone has paused the RISC processor. 		 */
name|oc
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|)
expr_stmt|;
name|tc
operator|=
name|oc
operator|&
operator|~
name|BIU_PCI1080_CONF1_DMA
expr_stmt|;
if|if
condition|(
name|regoff
operator|&
name|SXP_BANK1_SELECT
condition|)
name|tc
operator||=
name|BIU_PCI1080_CONF1_SXP1
expr_stmt|;
else|else
name|tc
operator||=
name|BIU_PCI1080_CONF1_SXP0
expr_stmt|;
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|regoff
operator|&
name|_BLK_REG_MASK
operator|)
operator|==
name|DMA_BLOCK
condition|)
block|{
name|oc
operator|=
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|)
expr_stmt|;
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
name|oc
operator||
name|BIU_PCI1080_CONF1_DMA
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|oc
condition|)
block|{
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
name|oc
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|isp_pci_rd_reg_2400
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|regoff
parameter_list|)
block|{
name|uint32_t
name|rv
decl_stmt|;
name|int
name|block
init|=
name|regoff
operator|&
name|_BLK_REG_MASK
decl_stmt|;
switch|switch
condition|(
name|block
condition|)
block|{
case|case
name|BIU_BLOCK
case|:
break|break;
case|case
name|MBOX_BLOCK
case|:
return|return
operator|(
name|BXR2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|)
operator|)
return|;
case|case
name|SXP_BLOCK
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"SXP_BLOCK read at 0x%x"
argument_list|,
name|regoff
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0xffffffff
operator|)
return|;
case|case
name|RISC_BLOCK
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"RISC_BLOCK read at 0x%x"
argument_list|,
name|regoff
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0xffffffff
operator|)
return|;
case|case
name|DMA_BLOCK
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"DMA_BLOCK read at 0x%x"
argument_list|,
name|regoff
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0xffffffff
operator|)
return|;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"unknown block read at 0x%x"
argument_list|,
name|regoff
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0xffffffff
operator|)
return|;
block|}
switch|switch
condition|(
name|regoff
condition|)
block|{
case|case
name|BIU2400_FLASH_ADDR
case|:
case|case
name|BIU2400_FLASH_DATA
case|:
case|case
name|BIU2400_ICR
case|:
case|case
name|BIU2400_ISR
case|:
case|case
name|BIU2400_CSR
case|:
case|case
name|BIU2400_REQINP
case|:
case|case
name|BIU2400_REQOUTP
case|:
case|case
name|BIU2400_RSPINP
case|:
case|case
name|BIU2400_RSPOUTP
case|:
case|case
name|BIU2400_PRI_REQINP
case|:
case|case
name|BIU2400_PRI_REQOUTP
case|:
case|case
name|BIU2400_ATIO_RSPINP
case|:
case|case
name|BIU2400_ATIO_RSPOUTP
case|:
case|case
name|BIU2400_HCCR
case|:
case|case
name|BIU2400_GPIOD
case|:
case|case
name|BIU2400_GPIOE
case|:
case|case
name|BIU2400_HSEMA
case|:
name|rv
operator|=
name|BXR4
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BIU2400_R2HSTSLO
case|:
name|rv
operator|=
name|BXR4
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|BIU2400_R2HSTSHI
case|:
name|rv
operator|=
name|BXR4
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|)
operator|>>
literal|16
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"isp_pci_rd_reg_2400: unknown offset %x"
argument_list|,
name|regoff
argument_list|)
expr_stmt|;
name|rv
operator|=
literal|0xffffffff
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_pci_wr_reg_2400
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|int
name|regoff
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|int
name|block
init|=
name|regoff
operator|&
name|_BLK_REG_MASK
decl_stmt|;
switch|switch
condition|(
name|block
condition|)
block|{
case|case
name|BIU_BLOCK
case|:
break|break;
case|case
name|MBOX_BLOCK
case|:
name|BXW2
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return;
case|case
name|SXP_BLOCK
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"SXP_BLOCK write at 0x%x"
argument_list|,
name|regoff
argument_list|)
expr_stmt|;
return|return;
case|case
name|RISC_BLOCK
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"RISC_BLOCK write at 0x%x"
argument_list|,
name|regoff
argument_list|)
expr_stmt|;
return|return;
case|case
name|DMA_BLOCK
case|:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"DMA_BLOCK write at 0x%x"
argument_list|,
name|regoff
argument_list|)
expr_stmt|;
return|return;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGWARN
argument_list|,
literal|"unknown block write at 0x%x"
argument_list|,
name|regoff
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|regoff
condition|)
block|{
case|case
name|BIU2400_FLASH_ADDR
case|:
case|case
name|BIU2400_FLASH_DATA
case|:
case|case
name|BIU2400_ICR
case|:
case|case
name|BIU2400_ISR
case|:
case|case
name|BIU2400_CSR
case|:
case|case
name|BIU2400_REQINP
case|:
case|case
name|BIU2400_REQOUTP
case|:
case|case
name|BIU2400_RSPINP
case|:
case|case
name|BIU2400_RSPOUTP
case|:
case|case
name|BIU2400_PRI_REQINP
case|:
case|case
name|BIU2400_PRI_REQOUTP
case|:
case|case
name|BIU2400_ATIO_RSPINP
case|:
case|case
name|BIU2400_ATIO_RSPOUTP
case|:
case|case
name|BIU2400_HCCR
case|:
case|case
name|BIU2400_GPIOD
case|:
case|case
name|BIU2400_GPIOE
case|:
case|case
name|BIU2400_HSEMA
case|:
name|BXW4
argument_list|(
name|isp
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|MEMORYBARRIER
argument_list|(
name|isp
argument_list|,
name|SYNC_REG
argument_list|,
name|IspVirt2Off
argument_list|(
name|isp
argument_list|,
name|regoff
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
break|break;
default|default:
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"isp_pci_wr_reg_2400: bad offset 0x%x"
argument_list|,
name|regoff
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_struct
struct|struct
name|imush
block|{
name|ispsoftc_t
modifier|*
name|isp
decl_stmt|;
name|caddr_t
name|vbase
decl_stmt|;
name|int
name|chan
decl_stmt|;
name|int
name|error
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|imc
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|imc1
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|imc
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|imush
modifier|*
name|imushp
init|=
operator|(
expr|struct
name|imush
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|imushp
operator|->
name|error
operator|=
name|error
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|nseg
operator|!=
literal|1
condition|)
block|{
name|imushp
operator|->
name|error
operator|=
name|EINVAL
expr_stmt|;
return|return;
block|}
name|imushp
operator|->
name|isp
operator|->
name|isp_rquest
operator|=
name|imushp
operator|->
name|vbase
expr_stmt|;
name|imushp
operator|->
name|isp
operator|->
name|isp_rquest_dma
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
name|segs
operator|->
name|ds_addr
operator|+=
name|ISP_QUEUE_SIZE
argument_list|(
name|RQUEST_QUEUE_LEN
argument_list|(
name|imushp
operator|->
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|imushp
operator|->
name|vbase
operator|+=
name|ISP_QUEUE_SIZE
argument_list|(
name|RQUEST_QUEUE_LEN
argument_list|(
name|imushp
operator|->
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|imushp
operator|->
name|isp
operator|->
name|isp_result_dma
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
name|imushp
operator|->
name|isp
operator|->
name|isp_result
operator|=
name|imushp
operator|->
name|vbase
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|IS_24XX
argument_list|(
name|imushp
operator|->
name|isp
argument_list|)
condition|)
block|{
name|segs
operator|->
name|ds_addr
operator|+=
name|ISP_QUEUE_SIZE
argument_list|(
name|RESULT_QUEUE_LEN
argument_list|(
name|imushp
operator|->
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|imushp
operator|->
name|vbase
operator|+=
name|ISP_QUEUE_SIZE
argument_list|(
name|RESULT_QUEUE_LEN
argument_list|(
name|imushp
operator|->
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|imushp
operator|->
name|isp
operator|->
name|isp_atioq_dma
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
name|imushp
operator|->
name|isp
operator|->
name|isp_atioq
operator|=
name|imushp
operator|->
name|vbase
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|imc1
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|imush
modifier|*
name|imushp
init|=
operator|(
expr|struct
name|imush
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|imushp
operator|->
name|error
operator|=
name|error
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|nseg
operator|!=
literal|1
condition|)
block|{
name|imushp
operator|->
name|error
operator|=
name|EINVAL
expr_stmt|;
return|return;
block|}
name|FCPARAM
argument_list|(
name|imushp
operator|->
name|isp
argument_list|,
name|imushp
operator|->
name|chan
argument_list|)
operator|->
name|isp_scdma
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
name|FCPARAM
argument_list|(
name|imushp
operator|->
name|isp
argument_list|,
name|imushp
operator|->
name|chan
argument_list|)
operator|->
name|isp_scratch
operator|=
name|imushp
operator|->
name|vbase
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|isp_pci_mbxdma
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|)
block|{
name|caddr_t
name|base
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|ns
decl_stmt|,
name|cmap
init|=
literal|0
decl_stmt|;
name|bus_size_t
name|slim
decl_stmt|;
comment|/* segment size */
name|bus_addr_t
name|llim
decl_stmt|;
comment|/* low limit of unavailable dma */
name|bus_addr_t
name|hlim
decl_stmt|;
comment|/* high limit of unavailable dma */
name|struct
name|imush
name|im
decl_stmt|;
comment|/* 	 * Already been here? If so, leave... 	 */
if|if
condition|(
name|isp
operator|->
name|isp_rquest
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ISP_UNLOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_maxcmds
operator|==
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"maxcmds not set"
argument_list|)
expr_stmt|;
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|hlim
operator|=
name|BUS_SPACE_MAXADDR
expr_stmt|;
if|if
condition|(
name|IS_ULTRA2
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_FC
argument_list|(
name|isp
argument_list|)
operator|||
name|IS_1240
argument_list|(
name|isp
argument_list|)
condition|)
block|{
if|if
condition|(
sizeof|sizeof
argument_list|(
name|bus_size_t
argument_list|)
operator|>
literal|4
condition|)
block|{
name|slim
operator|=
call|(
name|bus_size_t
call|)
argument_list|(
literal|1ULL
operator|<<
literal|32
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|slim
operator|=
call|(
name|bus_size_t
call|)
argument_list|(
literal|1UL
operator|<<
literal|31
argument_list|)
expr_stmt|;
block|}
name|llim
operator|=
name|BUS_SPACE_MAXADDR
expr_stmt|;
block|}
else|else
block|{
name|llim
operator|=
name|BUS_SPACE_MAXADDR_32BIT
expr_stmt|;
name|slim
operator|=
operator|(
literal|1UL
operator|<<
literal|24
operator|)
expr_stmt|;
block|}
name|len
operator|=
name|isp
operator|->
name|isp_maxcmds
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|isp_pcmd
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
operator|=
operator|(
expr|struct
name|isp_pcmd
operator|*
operator|)
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
operator|==
name|NULL
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"cannot allocate pcmds"
argument_list|)
expr_stmt|;
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* 	 * XXX: We don't really support 64 bit target mode for parallel scsi yet 	 */
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
operator|&&
sizeof|sizeof
argument_list|(
name|bus_addr_t
argument_list|)
operator|>
literal|4
condition|)
block|{
name|free
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"we cannot do DAC for SPI cards yet"
argument_list|)
expr_stmt|;
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|isp_dma_tag_create
argument_list|(
name|BUS_DMA_ROOTARG
argument_list|(
name|ISP_PCD
argument_list|(
name|isp
argument_list|)
argument_list|)
argument_list|,
literal|1
argument_list|,
name|slim
argument_list|,
name|llim
argument_list|,
name|hlim
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|BUS_SPACE_MAXSIZE
argument_list|,
name|ISP_NSEGS
argument_list|,
name|slim
argument_list|,
literal|0
argument_list|,
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"could not create master dma tag"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|isp_hdl_t
argument_list|)
operator|*
name|isp
operator|->
name|isp_maxcmds
expr_stmt|;
name|isp
operator|->
name|isp_xflist
operator|=
operator|(
name|isp_hdl_t
operator|*
operator|)
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_xflist
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"cannot alloc xflist array"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
for|for
control|(
name|len
operator|=
literal|0
init|;
name|len
operator|<
name|isp
operator|->
name|isp_maxcmds
operator|-
literal|1
condition|;
name|len
operator|++
control|)
block|{
name|isp
operator|->
name|isp_xflist
index|[
name|len
index|]
operator|.
name|cmd
operator|=
operator|&
name|isp
operator|->
name|isp_xflist
index|[
name|len
operator|+
literal|1
index|]
expr_stmt|;
block|}
name|isp
operator|->
name|isp_xffree
operator|=
name|isp
operator|->
name|isp_xflist
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
name|len
operator|=
sizeof|sizeof
argument_list|(
name|isp_hdl_t
operator|*
argument_list|)
operator|*
name|isp
operator|->
name|isp_maxcmds
expr_stmt|;
name|isp
operator|->
name|isp_tgtlist
operator|=
operator|(
name|isp_hdl_t
operator|*
operator|)
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|isp
operator|->
name|isp_tgtlist
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|isp
operator|->
name|isp_xflist
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"cannot alloc tgtlist array"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
for|for
control|(
name|len
operator|=
literal|0
init|;
name|len
operator|<
name|isp
operator|->
name|isp_maxcmds
operator|-
literal|1
condition|;
name|len
operator|++
control|)
block|{
name|isp
operator|->
name|isp_tgtlist
index|[
name|len
index|]
operator|.
name|cmd
operator|=
operator|&
name|isp
operator|->
name|isp_tgtlist
index|[
name|len
operator|+
literal|1
index|]
expr_stmt|;
block|}
name|isp
operator|->
name|isp_tgtfree
operator|=
name|isp
operator|->
name|isp_tgtlist
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * Allocate and map the request and result queues (and ATIO queue 	 * if we're a 2400 supporting target mode). 	 */
name|len
operator|=
name|ISP_QUEUE_SIZE
argument_list|(
name|RQUEST_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|+=
name|ISP_QUEUE_SIZE
argument_list|(
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|len
operator|+=
name|ISP_QUEUE_SIZE
argument_list|(
name|RESULT_QUEUE_LEN
argument_list|(
name|isp
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|ns
operator|=
operator|(
name|len
operator|/
name|PAGE_SIZE
operator|)
operator|+
literal|1
expr_stmt|;
comment|/* 	 * Create a tag for the control spaces. We don't always need this 	 * to be 32 bits, but we do this for simplicity and speed's sake. 	 */
if|if
condition|(
name|isp_dma_tag_create
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
name|QENTRY_LEN
argument_list|,
name|slim
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|len
argument_list|,
name|ns
argument_list|,
name|slim
argument_list|,
literal|0
argument_list|,
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|cdmat
argument_list|)
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"cannot create a dma tag for control spaces"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|isp
operator|->
name|isp_xflist
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
name|free
argument_list|(
name|isp
operator|->
name|isp_tgtlist
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|cdmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|base
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|cdmap
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"cannot allocate %d bytes of CCB memory"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|cdmat
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|isp
operator|->
name|isp_xflist
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
name|free
argument_list|(
name|isp
operator|->
name|isp_tgtlist
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|im
operator|.
name|isp
operator|=
name|isp
expr_stmt|;
name|im
operator|.
name|chan
operator|=
literal|0
expr_stmt|;
name|im
operator|.
name|vbase
operator|=
name|base
expr_stmt|;
name|im
operator|.
name|error
operator|=
literal|0
expr_stmt|;
name|bus_dmamap_load
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|cdmat
argument_list|,
name|isp
operator|->
name|isp_osinfo
operator|.
name|cdmap
argument_list|,
name|base
argument_list|,
name|len
argument_list|,
name|imc
argument_list|,
operator|&
name|im
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|im
operator|.
name|error
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"error %d loading dma map for control areas"
argument_list|,
name|im
operator|.
name|error
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|IS_FC
argument_list|(
name|isp
argument_list|)
condition|)
block|{
for|for
control|(
name|cmap
operator|=
literal|0
init|;
name|cmap
operator|<
name|isp
operator|->
name|isp_nchan
condition|;
name|cmap
operator|++
control|)
block|{
name|struct
name|isp_fc
modifier|*
name|fc
init|=
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|cmap
argument_list|)
decl_stmt|;
if|if
condition|(
name|isp_dma_tag_create
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
literal|64
argument_list|,
name|slim
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ISP_FC_SCRLEN
argument_list|,
literal|1
argument_list|,
name|slim
argument_list|,
literal|0
argument_list|,
operator|&
name|fc
operator|->
name|tdmat
argument_list|)
condition|)
block|{
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|fc
operator|->
name|tdmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|base
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|fc
operator|->
name|tdmap
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|fc
operator|->
name|tdmat
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|im
operator|.
name|isp
operator|=
name|isp
expr_stmt|;
name|im
operator|.
name|chan
operator|=
name|cmap
expr_stmt|;
name|im
operator|.
name|vbase
operator|=
name|base
expr_stmt|;
name|im
operator|.
name|error
operator|=
literal|0
expr_stmt|;
name|bus_dmamap_load
argument_list|(
name|fc
operator|->
name|tdmat
argument_list|,
name|fc
operator|->
name|tdmap
argument_list|,
name|base
argument_list|,
name|ISP_FC_SCRLEN
argument_list|,
name|imc1
argument_list|,
operator|&
name|im
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|im
operator|.
name|error
condition|)
block|{
name|bus_dmamem_free
argument_list|(
name|fc
operator|->
name|tdmat
argument_list|,
name|base
argument_list|,
name|fc
operator|->
name|tdmap
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|fc
operator|->
name|tdmat
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|isp
operator|->
name|isp_maxcmds
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|isp_pcmd
modifier|*
name|pcmd
init|=
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
index|[
name|i
index|]
decl_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
literal|0
argument_list|,
operator|&
name|pcmd
operator|->
name|dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"error %d creating per-cmd DMA maps"
argument_list|,
name|error
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
index|[
name|i
index|]
operator|.
name|dmap
argument_list|)
expr_stmt|;
block|}
goto|goto
name|bad
goto|;
block|}
name|callout_init_mtx
argument_list|(
operator|&
name|pcmd
operator|->
name|wdog
argument_list|,
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|isp
operator|->
name|isp_maxcmds
operator|-
literal|1
condition|)
block|{
name|pcmd
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|pcmd
operator|->
name|next
operator|=
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
block|}
block|}
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_free
operator|=
operator|&
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
index|[
literal|0
index|]
expr_stmt|;
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|bad
label|:
while|while
condition|(
operator|--
name|cmap
operator|>=
literal|0
condition|)
block|{
name|struct
name|isp_fc
modifier|*
name|fc
init|=
name|ISP_FC_PC
argument_list|(
name|isp
argument_list|,
name|cmap
argument_list|)
decl_stmt|;
name|bus_dmamem_free
argument_list|(
name|fc
operator|->
name|tdmat
argument_list|,
name|base
argument_list|,
name|fc
operator|->
name|tdmap
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|fc
operator|->
name|tdmat
argument_list|)
expr_stmt|;
block|}
name|bus_dmamem_free
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|cdmat
argument_list|,
name|base
argument_list|,
name|isp
operator|->
name|isp_osinfo
operator|.
name|cdmap
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|cdmat
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|isp
operator|->
name|isp_xflist
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
name|free
argument_list|(
name|isp
operator|->
name|isp_tgtlist
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|free
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|pcmd_pool
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|isp
operator|->
name|isp_rquest
operator|=
name|NULL
expr_stmt|;
name|ISP_LOCK
argument_list|(
name|isp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
block|{
name|ispsoftc_t
modifier|*
name|isp
decl_stmt|;
name|void
modifier|*
name|cmd_token
decl_stmt|;
name|void
modifier|*
name|rq
decl_stmt|;
comment|/* original request */
name|int
name|error
decl_stmt|;
name|bus_size_t
name|mapsize
decl_stmt|;
block|}
name|mush_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|MUSHERR_NOQENTRIES
value|-2
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
end_ifdef

begin_function_decl
specifier|static
name|void
name|tdma2_2
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|bus_size_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tdma2
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|tdma2_2
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|dm_segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|bus_size_t
name|mapsize
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|mush_t
modifier|*
name|mp
decl_stmt|;
name|mp
operator|=
operator|(
name|mush_t
operator|*
operator|)
name|arg
expr_stmt|;
name|mp
operator|->
name|mapsize
operator|=
name|mapsize
expr_stmt|;
name|tdma2
argument_list|(
name|arg
argument_list|,
name|dm_segs
argument_list|,
name|nseg
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|tdma2
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|dm_segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|mush_t
modifier|*
name|mp
decl_stmt|;
name|ispsoftc_t
modifier|*
name|isp
decl_stmt|;
name|struct
name|ccb_scsiio
modifier|*
name|csio
decl_stmt|;
name|isp_ddir_t
name|ddir
decl_stmt|;
name|ispreq_t
modifier|*
name|rq
decl_stmt|;
name|mp
operator|=
operator|(
name|mush_t
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|mp
operator|->
name|error
operator|=
name|error
expr_stmt|;
return|return;
block|}
name|csio
operator|=
name|mp
operator|->
name|cmd_token
expr_stmt|;
name|isp
operator|=
name|mp
operator|->
name|isp
expr_stmt|;
name|rq
operator|=
name|mp
operator|->
name|rq
expr_stmt|;
if|if
condition|(
name|nseg
condition|)
block|{
if|if
condition|(
sizeof|sizeof
argument_list|(
name|bus_addr_t
argument_list|)
operator|>
literal|4
condition|)
block|{
if|if
condition|(
name|nseg
operator|>=
name|ISP_NSEG64_MAX
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"number of segments (%d) exceed maximum we can support (%d)"
argument_list|,
name|nseg
argument_list|,
name|ISP_NSEG64_MAX
argument_list|)
expr_stmt|;
name|mp
operator|->
name|error
operator|=
name|EFAULT
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rq
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|==
name|RQSTYPE_CTIO2
condition|)
block|{
name|rq
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_CTIO3
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|nseg
operator|>=
name|ISP_NSEG_MAX
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"number of segments (%d) exceed maximum we can support (%d)"
argument_list|,
name|nseg
argument_list|,
name|ISP_NSEG_MAX
argument_list|)
expr_stmt|;
name|mp
operator|->
name|error
operator|=
name|EFAULT
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
operator|(
name|csio
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
name|PISP_PCMD
argument_list|(
name|csio
argument_list|)
operator|->
name|dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|ddir
operator|=
name|ISP_TO_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|csio
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_OUT
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
name|PISP_PCMD
argument_list|(
name|csio
argument_list|)
operator|->
name|dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|ddir
operator|=
name|ISP_FROM_DEVICE
expr_stmt|;
block|}
else|else
block|{
name|ddir
operator|=
name|ISP_NOXFR
expr_stmt|;
block|}
block|}
else|else
block|{
name|dm_segs
operator|=
name|NULL
expr_stmt|;
name|nseg
operator|=
literal|0
expr_stmt|;
name|ddir
operator|=
name|ISP_NOXFR
expr_stmt|;
block|}
if|if
condition|(
name|isp_send_tgt_cmd
argument_list|(
name|isp
argument_list|,
name|rq
argument_list|,
name|dm_segs
argument_list|,
name|nseg
argument_list|,
name|XS_XFRLEN
argument_list|(
name|csio
argument_list|)
argument_list|,
name|ddir
argument_list|,
operator|&
name|csio
operator|->
name|sense_data
argument_list|,
name|csio
operator|->
name|sense_len
argument_list|)
operator|!=
name|CMD_QUEUED
condition|)
block|{
name|mp
operator|->
name|error
operator|=
name|MUSHERR_NOQENTRIES
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|dma2_2
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|bus_size_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dma2
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|dma2_2
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|dm_segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|bus_size_t
name|mapsize
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|mush_t
modifier|*
name|mp
decl_stmt|;
name|mp
operator|=
operator|(
name|mush_t
operator|*
operator|)
name|arg
expr_stmt|;
name|mp
operator|->
name|mapsize
operator|=
name|mapsize
expr_stmt|;
name|dma2
argument_list|(
name|arg
argument_list|,
name|dm_segs
argument_list|,
name|nseg
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dma2
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|dm_segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|mush_t
modifier|*
name|mp
decl_stmt|;
name|ispsoftc_t
modifier|*
name|isp
decl_stmt|;
name|struct
name|ccb_scsiio
modifier|*
name|csio
decl_stmt|;
name|isp_ddir_t
name|ddir
decl_stmt|;
name|ispreq_t
modifier|*
name|rq
decl_stmt|;
name|mp
operator|=
operator|(
name|mush_t
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|mp
operator|->
name|error
operator|=
name|error
expr_stmt|;
return|return;
block|}
name|csio
operator|=
name|mp
operator|->
name|cmd_token
expr_stmt|;
name|isp
operator|=
name|mp
operator|->
name|isp
expr_stmt|;
name|rq
operator|=
name|mp
operator|->
name|rq
expr_stmt|;
if|if
condition|(
name|nseg
condition|)
block|{
if|if
condition|(
sizeof|sizeof
argument_list|(
name|bus_addr_t
argument_list|)
operator|>
literal|4
condition|)
block|{
if|if
condition|(
name|nseg
operator|>=
name|ISP_NSEG64_MAX
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"number of segments (%d) exceed maximum we can support (%d)"
argument_list|,
name|nseg
argument_list|,
name|ISP_NSEG64_MAX
argument_list|)
expr_stmt|;
name|mp
operator|->
name|error
operator|=
name|EFAULT
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rq
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|==
name|RQSTYPE_T2RQS
condition|)
block|{
name|rq
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_T3RQS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rq
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|==
name|RQSTYPE_REQUEST
condition|)
block|{
name|rq
operator|->
name|req_header
operator|.
name|rqs_entry_type
operator|=
name|RQSTYPE_A64
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|nseg
operator|>=
name|ISP_NSEG_MAX
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"number of segments (%d) exceed maximum we can support (%d)"
argument_list|,
name|nseg
argument_list|,
name|ISP_NSEG_MAX
argument_list|)
expr_stmt|;
name|mp
operator|->
name|error
operator|=
name|EFAULT
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
operator|(
name|csio
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
name|PISP_PCMD
argument_list|(
name|csio
argument_list|)
operator|->
name|dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|ddir
operator|=
name|ISP_FROM_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|csio
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_OUT
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
name|PISP_PCMD
argument_list|(
name|csio
argument_list|)
operator|->
name|dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|ddir
operator|=
name|ISP_TO_DEVICE
expr_stmt|;
block|}
else|else
block|{
name|ddir
operator|=
name|ISP_NOXFR
expr_stmt|;
block|}
block|}
else|else
block|{
name|dm_segs
operator|=
name|NULL
expr_stmt|;
name|nseg
operator|=
literal|0
expr_stmt|;
name|ddir
operator|=
name|ISP_NOXFR
expr_stmt|;
block|}
if|if
condition|(
name|isp_send_cmd
argument_list|(
name|isp
argument_list|,
name|rq
argument_list|,
name|dm_segs
argument_list|,
name|nseg
argument_list|,
name|XS_XFRLEN
argument_list|(
name|csio
argument_list|)
argument_list|,
name|ddir
argument_list|)
operator|!=
name|CMD_QUEUED
condition|)
block|{
name|mp
operator|->
name|error
operator|=
name|MUSHERR_NOQENTRIES
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|isp_pci_dmasetup
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
name|struct
name|ccb_scsiio
modifier|*
name|csio
parameter_list|,
name|void
modifier|*
name|ff
parameter_list|)
block|{
name|mush_t
name|mush
decl_stmt|,
modifier|*
name|mp
decl_stmt|;
name|void
function_decl|(
modifier|*
name|eptr
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|eptr2
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|bus_size_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
name|mp
operator|=
operator|&
name|mush
expr_stmt|;
name|mp
operator|->
name|isp
operator|=
name|isp
expr_stmt|;
name|mp
operator|->
name|cmd_token
operator|=
name|csio
expr_stmt|;
name|mp
operator|->
name|rq
operator|=
name|ff
expr_stmt|;
name|mp
operator|->
name|error
operator|=
literal|0
expr_stmt|;
name|mp
operator|->
name|mapsize
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|ISP_TARGET_MODE
if|if
condition|(
name|csio
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_CONT_TARGET_IO
condition|)
block|{
name|eptr
operator|=
name|tdma2
expr_stmt|;
name|eptr2
operator|=
name|tdma2_2
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|eptr
operator|=
name|dma2
expr_stmt|;
name|eptr2
operator|=
name|dma2_2
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|csio
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_NONE
operator|||
operator|(
name|csio
operator|->
name|dxfer_len
operator|==
literal|0
operator|)
condition|)
block|{
call|(
modifier|*
name|eptr
call|)
argument_list|(
name|mp
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|csio
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_SCATTER_VALID
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|csio
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DATA_PHYS
operator|)
operator|==
literal|0
condition|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
name|PISP_PCMD
argument_list|(
name|csio
argument_list|)
operator|->
name|dmap
argument_list|,
name|csio
operator|->
name|data_ptr
argument_list|,
name|csio
operator|->
name|dxfer_len
argument_list|,
name|eptr
argument_list|,
name|mp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|xpt_print(csio->ccb_h.path, "%s: bus_dmamap_load " "ptr %p len %d returned %d\n", __func__, csio->data_ptr, csio->dxfer_len, error);
endif|#
directive|endif
if|if
condition|(
name|error
operator|==
name|EINPROGRESS
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
name|PISP_PCMD
argument_list|(
name|csio
argument_list|)
operator|->
name|dmap
argument_list|)
expr_stmt|;
name|mp
operator|->
name|error
operator|=
name|EINVAL
expr_stmt|;
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"deferred dma allocation not supported"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|&&
name|mp
operator|->
name|error
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DIAGNOSTIC
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"error %d in dma mapping code"
argument_list|,
name|error
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|mp
operator|->
name|error
operator|=
name|error
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Pointer to physical buffer */
name|struct
name|bus_dma_segment
name|seg
decl_stmt|;
name|seg
operator|.
name|ds_addr
operator|=
operator|(
name|bus_addr_t
operator|)
operator|(
name|vm_offset_t
operator|)
name|csio
operator|->
name|data_ptr
expr_stmt|;
name|seg
operator|.
name|ds_len
operator|=
name|csio
operator|->
name|dxfer_len
expr_stmt|;
call|(
modifier|*
name|eptr
call|)
argument_list|(
name|mp
argument_list|,
operator|&
name|seg
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|struct
name|bus_dma_segment
modifier|*
name|segs
decl_stmt|;
if|if
condition|(
operator|(
name|csio
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DATA_PHYS
operator|)
operator|!=
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"Physical segment pointers unsupported"
argument_list|)
expr_stmt|;
name|mp
operator|->
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|csio
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_SG_LIST_PHYS
operator|)
operator|==
literal|0
condition|)
block|{
name|struct
name|uio
name|sguio
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* 			 * We're taking advantage of the fact that 			 * the pointer/length sizes and layout of the iovec 			 * structure are the same as the bus_dma_segment 			 * structure.  This might be a little dangerous, 			 * but only if they change the structures, which 			 * seems unlikely. 			 */
name|KASSERT
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|sguio
operator|.
name|uio_iov
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|csio
operator|->
name|data_ptr
argument_list|)
operator|&&
sizeof|sizeof
argument_list|(
name|sguio
operator|.
name|uio_iovcnt
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|csio
operator|->
name|sglist_cnt
argument_list|)
operator|&&
sizeof|sizeof
argument_list|(
name|sguio
operator|.
name|uio_resid
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|csio
operator|->
name|dxfer_len
argument_list|)
operator|)
argument_list|,
operator|(
literal|"Ken's assumption failed"
operator|)
argument_list|)
expr_stmt|;
name|sguio
operator|.
name|uio_iov
operator|=
operator|(
expr|struct
name|iovec
operator|*
operator|)
name|csio
operator|->
name|data_ptr
expr_stmt|;
name|sguio
operator|.
name|uio_iovcnt
operator|=
name|csio
operator|->
name|sglist_cnt
expr_stmt|;
name|sguio
operator|.
name|uio_resid
operator|=
name|csio
operator|->
name|dxfer_len
expr_stmt|;
name|sguio
operator|.
name|uio_segflg
operator|=
name|UIO_SYSSPACE
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_uio
argument_list|(
name|isp
operator|->
name|isp_osinfo
operator|.
name|dmat
argument_list|,
name|PISP_PCMD
argument_list|(
name|csio
argument_list|)
operator|->
name|dmap
argument_list|,
operator|&
name|sguio
argument_list|,
name|eptr2
argument_list|,
name|mp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
operator|&&
name|mp
operator|->
name|error
operator|==
literal|0
condition|)
block|{
name|isp_prt
argument_list|(
name|isp
argument_list|,
name|ISP_LOGERR
argument_list|,
literal|"error %d in dma mapping code"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|mp
operator|->
name|error
operator|=
name|error
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Just use the segments provided */
name|segs
operator|=
operator|(
expr|struct
name|bus_dma_segment
operator|*
operator|)
name|csio
operator|->
name|data_ptr
expr_stmt|;
call|(
modifier|*
name|eptr
call|)
argument_list|(
name|mp
argument_list|,
name|segs
argument_list|,
name|csio
operator|->
name|sglist_cnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mp
operator|->
name|error
condition|)
block|{
name|int
name|retval
init|=
name|CMD_COMPLETE
decl_stmt|;
if|if
condition|(
name|mp
operator|->
name|error
operator|==
name|MUSHERR_NOQENTRIES
condition|)
block|{
name|retval
operator|=
name|CMD_EAGAIN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mp
operator|->
name|error
operator|==
name|EFBIG
condition|)
block|{
name|XS_SETERR
argument_list|(
name|csio
argument_list|,
name|CAM_REQ_TOO_BIG
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mp
operator|->
name|error
operator|==
name|EINVAL
condition|)
block|{
name|XS_SETERR
argument_list|(
name|csio
argument_list|,
name|CAM_REQ_INVALID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|XS_SETERR
argument_list|(
name|csio
argument_list|,
name|CAM_UNREC_HBA_ERROR
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|retval
operator|)
return|;
block|}
return|return
operator|(
name|CMD_QUEUED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_pci_reset0
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|)
block|{
name|ISP_DISABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_pci_reset1
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|)
block|{
if|if
condition|(
operator|!
name|IS_24XX
argument_list|(
name|isp
argument_list|)
condition|)
block|{
comment|/* Make sure the BIOS is disabled */
name|isp_pci_wr_reg
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|PCI_HCCR_CMD_BIOS
argument_list|)
expr_stmt|;
block|}
comment|/* and enable interrupts */
name|ISP_ENABLE_INTS
argument_list|(
name|isp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|isp_pci_dumpregs
parameter_list|(
name|ispsoftc_t
modifier|*
name|isp
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|isp_pcisoftc
modifier|*
name|pcs
init|=
operator|(
expr|struct
name|isp_pcisoftc
operator|*
operator|)
name|isp
decl_stmt|;
if|if
condition|(
name|msg
condition|)
name|printf
argument_list|(
literal|"%s: %s\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|isp
operator|->
name|isp_dev
argument_list|)
argument_list|,
name|msg
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s:\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|isp
operator|->
name|isp_dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
name|printf
argument_list|(
literal|"    biu_conf1=%x"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_CONF1
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"    biu_csr=%x"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU2100_CSR
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" biu_icr=%x biu_isr=%x biu_sema=%x "
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_ICR
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_ISR
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|BIU_SEMA
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"risc_hccr=%x\n"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_SCSI
argument_list|(
name|isp
argument_list|)
condition|)
block|{
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_PAUSE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    cdma_conf=%x cdma_sts=%x cdma_fifostat=%x\n"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|CDMA_CONF
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|CDMA_STATUS
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|CDMA_FIFO_STS
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    ddma_conf=%x ddma_sts=%x ddma_fifostat=%x\n"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|DDMA_CONF
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|DDMA_STATUS
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|DDMA_FIFO_STS
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    sxp_int=%x sxp_gross=%x sxp(scsi_ctrl)=%x\n"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|SXP_INTERRUPT
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|SXP_GROSS_ERR
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|SXP_PINS_CTRL
argument_list|)
argument_list|)
expr_stmt|;
name|ISP_WRITE
argument_list|(
name|isp
argument_list|,
name|HCCR
argument_list|,
name|HCCR_CMD_RELEASE
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"    mbox regs: %x %x %x %x %x\n"
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX0
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX1
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX2
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX3
argument_list|)
argument_list|,
name|ISP_READ
argument_list|(
name|isp
argument_list|,
name|OUTMAILBOX4
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    PCI Status Command/Status=%x\n"
argument_list|,
name|pci_read_config
argument_list|(
name|pcs
operator|->
name|pci_dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


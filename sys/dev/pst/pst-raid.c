begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2001,2002,2003 SÃ¸ren Schmidt<sos@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/eventhandler.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<geom/geom_disk.h>
end_include

begin_include
include|#
directive|include
file|"dev/pst/pst-iop.h"
end_include

begin_struct
struct|struct
name|pst_softc
block|{
name|struct
name|iop_softc
modifier|*
name|iop
decl_stmt|;
name|struct
name|i2o_lct_entry
modifier|*
name|lct
decl_stmt|;
name|struct
name|i2o_bsa_device
modifier|*
name|info
decl_stmt|;
name|struct
name|disk
name|disk
decl_stmt|;
name|struct
name|bio_queue_head
name|queue
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|pst_request
block|{
name|struct
name|pst_softc
modifier|*
name|psc
decl_stmt|;
comment|/* pointer to softc */
name|u_int32_t
name|mfa
decl_stmt|;
comment|/* frame addreess */
name|struct
name|callout_handle
name|timeout_handle
decl_stmt|;
comment|/* handle for untimeout */
name|struct
name|bio
modifier|*
name|bp
decl_stmt|;
comment|/* associated bio ptr */
block|}
struct|;
end_struct

begin_comment
comment|/* prototypes */
end_comment

begin_decl_stmt
specifier|static
name|disk_strategy_t
name|pststrategy
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|pst_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pst_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pst_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pst_start
parameter_list|(
name|struct
name|pst_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pst_done
parameter_list|(
name|struct
name|iop_softc
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|,
name|struct
name|i2o_single_reply
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pst_rw
parameter_list|(
name|struct
name|pst_request
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pst_timeout
parameter_list|(
name|struct
name|pst_request
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bpack
parameter_list|(
name|int8_t
modifier|*
parameter_list|,
name|int8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* local vars */
end_comment

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_PSTRAID
argument_list|,
literal|"pst"
argument_list|,
literal|"Promise SuperTrak RAID driver"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|pst_add_raid
parameter_list|(
name|struct
name|iop_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|i2o_lct_entry
modifier|*
name|lct
parameter_list|)
block|{
name|struct
name|pst_softc
modifier|*
name|psc
decl_stmt|;
name|device_t
name|child
init|=
name|device_add_child
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"pst"
argument_list|,
operator|-
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|child
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
operator|!
operator|(
name|psc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|pst_softc
argument_list|)
argument_list|,
name|M_PSTRAID
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
name|device_delete_child
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|child
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|psc
operator|->
name|iop
operator|=
name|sc
expr_stmt|;
name|psc
operator|->
name|lct
operator|=
name|lct
expr_stmt|;
name|device_set_softc
argument_list|(
name|child
argument_list|,
name|psc
argument_list|)
expr_stmt|;
return|return
name|bus_generic_attach
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pst_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Promise SuperTrak RAID"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pst_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|pst_softc
modifier|*
name|psc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|i2o_get_param_reply
modifier|*
name|reply
decl_stmt|;
name|struct
name|i2o_device_identity
modifier|*
name|ident
decl_stmt|;
name|int
name|lun
init|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int8_t
name|name
index|[
literal|32
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|reply
operator|=
name|iop_get_util_params
argument_list|(
name|psc
operator|->
name|iop
argument_list|,
name|psc
operator|->
name|lct
operator|->
name|local_tid
argument_list|,
name|I2O_PARAMS_OPERATION_FIELD_GET
argument_list|,
name|I2O_BSA_DEVICE_INFO_GROUP_NO
argument_list|)
operator|)
condition|)
return|return
name|ENODEV
return|;
if|if
condition|(
operator|!
operator|(
name|psc
operator|->
name|info
operator|=
operator|(
expr|struct
name|i2o_bsa_device
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|i2o_bsa_device
argument_list|)
argument_list|,
name|M_PSTRAID
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
condition|)
block|{
name|contigfree
argument_list|(
name|reply
argument_list|,
name|PAGE_SIZE
argument_list|,
name|M_PSTRAID
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|bcopy
argument_list|(
name|reply
operator|->
name|result
argument_list|,
name|psc
operator|->
name|info
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i2o_bsa_device
argument_list|)
argument_list|)
expr_stmt|;
name|contigfree
argument_list|(
name|reply
argument_list|,
name|PAGE_SIZE
argument_list|,
name|M_PSTRAID
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reply
operator|=
name|iop_get_util_params
argument_list|(
name|psc
operator|->
name|iop
argument_list|,
name|psc
operator|->
name|lct
operator|->
name|local_tid
argument_list|,
name|I2O_PARAMS_OPERATION_FIELD_GET
argument_list|,
name|I2O_UTIL_DEVICE_IDENTITY_GROUP_NO
argument_list|)
operator|)
condition|)
return|return
name|ENODEV
return|;
name|ident
operator|=
operator|(
expr|struct
name|i2o_device_identity
operator|*
operator|)
name|reply
operator|->
name|result
expr_stmt|;
ifdef|#
directive|ifdef
name|PSTDEBUG
name|printf
argument_list|(
literal|"pst: vendor=<%.16s> product=<%.16s>\n"
argument_list|,
name|ident
operator|->
name|vendor
argument_list|,
name|ident
operator|->
name|product
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"pst: description=<%.16s> revision=<%.8s>\n"
argument_list|,
name|ident
operator|->
name|description
argument_list|,
name|ident
operator|->
name|revision
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"pst: capacity=%lld blocksize=%d\n"
argument_list|,
name|psc
operator|->
name|info
operator|->
name|capacity
argument_list|,
name|psc
operator|->
name|info
operator|->
name|block_size
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|bpack
argument_list|(
name|ident
operator|->
name|vendor
argument_list|,
name|ident
operator|->
name|vendor
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|bpack
argument_list|(
name|ident
operator|->
name|product
argument_list|,
name|ident
operator|->
name|product
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|name
argument_list|,
literal|"%s %s"
argument_list|,
name|ident
operator|->
name|vendor
argument_list|,
name|ident
operator|->
name|product
argument_list|)
expr_stmt|;
name|contigfree
argument_list|(
name|reply
argument_list|,
name|PAGE_SIZE
argument_list|,
name|M_PSTRAID
argument_list|)
expr_stmt|;
name|bioq_init
argument_list|(
operator|&
name|psc
operator|->
name|queue
argument_list|)
expr_stmt|;
name|psc
operator|->
name|disk
operator|.
name|d_name
operator|=
literal|"pst"
expr_stmt|;
name|psc
operator|->
name|disk
operator|.
name|d_strategy
operator|=
name|pststrategy
expr_stmt|;
name|psc
operator|->
name|disk
operator|.
name|d_maxsize
operator|=
literal|64
operator|*
literal|1024
expr_stmt|;
comment|/*I2O_SGL_MAX_SEGS * PAGE_SIZE;*/
name|psc
operator|->
name|disk
operator|.
name|d_drv1
operator|=
name|psc
expr_stmt|;
name|disk_create
argument_list|(
name|lun
argument_list|,
operator|&
name|psc
operator|->
name|disk
argument_list|,
name|DISKFLAG_NOGIANT
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|psc
operator|->
name|disk
operator|.
name|d_sectorsize
operator|=
name|psc
operator|->
name|info
operator|->
name|block_size
expr_stmt|;
name|psc
operator|->
name|disk
operator|.
name|d_mediasize
operator|=
name|psc
operator|->
name|info
operator|->
name|capacity
expr_stmt|;
name|psc
operator|->
name|disk
operator|.
name|d_fwsectors
operator|=
literal|63
expr_stmt|;
name|psc
operator|->
name|disk
operator|.
name|d_fwheads
operator|=
literal|255
expr_stmt|;
name|printf
argument_list|(
literal|"pst%d: %lluMB<%.40s> [%lld/%d/%d] on %.16s\n"
argument_list|,
name|lun
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|psc
operator|->
name|info
operator|->
name|capacity
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
argument_list|,
name|name
argument_list|,
name|psc
operator|->
name|info
operator|->
name|capacity
operator|/
operator|(
literal|512
operator|*
literal|255
operator|*
literal|63
operator|)
argument_list|,
literal|255
argument_list|,
literal|63
argument_list|,
name|device_get_nameunit
argument_list|(
name|psc
operator|->
name|iop
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|EVENTHANDLER_REGISTER
argument_list|(
name|shutdown_post_sync
argument_list|,
name|pst_shutdown
argument_list|,
name|dev
argument_list|,
name|SHUTDOWN_PRI_FIRST
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pst_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|pst_softc
modifier|*
name|psc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|i2o_bsa_cache_flush_message
modifier|*
name|msg
decl_stmt|;
name|int
name|mfa
decl_stmt|;
name|mfa
operator|=
name|iop_get_mfa
argument_list|(
name|psc
operator|->
name|iop
argument_list|)
expr_stmt|;
name|msg
operator|=
operator|(
expr|struct
name|i2o_bsa_cache_flush_message
operator|*
operator|)
operator|(
name|psc
operator|->
name|iop
operator|->
name|ibase
operator|+
name|mfa
operator|)
expr_stmt|;
name|bzero
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i2o_bsa_cache_flush_message
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|version_offset
operator|=
literal|0x01
expr_stmt|;
name|msg
operator|->
name|message_flags
operator|=
literal|0x0
expr_stmt|;
name|msg
operator|->
name|message_size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i2o_bsa_cache_flush_message
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|msg
operator|->
name|target_address
operator|=
name|psc
operator|->
name|lct
operator|->
name|local_tid
expr_stmt|;
name|msg
operator|->
name|initiator_address
operator|=
name|I2O_TID_HOST
expr_stmt|;
name|msg
operator|->
name|function
operator|=
name|I2O_BSA_CACHE_FLUSH
expr_stmt|;
name|msg
operator|->
name|control_flags
operator|=
literal|0x0
expr_stmt|;
comment|/* 0x80 = post progress reports */
if|if
condition|(
name|iop_queue_wait_msg
argument_list|(
name|psc
operator|->
name|iop
argument_list|,
name|mfa
argument_list|,
operator|(
expr|struct
name|i2o_basic_message
operator|*
operator|)
name|msg
argument_list|)
condition|)
name|printf
argument_list|(
literal|"pst: shutdown failed!\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pststrategy
parameter_list|(
name|struct
name|bio
modifier|*
name|bp
parameter_list|)
block|{
name|struct
name|pst_softc
modifier|*
name|psc
init|=
name|bp
operator|->
name|bio_disk
operator|->
name|d_drv1
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|psc
operator|->
name|iop
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|bioq_disksort
argument_list|(
operator|&
name|psc
operator|->
name|queue
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|pst_start
argument_list|(
name|psc
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|psc
operator|->
name|iop
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pst_start
parameter_list|(
name|struct
name|pst_softc
modifier|*
name|psc
parameter_list|)
block|{
name|struct
name|pst_request
modifier|*
name|request
decl_stmt|;
name|struct
name|bio
modifier|*
name|bp
decl_stmt|;
name|u_int32_t
name|mfa
decl_stmt|;
if|if
condition|(
name|psc
operator|->
name|iop
operator|->
name|outstanding
operator|<
operator|(
name|I2O_IOP_OUTBOUND_FRAME_COUNT
operator|-
literal|1
operator|)
operator|&&
operator|(
name|bp
operator|=
name|bioq_first
argument_list|(
operator|&
name|psc
operator|->
name|queue
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|mfa
operator|=
name|iop_get_mfa
argument_list|(
name|psc
operator|->
name|iop
argument_list|)
operator|)
operator|!=
literal|0xffffffff
condition|)
block|{
name|bioq_remove
argument_list|(
operator|&
name|psc
operator|->
name|queue
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|request
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|pst_request
argument_list|)
argument_list|,
name|M_PSTRAID
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"pst: out of memory in start\n"
argument_list|)
expr_stmt|;
name|biofinish
argument_list|(
name|request
operator|->
name|bp
argument_list|,
name|NULL
argument_list|,
name|ENOMEM
argument_list|)
expr_stmt|;
name|iop_free_mfa
argument_list|(
name|psc
operator|->
name|iop
argument_list|,
name|mfa
argument_list|)
expr_stmt|;
return|return;
block|}
name|psc
operator|->
name|iop
operator|->
name|outstanding
operator|++
expr_stmt|;
name|request
operator|->
name|psc
operator|=
name|psc
expr_stmt|;
name|request
operator|->
name|mfa
operator|=
name|mfa
expr_stmt|;
name|request
operator|->
name|bp
operator|=
name|bp
expr_stmt|;
if|if
condition|(
name|pst_rw
argument_list|(
name|request
argument_list|)
condition|)
block|{
name|biofinish
argument_list|(
name|request
operator|->
name|bp
argument_list|,
name|NULL
argument_list|,
name|EIO
argument_list|)
expr_stmt|;
name|iop_free_mfa
argument_list|(
name|request
operator|->
name|psc
operator|->
name|iop
argument_list|,
name|request
operator|->
name|mfa
argument_list|)
expr_stmt|;
name|psc
operator|->
name|iop
operator|->
name|outstanding
operator|--
expr_stmt|;
name|free
argument_list|(
name|request
argument_list|,
name|M_PSTRAID
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pst_done
parameter_list|(
name|struct
name|iop_softc
modifier|*
name|sc
parameter_list|,
name|u_int32_t
name|mfa
parameter_list|,
name|struct
name|i2o_single_reply
modifier|*
name|reply
parameter_list|)
block|{
name|struct
name|pst_request
modifier|*
name|request
init|=
operator|(
expr|struct
name|pst_request
operator|*
operator|)
name|reply
operator|->
name|transaction_context
decl_stmt|;
name|struct
name|pst_softc
modifier|*
name|psc
init|=
name|request
operator|->
name|psc
decl_stmt|;
name|untimeout
argument_list|(
operator|(
name|timeout_t
operator|*
operator|)
name|pst_timeout
argument_list|,
name|request
argument_list|,
name|request
operator|->
name|timeout_handle
argument_list|)
expr_stmt|;
name|request
operator|->
name|bp
operator|->
name|bio_resid
operator|=
name|request
operator|->
name|bp
operator|->
name|bio_bcount
operator|-
name|reply
operator|->
name|donecount
expr_stmt|;
name|biofinish
argument_list|(
name|request
operator|->
name|bp
argument_list|,
name|NULL
argument_list|,
name|reply
operator|->
name|status
condition|?
name|EIO
else|:
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|request
argument_list|,
name|M_PSTRAID
argument_list|)
expr_stmt|;
name|psc
operator|->
name|iop
operator|->
name|reg
operator|->
name|oqueue
operator|=
name|mfa
expr_stmt|;
name|psc
operator|->
name|iop
operator|->
name|outstanding
operator|--
expr_stmt|;
name|pst_start
argument_list|(
name|psc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pst_rw
parameter_list|(
name|struct
name|pst_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|i2o_bsa_rw_block_message
modifier|*
name|msg
decl_stmt|;
name|int
name|sgl_flag
decl_stmt|;
name|msg
operator|=
operator|(
expr|struct
name|i2o_bsa_rw_block_message
operator|*
operator|)
operator|(
name|request
operator|->
name|psc
operator|->
name|iop
operator|->
name|ibase
operator|+
name|request
operator|->
name|mfa
operator|)
expr_stmt|;
name|bzero
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|i2o_bsa_rw_block_message
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|version_offset
operator|=
literal|0x81
expr_stmt|;
name|msg
operator|->
name|message_flags
operator|=
literal|0x0
expr_stmt|;
name|msg
operator|->
name|message_size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|i2o_bsa_rw_block_message
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|msg
operator|->
name|target_address
operator|=
name|request
operator|->
name|psc
operator|->
name|lct
operator|->
name|local_tid
expr_stmt|;
name|msg
operator|->
name|initiator_address
operator|=
name|I2O_TID_HOST
expr_stmt|;
switch|switch
condition|(
name|request
operator|->
name|bp
operator|->
name|bio_cmd
condition|)
block|{
case|case
name|BIO_READ
case|:
name|msg
operator|->
name|function
operator|=
name|I2O_BSA_BLOCK_READ
expr_stmt|;
name|msg
operator|->
name|control_flags
operator|=
literal|0x0
expr_stmt|;
comment|/* 0x0c = read cache + readahead */
name|msg
operator|->
name|fetch_ahead
operator|=
literal|0x0
expr_stmt|;
comment|/* 8 Kb */
name|sgl_flag
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|BIO_WRITE
case|:
name|msg
operator|->
name|function
operator|=
name|I2O_BSA_BLOCK_WRITE
expr_stmt|;
name|msg
operator|->
name|control_flags
operator|=
literal|0x0
expr_stmt|;
comment|/* 0x10 = write behind cache */
name|msg
operator|->
name|fetch_ahead
operator|=
literal|0x0
expr_stmt|;
name|sgl_flag
operator|=
name|I2O_SGL_DIR
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"pst: unknown command type 0x%02x\n"
argument_list|,
name|request
operator|->
name|bp
operator|->
name|bio_cmd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|initiator_context
operator|=
operator|(
name|u_int32_t
operator|)
name|pst_done
expr_stmt|;
name|msg
operator|->
name|transaction_context
operator|=
operator|(
name|u_int32_t
operator|)
name|request
expr_stmt|;
name|msg
operator|->
name|time_multiplier
operator|=
literal|1
expr_stmt|;
name|msg
operator|->
name|bytecount
operator|=
name|request
operator|->
name|bp
operator|->
name|bio_bcount
expr_stmt|;
name|msg
operator|->
name|lba
operator|=
operator|(
operator|(
name|u_int64_t
operator|)
name|request
operator|->
name|bp
operator|->
name|bio_pblkno
operator|)
operator|*
operator|(
name|DEV_BSIZE
operator|*
literal|1LL
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|iop_create_sgl
argument_list|(
operator|(
expr|struct
name|i2o_basic_message
operator|*
operator|)
name|msg
argument_list|,
name|request
operator|->
name|bp
operator|->
name|bio_data
argument_list|,
name|request
operator|->
name|bp
operator|->
name|bio_bcount
argument_list|,
name|sgl_flag
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|request
operator|->
name|psc
operator|->
name|iop
operator|->
name|reg
operator|->
name|iqueue
operator|=
name|request
operator|->
name|mfa
expr_stmt|;
if|if
condition|(
name|dumping
condition|)
name|request
operator|->
name|timeout_handle
operator|.
name|callout
operator|=
name|NULL
expr_stmt|;
else|else
name|request
operator|->
name|timeout_handle
operator|=
name|timeout
argument_list|(
operator|(
name|timeout_t
operator|*
operator|)
name|pst_timeout
argument_list|,
name|request
argument_list|,
literal|10
operator|*
name|hz
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pst_timeout
parameter_list|(
name|struct
name|pst_request
modifier|*
name|request
parameter_list|)
block|{
name|printf
argument_list|(
literal|"pst: timeout mfa=0x%08x cmd=0x%02x\n"
argument_list|,
name|request
operator|->
name|mfa
argument_list|,
name|request
operator|->
name|bp
operator|->
name|bio_cmd
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|request
operator|->
name|psc
operator|->
name|iop
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|iop_free_mfa
argument_list|(
name|request
operator|->
name|psc
operator|->
name|iop
argument_list|,
name|request
operator|->
name|mfa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|request
operator|->
name|mfa
operator|=
name|iop_get_mfa
argument_list|(
name|request
operator|->
name|psc
operator|->
name|iop
argument_list|)
operator|)
operator|==
literal|0xffffffff
condition|)
block|{
name|printf
argument_list|(
literal|"pst: timeout no mfa possible\n"
argument_list|)
expr_stmt|;
name|biofinish
argument_list|(
name|request
operator|->
name|bp
argument_list|,
name|NULL
argument_list|,
name|EIO
argument_list|)
expr_stmt|;
name|request
operator|->
name|psc
operator|->
name|iop
operator|->
name|outstanding
operator|--
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|request
operator|->
name|psc
operator|->
name|iop
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dumping
condition|)
name|request
operator|->
name|timeout_handle
operator|.
name|callout
operator|=
name|NULL
expr_stmt|;
else|else
name|request
operator|->
name|timeout_handle
operator|=
name|timeout
argument_list|(
operator|(
name|timeout_t
operator|*
operator|)
name|pst_timeout
argument_list|,
name|request
argument_list|,
literal|10
operator|*
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|pst_rw
argument_list|(
name|request
argument_list|)
condition|)
block|{
name|iop_free_mfa
argument_list|(
name|request
operator|->
name|psc
operator|->
name|iop
argument_list|,
name|request
operator|->
name|mfa
argument_list|)
expr_stmt|;
name|biofinish
argument_list|(
name|request
operator|->
name|bp
argument_list|,
name|NULL
argument_list|,
name|EIO
argument_list|)
expr_stmt|;
name|request
operator|->
name|psc
operator|->
name|iop
operator|->
name|outstanding
operator|--
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|request
operator|->
name|psc
operator|->
name|iop
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bpack
parameter_list|(
name|int8_t
modifier|*
name|src
parameter_list|,
name|int8_t
modifier|*
name|dst
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|blank
decl_stmt|;
name|int8_t
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|buf
init|=
name|dst
decl_stmt|;
for|for
control|(
name|i
operator|=
name|j
operator|=
name|blank
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|blank
operator|&&
name|src
index|[
name|i
index|]
operator|==
literal|' '
condition|)
continue|continue;
if|if
condition|(
name|blank
operator|&&
name|src
index|[
name|i
index|]
operator|!=
literal|' '
condition|)
block|{
name|dst
index|[
name|j
operator|++
index|]
operator|=
name|src
index|[
name|i
index|]
expr_stmt|;
name|blank
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|src
index|[
name|i
index|]
operator|==
literal|' '
condition|)
block|{
name|blank
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
continue|continue;
block|}
name|dst
index|[
name|j
operator|++
index|]
operator|=
name|src
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|j
operator|<
name|len
condition|)
name|dst
index|[
name|j
index|]
operator|=
literal|0x00
expr_stmt|;
for|for
control|(
name|ptr
operator|=
name|buf
init|;
name|ptr
operator|<
name|buf
operator|+
name|len
condition|;
operator|++
name|ptr
control|)
if|if
condition|(
operator|!
operator|*
name|ptr
condition|)
operator|*
name|ptr
operator|=
literal|' '
expr_stmt|;
for|for
control|(
name|ptr
operator|=
name|buf
operator|+
name|len
operator|-
literal|1
init|;
name|ptr
operator|>=
name|buf
operator|&&
operator|*
name|ptr
operator|==
literal|' '
condition|;
operator|--
name|ptr
control|)
operator|*
name|ptr
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|pst_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|pst_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|pst_attach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|pst_driver
init|=
block|{
literal|"pst"
block|,
name|pst_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|pst_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|pst_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|pst
argument_list|,
name|pstpci
argument_list|,
name|pst_driver
argument_list|,
name|pst_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************************* ************************************************************************** Copyright (c) 2001 Intel Corporation  All rights reserved.   Redistribution and use in source and binary forms of the Software, with or  without modification, are permitted provided that the following conditions  are met:    1. Redistributions of source code of the Software may retain the above      copyright notice, this list of conditions and the following disclaimer.    2. Redistributions in binary form of the Software may reproduce the above      copyright notice, this list of conditions and the following disclaimer      in the documentation and/or other materials provided with the      distribution.    3. Neither the name of the Intel Corporation nor the names of its      contributors shall be used to endorse or promote products derived from      this Software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  ARE DISCLAIMED. IN NO EVENT SHALL THE INTEL OR ITS CONTRIBUTORS BE LIABLE  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER  CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  SUCH DAMAGE. *************************************************************************** **************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_comment
comment|/* * Workfile: fxhw.c  * Date: 9/25/01 2:40p  * Revision: 48  */
end_comment

begin_include
include|#
directive|include
file|<dev/em/if_em_fxhw.h>
end_include

begin_include
include|#
directive|include
file|<dev/em/if_em_phy.h>
end_include

begin_function_decl
specifier|static
name|void
name|em_shift_out_bits
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u16
name|Data
parameter_list|,
name|u16
name|Count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|em_raise_clock
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
modifier|*
name|EecdRegValue
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|em_lower_clock
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
modifier|*
name|EecdRegValue
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u16
name|em_shift_in_bits
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|em_eeprom_cleanup
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u16
name|em_wait_eeprom_command_done
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|em_stand_by
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|em_adapter_stop
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|IcrContents
decl_stmt|;
name|u16
name|PciCommandWord
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_adapter_stop"
argument_list|)
if|if
condition|(
name|Adapter
operator|->
name|AdapterStopped
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Exiting because the adapter is already stopped!!!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|Adapter
operator|->
name|AdapterStopped
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|==
name|MAC_WISEMAN_2_0
condition|)
block|{
if|if
condition|(
name|Adapter
operator|->
name|PciCommandWord
operator|&
name|CMD_MEM_WRT_INVALIDATE
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Disabling MWI on rev 2.0 Wiseman silicon\n"
argument_list|)
expr_stmt|;
name|PciCommandWord
operator|=
name|Adapter
operator|->
name|PciCommandWord
operator|&
operator|~
name|CMD_MEM_WRT_INVALIDATE
expr_stmt|;
name|WritePciConfigWord
argument_list|(
name|PCI_COMMAND_REGISTER
argument_list|,
operator|&
name|PciCommandWord
argument_list|)
expr_stmt|;
block|}
block|}
name|DEBUGOUT
argument_list|(
literal|"Masking off all interrupts\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Imc
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Rctl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Tctl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Adapter
operator|->
name|TbiCompatibilityOn
operator|=
literal|0
expr_stmt|;
name|DelayInMilliseconds
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Issuing a global reset to MAC\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|E1000_CTRL_RST
argument_list|)
expr_stmt|;
name|DelayInMilliseconds
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Masking off all interrupts\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Imc
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|IcrContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Icr
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|==
name|MAC_WISEMAN_2_0
condition|)
block|{
if|if
condition|(
name|Adapter
operator|->
name|PciCommandWord
operator|&
name|CMD_MEM_WRT_INVALIDATE
condition|)
block|{
name|WritePciConfigWord
argument_list|(
name|PCI_COMMAND_REGISTER
argument_list|,
operator|&
name|Adapter
operator|->
name|PciCommandWord
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|u8
name|em_initialize_hardware
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u16
name|PciCommandWord
decl_stmt|;
name|u8
name|Status
decl_stmt|;
name|u32
name|RegisterValue
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_initialize_hardware"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|!=
name|MAC_LIVENGOOD
condition|)
block|{
name|Adapter
operator|->
name|TbiCompatibilityEnable
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>=
name|MAC_LIVENGOOD
condition|)
block|{
name|RegisterValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Status
argument_list|)
expr_stmt|;
if|if
condition|(
name|RegisterValue
operator|&
name|E1000_STATUS_TBIMODE
condition|)
block|{
name|Adapter
operator|->
name|MediaType
operator|=
name|MEDIA_TYPE_FIBER
expr_stmt|;
name|Adapter
operator|->
name|TbiCompatibilityEnable
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|Adapter
operator|->
name|MediaType
operator|=
name|MEDIA_TYPE_COPPER
expr_stmt|;
block|}
block|}
else|else
block|{
name|Adapter
operator|->
name|MediaType
operator|=
name|MEDIA_TYPE_FIBER
expr_stmt|;
block|}
name|DEBUGOUT
argument_list|(
literal|"Initializing the IEEE VLAN\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Vet
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|em_clear_vfta
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|==
name|MAC_WISEMAN_2_0
condition|)
block|{
if|if
condition|(
name|Adapter
operator|->
name|PciCommandWord
operator|&
name|CMD_MEM_WRT_INVALIDATE
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Disabling MWI on rev 2.0 Wiseman silicon\n"
argument_list|)
expr_stmt|;
name|PciCommandWord
operator|=
name|Adapter
operator|->
name|PciCommandWord
operator|&
operator|~
name|CMD_MEM_WRT_INVALIDATE
expr_stmt|;
name|WritePciConfigWord
argument_list|(
name|PCI_COMMAND_REGISTER
argument_list|,
operator|&
name|PciCommandWord
argument_list|)
expr_stmt|;
block|}
name|E1000_WRITE_REG
argument_list|(
name|Rctl
argument_list|,
name|E1000_RCTL_RST
argument_list|)
expr_stmt|;
name|DelayInMilliseconds
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
name|em_init_rx_addresses
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|==
name|MAC_WISEMAN_2_0
condition|)
block|{
name|E1000_WRITE_REG
argument_list|(
name|Rctl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DelayInMilliseconds
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|PciCommandWord
operator|&
name|CMD_MEM_WRT_INVALIDATE
condition|)
block|{
name|WritePciConfigWord
argument_list|(
name|PCI_COMMAND_REGISTER
argument_list|,
operator|&
name|Adapter
operator|->
name|PciCommandWord
argument_list|)
expr_stmt|;
block|}
block|}
name|DEBUGOUT
argument_list|(
literal|"Zeroing the MTA\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|E1000_MC_TBL_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|E1000_WRITE_REG
argument_list|(
name|Mta
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|Status
operator|=
name|em_setup_flow_control_and_link
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
name|em_clear_hw_stats_counters
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
return|return
operator|(
name|Status
operator|)
return|;
block|}
end_function

begin_function
name|void
name|em_init_rx_addresses
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u32
name|HwLowAddress
decl_stmt|;
name|u32
name|HwHighAddress
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_init_rx_addresses"
argument_list|)
name|DEBUGOUT
argument_list|(
literal|"Programming IA into RAR[0]\n"
argument_list|)
expr_stmt|;
name|HwLowAddress
operator|=
operator|(
name|Adapter
operator|->
name|CurrentNetAddress
index|[
literal|0
index|]
operator||
operator|(
name|Adapter
operator|->
name|CurrentNetAddress
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|Adapter
operator|->
name|CurrentNetAddress
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|Adapter
operator|->
name|CurrentNetAddress
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator|)
expr_stmt|;
name|HwHighAddress
operator|=
operator|(
name|Adapter
operator|->
name|CurrentNetAddress
index|[
literal|4
index|]
operator||
operator|(
name|Adapter
operator|->
name|CurrentNetAddress
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator||
name|E1000_RAH_AV
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Rar
index|[
literal|0
index|]
operator|.
name|Low
argument_list|,
name|HwLowAddress
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Rar
index|[
literal|0
index|]
operator|.
name|High
argument_list|,
name|HwHighAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Clearing RAR[1-15]\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|E1000_RAR_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|E1000_WRITE_REG
argument_list|(
name|Rar
index|[
name|i
index|]
operator|.
name|Low
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Rar
index|[
name|i
index|]
operator|.
name|High
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|em_multicast_address_list_update
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u8
modifier|*
name|MulticastAddressList
parameter_list|,
name|u32
name|MulticastAddressCount
parameter_list|,
name|u32
name|Padding
parameter_list|)
block|{
name|u32
name|HashValue
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|u32
name|RarUsedCount
init|=
literal|1
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_multicast_address_list_update"
argument_list|)
expr_stmt|;
name|Adapter
operator|->
name|NumberOfMcAddresses
operator|=
name|MulticastAddressCount
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|" Clearing RAR[1-15]\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|RarUsedCount
init|;
name|i
operator|<
name|E1000_RAR_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|E1000_WRITE_REG
argument_list|(
name|Rar
index|[
name|i
index|]
operator|.
name|Low
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Rar
index|[
name|i
index|]
operator|.
name|High
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|DEBUGOUT
argument_list|(
literal|" Clearing MTA\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|E1000_NUM_MTA_REGISTERS
condition|;
name|i
operator|++
control|)
block|{
name|E1000_WRITE_REG
argument_list|(
name|Mta
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MulticastAddressCount
condition|;
name|i
operator|++
control|)
block|{
name|DEBUGOUT
argument_list|(
literal|" Adding the multicast addresses:\n"
argument_list|)
expr_stmt|;
name|DEBUGOUT7
argument_list|(
literal|" MC Addr #%d =%.2X %.2X %.2X %.2X %.2X %.2X\n"
argument_list|,
name|i
argument_list|,
name|MulticastAddressList
index|[
name|i
operator|*
operator|(
name|ETH_LENGTH_OF_ADDRESS
operator|+
name|Padding
operator|)
index|]
argument_list|,
name|MulticastAddressList
index|[
name|i
operator|*
operator|(
name|ETH_LENGTH_OF_ADDRESS
operator|+
name|Padding
operator|)
operator|+
literal|1
index|]
argument_list|,
name|MulticastAddressList
index|[
name|i
operator|*
operator|(
name|ETH_LENGTH_OF_ADDRESS
operator|+
name|Padding
operator|)
operator|+
literal|2
index|]
argument_list|,
name|MulticastAddressList
index|[
name|i
operator|*
operator|(
name|ETH_LENGTH_OF_ADDRESS
operator|+
name|Padding
operator|)
operator|+
literal|3
index|]
argument_list|,
name|MulticastAddressList
index|[
name|i
operator|*
operator|(
name|ETH_LENGTH_OF_ADDRESS
operator|+
name|Padding
operator|)
operator|+
literal|4
index|]
argument_list|,
name|MulticastAddressList
index|[
name|i
operator|*
operator|(
name|ETH_LENGTH_OF_ADDRESS
operator|+
name|Padding
operator|)
operator|+
literal|5
index|]
argument_list|)
expr_stmt|;
name|HashValue
operator|=
name|em_hash_multicast_address
argument_list|(
name|Adapter
argument_list|,
name|MulticastAddressList
operator|+
operator|(
name|i
operator|*
operator|(
name|ETH_LENGTH_OF_ADDRESS
operator|+
name|Padding
operator|)
operator|)
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|" Hash value = 0x%03X\n"
argument_list|,
name|HashValue
argument_list|)
expr_stmt|;
if|if
condition|(
name|RarUsedCount
operator|<
name|E1000_RAR_ENTRIES
condition|)
block|{
name|em_rar_set
argument_list|(
name|Adapter
argument_list|,
name|MulticastAddressList
operator|+
operator|(
name|i
operator|*
operator|(
name|ETH_LENGTH_OF_ADDRESS
operator|+
name|Padding
operator|)
operator|)
argument_list|,
name|RarUsedCount
argument_list|)
expr_stmt|;
name|RarUsedCount
operator|++
expr_stmt|;
block|}
else|else
block|{
name|em_mta_set
argument_list|(
name|Adapter
argument_list|,
name|HashValue
argument_list|)
expr_stmt|;
block|}
block|}
name|DEBUGOUT
argument_list|(
literal|"MC Update Complete\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u32
name|em_hash_multicast_address
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u8
modifier|*
name|MulticastAddress
parameter_list|)
block|{
name|u32
name|HashValue
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|Adapter
operator|->
name|MulticastFilterType
condition|)
block|{
case|case
literal|0
case|:
name|HashValue
operator|=
operator|(
operator|(
name|MulticastAddress
index|[
literal|4
index|]
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|MulticastAddress
index|[
literal|5
index|]
operator|)
operator|<<
literal|4
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|HashValue
operator|=
operator|(
operator|(
name|MulticastAddress
index|[
literal|4
index|]
operator|>>
literal|3
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|MulticastAddress
index|[
literal|5
index|]
operator|)
operator|<<
literal|5
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|HashValue
operator|=
operator|(
operator|(
name|MulticastAddress
index|[
literal|4
index|]
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|MulticastAddress
index|[
literal|5
index|]
operator|)
operator|<<
literal|6
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|HashValue
operator|=
operator|(
operator|(
name|MulticastAddress
index|[
literal|4
index|]
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|MulticastAddress
index|[
literal|5
index|]
operator|)
operator|<<
literal|8
operator|)
operator|)
expr_stmt|;
break|break;
block|}
name|HashValue
operator|&=
literal|0xFFF
expr_stmt|;
return|return
operator|(
name|HashValue
operator|)
return|;
block|}
end_function

begin_function
name|void
name|em_mta_set
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
name|HashValue
parameter_list|)
block|{
name|u32
name|HashBit
decl_stmt|,
name|HashReg
decl_stmt|;
name|u32
name|MtaRegisterValue
decl_stmt|;
name|u32
name|Temp
decl_stmt|;
name|HashReg
operator|=
operator|(
name|HashValue
operator|>>
literal|5
operator|)
operator|&
literal|0x7F
expr_stmt|;
name|HashBit
operator|=
name|HashValue
operator|&
literal|0x1F
expr_stmt|;
name|MtaRegisterValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Mta
index|[
operator|(
name|HashReg
operator|)
index|]
argument_list|)
expr_stmt|;
name|MtaRegisterValue
operator||=
operator|(
literal|1
operator|<<
name|HashBit
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|Adapter
operator|->
name|MacType
operator|==
name|MAC_CORDOVA
operator|)
operator|&&
operator|(
operator|(
name|HashReg
operator|&
literal|0x1
operator|)
operator|==
literal|1
operator|)
condition|)
block|{
name|Temp
operator|=
name|E1000_READ_REG
argument_list|(
name|Mta
index|[
name|HashReg
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Mta
index|[
name|HashReg
index|]
argument_list|,
name|HashValue
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Mta
index|[
name|HashReg
operator|-
literal|1
index|]
argument_list|,
name|Temp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|E1000_WRITE_REG
argument_list|(
name|Mta
index|[
name|HashReg
index|]
argument_list|,
name|MtaRegisterValue
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|em_rar_set
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u8
modifier|*
name|MulticastAddress
parameter_list|,
name|u32
name|RarIndex
parameter_list|)
block|{
name|u32
name|RarLow
decl_stmt|,
name|RarHigh
decl_stmt|;
name|RarLow
operator|=
operator|(
operator|(
name|u32
operator|)
name|MulticastAddress
index|[
literal|0
index|]
operator||
operator|(
operator|(
name|u32
operator|)
name|MulticastAddress
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|u32
operator|)
name|MulticastAddress
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|u32
operator|)
name|MulticastAddress
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator|)
expr_stmt|;
name|RarHigh
operator|=
operator|(
operator|(
name|u32
operator|)
name|MulticastAddress
index|[
literal|4
index|]
operator||
operator|(
operator|(
name|u32
operator|)
name|MulticastAddress
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator||
name|E1000_RAH_AV
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Rar
index|[
name|RarIndex
index|]
operator|.
name|Low
argument_list|,
name|RarLow
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Rar
index|[
name|RarIndex
index|]
operator|.
name|High
argument_list|,
name|RarHigh
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|em_write_vfta
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
name|Offset
parameter_list|,
name|u32
name|Value
parameter_list|)
block|{
name|u32
name|Temp
decl_stmt|;
if|if
condition|(
operator|(
name|Adapter
operator|->
name|MacType
operator|==
name|MAC_CORDOVA
operator|)
operator|&&
operator|(
operator|(
name|Offset
operator|&
literal|0x1
operator|)
operator|==
literal|1
operator|)
condition|)
block|{
name|Temp
operator|=
name|E1000_READ_REG
argument_list|(
name|Vfta
index|[
name|Offset
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Vfta
index|[
name|Offset
index|]
argument_list|,
name|Value
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Vfta
index|[
name|Offset
operator|-
literal|1
index|]
argument_list|,
name|Temp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|E1000_WRITE_REG
argument_list|(
name|Vfta
index|[
name|Offset
index|]
argument_list|,
name|Value
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|em_clear_vfta
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|Offset
decl_stmt|;
for|for
control|(
name|Offset
operator|=
literal|0
init|;
name|Offset
operator|<
name|E1000_VLAN_FILTER_TBL_SIZE
condition|;
name|Offset
operator|++
control|)
name|E1000_WRITE_REG
argument_list|(
name|Vfta
index|[
name|Offset
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u8
name|em_setup_flow_control_and_link
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|TempEepromWord
decl_stmt|;
name|u32
name|DeviceControlReg
decl_stmt|;
name|u32
name|ExtDevControlReg
decl_stmt|;
name|u8
name|Status
init|=
literal|1
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_setup_flow_control_and_link"
argument_list|)
name|TempEepromWord
operator|=
name|em_read_eeprom_word
argument_list|(
name|Adapter
argument_list|,
name|EEPROM_INIT_CONTROL1_REG
argument_list|)
expr_stmt|;
name|DeviceControlReg
operator|=
operator|(
operator|(
operator|(
name|TempEepromWord
operator|&
name|EEPROM_WORD0A_SWDPIO
operator|)
operator|<<
name|SWDPIO_SHIFT
operator|)
operator||
operator|(
operator|(
name|TempEepromWord
operator|&
name|EEPROM_WORD0A_ILOS
operator|)
operator|<<
name|ILOS_SHIFT
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|DmaFairness
condition|)
name|DeviceControlReg
operator||=
name|E1000_CTRL_PRIOR
expr_stmt|;
name|TempEepromWord
operator|=
name|em_read_eeprom_word
argument_list|(
name|Adapter
argument_list|,
name|EEPROM_INIT_CONTROL2_REG
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|FlowControl
operator|>
name|FLOW_CONTROL_FULL
condition|)
block|{
if|if
condition|(
operator|(
name|TempEepromWord
operator|&
name|EEPROM_WORD0F_PAUSE_MASK
operator|)
operator|==
literal|0
condition|)
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_NONE
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|TempEepromWord
operator|&
name|EEPROM_WORD0F_PAUSE_MASK
operator|)
operator|==
name|EEPROM_WORD0F_ASM_DIR
condition|)
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_TRANSMIT_PAUSE
expr_stmt|;
else|else
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_FULL
expr_stmt|;
block|}
name|Adapter
operator|->
name|OriginalFlowControl
operator|=
name|Adapter
operator|->
name|FlowControl
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|==
name|MAC_WISEMAN_2_0
condition|)
name|Adapter
operator|->
name|FlowControl
operator|&=
operator|(
operator|~
name|FLOW_CONTROL_TRANSMIT_PAUSE
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|Adapter
operator|->
name|MacType
operator|<
name|MAC_LIVENGOOD
operator|)
operator|&&
operator|(
name|Adapter
operator|->
name|ReportTxEarly
operator|==
literal|1
operator|)
condition|)
name|Adapter
operator|->
name|FlowControl
operator|&=
operator|(
operator|~
name|FLOW_CONTROL_RECEIVE_PAUSE
operator|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"After fix-ups FlowControl is now = %x\n"
argument_list|,
name|Adapter
operator|->
name|FlowControl
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>=
name|MAC_LIVENGOOD
condition|)
block|{
name|ExtDevControlReg
operator|=
operator|(
operator|(
name|TempEepromWord
operator|&
name|EEPROM_WORD0F_SWPDIO_EXT
operator|)
operator|<<
name|SWDPIO__EXT_SHIFT
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Exct
argument_list|,
name|ExtDevControlReg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>=
name|MAC_LIVENGOOD
condition|)
block|{
if|if
condition|(
name|Adapter
operator|->
name|MediaType
operator|==
name|MEDIA_TYPE_FIBER
condition|)
block|{
name|Status
operator|=
name|em_setup_pcs_link
argument_list|(
name|Adapter
argument_list|,
name|DeviceControlReg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Status
operator|=
name|em_phy_setup
argument_list|(
name|Adapter
argument_list|,
name|DeviceControlReg
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|Status
operator|=
name|em_setup_pcs_link
argument_list|(
name|Adapter
argument_list|,
name|DeviceControlReg
argument_list|)
expr_stmt|;
block|}
name|DEBUGOUT
argument_list|(
literal|"Initializing the Flow Control address, type and timer regs\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Fcal
argument_list|,
name|FLOW_CONTROL_ADDRESS_LOW
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Fcah
argument_list|,
name|FLOW_CONTROL_ADDRESS_HIGH
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Fct
argument_list|,
name|FLOW_CONTROL_TYPE
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Fcttv
argument_list|,
name|Adapter
operator|->
name|FlowControlPauseTime
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|Adapter
operator|->
name|FlowControl
operator|&
name|FLOW_CONTROL_TRANSMIT_PAUSE
operator|)
condition|)
block|{
name|E1000_WRITE_REG
argument_list|(
name|Fcrtl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Fcrth
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|Adapter
operator|->
name|FlowControlSendXon
condition|)
block|{
name|E1000_WRITE_REG
argument_list|(
name|Fcrtl
argument_list|,
operator|(
name|Adapter
operator|->
name|FlowControlLowWatermark
operator||
name|E1000_FCRTL_XONE
operator|)
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Fcrth
argument_list|,
name|Adapter
operator|->
name|FlowControlHighWatermark
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|E1000_WRITE_REG
argument_list|(
name|Fcrtl
argument_list|,
name|Adapter
operator|->
name|FlowControlLowWatermark
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Fcrth
argument_list|,
name|Adapter
operator|->
name|FlowControlHighWatermark
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|Status
operator|)
return|;
block|}
end_function

begin_function
name|u8
name|em_setup_pcs_link
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
name|DeviceControlReg
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u32
name|StatusContents
decl_stmt|;
name|u32
name|TctlReg
decl_stmt|;
name|u32
name|TransmitConfigWord
decl_stmt|;
name|u32
name|Shift32
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_setup_pcs_link"
argument_list|)
name|TctlReg
operator|=
name|E1000_READ_REG
argument_list|(
name|Tctl
argument_list|)
expr_stmt|;
name|Shift32
operator|=
name|E1000_FDX_COLLISION_DISTANCE
expr_stmt|;
name|Shift32
operator|<<=
name|E1000_COLD_SHIFT
expr_stmt|;
name|TctlReg
operator||=
name|Shift32
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Tctl
argument_list|,
name|TctlReg
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Adapter
operator|->
name|FlowControl
condition|)
block|{
case|case
name|FLOW_CONTROL_NONE
case|:
name|TransmitConfigWord
operator|=
operator|(
name|E1000_TXCW_ANE
operator||
name|E1000_TXCW_FD
operator|)
expr_stmt|;
break|break;
case|case
name|FLOW_CONTROL_RECEIVE_PAUSE
case|:
name|TransmitConfigWord
operator|=
operator|(
name|E1000_TXCW_ANE
operator||
name|E1000_TXCW_FD
operator||
name|E1000_TXCW_PAUSE_MASK
operator|)
expr_stmt|;
break|break;
case|case
name|FLOW_CONTROL_TRANSMIT_PAUSE
case|:
name|TransmitConfigWord
operator|=
operator|(
name|E1000_TXCW_ANE
operator||
name|E1000_TXCW_FD
operator||
name|E1000_TXCW_ASM_DIR
operator|)
expr_stmt|;
break|break;
case|case
name|FLOW_CONTROL_FULL
case|:
name|TransmitConfigWord
operator|=
operator|(
name|E1000_TXCW_ANE
operator||
name|E1000_TXCW_FD
operator||
name|E1000_TXCW_PAUSE_MASK
operator|)
expr_stmt|;
break|break;
default|default:
name|DEBUGOUT
argument_list|(
literal|"Flow control param set incorrectly\n"
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUGOUT
argument_list|(
literal|"Auto-negotiation enabled\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Txcw
argument_list|,
name|TransmitConfigWord
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|DeviceControlReg
argument_list|)
expr_stmt|;
name|Adapter
operator|->
name|TxcwRegValue
operator|=
name|TransmitConfigWord
expr_stmt|;
name|DelayInMilliseconds
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
operator|&
name|E1000_CTRL_SWDPIN1
operator|)
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Looking for Link\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|LINK_UP_TIMEOUT
operator|/
literal|10
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|DelayInMilliseconds
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|StatusContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Status
argument_list|)
expr_stmt|;
if|if
condition|(
name|StatusContents
operator|&
name|E1000_STATUS_LU
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
operator|(
name|LINK_UP_TIMEOUT
operator|/
literal|10
operator|)
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Never got a valid link from auto-neg!!!\n"
argument_list|)
expr_stmt|;
name|Adapter
operator|->
name|AutoNegFailed
operator|=
literal|1
expr_stmt|;
name|em_check_for_link
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
name|Adapter
operator|->
name|AutoNegFailed
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|Adapter
operator|->
name|AutoNegFailed
operator|=
literal|0
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Valid Link Found\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DEBUGOUT
argument_list|(
literal|"No Signal Detected\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|void
name|em_config_flow_control_after_link_up
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u16
name|MiiStatusReg
decl_stmt|,
name|MiiNWayAdvertiseReg
decl_stmt|,
name|MiiNWayBasePgAbleReg
decl_stmt|;
name|u16
name|Speed
decl_stmt|,
name|Duplex
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_config_flow_control_after_link_up"
argument_list|)
if|if
condition|(
operator|(
operator|(
name|Adapter
operator|->
name|MediaType
operator|==
name|MEDIA_TYPE_FIBER
operator|)
operator|&&
operator|(
name|Adapter
operator|->
name|AutoNegFailed
operator|)
operator|)
operator|||
operator|(
operator|(
name|Adapter
operator|->
name|MediaType
operator|==
name|MEDIA_TYPE_COPPER
operator|)
operator|&&
operator|(
operator|!
name|Adapter
operator|->
name|AutoNeg
operator|)
operator|)
condition|)
block|{
name|em_force_mac_flow_control_setting
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|Adapter
operator|->
name|MediaType
operator|==
name|MEDIA_TYPE_COPPER
operator|)
operator|&&
name|Adapter
operator|->
name|AutoNeg
condition|)
block|{
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
if|if
condition|(
name|MiiStatusReg
operator|&
name|MII_SR_AUTONEG_COMPLETE
condition|)
block|{
name|MiiNWayAdvertiseReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_ADVERTISEMENT
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiNWayBasePgAbleReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_LP_BPA
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|MiiNWayAdvertiseReg
operator|&
name|NWAY_AR_PAUSE
operator|)
operator|&&
operator|(
name|MiiNWayBasePgAbleReg
operator|&
name|NWAY_LPAR_PAUSE
operator|)
condition|)
block|{
if|if
condition|(
name|Adapter
operator|->
name|OriginalFlowControl
operator|==
name|FLOW_CONTROL_FULL
condition|)
block|{
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_FULL
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Flow Control = FULL.\r\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_RECEIVE_PAUSE
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Flow Control = RX PAUSE frames only.\r\n"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|MiiNWayAdvertiseReg
operator|&
name|NWAY_AR_PAUSE
operator|)
operator|&&
operator|(
name|MiiNWayAdvertiseReg
operator|&
name|NWAY_AR_ASM_DIR
operator|)
operator|&&
operator|(
name|MiiNWayBasePgAbleReg
operator|&
name|NWAY_LPAR_PAUSE
operator|)
operator|&&
operator|(
name|MiiNWayBasePgAbleReg
operator|&
name|NWAY_LPAR_ASM_DIR
operator|)
condition|)
block|{
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_TRANSMIT_PAUSE
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Flow Control = TX PAUSE frames only.\r\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|MiiNWayAdvertiseReg
operator|&
name|NWAY_AR_PAUSE
operator|)
operator|&&
operator|(
name|MiiNWayAdvertiseReg
operator|&
name|NWAY_AR_ASM_DIR
operator|)
operator|&&
operator|!
operator|(
name|MiiNWayBasePgAbleReg
operator|&
name|NWAY_LPAR_PAUSE
operator|)
operator|&&
operator|(
name|MiiNWayBasePgAbleReg
operator|&
name|NWAY_LPAR_ASM_DIR
operator|)
condition|)
block|{
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_RECEIVE_PAUSE
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Flow Control = RX PAUSE frames only.\r\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|Adapter
operator|->
name|OriginalFlowControl
operator|==
name|FLOW_CONTROL_NONE
operator|||
name|Adapter
operator|->
name|OriginalFlowControl
operator|==
name|FLOW_CONTROL_TRANSMIT_PAUSE
condition|)
block|{
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_NONE
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Flow Control = NONE.\r\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_RECEIVE_PAUSE
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Flow Control = RX PAUSE frames only.\r\n"
argument_list|)
expr_stmt|;
block|}
name|em_get_speed_and_duplex
argument_list|(
name|Adapter
argument_list|,
operator|&
name|Speed
argument_list|,
operator|&
name|Duplex
argument_list|)
expr_stmt|;
if|if
condition|(
name|Duplex
operator|==
name|HALF_DUPLEX
condition|)
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_NONE
expr_stmt|;
name|em_force_mac_flow_control_setting
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DEBUGOUT
argument_list|(
literal|"Copper PHY and Auto Neg has not completed.\r\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|em_force_mac_flow_control_setting
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|CtrlRegValue
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_force_mac_flow_control_setting"
argument_list|)
name|CtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Adapter
operator|->
name|FlowControl
condition|)
block|{
case|case
name|FLOW_CONTROL_NONE
case|:
name|CtrlRegValue
operator|&=
operator|(
operator|~
operator|(
name|E1000_CTRL_TFCE
operator||
name|E1000_CTRL_RFCE
operator|)
operator|)
expr_stmt|;
break|break;
case|case
name|FLOW_CONTROL_RECEIVE_PAUSE
case|:
name|CtrlRegValue
operator|&=
operator|(
operator|~
name|E1000_CTRL_TFCE
operator|)
expr_stmt|;
name|CtrlRegValue
operator||=
name|E1000_CTRL_RFCE
expr_stmt|;
break|break;
case|case
name|FLOW_CONTROL_TRANSMIT_PAUSE
case|:
name|CtrlRegValue
operator|&=
operator|(
operator|~
name|E1000_CTRL_RFCE
operator|)
expr_stmt|;
name|CtrlRegValue
operator||=
name|E1000_CTRL_TFCE
expr_stmt|;
break|break;
case|case
name|FLOW_CONTROL_FULL
case|:
name|CtrlRegValue
operator||=
operator|(
name|E1000_CTRL_TFCE
operator||
name|E1000_CTRL_RFCE
operator|)
expr_stmt|;
break|break;
default|default:
name|DEBUGOUT
argument_list|(
literal|"Flow control param set incorrectly\n"
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|==
name|MAC_WISEMAN_2_0
condition|)
name|CtrlRegValue
operator|&=
operator|(
operator|~
name|E1000_CTRL_TFCE
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|CtrlRegValue
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|em_check_for_link
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|RxcwRegValue
decl_stmt|;
name|u32
name|CtrlRegValue
decl_stmt|;
name|u32
name|StatusRegValue
decl_stmt|;
name|u32
name|RctlRegValue
decl_stmt|;
name|u16
name|PhyData
decl_stmt|;
name|u16
name|LinkPartnerCapability
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_check_for_link"
argument_list|)
name|CtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
name|StatusRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Status
argument_list|)
expr_stmt|;
name|RxcwRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Rxcw
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MediaType
operator|==
name|MEDIA_TYPE_COPPER
operator|&&
name|Adapter
operator|->
name|GetLinkStatus
condition|)
block|{
name|PhyData
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhyData
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
if|if
condition|(
name|PhyData
operator|&
name|MII_SR_LINK_STATUS
condition|)
block|{
name|Adapter
operator|->
name|GetLinkStatus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|DEBUGOUT
argument_list|(
literal|"**** CFL - No link detected. ****\r\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|Adapter
operator|->
name|AutoNeg
condition|)
block|{
return|return;
block|}
switch|switch
condition|(
name|Adapter
operator|->
name|PhyId
condition|)
block|{
case|case
name|PAXSON_PHY_88E1000
case|:
case|case
name|PAXSON_PHY_88E1000S
case|:
case|case
name|PAXSON_PHY_INTEGRATED
case|:
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>
name|MAC_WAINWRIGHT
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"CFL - Auto-Neg complete.  Configuring Collision Distance."
argument_list|)
expr_stmt|;
name|em_configure_collision_distance
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PhyData
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_STAT_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"CFL - Auto-Neg complete.  PhyData = %x\r\n"
argument_list|,
name|PhyData
argument_list|)
expr_stmt|;
name|em_configure_mac_to_phy_settings
argument_list|(
name|Adapter
argument_list|,
name|PhyData
argument_list|)
expr_stmt|;
block|}
name|em_config_flow_control_after_link_up
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DEBUGOUT
argument_list|(
literal|"CFL - Invalid PHY detected.\r\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Adapter
operator|->
name|TbiCompatibilityEnable
condition|)
block|{
name|LinkPartnerCapability
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_LP_BPA
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
if|if
condition|(
name|LinkPartnerCapability
operator|&
operator|(
name|NWAY_LPAR_10T_HD_CAPS
operator||
name|NWAY_LPAR_10T_FD_CAPS
operator||
name|NWAY_LPAR_100TX_HD_CAPS
operator||
name|NWAY_LPAR_100TX_FD_CAPS
operator||
name|NWAY_LPAR_100T4_CAPS
operator|)
condition|)
block|{
if|if
condition|(
name|Adapter
operator|->
name|TbiCompatibilityOn
condition|)
block|{
name|RctlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Rctl
argument_list|)
expr_stmt|;
name|RctlRegValue
operator|&=
operator|~
name|E1000_RCTL_SBP
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Rctl
argument_list|,
name|RctlRegValue
argument_list|)
expr_stmt|;
name|Adapter
operator|->
name|TbiCompatibilityOn
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|Adapter
operator|->
name|TbiCompatibilityOn
condition|)
block|{
name|Adapter
operator|->
name|TbiCompatibilityOn
operator|=
literal|1
expr_stmt|;
name|RctlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Rctl
argument_list|)
expr_stmt|;
name|RctlRegValue
operator||=
name|E1000_RCTL_SBP
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Rctl
argument_list|,
name|RctlRegValue
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|Adapter
operator|->
name|MediaType
operator|==
name|MEDIA_TYPE_FIBER
operator|)
operator|&&
operator|(
operator|!
operator|(
name|StatusRegValue
operator|&
name|E1000_STATUS_LU
operator|)
operator|)
operator|&&
operator|(
operator|!
operator|(
name|CtrlRegValue
operator|&
name|E1000_CTRL_SWDPIN1
operator|)
operator|)
operator|&&
operator|(
operator|!
operator|(
name|RxcwRegValue
operator|&
name|E1000_RXCW_C
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|Adapter
operator|->
name|AutoNegFailed
operator|==
literal|0
condition|)
block|{
name|Adapter
operator|->
name|AutoNegFailed
operator|=
literal|1
expr_stmt|;
return|return;
block|}
name|DEBUGOUT
argument_list|(
literal|"NOT RXing /C/, disable AutoNeg and force link.\r\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Txcw
argument_list|,
operator|(
name|Adapter
operator|->
name|TxcwRegValue
operator|&
operator|~
name|E1000_TXCW_ANE
operator|)
argument_list|)
expr_stmt|;
name|CtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
name|CtrlRegValue
operator||=
operator|(
name|E1000_CTRL_SLU
operator||
name|E1000_CTRL_FD
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|em_config_flow_control_after_link_up
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|Adapter
operator|->
name|MediaType
operator|==
name|MEDIA_TYPE_FIBER
operator|)
operator|&&
operator|(
name|CtrlRegValue
operator|&
name|E1000_CTRL_SLU
operator|)
operator|&&
operator|(
name|RxcwRegValue
operator|&
name|E1000_RXCW_C
operator|)
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"RXing /C/, enable AutoNeg and stop forcing link.\r\n"
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Txcw
argument_list|,
name|Adapter
operator|->
name|TxcwRegValue
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
operator|(
name|CtrlRegValue
operator|&
operator|~
name|E1000_CTRL_SLU
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|em_clear_hw_stats_counters
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
specifier|volatile
name|u32
name|RegisterContents
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_clear_hw_stats_counters"
argument_list|)
if|if
condition|(
name|Adapter
operator|->
name|AdapterStopped
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Exiting because the adapter is stopped!!!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Crcerrs
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Symerrs
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Mpc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Scc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Ecol
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Mcc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Latecol
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Colc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Dc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Sec
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Rlec
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Xonrxc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Xontxc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Xoffrxc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Xofftxc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Fcruc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Prc64
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Prc127
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Prc255
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Prc511
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Prc1023
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Prc1522
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Gprc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Bprc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Mprc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Gptc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Gorl
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Gorh
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Gotl
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Goth
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Rnbc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Ruc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Rfc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Roc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Rjc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Torl
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Torh
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Totl
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Toth
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Tpr
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Tpt
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Ptc64
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Ptc127
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Ptc255
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Ptc511
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Ptc1023
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Ptc1522
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Mptc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Bptc
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|<
name|MAC_LIVENGOOD
condition|)
return|return;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Algnerrc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Rxerrc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Tuc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Tncrs
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Cexterr
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Rutec
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Tsctc
argument_list|)
expr_stmt|;
name|RegisterContents
operator|=
name|E1000_READ_REG
argument_list|(
name|Tsctfc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|em_get_speed_and_duplex
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u16
modifier|*
name|Speed
parameter_list|,
name|u16
modifier|*
name|Duplex
parameter_list|)
block|{
name|u32
name|DeviceStatusReg
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_get_speed_and_duplex"
argument_list|)
if|if
condition|(
name|Adapter
operator|->
name|AdapterStopped
condition|)
block|{
operator|*
name|Speed
operator|=
literal|0
expr_stmt|;
operator|*
name|Duplex
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>=
name|MAC_LIVENGOOD
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Livengood MAC\n"
argument_list|)
expr_stmt|;
name|DeviceStatusReg
operator|=
name|E1000_READ_REG
argument_list|(
name|Status
argument_list|)
expr_stmt|;
if|if
condition|(
name|DeviceStatusReg
operator|&
name|E1000_STATUS_SPEED_1000
condition|)
block|{
operator|*
name|Speed
operator|=
name|SPEED_1000
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"   1000 Mbs\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DeviceStatusReg
operator|&
name|E1000_STATUS_SPEED_100
condition|)
block|{
operator|*
name|Speed
operator|=
name|SPEED_100
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"   100 Mbs\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|Speed
operator|=
name|SPEED_10
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"   10 Mbs\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|DeviceStatusReg
operator|&
name|E1000_STATUS_FD
condition|)
block|{
operator|*
name|Duplex
operator|=
name|FULL_DUPLEX
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"   Full Duplex\r\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|Duplex
operator|=
name|HALF_DUPLEX
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"   Half Duplex\r\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DEBUGOUT
argument_list|(
literal|"Wiseman MAC - 1000 Mbs, Full Duplex\r\n"
argument_list|)
expr_stmt|;
operator|*
name|Speed
operator|=
name|SPEED_1000
expr_stmt|;
operator|*
name|Duplex
operator|=
name|FULL_DUPLEX
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|em_setup_eeprom
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|val
decl_stmt|;
name|val
operator|=
name|E1000_READ_REG
argument_list|(
name|Eecd
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
name|E1000_EESK
operator||
name|E1000_EEDI
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator||=
name|E1000_EECS
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|em_standby_eeprom
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|val
decl_stmt|;
name|val
operator|=
name|E1000_READ_REG
argument_list|(
name|Eecd
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
name|E1000_EECS
operator||
name|E1000_EESK
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|val
operator||=
name|E1000_EESK
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|val
operator||=
name|E1000_EECS
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|E1000_EESK
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|em_clock_eeprom
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|val
decl_stmt|;
name|val
operator|=
name|E1000_READ_REG
argument_list|(
name|Eecd
argument_list|)
expr_stmt|;
name|val
operator||=
name|E1000_EESK
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|E1000_EESK
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|em_cleanup_eeprom
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|val
decl_stmt|;
name|val
operator|=
name|E1000_READ_REG
argument_list|(
name|Eecd
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
name|E1000_EECS
operator||
name|E1000_EEDI
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|em_clock_eeprom
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u16
name|em_read_eeprom_word
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u16
name|Reg
parameter_list|)
block|{
name|u16
name|Data
decl_stmt|;
name|ASSERT
argument_list|(
name|Reg
operator|<
name|EEPROM_WORD_SIZE
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|E1000_EECS
argument_list|)
expr_stmt|;
name|em_shift_out_bits
argument_list|(
name|Adapter
argument_list|,
name|EEPROM_READ_OPCODE
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|em_shift_out_bits
argument_list|(
name|Adapter
argument_list|,
name|Reg
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_shift_in_bits
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
name|em_eeprom_cleanup
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
return|return
operator|(
name|Data
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|em_shift_out_bits
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u16
name|Data
parameter_list|,
name|u16
name|Count
parameter_list|)
block|{
name|u32
name|EecdRegValue
decl_stmt|;
name|u32
name|Mask
decl_stmt|;
name|Mask
operator|=
literal|0x01
operator|<<
operator|(
name|Count
operator|-
literal|1
operator|)
expr_stmt|;
name|EecdRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Eecd
argument_list|)
expr_stmt|;
name|EecdRegValue
operator|&=
operator|~
operator|(
name|E1000_EEDO
operator||
name|E1000_EEDI
operator|)
expr_stmt|;
do|do
block|{
name|EecdRegValue
operator|&=
operator|~
name|E1000_EEDI
expr_stmt|;
if|if
condition|(
name|Data
operator|&
name|Mask
condition|)
name|EecdRegValue
operator||=
name|E1000_EEDI
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|EecdRegValue
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|em_raise_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|EecdRegValue
argument_list|)
expr_stmt|;
name|em_lower_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|EecdRegValue
argument_list|)
expr_stmt|;
name|Mask
operator|=
name|Mask
operator|>>
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|Mask
condition|)
do|;
name|EecdRegValue
operator|&=
operator|~
name|E1000_EEDI
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|EecdRegValue
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|em_raise_clock
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
modifier|*
name|EecdRegValue
parameter_list|)
block|{
operator|*
name|EecdRegValue
operator|=
operator|*
name|EecdRegValue
operator||
name|E1000_EESK
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
operator|*
name|EecdRegValue
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|em_lower_clock
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
modifier|*
name|EecdRegValue
parameter_list|)
block|{
operator|*
name|EecdRegValue
operator|=
operator|*
name|EecdRegValue
operator|&
operator|~
name|E1000_EESK
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
operator|*
name|EecdRegValue
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u16
name|em_shift_in_bits
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|EecdRegValue
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|u16
name|Data
decl_stmt|;
name|EecdRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Eecd
argument_list|)
expr_stmt|;
name|EecdRegValue
operator|&=
operator|~
operator|(
name|E1000_EEDO
operator||
name|E1000_EEDI
operator|)
expr_stmt|;
name|Data
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|Data
operator|=
name|Data
operator|<<
literal|1
expr_stmt|;
name|em_raise_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|EecdRegValue
argument_list|)
expr_stmt|;
name|EecdRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Eecd
argument_list|)
expr_stmt|;
name|EecdRegValue
operator|&=
operator|~
operator|(
name|E1000_EEDI
operator|)
expr_stmt|;
if|if
condition|(
name|EecdRegValue
operator|&
name|E1000_EEDO
condition|)
name|Data
operator||=
literal|1
expr_stmt|;
name|em_lower_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|EecdRegValue
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|Data
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|em_eeprom_cleanup
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|EecdRegValue
decl_stmt|;
name|EecdRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Eecd
argument_list|)
expr_stmt|;
name|EecdRegValue
operator|&=
operator|~
operator|(
name|E1000_EECS
operator||
name|E1000_EEDI
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|EecdRegValue
argument_list|)
expr_stmt|;
name|em_raise_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|EecdRegValue
argument_list|)
expr_stmt|;
name|em_lower_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|EecdRegValue
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u8
name|em_validate_eeprom_checksum
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u16
name|Checksum
init|=
literal|0
decl_stmt|;
name|u16
name|Iteration
decl_stmt|;
for|for
control|(
name|Iteration
operator|=
literal|0
init|;
name|Iteration
operator|<
operator|(
name|EEPROM_CHECKSUM_REG
operator|+
literal|1
operator|)
condition|;
name|Iteration
operator|++
control|)
name|Checksum
operator|+=
name|em_read_eeprom_word
argument_list|(
name|Adapter
argument_list|,
name|Iteration
argument_list|)
expr_stmt|;
if|if
condition|(
name|Checksum
operator|==
operator|(
name|u16
operator|)
name|EEPROM_SUM
condition|)
return|return
operator|(
literal|1
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|em_update_eeprom_checksum
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u16
name|Checksum
init|=
literal|0
decl_stmt|;
name|u16
name|Iteration
decl_stmt|;
for|for
control|(
name|Iteration
operator|=
literal|0
init|;
name|Iteration
operator|<
name|EEPROM_CHECKSUM_REG
condition|;
name|Iteration
operator|++
control|)
name|Checksum
operator|+=
name|em_read_eeprom_word
argument_list|(
name|Adapter
argument_list|,
name|Iteration
argument_list|)
expr_stmt|;
name|Checksum
operator|=
operator|(
name|u16
operator|)
name|EEPROM_SUM
operator|-
name|Checksum
expr_stmt|;
name|em_write_eeprom_word
argument_list|(
name|Adapter
argument_list|,
name|EEPROM_CHECKSUM_REG
argument_list|,
name|Checksum
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u8
name|em_write_eeprom_word
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u16
name|Reg
parameter_list|,
name|u16
name|Data
parameter_list|)
block|{
name|em_setup_eeprom
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
name|em_shift_out_bits
argument_list|(
name|Adapter
argument_list|,
name|EEPROM_EWEN_OPCODE
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|em_shift_out_bits
argument_list|(
name|Adapter
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|em_standby_eeprom
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
name|em_shift_out_bits
argument_list|(
name|Adapter
argument_list|,
name|EEPROM_WRITE_OPCODE
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|em_shift_out_bits
argument_list|(
name|Adapter
argument_list|,
name|Reg
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|em_shift_out_bits
argument_list|(
name|Adapter
argument_list|,
name|Data
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|em_wait_eeprom_command_done
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
name|em_standby_eeprom
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
name|em_shift_out_bits
argument_list|(
name|Adapter
argument_list|,
name|EEPROM_EWDS_OPCODE
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|em_shift_out_bits
argument_list|(
name|Adapter
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|em_cleanup_eeprom
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u16
name|em_wait_eeprom_command_done
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|EecdRegValue
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|em_stand_by
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|200
condition|;
name|i
operator|++
control|)
block|{
name|EecdRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Eecd
argument_list|)
expr_stmt|;
if|if
condition|(
name|EecdRegValue
operator|&
name|E1000_EEDO
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|DelayInMicroseconds
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
name|ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|em_stand_by
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|EecdRegValue
decl_stmt|;
name|EecdRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Eecd
argument_list|)
expr_stmt|;
name|EecdRegValue
operator|&=
operator|~
operator|(
name|E1000_EECS
operator||
name|E1000_EESK
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|EecdRegValue
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|EecdRegValue
operator||=
name|E1000_EECS
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Eecd
argument_list|,
name|EecdRegValue
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u8
name|em_read_part_number
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
modifier|*
name|PartNumber
parameter_list|)
block|{
name|u16
name|EepromWordValue
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_read_part_number"
argument_list|)
if|if
condition|(
name|Adapter
operator|->
name|AdapterStopped
condition|)
block|{
operator|*
name|PartNumber
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|EepromWordValue
operator|=
name|em_read_eeprom_word
argument_list|(
name|Adapter
argument_list|,
call|(
name|u16
call|)
argument_list|(
name|EEPROM_PBA_BYTE_1
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Read first part number word\n"
argument_list|)
expr_stmt|;
operator|*
name|PartNumber
operator|=
operator|(
name|u32
operator|)
name|EepromWordValue
expr_stmt|;
operator|*
name|PartNumber
operator|=
operator|*
name|PartNumber
operator|<<
literal|16
expr_stmt|;
name|EepromWordValue
operator|=
name|em_read_eeprom_word
argument_list|(
name|Adapter
argument_list|,
call|(
name|u16
call|)
argument_list|(
name|EEPROM_PBA_BYTE_1
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Read second part number word\n"
argument_list|)
expr_stmt|;
operator|*
name|PartNumber
operator||=
name|EepromWordValue
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|void
name|em_id_led_on
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|CtrlRegValue
decl_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|AdapterStopped
condition|)
block|{
return|return;
block|}
name|CtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
name|CtrlRegValue
operator||=
name|E1000_CTRL_SWDPIO0
expr_stmt|;
if|if
condition|(
name|em_is_low_profile
argument_list|(
name|Adapter
argument_list|)
condition|)
block|{
name|CtrlRegValue
operator|&=
operator|~
name|E1000_CTRL_SWDPIN0
expr_stmt|;
block|}
else|else
block|{
name|CtrlRegValue
operator||=
name|E1000_CTRL_SWDPIN0
expr_stmt|;
block|}
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|CtrlRegValue
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|em_id_led_off
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|CtrlRegValue
decl_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|AdapterStopped
condition|)
block|{
return|return;
block|}
name|CtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
name|CtrlRegValue
operator||=
name|E1000_CTRL_SWDPIO0
expr_stmt|;
if|if
condition|(
name|em_is_low_profile
argument_list|(
name|Adapter
argument_list|)
condition|)
block|{
name|CtrlRegValue
operator||=
name|E1000_CTRL_SWDPIN0
expr_stmt|;
block|}
else|else
block|{
name|CtrlRegValue
operator|&=
operator|~
name|E1000_CTRL_SWDPIN0
expr_stmt|;
block|}
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|CtrlRegValue
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|em_set_id_led_for_pc_ix
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|PciStatus
decl_stmt|;
name|PciStatus
operator|=
name|E1000_READ_REG
argument_list|(
name|Status
argument_list|)
expr_stmt|;
if|if
condition|(
name|PciStatus
operator|&
name|E1000_STATUS_PCIX_MODE
condition|)
block|{
name|em_id_led_on
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|em_id_led_off
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|u8
name|em_is_low_profile
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u16
name|LedLogicWord
decl_stmt|;
name|u8
name|ReturnValue
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>=
name|MAC_CORDOVA
condition|)
block|{
name|LedLogicWord
operator|=
name|em_read_eeprom_word
argument_list|(
name|Adapter
argument_list|,
name|E1000_EEPROM_LED_LOGIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|LedLogicWord
operator|&
name|E1000_EEPROM_SWDPIN0
condition|)
name|ReturnValue
operator|=
literal|1
expr_stmt|;
else|else
name|ReturnValue
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ReturnValue
return|;
block|}
end_function

begin_function
name|void
name|em_adjust_tbi_accepted_stats
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
name|FrameLength
parameter_list|,
name|u8
modifier|*
name|MacAddress
parameter_list|)
block|{
name|u32
name|CarryBit
decl_stmt|;
name|FrameLength
operator|--
expr_stmt|;
name|Adapter
operator|->
name|Crcerrs
operator|--
expr_stmt|;
name|Adapter
operator|->
name|Gprc
operator|++
expr_stmt|;
name|CarryBit
operator|=
literal|0x80000000
operator|&
name|Adapter
operator|->
name|Gorcl
expr_stmt|;
name|Adapter
operator|->
name|Gorcl
operator|+=
name|FrameLength
expr_stmt|;
if|if
condition|(
name|CarryBit
operator|&&
operator|(
operator|(
name|Adapter
operator|->
name|Gorcl
operator|&
literal|0x80000000
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
name|Adapter
operator|->
name|Gorch
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|MacAddress
index|[
literal|0
index|]
operator|==
operator|(
name|u8
operator|)
literal|0xff
operator|)
operator|&&
operator|(
name|MacAddress
index|[
literal|1
index|]
operator|==
operator|(
name|u8
operator|)
literal|0xff
operator|)
condition|)
block|{
name|Adapter
operator|->
name|Bprc
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|MacAddress
operator|&
literal|0x01
condition|)
block|{
name|Adapter
operator|->
name|Mprc
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|FrameLength
operator|==
name|Adapter
operator|->
name|MaxFrameSize
condition|)
block|{
name|Adapter
operator|->
name|Roc
operator|+=
name|E1000_READ_REG
argument_list|(
name|Roc
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|Roc
operator|>
literal|0
condition|)
name|Adapter
operator|->
name|Roc
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|FrameLength
operator|==
literal|64
condition|)
block|{
name|Adapter
operator|->
name|Prc64
operator|++
expr_stmt|;
name|Adapter
operator|->
name|Prc127
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FrameLength
operator|==
literal|127
condition|)
block|{
name|Adapter
operator|->
name|Prc127
operator|++
expr_stmt|;
name|Adapter
operator|->
name|Prc255
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FrameLength
operator|==
literal|255
condition|)
block|{
name|Adapter
operator|->
name|Prc255
operator|++
expr_stmt|;
name|Adapter
operator|->
name|Prc511
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FrameLength
operator|==
literal|511
condition|)
block|{
name|Adapter
operator|->
name|Prc511
operator|++
expr_stmt|;
name|Adapter
operator|->
name|Prc1023
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FrameLength
operator|==
literal|1023
condition|)
block|{
name|Adapter
operator|->
name|Prc1023
operator|++
expr_stmt|;
name|Adapter
operator|->
name|Prc1522
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FrameLength
operator|==
literal|1522
condition|)
block|{
name|Adapter
operator|->
name|Prc1522
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|em_get_bus_type_speed_width
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|DeviceStatusReg
decl_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|<
name|MAC_LIVENGOOD
condition|)
block|{
name|Adapter
operator|->
name|BusType
operator|=
name|E1000_BUS_TYPE_UNKNOWN
expr_stmt|;
name|Adapter
operator|->
name|BusSpeed
operator|=
name|E1000_BUS_SPEED_UNKNOWN
expr_stmt|;
name|Adapter
operator|->
name|BusWidth
operator|=
name|E1000_BUS_WIDTH_UNKNOWN
expr_stmt|;
return|return;
block|}
name|DeviceStatusReg
operator|=
name|E1000_READ_REG
argument_list|(
name|Status
argument_list|)
expr_stmt|;
name|Adapter
operator|->
name|BusType
operator|=
operator|(
name|DeviceStatusReg
operator|&
name|E1000_STATUS_PCIX_MODE
operator|)
condition|?
name|E1000_BUS_TYPE_PCIX
else|:
name|E1000_BUS_TYPE_PCI
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|BusType
operator|==
name|E1000_BUS_TYPE_PCI
condition|)
block|{
name|Adapter
operator|->
name|BusSpeed
operator|=
operator|(
name|DeviceStatusReg
operator|&
name|E1000_STATUS_PCI66
operator|)
condition|?
name|E1000_BUS_SPEED_PCI_66MHZ
else|:
name|E1000_BUS_SPEED_PCI_33MHZ
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|DeviceStatusReg
operator|&
name|E1000_STATUS_PCIX_SPEED
condition|)
block|{
case|case
name|E1000_STATUS_PCIX_SPEED_66
case|:
name|Adapter
operator|->
name|BusSpeed
operator|=
name|E1000_BUS_SPEED_PCIX_50_66MHZ
expr_stmt|;
break|break;
case|case
name|E1000_STATUS_PCIX_SPEED_100
case|:
name|Adapter
operator|->
name|BusSpeed
operator|=
name|E1000_BUS_SPEED_PCIX_66_100MHZ
expr_stmt|;
break|break;
case|case
name|E1000_STATUS_PCIX_SPEED_133
case|:
name|Adapter
operator|->
name|BusSpeed
operator|=
name|E1000_BUS_SPEED_PCIX_100_133MHZ
expr_stmt|;
break|break;
default|default:
name|Adapter
operator|->
name|BusSpeed
operator|=
name|E1000_BUS_SPEED_PCIX_RESERVED
expr_stmt|;
break|break;
block|}
block|}
name|Adapter
operator|->
name|BusWidth
operator|=
operator|(
name|DeviceStatusReg
operator|&
name|E1000_STATUS_BUS64
operator|)
condition|?
name|E1000_BUS_WIDTH_64_BIT
else|:
name|E1000_BUS_WIDTH_32_BIT
expr_stmt|;
return|return;
block|}
end_function

end_unit


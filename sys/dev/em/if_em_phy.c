begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************************* ************************************************************************** Copyright (c) 2001 Intel Corporation  All rights reserved.   Redistribution and use in source and binary forms of the Software, with or  without modification, are permitted provided that the following conditions  are met:    1. Redistributions of source code of the Software may retain the above      copyright notice, this list of conditions and the following disclaimer.    2. Redistributions in binary form of the Software may reproduce the above      copyright notice, this list of conditions and the following disclaimer      in the documentation and/or other materials provided with the      distribution.    3. Neither the name of the Intel Corporation nor the names of its      contributors shall be used to endorse or promote products derived from      this Software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  ARE DISCLAIMED. IN NO EVENT SHALL THE INTEL OR ITS CONTRIBUTORS BE LIABLE  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER  CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  SUCH DAMAGE. *************************************************************************** **************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_comment
comment|/* * Workfile: phy.c  * Date: 9/25/01 2:40p  * Revision: 37  */
end_comment

begin_include
include|#
directive|include
file|<dev/em/if_em_fxhw.h>
end_include

begin_include
include|#
directive|include
file|<dev/em/if_em_phy.h>
end_include

begin_function_decl
specifier|static
name|void
name|em_mii_shift_out_phy_data
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
name|Data
parameter_list|,
name|u16
name|Count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|em_raise_mdc_clock
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
modifier|*
name|CtrlRegValue
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|em_lower_mdc_clock
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
modifier|*
name|CtrlRegValue
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u16
name|em_mii_shift_in_phy_data
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u8
name|em_phy_setup_auto_neg_advertisement
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|em_phy_force_speed_and_duplex
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|GOOD_MII_IF
value|0
end_define

begin_function
name|u16
name|em_read_phy_register
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
name|RegAddress
parameter_list|,
name|u32
name|PhyAddress
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u32
name|Data
init|=
literal|0
decl_stmt|;
name|u32
name|Command
init|=
literal|0
decl_stmt|;
name|ASSERT
argument_list|(
name|RegAddress
operator|<=
name|MAX_PHY_REG_ADDRESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>
name|MAC_LIVENGOOD
condition|)
block|{
name|Command
operator|=
operator|(
operator|(
name|RegAddress
operator|<<
name|MDI_REGADD_SHIFT
operator|)
operator||
operator|(
name|PhyAddress
operator|<<
name|MDI_PHYADD_SHIFT
operator|)
operator||
operator|(
name|E1000_MDI_READ
operator|)
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Mdic
argument_list|,
name|Command
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|DelayInMicroseconds
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|Data
operator|=
name|E1000_READ_REG
argument_list|(
name|Mdic
argument_list|)
expr_stmt|;
if|if
condition|(
name|Data
operator|&
name|E1000_MDI_READY
condition|)
break|break;
block|}
block|}
else|else
block|{
name|em_mii_shift_out_phy_data
argument_list|(
name|Adapter
argument_list|,
name|PHY_PREAMBLE
argument_list|,
name|PHY_PREAMBLE_SIZE
argument_list|)
expr_stmt|;
name|Command
operator|=
operator|(
operator|(
name|RegAddress
operator|)
operator||
operator|(
name|PhyAddress
operator|<<
literal|5
operator|)
operator||
operator|(
name|PHY_OP_READ
operator|<<
literal|10
operator|)
operator||
operator|(
name|PHY_SOF
operator|<<
literal|12
operator|)
operator|)
expr_stmt|;
name|em_mii_shift_out_phy_data
argument_list|(
name|Adapter
argument_list|,
name|Command
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|Data
operator|=
operator|(
name|u32
operator|)
name|em_mii_shift_in_phy_data
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
name|ASSERT
argument_list|(
operator|!
operator|(
name|Data
operator|&
name|E1000_MDI_ERR
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|u16
operator|)
name|Data
operator|)
return|;
block|}
end_function

begin_function
name|void
name|em_write_phy_register
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
name|RegAddress
parameter_list|,
name|u32
name|PhyAddress
parameter_list|,
name|u16
name|Data
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u32
name|Command
init|=
literal|0
decl_stmt|;
name|u32
name|MdicRegValue
decl_stmt|;
name|ASSERT
argument_list|(
name|RegAddress
operator|<=
name|MAX_PHY_REG_ADDRESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>
name|MAC_LIVENGOOD
condition|)
block|{
name|Command
operator|=
operator|(
operator|(
operator|(
name|u32
operator|)
name|Data
operator|)
operator||
operator|(
name|RegAddress
operator|<<
name|MDI_REGADD_SHIFT
operator|)
operator||
operator|(
name|PhyAddress
operator|<<
name|MDI_PHYADD_SHIFT
operator|)
operator||
operator|(
name|E1000_MDI_WRITE
operator|)
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Mdic
argument_list|,
name|Command
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|DelayInMicroseconds
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|MdicRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Mdic
argument_list|)
expr_stmt|;
if|if
condition|(
name|MdicRegValue
operator|&
name|E1000_MDI_READY
condition|)
break|break;
block|}
block|}
else|else
block|{
name|em_mii_shift_out_phy_data
argument_list|(
name|Adapter
argument_list|,
name|PHY_PREAMBLE
argument_list|,
name|PHY_PREAMBLE_SIZE
argument_list|)
expr_stmt|;
name|Command
operator|=
operator|(
operator|(
name|PHY_TURNAROUND
operator|)
operator||
operator|(
name|RegAddress
operator|<<
literal|2
operator|)
operator||
operator|(
name|PhyAddress
operator|<<
literal|7
operator|)
operator||
operator|(
name|PHY_OP_WRITE
operator|<<
literal|12
operator|)
operator||
operator|(
name|PHY_SOF
operator|<<
literal|14
operator|)
operator|)
expr_stmt|;
name|Command
operator|<<=
literal|16
expr_stmt|;
name|Command
operator||=
operator|(
operator|(
name|u32
operator|)
name|Data
operator|)
expr_stmt|;
name|em_mii_shift_out_phy_data
argument_list|(
name|Adapter
argument_list|,
name|Command
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|u16
name|em_mii_shift_in_phy_data
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|CtrlRegValue
decl_stmt|;
name|u16
name|Data
init|=
literal|0
decl_stmt|;
name|u8
name|i
decl_stmt|;
name|CtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
name|CtrlRegValue
operator|&=
operator|~
name|E1000_CTRL_MDIO_DIR
expr_stmt|;
name|CtrlRegValue
operator|&=
operator|~
name|E1000_CTRL_MDIO
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|em_raise_mdc_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|em_lower_mdc_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|CtrlRegValue
argument_list|)
expr_stmt|;
for|for
control|(
name|Data
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|Data
operator|=
name|Data
operator|<<
literal|1
expr_stmt|;
name|em_raise_mdc_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|CtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|CtrlRegValue
operator|&
name|E1000_CTRL_MDIO
condition|)
name|Data
operator||=
literal|1
expr_stmt|;
name|em_lower_mdc_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|CtrlRegValue
argument_list|)
expr_stmt|;
block|}
name|em_raise_mdc_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|em_lower_mdc_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|CtrlRegValue
operator|&=
operator|~
name|E1000_CTRL_MDIO
expr_stmt|;
return|return
operator|(
name|Data
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|em_mii_shift_out_phy_data
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
name|Data
parameter_list|,
name|u16
name|Count
parameter_list|)
block|{
name|u32
name|CtrlRegValue
decl_stmt|;
name|u32
name|Mask
decl_stmt|;
if|if
condition|(
name|Count
operator|>
literal|32
condition|)
name|ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|Mask
operator|=
literal|0x01
expr_stmt|;
name|Mask
operator|<<=
operator|(
name|Count
operator|-
literal|1
operator|)
expr_stmt|;
name|CtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
name|CtrlRegValue
operator||=
operator|(
name|E1000_CTRL_MDIO_DIR
operator||
name|E1000_CTRL_MDC_DIR
operator|)
expr_stmt|;
while|while
condition|(
name|Mask
condition|)
block|{
if|if
condition|(
name|Data
operator|&
name|Mask
condition|)
name|CtrlRegValue
operator||=
name|E1000_CTRL_MDIO
expr_stmt|;
else|else
name|CtrlRegValue
operator|&=
operator|~
name|E1000_CTRL_MDIO
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|em_raise_mdc_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|em_lower_mdc_clock
argument_list|(
name|Adapter
argument_list|,
operator|&
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|Mask
operator|=
name|Mask
operator|>>
literal|1
expr_stmt|;
block|}
name|CtrlRegValue
operator|&=
operator|~
name|E1000_CTRL_MDIO
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|em_raise_mdc_clock
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
modifier|*
name|CtrlRegValue
parameter_list|)
block|{
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
operator|(
operator|*
name|CtrlRegValue
operator||
name|E1000_CTRL_MDC
operator|)
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|em_lower_mdc_clock
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
modifier|*
name|CtrlRegValue
parameter_list|)
block|{
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
operator|(
operator|*
name|CtrlRegValue
operator|&
operator|~
name|E1000_CTRL_MDC
operator|)
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|em_phy_hardware_reset
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|ExtCtrlRegValue
decl_stmt|,
name|CtrlRegValue
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_phy_hardware_reset"
argument_list|)
name|DEBUGOUT
argument_list|(
literal|"Resetting Phy...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>
name|MAC_LIVENGOOD
condition|)
block|{
name|CtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
name|CtrlRegValue
operator||=
name|E1000_CTRL_PHY_RST
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|DelayInMilliseconds
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|CtrlRegValue
operator|&=
operator|~
name|E1000_CTRL_PHY_RST
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|CtrlRegValue
argument_list|)
expr_stmt|;
name|DelayInMilliseconds
argument_list|(
literal|20
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ExtCtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Exct
argument_list|)
expr_stmt|;
name|ExtCtrlRegValue
operator||=
name|E1000_CTRL_PHY_RESET_DIR4
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Exct
argument_list|,
name|ExtCtrlRegValue
argument_list|)
expr_stmt|;
name|DelayInMilliseconds
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|ExtCtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Exct
argument_list|)
expr_stmt|;
name|ExtCtrlRegValue
operator|&=
operator|~
name|E1000_CTRL_PHY_RESET4
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Exct
argument_list|,
name|ExtCtrlRegValue
argument_list|)
expr_stmt|;
name|DelayInMilliseconds
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|ExtCtrlRegValue
operator|=
name|E1000_READ_REG
argument_list|(
name|Exct
argument_list|)
expr_stmt|;
name|ExtCtrlRegValue
operator||=
name|E1000_CTRL_PHY_RESET4
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Exct
argument_list|,
name|ExtCtrlRegValue
argument_list|)
expr_stmt|;
name|DelayInMilliseconds
argument_list|(
literal|20
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|u8
name|em_phy_reset
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u16
name|RegData
decl_stmt|;
name|u16
name|i
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_phy_reset"
argument_list|)
name|RegData
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|RegData
operator||=
name|MII_CR_RESET
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|RegData
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|RegData
operator|&
name|MII_CR_RESET
operator|)
operator|&&
name|i
operator|++
operator|<
literal|500
condition|)
block|{
name|RegData
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|>=
literal|500
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Timeout waiting for PHY to reset.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|u8
name|em_phy_setup
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u32
name|DeviceControlReg
parameter_list|)
block|{
name|u16
name|MiiCtrlReg
decl_stmt|,
name|MiiStatusReg
decl_stmt|;
name|u16
name|PhySpecCtrlReg
decl_stmt|;
name|u16
name|MiiAutoNegAdvertiseReg
decl_stmt|,
name|Mii1000TCtrlReg
decl_stmt|;
name|u16
name|i
decl_stmt|,
name|Data
decl_stmt|;
name|u16
name|AutoNegHwSetting
decl_stmt|;
name|u16
name|AutoNegFCSetting
decl_stmt|;
name|u8
name|RestartAutoNeg
init|=
literal|0
decl_stmt|;
name|u8
name|ForceAutoNegRestart
init|=
literal|0
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_phy_setup"
argument_list|)
name|ASSERT
argument_list|(
name|Adapter
operator|->
name|MacType
operator|>=
name|MAC_LIVENGOOD
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>
name|MAC_WAINWRIGHT
condition|)
block|{
name|DeviceControlReg
operator||=
operator|(
name|E1000_CTRL_ASDE
operator||
name|E1000_CTRL_SLU
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|DeviceControlReg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DeviceControlReg
operator||=
operator|(
name|E1000_CTRL_FRCSPD
operator||
name|E1000_CTRL_FRCDPX
operator||
name|E1000_CTRL_SLU
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|DeviceControlReg
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|==
name|MAC_LIVENGOOD
condition|)
name|em_phy_hardware_reset
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
name|Adapter
operator|->
name|PhyAddress
operator|=
name|em_auto_detect_gigabit_phy
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|PhyAddress
operator|>
name|MAX_PHY_REG_ADDRESS
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"em_phy_setup failure, did not detect valid phy.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|DEBUGOUT1
argument_list|(
literal|"Phy ID = %x \n"
argument_list|,
name|Adapter
operator|->
name|PhyId
argument_list|)
expr_stmt|;
name|MiiCtrlReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"MII Ctrl Reg contents = %x\n"
argument_list|,
name|MiiCtrlReg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|MiiCtrlReg
operator|&
name|MII_CR_AUTO_NEG_EN
operator|)
condition|)
name|ForceAutoNegRestart
operator|=
literal|1
expr_stmt|;
name|MiiCtrlReg
operator|&=
operator|~
operator|(
name|MII_CR_ISOLATE
operator|)
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|MiiCtrlReg
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|Data
operator||=
name|PXN_PSCR_ASSERT_CRS_ON_TX
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson PSCR: %x \n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_EXT_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|Data
operator||=
name|PXN_EPSCR_TX_CLK_25
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_EXT_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|MiiAutoNegAdvertiseReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_ADVERTISEMENT
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|AutoNegHwSetting
operator|=
operator|(
name|MiiAutoNegAdvertiseReg
operator|>>
literal|5
operator|)
operator|&
literal|0xF
expr_stmt|;
name|Mii1000TCtrlReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_1000T_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|AutoNegHwSetting
operator||=
operator|(
operator|(
name|Mii1000TCtrlReg
operator|&
literal|0x0300
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
name|AutoNegFCSetting
operator|=
operator|(
operator|(
name|MiiAutoNegAdvertiseReg
operator|&
literal|0x0C00
operator|)
operator|>>
literal|10
operator|)
expr_stmt|;
name|Adapter
operator|->
name|AutoNegAdvertised
operator|&=
name|AUTONEG_ADVERTISE_SPEED_DEFAULT
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|AutoNegAdvertised
operator|==
literal|0
condition|)
name|Adapter
operator|->
name|AutoNegAdvertised
operator|=
name|AUTONEG_ADVERTISE_SPEED_DEFAULT
expr_stmt|;
if|if
condition|(
operator|!
name|ForceAutoNegRestart
operator|&&
name|Adapter
operator|->
name|AutoNeg
operator|&&
operator|(
name|Adapter
operator|->
name|AutoNegAdvertised
operator|==
name|AutoNegHwSetting
operator|)
operator|&&
operator|(
name|Adapter
operator|->
name|FlowControl
operator|==
name|AutoNegFCSetting
operator|)
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"No overrides - Reading MII Status Reg..\n"
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"MII Status Reg contents = %x\n"
argument_list|,
name|MiiStatusReg
argument_list|)
expr_stmt|;
if|if
condition|(
name|MiiStatusReg
operator|&
name|MII_SR_LINK_STATUS
condition|)
block|{
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_STAT_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson Phy Specific Status Reg contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>
name|MAC_WAINWRIGHT
condition|)
name|em_configure_collision_distance
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
else|else
name|em_configure_mac_to_phy_settings
argument_list|(
name|Adapter
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|em_config_flow_control_after_link_up
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
name|PhySpecCtrlReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhySpecCtrlReg
operator|&=
operator|~
name|PXN_PSCR_AUTO_X_MODE
expr_stmt|;
switch|switch
condition|(
name|Adapter
operator|->
name|MdiX
condition|)
block|{
case|case
literal|1
case|:
name|PhySpecCtrlReg
operator||=
name|PXN_PSCR_MDI_MANUAL_MODE
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|PhySpecCtrlReg
operator||=
name|PXN_PSCR_MDIX_MANUAL_MODE
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|PhySpecCtrlReg
operator||=
name|PXN_PSCR_AUTO_X_1000T
expr_stmt|;
break|break;
case|case
literal|0
case|:
default|default:
name|PhySpecCtrlReg
operator||=
name|PXN_PSCR_AUTO_X_MODE
expr_stmt|;
break|break;
block|}
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|PhySpecCtrlReg
argument_list|)
expr_stmt|;
name|PhySpecCtrlReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhySpecCtrlReg
operator|&=
operator|~
name|PXN_PSCR_POLARITY_REVERSAL
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|DisablePolarityCorrection
operator|==
literal|1
condition|)
name|PhySpecCtrlReg
operator||=
name|PXN_PSCR_POLARITY_REVERSAL
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|PhySpecCtrlReg
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|AutoNeg
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Livengood - Reconfiguring auto-neg advertisement params\n"
argument_list|)
expr_stmt|;
name|RestartAutoNeg
operator|=
name|em_phy_setup_auto_neg_advertisement
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DEBUGOUT
argument_list|(
literal|"Livengood - Forcing speed and duplex\n"
argument_list|)
expr_stmt|;
name|em_phy_force_speed_and_duplex
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|RestartAutoNeg
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Restarting Auto-Neg\n"
argument_list|)
expr_stmt|;
name|MiiCtrlReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiCtrlReg
operator||=
operator|(
name|MII_CR_AUTO_NEG_EN
operator||
name|MII_CR_RESTART_AUTO_NEG
operator|)
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|MiiCtrlReg
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|WaitAutoNegComplete
condition|)
name|em_wait_for_auto_neg
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Checking for link status - MII Status Reg contents = %x\n"
argument_list|,
name|MiiStatusReg
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|MiiStatusReg
operator|&
name|MII_SR_LINK_STATUS
condition|)
block|{
break|break;
block|}
name|DelayInMicroseconds
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|". "
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|MiiStatusReg
operator|&
name|MII_SR_LINK_STATUS
condition|)
block|{
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_STAT_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson Phy Specific Status Reg contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|MacType
operator|>
name|MAC_WAINWRIGHT
condition|)
name|em_configure_collision_distance
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
else|else
name|em_configure_mac_to_phy_settings
argument_list|(
name|Adapter
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|em_config_flow_control_after_link_up
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Valid link established!!!\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DEBUGOUT
argument_list|(
literal|"Unable to establish link!!!\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|u8
name|em_phy_setup_auto_neg_advertisement
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u16
name|MiiAutoNegAdvertiseReg
decl_stmt|,
name|Mii1000TCtrlReg
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_phy_setup_auto_neg_advertisement"
argument_list|)
name|MiiAutoNegAdvertiseReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_ADVERTISEMENT
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|Mii1000TCtrlReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_1000T_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiAutoNegAdvertiseReg
operator|&=
operator|~
name|REG4_SPEED_MASK
expr_stmt|;
name|Mii1000TCtrlReg
operator|&=
operator|~
name|REG9_SPEED_MASK
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"AutoNegAdvertised %x\n"
argument_list|,
name|Adapter
operator|->
name|AutoNegAdvertised
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|AutoNegAdvertised
operator|&
name|ADVERTISE_10_HALF
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Advertise 10mb Half duplex\n"
argument_list|)
expr_stmt|;
name|MiiAutoNegAdvertiseReg
operator||=
name|NWAY_AR_10T_HD_CAPS
expr_stmt|;
block|}
if|if
condition|(
name|Adapter
operator|->
name|AutoNegAdvertised
operator|&
name|ADVERTISE_10_FULL
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Advertise 10mb Full duplex\n"
argument_list|)
expr_stmt|;
name|MiiAutoNegAdvertiseReg
operator||=
name|NWAY_AR_10T_FD_CAPS
expr_stmt|;
block|}
if|if
condition|(
name|Adapter
operator|->
name|AutoNegAdvertised
operator|&
name|ADVERTISE_100_HALF
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Advertise 100mb Half duplex\n"
argument_list|)
expr_stmt|;
name|MiiAutoNegAdvertiseReg
operator||=
name|NWAY_AR_100TX_HD_CAPS
expr_stmt|;
block|}
if|if
condition|(
name|Adapter
operator|->
name|AutoNegAdvertised
operator|&
name|ADVERTISE_100_FULL
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Advertise 100mb Full duplex\n"
argument_list|)
expr_stmt|;
name|MiiAutoNegAdvertiseReg
operator||=
name|NWAY_AR_100TX_FD_CAPS
expr_stmt|;
block|}
if|if
condition|(
name|Adapter
operator|->
name|AutoNegAdvertised
operator|&
name|ADVERTISE_1000_HALF
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Advertise 1000mb Half duplex requested, request denied!\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Adapter
operator|->
name|AutoNegAdvertised
operator|&
name|ADVERTISE_1000_FULL
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Advertise 1000mb Full duplex\n"
argument_list|)
expr_stmt|;
name|Mii1000TCtrlReg
operator||=
name|CR_1000T_FD_CAPS
expr_stmt|;
block|}
switch|switch
condition|(
name|Adapter
operator|->
name|FlowControl
condition|)
block|{
case|case
name|FLOW_CONTROL_NONE
case|:
name|MiiAutoNegAdvertiseReg
operator|&=
operator|~
operator|(
name|NWAY_AR_ASM_DIR
operator||
name|NWAY_AR_PAUSE
operator|)
expr_stmt|;
break|break;
case|case
name|FLOW_CONTROL_RECEIVE_PAUSE
case|:
name|MiiAutoNegAdvertiseReg
operator||=
operator|(
name|NWAY_AR_ASM_DIR
operator||
name|NWAY_AR_PAUSE
operator|)
expr_stmt|;
break|break;
case|case
name|FLOW_CONTROL_TRANSMIT_PAUSE
case|:
name|MiiAutoNegAdvertiseReg
operator||=
name|NWAY_AR_ASM_DIR
expr_stmt|;
name|MiiAutoNegAdvertiseReg
operator|&=
operator|~
name|NWAY_AR_PAUSE
expr_stmt|;
break|break;
case|case
name|FLOW_CONTROL_FULL
case|:
name|MiiAutoNegAdvertiseReg
operator||=
operator|(
name|NWAY_AR_ASM_DIR
operator||
name|NWAY_AR_PAUSE
operator|)
expr_stmt|;
break|break;
default|default:
name|DEBUGOUT
argument_list|(
literal|"Flow control param set incorrectly\n"
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_ADVERTISEMENT
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|MiiAutoNegAdvertiseReg
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Auto-Neg Advertising %x\n"
argument_list|,
name|MiiAutoNegAdvertiseReg
argument_list|)
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_1000T_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|Mii1000TCtrlReg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|em_phy_force_speed_and_duplex
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u16
name|MiiCtrlReg
decl_stmt|;
name|u16
name|MiiStatusReg
decl_stmt|;
name|u16
name|PhyData
decl_stmt|;
name|u16
name|i
decl_stmt|;
name|u32
name|TctlReg
decl_stmt|;
name|u32
name|DeviceCtrlReg
decl_stmt|;
name|u32
name|Shift32
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_phy_force_speed_and_duplex"
argument_list|)
name|Adapter
operator|->
name|FlowControl
operator|=
name|FLOW_CONTROL_NONE
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Adapter->FlowControl = %d\n"
argument_list|,
name|Adapter
operator|->
name|FlowControl
argument_list|)
expr_stmt|;
name|DeviceCtrlReg
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
name|DeviceCtrlReg
operator||=
operator|(
name|E1000_CTRL_FRCSPD
operator||
name|E1000_CTRL_FRCDPX
operator|)
expr_stmt|;
name|DeviceCtrlReg
operator|&=
operator|~
operator|(
name|DEVICE_SPEED_MASK
operator|)
expr_stmt|;
name|DeviceCtrlReg
operator|&=
operator|~
name|E1000_CTRL_ASDE
expr_stmt|;
name|MiiCtrlReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiCtrlReg
operator|&=
operator|~
name|MII_CR_AUTO_NEG_EN
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|ForcedSpeedDuplex
operator|==
name|FULL_100
operator|||
name|Adapter
operator|->
name|ForcedSpeedDuplex
operator|==
name|FULL_10
condition|)
block|{
name|DeviceCtrlReg
operator||=
name|E1000_CTRL_FD
expr_stmt|;
name|MiiCtrlReg
operator||=
name|MII_CR_FULL_DUPLEX
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Full Duplex\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DeviceCtrlReg
operator|&=
operator|~
name|E1000_CTRL_FD
expr_stmt|;
name|MiiCtrlReg
operator|&=
operator|~
name|MII_CR_FULL_DUPLEX
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Half Duplex\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Adapter
operator|->
name|ForcedSpeedDuplex
operator|==
name|FULL_100
operator|||
name|Adapter
operator|->
name|ForcedSpeedDuplex
operator|==
name|HALF_100
condition|)
block|{
name|DeviceCtrlReg
operator||=
name|E1000_CTRL_SPD_100
expr_stmt|;
name|MiiCtrlReg
operator||=
name|MII_CR_SPEED_100
expr_stmt|;
name|MiiCtrlReg
operator|&=
operator|~
operator|(
name|MII_CR_SPEED_1000
operator||
name|MII_CR_SPEED_10
operator|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Forcing 100mb "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DeviceCtrlReg
operator|&=
operator|~
operator|(
name|E1000_CTRL_SPD_1000
operator||
name|E1000_CTRL_SPD_100
operator|)
expr_stmt|;
name|MiiCtrlReg
operator||=
name|MII_CR_SPEED_10
expr_stmt|;
name|MiiCtrlReg
operator|&=
operator|~
operator|(
name|MII_CR_SPEED_1000
operator||
name|MII_CR_SPEED_100
operator|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Forcing 10mb "
argument_list|)
expr_stmt|;
block|}
name|TctlReg
operator|=
name|E1000_READ_REG
argument_list|(
name|Tctl
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"TctlReg = %x\n"
argument_list|,
name|TctlReg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|MiiCtrlReg
operator|&
name|MII_CR_FULL_DUPLEX
operator|)
condition|)
block|{
name|TctlReg
operator|&=
operator|~
name|E1000_TCTL_COLD
expr_stmt|;
name|Shift32
operator|=
name|E1000_HDX_COLLISION_DISTANCE
expr_stmt|;
name|Shift32
operator|<<=
name|E1000_COLD_SHIFT
expr_stmt|;
name|TctlReg
operator||=
name|Shift32
expr_stmt|;
block|}
else|else
block|{
name|TctlReg
operator|&=
operator|~
name|E1000_TCTL_COLD
expr_stmt|;
name|Shift32
operator|=
name|E1000_FDX_COLLISION_DISTANCE
expr_stmt|;
name|Shift32
operator|<<=
name|E1000_COLD_SHIFT
expr_stmt|;
name|TctlReg
operator||=
name|Shift32
expr_stmt|;
block|}
name|E1000_WRITE_REG
argument_list|(
name|Tctl
argument_list|,
name|TctlReg
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|DeviceCtrlReg
argument_list|)
expr_stmt|;
name|PhyData
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhyData
operator|&=
operator|~
name|PXN_PSCR_AUTO_X_MODE
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|PhyData
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson PSCR: %x \n"
argument_list|,
name|PhyData
argument_list|)
expr_stmt|;
name|MiiCtrlReg
operator||=
name|MII_CR_RESET
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|MiiCtrlReg
argument_list|)
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|WaitAutoNegComplete
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Waiting for forced speed/duplex link.\n"
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
literal|0
expr_stmt|;
define|#
directive|define
name|PHY_WAIT_FOR_FORCED_TIME
value|20
for|for
control|(
name|i
operator|=
literal|20
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
if|if
condition|(
name|MiiStatusReg
operator|&
name|MII_SR_LINK_STATUS
condition|)
block|{
break|break;
block|}
name|DelayInMilliseconds
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|em_pxn_phy_reset_dsp
argument_list|(
name|Adapter
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|20
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|MiiStatusReg
operator|&
name|MII_SR_LINK_STATUS
condition|)
block|{
break|break;
block|}
name|DelayInMilliseconds
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
block|}
block|}
name|PhyData
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_EXT_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhyData
operator||=
name|PXN_EPSCR_TX_CLK_25
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_EXT_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|PhyData
argument_list|)
expr_stmt|;
name|PhyData
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhyData
operator||=
name|PXN_PSCR_ASSERT_CRS_ON_TX
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
name|PhyData
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"After force, Paxson Phy Specific Ctrl Reg = %4x\r\n"
argument_list|,
name|PhyData
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|em_configure_mac_to_phy_settings
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u16
name|MiiRegisterData
parameter_list|)
block|{
name|u32
name|DeviceCtrlReg
decl_stmt|,
name|TctlReg
decl_stmt|;
name|u32
name|Shift32
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_configure_mac_to_phy_settings"
argument_list|)
name|TctlReg
operator|=
name|E1000_READ_REG
argument_list|(
name|Tctl
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"TctlReg = %x\n"
argument_list|,
name|TctlReg
argument_list|)
expr_stmt|;
name|DeviceCtrlReg
operator|=
name|E1000_READ_REG
argument_list|(
name|Ctrl
argument_list|)
expr_stmt|;
name|DeviceCtrlReg
operator||=
operator|(
name|E1000_CTRL_FRCSPD
operator||
name|E1000_CTRL_FRCDPX
operator|)
expr_stmt|;
name|DeviceCtrlReg
operator|&=
operator|~
operator|(
name|DEVICE_SPEED_MASK
operator|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"MII Register Data = %x\r\n"
argument_list|,
name|MiiRegisterData
argument_list|)
expr_stmt|;
name|DeviceCtrlReg
operator|&=
operator|~
name|E1000_CTRL_ILOS
expr_stmt|;
if|if
condition|(
name|MiiRegisterData
operator|&
name|PXN_PSSR_DPLX
condition|)
block|{
name|DeviceCtrlReg
operator||=
name|E1000_CTRL_FD
expr_stmt|;
name|TctlReg
operator|&=
operator|~
name|E1000_TCTL_COLD
expr_stmt|;
name|Shift32
operator|=
name|E1000_FDX_COLLISION_DISTANCE
expr_stmt|;
name|Shift32
operator|<<=
name|E1000_COLD_SHIFT
expr_stmt|;
name|TctlReg
operator||=
name|Shift32
expr_stmt|;
block|}
else|else
block|{
name|DeviceCtrlReg
operator|&=
operator|~
name|E1000_CTRL_FD
expr_stmt|;
if|if
condition|(
operator|(
name|MiiRegisterData
operator|&
name|PXN_PSSR_SPEED
operator|)
operator|==
name|PXN_PSSR_1000MBS
condition|)
block|{
name|TctlReg
operator|&=
operator|~
name|E1000_TCTL_COLD
expr_stmt|;
name|Shift32
operator|=
name|E1000_GB_HDX_COLLISION_DISTANCE
expr_stmt|;
name|Shift32
operator|<<=
name|E1000_COLD_SHIFT
expr_stmt|;
name|TctlReg
operator||=
name|Shift32
expr_stmt|;
name|TctlReg
operator||=
name|E1000_TCTL_PBE
expr_stmt|;
block|}
else|else
block|{
name|TctlReg
operator|&=
operator|~
name|E1000_TCTL_COLD
expr_stmt|;
name|Shift32
operator|=
name|E1000_HDX_COLLISION_DISTANCE
expr_stmt|;
name|Shift32
operator|<<=
name|E1000_COLD_SHIFT
expr_stmt|;
name|TctlReg
operator||=
name|Shift32
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|MiiRegisterData
operator|&
name|PXN_PSSR_SPEED
operator|)
operator|==
name|PXN_PSSR_1000MBS
condition|)
name|DeviceCtrlReg
operator||=
name|E1000_CTRL_SPD_1000
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|MiiRegisterData
operator|&
name|PXN_PSSR_SPEED
operator|)
operator|==
name|PXN_PSSR_100MBS
condition|)
name|DeviceCtrlReg
operator||=
name|E1000_CTRL_SPD_100
expr_stmt|;
else|else
name|DeviceCtrlReg
operator|&=
operator|~
operator|(
name|E1000_CTRL_SPD_1000
operator||
name|E1000_CTRL_SPD_100
operator|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Tctl
argument_list|,
name|TctlReg
argument_list|)
expr_stmt|;
name|E1000_WRITE_REG
argument_list|(
name|Ctrl
argument_list|,
name|DeviceCtrlReg
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|em_configure_collision_distance
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|TctlReg
decl_stmt|;
name|u16
name|Speed
decl_stmt|;
name|u16
name|Duplex
decl_stmt|;
name|u32
name|Shift32
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_configure_collision_distance"
argument_list|)
name|em_get_speed_and_duplex
argument_list|(
name|Adapter
argument_list|,
operator|&
name|Speed
argument_list|,
operator|&
name|Duplex
argument_list|)
expr_stmt|;
name|TctlReg
operator|=
name|E1000_READ_REG
argument_list|(
name|Tctl
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"TctlReg = %x\n"
argument_list|,
name|TctlReg
argument_list|)
expr_stmt|;
name|TctlReg
operator|&=
operator|~
name|E1000_TCTL_COLD
expr_stmt|;
if|if
condition|(
name|Duplex
operator|==
name|FULL_DUPLEX
condition|)
block|{
name|Shift32
operator|=
name|E1000_FDX_COLLISION_DISTANCE
expr_stmt|;
name|Shift32
operator|<<=
name|E1000_COLD_SHIFT
expr_stmt|;
name|TctlReg
operator||=
name|Shift32
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|Speed
operator|==
name|SPEED_1000
condition|)
block|{
name|Shift32
operator|=
name|E1000_GB_HDX_COLLISION_DISTANCE
expr_stmt|;
name|Shift32
operator|<<=
name|E1000_COLD_SHIFT
expr_stmt|;
name|TctlReg
operator||=
name|Shift32
expr_stmt|;
name|TctlReg
operator||=
name|E1000_TCTL_PBE
expr_stmt|;
block|}
else|else
block|{
name|Shift32
operator|=
name|E1000_HDX_COLLISION_DISTANCE
expr_stmt|;
name|Shift32
operator|<<=
name|E1000_COLD_SHIFT
expr_stmt|;
name|TctlReg
operator||=
name|Shift32
expr_stmt|;
block|}
block|}
name|E1000_WRITE_REG
argument_list|(
name|Tctl
argument_list|,
name|TctlReg
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|em_display_mii_contents
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|u8
name|PhyAddress
parameter_list|)
block|{
name|u16
name|Data
decl_stmt|,
name|PhyIDHi
decl_stmt|,
name|PhyIDLo
decl_stmt|;
name|u32
name|PhyID
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_display_mii_contents"
argument_list|)
name|DEBUGOUT1
argument_list|(
literal|"Adapter Base Address = %x\n"
argument_list|,
name|Adapter
operator|->
name|HardwareVirtualAddress
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_CTRL_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"MII Ctrl Reg contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"MII Status Reg contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|PhyIDHi
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_PHY_ID_REG1
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|PhyIDLo
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_PHY_ID_REG2
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhyID
operator|=
operator|(
name|PhyIDLo
operator||
operator|(
name|PhyIDHi
operator|<<
literal|16
operator|)
operator|)
operator|&
name|PHY_REVISION_MASK
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Phy ID = %x \n"
argument_list|,
name|PhyID
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_ADVERTISEMENT
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Reg 4 contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_LP_BPA
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Reg 5 contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_EXPANSION_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Reg 6 contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_NEXT_PAGE_TX
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Reg 7 contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_AUTONEG_LP_RX_NEXT_PAGE
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Reg 8 contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_1000T_CTRL_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Reg 9 contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_1000T_STATUS_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Reg A contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_IEEE_EXT_STATUS_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Reg F contents = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson Specific Control Reg (0x10) = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_STAT_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson Specific Status Reg (0x11) = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_INT_ENABLE_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson Interrupt Enable Reg (0x12) = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_INT_STATUS_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson Interrupt Status Reg (0x13) = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_EXT_PHY_SPEC_CTRL_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson Ext. Phy Specific Control (0x14) = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_RX_ERROR_COUNTER
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson Receive Error Counter (0x15) = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
name|Data
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_LED_CTRL_REG
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Paxson LED control reg (0x18) = %x\n"
argument_list|,
name|Data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u32
name|em_auto_detect_gigabit_phy
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u32
name|PhyAddress
init|=
literal|1
decl_stmt|;
name|u32
name|PhyIDHi
decl_stmt|;
name|u16
name|PhyIDLo
decl_stmt|;
name|u8
name|GotOne
init|=
literal|0
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_auto_detect_gigabit_phy"
argument_list|)
while|while
condition|(
operator|(
operator|!
name|GotOne
operator|)
operator|&&
operator|(
name|PhyAddress
operator|<=
name|MAX_PHY_REG_ADDRESS
operator|)
condition|)
block|{
name|PhyIDHi
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_PHY_ID_REG1
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|DelayInMicroseconds
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|PhyIDLo
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_PHY_ID_REG2
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|Adapter
operator|->
name|PhyId
operator|=
operator|(
name|PhyIDLo
operator||
operator|(
name|PhyIDHi
operator|<<
literal|16
operator|)
operator|)
operator|&
name|PHY_REVISION_MASK
expr_stmt|;
if|if
condition|(
name|Adapter
operator|->
name|PhyId
operator|==
name|PAXSON_PHY_88E1000
operator|||
name|Adapter
operator|->
name|PhyId
operator|==
name|PAXSON_PHY_88E1000S
operator|||
name|Adapter
operator|->
name|PhyId
operator|==
name|PAXSON_PHY_INTEGRATED
condition|)
block|{
name|DEBUGOUT2
argument_list|(
literal|"PhyId 0x%x detected at address 0x%x\n"
argument_list|,
name|Adapter
operator|->
name|PhyId
argument_list|,
name|PhyAddress
argument_list|)
expr_stmt|;
name|GotOne
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|PhyAddress
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|PhyAddress
operator|>
name|MAX_PHY_REG_ADDRESS
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Could not auto-detect Phy!\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PhyAddress
operator|)
return|;
block|}
end_function

begin_function
name|void
name|em_pxn_phy_reset_dsp
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
literal|29
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
literal|0x1d
argument_list|)
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
literal|30
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
literal|0xc1
argument_list|)
expr_stmt|;
name|em_write_phy_register
argument_list|(
name|Adapter
argument_list|,
literal|30
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u8
name|em_wait_for_auto_neg
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|)
block|{
name|u8
name|AutoNegComplete
init|=
literal|0
decl_stmt|;
name|u16
name|i
decl_stmt|;
name|u16
name|MiiStatusReg
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"em_wait_for_auto_neg"
argument_list|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Waiting for Auto-Neg to complete.\n"
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|PHY_AUTO_NEG_TIME
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|MiiStatusReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
if|if
condition|(
name|MiiStatusReg
operator|&
name|MII_SR_AUTONEG_COMPLETE
condition|)
block|{
name|AutoNegComplete
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|DelayInMilliseconds
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|AutoNegComplete
operator|)
return|;
block|}
end_function

begin_function
name|u8
name|em_phy_get_status_info
parameter_list|(
name|struct
name|adapter
modifier|*
name|Adapter
parameter_list|,
name|phy_status_info_struct
modifier|*
name|PhyStatusInfo
parameter_list|)
block|{
name|u16
name|PhyMIIStatReg
decl_stmt|;
name|u16
name|PhySpecCtrlReg
decl_stmt|;
name|u16
name|PhySpecStatReg
decl_stmt|;
name|u16
name|PhyExtSpecCtrlReg
decl_stmt|;
name|u16
name|Phy1000BTStatReg
decl_stmt|;
name|PhyStatusInfo
operator|->
name|CableLength
operator|=
name|PXN_PSSR_CABLE_LENGTH_UNDEFINED
expr_stmt|;
name|PhyStatusInfo
operator|->
name|Extended10BTDistance
operator|=
name|PXN_PSCR_10BT_EXT_DIST_ENABLE_UNDEFINED
expr_stmt|;
name|PhyStatusInfo
operator|->
name|CablePolarity
operator|=
name|PXN_PSSR_REV_POLARITY_UNDEFINED
expr_stmt|;
name|PhyStatusInfo
operator|->
name|PolarityCorrection
operator|=
name|PXN_PSCR_POLARITY_REVERSAL_UNDEFINED
expr_stmt|;
name|PhyStatusInfo
operator|->
name|LinkReset
operator|=
name|PXN_EPSCR_DOWN_NO_IDLE_UNDEFINED
expr_stmt|;
name|PhyStatusInfo
operator|->
name|MDIXMode
operator|=
name|PXN_PSCR_AUTO_X_MODE_UNDEFINED
expr_stmt|;
name|PhyStatusInfo
operator|->
name|LocalRx
operator|=
name|SR_1000T_RX_STATUS_UNDEFINED
expr_stmt|;
name|PhyStatusInfo
operator|->
name|RemoteRx
operator|=
name|SR_1000T_RX_STATUS_UNDEFINED
expr_stmt|;
if|if
condition|(
name|Adapter
operator|==
name|NULL
operator|||
name|Adapter
operator|->
name|MediaType
operator|!=
name|MEDIA_TYPE_COPPER
condition|)
return|return
literal|0
return|;
name|PhyMIIStatReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhyMIIStatReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_MII_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|PhyMIIStatReg
operator|&
name|MII_SR_LINK_STATUS
operator|)
operator|!=
name|MII_SR_LINK_STATUS
condition|)
return|return
literal|0
return|;
name|PhySpecCtrlReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhySpecStatReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_PHY_SPEC_STAT_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhyExtSpecCtrlReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PXN_EXT_PHY_SPEC_CTRL_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|Phy1000BTStatReg
operator|=
name|em_read_phy_register
argument_list|(
name|Adapter
argument_list|,
name|PHY_1000T_STATUS_REG
argument_list|,
name|Adapter
operator|->
name|PhyAddress
argument_list|)
expr_stmt|;
name|PhyStatusInfo
operator|->
name|CableLength
operator|=
call|(
name|PXN_PSSR_CABLE_LENGTH_ENUM
call|)
argument_list|(
operator|(
name|PhySpecStatReg
operator|&
name|PXN_PSSR_CABLE_LENGTH
operator|)
operator|>>
name|PXN_PSSR_CABLE_LENGTH_SHIFT
argument_list|)
expr_stmt|;
name|PhyStatusInfo
operator|->
name|Extended10BTDistance
operator|=
call|(
name|PXN_PSCR_10BT_EXT_DIST_ENABLE_ENUM
call|)
argument_list|(
name|PhySpecCtrlReg
operator|&
name|PXN_PSCR_10BT_EXT_DIST_ENABLE
argument_list|)
operator|>>
name|PXN_PSCR_10BT_EXT_DIST_ENABLE_SHIFT
expr_stmt|;
name|PhyStatusInfo
operator|->
name|CablePolarity
operator|=
call|(
name|PXN_PSSR_REV_POLARITY_ENUM
call|)
argument_list|(
name|PhySpecStatReg
operator|&
name|PXN_PSSR_REV_POLARITY
argument_list|)
operator|>>
name|PXN_PSSR_REV_POLARITY_SHIFT
expr_stmt|;
name|PhyStatusInfo
operator|->
name|PolarityCorrection
operator|=
call|(
name|PXN_PSCR_POLARITY_REVERSAL_ENUM
call|)
argument_list|(
name|PhySpecCtrlReg
operator|&
name|PXN_PSCR_POLARITY_REVERSAL
argument_list|)
operator|>>
name|PXN_PSCR_POLARITY_REVERSAL_SHIFT
expr_stmt|;
name|PhyStatusInfo
operator|->
name|LinkReset
operator|=
call|(
name|PXN_EPSCR_DOWN_NO_IDLE_ENUM
call|)
argument_list|(
name|PhyExtSpecCtrlReg
operator|&
name|PXN_EPSCR_DOWN_NO_IDLE
argument_list|)
operator|>>
name|PXN_EPSCR_DOWN_NO_IDLE_SHIFT
expr_stmt|;
name|PhyStatusInfo
operator|->
name|MDIXMode
operator|=
call|(
name|PXN_PSCR_AUTO_X_MODE_ENUM
call|)
argument_list|(
name|PhySpecCtrlReg
operator|&
name|PXN_PSCR_AUTO_X_MODE
argument_list|)
operator|>>
name|PXN_PSCR_AUTO_X_MODE_SHIFT
expr_stmt|;
name|PhyStatusInfo
operator|->
name|LocalRx
operator|=
call|(
name|SR_1000T_RX_STATUS_ENUM
call|)
argument_list|(
name|Phy1000BTStatReg
operator|&
name|SR_1000T_LOCAL_RX_STATUS
argument_list|)
operator|>>
name|SR_1000T_LOCAL_RX_STATUS_SHIFT
expr_stmt|;
name|PhyStatusInfo
operator|->
name|RemoteRx
operator|=
call|(
name|SR_1000T_RX_STATUS_ENUM
call|)
argument_list|(
name|Phy1000BTStatReg
operator|&
name|SR_1000T_REMOTE_RX_STATUS
argument_list|)
operator|>>
name|SR_1000T_REMOTE_RX_STATUS_SHIFT
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

end_unit


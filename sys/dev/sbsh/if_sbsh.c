begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Granch SBNI16 G.SHDSL Modem driver  * Written by Denis I. Timofeev, 2002-2003.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/priv.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/random.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/sbsh/if_sbshreg.h>
end_include

begin_comment
comment|/* -------------------------------------------------------------------------- */
end_comment

begin_struct
struct|struct
name|sbni16_hw_regs
block|{
name|u_int8_t
name|CR
decl_stmt|,
name|CRB
decl_stmt|,
name|SR
decl_stmt|,
name|IMR
decl_stmt|,
name|CTDR
decl_stmt|,
name|LTDR
decl_stmt|,
name|CRDR
decl_stmt|,
name|LRDR
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|hw_descr
block|{
name|u_int32_t
name|address
decl_stmt|;
name|u_int32_t
name|length
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cx28975_cmdarea
block|{
name|u_int8_t
name|intr_host
decl_stmt|;
name|u_int8_t
name|intr_8051
decl_stmt|;
name|u_int8_t
name|map_version
decl_stmt|;
name|u_int8_t
name|in_dest
decl_stmt|;
name|u_int8_t
name|in_opcode
decl_stmt|;
name|u_int8_t
name|in_zero
decl_stmt|;
name|u_int8_t
name|in_length
decl_stmt|;
name|u_int8_t
name|in_csum
decl_stmt|;
name|u_int8_t
name|in_data
index|[
literal|75
index|]
decl_stmt|;
name|u_int8_t
name|in_datasum
decl_stmt|;
name|u_int8_t
name|out_dest
decl_stmt|;
name|u_int8_t
name|out_opcode
decl_stmt|;
name|u_int8_t
name|out_ack
decl_stmt|;
name|u_int8_t
name|out_length
decl_stmt|;
name|u_int8_t
name|out_csum
decl_stmt|;
name|u_int8_t
name|out_data
index|[
literal|75
index|]
decl_stmt|;
name|u_int8_t
name|out_datasum
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|XQLEN
value|8
end_define

begin_define
define|#
directive|define
name|RQLEN
value|8
end_define

begin_struct
struct|struct
name|sbsh_softc
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|resource
modifier|*
name|mem_res
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq_res
decl_stmt|;
name|void
modifier|*
name|intr_hand
decl_stmt|;
name|void
modifier|*
name|mem_base
decl_stmt|;
comment|/* mapped memory address */
specifier|volatile
name|struct
name|sbni16_hw_regs
modifier|*
name|regs
decl_stmt|;
specifier|volatile
name|struct
name|hw_descr
modifier|*
name|tbd
decl_stmt|;
specifier|volatile
name|struct
name|hw_descr
modifier|*
name|rbd
decl_stmt|;
specifier|volatile
name|struct
name|cx28975_cmdarea
modifier|*
name|cmdp
decl_stmt|;
comment|/* SBNI16 controller statistics */
struct|struct
name|sbni16_stats
block|{
name|u_int32_t
name|sent_pkts
decl_stmt|,
name|rcvd_pkts
decl_stmt|;
name|u_int32_t
name|crc_errs
decl_stmt|,
name|ufl_errs
decl_stmt|,
name|ofl_errs
decl_stmt|,
name|attempts
decl_stmt|,
name|last_time
decl_stmt|;
block|}
name|in_stats
struct|;
comment|/* transmit and reception queues */
name|struct
name|mbuf
modifier|*
name|xq
index|[
name|XQLEN
index|]
decl_stmt|,
modifier|*
name|rq
index|[
name|RQLEN
index|]
decl_stmt|;
name|unsigned
name|head_xq
decl_stmt|,
name|tail_xq
decl_stmt|,
name|head_rq
decl_stmt|,
name|tail_rq
decl_stmt|;
comment|/* the descriptors mapped onto the first buffers in xq and rq */
name|unsigned
name|head_tdesc
decl_stmt|,
name|head_rdesc
decl_stmt|;
name|u_int8_t
name|state
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cx28975_cfg
block|{
name|u_int8_t
modifier|*
name|firmw_image
decl_stmt|;
name|u_int32_t
name|firmw_len
decl_stmt|;
name|u_int32_t
name|lrate
range|:
literal|10
decl_stmt|;
name|u_int32_t
name|master
range|:
literal|1
decl_stmt|;
name|u_int32_t
name|mod
range|:
literal|2
decl_stmt|;
name|u_int32_t
name|crc16
range|:
literal|1
decl_stmt|;
name|u_int32_t
name|fill_7e
range|:
literal|1
decl_stmt|;
name|u_int32_t
name|inv
range|:
literal|1
decl_stmt|;
name|u_int32_t
name|rburst
range|:
literal|1
decl_stmt|;
name|u_int32_t
name|wburst
range|:
literal|1
decl_stmt|;
name|u_int32_t
label|:
literal|14
expr_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* SHDSL transceiver statistics */
end_comment

begin_struct
struct|struct
name|dsl_stats
block|{
name|u_int8_t
name|status_1
decl_stmt|,
name|status_3
decl_stmt|;
name|u_int8_t
name|attenuat
decl_stmt|,
name|nmr
decl_stmt|,
name|tpbo
decl_stmt|,
name|rpbo
decl_stmt|;
name|u_int16_t
name|losw
decl_stmt|,
name|segd
decl_stmt|,
name|crc
decl_stmt|,
name|sega
decl_stmt|,
name|losd
decl_stmt|;
block|}
struct|;
end_struct

begin_enum
enum|enum
name|State
block|{
name|NOT_LOADED
block|,
name|DOWN
block|,
name|ACTIVATION
block|,
name|ACTIVE
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|SIOCLOADFIRMW
value|_IOWR('i', 67, struct ifreq)
end_define

begin_define
define|#
directive|define
name|SIOCGETSTATS
value|_IOWR('i', 68, struct ifreq)
end_define

begin_define
define|#
directive|define
name|SIOCCLRSTATS
value|_IOWR('i', 69, struct ifreq)
end_define

begin_function_decl
specifier|static
name|int
name|sbsh_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sbsh_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sbsh_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sbsh_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sbsh_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sbsh_suspend
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sbsh_resume
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sbsh_watchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sbsh_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sbsh_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sbsh_stop
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|init_card
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sbsh_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|resume_tx
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|start_xmit_frames
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|encap_frame
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|mbuf
modifier|*
name|repack
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|free_sent_buffers
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|alloc_rx_buffers
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|indicate_frames
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|drop_queues
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|activate
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|deactivate
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cx28975_interrupt
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|start_cx28975
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|,
name|struct
name|cx28975_cfg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|download_firmware
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|,
name|u_int8_t
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|issue_cx28975_cmd
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int8_t
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|sbsh_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|sbsh_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|sbsh_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|sbsh_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|sbsh_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|sbsh_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|sbsh_resume
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|sbsh_driver
init|=
block|{
literal|"sbsh"
block|,
name|sbsh_methods
block|,
expr|sizeof
operator|(
expr|struct
name|sbsh_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|sbsh_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|sbsh
argument_list|,
name|pci
argument_list|,
name|sbsh_driver
argument_list|,
name|sbsh_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|sbsh
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|sbsh_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|!=
name|SBNI16_VENDOR
operator|||
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|!=
name|SBNI16_DEVICE
operator|||
name|pci_get_subdevice
argument_list|(
name|dev
argument_list|)
operator|!=
name|SBNI16_SUBDEV
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Granch SBNI16 G.SHDSL Modem"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sbsh_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sbsh_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|unit
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|,
name|rid
decl_stmt|,
name|s
decl_stmt|;
name|u_char
name|eaddr
index|[
literal|6
index|]
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|unit
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mem_res
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|4096
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"sbsh%d: couldn't map memory\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_res
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"sbsh%d: couldn't map interrupt\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|PCIR_BAR
argument_list|(
literal|1
argument_list|)
argument_list|,
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|mem_base
operator|=
name|rman_get_virtual
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
name|init_card
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|INTR_TYPE_NET
argument_list|,
name|NULL
argument_list|,
name|sbsh_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|intr_hand
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|PCIR_BAR
argument_list|(
literal|1
argument_list|)
argument_list|,
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"sbsh%d: couldn't set up irq\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* generate ethernet MAC address */
operator|*
operator|(
name|u_int32_t
operator|*
operator|)
name|eaddr
operator|=
name|htonl
argument_list|(
literal|0x00ff0192
argument_list|)
expr_stmt|;
name|read_random
argument_list|(
name|eaddr
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|PCIR_BAR
argument_list|(
literal|1
argument_list|)
argument_list|,
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|sc
operator|->
name|intr_hand
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"sbsh%d: can not if_alloc()\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
operator||
name|IFF_NEEDSGIANT
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|sbsh_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|sbsh_start
expr_stmt|;
name|ifp
operator|->
name|if_watchdog
operator|=
name|sbsh_watchdog
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|sbsh_init
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
literal|4600000
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|IFQ_MAXLEN
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|eaddr
argument_list|)
expr_stmt|;
name|fail
label|:
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sbsh_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sbsh_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|sbsh_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|sc
operator|->
name|intr_hand
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|PCIR_BAR
argument_list|(
literal|1
argument_list|)
argument_list|,
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbsh_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|sbsh_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|state
operator|!=
name|ACTIVE
condition|)
return|return;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|start_xmit_frames
argument_list|(
name|ifp
operator|->
name|if_softc
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbsh_init
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|sbsh_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|int
name|s
decl_stmt|;
name|u_int8_t
name|t
decl_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|||
name|sc
operator|->
name|state
operator|==
name|NOT_LOADED
condition|)
return|return;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sc
operator|->
name|in_stats
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sbni16_stats
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|head_xq
operator|=
name|sc
operator|->
name|tail_xq
operator|=
name|sc
operator|->
name|head_rq
operator|=
name|sc
operator|->
name|tail_rq
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|head_tdesc
operator|=
name|sc
operator|->
name|head_rdesc
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|IMR
operator|=
name|EXT
expr_stmt|;
name|t
operator|=
literal|2
expr_stmt|;
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_CLEAR_ERROR_CTRS
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_ACTIVATION
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|state
operator|=
name|ACTIVATION
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbsh_stop
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|u_int8_t
name|t
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|IMR
operator|=
name|EXT
expr_stmt|;
name|t
operator|=
literal|0
expr_stmt|;
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_ACTIVATION
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|state
operator|==
name|ACTIVE
condition|)
block|{
name|t
operator|=
literal|1
expr_stmt|;
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_FORCE_DEACTIVATE
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* FIX! activation manager state */
comment|/* Is it really must be done here? It calls from intr handler */
name|deactivate
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|regs
operator|->
name|IMR
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|state
operator|=
name|DOWN
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|init_card
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|state
operator|=
name|NOT_LOADED
expr_stmt|;
name|sc
operator|->
name|tbd
operator|=
operator|(
expr|struct
name|hw_descr
operator|*
operator|)
name|sc
operator|->
name|mem_base
expr_stmt|;
name|sc
operator|->
name|rbd
operator|=
operator|(
expr|struct
name|hw_descr
operator|*
operator|)
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|sc
operator|->
name|mem_base
operator|+
literal|0x400
operator|)
expr_stmt|;
name|sc
operator|->
name|regs
operator|=
operator|(
expr|struct
name|sbni16_hw_regs
operator|*
operator|)
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|sc
operator|->
name|mem_base
operator|+
literal|0x800
operator|)
expr_stmt|;
name|sc
operator|->
name|cmdp
operator|=
operator|(
expr|struct
name|cx28975_cmdarea
operator|*
operator|)
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|sc
operator|->
name|mem_base
operator|+
literal|0xc00
operator|)
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CR
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|SR
operator|=
literal|0xff
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|IMR
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sbsh_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|sbsh_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|cx28975_cfg
name|cfg
decl_stmt|;
name|struct
name|dsl_stats
name|ds
decl_stmt|;
name|int
name|s
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|t
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCLOADFIRMW
case|:
if|if
condition|(
operator|(
name|error
operator|=
name|priv_check
argument_list|(
name|curthread
argument_list|,
name|PRIV_DRIVER
argument_list|)
operator|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
name|error
operator|=
name|EBUSY
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|cfg
argument_list|,
sizeof|sizeof
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|start_cx28975
argument_list|(
name|sc
argument_list|,
name|cfg
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|static
name|char
modifier|*
name|modstr
index|[]
init|=
block|{
literal|"TCPAM32"
block|,
literal|"TCPAM16"
block|,
literal|"TCPAM8"
block|,
literal|"TCPAM4"
block|}
decl_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"%s, rate %d, %s\n"
argument_list|,
name|cfg
operator|.
name|master
condition|?
literal|"master"
else|:
literal|"slave"
argument_list|,
name|cfg
operator|.
name|lrate
operator|<<
literal|3
argument_list|,
name|modstr
index|[
name|cfg
operator|.
name|mod
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"unable to load firmware\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
block|}
break|break;
case|case
name|SIOCGETSTATS
case|:
if|if
condition|(
operator|(
name|error
operator|=
name|priv_check
argument_list|(
name|curthread
argument_list|,
name|PRIV_DRIVER
argument_list|)
operator|)
operator|!=
literal|0
condition|)
break|break;
name|t
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_FAR_END_ATTEN
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
condition|)
name|error
operator|=
name|EIO
expr_stmt|;
name|ds
operator|.
name|attenuat
operator|=
name|sc
operator|->
name|cmdp
operator|->
name|out_data
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_NOISE_MARGIN
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
condition|)
name|error
operator|=
name|EIO
expr_stmt|;
name|ds
operator|.
name|nmr
operator|=
name|sc
operator|->
name|cmdp
operator|->
name|out_data
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_POWER_BACK_OFF_RESULT
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
condition|)
name|error
operator|=
name|EIO
expr_stmt|;
name|ds
operator|.
name|tpbo
operator|=
name|sc
operator|->
name|cmdp
operator|->
name|out_data
index|[
literal|0
index|]
expr_stmt|;
name|ds
operator|.
name|rpbo
operator|=
name|sc
operator|->
name|cmdp
operator|->
name|out_data
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_HDSL_PERF_ERR_CTRS
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
operator|++
name|i
control|)
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|ds
operator|.
name|losw
operator|)
index|[
name|i
index|]
operator|=
name|sc
operator|->
name|cmdp
operator|->
name|out_data
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EIO
expr_stmt|;
name|ds
operator|.
name|status_1
operator|=
operator|(
operator|(
specifier|volatile
name|u_int8_t
operator|*
operator|)
name|sc
operator|->
name|cmdp
operator|)
index|[
literal|0x3c0
index|]
expr_stmt|;
name|ds
operator|.
name|status_3
operator|=
operator|(
operator|(
specifier|volatile
name|u_int8_t
operator|*
operator|)
name|sc
operator|->
name|cmdp
operator|)
index|[
literal|0x3c2
index|]
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|sc
operator|->
name|in_stats
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sbni16_stats
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|ds
argument_list|,
name|ifr
operator|->
name|ifr_data
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sbni16_stats
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|dsl_stats
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCCLRSTATS
case|:
if|if
condition|(
operator|!
operator|(
name|error
operator|=
name|priv_check
argument_list|(
name|curthread
argument_list|,
name|PRIV_DRIVER
argument_list|)
operator|)
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|sc
operator|->
name|in_stats
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sbni16_stats
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_CLEAR_ERROR_CTRS
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
condition|)
name|error
operator|=
name|EIO
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|state
operator|==
name|NOT_LOADED
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"firmware wasn't loaded\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EBUSY
expr_stmt|;
block|}
else|else
name|sbsh_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|sbsh_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
block|}
block|}
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
name|error
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbsh_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sbsh_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|sbsh_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sbsh_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sbsh_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|sbsh_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sbsh_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sbsh_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
name|sbsh_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbsh_watchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|sbsh_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"transmit timeout\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|regs
operator|->
name|SR
operator|&
name|TXS
condition|)
block|{
name|sc
operator|->
name|regs
operator|->
name|SR
operator|=
name|TXS
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"interrupt posted but not delivered\n"
argument_list|)
expr_stmt|;
block|}
name|free_sent_buffers
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|void
name|sbsh_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|sbsh_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sbsh_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|u_int8_t
name|status
init|=
name|sc
operator|->
name|regs
operator|->
name|SR
decl_stmt|;
if|if
condition|(
name|status
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|status
operator|&
name|EXT
condition|)
block|{
name|cx28975_interrupt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|SR
operator|=
name|EXT
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|UFL
condition|)
block|{
name|resume_tx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|SR
operator|=
name|UFL
expr_stmt|;
operator|++
name|sc
operator|->
name|in_stats
operator|.
name|ufl_errs
expr_stmt|;
operator|++
name|sc
operator|->
name|ifp
operator|->
name|if_oerrors
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|RXS
condition|)
block|{
name|sc
operator|->
name|regs
operator|->
name|SR
operator|=
name|RXS
expr_stmt|;
name|indicate_frames
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|alloc_rx_buffers
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|TXS
condition|)
block|{
name|sc
operator|->
name|regs
operator|->
name|SR
operator|=
name|TXS
expr_stmt|;
name|free_sent_buffers
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|CRC
condition|)
block|{
operator|++
name|sc
operator|->
name|in_stats
operator|.
name|crc_errs
expr_stmt|;
operator|++
name|sc
operator|->
name|ifp
operator|->
name|if_ierrors
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|SR
operator|=
name|CRC
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|OFL
condition|)
block|{
operator|++
name|sc
operator|->
name|in_stats
operator|.
name|ofl_errs
expr_stmt|;
operator|++
name|sc
operator|->
name|ifp
operator|->
name|if_ierrors
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|SR
operator|=
name|OFL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Look for a first descriptor of a next packet, and write it's number  * into CTDR. Then enable the transmitter.  */
end_comment

begin_function
specifier|static
name|void
name|resume_tx
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
name|u_int32_t
name|cur_tbd
init|=
name|sc
operator|->
name|regs
operator|->
name|CTDR
decl_stmt|;
while|while
condition|(
name|cur_tbd
operator|!=
name|sc
operator|->
name|regs
operator|->
name|LTDR
operator|&&
operator|(
name|sc
operator|->
name|tbd
index|[
name|cur_tbd
operator|++
index|]
operator|.
name|length
operator|&
name|LAST_FRAG
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CTDR
operator|=
name|cur_tbd
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CR
operator||=
name|TXEN
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|start_xmit_frames
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
comment|/* 	 * Check if we have any free descriptor(s) and free space in 	 * our transmit queue. 	 */
while|while
condition|(
name|sc
operator|->
name|tail_xq
operator|!=
operator|(
operator|(
name|sc
operator|->
name|head_xq
operator|-
literal|1
operator|)
operator|&
operator|(
name|XQLEN
operator|-
literal|1
operator|)
operator|)
operator|&&
name|sc
operator|->
name|regs
operator|->
name|LTDR
operator|!=
operator|(
operator|(
name|sc
operator|->
name|head_tdesc
operator|-
literal|1
operator|)
operator|&
literal|0x7f
operator|)
condition|)
block|{
name|IF_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
break|break;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
condition|)
block|{
name|BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|encap_frame
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
else|else
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|regs
operator|->
name|CTDR
operator|!=
name|sc
operator|->
name|regs
operator|->
name|LTDR
condition|)
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
else|else
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * MUST be called at splimp  */
end_comment

begin_function
specifier|static
name|void
name|encap_frame
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m_head
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|u_int32_t
name|cur_tbd
decl_stmt|;
name|int
name|done
decl_stmt|;
name|look_for_nonzero
label|:
for|for
control|(
name|m
operator|=
name|m_head
init|;
operator|!
name|m
operator|->
name|m_len
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
empty_stmt|;
name|cur_tbd
operator|=
name|sc
operator|->
name|regs
operator|->
name|LTDR
operator|&
literal|0x7f
expr_stmt|;
name|done
operator|=
literal|0
expr_stmt|;
do|do
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
literal|5
operator|||
name|cur_tbd
operator|==
operator|(
operator|(
name|sc
operator|->
name|head_tdesc
operator|-
literal|1
operator|)
operator|&
literal|0x7f
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|m_head
operator|=
name|repack
argument_list|(
name|sc
argument_list|,
name|m_head
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
goto|goto
name|look_for_nonzero
goto|;
else|else
return|return;
block|}
name|sc
operator|->
name|tbd
index|[
name|cur_tbd
index|]
operator|.
name|address
operator|=
name|vtophys
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tbd
index|[
name|cur_tbd
index|]
operator|.
name|length
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
do|do
block|{
name|m
operator|=
name|m
operator|->
name|m_next
expr_stmt|;
block|}
do|while
condition|(
name|m
operator|&&
operator|!
name|m
operator|->
name|m_len
condition|)
do|;
if|if
condition|(
operator|!
name|m
condition|)
block|{
comment|/* last fragment has been reached */
name|sc
operator|->
name|tbd
index|[
name|cur_tbd
index|]
operator|.
name|length
operator||=
name|LAST_FRAG
expr_stmt|;
name|done
operator|=
literal|1
expr_stmt|;
block|}
operator|++
name|cur_tbd
expr_stmt|;
name|cur_tbd
operator|&=
literal|0x7f
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|done
condition|)
do|;
name|sc
operator|->
name|xq
index|[
name|sc
operator|->
name|tail_xq
operator|++
index|]
operator|=
name|m_head
expr_stmt|;
name|sc
operator|->
name|tail_xq
operator|&=
operator|(
name|XQLEN
operator|-
literal|1
operator|)
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|LTDR
operator|=
name|cur_tbd
expr_stmt|;
operator|++
name|sc
operator|->
name|in_stats
operator|.
name|sent_pkts
expr_stmt|;
operator|++
name|sc
operator|->
name|ifp
operator|->
name|if_opackets
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|repack
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m_new
decl_stmt|;
name|MGETHDR
argument_list|(
name|m_new
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m_new
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"unable to get mbuf.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|MHLEN
condition|)
block|{
name|MCLGET
argument_list|(
name|m_new
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|m_new
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|m_new
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"unable to get mbuf cluster.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|mtod
argument_list|(
name|m_new
argument_list|,
name|caddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|m_new
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m_new
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|m_new
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_sent_buffers
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
name|u_int32_t
name|cur_tbd
decl_stmt|;
name|cur_tbd
operator|=
name|sc
operator|->
name|regs
operator|->
name|CTDR
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|head_tdesc
operator|!=
name|cur_tbd
condition|)
block|{
comment|/* 		 * Be careful! one element in xq may correspond to 		 * multiple descriptors. 		 */
if|if
condition|(
name|sc
operator|->
name|tbd
index|[
name|sc
operator|->
name|head_tdesc
index|]
operator|.
name|length
operator|&
name|LAST_FRAG
condition|)
block|{
name|m_freem
argument_list|(
name|sc
operator|->
name|xq
index|[
name|sc
operator|->
name|head_xq
operator|++
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|head_xq
operator|&=
operator|(
name|XQLEN
operator|-
literal|1
operator|)
expr_stmt|;
block|}
name|sc
operator|->
name|tbd
index|[
name|sc
operator|->
name|head_tdesc
index|]
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|head_tdesc
operator|=
operator|(
name|sc
operator|->
name|head_tdesc
operator|+
literal|1
operator|)
operator|&
literal|0x7f
expr_stmt|;
block|}
name|start_xmit_frames
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * DON'T use free_sent_buffers to drop the queue!  */
end_comment

begin_function
specifier|static
name|void
name|alloc_rx_buffers
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
name|unsigned
name|cur_rbd
init|=
name|sc
operator|->
name|regs
operator|->
name|LRDR
operator|&
literal|0x7f
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
while|while
condition|(
name|sc
operator|->
name|tail_rq
operator|!=
operator|(
operator|(
name|sc
operator|->
name|head_rq
operator|-
literal|1
operator|)
operator|&
operator|(
name|RQLEN
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"unable to get mbuf.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|SBNI16_MAX_FRAME
operator|>
name|MHLEN
condition|)
block|{
name|MCLGET
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"unable to get mbuf cluster.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|MCLBYTES
expr_stmt|;
block|}
name|m_adj
argument_list|(
name|m
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* align ip on longword boundaries */
name|sc
operator|->
name|rq
index|[
name|sc
operator|->
name|tail_rq
operator|++
index|]
operator|=
name|m
expr_stmt|;
name|sc
operator|->
name|tail_rq
operator|&=
operator|(
name|RQLEN
operator|-
literal|1
operator|)
expr_stmt|;
name|sc
operator|->
name|rbd
index|[
name|cur_rbd
index|]
operator|.
name|address
operator|=
name|vtophys
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rbd
index|[
name|cur_rbd
index|]
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|LRDR
operator|=
name|cur_rbd
operator|=
operator|(
name|cur_rbd
operator|+
literal|1
operator|)
operator|&
literal|0x7f
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|indicate_frames
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
name|unsigned
name|cur_rbd
init|=
name|sc
operator|->
name|regs
operator|->
name|CRDR
operator|&
literal|0x7f
decl_stmt|;
while|while
condition|(
name|sc
operator|->
name|head_rdesc
operator|!=
name|cur_rbd
condition|)
block|{
name|struct
name|mbuf
modifier|*
name|m
init|=
name|sc
operator|->
name|rq
index|[
name|sc
operator|->
name|head_rq
operator|++
index|]
decl_stmt|;
name|sc
operator|->
name|head_rq
operator|&=
operator|(
name|RQLEN
operator|-
literal|1
operator|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|sc
operator|->
name|rbd
index|[
name|sc
operator|->
name|head_rdesc
index|]
operator|.
name|length
operator|&
literal|0x7ff
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
call|(
modifier|*
name|sc
operator|->
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
operator|++
name|sc
operator|->
name|in_stats
operator|.
name|rcvd_pkts
expr_stmt|;
operator|++
name|sc
operator|->
name|ifp
operator|->
name|if_ipackets
expr_stmt|;
name|sc
operator|->
name|head_rdesc
operator|=
operator|(
name|sc
operator|->
name|head_rdesc
operator|+
literal|1
operator|)
operator|&
literal|0x7f
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|drop_queues
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
while|while
condition|(
name|sc
operator|->
name|head_rq
operator|!=
name|sc
operator|->
name|tail_rq
condition|)
block|{
name|m_freem
argument_list|(
name|sc
operator|->
name|rq
index|[
name|sc
operator|->
name|head_rq
operator|++
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|head_rq
operator|&=
operator|(
name|RQLEN
operator|-
literal|1
operator|)
expr_stmt|;
block|}
while|while
condition|(
name|sc
operator|->
name|head_xq
operator|!=
name|sc
operator|->
name|tail_xq
condition|)
block|{
name|m_freem
argument_list|(
name|sc
operator|->
name|xq
index|[
name|sc
operator|->
name|head_xq
operator|++
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|head_xq
operator|&=
operator|(
name|XQLEN
operator|-
literal|1
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|void
name|activate
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|sc
operator|->
name|regs
operator|->
name|SR
operator|=
literal|0xff
expr_stmt|;
comment|/* clear it! */
name|sc
operator|->
name|regs
operator|->
name|CTDR
operator|=
name|sc
operator|->
name|regs
operator|->
name|LTDR
operator|=
name|sc
operator|->
name|regs
operator|->
name|CRDR
operator|=
name|sc
operator|->
name|regs
operator|->
name|LRDR
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|head_tdesc
operator|=
name|sc
operator|->
name|head_rdesc
operator|=
literal|0
expr_stmt|;
name|alloc_rx_buffers
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CRB
operator|&=
operator|~
name|RXDE
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|IMR
operator|=
name|EXT
operator||
name|RXS
operator||
name|TXS
operator||
name|CRC
operator||
name|OFL
operator||
name|UFL
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CR
operator||=
name|TXEN
operator||
name|RXEN
expr_stmt|;
name|sc
operator|->
name|state
operator|=
name|ACTIVE
expr_stmt|;
operator|++
name|sc
operator|->
name|in_stats
operator|.
name|attempts
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|sc
operator|->
name|in_stats
operator|.
name|last_time
operator|=
name|tv
operator|.
name|tv_sec
expr_stmt|;
name|start_xmit_frames
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|deactivate
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|regs
operator|->
name|CR
operator|&=
operator|~
operator|(
name|RXEN
operator||
name|TXEN
operator|)
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CRB
operator||=
name|RXDE
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|IMR
operator|=
name|EXT
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CTDR
operator|=
name|sc
operator|->
name|regs
operator|->
name|LTDR
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CRDR
operator|=
name|sc
operator|->
name|regs
operator|->
name|LRDR
expr_stmt|;
name|sc
operator|->
name|state
operator|=
name|ACTIVATION
expr_stmt|;
name|drop_queues
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|void
name|cx28975_interrupt
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|volatile
name|struct
name|cx28975_cmdarea
modifier|*
name|p
init|=
name|sc
operator|->
name|cmdp
decl_stmt|;
name|u_int8_t
name|t
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|intr_host
operator|!=
literal|0xfe
condition|)
return|return;
if|if
condition|(
name|p
operator|->
name|out_ack
operator|&
literal|0x80
condition|)
block|{
if|if
condition|(
operator|*
operator|(
operator|(
specifier|volatile
name|u_int8_t
operator|*
operator|)
name|p
operator|+
literal|0x3c7
operator|)
operator|&
literal|2
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|state
operator|!=
name|ACTIVE
operator|&&
operator|(
operator|*
operator|(
operator|(
specifier|volatile
name|u_int8_t
operator|*
operator|)
name|p
operator|+
literal|0x3c0
operator|)
operator|&
literal|0xc0
operator|)
operator|==
literal|0x40
condition|)
block|{
name|activate
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"connected to peer\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|state
operator|==
name|ACTIVE
operator|&&
operator|(
operator|*
operator|(
operator|(
specifier|volatile
name|u_int8_t
operator|*
operator|)
name|p
operator|+
literal|0x3c0
operator|)
operator|&
literal|0xc0
operator|)
operator|!=
literal|0x40
condition|)
block|{
name|deactivate
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"carrier lost\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|p
operator|->
name|intr_host
operator|=
literal|0
expr_stmt|;
name|t
operator|=
name|p
operator|->
name|intr_host
expr_stmt|;
name|p
operator|->
name|out_ack
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|p
operator|->
name|intr_host
operator|=
literal|0
expr_stmt|;
name|t
operator|=
name|p
operator|->
name|intr_host
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|int
name|start_cx28975
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|cx28975_cfg
name|cfg
parameter_list|)
block|{
specifier|static
name|char
name|thresh
index|[]
init|=
block|{
operator|+
literal|8
block|,
operator|-
literal|4
block|,
operator|-
literal|16
block|,
operator|-
literal|40
block|}
decl_stmt|;
specifier|volatile
name|struct
name|cx28975_cmdarea
modifier|*
name|p
init|=
name|sc
operator|->
name|cmdp
decl_stmt|;
name|u_int8_t
name|t
decl_stmt|,
name|parm
index|[
literal|12
index|]
decl_stmt|;
name|p
operator|->
name|intr_host
operator|=
literal|0
expr_stmt|;
name|t
operator|=
name|p
operator|->
name|intr_host
expr_stmt|;
comment|/* reset chip set */
name|sc
operator|->
name|regs
operator|->
name|IMR
operator|=
name|EXT
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CR
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|SR
operator|=
literal|0xff
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CR
operator|=
name|XRST
expr_stmt|;
if|if
condition|(
name|cfg
operator|.
name|crc16
condition|)
name|sc
operator|->
name|regs
operator|->
name|CR
operator||=
name|CMOD
expr_stmt|;
if|if
condition|(
name|cfg
operator|.
name|fill_7e
condition|)
name|sc
operator|->
name|regs
operator|->
name|CR
operator||=
name|FMOD
expr_stmt|;
if|if
condition|(
name|cfg
operator|.
name|inv
condition|)
name|sc
operator|->
name|regs
operator|->
name|CR
operator||=
name|PMOD
expr_stmt|;
name|sc
operator|->
name|regs
operator|->
name|CRB
operator||=
name|RODD
operator||
name|RXDE
expr_stmt|;
if|if
condition|(
name|cfg
operator|.
name|rburst
condition|)
name|sc
operator|->
name|regs
operator|->
name|CRB
operator||=
name|RDBE
expr_stmt|;
if|if
condition|(
name|cfg
operator|.
name|wburst
condition|)
name|sc
operator|->
name|regs
operator|->
name|CRB
operator||=
name|WTBE
expr_stmt|;
name|tsleep
argument_list|(
name|sc
argument_list|,
name|PWAIT
argument_list|,
literal|"sbsh"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|out_ack
operator|&
literal|0x1f
operator|)
operator|!=
name|_ACK_BOOT_WAKE_UP
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|download_firmware
argument_list|(
name|sc
argument_list|,
name|cfg
operator|.
name|firmw_image
argument_list|,
name|cfg
operator|.
name|firmw_len
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|tsleep
argument_list|(
name|sc
argument_list|,
name|PWAIT
argument_list|,
literal|"sbsh"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|out_ack
operator|&
literal|0x1f
operator|)
operator|!=
name|_ACK_OPER_WAKE_UP
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|t
operator|=
name|cfg
operator|.
name|master
condition|?
literal|1
else|:
literal|9
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_SYSTEM_ENABLE
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|t
operator|=
literal|0x63
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_SYSTEM_CONFIG
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
name|parm
operator|=
name|cfg
operator|.
name|lrate
operator|>>
literal|3
expr_stmt|;
name|parm
index|[
literal|2
index|]
operator|=
name|parm
index|[
literal|3
index|]
operator|=
name|parm
index|[
literal|0
index|]
expr_stmt|;
name|parm
index|[
literal|5
index|]
operator|=
name|cfg
operator|.
name|lrate
operator|&
literal|7
expr_stmt|;
name|parm
index|[
literal|4
index|]
operator|=
name|parm
index|[
literal|7
index|]
operator|=
literal|1
expr_stmt|;
name|parm
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_MULTI_RATE_CONFIG
argument_list|,
name|parm
argument_list|,
literal|8
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|parm
index|[
literal|0
index|]
operator|=
literal|0x02
operator||
operator|(
name|cfg
operator|.
name|mod
operator|<<
literal|4
operator|)
expr_stmt|;
name|parm
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_TRAINING_MODE
argument_list|,
name|parm
argument_list|,
literal|2
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|bzero
argument_list|(
name|parm
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|parm
index|[
literal|0
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* pre-activation: G.hs */
name|parm
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* no remote configuration */
name|parm
index|[
literal|7
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* annex A (default) */
name|parm
index|[
literal|8
index|]
operator|=
literal|0xff
expr_stmt|;
comment|/* i-bit mask (all bits) */
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_PREACTIVATION_CFG
argument_list|,
name|parm
argument_list|,
literal|12
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|parm
index|[
literal|0
index|]
operator|=
literal|0x03
expr_stmt|;
comment|/* dying gasp time - 3 frames */
name|parm
index|[
literal|1
index|]
operator|=
name|thresh
index|[
name|cfg
operator|.
name|mod
index|]
expr_stmt|;
name|parm
index|[
literal|2
index|]
operator|=
literal|0xff
expr_stmt|;
comment|/* attenuation */
name|parm
index|[
literal|3
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* line probe NMR (+2 dB) */
name|parm
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|parm
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_THRESHOLDS
argument_list|,
name|parm
argument_list|,
literal|6
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|t
operator|=
name|cfg
operator|.
name|master
condition|?
literal|0x23
else|:
literal|0x21
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_FR_PCM_CONFIG
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|t
operator|=
literal|0x02
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_INTR_HOST_MASK
argument_list|,
operator|&
name|t
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|sc
operator|->
name|state
operator|=
name|DOWN
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|download_firmware
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|,
name|u_int8_t
modifier|*
name|img
parameter_list|,
name|u_int32_t
name|img_len
parameter_list|)
block|{
name|u_int32_t
name|t
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u_int8_t
name|cksum
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|img_len
condition|;
operator|++
name|i
control|)
name|cksum
operator|+=
name|img
index|[
name|i
index|]
expr_stmt|;
name|t
operator|=
name|img_len
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_DOWNLOAD_START
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|t
argument_list|,
literal|4
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|img_len
operator|>=
literal|75
condition|;
name|i
operator|+=
literal|75
operator|,
name|img_len
operator|-=
literal|75
control|)
block|{
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_DOWNLOAD_DATA
argument_list|,
name|img
operator|+
name|i
argument_list|,
literal|75
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|img_len
operator|&&
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_DOWNLOAD_DATA
argument_list|,
name|img
operator|+
name|i
argument_list|,
name|img_len
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|t
operator|=
operator|(
name|cksum
operator|^
literal|0xff
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|issue_cx28975_cmd
argument_list|(
name|sc
argument_list|,
name|_DSL_DOWNLOAD_END
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|t
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|issue_cx28975_cmd
parameter_list|(
name|struct
name|sbsh_softc
modifier|*
name|sc
parameter_list|,
name|u_int8_t
name|cmd
parameter_list|,
name|u_int8_t
modifier|*
name|data
parameter_list|,
name|u_int8_t
name|size
parameter_list|)
block|{
specifier|volatile
name|struct
name|cx28975_cmdarea
modifier|*
name|p
init|=
name|sc
operator|->
name|cmdp
decl_stmt|;
name|u_int8_t
modifier|*
name|databuf
init|=
name|p
operator|->
name|in_data
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u_int8_t
name|cksum
init|=
literal|0
decl_stmt|;
name|p
operator|->
name|in_dest
operator|=
literal|0xf0
expr_stmt|;
name|p
operator|->
name|in_opcode
operator|=
name|cmd
expr_stmt|;
name|p
operator|->
name|in_zero
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|in_length
operator|=
operator|--
name|size
expr_stmt|;
name|p
operator|->
name|in_csum
operator|=
literal|0xf0
operator|^
name|cmd
operator|^
name|size
operator|^
literal|0xaa
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|size
condition|;
operator|++
name|i
control|)
block|{
name|cksum
operator|^=
operator|*
name|data
expr_stmt|;
operator|*
name|databuf
operator|++
operator|=
operator|*
name|data
operator|++
expr_stmt|;
comment|/* only 1 byte per cycle! */
block|}
name|p
operator|->
name|in_datasum
operator|=
name|cksum
operator|^
literal|0xaa
expr_stmt|;
name|p
operator|->
name|out_ack
operator|=
name|_ACK_NOT_COMPLETE
expr_stmt|;
name|p
operator|->
name|intr_8051
operator|=
literal|0xfe
expr_stmt|;
if|if
condition|(
name|tsleep
argument_list|(
name|sc
argument_list|,
name|PWAIT
argument_list|,
literal|"sbsh"
argument_list|,
name|hz
operator|<<
literal|3
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
while|while
condition|(
name|p
operator|->
name|out_ack
operator|==
name|_ACK_NOT_COMPLETE
condition|)
empty_stmt|;
comment|/* FIXME ! */
if|if
condition|(
operator|(
name|p
operator|->
name|out_ack
operator|&
literal|0x1f
operator|)
operator|==
name|_ACK_PASS
condition|)
block|{
name|p
operator|->
name|out_ack
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|p
operator|->
name|out_ack
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2003  * 	Hidetoshi Shimokawa. All rights reserved.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *  *	This product includes software developed by Hidetoshi Shimokawa.  *  * 4. Neither the name of the author nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|500000
end_if

begin_include
include|#
directive|include
file|<sys/devicestat.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/firewire/firewire.h>
end_include

begin_include
include|#
directive|include
file|<dev/firewire/firewirereg.h>
end_include

begin_include
include|#
directive|include
file|<dev/firewire/iec13213.h>
end_include

begin_include
include|#
directive|include
file|<dev/firewire/sbp.h>
end_include

begin_include
include|#
directive|include
file|<dev/firewire/fwmem.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_ccb.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_debug.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_periph.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_define
define|#
directive|define
name|SBP_TARG_RECV_LEN
value|8
end_define

begin_define
define|#
directive|define
name|MAX_INITIATORS
value|8
end_define

begin_define
define|#
directive|define
name|MAX_LUN
value|63
end_define

begin_define
define|#
directive|define
name|MAX_LOGINS
value|63
end_define

begin_define
define|#
directive|define
name|MAX_NODES
value|63
end_define

begin_comment
comment|/*  * management/command block agent registers  *  * BASE 0xffff f001 0000 management port  * BASE 0xffff f001 0020 command port for login id 0  * BASE 0xffff f001 0040 command port for login id 1  *  */
end_comment

begin_define
define|#
directive|define
name|SBP_TARG_MGM
value|0x10000
end_define

begin_comment
comment|/* offset from 0xffff f000 000 */
end_comment

begin_define
define|#
directive|define
name|SBP_TARG_BIND_HI
value|0xffff
end_define

begin_define
define|#
directive|define
name|SBP_TARG_BIND_LO
parameter_list|(
name|l
parameter_list|)
value|(0xf0000000 + SBP_TARG_MGM + 0x20 * ((l) + 1))
end_define

begin_define
define|#
directive|define
name|SBP_TARG_BIND_START
value|(((u_int64_t)SBP_TARG_BIND_HI<< 32) | \ 				    SBP_TARG_BIND_LO(-1))
end_define

begin_define
define|#
directive|define
name|SBP_TARG_BIND_END
value|(((u_int64_t)SBP_TARG_BIND_HI<< 32) | \ 				    SBP_TARG_BIND_LO(MAX_LOGINS))
end_define

begin_define
define|#
directive|define
name|SBP_TARG_LOGIN_ID
parameter_list|(
name|lo
parameter_list|)
value|(((lo) - SBP_TARG_BIND_LO(0))/0x20)
end_define

begin_define
define|#
directive|define
name|FETCH_MGM
value|0
end_define

begin_define
define|#
directive|define
name|FETCH_CMD
value|1
end_define

begin_define
define|#
directive|define
name|FETCH_POINTER
value|2
end_define

begin_define
define|#
directive|define
name|F_LINK_ACTIVE
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|F_ATIO_STARVED
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|F_LOGIN
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|F_HOLD
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|F_FREEZED
value|(1<< 4)
end_define

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_SBP_TARG
argument_list|,
literal|"sbp_targ"
argument_list|,
literal|"SBP-II/FireWire target mode"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_debug
argument_list|,
name|OID_AUTO
argument_list|,
name|sbp_targ_debug
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|debug
argument_list|,
literal|0
argument_list|,
literal|"SBP target mode debug flag"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
struct|struct
name|sbp_targ_login
block|{
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
decl_stmt|;
name|struct
name|fw_device
modifier|*
name|fwdev
decl_stmt|;
name|struct
name|sbp_login_res
name|loginres
decl_stmt|;
name|uint16_t
name|fifo_hi
decl_stmt|;
name|uint16_t
name|last_hi
decl_stmt|;
name|uint32_t
name|fifo_lo
decl_stmt|;
name|uint32_t
name|last_lo
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|orb_info
argument_list|)
name|orbs
expr_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|sbp_targ_login
argument_list|)
name|link
expr_stmt|;
name|uint16_t
name|hold_sec
decl_stmt|;
name|uint16_t
name|id
decl_stmt|;
name|uint8_t
name|flags
decl_stmt|;
name|uint8_t
name|spd
decl_stmt|;
name|struct
name|callout
name|hold_callout
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sbp_targ_lstate
block|{
name|uint16_t
name|lun
decl_stmt|;
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|cam_path
modifier|*
name|path
decl_stmt|;
name|struct
name|ccb_hdr_slist
name|accept_tios
decl_stmt|;
name|struct
name|ccb_hdr_slist
name|immed_notifies
decl_stmt|;
name|struct
name|crom_chunk
name|model
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|sbp_targ_login
argument_list|)
name|logins
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sbp_targ_softc
block|{
name|struct
name|firewire_dev_comm
name|fd
decl_stmt|;
name|struct
name|cam_sim
modifier|*
name|sim
decl_stmt|;
name|struct
name|cam_path
modifier|*
name|path
decl_stmt|;
name|struct
name|fw_bind
name|fwb
decl_stmt|;
name|int
name|ndevs
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|struct
name|crom_chunk
name|unit
decl_stmt|;
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
index|[
name|MAX_LUN
index|]
decl_stmt|;
name|struct
name|sbp_targ_lstate
modifier|*
name|black_hole
decl_stmt|;
name|struct
name|sbp_targ_login
modifier|*
name|logins
index|[
name|MAX_LOGINS
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|corb4
block|{
if|#
directive|if
name|BYTE_ORDER
operator|==
name|BIG_ENDIAN
name|uint32_t
name|n
range|:
literal|1
decl_stmt|,
name|rq_fmt
range|:
literal|2
decl_stmt|,
range|:
literal|1
decl_stmt|,
name|dir
range|:
literal|1
decl_stmt|,
name|spd
range|:
literal|3
decl_stmt|,
name|max_payload
range|:
literal|4
decl_stmt|,
name|page_table_present
range|:
literal|1
decl_stmt|,
name|page_size
range|:
literal|3
decl_stmt|,
name|data_size
range|:
literal|16
decl_stmt|;
else|#
directive|else
name|uint32_t
name|data_size
range|:
literal|16
decl_stmt|,
name|page_size
range|:
literal|3
decl_stmt|,
name|page_table_present
range|:
literal|1
decl_stmt|,
name|max_payload
range|:
literal|4
decl_stmt|,
name|spd
range|:
literal|3
decl_stmt|,
name|dir
range|:
literal|1
decl_stmt|,
range|:
literal|1
decl_stmt|,
name|rq_fmt
range|:
literal|2
decl_stmt|,
name|n
range|:
literal|1
decl_stmt|;
endif|#
directive|endif
block|}
struct|;
end_struct

begin_struct
struct|struct
name|morb4
block|{
if|#
directive|if
name|BYTE_ORDER
operator|==
name|BIG_ENDIAN
name|uint32_t
name|n
range|:
literal|1
decl_stmt|,
name|rq_fmt
range|:
literal|2
decl_stmt|,
range|:
literal|9
decl_stmt|,
name|fun
range|:
literal|4
decl_stmt|,
name|id
range|:
literal|16
decl_stmt|;
else|#
directive|else
name|uint32_t
name|id
range|:
literal|16
decl_stmt|,
name|fun
range|:
literal|4
decl_stmt|,
range|:
literal|9
decl_stmt|,
name|rq_fmt
range|:
literal|2
decl_stmt|,
name|n
range|:
literal|1
decl_stmt|;
endif|#
directive|endif
block|}
struct|;
end_struct

begin_struct
struct|struct
name|orb_info
block|{
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|fw_device
modifier|*
name|fwdev
decl_stmt|;
name|struct
name|sbp_targ_login
modifier|*
name|login
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|struct
name|ccb_accept_tio
modifier|*
name|atio
decl_stmt|;
name|uint8_t
name|state
decl_stmt|;
define|#
directive|define
name|ORBI_STATUS_NONE
value|0
define|#
directive|define
name|ORBI_STATUS_FETCH
value|1
define|#
directive|define
name|ORBI_STATUS_ATIO
value|2
define|#
directive|define
name|ORBI_STATUS_CTIO
value|3
define|#
directive|define
name|ORBI_STATUS_STATUS
value|4
define|#
directive|define
name|ORBI_STATUS_POINTER
value|5
define|#
directive|define
name|ORBI_STATUS_ABORTED
value|7
name|uint8_t
name|refcount
decl_stmt|;
name|uint16_t
name|orb_hi
decl_stmt|;
name|uint32_t
name|orb_lo
decl_stmt|;
name|uint32_t
name|data_hi
decl_stmt|;
name|uint32_t
name|data_lo
decl_stmt|;
name|struct
name|corb4
name|orb4
decl_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|orb_info
argument_list|)
name|link
expr_stmt|;
name|uint32_t
name|orb
index|[
literal|8
index|]
decl_stmt|;
name|uint32_t
modifier|*
name|page_table
decl_stmt|;
name|struct
name|sbp_status
name|status
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|char
modifier|*
name|orb_fun_name
index|[]
init|=
block|{
name|ORB_FUN_NAMES
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|sbp_targ_recv
parameter_list|(
name|struct
name|fw_xfer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sbp_targ_fetch_orb
parameter_list|(
name|struct
name|sbp_targ_softc
modifier|*
parameter_list|,
name|struct
name|fw_device
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|,
name|struct
name|sbp_targ_login
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|sbp_targ_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|,
literal|"sbp_targ"
argument_list|,
name|device_get_unit
argument_list|(
name|parent
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sbp_targ_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_t
name|pa
decl_stmt|;
name|pa
operator|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_get_unit
argument_list|(
name|dev
argument_list|)
operator|!=
name|device_get_unit
argument_list|(
name|pa
argument_list|)
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"SBP-2/SCSI over FireWire target mode"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_dealloc_login
parameter_list|(
name|struct
name|sbp_targ_login
modifier|*
name|login
parameter_list|)
block|{
name|struct
name|orb_info
modifier|*
name|orbi
decl_stmt|,
modifier|*
name|next
decl_stmt|;
if|if
condition|(
name|login
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: login = NULL\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|orbi
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|login
operator|->
name|orbs
argument_list|)
init|;
name|orbi
operator|!=
name|NULL
condition|;
name|orbi
operator|=
name|next
control|)
block|{
name|next
operator|=
name|STAILQ_NEXT
argument_list|(
name|orbi
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|orbi
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
block|}
name|callout_stop
argument_list|(
operator|&
name|login
operator|->
name|hold_callout
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE
argument_list|(
operator|&
name|login
operator|->
name|lstate
operator|->
name|logins
argument_list|,
name|login
argument_list|,
name|sbp_targ_login
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|login
operator|->
name|lstate
operator|->
name|sc
operator|->
name|logins
index|[
name|login
operator|->
name|id
index|]
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|login
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_hold_expire
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|sbp_targ_login
modifier|*
name|login
decl_stmt|;
name|login
operator|=
operator|(
expr|struct
name|sbp_targ_login
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|login
operator|->
name|flags
operator|&
name|F_HOLD
condition|)
block|{
name|printf
argument_list|(
literal|"%s: login_id=%d expired\n"
argument_list|,
name|__func__
argument_list|,
name|login
operator|->
name|id
argument_list|)
expr_stmt|;
name|sbp_targ_dealloc_login
argument_list|(
name|login
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s: login_id=%d not hold\n"
argument_list|,
name|__func__
argument_list|,
name|login
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_post_busreset
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|crom_src
modifier|*
name|src
decl_stmt|;
name|struct
name|crom_chunk
modifier|*
name|root
decl_stmt|;
name|struct
name|crom_chunk
modifier|*
name|unit
decl_stmt|;
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
decl_stmt|;
name|struct
name|sbp_targ_login
modifier|*
name|login
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|sbp_targ_softc
operator|*
operator|)
name|arg
expr_stmt|;
name|src
operator|=
name|sc
operator|->
name|fd
operator|.
name|fc
operator|->
name|crom_src
expr_stmt|;
name|root
operator|=
name|sc
operator|->
name|fd
operator|.
name|fc
operator|->
name|crom_root
expr_stmt|;
name|unit
operator|=
operator|&
name|sc
operator|->
name|unit
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|flags
operator|&
name|F_FREEZED
operator|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|flags
operator||=
name|F_FREEZED
expr_stmt|;
name|xpt_freeze_simq
argument_list|(
name|sc
operator|->
name|sim
argument_list|,
comment|/*count*/
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s: already freezed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
name|unit
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|crom_chunk
argument_list|)
argument_list|)
expr_stmt|;
name|crom_add_chunk
argument_list|(
name|src
argument_list|,
name|root
argument_list|,
name|unit
argument_list|,
name|CROM_UDIR
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
name|unit
argument_list|,
name|CSRKEY_SPEC
argument_list|,
name|CSRVAL_ANSIT10
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
name|unit
argument_list|,
name|CSRKEY_VER
argument_list|,
name|CSRVAL_T10SBP2
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
name|unit
argument_list|,
name|CSRKEY_COM_SPEC
argument_list|,
name|CSRVAL_ANSIT10
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
name|unit
argument_list|,
name|CSRKEY_COM_SET
argument_list|,
name|CSRVAL_SCSI
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
name|unit
argument_list|,
name|CROM_MGM
argument_list|,
name|SBP_TARG_MGM
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
name|unit
argument_list|,
name|CSRKEY_UNIT_CH
argument_list|,
operator|(
literal|10
operator|<<
literal|8
operator|)
operator||
literal|8
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_LUN
condition|;
name|i
operator|++
control|)
block|{
name|lstate
operator|=
name|sc
operator|->
name|lstate
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|lstate
operator|==
name|NULL
condition|)
continue|continue;
name|crom_add_entry
argument_list|(
name|unit
argument_list|,
name|CSRKEY_FIRM_VER
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
name|unit
argument_list|,
name|CROM_LUN
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|crom_add_entry
argument_list|(
name|unit
argument_list|,
name|CSRKEY_MODEL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|crom_add_simple_text
argument_list|(
name|src
argument_list|,
name|unit
argument_list|,
operator|&
name|lstate
operator|->
name|model
argument_list|,
literal|"TargetMode"
argument_list|)
expr_stmt|;
block|}
comment|/* Process for reconnection hold time */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_LOGINS
condition|;
name|i
operator|++
control|)
block|{
name|login
operator|=
name|sc
operator|->
name|logins
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|login
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|login
operator|->
name|flags
operator|&
name|F_LOGIN
condition|)
block|{
name|login
operator|->
name|flags
operator||=
name|F_HOLD
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|login
operator|->
name|hold_callout
argument_list|,
name|hz
operator|*
name|login
operator|->
name|hold_sec
argument_list|,
name|sbp_targ_hold_expire
argument_list|,
operator|(
name|void
operator|*
operator|)
name|login
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_post_explore
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|sbp_targ_softc
operator|*
operator|)
name|arg
expr_stmt|;
name|sc
operator|->
name|flags
operator|&=
operator|~
name|F_FREEZED
expr_stmt|;
name|xpt_release_simq
argument_list|(
name|sc
operator|->
name|sim
argument_list|,
comment|/*run queue*/
name|TRUE
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|cam_status
name|sbp_targ_find_devs
parameter_list|(
name|struct
name|sbp_targ_softc
modifier|*
name|sc
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|struct
name|sbp_targ_lstate
modifier|*
modifier|*
name|lstate
parameter_list|,
name|int
name|notfound_failure
parameter_list|)
block|{
name|u_int
name|lun
decl_stmt|;
comment|/* XXX 0 is the only vaild target_id */
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|==
name|CAM_TARGET_WILDCARD
operator|&&
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
operator|==
name|CAM_LUN_WILDCARD
condition|)
block|{
operator|*
name|lstate
operator|=
name|sc
operator|->
name|black_hole
expr_stmt|;
return|return
operator|(
name|CAM_REQ_CMP
operator|)
return|;
block|}
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|!=
literal|0
condition|)
return|return
operator|(
name|CAM_TID_INVALID
operator|)
return|;
name|lun
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
expr_stmt|;
if|if
condition|(
name|lun
operator|>=
name|MAX_LUN
condition|)
return|return
operator|(
name|CAM_LUN_INVALID
operator|)
return|;
operator|*
name|lstate
operator|=
name|sc
operator|->
name|lstate
index|[
name|lun
index|]
expr_stmt|;
if|if
condition|(
name|notfound_failure
operator|!=
literal|0
operator|&&
operator|*
name|lstate
operator|==
name|NULL
condition|)
return|return
operator|(
name|CAM_PATH_INVALID
operator|)
return|;
return|return
operator|(
name|CAM_REQ_CMP
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_en_lun
parameter_list|(
name|struct
name|sbp_targ_softc
modifier|*
name|sc
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|ccb_en_lun
modifier|*
name|cel
init|=
operator|&
name|ccb
operator|->
name|cel
decl_stmt|;
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
decl_stmt|;
name|cam_status
name|status
decl_stmt|;
name|status
operator|=
name|sbp_targ_find_devs
argument_list|(
name|sc
argument_list|,
name|ccb
argument_list|,
operator|&
name|lstate
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|status
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cel
operator|->
name|enable
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|lstate
operator|!=
name|NULL
condition|)
block|{
name|xpt_print_path
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Lun already enabled\n"
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_LUN_ALRDY_ENA
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cel
operator|->
name|grp6_len
operator|!=
literal|0
operator|||
name|cel
operator|->
name|grp7_len
operator|!=
literal|0
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|printf
argument_list|(
literal|"Non-zero Group Codes\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|lstate
operator|=
operator|(
expr|struct
name|sbp_targ_lstate
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|lstate
argument_list|)
argument_list|,
name|M_SBP_TARG
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|lstate
operator|==
name|NULL
condition|)
block|{
name|xpt_print_path
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Couldn't allocate lstate\n"
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_RESRC_UNAVAIL
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|==
name|CAM_TARGET_WILDCARD
condition|)
name|sc
operator|->
name|black_hole
operator|=
name|lstate
expr_stmt|;
else|else
name|sc
operator|->
name|lstate
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
index|]
operator|=
name|lstate
expr_stmt|;
name|memset
argument_list|(
name|lstate
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|lstate
argument_list|)
argument_list|)
expr_stmt|;
name|lstate
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|status
operator|=
name|xpt_create_path
argument_list|(
operator|&
name|lstate
operator|->
name|path
argument_list|,
comment|/*periph*/
name|NULL
argument_list|,
name|xpt_path_path_id
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
argument_list|,
name|xpt_path_target_id
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
argument_list|,
name|xpt_path_lun_id
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|free
argument_list|(
name|lstate
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
name|xpt_print_path
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Couldn't allocate path\n"
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_RESRC_UNAVAIL
expr_stmt|;
return|return;
block|}
name|SLIST_INIT
argument_list|(
operator|&
name|lstate
operator|->
name|accept_tios
argument_list|)
expr_stmt|;
name|SLIST_INIT
argument_list|(
operator|&
name|lstate
operator|->
name|immed_notifies
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|lstate
operator|->
name|logins
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_print_path
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Lun now enabled for target mode\n"
argument_list|)
expr_stmt|;
comment|/* bus reset */
name|sc
operator|->
name|fd
operator|.
name|fc
operator|->
name|ibr
argument_list|(
name|sc
operator|->
name|fd
operator|.
name|fc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|sbp_targ_login
modifier|*
name|login
decl_stmt|,
modifier|*
name|next
decl_stmt|;
if|if
condition|(
name|lstate
operator|==
name|NULL
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_LUN_INVALID
expr_stmt|;
return|return;
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
if|if
condition|(
name|SLIST_FIRST
argument_list|(
operator|&
name|lstate
operator|->
name|accept_tios
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"ATIOs pending\n"
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
block|}
if|if
condition|(
name|SLIST_FIRST
argument_list|(
operator|&
name|lstate
operator|->
name|immed_notifies
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"INOTs pending\n"
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
block|}
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
return|return;
block|}
name|xpt_print_path
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Target mode disabled\n"
argument_list|)
expr_stmt|;
name|xpt_free_path
argument_list|(
name|lstate
operator|->
name|path
argument_list|)
expr_stmt|;
for|for
control|(
name|login
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|lstate
operator|->
name|logins
argument_list|)
init|;
name|login
operator|!=
name|NULL
condition|;
name|login
operator|=
name|next
control|)
block|{
name|next
operator|=
name|STAILQ_NEXT
argument_list|(
name|login
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|sbp_targ_dealloc_login
argument_list|(
name|login
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|==
name|CAM_TARGET_WILDCARD
condition|)
name|sc
operator|->
name|black_hole
operator|=
name|NULL
expr_stmt|;
else|else
name|sc
operator|->
name|lstate
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
index|]
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|lstate
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
comment|/* bus reset */
name|sc
operator|->
name|fd
operator|.
name|fc
operator|->
name|ibr
argument_list|(
name|sc
operator|->
name|fd
operator|.
name|fc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_send_lstate_events
parameter_list|(
name|struct
name|sbp_targ_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct ccb_hdr *ccbh; 	struct ccb_immed_notify *inot;  	printf("%s: not implemented yet\n", __func__);
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|sbp_targ_remove_orb_info
parameter_list|(
name|struct
name|sbp_targ_login
modifier|*
name|login
parameter_list|,
name|struct
name|orb_info
modifier|*
name|orbi
parameter_list|)
block|{
name|STAILQ_REMOVE
argument_list|(
operator|&
name|login
operator|->
name|orbs
argument_list|,
name|orbi
argument_list|,
name|orb_info
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * tag_id/init_id encoding  *  * tag_id and init_id has only 32bit for each.  * scsi_target can handle very limited number(up to 15) of init_id.  * we have to encode 48bit orb and 64bit EUI64 into these  * variables.  *  * tag_id represents lower 32bit of ORB address.  * init_id represents login_id.  *  */
end_comment

begin_function
specifier|static
name|struct
name|orb_info
modifier|*
name|sbp_targ_get_orb_info
parameter_list|(
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
parameter_list|,
name|u_int
name|tag_id
parameter_list|,
name|u_int
name|init_id
parameter_list|)
block|{
name|struct
name|sbp_targ_login
modifier|*
name|login
decl_stmt|;
name|struct
name|orb_info
modifier|*
name|orbi
decl_stmt|;
name|login
operator|=
name|lstate
operator|->
name|sc
operator|->
name|logins
index|[
name|init_id
index|]
expr_stmt|;
if|if
condition|(
name|login
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: no such login\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|STAILQ_FOREACH
argument_list|(
argument|orbi
argument_list|,
argument|&login->orbs
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|orbi
operator|->
name|orb_lo
operator|==
name|tag_id
condition|)
goto|goto
name|found
goto|;
name|printf
argument_list|(
literal|"%s: orb not found tag_id=0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|tag_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
name|found
label|:
return|return
operator|(
name|orbi
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_abort
parameter_list|(
name|struct
name|orb_info
modifier|*
name|orbi
parameter_list|)
block|{
name|struct
name|orb_info
modifier|*
name|norbi
decl_stmt|;
for|for
control|(
init|;
name|orbi
operator|!=
name|NULL
condition|;
name|orbi
operator|=
name|norbi
control|)
block|{
name|printf
argument_list|(
literal|"%s: status=%d\n"
argument_list|,
name|__func__
argument_list|,
name|orbi
operator|->
name|state
argument_list|)
expr_stmt|;
name|norbi
operator|=
name|STAILQ_NEXT
argument_list|(
name|orbi
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|orbi
operator|->
name|state
operator|!=
name|ORBI_STATUS_ABORTED
condition|)
block|{
if|if
condition|(
name|orbi
operator|->
name|ccb
operator|!=
name|NULL
condition|)
block|{
name|orbi
operator|->
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_ABORTED
expr_stmt|;
name|xpt_done
argument_list|(
name|orbi
operator|->
name|ccb
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|ccb
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|orbi
operator|->
name|state
operator|<=
name|ORBI_STATUS_ATIO
condition|)
block|{
name|sbp_targ_remove_orb_info
argument_list|(
name|orbi
operator|->
name|login
argument_list|,
name|orbi
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|orbi
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
block|}
else|else
name|orbi
operator|->
name|state
operator|=
name|ORBI_STATUS_ABORTED
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_free_orbi
parameter_list|(
name|struct
name|fw_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|orb_info
modifier|*
name|orbi
decl_stmt|;
name|orbi
operator|=
operator|(
expr|struct
name|orb_info
operator|*
operator|)
name|xfer
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|resp
operator|!=
literal|0
condition|)
block|{
comment|/* XXX */
name|printf
argument_list|(
literal|"%s: xfer->resp = %d\n"
argument_list|,
name|__func__
argument_list|,
name|xfer
operator|->
name|resp
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|orbi
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
name|fw_xfer_free
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_status_FIFO
parameter_list|(
name|struct
name|orb_info
modifier|*
name|orbi
parameter_list|,
name|uint32_t
name|fifo_hi
parameter_list|,
name|uint32_t
name|fifo_lo
parameter_list|,
name|int
name|dequeue
parameter_list|)
block|{
name|struct
name|fw_xfer
modifier|*
name|xfer
decl_stmt|;
if|if
condition|(
name|dequeue
condition|)
name|sbp_targ_remove_orb_info
argument_list|(
name|orbi
operator|->
name|login
argument_list|,
name|orbi
argument_list|)
expr_stmt|;
name|xfer
operator|=
name|fwmem_write_block
argument_list|(
name|orbi
operator|->
name|fwdev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|orbi
argument_list|,
comment|/*spd*/
literal|2
argument_list|,
name|fifo_hi
argument_list|,
name|fifo_lo
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
operator|(
name|orbi
operator|->
name|status
operator|.
name|len
operator|+
literal|1
operator|)
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|orbi
operator|->
name|status
argument_list|,
name|sbp_targ_free_orbi
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer
operator|==
name|NULL
condition|)
block|{
comment|/* XXX */
name|printf
argument_list|(
literal|"%s: xfer == NULL\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_send_status
parameter_list|(
name|struct
name|orb_info
modifier|*
name|orbi
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|sbp_status
modifier|*
name|sbp_status
decl_stmt|;
name|sbp_status
operator|=
operator|&
name|orbi
operator|->
name|status
expr_stmt|;
name|orbi
operator|->
name|state
operator|=
name|ORBI_STATUS_STATUS
expr_stmt|;
name|sbp_status
operator|->
name|resp
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
name|sbp_status
operator|->
name|status
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
name|sbp_status
operator|->
name|dead
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
switch|switch
condition|(
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
condition|)
block|{
case|case
name|SCSI_STATUS_OK
case|:
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: STATUS_OK\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|sbp_status
operator|->
name|len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SCSI_STATUS_CHECK_COND
case|:
case|case
name|SCSI_STATUS_BUSY
case|:
case|case
name|SCSI_STATUS_CMD_TERMINATED
case|:
block|{
name|struct
name|sbp_cmd_status
modifier|*
name|sbp_cmd_status
decl_stmt|;
name|struct
name|scsi_sense_data
modifier|*
name|sense
decl_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: STATUS %d\n"
argument_list|,
name|__func__
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
argument_list|)
expr_stmt|;
name|sbp_cmd_status
operator|=
operator|(
expr|struct
name|sbp_cmd_status
operator|*
operator|)
operator|&
name|sbp_status
operator|->
name|data
index|[
literal|0
index|]
expr_stmt|;
name|sbp_cmd_status
operator|->
name|status
operator|=
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
expr_stmt|;
name|sense
operator|=
operator|&
name|ccb
operator|->
name|csio
operator|.
name|sense_data
expr_stmt|;
name|sbp_targ_abort
argument_list|(
name|STAILQ_NEXT
argument_list|(
name|orbi
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sense
operator|->
name|error_code
operator|&
name|SSD_ERRCODE
operator|)
operator|==
name|SSD_CURRENT_ERROR
condition|)
name|sbp_cmd_status
operator|->
name|sfmt
operator|=
name|SBP_SFMT_CURR
expr_stmt|;
else|else
name|sbp_cmd_status
operator|->
name|sfmt
operator|=
name|SBP_SFMT_DEFER
expr_stmt|;
name|sbp_cmd_status
operator|->
name|valid
operator|=
operator|(
name|sense
operator|->
name|error_code
operator|&
name|SSD_ERRCODE_VALID
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|sbp_cmd_status
operator|->
name|s_key
operator|=
name|sense
operator|->
name|flags
operator|&
name|SSD_KEY
expr_stmt|;
name|sbp_cmd_status
operator|->
name|mark
operator|=
operator|(
name|sense
operator|->
name|flags
operator|&
name|SSD_FILEMARK
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|sbp_cmd_status
operator|->
name|eom
operator|=
operator|(
name|sense
operator|->
name|flags
operator|&
name|SSD_EOM
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|sbp_cmd_status
operator|->
name|ill_len
operator|=
operator|(
name|sense
operator|->
name|flags
operator|&
name|SSD_ILI
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|sense
operator|->
name|info
index|[
literal|0
index|]
argument_list|,
operator|&
name|sbp_cmd_status
operator|->
name|info
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|sense
operator|->
name|extra_len
operator|<=
literal|6
condition|)
comment|/* add_sense_code(_qual), info, cmd_spec_info */
name|sbp_status
operator|->
name|len
operator|=
literal|4
expr_stmt|;
else|else
comment|/* fru, sense_key_spec */
name|sbp_status
operator|->
name|len
operator|=
literal|5
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|sense
operator|->
name|cmd_spec_info
index|[
literal|0
index|]
argument_list|,
operator|&
name|sbp_cmd_status
operator|->
name|cdb
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sbp_cmd_status
operator|->
name|s_code
operator|=
name|sense
operator|->
name|add_sense_code
expr_stmt|;
name|sbp_cmd_status
operator|->
name|s_qlfr
operator|=
name|sense
operator|->
name|add_sense_code_qual
expr_stmt|;
name|sbp_cmd_status
operator|->
name|fru
operator|=
name|sense
operator|->
name|fru
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|sense
operator|->
name|sense_key_spec
index|[
literal|0
index|]
argument_list|,
operator|&
name|sbp_cmd_status
operator|->
name|s_keydep
index|[
literal|0
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|printf
argument_list|(
literal|"%s: unknown scsi status 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|sbp_status
operator|->
name|status
argument_list|)
expr_stmt|;
block|}
name|sbp_targ_status_FIFO
argument_list|(
name|orbi
argument_list|,
name|orbi
operator|->
name|login
operator|->
name|fifo_hi
argument_list|,
name|orbi
operator|->
name|login
operator|->
name|fifo_lo
argument_list|,
comment|/*dequeue*/
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|orbi
operator|->
name|page_table
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|orbi
operator|->
name|page_table
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_cam_done
parameter_list|(
name|struct
name|fw_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|orb_info
modifier|*
name|orbi
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|orbi
operator|=
operator|(
expr|struct
name|orb_info
operator|*
operator|)
name|xfer
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"%s: resp=%d refcount=%d\n"
argument_list|,
name|__func__
argument_list|,
name|xfer
operator|->
name|resp
argument_list|,
name|orbi
operator|->
name|refcount
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|resp
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: xfer->resp = %d\n"
argument_list|,
name|__func__
argument_list|,
name|xfer
operator|->
name|resp
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|resp
operator|=
name|SBP_TRANS_FAIL
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|status
operator|=
name|OBJ_DATA
operator||
name|SBE_TIMEOUT
comment|/*XXX*/
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|dead
operator|=
literal|1
expr_stmt|;
name|sbp_targ_abort
argument_list|(
name|STAILQ_NEXT
argument_list|(
name|orbi
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|orbi
operator|->
name|refcount
operator|--
expr_stmt|;
name|ccb
operator|=
name|orbi
operator|->
name|ccb
expr_stmt|;
if|if
condition|(
name|orbi
operator|->
name|refcount
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|orbi
operator|->
name|state
operator|==
name|ORBI_STATUS_ABORTED
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: orbi aborted\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|sbp_targ_remove_orb_info
argument_list|(
name|orbi
operator|->
name|login
argument_list|,
name|orbi
argument_list|)
expr_stmt|;
if|if
condition|(
name|orbi
operator|->
name|page_table
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|orbi
operator|->
name|page_table
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|orbi
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|orbi
operator|->
name|status
operator|.
name|resp
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_SEND_STATUS
operator|)
operator|!=
literal|0
condition|)
name|sbp_targ_send_status
argument_list|(
name|orbi
argument_list|,
name|ccb
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|orbi
operator|->
name|status
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|sbp_targ_status_FIFO
argument_list|(
name|orbi
argument_list|,
name|orbi
operator|->
name|login
operator|->
name|fifo_hi
argument_list|,
name|orbi
operator|->
name|login
operator|->
name|fifo_lo
argument_list|,
comment|/*dequeue*/
literal|1
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_ABORTED
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
block|}
name|fw_xfer_free
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|cam_status
name|sbp_targ_abort_ccb
parameter_list|(
name|struct
name|sbp_targ_softc
modifier|*
name|sc
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|union
name|ccb
modifier|*
name|accb
decl_stmt|;
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
decl_stmt|;
name|struct
name|ccb_hdr_slist
modifier|*
name|list
decl_stmt|;
name|struct
name|ccb_hdr
modifier|*
name|curelm
decl_stmt|;
name|int
name|found
decl_stmt|;
name|cam_status
name|status
decl_stmt|;
name|status
operator|=
name|sbp_targ_find_devs
argument_list|(
name|sc
argument_list|,
name|ccb
argument_list|,
operator|&
name|lstate
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|accb
operator|=
name|ccb
operator|->
name|cab
operator|.
name|abort_ccb
expr_stmt|;
if|if
condition|(
name|accb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ACCEPT_TARGET_IO
condition|)
name|list
operator|=
operator|&
name|lstate
operator|->
name|accept_tios
expr_stmt|;
elseif|else
if|if
condition|(
name|accb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_IMMED_NOTIFY
condition|)
name|list
operator|=
operator|&
name|lstate
operator|->
name|immed_notifies
expr_stmt|;
else|else
return|return
operator|(
name|CAM_UA_ABORT
operator|)
return|;
name|curelm
operator|=
name|SLIST_FIRST
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|curelm
operator|==
operator|&
name|accb
operator|->
name|ccb_h
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
name|SLIST_REMOVE_HEAD
argument_list|(
name|list
argument_list|,
name|sim_links
operator|.
name|sle
argument_list|)
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|curelm
operator|!=
name|NULL
condition|)
block|{
name|struct
name|ccb_hdr
modifier|*
name|nextelm
decl_stmt|;
name|nextelm
operator|=
name|SLIST_NEXT
argument_list|(
name|curelm
argument_list|,
name|sim_links
operator|.
name|sle
argument_list|)
expr_stmt|;
if|if
condition|(
name|nextelm
operator|==
operator|&
name|accb
operator|->
name|ccb_h
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
name|SLIST_NEXT
argument_list|(
name|curelm
argument_list|,
name|sim_links
operator|.
name|sle
argument_list|)
operator|=
name|SLIST_NEXT
argument_list|(
name|nextelm
argument_list|,
name|sim_links
operator|.
name|sle
argument_list|)
expr_stmt|;
break|break;
block|}
name|curelm
operator|=
name|nextelm
expr_stmt|;
block|}
block|}
if|if
condition|(
name|found
condition|)
block|{
name|accb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_ABORTED
expr_stmt|;
name|xpt_done
argument_list|(
name|accb
argument_list|)
expr_stmt|;
return|return
operator|(
name|CAM_REQ_CMP
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"%s: not found\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|CAM_PATH_INVALID
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_xfer_buf
parameter_list|(
name|struct
name|orb_info
modifier|*
name|orbi
parameter_list|,
name|u_int
name|offset
parameter_list|,
name|uint16_t
name|dst_hi
parameter_list|,
name|uint32_t
name|dst_lo
parameter_list|,
name|u_int
name|size
parameter_list|,
name|void
function_decl|(
modifier|*
name|hand
function_decl|)
parameter_list|(
name|struct
name|fw_xfer
modifier|*
parameter_list|)
parameter_list|)
block|{
name|struct
name|fw_xfer
modifier|*
name|xfer
decl_stmt|;
name|u_int
name|len
decl_stmt|,
name|ccb_dir
decl_stmt|,
name|off
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
name|debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"%s: offset=%d size=%d\n"
argument_list|,
name|__func__
argument_list|,
name|offset
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|ccb_dir
operator|=
name|orbi
operator|->
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
expr_stmt|;
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|orbi
operator|->
name|ccb
operator|->
name|csio
operator|.
name|data_ptr
operator|+
name|offset
expr_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
comment|/* XXX assume dst_lo + off doesn't overflow */
name|len
operator|=
name|MIN
argument_list|(
name|size
argument_list|,
literal|2048
comment|/* XXX */
argument_list|)
expr_stmt|;
name|size
operator|-=
name|len
expr_stmt|;
name|orbi
operator|->
name|refcount
operator|++
expr_stmt|;
if|if
condition|(
name|ccb_dir
operator|==
name|CAM_DIR_OUT
condition|)
name|xfer
operator|=
name|fwmem_read_block
argument_list|(
name|orbi
operator|->
name|fwdev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|orbi
argument_list|,
comment|/*spd*/
literal|2
argument_list|,
name|dst_hi
argument_list|,
name|dst_lo
operator|+
name|off
argument_list|,
name|len
argument_list|,
name|ptr
operator|+
name|off
argument_list|,
name|hand
argument_list|)
expr_stmt|;
else|else
name|xfer
operator|=
name|fwmem_write_block
argument_list|(
name|orbi
operator|->
name|fwdev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|orbi
argument_list|,
comment|/*spd*/
literal|2
argument_list|,
name|dst_hi
argument_list|,
name|dst_lo
operator|+
name|off
argument_list|,
name|len
argument_list|,
name|ptr
operator|+
name|off
argument_list|,
name|hand
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: xfer == NULL"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* XXX what should we do?? */
name|orbi
operator|->
name|refcount
operator|--
expr_stmt|;
block|}
name|off
operator|+=
name|len
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_pt_done
parameter_list|(
name|struct
name|fw_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|orb_info
modifier|*
name|orbi
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|u_int
name|i
decl_stmt|,
name|offset
decl_stmt|,
name|res
decl_stmt|,
name|len
decl_stmt|;
name|uint32_t
name|t1
decl_stmt|,
name|t2
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|orbi
operator|=
operator|(
expr|struct
name|orb_info
operator|*
operator|)
name|xfer
operator|->
name|sc
expr_stmt|;
name|ccb
operator|=
name|orbi
operator|->
name|ccb
expr_stmt|;
if|if
condition|(
name|orbi
operator|->
name|state
operator|==
name|ORBI_STATUS_ABORTED
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: orbi aborted\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|sbp_targ_remove_orb_info
argument_list|(
name|orbi
operator|->
name|login
argument_list|,
name|orbi
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|orbi
operator|->
name|page_table
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|orbi
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
name|fw_xfer_free
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|xfer
operator|->
name|resp
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: xfer->resp = %d\n"
argument_list|,
name|__func__
argument_list|,
name|xfer
operator|->
name|resp
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|resp
operator|=
name|SBP_TRANS_FAIL
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|status
operator|=
name|OBJ_PT
operator||
name|SBE_TIMEOUT
comment|/*XXX*/
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|dead
operator|=
literal|1
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|sbp_targ_abort
argument_list|(
name|STAILQ_NEXT
argument_list|(
name|orbi
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|sbp_targ_status_FIFO
argument_list|(
name|orbi
argument_list|,
name|orbi
operator|->
name|login
operator|->
name|fifo_hi
argument_list|,
name|orbi
operator|->
name|login
operator|->
name|fifo_lo
argument_list|,
comment|/*dequeue*/
literal|1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|orbi
operator|->
name|page_table
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
name|fw_xfer_free
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: dxfer_len=%d\n"
argument_list|,
name|__func__
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|refcount
operator|++
expr_stmt|;
for|for
control|(
name|p
operator|=
name|orbi
operator|->
name|page_table
operator|,
name|i
operator|=
name|orbi
operator|->
name|orb4
operator|.
name|data_size
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|t1
operator|=
name|ntohl
argument_list|(
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
name|t2
operator|=
name|ntohl
argument_list|(
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"page_table: %04x:%08x %d\n"
argument_list|,
name|t1
operator|&
literal|0xffff
argument_list|,
name|t2
argument_list|,
name|t1
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|len
operator|=
name|MIN
argument_list|(
name|t1
operator|>>
literal|16
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|res
operator|-=
name|len
expr_stmt|;
name|sbp_targ_xfer_buf
argument_list|(
name|orbi
argument_list|,
name|offset
argument_list|,
name|t1
operator|&
literal|0xffff
argument_list|,
name|t2
argument_list|,
name|len
argument_list|,
name|sbp_targ_cam_done
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
break|break;
block|}
name|orbi
operator|->
name|refcount
operator|--
expr_stmt|;
if|if
condition|(
name|orbi
operator|->
name|refcount
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: refcount == 0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
comment|/* XXX handle res != 0 case */
name|printf
argument_list|(
literal|"%s: page table is too small(%d)\n"
argument_list|,
name|__func__
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|fw_xfer_free
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_fetch_pt
parameter_list|(
name|struct
name|orb_info
modifier|*
name|orbi
parameter_list|)
block|{
name|struct
name|fw_xfer
modifier|*
name|xfer
decl_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: page_table_size=%d\n"
argument_list|,
name|__func__
argument_list|,
name|orbi
operator|->
name|orb4
operator|.
name|data_size
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|page_table
operator|=
name|malloc
argument_list|(
name|orbi
operator|->
name|orb4
operator|.
name|data_size
operator|*
literal|8
argument_list|,
name|M_SBP_TARG
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|orbi
operator|->
name|page_table
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|xfer
operator|=
name|fwmem_read_block
argument_list|(
name|orbi
operator|->
name|fwdev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|orbi
argument_list|,
comment|/*spd*/
literal|2
argument_list|,
name|orbi
operator|->
name|data_hi
argument_list|,
name|orbi
operator|->
name|data_lo
argument_list|,
name|orbi
operator|->
name|orb4
operator|.
name|data_size
operator|*
literal|8
argument_list|,
operator|(
name|void
operator|*
operator|)
name|orbi
operator|->
name|page_table
argument_list|,
name|sbp_targ_pt_done
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer
operator|!=
name|NULL
condition|)
return|return;
name|error
label|:
name|orbi
operator|->
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_RESRC_UNAVAIL
expr_stmt|;
name|xpt_done
argument_list|(
name|orbi
operator|->
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_action1
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
decl_stmt|;
name|cam_status
name|status
decl_stmt|;
name|u_int
name|ccb_dir
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|sbp_targ_softc
operator|*
operator|)
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|status
operator|=
name|sbp_targ_find_devs
argument_list|(
name|sc
argument_list|,
name|ccb
argument_list|,
operator|&
name|lstate
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
condition|)
block|{
case|case
name|XPT_CONT_TARGET_IO
case|:
block|{
name|struct
name|orb_info
modifier|*
name|orbi
decl_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: XPT_CONT_TARGET_IO\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* XXX transfer from/to initiator */
name|orbi
operator|=
name|sbp_targ_get_orb_info
argument_list|(
name|lstate
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|tag_id
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|init_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|orbi
operator|==
name|NULL
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_ABORTED
expr_stmt|;
comment|/* XXX */
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|orbi
operator|->
name|state
operator|==
name|ORBI_STATUS_ABORTED
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: ctio aborted\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|sbp_targ_remove_orb_info
argument_list|(
name|orbi
operator|->
name|login
argument_list|,
name|orbi
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|orbi
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
break|break;
block|}
name|orbi
operator|->
name|state
operator|=
name|ORBI_STATUS_CTIO
expr_stmt|;
name|orbi
operator|->
name|ccb
operator|=
name|ccb
expr_stmt|;
name|ccb_dir
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
operator|==
literal|0
condition|)
name|ccb_dir
operator|=
name|CAM_DIR_NONE
expr_stmt|;
comment|/* Sanity check */
if|if
condition|(
name|ccb_dir
operator|==
name|CAM_DIR_IN
operator|&&
name|orbi
operator|->
name|orb4
operator|.
name|dir
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: direction mismatch\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* check page table */
if|if
condition|(
name|ccb_dir
operator|!=
name|CAM_DIR_NONE
operator|&&
name|orbi
operator|->
name|orb4
operator|.
name|page_table_present
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: page_table_present\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|orbi
operator|->
name|orb4
operator|.
name|page_size
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: unsupported pagesize %d != 0\n"
argument_list|,
name|__func__
argument_list|,
name|orbi
operator|->
name|orb4
operator|.
name|page_size
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
name|sbp_targ_fetch_pt
argument_list|(
name|orbi
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Sanity check */
if|if
condition|(
name|ccb_dir
operator|!=
name|CAM_DIR_NONE
operator|&&
name|orbi
operator|->
name|orb4
operator|.
name|data_size
operator|!=
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
condition|)
name|printf
argument_list|(
literal|"%s: data_size(%d) != dxfer_len(%d)\n"
argument_list|,
name|__func__
argument_list|,
name|orbi
operator|->
name|orb4
operator|.
name|data_size
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccb_dir
operator|!=
name|CAM_DIR_NONE
condition|)
name|sbp_targ_xfer_buf
argument_list|(
name|orbi
argument_list|,
literal|0
argument_list|,
name|orbi
operator|->
name|data_hi
argument_list|,
name|orbi
operator|->
name|data_lo
argument_list|,
name|MIN
argument_list|(
name|orbi
operator|->
name|orb4
operator|.
name|data_size
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
argument_list|)
argument_list|,
name|sbp_targ_cam_done
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccb_dir
operator|==
name|CAM_DIR_NONE
condition|)
block|{
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_SEND_STATUS
operator|)
operator|!=
literal|0
condition|)
name|sbp_targ_send_status
argument_list|(
name|orbi
argument_list|,
name|ccb
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|XPT_ACCEPT_TARGET_IO
case|:
comment|/* Add Accept Target IO Resource */
if|if
condition|(
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|lstate
operator|->
name|accept_tios
argument_list|,
operator|&
name|ccb
operator|->
name|ccb_h
argument_list|,
name|sim_links
operator|.
name|sle
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INPROG
expr_stmt|;
if|if
condition|(
operator|(
name|lstate
operator|->
name|flags
operator|&
name|F_ATIO_STARVED
operator|)
operator|!=
literal|0
condition|)
block|{
name|struct
name|sbp_targ_login
modifier|*
name|login
decl_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: new atio arrived\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|lstate
operator|->
name|flags
operator|&=
operator|~
name|F_ATIO_STARVED
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|login
argument_list|,
argument|&lstate->logins
argument_list|,
argument|link
argument_list|)
if|if
condition|(
operator|(
name|login
operator|->
name|flags
operator|&
name|F_ATIO_STARVED
operator|)
operator|!=
literal|0
condition|)
block|{
name|login
operator|->
name|flags
operator|&=
operator|~
name|F_ATIO_STARVED
expr_stmt|;
name|sbp_targ_fetch_orb
argument_list|(
name|lstate
operator|->
name|sc
argument_list|,
name|login
operator|->
name|fwdev
argument_list|,
name|login
operator|->
name|last_hi
argument_list|,
name|login
operator|->
name|last_lo
argument_list|,
name|login
argument_list|,
name|FETCH_CMD
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|XPT_NOTIFY_ACK
case|:
comment|/* recycle notify ack */
case|case
name|XPT_IMMED_NOTIFY
case|:
comment|/* Add Immediate Notify Resource */
if|if
condition|(
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|lstate
operator|->
name|immed_notifies
argument_list|,
operator|&
name|ccb
operator|->
name|ccb_h
argument_list|,
name|sim_links
operator|.
name|sle
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INPROG
expr_stmt|;
name|sbp_targ_send_lstate_events
argument_list|(
name|sc
argument_list|,
name|lstate
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_EN_LUN
case|:
name|sbp_targ_en_lun
argument_list|(
name|sc
argument_list|,
name|ccb
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_PATH_INQ
case|:
block|{
name|struct
name|ccb_pathinq
modifier|*
name|cpi
init|=
operator|&
name|ccb
operator|->
name|cpi
decl_stmt|;
name|cpi
operator|->
name|version_num
operator|=
literal|1
expr_stmt|;
comment|/* XXX??? */
name|cpi
operator|->
name|hba_inquiry
operator|=
name|PI_TAG_ABLE
expr_stmt|;
name|cpi
operator|->
name|target_sprt
operator|=
name|PIT_PROCESSOR
operator||
name|PIT_DISCONNECT
operator||
name|PIT_TERM_IO
expr_stmt|;
name|cpi
operator|->
name|hba_misc
operator|=
name|PIM_NOBUSRESET
operator||
name|PIM_NO_6_BYTE
expr_stmt|;
name|cpi
operator|->
name|hba_eng_cnt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|max_target
operator|=
literal|7
expr_stmt|;
comment|/* XXX */
name|cpi
operator|->
name|max_lun
operator|=
name|MAX_LUN
operator|-
literal|1
expr_stmt|;
name|cpi
operator|->
name|initiator_id
operator|=
literal|7
expr_stmt|;
comment|/* XXX */
name|cpi
operator|->
name|bus_id
operator|=
name|sim
operator|->
name|bus_id
expr_stmt|;
name|cpi
operator|->
name|base_transfer_speed
operator|=
literal|400
operator|*
literal|1000
operator|/
literal|8
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|sim_vid
argument_list|,
literal|"FreeBSD"
argument_list|,
name|SIM_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|hba_vid
argument_list|,
literal|"SBP_TARG"
argument_list|,
name|HBA_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|dev_name
argument_list|,
name|sim
operator|->
name|sim_name
argument_list|,
name|DEV_IDLEN
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|unit_number
operator|=
name|sim
operator|->
name|unit_number
expr_stmt|;
name|cpi
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|XPT_ABORT
case|:
block|{
name|union
name|ccb
modifier|*
name|accb
init|=
name|ccb
operator|->
name|cab
operator|.
name|abort_ccb
decl_stmt|;
switch|switch
condition|(
name|accb
operator|->
name|ccb_h
operator|.
name|func_code
condition|)
block|{
case|case
name|XPT_ACCEPT_TARGET_IO
case|:
case|case
name|XPT_IMMED_NOTIFY
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|sbp_targ_abort_ccb
argument_list|(
name|sc
argument_list|,
name|ccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_CONT_TARGET_IO
case|:
comment|/* XXX */
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_UA_ABORT
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%s: aborting unknown function %d\n"
argument_list|,
name|__func__
argument_list|,
name|accb
operator|->
name|ccb_h
operator|.
name|func_code
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
break|break;
block|}
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|printf
argument_list|(
literal|"%s: unknown function %d\n"
argument_list|,
name|__func__
argument_list|,
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splfw
argument_list|()
expr_stmt|;
name|sbp_targ_action1
argument_list|(
name|sim
argument_list|,
name|ccb
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|)
block|{
comment|/* XXX */
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_cmd_handler
parameter_list|(
name|struct
name|fw_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|fw_pkt
modifier|*
name|fp
decl_stmt|;
name|uint32_t
modifier|*
name|orb
decl_stmt|;
name|struct
name|corb4
modifier|*
name|orb4
decl_stmt|;
name|struct
name|orb_info
modifier|*
name|orbi
decl_stmt|;
name|struct
name|ccb_accept_tio
modifier|*
name|atio
decl_stmt|;
name|u_char
modifier|*
name|bytes
decl_stmt|;
name|int
name|i
decl_stmt|;
name|orbi
operator|=
operator|(
expr|struct
name|orb_info
operator|*
operator|)
name|xfer
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|resp
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: xfer->resp = %d\n"
argument_list|,
name|__func__
argument_list|,
name|xfer
operator|->
name|resp
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|resp
operator|=
name|SBP_TRANS_FAIL
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|status
operator|=
name|OBJ_ORB
operator||
name|SBE_TIMEOUT
comment|/*XXX*/
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|dead
operator|=
literal|1
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|sbp_targ_abort
argument_list|(
name|STAILQ_NEXT
argument_list|(
name|orbi
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|sbp_targ_status_FIFO
argument_list|(
name|orbi
argument_list|,
name|orbi
operator|->
name|login
operator|->
name|fifo_hi
argument_list|,
name|orbi
operator|->
name|login
operator|->
name|fifo_lo
argument_list|,
comment|/*dequeue*/
literal|1
argument_list|)
expr_stmt|;
name|fw_xfer_free
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return;
block|}
name|fp
operator|=
operator|&
name|xfer
operator|->
name|recv
operator|.
name|hdr
expr_stmt|;
if|if
condition|(
name|orbi
operator|->
name|state
operator|==
name|ORBI_STATUS_ABORTED
condition|)
block|{
name|printf
argument_list|(
literal|"%s: aborted\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|sbp_targ_remove_orb_info
argument_list|(
name|orbi
operator|->
name|login
argument_list|,
name|orbi
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|orbi
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
goto|goto
name|done0
goto|;
block|}
name|orbi
operator|->
name|state
operator|=
name|ORBI_STATUS_ATIO
expr_stmt|;
name|orb
operator|=
name|orbi
operator|->
name|orb
expr_stmt|;
comment|/* swap payload except SCSI command */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|orb
index|[
name|i
index|]
operator|=
name|ntohl
argument_list|(
name|orb
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|orb4
operator|=
operator|(
expr|struct
name|corb4
operator|*
operator|)
operator|&
name|orb
index|[
literal|4
index|]
expr_stmt|;
if|if
condition|(
name|orb4
operator|->
name|rq_fmt
operator|!=
literal|0
condition|)
block|{
comment|/* XXX */
name|printf
argument_list|(
literal|"%s: rq_fmt(%d) != 0\n"
argument_list|,
name|__func__
argument_list|,
name|orb4
operator|->
name|rq_fmt
argument_list|)
expr_stmt|;
block|}
name|atio
operator|=
name|orbi
operator|->
name|atio
expr_stmt|;
name|atio
operator|->
name|ccb_h
operator|.
name|target_id
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
name|atio
operator|->
name|ccb_h
operator|.
name|target_lun
operator|=
name|orbi
operator|->
name|login
operator|->
name|lstate
operator|->
name|lun
expr_stmt|;
name|atio
operator|->
name|sense_len
operator|=
literal|0
expr_stmt|;
name|atio
operator|->
name|tag_action
operator|=
literal|1
expr_stmt|;
comment|/* XXX */
name|atio
operator|->
name|tag_id
operator|=
name|orbi
operator|->
name|orb_lo
expr_stmt|;
name|atio
operator|->
name|init_id
operator|=
name|orbi
operator|->
name|login
operator|->
name|id
expr_stmt|;
name|atio
operator|->
name|ccb_h
operator|.
name|flags
operator|=
name|CAM_TAG_ACTION_VALID
expr_stmt|;
name|bytes
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|orb
index|[
literal|5
index|]
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x\n"
argument_list|,
name|__func__
argument_list|,
name|bytes
index|[
literal|0
index|]
argument_list|,
name|bytes
index|[
literal|1
index|]
argument_list|,
name|bytes
index|[
literal|2
index|]
argument_list|,
name|bytes
index|[
literal|3
index|]
argument_list|,
name|bytes
index|[
literal|4
index|]
argument_list|,
name|bytes
index|[
literal|5
index|]
argument_list|,
name|bytes
index|[
literal|6
index|]
argument_list|,
name|bytes
index|[
literal|7
index|]
argument_list|,
name|bytes
index|[
literal|8
index|]
argument_list|,
name|bytes
index|[
literal|9
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|bytes
index|[
literal|0
index|]
operator|>>
literal|5
condition|)
block|{
case|case
literal|0
case|:
name|atio
operator|->
name|cdb_len
operator|=
literal|6
expr_stmt|;
break|break;
case|case
literal|1
case|:
case|case
literal|2
case|:
name|atio
operator|->
name|cdb_len
operator|=
literal|10
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|atio
operator|->
name|cdb_len
operator|=
literal|16
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|atio
operator|->
name|cdb_len
operator|=
literal|12
expr_stmt|;
break|break;
case|case
literal|3
case|:
default|default:
comment|/* Only copy the opcode. */
name|atio
operator|->
name|cdb_len
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"Reserved or VU command code type encountered\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|memcpy
argument_list|(
name|atio
operator|->
name|cdb_io
operator|.
name|cdb_bytes
argument_list|,
name|bytes
argument_list|,
name|atio
operator|->
name|cdb_len
argument_list|)
expr_stmt|;
name|atio
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_CDB_RECVD
expr_stmt|;
comment|/* next ORB */
if|if
condition|(
operator|(
name|orb
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
literal|31
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: fetch next orb\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|src
operator|=
name|SRC_NEXT_EXISTS
expr_stmt|;
name|sbp_targ_fetch_orb
argument_list|(
name|orbi
operator|->
name|sc
argument_list|,
name|orbi
operator|->
name|fwdev
argument_list|,
name|orb
index|[
literal|0
index|]
argument_list|,
name|orb
index|[
literal|1
index|]
argument_list|,
name|orbi
operator|->
name|login
argument_list|,
name|FETCH_CMD
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|orbi
operator|->
name|status
operator|.
name|src
operator|=
name|SRC_NO_NEXT
expr_stmt|;
name|orbi
operator|->
name|login
operator|->
name|flags
operator|&=
operator|~
name|F_LINK_ACTIVE
expr_stmt|;
block|}
name|orbi
operator|->
name|data_hi
operator|=
name|orb
index|[
literal|2
index|]
expr_stmt|;
name|orbi
operator|->
name|data_lo
operator|=
name|orb
index|[
literal|3
index|]
expr_stmt|;
name|orbi
operator|->
name|orb4
operator|=
operator|*
name|orb4
expr_stmt|;
name|xpt_done
argument_list|(
operator|(
expr|union
name|ccb
operator|*
operator|)
name|atio
argument_list|)
expr_stmt|;
name|done0
label|:
name|fw_xfer_free
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|struct
name|sbp_targ_login
modifier|*
name|sbp_targ_get_login
parameter_list|(
name|struct
name|sbp_targ_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|fw_device
modifier|*
name|fwdev
parameter_list|,
name|int
name|lun
parameter_list|)
block|{
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
decl_stmt|;
name|struct
name|sbp_targ_login
modifier|*
name|login
decl_stmt|;
name|int
name|i
decl_stmt|;
name|lstate
operator|=
name|sc
operator|->
name|lstate
index|[
name|lun
index|]
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|login
argument_list|,
argument|&lstate->logins
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|login
operator|->
name|fwdev
operator|==
name|fwdev
condition|)
return|return
operator|(
name|login
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_LOGINS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|sc
operator|->
name|logins
index|[
name|i
index|]
operator|==
name|NULL
condition|)
goto|goto
name|found
goto|;
name|printf
argument_list|(
literal|"%s: increase MAX_LOGIN\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
name|found
label|:
name|login
operator|=
operator|(
expr|struct
name|sbp_targ_login
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sbp_targ_login
argument_list|)
argument_list|,
name|M_SBP_TARG
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|login
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: malloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|login
operator|->
name|fwdev
operator|=
name|fwdev
expr_stmt|;
name|login
operator|->
name|lstate
operator|=
name|lstate
expr_stmt|;
name|login
operator|->
name|last_hi
operator|=
literal|0xffff
expr_stmt|;
name|login
operator|->
name|last_lo
operator|=
literal|0xffffffff
expr_stmt|;
name|login
operator|->
name|hold_sec
operator|=
literal|1
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|login
operator|->
name|orbs
argument_list|)
expr_stmt|;
name|CALLOUT_INIT
argument_list|(
operator|&
name|login
operator|->
name|hold_callout
argument_list|)
expr_stmt|;
name|sc
operator|->
name|logins
index|[
name|i
index|]
operator|=
name|login
expr_stmt|;
return|return
operator|(
name|login
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_mgm_handler
parameter_list|(
name|struct
name|fw_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
decl_stmt|;
name|struct
name|sbp_targ_login
modifier|*
name|login
decl_stmt|;
name|struct
name|fw_pkt
modifier|*
name|fp
decl_stmt|;
name|uint32_t
modifier|*
name|orb
decl_stmt|;
name|struct
name|morb4
modifier|*
name|orb4
decl_stmt|;
name|struct
name|orb_info
modifier|*
name|orbi
decl_stmt|;
name|int
name|i
decl_stmt|;
name|orbi
operator|=
operator|(
expr|struct
name|orb_info
operator|*
operator|)
name|xfer
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|resp
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: xfer->resp = %d\n"
argument_list|,
name|__func__
argument_list|,
name|xfer
operator|->
name|resp
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|resp
operator|=
name|SBP_TRANS_FAIL
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|status
operator|=
name|OBJ_ORB
operator||
name|SBE_TIMEOUT
comment|/*XXX*/
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|dead
operator|=
literal|1
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|sbp_targ_abort
argument_list|(
name|STAILQ_NEXT
argument_list|(
name|orbi
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|sbp_targ_status_FIFO
argument_list|(
name|orbi
argument_list|,
name|orbi
operator|->
name|login
operator|->
name|fifo_hi
argument_list|,
name|orbi
operator|->
name|login
operator|->
name|fifo_lo
argument_list|,
comment|/*dequeue*/
literal|0
argument_list|)
expr_stmt|;
name|fw_xfer_free
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return;
block|}
name|fp
operator|=
operator|&
name|xfer
operator|->
name|recv
operator|.
name|hdr
expr_stmt|;
name|orb
operator|=
name|orbi
operator|->
name|orb
expr_stmt|;
comment|/* swap payload */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|orb
index|[
name|i
index|]
operator|=
name|ntohl
argument_list|(
name|orb
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|orb4
operator|=
operator|(
expr|struct
name|morb4
operator|*
operator|)
operator|&
name|orb
index|[
literal|4
index|]
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: %s\n"
argument_list|,
name|__func__
argument_list|,
name|orb_fun_name
index|[
name|orb4
operator|->
name|fun
index|]
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|src
operator|=
name|SRC_NO_NEXT
expr_stmt|;
switch|switch
condition|(
name|orb4
operator|->
name|fun
operator|<<
literal|16
condition|)
block|{
case|case
name|ORB_FUN_LGI
case|:
block|{
name|int
name|exclusive
init|=
literal|0
decl_stmt|,
name|lun
decl_stmt|;
if|if
condition|(
name|orb
index|[
literal|4
index|]
operator|&
name|ORB_EXV
condition|)
name|exclusive
operator|=
literal|1
expr_stmt|;
name|lun
operator|=
name|orb4
operator|->
name|id
expr_stmt|;
name|lstate
operator|=
name|orbi
operator|->
name|sc
operator|->
name|lstate
index|[
name|lun
index|]
expr_stmt|;
if|if
condition|(
name|lun
operator|>=
name|MAX_LUN
operator|||
name|lstate
operator|==
name|NULL
operator|||
operator|(
name|exclusive
operator|&&
name|STAILQ_FIRST
argument_list|(
operator|&
name|lstate
operator|->
name|logins
argument_list|)
operator|!=
name|NULL
operator|&&
name|STAILQ_FIRST
argument_list|(
operator|&
name|lstate
operator|->
name|logins
argument_list|)
operator|->
name|fwdev
operator|!=
name|orbi
operator|->
name|fwdev
operator|)
condition|)
block|{
comment|/* error */
name|orbi
operator|->
name|status
operator|.
name|dead
operator|=
literal|1
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|status
operator|=
name|STATUS_ACCESS_DENY
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|len
operator|=
literal|1
expr_stmt|;
break|break;
block|}
comment|/* allocate login */
name|login
operator|=
name|sbp_targ_get_login
argument_list|(
name|orbi
operator|->
name|sc
argument_list|,
name|orbi
operator|->
name|fwdev
argument_list|,
name|lun
argument_list|)
expr_stmt|;
if|if
condition|(
name|login
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: sbp_targ_get_login failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|dead
operator|=
literal|1
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|status
operator|=
name|STATUS_RES_UNAVAIL
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|len
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|login
operator|->
name|fifo_hi
operator|=
name|orb
index|[
literal|6
index|]
expr_stmt|;
name|login
operator|->
name|fifo_lo
operator|=
name|orb
index|[
literal|7
index|]
expr_stmt|;
name|login
operator|->
name|loginres
operator|.
name|len
operator|=
name|htons
argument_list|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
literal|4
argument_list|)
expr_stmt|;
name|login
operator|->
name|loginres
operator|.
name|id
operator|=
name|htons
argument_list|(
name|login
operator|->
name|id
argument_list|)
expr_stmt|;
name|login
operator|->
name|loginres
operator|.
name|cmd_hi
operator|=
name|htons
argument_list|(
name|SBP_TARG_BIND_HI
argument_list|)
expr_stmt|;
name|login
operator|->
name|loginres
operator|.
name|cmd_lo
operator|=
name|htonl
argument_list|(
name|SBP_TARG_BIND_LO
argument_list|(
name|login
operator|->
name|id
argument_list|)
argument_list|)
expr_stmt|;
name|login
operator|->
name|loginres
operator|.
name|recon_hold
operator|=
name|htons
argument_list|(
name|login
operator|->
name|hold_sec
argument_list|)
expr_stmt|;
name|fwmem_write_block
argument_list|(
name|orbi
operator|->
name|fwdev
argument_list|,
name|NULL
argument_list|,
comment|/*spd*/
literal|2
argument_list|,
name|orb
index|[
literal|2
index|]
argument_list|,
name|orb
index|[
literal|3
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sbp_login_res
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|login
operator|->
name|loginres
argument_list|,
name|fw_asy_callback_free
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|lstate
operator|->
name|logins
argument_list|,
name|login
argument_list|,
name|link
argument_list|)
expr_stmt|;
comment|/* XXX return status after loginres is successfully written */
break|break;
block|}
case|case
name|ORB_FUN_RCN
case|:
name|login
operator|=
name|orbi
operator|->
name|sc
operator|->
name|logins
index|[
name|orb4
operator|->
name|id
index|]
expr_stmt|;
if|if
condition|(
name|login
operator|!=
name|NULL
operator|&&
name|login
operator|->
name|fwdev
operator|==
name|orbi
operator|->
name|fwdev
condition|)
block|{
name|login
operator|->
name|flags
operator|&=
operator|~
name|F_HOLD
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|login
operator|->
name|hold_callout
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: reconnected id=%d\n"
argument_list|,
name|__func__
argument_list|,
name|login
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|orbi
operator|->
name|status
operator|.
name|dead
operator|=
literal|1
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|status
operator|=
name|STATUS_ACCESS_DENY
expr_stmt|;
name|printf
argument_list|(
literal|"%s: reconnection faild id=%d\n"
argument_list|,
name|__func__
argument_list|,
name|orb4
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ORB_FUN_LGO
case|:
name|login
operator|=
name|orbi
operator|->
name|sc
operator|->
name|logins
index|[
name|orb4
operator|->
name|id
index|]
expr_stmt|;
if|if
condition|(
name|login
operator|->
name|fwdev
operator|!=
name|orbi
operator|->
name|fwdev
condition|)
block|{
name|printf
argument_list|(
literal|"%s: wrong initiator\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
break|break;
block|}
name|sbp_targ_dealloc_login
argument_list|(
name|login
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%s: %s not implemented yet\n"
argument_list|,
name|__func__
argument_list|,
name|orb_fun_name
index|[
name|orb4
operator|->
name|fun
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|orbi
operator|->
name|status
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|sbp_targ_status_FIFO
argument_list|(
name|orbi
argument_list|,
name|orb
index|[
literal|6
index|]
argument_list|,
name|orb
index|[
literal|7
index|]
argument_list|,
comment|/*dequeue*/
literal|0
argument_list|)
expr_stmt|;
name|fw_xfer_free
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_pointer_handler
parameter_list|(
name|struct
name|fw_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|orb_info
modifier|*
name|orbi
decl_stmt|;
name|uint32_t
name|orb0
decl_stmt|,
name|orb1
decl_stmt|;
name|orbi
operator|=
operator|(
expr|struct
name|orb_info
operator|*
operator|)
name|xfer
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|xfer
operator|->
name|resp
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: xfer->resp = %d\n"
argument_list|,
name|__func__
argument_list|,
name|xfer
operator|->
name|resp
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|orb0
operator|=
name|ntohl
argument_list|(
name|orbi
operator|->
name|orb
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|orb1
operator|=
name|ntohl
argument_list|(
name|orbi
operator|->
name|orb
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|orb0
operator|&
operator|(
literal|1
operator|<<
literal|31
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: invalid pointer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|sbp_targ_fetch_orb
argument_list|(
name|orbi
operator|->
name|login
operator|->
name|lstate
operator|->
name|sc
argument_list|,
name|orbi
operator|->
name|fwdev
argument_list|,
operator|(
name|uint16_t
operator|)
name|orb0
argument_list|,
name|orb1
argument_list|,
name|orbi
operator|->
name|login
argument_list|,
name|FETCH_CMD
argument_list|)
expr_stmt|;
name|done
label|:
name|free
argument_list|(
name|orbi
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
name|fw_xfer_free
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_fetch_orb
parameter_list|(
name|struct
name|sbp_targ_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|fw_device
modifier|*
name|fwdev
parameter_list|,
name|uint16_t
name|orb_hi
parameter_list|,
name|uint32_t
name|orb_lo
parameter_list|,
name|struct
name|sbp_targ_login
modifier|*
name|login
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|orb_info
modifier|*
name|orbi
decl_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: fetch orb %04x:%08x\n"
argument_list|,
name|__func__
argument_list|,
name|orb_hi
argument_list|,
name|orb_lo
argument_list|)
expr_stmt|;
name|orbi
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|orb_info
argument_list|)
argument_list|,
name|M_SBP_TARG
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|orbi
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: malloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|orbi
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|orbi
operator|->
name|fwdev
operator|=
name|fwdev
expr_stmt|;
name|orbi
operator|->
name|login
operator|=
name|login
expr_stmt|;
name|orbi
operator|->
name|orb_hi
operator|=
name|orb_hi
expr_stmt|;
name|orbi
operator|->
name|orb_lo
operator|=
name|orb_lo
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|orb_hi
operator|=
name|htons
argument_list|(
name|orb_hi
argument_list|)
expr_stmt|;
name|orbi
operator|->
name|status
operator|.
name|orb_lo
operator|=
name|htonl
argument_list|(
name|orb_lo
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|FETCH_MGM
case|:
name|fwmem_read_block
argument_list|(
name|fwdev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|orbi
argument_list|,
comment|/*spd*/
literal|2
argument_list|,
name|orb_hi
argument_list|,
name|orb_lo
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
literal|8
argument_list|,
operator|&
name|orbi
operator|->
name|orb
index|[
literal|0
index|]
argument_list|,
name|sbp_targ_mgm_handler
argument_list|)
expr_stmt|;
break|break;
case|case
name|FETCH_CMD
case|:
name|orbi
operator|->
name|state
operator|=
name|ORBI_STATUS_FETCH
expr_stmt|;
name|login
operator|->
name|last_hi
operator|=
name|orb_hi
expr_stmt|;
name|login
operator|->
name|last_lo
operator|=
name|orb_lo
expr_stmt|;
name|login
operator|->
name|flags
operator||=
name|F_LINK_ACTIVE
expr_stmt|;
comment|/* dequeue */
name|orbi
operator|->
name|atio
operator|=
operator|(
expr|struct
name|ccb_accept_tio
operator|*
operator|)
name|SLIST_FIRST
argument_list|(
operator|&
name|login
operator|->
name|lstate
operator|->
name|accept_tios
argument_list|)
expr_stmt|;
if|if
condition|(
name|orbi
operator|->
name|atio
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: no free atio\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|login
operator|->
name|lstate
operator|->
name|flags
operator||=
name|F_ATIO_STARVED
expr_stmt|;
name|login
operator|->
name|flags
operator||=
name|F_ATIO_STARVED
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX ?? */
block|login->fwdev = fwdev;
endif|#
directive|endif
break|break;
block|}
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|login
operator|->
name|lstate
operator|->
name|accept_tios
argument_list|,
name|sim_links
operator|.
name|sle
argument_list|)
expr_stmt|;
name|fwmem_read_block
argument_list|(
name|fwdev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|orbi
argument_list|,
comment|/*spd*/
literal|2
argument_list|,
name|orb_hi
argument_list|,
name|orb_lo
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
literal|8
argument_list|,
operator|&
name|orbi
operator|->
name|orb
index|[
literal|0
index|]
argument_list|,
name|sbp_targ_cmd_handler
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|login
operator|->
name|orbs
argument_list|,
name|orbi
argument_list|,
name|link
argument_list|)
expr_stmt|;
break|break;
case|case
name|FETCH_POINTER
case|:
name|orbi
operator|->
name|state
operator|=
name|ORBI_STATUS_POINTER
expr_stmt|;
name|login
operator|->
name|flags
operator||=
name|F_LINK_ACTIVE
expr_stmt|;
name|fwmem_read_block
argument_list|(
name|fwdev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|orbi
argument_list|,
comment|/*spd*/
literal|2
argument_list|,
name|orb_hi
argument_list|,
name|orb_lo
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
literal|2
argument_list|,
operator|&
name|orbi
operator|->
name|orb
index|[
literal|0
index|]
argument_list|,
name|sbp_targ_pointer_handler
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%s: invalid mode %d\n"
argument_list|,
name|__func__
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_resp_callback
parameter_list|(
name|struct
name|fw_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: xfer=%p\n"
argument_list|,
name|__func__
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|sbp_targ_softc
operator|*
operator|)
name|xfer
operator|->
name|sc
expr_stmt|;
name|fw_xfer_unload
argument_list|(
name|xfer
argument_list|)
expr_stmt|;
name|xfer
operator|->
name|recv
operator|.
name|pay_len
operator|=
name|SBP_TARG_RECV_LEN
expr_stmt|;
name|xfer
operator|->
name|hand
operator|=
name|sbp_targ_recv
expr_stmt|;
name|s
operator|=
name|splfw
argument_list|()
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|fwb
operator|.
name|xferlist
argument_list|,
name|xfer
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sbp_targ_cmd
parameter_list|(
name|struct
name|fw_xfer
modifier|*
name|xfer
parameter_list|,
name|struct
name|fw_device
modifier|*
name|fwdev
parameter_list|,
name|int
name|login_id
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|struct
name|sbp_targ_login
modifier|*
name|login
decl_stmt|;
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|rtcode
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|login_id
operator|<
literal|0
operator|||
name|login_id
operator|>=
name|MAX_LOGINS
condition|)
return|return
operator|(
name|RESP_ADDRESS_ERROR
operator|)
return|;
name|sc
operator|=
operator|(
expr|struct
name|sbp_targ_softc
operator|*
operator|)
name|xfer
operator|->
name|sc
expr_stmt|;
name|login
operator|=
name|sc
operator|->
name|logins
index|[
name|login_id
index|]
expr_stmt|;
if|if
condition|(
name|login
operator|==
name|NULL
condition|)
return|return
operator|(
name|RESP_ADDRESS_ERROR
operator|)
return|;
if|if
condition|(
name|login
operator|->
name|fwdev
operator|!=
name|fwdev
condition|)
block|{
comment|/* XXX */
return|return
operator|(
name|RESP_ADDRESS_ERROR
operator|)
return|;
block|}
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
literal|0x08
case|:
comment|/* ORB_POINTER */
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: ORB_POINTER\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|login
operator|->
name|flags
operator|&
name|F_LINK_ACTIVE
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"link active (ORB_POINTER)\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|sbp_targ_fetch_orb
argument_list|(
name|sc
argument_list|,
name|fwdev
argument_list|,
name|ntohl
argument_list|(
name|xfer
operator|->
name|recv
operator|.
name|payload
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|xfer
operator|->
name|recv
operator|.
name|payload
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|login
argument_list|,
name|FETCH_CMD
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
comment|/* AGENT_RESET */
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: AGENT RESET\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|login
operator|->
name|last_hi
operator|=
literal|0xffff
expr_stmt|;
name|login
operator|->
name|last_lo
operator|=
literal|0xffffffff
expr_stmt|;
name|sbp_targ_abort
argument_list|(
name|STAILQ_FIRST
argument_list|(
operator|&
name|login
operator|->
name|orbs
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
comment|/* DOORBELL */
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%s: DOORBELL\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|login
operator|->
name|last_hi
operator|==
literal|0xffff
operator|&&
name|login
operator|->
name|last_lo
operator|==
literal|0xffffffff
condition|)
block|{
name|printf
argument_list|(
literal|"%s: no previous pointer(DOORBELL)\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|login
operator|->
name|flags
operator|&
name|F_LINK_ACTIVE
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"link active (DOORBELL)\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|sbp_targ_fetch_orb
argument_list|(
name|sc
argument_list|,
name|fwdev
argument_list|,
name|login
operator|->
name|last_hi
argument_list|,
name|login
operator|->
name|last_lo
argument_list|,
name|login
argument_list|,
name|FETCH_POINTER
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x00
case|:
comment|/* AGENT_STATE */
name|printf
argument_list|(
literal|"%s: AGENT_STATE (ignore)\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x14
case|:
comment|/* UNSOLICITED_STATE_ENABLE */
name|printf
argument_list|(
literal|"%s: UNSOLICITED_STATE_ENABLE (ignore)\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%s: invalid register %d\n"
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|rtcode
operator|=
name|RESP_ADDRESS_ERROR
expr_stmt|;
block|}
return|return
operator|(
name|rtcode
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sbp_targ_mgm
parameter_list|(
name|struct
name|fw_xfer
modifier|*
name|xfer
parameter_list|,
name|struct
name|fw_device
modifier|*
name|fwdev
parameter_list|)
block|{
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|fw_pkt
modifier|*
name|fp
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|sbp_targ_softc
operator|*
operator|)
name|xfer
operator|->
name|sc
expr_stmt|;
name|fp
operator|=
operator|&
name|xfer
operator|->
name|recv
operator|.
name|hdr
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|mode
operator|.
name|wreqb
operator|.
name|tcode
operator|!=
name|FWTCODE_WREQB
condition|)
block|{
name|printf
argument_list|(
literal|"%s: tcode = %d\n"
argument_list|,
name|__func__
argument_list|,
name|fp
operator|->
name|mode
operator|.
name|wreqb
operator|.
name|tcode
argument_list|)
expr_stmt|;
return|return
operator|(
name|RESP_TYPE_ERROR
operator|)
return|;
block|}
name|sbp_targ_fetch_orb
argument_list|(
name|sc
argument_list|,
name|fwdev
argument_list|,
name|ntohl
argument_list|(
name|xfer
operator|->
name|recv
operator|.
name|payload
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|xfer
operator|->
name|recv
operator|.
name|payload
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|FETCH_MGM
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sbp_targ_recv
parameter_list|(
name|struct
name|fw_xfer
modifier|*
name|xfer
parameter_list|)
block|{
name|struct
name|fw_pkt
modifier|*
name|fp
decl_stmt|,
modifier|*
name|sfp
decl_stmt|;
name|struct
name|fw_device
modifier|*
name|fwdev
decl_stmt|;
name|uint32_t
name|lo
decl_stmt|;
name|int
name|s
decl_stmt|,
name|rtcode
decl_stmt|;
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|s
operator|=
name|splfw
argument_list|()
expr_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|sbp_targ_softc
operator|*
operator|)
name|xfer
operator|->
name|sc
expr_stmt|;
name|fp
operator|=
operator|&
name|xfer
operator|->
name|recv
operator|.
name|hdr
expr_stmt|;
name|fwdev
operator|=
name|fw_noderesolve_nodeid
argument_list|(
name|sc
operator|->
name|fd
operator|.
name|fc
argument_list|,
name|fp
operator|->
name|mode
operator|.
name|wreqb
operator|.
name|src
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwdev
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: cannot resolve nodeid=%d\n"
argument_list|,
name|__func__
argument_list|,
name|fp
operator|->
name|mode
operator|.
name|wreqb
operator|.
name|src
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
name|rtcode
operator|=
name|RESP_TYPE_ERROR
expr_stmt|;
comment|/* XXX */
goto|goto
name|done
goto|;
block|}
name|lo
operator|=
name|fp
operator|->
name|mode
operator|.
name|wreqb
operator|.
name|dest_lo
expr_stmt|;
if|if
condition|(
name|lo
operator|==
name|SBP_TARG_BIND_LO
argument_list|(
operator|-
literal|1
argument_list|)
condition|)
name|rtcode
operator|=
name|sbp_targ_mgm
argument_list|(
name|xfer
argument_list|,
name|fwdev
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|lo
operator|>=
name|SBP_TARG_BIND_LO
argument_list|(
literal|0
argument_list|)
condition|)
name|rtcode
operator|=
name|sbp_targ_cmd
argument_list|(
name|xfer
argument_list|,
name|fwdev
argument_list|,
name|SBP_TARG_LOGIN_ID
argument_list|(
name|lo
argument_list|)
argument_list|,
name|lo
operator|%
literal|0x20
argument_list|)
expr_stmt|;
else|else
name|rtcode
operator|=
name|RESP_ADDRESS_ERROR
expr_stmt|;
name|done
label|:
if|if
condition|(
name|rtcode
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: rtcode = %d\n"
argument_list|,
name|__func__
argument_list|,
name|rtcode
argument_list|)
expr_stmt|;
name|sfp
operator|=
operator|&
name|xfer
operator|->
name|send
operator|.
name|hdr
expr_stmt|;
name|xfer
operator|->
name|send
operator|.
name|spd
operator|=
literal|2
expr_stmt|;
comment|/* XXX */
name|xfer
operator|->
name|hand
operator|=
name|sbp_targ_resp_callback
expr_stmt|;
name|sfp
operator|->
name|mode
operator|.
name|wres
operator|.
name|dst
operator|=
name|fp
operator|->
name|mode
operator|.
name|wreqb
operator|.
name|src
expr_stmt|;
name|sfp
operator|->
name|mode
operator|.
name|wres
operator|.
name|tlrt
operator|=
name|fp
operator|->
name|mode
operator|.
name|wreqb
operator|.
name|tlrt
expr_stmt|;
name|sfp
operator|->
name|mode
operator|.
name|wres
operator|.
name|tcode
operator|=
name|FWTCODE_WRES
expr_stmt|;
name|sfp
operator|->
name|mode
operator|.
name|wres
operator|.
name|rtcode
operator|=
name|rtcode
expr_stmt|;
name|sfp
operator|->
name|mode
operator|.
name|wres
operator|.
name|pri
operator|=
literal|0
expr_stmt|;
name|fw_asyreq
argument_list|(
name|xfer
operator|->
name|fc
argument_list|,
operator|-
literal|1
argument_list|,
name|xfer
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sbp_targ_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|cam_devq
modifier|*
name|devq
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|sbp_targ_softc
operator|*
operator|)
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sbp_targ_softc
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|fd
operator|.
name|fc
operator|=
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|fd
operator|.
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|fd
operator|.
name|post_explore
operator|=
operator|(
name|void
operator|*
operator|)
name|sbp_targ_post_explore
expr_stmt|;
name|sc
operator|->
name|fd
operator|.
name|post_busreset
operator|=
operator|(
name|void
operator|*
operator|)
name|sbp_targ_post_busreset
expr_stmt|;
name|devq
operator|=
name|cam_simq_alloc
argument_list|(
comment|/*maxopenings*/
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|devq
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|->
name|sim
operator|=
name|cam_sim_alloc
argument_list|(
name|sbp_targ_action
argument_list|,
name|sbp_targ_poll
argument_list|,
literal|"sbp_targ"
argument_list|,
name|sc
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|Giant
argument_list|,
comment|/*untagged*/
literal|1
argument_list|,
comment|/*tagged*/
literal|1
argument_list|,
name|devq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sim
operator|==
name|NULL
condition|)
block|{
name|cam_simq_free
argument_list|(
name|devq
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|xpt_bus_register
argument_list|(
name|sc
operator|->
name|sim
argument_list|,
comment|/*bus*/
literal|0
argument_list|)
operator|!=
name|CAM_SUCCESS
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|xpt_create_path
argument_list|(
operator|&
name|sc
operator|->
name|path
argument_list|,
comment|/*periph*/
name|NULL
argument_list|,
name|cam_sim_path
argument_list|(
name|sc
operator|->
name|sim
argument_list|)
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|sc
operator|->
name|sim
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|fwb
operator|.
name|start
operator|=
name|SBP_TARG_BIND_START
expr_stmt|;
name|sc
operator|->
name|fwb
operator|.
name|end
operator|=
name|SBP_TARG_BIND_END
expr_stmt|;
comment|/* pre-allocate xfer */
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|fwb
operator|.
name|xferlist
argument_list|)
expr_stmt|;
name|fw_xferlist_add
argument_list|(
operator|&
name|sc
operator|->
name|fwb
operator|.
name|xferlist
argument_list|,
name|M_SBP_TARG
argument_list|,
comment|/*send*/
literal|0
argument_list|,
comment|/*recv*/
name|SBP_TARG_RECV_LEN
argument_list|,
name|MAX_LUN
comment|/* XXX */
argument_list|,
name|sc
operator|->
name|fd
operator|.
name|fc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
argument_list|,
name|sbp_targ_recv
argument_list|)
expr_stmt|;
name|fw_bindadd
argument_list|(
name|sc
operator|->
name|fd
operator|.
name|fc
argument_list|,
operator|&
name|sc
operator|->
name|fwb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
name|cam_sim_free
argument_list|(
name|sc
operator|->
name|sim
argument_list|,
comment|/*free_devq*/
name|TRUE
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sbp_targ_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sbp_targ_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sbp_targ_lstate
modifier|*
name|lstate
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|sbp_targ_softc
operator|*
operator|)
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|fd
operator|.
name|post_busreset
operator|=
name|NULL
expr_stmt|;
name|xpt_free_path
argument_list|(
name|sc
operator|->
name|path
argument_list|)
expr_stmt|;
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|sc
operator|->
name|sim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|sc
operator|->
name|sim
argument_list|,
comment|/*free_devq*/
name|TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_LUN
condition|;
name|i
operator|++
control|)
block|{
name|lstate
operator|=
name|sc
operator|->
name|lstate
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|lstate
operator|!=
name|NULL
condition|)
block|{
name|xpt_free_path
argument_list|(
name|lstate
operator|->
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|lstate
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|black_hole
operator|!=
name|NULL
condition|)
block|{
name|xpt_free_path
argument_list|(
name|sc
operator|->
name|black_hole
operator|->
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
operator|->
name|black_hole
argument_list|,
name|M_SBP_TARG
argument_list|)
expr_stmt|;
block|}
name|fw_bindremove
argument_list|(
name|sc
operator|->
name|fd
operator|.
name|fc
argument_list|,
operator|&
name|sc
operator|->
name|fwb
argument_list|)
expr_stmt|;
name|fw_xferlist_remove
argument_list|(
operator|&
name|sc
operator|->
name|fwb
operator|.
name|xferlist
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|devclass_t
name|sbp_targ_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|sbp_targ_methods
index|[]
init|=
block|{
comment|/* device interface */
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|sbp_targ_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|sbp_targ_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|sbp_targ_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|sbp_targ_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|sbp_targ_driver
init|=
block|{
literal|"sbp_targ"
block|,
name|sbp_targ_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|sbp_targ_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|sbp_targ
argument_list|,
name|firewire
argument_list|,
name|sbp_targ_driver
argument_list|,
name|sbp_targ_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|sbp_targ
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|sbp_targ
argument_list|,
name|firewire
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|sbp_targ
argument_list|,
name|cam
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


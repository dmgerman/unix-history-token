begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: rf_sstf.c,v 1.6 2001/01/27 20:18:55 oster Exp $	*/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Copyright (c) 1995 Carnegie-Mellon University.  * All rights reserved.  *  * Author: Jim Zelenka  *  * Permission to use, copy, modify and distribute this software and  * its documentation is hereby granted, provided that both the copyright  * notice and this permission notice appear in all copies of the  * software, derivative works or modified versions, and any portions  * thereof, and that both notices appear in supporting documentation.  *  * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS"  * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND  * FOR ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.  *  * Carnegie Mellon requests users of this software to return to  *  *  Software Distribution Coordinator  or  Software.Distribution@CS.CMU.EDU  *  School of Computer Science  *  Carnegie Mellon University  *  Pittsburgh PA 15213-3890  *  * any improvements or extensions that they make and grant Carnegie the  * rights to redistribute these changes.  */
end_comment

begin_comment
comment|/*******************************************************************************  *  * sstf.c --  prioritized shortest seek time first disk queueing code  *  ******************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<dev/raidframe/rf_alloclist.h>
end_include

begin_include
include|#
directive|include
file|<dev/raidframe/rf_stripelocks.h>
end_include

begin_include
include|#
directive|include
file|<dev/raidframe/rf_layout.h>
end_include

begin_include
include|#
directive|include
file|<dev/raidframe/rf_diskqueue.h>
end_include

begin_include
include|#
directive|include
file|<dev/raidframe/rf_sstf.h>
end_include

begin_include
include|#
directive|include
file|<dev/raidframe/rf_debugMem.h>
end_include

begin_include
include|#
directive|include
file|<dev/raidframe/rf_general.h>
end_include

begin_include
include|#
directive|include
file|<dev/raidframe/rf_options.h>
end_include

begin_include
include|#
directive|include
file|<dev/raidframe/rf_raid.h>
end_include

begin_include
include|#
directive|include
file|<dev/raidframe/rf_types.h>
end_include

begin_define
define|#
directive|define
name|DIR_LEFT
value|1
end_define

begin_define
define|#
directive|define
name|DIR_RIGHT
value|2
end_define

begin_define
define|#
directive|define
name|DIR_EITHER
value|3
end_define

begin_define
define|#
directive|define
name|SNUM_DIFF
parameter_list|(
name|_a_
parameter_list|,
name|_b_
parameter_list|)
value|(((_a_)>(_b_))?((_a_)-(_b_)):((_b_)-(_a_)))
end_define

begin_define
define|#
directive|define
name|QSUM
parameter_list|(
name|_sstfq_
parameter_list|)
value|(((_sstfq_)->lopri.qlen)+((_sstfq_)->left.qlen)+((_sstfq_)->right.qlen))
end_define

begin_function_decl
specifier|static
name|void
name|do_sstf_ord_q
parameter_list|(
name|RF_DiskQueueData_t
modifier|*
modifier|*
parameter_list|,
name|RF_DiskQueueData_t
modifier|*
modifier|*
parameter_list|,
name|RF_DiskQueueData_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|RF_DiskQueueData_t
modifier|*
name|closest_to_arm
parameter_list|(
name|RF_SstfQ_t
modifier|*
parameter_list|,
name|RF_SectorNum_t
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_dequeue
parameter_list|(
name|RF_SstfQ_t
modifier|*
parameter_list|,
name|RF_DiskQueueData_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|do_sstf_ord_q
parameter_list|(
name|queuep
parameter_list|,
name|tailp
parameter_list|,
name|req
parameter_list|)
name|RF_DiskQueueData_t
modifier|*
modifier|*
name|queuep
decl_stmt|;
name|RF_DiskQueueData_t
modifier|*
modifier|*
name|tailp
decl_stmt|;
name|RF_DiskQueueData_t
modifier|*
name|req
decl_stmt|;
block|{
name|RF_DiskQueueData_t
modifier|*
name|r
decl_stmt|,
modifier|*
name|s
decl_stmt|;
if|if
condition|(
operator|*
name|queuep
operator|==
name|NULL
condition|)
block|{
operator|*
name|queuep
operator|=
name|req
expr_stmt|;
operator|*
name|tailp
operator|=
name|req
expr_stmt|;
name|req
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|req
operator|->
name|prev
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|req
operator|->
name|sectorOffset
operator|<=
operator|(
operator|*
name|queuep
operator|)
operator|->
name|sectorOffset
condition|)
block|{
name|req
operator|->
name|next
operator|=
operator|*
name|queuep
expr_stmt|;
name|req
operator|->
name|prev
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|queuep
operator|)
operator|->
name|prev
operator|=
name|req
expr_stmt|;
operator|*
name|queuep
operator|=
name|req
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|req
operator|->
name|sectorOffset
operator|>
operator|(
operator|*
name|tailp
operator|)
operator|->
name|sectorOffset
condition|)
block|{
comment|/* optimization */
name|r
operator|=
name|NULL
expr_stmt|;
name|s
operator|=
operator|*
name|tailp
expr_stmt|;
goto|goto
name|q_at_end
goto|;
block|}
for|for
control|(
name|s
operator|=
name|NULL
operator|,
name|r
operator|=
operator|*
name|queuep
init|;
name|r
condition|;
name|s
operator|=
name|r
operator|,
name|r
operator|=
name|r
operator|->
name|next
control|)
block|{
if|if
condition|(
name|r
operator|->
name|sectorOffset
operator|>=
name|req
operator|->
name|sectorOffset
condition|)
block|{
comment|/* insert after s, before r */
name|RF_ASSERT
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|req
operator|->
name|next
operator|=
name|r
expr_stmt|;
name|r
operator|->
name|prev
operator|=
name|req
expr_stmt|;
name|s
operator|->
name|next
operator|=
name|req
expr_stmt|;
name|req
operator|->
name|prev
operator|=
name|s
expr_stmt|;
return|return;
block|}
block|}
name|q_at_end
label|:
comment|/* insert after s, at end of queue */
name|RF_ASSERT
argument_list|(
name|r
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|s
operator|==
operator|(
operator|*
name|tailp
operator|)
argument_list|)
expr_stmt|;
name|req
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|req
operator|->
name|prev
operator|=
name|s
expr_stmt|;
name|s
operator|->
name|next
operator|=
name|req
expr_stmt|;
operator|*
name|tailp
operator|=
name|req
expr_stmt|;
block|}
end_function

begin_comment
comment|/* for removing from head-of-queue */
end_comment

begin_define
define|#
directive|define
name|DO_HEAD_DEQ
parameter_list|(
name|_r_
parameter_list|,
name|_q_
parameter_list|)
value|{ \ 	_r_ = (_q_)->queue; \ 	RF_ASSERT((_r_) != NULL); \ 	(_q_)->queue = (_r_)->next; \ 	(_q_)->qlen--; \ 	if ((_q_)->qlen == 0) { \ 		RF_ASSERT((_r_) == (_q_)->qtail); \ 		RF_ASSERT((_q_)->queue == NULL); \ 		(_q_)->qtail = NULL; \ 	} \ 	else { \ 		RF_ASSERT((_q_)->queue->prev == (_r_)); \ 		(_q_)->queue->prev = NULL; \ 	} \ }
end_define

begin_comment
comment|/* for removing from end-of-queue */
end_comment

begin_define
define|#
directive|define
name|DO_TAIL_DEQ
parameter_list|(
name|_r_
parameter_list|,
name|_q_
parameter_list|)
value|{ \ 	_r_ = (_q_)->qtail; \ 	RF_ASSERT((_r_) != NULL); \ 	(_q_)->qtail = (_r_)->prev; \ 	(_q_)->qlen--; \ 	if ((_q_)->qlen == 0) { \ 		RF_ASSERT((_r_) == (_q_)->queue); \ 		RF_ASSERT((_q_)->qtail == NULL); \ 		(_q_)->queue = NULL; \ 	} \ 	else { \ 		RF_ASSERT((_q_)->qtail->next == (_r_)); \ 		(_q_)->qtail->next = NULL; \ 	} \ }
end_define

begin_define
define|#
directive|define
name|DO_BEST_DEQ
parameter_list|(
name|_l_
parameter_list|,
name|_r_
parameter_list|,
name|_q_
parameter_list|)
value|{ \ 	if (SNUM_DIFF((_q_)->queue->sectorOffset,_l_) \< SNUM_DIFF((_q_)->qtail->sectorOffset,_l_)) \ 	{ \ 		DO_HEAD_DEQ(_r_,_q_); \ 	} \ 	else { \ 		DO_TAIL_DEQ(_r_,_q_); \ 	} \ }
end_define

begin_function
specifier|static
name|RF_DiskQueueData_t
modifier|*
name|closest_to_arm
parameter_list|(
name|queue
parameter_list|,
name|arm_pos
parameter_list|,
name|dir
parameter_list|,
name|allow_reverse
parameter_list|)
name|RF_SstfQ_t
modifier|*
name|queue
decl_stmt|;
name|RF_SectorNum_t
name|arm_pos
decl_stmt|;
name|int
modifier|*
name|dir
decl_stmt|;
name|int
name|allow_reverse
decl_stmt|;
block|{
name|RF_SectorNum_t
name|best_pos_l
init|=
literal|0
decl_stmt|,
name|this_pos_l
init|=
literal|0
decl_stmt|,
name|last_pos
init|=
literal|0
decl_stmt|;
name|RF_SectorNum_t
name|best_pos_r
init|=
literal|0
decl_stmt|,
name|this_pos_r
init|=
literal|0
decl_stmt|;
name|RF_DiskQueueData_t
modifier|*
name|r
decl_stmt|,
modifier|*
name|best_l
decl_stmt|,
modifier|*
name|best_r
decl_stmt|;
name|best_r
operator|=
name|best_l
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|r
operator|=
name|queue
operator|->
name|queue
init|;
name|r
condition|;
name|r
operator|=
name|r
operator|->
name|next
control|)
block|{
if|if
condition|(
name|r
operator|->
name|sectorOffset
operator|<
name|arm_pos
condition|)
block|{
if|if
condition|(
name|best_l
operator|==
name|NULL
condition|)
block|{
name|best_l
operator|=
name|r
expr_stmt|;
name|last_pos
operator|=
name|best_pos_l
operator|=
name|this_pos_l
expr_stmt|;
block|}
else|else
block|{
name|this_pos_l
operator|=
name|arm_pos
operator|-
name|r
operator|->
name|sectorOffset
expr_stmt|;
if|if
condition|(
name|this_pos_l
operator|<
name|best_pos_l
condition|)
block|{
name|best_l
operator|=
name|r
expr_stmt|;
name|last_pos
operator|=
name|best_pos_l
operator|=
name|this_pos_l
expr_stmt|;
block|}
else|else
block|{
name|last_pos
operator|=
name|this_pos_l
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|best_r
operator|==
name|NULL
condition|)
block|{
name|best_r
operator|=
name|r
expr_stmt|;
name|last_pos
operator|=
name|best_pos_r
operator|=
name|this_pos_r
expr_stmt|;
block|}
else|else
block|{
name|this_pos_r
operator|=
name|r
operator|->
name|sectorOffset
operator|-
name|arm_pos
expr_stmt|;
if|if
condition|(
name|this_pos_r
operator|<
name|best_pos_r
condition|)
block|{
name|best_r
operator|=
name|r
expr_stmt|;
name|last_pos
operator|=
name|best_pos_r
operator|=
name|this_pos_r
expr_stmt|;
block|}
else|else
block|{
name|last_pos
operator|=
name|this_pos_r
expr_stmt|;
block|}
if|if
condition|(
name|this_pos_r
operator|>
name|last_pos
condition|)
block|{
comment|/* getting farther away */
break|break;
block|}
block|}
block|}
block|}
if|if
condition|(
operator|(
name|best_r
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|best_l
operator|==
name|NULL
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
operator|(
operator|*
name|dir
operator|==
name|DIR_RIGHT
operator|)
operator|&&
name|best_r
condition|)
return|return
operator|(
name|best_r
operator|)
return|;
if|if
condition|(
operator|(
operator|*
name|dir
operator|==
name|DIR_LEFT
operator|)
operator|&&
name|best_l
condition|)
return|return
operator|(
name|best_l
operator|)
return|;
if|if
condition|(
operator|*
name|dir
operator|==
name|DIR_EITHER
condition|)
block|{
if|if
condition|(
name|best_l
operator|==
name|NULL
condition|)
return|return
operator|(
name|best_r
operator|)
return|;
if|if
condition|(
name|best_r
operator|==
name|NULL
condition|)
return|return
operator|(
name|best_l
operator|)
return|;
if|if
condition|(
name|best_pos_r
operator|<
name|best_pos_l
condition|)
return|return
operator|(
name|best_r
operator|)
return|;
else|else
return|return
operator|(
name|best_l
operator|)
return|;
block|}
comment|/* 	 * Nothing in the direction we want to go. Reverse or 	 * reset the arm. We know we have an I/O in the other 	 * direction. 	 */
if|if
condition|(
name|allow_reverse
condition|)
block|{
if|if
condition|(
operator|*
name|dir
operator|==
name|DIR_RIGHT
condition|)
block|{
operator|*
name|dir
operator|=
name|DIR_LEFT
expr_stmt|;
return|return
operator|(
name|best_l
operator|)
return|;
block|}
else|else
block|{
operator|*
name|dir
operator|=
name|DIR_RIGHT
expr_stmt|;
return|return
operator|(
name|best_r
operator|)
return|;
block|}
block|}
comment|/* 	 * Reset (beginning of queue). 	 */
name|RF_ASSERT
argument_list|(
operator|*
name|dir
operator|==
name|DIR_RIGHT
argument_list|)
expr_stmt|;
return|return
operator|(
name|queue
operator|->
name|queue
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|rf_SstfCreate
parameter_list|(
name|sect_per_disk
parameter_list|,
name|cl_list
parameter_list|,
name|listp
parameter_list|)
name|RF_SectorCount_t
name|sect_per_disk
decl_stmt|;
name|RF_AllocListElem_t
modifier|*
name|cl_list
decl_stmt|;
name|RF_ShutdownList_t
modifier|*
modifier|*
name|listp
decl_stmt|;
block|{
name|RF_Sstf_t
modifier|*
name|sstfq
decl_stmt|;
name|RF_CallocAndAdd
argument_list|(
name|sstfq
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|RF_Sstf_t
argument_list|)
argument_list|,
operator|(
name|RF_Sstf_t
operator|*
operator|)
argument_list|,
name|cl_list
argument_list|)
expr_stmt|;
name|sstfq
operator|->
name|dir
operator|=
name|DIR_EITHER
expr_stmt|;
name|sstfq
operator|->
name|allow_reverse
operator|=
literal|1
expr_stmt|;
return|return
operator|(
operator|(
name|void
operator|*
operator|)
name|sstfq
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|rf_ScanCreate
parameter_list|(
name|sect_per_disk
parameter_list|,
name|cl_list
parameter_list|,
name|listp
parameter_list|)
name|RF_SectorCount_t
name|sect_per_disk
decl_stmt|;
name|RF_AllocListElem_t
modifier|*
name|cl_list
decl_stmt|;
name|RF_ShutdownList_t
modifier|*
modifier|*
name|listp
decl_stmt|;
block|{
name|RF_Sstf_t
modifier|*
name|scanq
decl_stmt|;
name|RF_CallocAndAdd
argument_list|(
name|scanq
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|RF_Sstf_t
argument_list|)
argument_list|,
operator|(
name|RF_Sstf_t
operator|*
operator|)
argument_list|,
name|cl_list
argument_list|)
expr_stmt|;
name|scanq
operator|->
name|dir
operator|=
name|DIR_RIGHT
expr_stmt|;
name|scanq
operator|->
name|allow_reverse
operator|=
literal|1
expr_stmt|;
return|return
operator|(
operator|(
name|void
operator|*
operator|)
name|scanq
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|rf_CscanCreate
parameter_list|(
name|sect_per_disk
parameter_list|,
name|cl_list
parameter_list|,
name|listp
parameter_list|)
name|RF_SectorCount_t
name|sect_per_disk
decl_stmt|;
name|RF_AllocListElem_t
modifier|*
name|cl_list
decl_stmt|;
name|RF_ShutdownList_t
modifier|*
modifier|*
name|listp
decl_stmt|;
block|{
name|RF_Sstf_t
modifier|*
name|cscanq
decl_stmt|;
name|RF_CallocAndAdd
argument_list|(
name|cscanq
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|RF_Sstf_t
argument_list|)
argument_list|,
operator|(
name|RF_Sstf_t
operator|*
operator|)
argument_list|,
name|cl_list
argument_list|)
expr_stmt|;
name|cscanq
operator|->
name|dir
operator|=
name|DIR_RIGHT
expr_stmt|;
return|return
operator|(
operator|(
name|void
operator|*
operator|)
name|cscanq
operator|)
return|;
block|}
end_function

begin_function
name|void
name|rf_SstfEnqueue
parameter_list|(
name|qptr
parameter_list|,
name|req
parameter_list|,
name|priority
parameter_list|)
name|void
modifier|*
name|qptr
decl_stmt|;
name|RF_DiskQueueData_t
modifier|*
name|req
decl_stmt|;
name|int
name|priority
decl_stmt|;
block|{
name|RF_Sstf_t
modifier|*
name|sstfq
decl_stmt|;
name|sstfq
operator|=
operator|(
name|RF_Sstf_t
operator|*
operator|)
name|qptr
expr_stmt|;
if|if
condition|(
name|priority
operator|==
name|RF_IO_LOW_PRIORITY
condition|)
block|{
if|if
condition|(
name|rf_sstfDebug
operator|||
name|rf_scanDebug
operator|||
name|rf_cscanDebug
condition|)
block|{
name|RF_DiskQueue_t
modifier|*
name|dq
decl_stmt|;
name|dq
operator|=
operator|(
name|RF_DiskQueue_t
operator|*
operator|)
name|req
operator|->
name|queue
expr_stmt|;
name|printf
argument_list|(
literal|"raid%d: ENQ lopri %d,%d queues are %d,%d,%d\n"
argument_list|,
name|req
operator|->
name|raidPtr
operator|->
name|raidid
argument_list|,
name|dq
operator|->
name|row
argument_list|,
name|dq
operator|->
name|col
argument_list|,
name|sstfq
operator|->
name|left
operator|.
name|qlen
argument_list|,
name|sstfq
operator|->
name|right
operator|.
name|qlen
argument_list|,
name|sstfq
operator|->
name|lopri
operator|.
name|qlen
argument_list|)
expr_stmt|;
block|}
name|do_sstf_ord_q
argument_list|(
operator|&
name|sstfq
operator|->
name|lopri
operator|.
name|queue
argument_list|,
operator|&
name|sstfq
operator|->
name|lopri
operator|.
name|qtail
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|sstfq
operator|->
name|lopri
operator|.
name|qlen
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|req
operator|->
name|sectorOffset
operator|<
name|sstfq
operator|->
name|last_sector
condition|)
block|{
name|do_sstf_ord_q
argument_list|(
operator|&
name|sstfq
operator|->
name|left
operator|.
name|queue
argument_list|,
operator|&
name|sstfq
operator|->
name|left
operator|.
name|qtail
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|sstfq
operator|->
name|left
operator|.
name|qlen
operator|++
expr_stmt|;
block|}
else|else
block|{
name|do_sstf_ord_q
argument_list|(
operator|&
name|sstfq
operator|->
name|right
operator|.
name|queue
argument_list|,
operator|&
name|sstfq
operator|->
name|right
operator|.
name|qtail
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|sstfq
operator|->
name|right
operator|.
name|qlen
operator|++
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|do_dequeue
parameter_list|(
name|queue
parameter_list|,
name|req
parameter_list|)
name|RF_SstfQ_t
modifier|*
name|queue
decl_stmt|;
name|RF_DiskQueueData_t
modifier|*
name|req
decl_stmt|;
block|{
name|RF_DiskQueueData_t
modifier|*
name|req2
decl_stmt|;
if|if
condition|(
name|rf_sstfDebug
operator|||
name|rf_scanDebug
operator|||
name|rf_cscanDebug
condition|)
block|{
name|printf
argument_list|(
literal|"raid%d: do_dequeue\n"
argument_list|,
name|req
operator|->
name|raidPtr
operator|->
name|raidid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|req
operator|==
name|queue
operator|->
name|queue
condition|)
block|{
name|DO_HEAD_DEQ
argument_list|(
name|req2
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|req2
operator|==
name|req
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|req
operator|==
name|queue
operator|->
name|qtail
condition|)
block|{
name|DO_TAIL_DEQ
argument_list|(
name|req2
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|req2
operator|==
name|req
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* dequeue from middle of list */
name|RF_ASSERT
argument_list|(
name|req
operator|->
name|next
argument_list|)
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|req
operator|->
name|prev
argument_list|)
expr_stmt|;
name|queue
operator|->
name|qlen
operator|--
expr_stmt|;
name|req
operator|->
name|next
operator|->
name|prev
operator|=
name|req
operator|->
name|prev
expr_stmt|;
name|req
operator|->
name|prev
operator|->
name|next
operator|=
name|req
operator|->
name|next
expr_stmt|;
name|req
operator|->
name|next
operator|=
name|req
operator|->
name|prev
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|RF_DiskQueueData_t
modifier|*
name|rf_SstfDequeue
parameter_list|(
name|qptr
parameter_list|)
name|void
modifier|*
name|qptr
decl_stmt|;
block|{
name|RF_DiskQueueData_t
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|RF_Sstf_t
modifier|*
name|sstfq
decl_stmt|;
name|sstfq
operator|=
operator|(
name|RF_Sstf_t
operator|*
operator|)
name|qptr
expr_stmt|;
if|if
condition|(
name|rf_sstfDebug
condition|)
block|{
name|RF_DiskQueue_t
modifier|*
name|dq
decl_stmt|;
name|dq
operator|=
operator|(
name|RF_DiskQueue_t
operator|*
operator|)
name|req
operator|->
name|queue
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|QSUM
argument_list|(
name|sstfq
argument_list|)
operator|==
name|dq
operator|->
name|queueLength
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid%d: sstf: Dequeue %d,%d queues are %d,%d,%d\n"
argument_list|,
name|req
operator|->
name|raidPtr
operator|->
name|raidid
argument_list|,
name|dq
operator|->
name|row
argument_list|,
name|dq
operator|->
name|col
argument_list|,
name|sstfq
operator|->
name|left
operator|.
name|qlen
argument_list|,
name|sstfq
operator|->
name|right
operator|.
name|qlen
argument_list|,
name|sstfq
operator|->
name|lopri
operator|.
name|qlen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sstfq
operator|->
name|left
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|sstfq
operator|->
name|left
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sstfq
operator|->
name|right
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|sstfq
operator|->
name|right
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sstfq
operator|->
name|lopri
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|sstfq
operator|->
name|lopri
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|rf_sstfDebug
condition|)
block|{
name|printf
argument_list|(
literal|"raid%d: sstf: check for close lopri"
argument_list|,
name|req
operator|->
name|raidPtr
operator|->
name|raidid
argument_list|)
expr_stmt|;
block|}
name|req
operator|=
name|closest_to_arm
argument_list|(
operator|&
name|sstfq
operator|->
name|lopri
argument_list|,
name|sstfq
operator|->
name|last_sector
argument_list|,
operator|&
name|sstfq
operator|->
name|dir
argument_list|,
name|sstfq
operator|->
name|allow_reverse
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf_sstfDebug
condition|)
block|{
name|printf
argument_list|(
literal|"raid%d: sstf: closest_to_arm said %lx"
argument_list|,
name|req
operator|->
name|raidPtr
operator|->
name|raidid
argument_list|,
operator|(
name|long
operator|)
name|req
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|do_dequeue
argument_list|(
operator|&
name|sstfq
operator|->
name|lopri
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DO_BEST_DEQ
argument_list|(
name|sstfq
operator|->
name|last_sector
argument_list|,
name|req
argument_list|,
operator|&
name|sstfq
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|sstfq
operator|->
name|right
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|sstfq
operator|->
name|right
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
name|DO_BEST_DEQ
argument_list|(
name|sstfq
operator|->
name|last_sector
argument_list|,
name|req
argument_list|,
operator|&
name|sstfq
operator|->
name|left
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SNUM_DIFF
argument_list|(
name|sstfq
operator|->
name|last_sector
argument_list|,
name|sstfq
operator|->
name|right
operator|.
name|queue
operator|->
name|sectorOffset
argument_list|)
operator|<
name|SNUM_DIFF
argument_list|(
name|sstfq
operator|->
name|last_sector
argument_list|,
name|sstfq
operator|->
name|left
operator|.
name|qtail
operator|->
name|sectorOffset
argument_list|)
condition|)
block|{
name|DO_HEAD_DEQ
argument_list|(
name|req
argument_list|,
operator|&
name|sstfq
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DO_TAIL_DEQ
argument_list|(
name|req
argument_list|,
operator|&
name|sstfq
operator|->
name|left
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|RF_ASSERT
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|sstfq
operator|->
name|last_sector
operator|=
name|req
operator|->
name|sectorOffset
expr_stmt|;
return|return
operator|(
name|req
operator|)
return|;
block|}
end_function

begin_function
name|RF_DiskQueueData_t
modifier|*
name|rf_ScanDequeue
parameter_list|(
name|qptr
parameter_list|)
name|void
modifier|*
name|qptr
decl_stmt|;
block|{
name|RF_DiskQueueData_t
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|RF_Sstf_t
modifier|*
name|scanq
decl_stmt|;
name|scanq
operator|=
operator|(
name|RF_Sstf_t
operator|*
operator|)
name|qptr
expr_stmt|;
if|if
condition|(
name|rf_scanDebug
condition|)
block|{
name|RF_DiskQueue_t
modifier|*
name|dq
decl_stmt|;
name|dq
operator|=
operator|(
name|RF_DiskQueue_t
operator|*
operator|)
name|req
operator|->
name|queue
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|QSUM
argument_list|(
name|scanq
argument_list|)
operator|==
name|dq
operator|->
name|queueLength
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid%d: scan: Dequeue %d,%d queues are %d,%d,%d\n"
argument_list|,
name|req
operator|->
name|raidPtr
operator|->
name|raidid
argument_list|,
name|dq
operator|->
name|row
argument_list|,
name|dq
operator|->
name|col
argument_list|,
name|scanq
operator|->
name|left
operator|.
name|qlen
argument_list|,
name|scanq
operator|->
name|right
operator|.
name|qlen
argument_list|,
name|scanq
operator|->
name|lopri
operator|.
name|qlen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|scanq
operator|->
name|left
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|left
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|scanq
operator|->
name|right
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|right
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|scanq
operator|->
name|lopri
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|lopri
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|req
operator|=
name|closest_to_arm
argument_list|(
operator|&
name|scanq
operator|->
name|lopri
argument_list|,
name|scanq
operator|->
name|last_sector
argument_list|,
operator|&
name|scanq
operator|->
name|dir
argument_list|,
name|scanq
operator|->
name|allow_reverse
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|do_dequeue
argument_list|(
operator|&
name|scanq
operator|->
name|lopri
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|scanq
operator|->
name|dir
operator|=
name|DIR_RIGHT
expr_stmt|;
name|DO_HEAD_DEQ
argument_list|(
name|req
argument_list|,
operator|&
name|scanq
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|scanq
operator|->
name|right
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|right
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|left
operator|.
name|queue
argument_list|)
expr_stmt|;
name|scanq
operator|->
name|dir
operator|=
name|DIR_LEFT
expr_stmt|;
name|DO_TAIL_DEQ
argument_list|(
name|req
argument_list|,
operator|&
name|scanq
operator|->
name|left
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|right
operator|.
name|queue
argument_list|)
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|left
operator|.
name|queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|scanq
operator|->
name|dir
operator|==
name|DIR_RIGHT
condition|)
block|{
name|DO_HEAD_DEQ
argument_list|(
name|req
argument_list|,
operator|&
name|scanq
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DO_TAIL_DEQ
argument_list|(
name|req
argument_list|,
operator|&
name|scanq
operator|->
name|left
argument_list|)
expr_stmt|;
block|}
block|}
name|RF_ASSERT
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|scanq
operator|->
name|last_sector
operator|=
name|req
operator|->
name|sectorOffset
expr_stmt|;
return|return
operator|(
name|req
operator|)
return|;
block|}
end_function

begin_function
name|RF_DiskQueueData_t
modifier|*
name|rf_CscanDequeue
parameter_list|(
name|qptr
parameter_list|)
name|void
modifier|*
name|qptr
decl_stmt|;
block|{
name|RF_DiskQueueData_t
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|RF_Sstf_t
modifier|*
name|cscanq
decl_stmt|;
name|cscanq
operator|=
operator|(
name|RF_Sstf_t
operator|*
operator|)
name|qptr
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|cscanq
operator|->
name|dir
operator|==
name|DIR_RIGHT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf_cscanDebug
condition|)
block|{
name|RF_DiskQueue_t
modifier|*
name|dq
decl_stmt|;
name|dq
operator|=
operator|(
name|RF_DiskQueue_t
operator|*
operator|)
name|req
operator|->
name|queue
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|QSUM
argument_list|(
name|cscanq
argument_list|)
operator|==
name|dq
operator|->
name|queueLength
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"raid%d: scan: Dequeue %d,%d queues are %d,%d,%d\n"
argument_list|,
name|req
operator|->
name|raidPtr
operator|->
name|raidid
argument_list|,
name|dq
operator|->
name|row
argument_list|,
name|dq
operator|->
name|col
argument_list|,
name|cscanq
operator|->
name|left
operator|.
name|qlen
argument_list|,
name|cscanq
operator|->
name|right
operator|.
name|qlen
argument_list|,
name|cscanq
operator|->
name|lopri
operator|.
name|qlen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cscanq
operator|->
name|right
operator|.
name|queue
condition|)
block|{
name|DO_HEAD_DEQ
argument_list|(
name|req
argument_list|,
operator|&
name|cscanq
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|RF_ASSERT
argument_list|(
name|cscanq
operator|->
name|right
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cscanq
operator|->
name|left
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|cscanq
operator|->
name|left
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cscanq
operator|->
name|lopri
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|cscanq
operator|->
name|lopri
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|req
operator|=
name|closest_to_arm
argument_list|(
operator|&
name|cscanq
operator|->
name|lopri
argument_list|,
name|cscanq
operator|->
name|last_sector
argument_list|,
operator|&
name|cscanq
operator|->
name|dir
argument_list|,
name|cscanq
operator|->
name|allow_reverse
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|do_dequeue
argument_list|(
operator|&
name|cscanq
operator|->
name|lopri
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * There's I/Os to the left of the arm. Swing 			 * on back (swap queues). 			 */
name|cscanq
operator|->
name|right
operator|=
name|cscanq
operator|->
name|left
expr_stmt|;
name|cscanq
operator|->
name|left
operator|.
name|qlen
operator|=
literal|0
expr_stmt|;
name|cscanq
operator|->
name|left
operator|.
name|queue
operator|=
name|cscanq
operator|->
name|left
operator|.
name|qtail
operator|=
name|NULL
expr_stmt|;
name|DO_HEAD_DEQ
argument_list|(
name|req
argument_list|,
operator|&
name|cscanq
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
block|}
name|RF_ASSERT
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|cscanq
operator|->
name|last_sector
operator|=
name|req
operator|->
name|sectorOffset
expr_stmt|;
return|return
operator|(
name|req
operator|)
return|;
block|}
end_function

begin_function
name|RF_DiskQueueData_t
modifier|*
name|rf_SstfPeek
parameter_list|(
name|qptr
parameter_list|)
name|void
modifier|*
name|qptr
decl_stmt|;
block|{
name|RF_DiskQueueData_t
modifier|*
name|req
decl_stmt|;
name|RF_Sstf_t
modifier|*
name|sstfq
decl_stmt|;
name|sstfq
operator|=
operator|(
name|RF_Sstf_t
operator|*
operator|)
name|qptr
expr_stmt|;
if|if
condition|(
operator|(
name|sstfq
operator|->
name|left
operator|.
name|queue
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|sstfq
operator|->
name|right
operator|.
name|queue
operator|==
name|NULL
operator|)
condition|)
block|{
name|req
operator|=
name|closest_to_arm
argument_list|(
operator|&
name|sstfq
operator|->
name|lopri
argument_list|,
name|sstfq
operator|->
name|last_sector
argument_list|,
operator|&
name|sstfq
operator|->
name|dir
argument_list|,
name|sstfq
operator|->
name|allow_reverse
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sstfq
operator|->
name|left
operator|.
name|queue
operator|==
name|NULL
condition|)
name|req
operator|=
name|sstfq
operator|->
name|right
operator|.
name|queue
expr_stmt|;
else|else
block|{
if|if
condition|(
name|sstfq
operator|->
name|right
operator|.
name|queue
operator|==
name|NULL
condition|)
name|req
operator|=
name|sstfq
operator|->
name|left
operator|.
name|queue
expr_stmt|;
else|else
block|{
if|if
condition|(
name|SNUM_DIFF
argument_list|(
name|sstfq
operator|->
name|last_sector
argument_list|,
name|sstfq
operator|->
name|right
operator|.
name|queue
operator|->
name|sectorOffset
argument_list|)
operator|<
name|SNUM_DIFF
argument_list|(
name|sstfq
operator|->
name|last_sector
argument_list|,
name|sstfq
operator|->
name|left
operator|.
name|qtail
operator|->
name|sectorOffset
argument_list|)
condition|)
block|{
name|req
operator|=
name|sstfq
operator|->
name|right
operator|.
name|queue
expr_stmt|;
block|}
else|else
block|{
name|req
operator|=
name|sstfq
operator|->
name|left
operator|.
name|qtail
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|QSUM
argument_list|(
name|sstfq
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|req
operator|)
return|;
block|}
end_function

begin_function
name|RF_DiskQueueData_t
modifier|*
name|rf_ScanPeek
parameter_list|(
name|qptr
parameter_list|)
name|void
modifier|*
name|qptr
decl_stmt|;
block|{
name|RF_DiskQueueData_t
modifier|*
name|req
decl_stmt|;
name|RF_Sstf_t
modifier|*
name|scanq
decl_stmt|;
name|int
name|dir
decl_stmt|;
name|scanq
operator|=
operator|(
name|RF_Sstf_t
operator|*
operator|)
name|qptr
expr_stmt|;
name|dir
operator|=
name|scanq
operator|->
name|dir
expr_stmt|;
if|if
condition|(
name|scanq
operator|->
name|left
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|left
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|scanq
operator|->
name|right
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|right
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|scanq
operator|->
name|lopri
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|lopri
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|req
operator|=
name|closest_to_arm
argument_list|(
operator|&
name|scanq
operator|->
name|lopri
argument_list|,
name|scanq
operator|->
name|last_sector
argument_list|,
operator|&
name|dir
argument_list|,
name|scanq
operator|->
name|allow_reverse
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|req
operator|=
name|scanq
operator|->
name|right
operator|.
name|queue
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|scanq
operator|->
name|right
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|right
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|left
operator|.
name|queue
argument_list|)
expr_stmt|;
name|req
operator|=
name|scanq
operator|->
name|left
operator|.
name|qtail
expr_stmt|;
block|}
else|else
block|{
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|right
operator|.
name|queue
argument_list|)
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|scanq
operator|->
name|left
operator|.
name|queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|scanq
operator|->
name|dir
operator|==
name|DIR_RIGHT
condition|)
block|{
name|req
operator|=
name|scanq
operator|->
name|right
operator|.
name|queue
expr_stmt|;
block|}
else|else
block|{
name|req
operator|=
name|scanq
operator|->
name|left
operator|.
name|qtail
expr_stmt|;
block|}
block|}
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|QSUM
argument_list|(
name|scanq
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|req
operator|)
return|;
block|}
end_function

begin_function
name|RF_DiskQueueData_t
modifier|*
name|rf_CscanPeek
parameter_list|(
name|qptr
parameter_list|)
name|void
modifier|*
name|qptr
decl_stmt|;
block|{
name|RF_DiskQueueData_t
modifier|*
name|req
decl_stmt|;
name|RF_Sstf_t
modifier|*
name|cscanq
decl_stmt|;
name|cscanq
operator|=
operator|(
name|RF_Sstf_t
operator|*
operator|)
name|qptr
expr_stmt|;
name|RF_ASSERT
argument_list|(
name|cscanq
operator|->
name|dir
operator|==
name|DIR_RIGHT
argument_list|)
expr_stmt|;
if|if
condition|(
name|cscanq
operator|->
name|right
operator|.
name|queue
condition|)
block|{
name|req
operator|=
name|cscanq
operator|->
name|right
operator|.
name|queue
expr_stmt|;
block|}
else|else
block|{
name|RF_ASSERT
argument_list|(
name|cscanq
operator|->
name|right
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cscanq
operator|->
name|left
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|cscanq
operator|->
name|left
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cscanq
operator|->
name|lopri
operator|.
name|queue
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|cscanq
operator|->
name|lopri
operator|.
name|qlen
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|req
operator|=
name|closest_to_arm
argument_list|(
operator|&
name|cscanq
operator|->
name|lopri
argument_list|,
name|cscanq
operator|->
name|last_sector
argument_list|,
operator|&
name|cscanq
operator|->
name|dir
argument_list|,
name|cscanq
operator|->
name|allow_reverse
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * There's I/Os to the left of the arm. We'll end 			 * up swinging on back. 			 */
name|req
operator|=
name|cscanq
operator|->
name|left
operator|.
name|queue
expr_stmt|;
block|}
block|}
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|RF_ASSERT
argument_list|(
name|QSUM
argument_list|(
name|cscanq
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|req
operator|)
return|;
block|}
end_function

begin_function
name|int
name|rf_SstfPromote
parameter_list|(
name|qptr
parameter_list|,
name|parityStripeID
parameter_list|,
name|which_ru
parameter_list|)
name|void
modifier|*
name|qptr
decl_stmt|;
name|RF_StripeNum_t
name|parityStripeID
decl_stmt|;
name|RF_ReconUnitNum_t
name|which_ru
decl_stmt|;
block|{
name|RF_DiskQueueData_t
modifier|*
name|r
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|RF_Sstf_t
modifier|*
name|sstfq
decl_stmt|;
name|int
name|n
decl_stmt|;
name|sstfq
operator|=
operator|(
name|RF_Sstf_t
operator|*
operator|)
name|qptr
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|r
operator|=
name|sstfq
operator|->
name|lopri
operator|.
name|queue
init|;
name|r
condition|;
name|r
operator|=
name|next
control|)
block|{
name|next
operator|=
name|r
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|rf_sstfDebug
operator|||
name|rf_scanDebug
operator|||
name|rf_cscanDebug
condition|)
block|{
name|printf
argument_list|(
literal|"raid%d: check promote %lx\n"
argument_list|,
name|r
operator|->
name|raidPtr
operator|->
name|raidid
argument_list|,
operator|(
name|long
operator|)
name|r
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|r
operator|->
name|parityStripeID
operator|==
name|parityStripeID
operator|)
operator|&&
operator|(
name|r
operator|->
name|which_ru
operator|==
name|which_ru
operator|)
condition|)
block|{
name|do_dequeue
argument_list|(
operator|&
name|sstfq
operator|->
name|lopri
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|rf_SstfEnqueue
argument_list|(
name|qptr
argument_list|,
name|r
argument_list|,
name|RF_IO_NORMAL_PRIORITY
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rf_sstfDebug
operator|||
name|rf_scanDebug
operator|||
name|rf_cscanDebug
condition|)
block|{
name|printf
argument_list|(
literal|"raid%d: promoted %d matching I/Os queues are %d,%d,%d\n"
argument_list|,
name|r
operator|->
name|raidPtr
operator|->
name|raidid
argument_list|,
name|n
argument_list|,
name|sstfq
operator|->
name|left
operator|.
name|qlen
argument_list|,
name|sstfq
operator|->
name|right
operator|.
name|qlen
argument_list|,
name|sstfq
operator|->
name|lopri
operator|.
name|qlen
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|n
operator|)
return|;
block|}
end_function

end_unit


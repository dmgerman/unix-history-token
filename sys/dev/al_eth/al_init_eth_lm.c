begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015,2016 Annapurna Labs Ltd. and affiliates  * All rights reserved.  *  * Developed by Semihalf.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"al_init_eth_lm.h"
end_include

begin_include
include|#
directive|include
file|"al_serdes.h"
end_include

begin_include
include|#
directive|include
file|"al_hal_eth.h"
end_include

begin_include
include|#
directive|include
file|"al_init_eth_kr.h"
end_include

begin_comment
comment|/**  *  @{  * @file   al_init_eth_lm.c  *  * @brief ethernet link management common utilities  *  */
end_comment

begin_comment
comment|/* delay before checking link status with new serdes parameters (uSec) */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_LM_LINK_STATUS_DELAY
value|1000
end_define

begin_comment
comment|/* delay before checking link status after reconfiguring the retimer (uSec) */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_LM_RETIMER_LINK_STATUS_DELAY
value|50000
end_define

begin_define
define|#
directive|define
name|AL_ETH_LM_EQ_ITERATIONS
value|15
end_define

begin_define
define|#
directive|define
name|AL_ETH_LM_MAX_DCGAIN
value|8
end_define

begin_comment
comment|/* num of link training failures till serdes reset */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_LT_FAILURES_TO_RESET
value|10
end_define

begin_define
define|#
directive|define
name|MODULE_IDENTIFIER_IDX
value|0
end_define

begin_define
define|#
directive|define
name|MODULE_IDENTIFIER_SFP
value|0x3
end_define

begin_define
define|#
directive|define
name|MODULE_IDENTIFIER_QSFP
value|0xd
end_define

begin_define
define|#
directive|define
name|SFP_PRESENT
value|0
end_define

begin_define
define|#
directive|define
name|SFP_NOT_PRESENT
value|1
end_define

begin_comment
comment|/* SFP+ module */
end_comment

begin_define
define|#
directive|define
name|SFP_I2C_HEADER_10G_IDX
value|3
end_define

begin_define
define|#
directive|define
name|SFP_I2C_HEADER_10G_DA_IDX
value|8
end_define

begin_define
define|#
directive|define
name|SFP_I2C_HEADER_10G_DA_LEN_IDX
value|18
end_define

begin_define
define|#
directive|define
name|SFP_I2C_HEADER_1G_IDX
value|6
end_define

begin_define
define|#
directive|define
name|SFP_I2C_HEADER_SIGNAL_RATE
value|12
end_define

begin_comment
comment|/* Nominal signaling rate, units of 100MBd. */
end_comment

begin_define
define|#
directive|define
name|SFP_MIN_SIGNAL_RATE_25G
value|250
end_define

begin_define
define|#
directive|define
name|SFP_MIN_SIGNAL_RATE_10G
value|100
end_define

begin_comment
comment|/* QSFP+ module */
end_comment

begin_define
define|#
directive|define
name|QSFP_COMPLIANCE_CODE_IDX
value|131
end_define

begin_comment
comment|/* 40GBASE-LR4 and 40GBASE-SR4 are optic modules */
end_comment

begin_define
define|#
directive|define
name|QSFP_COMPLIANCE_CODE_OPTIC
value|((1<< 1) | (1<< 2))
end_define

begin_define
define|#
directive|define
name|QSFP_COMPLIANCE_CODE_DAC
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|QSFP_CABLE_LEN_IDX
value|146
end_define

begin_comment
comment|/* TODO: need to check the necessary delay */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_LM_RETIMER_WAIT_FOR_LOCK
value|500
end_define

begin_comment
comment|/* delay after retimer reset to lock (mSec) */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_LM_SERDES_WAIT_FOR_LOCK
value|50
end_define

begin_comment
comment|/* delay after signal detect to lock (mSec) */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_LM_GEARBOX_RESET_DELAY
value|1000
end_define

begin_comment
comment|/* (uSec) */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|al_eth_retimer_boost_addr
index|[
name|AL_ETH_RETIMER_CHANNEL_MAX
index|]
index|[
name|AL_ETH_RETIMER_TYPE_MAX
index|]
init|=
block|{
comment|/* BR_210  |  BR_410 */
comment|/* AL_ETH_RETIMER_CHANNEL_A */
block|{
literal|0xf
block|,
literal|0x1a
block|}
block|,
comment|/* AL_ETH_RETIMER_CHANNEL_B */
block|{
literal|0x16
block|,
literal|0x18
block|}
block|,
comment|/* AL_ETH_RETIMER_CHANNEL_C */
block|{
literal|0x0
block|,
literal|0x16
block|}
block|,
comment|/* AL_ETH_RETIMER_CHANNEL_D */
block|{
literal|0x0
block|,
literal|0x14
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|RETIMER_LENS_MAX
value|5
end_define

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|al_eth_retimer_boost_lens
index|[
name|RETIMER_LENS_MAX
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|5
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|al_eth_retimer_boost_value
index|[
name|RETIMER_LENS_MAX
operator|+
literal|1
index|]
index|[
name|AL_ETH_RETIMER_TYPE_MAX
index|]
init|=
block|{
comment|/* BR_210  |  BR_410 */
comment|/* 0 */
block|{
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* 1 */
block|{
literal|0x1
block|,
literal|0x1
block|}
block|,
comment|/* 2 */
block|{
literal|0x2
block|,
literal|0x1
block|}
block|,
comment|/* 3 */
block|{
literal|0x3
block|,
literal|0x3
block|}
block|,
comment|/* 5 */
block|{
literal|0x7
block|,
literal|0x3
block|}
block|,
comment|/* 5+ */
block|{
literal|0xb
block|,
literal|0x7
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|retimer_config_reg
block|{
name|uint8_t
name|addr
decl_stmt|;
name|uint8_t
name|value
decl_stmt|;
name|uint8_t
name|mask
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|retimer_config_reg
name|retimer_ds25_25g_mode_tx_ch
index|[]
init|=
block|{
block|{
operator|.
name|addr
operator|=
literal|0x0A
block|,
operator|.
name|value
operator|=
literal|0x0C
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x2F
block|,
operator|.
name|value
operator|=
literal|0x54
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x31
block|,
operator|.
name|value
operator|=
literal|0x20
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x1E
block|,
operator|.
name|value
operator|=
literal|0xE9
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x1F
block|,
operator|.
name|value
operator|=
literal|0x0B
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0xA6
block|,
operator|.
name|value
operator|=
literal|0x43
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x2A
block|,
operator|.
name|value
operator|=
literal|0x5A
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x2B
block|,
operator|.
name|value
operator|=
literal|0x0A
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x2C
block|,
operator|.
name|value
operator|=
literal|0xF6
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x70
block|,
operator|.
name|value
operator|=
literal|0x05
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x6A
block|,
operator|.
name|value
operator|=
literal|0x21
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x35
block|,
operator|.
name|value
operator|=
literal|0x0F
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x12
block|,
operator|.
name|value
operator|=
literal|0x83
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x9C
block|,
operator|.
name|value
operator|=
literal|0x24
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x98
block|,
operator|.
name|value
operator|=
literal|0x00
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x42
block|,
operator|.
name|value
operator|=
literal|0x50
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x44
block|,
operator|.
name|value
operator|=
literal|0x90
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x45
block|,
operator|.
name|value
operator|=
literal|0xC0
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x46
block|,
operator|.
name|value
operator|=
literal|0xD0
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x47
block|,
operator|.
name|value
operator|=
literal|0xD1
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x48
block|,
operator|.
name|value
operator|=
literal|0xD5
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x49
block|,
operator|.
name|value
operator|=
literal|0xD8
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x4A
block|,
operator|.
name|value
operator|=
literal|0xEA
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x4B
block|,
operator|.
name|value
operator|=
literal|0xF7
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x4C
block|,
operator|.
name|value
operator|=
literal|0xFD
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x8E
block|,
operator|.
name|value
operator|=
literal|0x00
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x3D
block|,
operator|.
name|value
operator|=
literal|0x94
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x3F
block|,
operator|.
name|value
operator|=
literal|0x40
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x3E
block|,
operator|.
name|value
operator|=
literal|0x43
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x0A
block|,
operator|.
name|value
operator|=
literal|0x00
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|retimer_config_reg
name|retimer_ds25_25g_mode_rx_ch
index|[]
init|=
block|{
block|{
operator|.
name|addr
operator|=
literal|0x0A
block|,
operator|.
name|value
operator|=
literal|0x0C
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x2F
block|,
operator|.
name|value
operator|=
literal|0x54
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x31
block|,
operator|.
name|value
operator|=
literal|0x40
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x1E
block|,
operator|.
name|value
operator|=
literal|0xE3
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x1F
block|,
operator|.
name|value
operator|=
literal|0x0B
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0xA6
block|,
operator|.
name|value
operator|=
literal|0x43
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x2A
block|,
operator|.
name|value
operator|=
literal|0x5A
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x2B
block|,
operator|.
name|value
operator|=
literal|0x0A
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x2C
block|,
operator|.
name|value
operator|=
literal|0xF6
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x70
block|,
operator|.
name|value
operator|=
literal|0x05
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x6A
block|,
operator|.
name|value
operator|=
literal|0x21
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x35
block|,
operator|.
name|value
operator|=
literal|0x0F
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x12
block|,
operator|.
name|value
operator|=
literal|0x83
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x9C
block|,
operator|.
name|value
operator|=
literal|0x24
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x98
block|,
operator|.
name|value
operator|=
literal|0x00
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x42
block|,
operator|.
name|value
operator|=
literal|0x50
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x44
block|,
operator|.
name|value
operator|=
literal|0x90
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x45
block|,
operator|.
name|value
operator|=
literal|0xC0
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x46
block|,
operator|.
name|value
operator|=
literal|0xD0
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x47
block|,
operator|.
name|value
operator|=
literal|0xD1
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x48
block|,
operator|.
name|value
operator|=
literal|0xD5
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x49
block|,
operator|.
name|value
operator|=
literal|0xD8
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x4A
block|,
operator|.
name|value
operator|=
literal|0xEA
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x4B
block|,
operator|.
name|value
operator|=
literal|0xF7
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x4C
block|,
operator|.
name|value
operator|=
literal|0xFD
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x8E
block|,
operator|.
name|value
operator|=
literal|0x00
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x3D
block|,
operator|.
name|value
operator|=
literal|0x94
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x3F
block|,
operator|.
name|value
operator|=
literal|0x40
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x3E
block|,
operator|.
name|value
operator|=
literal|0x43
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|,
block|{
operator|.
name|addr
operator|=
literal|0x0A
block|,
operator|.
name|value
operator|=
literal|0x00
block|,
operator|.
name|mask
operator|=
literal|0xff
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|retimer_config_reg
name|retimer_ds25_10g_mode
index|[]
init|=
block|{
comment|/* Assert CDR reset (6.3) */
block|{
operator|.
name|addr
operator|=
literal|0x0A
block|,
operator|.
name|value
operator|=
literal|0x0C
block|,
operator|.
name|mask
operator|=
literal|0x0C
block|}
block|,
comment|/* Select 10.3125Gbps standard rate mode (6.6) */
block|{
operator|.
name|addr
operator|=
literal|0x2F
block|,
operator|.
name|value
operator|=
literal|0x00
block|,
operator|.
name|mask
operator|=
literal|0xF0
block|}
block|,
comment|/* Enable loop filter auto-adjust */
block|{
operator|.
name|addr
operator|=
literal|0x1F
block|,
operator|.
name|value
operator|=
literal|0x08
block|,
operator|.
name|mask
operator|=
literal|0x08
block|}
block|,
comment|/* Set Adapt Mode 1 (6.13) */
block|{
operator|.
name|addr
operator|=
literal|0x31
block|,
operator|.
name|value
operator|=
literal|0x20
block|,
operator|.
name|mask
operator|=
literal|0x60
block|}
block|,
comment|/* Disable the DFE since most applications do not need it (6.18) */
block|{
operator|.
name|addr
operator|=
literal|0x1E
block|,
operator|.
name|value
operator|=
literal|0x08
block|,
operator|.
name|mask
operator|=
literal|0x08
block|}
block|,
comment|/* Release CDR reset (6.4) */
block|{
operator|.
name|addr
operator|=
literal|0x0A
block|,
operator|.
name|value
operator|=
literal|0x00
block|,
operator|.
name|mask
operator|=
literal|0x0C
block|}
block|,
comment|/* Enable FIR (6.12) */
block|{
operator|.
name|addr
operator|=
literal|0x3D
block|,
operator|.
name|value
operator|=
literal|0x80
block|,
operator|.
name|mask
operator|=
literal|0x80
block|}
block|,
comment|/* Set Main-cursor tap sign to positive (6.12) */
block|{
operator|.
name|addr
operator|=
literal|0x3D
block|,
operator|.
name|value
operator|=
literal|0x00
block|,
operator|.
name|mask
operator|=
literal|0x40
block|}
block|,
comment|/* Set Post-cursor tap sign to negative (6.12) */
block|{
operator|.
name|addr
operator|=
literal|0x3F
block|,
operator|.
name|value
operator|=
literal|0x40
block|,
operator|.
name|mask
operator|=
literal|0x40
block|}
block|,
comment|/* Set Pre-cursor tap sign to negative (6.12) */
block|{
operator|.
name|addr
operator|=
literal|0x3E
block|,
operator|.
name|value
operator|=
literal|0x40
block|,
operator|.
name|mask
operator|=
literal|0x40
block|}
block|,
comment|/* Set Main-cursor tap magnitude to 13 (6.12) */
block|{
operator|.
name|addr
operator|=
literal|0x3D
block|,
operator|.
name|value
operator|=
literal|0x0D
block|,
operator|.
name|mask
operator|=
literal|0x1F
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|al_eth_lm_retimer_boost_config
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|al_eth_lm_retimer_ds25_full_config
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|al_bool
name|al_eth_lm_retimer_ds25_signal_detect
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|al_eth_lm_retimer_ds25_cdr_reset
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|al_bool
name|al_eth_lm_retimer_ds25_cdr_lock
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|al_eth_lm_retimer_25g_rx_adaptation
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|al_eth_lm_retimer
block|{
name|int
function_decl|(
modifier|*
name|config
function_decl|)
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|reset
function_decl|)
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|signal_detect
function_decl|)
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|cdr_lock
function_decl|)
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|rx_adaptation
function_decl|)
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|al_eth_lm_retimer
name|retimer
index|[]
init|=
block|{
block|{
operator|.
name|config
operator|=
name|al_eth_lm_retimer_boost_config
block|,
operator|.
name|signal_detect
operator|=
name|NULL
block|,
operator|.
name|reset
operator|=
name|NULL
block|,
operator|.
name|cdr_lock
operator|=
name|NULL
block|,
operator|.
name|rx_adaptation
operator|=
name|NULL
block|}
block|,
block|{
operator|.
name|config
operator|=
name|al_eth_lm_retimer_boost_config
block|,
operator|.
name|signal_detect
operator|=
name|NULL
block|,
operator|.
name|reset
operator|=
name|NULL
block|,
operator|.
name|cdr_lock
operator|=
name|NULL
block|,
operator|.
name|rx_adaptation
operator|=
name|NULL
block|}
block|,
block|{
operator|.
name|config
operator|=
name|al_eth_lm_retimer_ds25_full_config
block|,
operator|.
name|signal_detect
operator|=
name|al_eth_lm_retimer_ds25_signal_detect
block|,
operator|.
name|reset
operator|=
name|al_eth_lm_retimer_ds25_cdr_reset
block|,
operator|.
name|cdr_lock
operator|=
name|al_eth_lm_retimer_ds25_cdr_lock
block|,
operator|.
name|rx_adaptation
operator|=
name|al_eth_lm_retimer_25g_rx_adaptation
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SFP_10G_DA_ACTIVE
value|0x8
end_define

begin_define
define|#
directive|define
name|SFP_10G_DA_PASSIVE
value|0x4
end_define

begin_define
define|#
directive|define
name|lm_debug
parameter_list|(
modifier|...
parameter_list|)
define|\
value|do {					\ 		if (lm_context->debug)		\ 			al_warn(__VA_ARGS__);	\ 		else				\ 			al_dbg(__VA_ARGS__);	\ 	} while (0)
end_define

begin_function
specifier|static
name|int
name|al_eth_sfp_detect
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|enum
name|al_eth_lm_link_mode
modifier|*
name|new_mode
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
name|sfp_10g
decl_stmt|;
name|uint8_t
name|sfp_1g
decl_stmt|;
name|uint8_t
name|sfp_cable_tech
decl_stmt|;
name|uint8_t
name|sfp_da_len
decl_stmt|;
name|uint8_t
name|signal_rate
decl_stmt|;
do|do
block|{
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|sfp_bus_id
argument_list|,
name|lm_context
operator|->
name|sfp_i2c_addr
argument_list|,
name|SFP_I2C_HEADER_10G_IDX
argument_list|,
operator|&
name|sfp_10g
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
break|break;
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|sfp_bus_id
argument_list|,
name|lm_context
operator|->
name|sfp_i2c_addr
argument_list|,
name|SFP_I2C_HEADER_1G_IDX
argument_list|,
operator|&
name|sfp_1g
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
break|break;
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|sfp_bus_id
argument_list|,
name|lm_context
operator|->
name|sfp_i2c_addr
argument_list|,
name|SFP_I2C_HEADER_10G_DA_IDX
argument_list|,
operator|&
name|sfp_cable_tech
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
break|break;
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|sfp_bus_id
argument_list|,
name|lm_context
operator|->
name|sfp_i2c_addr
argument_list|,
name|SFP_I2C_HEADER_10G_DA_LEN_IDX
argument_list|,
operator|&
name|sfp_da_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
break|break;
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|sfp_bus_id
argument_list|,
name|lm_context
operator|->
name|sfp_i2c_addr
argument_list|,
name|SFP_I2C_HEADER_SIGNAL_RATE
argument_list|,
operator|&
name|signal_rate
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|rc
operator|==
name|ETIMEDOUT
condition|)
block|{
comment|/* ETIMEDOUT is returned when no SFP is connected */
if|if
condition|(
name|lm_context
operator|->
name|mode
operator|!=
name|AL_ETH_LM_MODE_DISCONNECTED
condition|)
name|lm_debug
argument_list|(
literal|"%s: SFP Disconnected\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_DISCONNECTED
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
name|rc
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|sfp_cable_tech
operator|&
operator|(
name|SFP_10G_DA_PASSIVE
operator||
name|SFP_10G_DA_ACTIVE
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|signal_rate
operator|>=
name|SFP_MIN_SIGNAL_RATE_25G
operator|)
operator|&&
operator|(
operator|(
name|lm_context
operator|->
name|max_speed
operator|==
name|AL_ETH_LM_MAX_SPEED_25G
operator|)
operator|||
operator|(
name|lm_context
operator|->
name|max_speed
operator|==
name|AL_ETH_LM_MAX_SPEED_MAX
operator|)
operator|)
condition|)
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_25G
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|signal_rate
operator|>=
name|SFP_MIN_SIGNAL_RATE_10G
operator|)
operator|&&
operator|(
operator|(
name|lm_context
operator|->
name|max_speed
operator|==
name|AL_ETH_LM_MAX_SPEED_10G
operator|)
operator|||
operator|(
name|lm_context
operator|->
name|max_speed
operator|==
name|AL_ETH_LM_MAX_SPEED_MAX
operator|)
operator|)
condition|)
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_10G_DA
expr_stmt|;
else|else
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_1G
expr_stmt|;
name|lm_debug
argument_list|(
literal|"%s: %s DAC (%d M) detected (max signal rate %d)\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|sfp_cable_tech
operator|&
name|SFP_10G_DA_PASSIVE
operator|)
condition|?
literal|"Passive"
else|:
literal|"Active"
argument_list|,
name|sfp_da_len
argument_list|,
name|signal_rate
argument_list|)
expr_stmt|;
comment|/* for active direct attached need to use len 0 in the retimer configuration */
name|lm_context
operator|->
name|da_len
operator|=
operator|(
name|sfp_cable_tech
operator|&
name|SFP_10G_DA_PASSIVE
operator|)
condition|?
name|sfp_da_len
else|:
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sfp_10g
operator|!=
literal|0
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: 10 SFP detected\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_10G_OPTIC
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sfp_1g
operator|!=
literal|0
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: 1G SFP detected\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_1G
expr_stmt|;
block|}
else|else
block|{
name|al_warn
argument_list|(
literal|"%s: unknown SFP inserted. eeprom content: 10G compliance 0x%x,"
literal|" 1G compliance 0x%x, sfp+cable 0x%x. default to %s\n"
argument_list|,
name|__func__
argument_list|,
name|sfp_10g
argument_list|,
name|sfp_1g
argument_list|,
name|sfp_cable_tech
argument_list|,
name|al_eth_lm_mode_convert_to_str
argument_list|(
name|lm_context
operator|->
name|default_mode
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|lm_context
operator|->
name|default_mode
expr_stmt|;
name|lm_context
operator|->
name|da_len
operator|=
name|lm_context
operator|->
name|default_dac_len
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|lm_context
operator|->
name|sfp_detect_force_mode
operator|)
operator|&&
operator|(
operator|*
name|new_mode
operator|!=
name|AL_ETH_LM_MODE_DISCONNECTED
operator|)
operator|&&
operator|(
operator|*
name|new_mode
operator|!=
name|lm_context
operator|->
name|default_mode
operator|)
condition|)
block|{
name|al_warn
argument_list|(
literal|"%s: Force mode to default (%s). mode based of the SFP EEPROM %s\n"
argument_list|,
name|__func__
argument_list|,
name|al_eth_lm_mode_convert_to_str
argument_list|(
name|lm_context
operator|->
name|default_mode
argument_list|)
argument_list|,
name|al_eth_lm_mode_convert_to_str
argument_list|(
operator|*
name|new_mode
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|lm_context
operator|->
name|default_mode
expr_stmt|;
block|}
name|lm_context
operator|->
name|mode
operator|=
operator|*
name|new_mode
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_qsfp_detect
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|enum
name|al_eth_lm_link_mode
modifier|*
name|new_mode
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
name|qsfp_comp_code
decl_stmt|;
name|uint8_t
name|qsfp_da_len
decl_stmt|;
do|do
block|{
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|sfp_bus_id
argument_list|,
name|lm_context
operator|->
name|sfp_i2c_addr
argument_list|,
name|QSFP_COMPLIANCE_CODE_IDX
argument_list|,
operator|&
name|qsfp_comp_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
break|break;
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|sfp_bus_id
argument_list|,
name|lm_context
operator|->
name|sfp_i2c_addr
argument_list|,
name|QSFP_CABLE_LEN_IDX
argument_list|,
operator|&
name|qsfp_da_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
break|break;
block|}
do|while
condition|(
literal|0
condition|)
do|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|rc
operator|==
name|ETIMEDOUT
condition|)
block|{
comment|/* ETIMEDOUT is returned when no SFP is connected */
name|lm_debug
argument_list|(
literal|"%s: SFP Disconnected\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_DISCONNECTED
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
name|rc
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|qsfp_comp_code
operator|&
name|QSFP_COMPLIANCE_CODE_DAC
operator|)
operator|!=
literal|0
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: 10G passive DAC (%d M) detected\n"
argument_list|,
name|__func__
argument_list|,
name|qsfp_da_len
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_10G_DA
expr_stmt|;
name|lm_context
operator|->
name|da_len
operator|=
name|qsfp_da_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|qsfp_comp_code
operator|&
name|QSFP_COMPLIANCE_CODE_OPTIC
operator|)
operator|!=
literal|0
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: 10G optic module detected\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_10G_OPTIC
expr_stmt|;
block|}
else|else
block|{
name|al_warn
argument_list|(
literal|"%s: unknown QSFP inserted. eeprom content: 10G "
literal|"compliance 0x%x default to %s\n"
argument_list|,
name|__func__
argument_list|,
name|qsfp_comp_code
argument_list|,
name|al_eth_lm_mode_convert_to_str
argument_list|(
name|lm_context
operator|->
name|default_mode
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|lm_context
operator|->
name|default_mode
expr_stmt|;
name|lm_context
operator|->
name|da_len
operator|=
name|lm_context
operator|->
name|default_dac_len
expr_stmt|;
block|}
name|lm_context
operator|->
name|mode
operator|=
operator|*
name|new_mode
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_module_detect
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|enum
name|al_eth_lm_link_mode
modifier|*
name|new_mode
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
name|module_idx
decl_stmt|;
name|int
name|sfp_present
init|=
name|SFP_PRESENT
decl_stmt|;
if|if
condition|(
operator|(
name|lm_context
operator|->
name|gpio_get
operator|)
operator|&&
operator|(
name|lm_context
operator|->
name|gpio_present
operator|!=
literal|0
operator|)
condition|)
name|sfp_present
operator|=
name|lm_context
operator|->
name|gpio_get
argument_list|(
name|lm_context
operator|->
name|gpio_present
argument_list|)
expr_stmt|;
if|if
condition|(
name|sfp_present
operator|==
name|SFP_NOT_PRESENT
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: SFP not exist\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_DISCONNECTED
expr_stmt|;
return|return
literal|0
return|;
block|}
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|sfp_bus_id
argument_list|,
name|lm_context
operator|->
name|sfp_i2c_addr
argument_list|,
name|MODULE_IDENTIFIER_IDX
argument_list|,
operator|&
name|module_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|rc
operator|==
name|ETIMEDOUT
condition|)
block|{
comment|/* ETIMEDOUT is returned when no SFP is connected */
if|if
condition|(
name|lm_context
operator|->
name|mode
operator|!=
name|AL_ETH_LM_MODE_DISCONNECTED
condition|)
name|lm_debug
argument_list|(
literal|"%s: SFP Disconnected\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_DISCONNECTED
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|rc
operator|)
return|;
block|}
block|}
if|if
condition|(
name|module_idx
operator|==
name|MODULE_IDENTIFIER_QSFP
condition|)
return|return
operator|(
name|al_eth_qsfp_detect
argument_list|(
name|lm_context
argument_list|,
name|new_mode
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|al_eth_sfp_detect
argument_list|(
name|lm_context
argument_list|,
name|new_mode
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|al_serdes_adv_tx_params
name|da_tx_params
init|=
block|{
operator|.
name|override
operator|=
name|TRUE
block|,
operator|.
name|amp
operator|=
literal|0x1
block|,
operator|.
name|total_driver_units
operator|=
literal|0x13
block|,
operator|.
name|c_plus_1
operator|=
literal|0x2
block|,
operator|.
name|c_plus_2
operator|=
literal|0
block|,
operator|.
name|c_minus_1
operator|=
literal|0x2
block|,
operator|.
name|slew_rate
operator|=
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|al_serdes_adv_rx_params
name|da_rx_params
init|=
block|{
operator|.
name|override
operator|=
name|TRUE
block|,
operator|.
name|dcgain
operator|=
literal|0x4
block|,
operator|.
name|dfe_3db_freq
operator|=
literal|0x4
block|,
operator|.
name|dfe_gain
operator|=
literal|0x3
block|,
operator|.
name|dfe_first_tap_ctrl
operator|=
literal|0x5
block|,
operator|.
name|dfe_secound_tap_ctrl
operator|=
literal|0x1
block|,
operator|.
name|dfe_third_tap_ctrl
operator|=
literal|0x8
block|,
operator|.
name|dfe_fourth_tap_ctrl
operator|=
literal|0x1
block|,
operator|.
name|low_freq_agc_gain
operator|=
literal|0x7
block|,
operator|.
name|precal_code_sel
operator|=
literal|0
block|,
operator|.
name|high_freq_agc_boost
operator|=
literal|0x1d
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|al_serdes_adv_tx_params
name|optic_tx_params
init|=
block|{
operator|.
name|override
operator|=
name|TRUE
block|,
operator|.
name|amp
operator|=
literal|0x1
block|,
operator|.
name|total_driver_units
operator|=
literal|0x13
block|,
operator|.
name|c_plus_1
operator|=
literal|0x2
block|,
operator|.
name|c_plus_2
operator|=
literal|0
block|,
operator|.
name|c_minus_1
operator|=
literal|0
block|,
operator|.
name|slew_rate
operator|=
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|al_serdes_adv_rx_params
name|optic_rx_params
init|=
block|{
operator|.
name|override
operator|=
name|TRUE
block|,
operator|.
name|dcgain
operator|=
literal|0x0
block|,
operator|.
name|dfe_3db_freq
operator|=
literal|0x7
block|,
operator|.
name|dfe_gain
operator|=
literal|0x0
block|,
operator|.
name|dfe_first_tap_ctrl
operator|=
literal|0x0
block|,
operator|.
name|dfe_secound_tap_ctrl
operator|=
literal|0x8
block|,
operator|.
name|dfe_third_tap_ctrl
operator|=
literal|0x0
block|,
operator|.
name|dfe_fourth_tap_ctrl
operator|=
literal|0x8
block|,
operator|.
name|low_freq_agc_gain
operator|=
literal|0x7
block|,
operator|.
name|precal_code_sel
operator|=
literal|0
block|,
operator|.
name|high_freq_agc_boost
operator|=
literal|0x4
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|al_eth_serdes_static_tx_params_set
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
block|{
if|if
condition|(
name|lm_context
operator|->
name|tx_param_dirty
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|lm_context
operator|->
name|serdes_tx_params_valid
operator|!=
literal|0
condition|)
block|{
name|lm_context
operator|->
name|tx_param_dirty
operator|=
literal|0
expr_stmt|;
name|lm_context
operator|->
name|tx_params_override
operator|.
name|override
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|(
name|lm_context
operator|->
name|serdes_obj
operator|->
name|tx_advanced_params_set
operator|)
operator|==
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|"tx_advanced_params_set is not supported for this serdes group\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|lm_context
operator|->
name|serdes_obj
operator|->
name|tx_advanced_params_set
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|lm_context
operator|->
name|tx_params_override
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lm_context
operator|->
name|static_values
operator|!=
literal|0
condition|)
block|{
name|lm_context
operator|->
name|tx_param_dirty
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lm_context
operator|->
name|serdes_obj
operator|->
name|tx_advanced_params_set
operator|)
operator|==
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|"tx_advanced_params_set is not supported for this serdes group\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|lm_context
operator|->
name|retimer_exist
operator|==
literal|0
operator|)
operator|&&
operator|(
name|lm_context
operator|->
name|mode
operator|==
name|AL_ETH_LM_MODE_10G_DA
operator|)
condition|)
name|lm_context
operator|->
name|serdes_obj
operator|->
name|tx_advanced_params_set
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|da_tx_params
argument_list|)
expr_stmt|;
else|else
name|lm_context
operator|->
name|serdes_obj
operator|->
name|tx_advanced_params_set
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|optic_tx_params
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|al_eth_serdes_static_rx_params_set
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
block|{
if|if
condition|(
name|lm_context
operator|->
name|rx_param_dirty
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|lm_context
operator|->
name|serdes_rx_params_valid
operator|!=
literal|0
condition|)
block|{
name|lm_context
operator|->
name|rx_param_dirty
operator|=
literal|0
expr_stmt|;
name|lm_context
operator|->
name|rx_params_override
operator|.
name|override
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|(
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_advanced_params_set
operator|)
operator|==
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|"rx_advanced_params_set is not supported for this serdes group\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_advanced_params_set
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|lm_context
operator|->
name|rx_params_override
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lm_context
operator|->
name|static_values
operator|!=
literal|0
condition|)
block|{
name|lm_context
operator|->
name|rx_param_dirty
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_advanced_params_set
operator|)
operator|==
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|"rx_advanced_params_set is not supported for this serdes group\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|lm_context
operator|->
name|retimer_exist
operator|==
literal|0
operator|)
operator|&&
operator|(
name|lm_context
operator|->
name|mode
operator|==
name|AL_ETH_LM_MODE_10G_DA
operator|)
condition|)
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_advanced_params_set
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|da_rx_params
argument_list|)
expr_stmt|;
else|else
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_advanced_params_set
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|optic_rx_params
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_rx_equal_run
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
block|{
name|struct
name|al_serdes_adv_rx_params
name|rx_params
decl_stmt|;
name|int
name|dcgain
decl_stmt|;
name|int
name|best_dcgain
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|best_score
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|test_score
init|=
operator|-
literal|1
decl_stmt|;
name|rx_params
operator|.
name|override
operator|=
name|FALSE
expr_stmt|;
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_advanced_params_set
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|rx_params
argument_list|)
expr_stmt|;
name|lm_debug
argument_list|(
literal|"score | dcgain | dfe3db | dfegain | tap1 | tap2 | tap3 | "
literal|"tap4 | low freq | high freq\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|dcgain
operator|=
literal|0
init|;
name|dcgain
operator|<
name|AL_ETH_LM_MAX_DCGAIN
condition|;
name|dcgain
operator|++
control|)
block|{
name|lm_context
operator|->
name|serdes_obj
operator|->
name|dcgain_set
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|dcgain
argument_list|)
expr_stmt|;
name|test_score
operator|=
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_equalization
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_score
operator|<
literal|0
condition|)
block|{
name|al_warn
argument_list|(
literal|"serdes rx equalization failed on error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|test_score
operator|)
return|;
block|}
if|if
condition|(
name|test_score
operator|>
name|best_score
condition|)
block|{
name|best_score
operator|=
name|test_score
expr_stmt|;
name|best_dcgain
operator|=
name|dcgain
expr_stmt|;
block|}
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_advanced_params_get
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|rx_params
argument_list|)
expr_stmt|;
name|lm_debug
argument_list|(
literal|"%6d|%8x|%8x|%9x|%6x|%6x|%6x|%6x|%10x|%10x|\n"
argument_list|,
name|test_score
argument_list|,
name|rx_params
operator|.
name|dcgain
argument_list|,
name|rx_params
operator|.
name|dfe_3db_freq
argument_list|,
name|rx_params
operator|.
name|dfe_gain
argument_list|,
name|rx_params
operator|.
name|dfe_first_tap_ctrl
argument_list|,
name|rx_params
operator|.
name|dfe_secound_tap_ctrl
argument_list|,
name|rx_params
operator|.
name|dfe_third_tap_ctrl
argument_list|,
name|rx_params
operator|.
name|dfe_fourth_tap_ctrl
argument_list|,
name|rx_params
operator|.
name|low_freq_agc_gain
argument_list|,
name|rx_params
operator|.
name|high_freq_agc_boost
argument_list|)
expr_stmt|;
block|}
name|lm_context
operator|->
name|serdes_obj
operator|->
name|dcgain_set
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|best_dcgain
argument_list|)
expr_stmt|;
name|best_score
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_ETH_LM_EQ_ITERATIONS
condition|;
name|i
operator|++
control|)
block|{
name|test_score
operator|=
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_equalization
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_score
operator|<
literal|0
condition|)
block|{
name|al_warn
argument_list|(
literal|"serdes rx equalization failed on error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|test_score
operator|)
return|;
block|}
if|if
condition|(
name|test_score
operator|>
name|best_score
condition|)
block|{
name|best_score
operator|=
name|test_score
expr_stmt|;
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_advanced_params_get
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|rx_params
argument_list|)
expr_stmt|;
block|}
block|}
name|rx_params
operator|.
name|precal_code_sel
operator|=
literal|0
expr_stmt|;
name|rx_params
operator|.
name|override
operator|=
name|TRUE
expr_stmt|;
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_advanced_params_set
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|rx_params
argument_list|)
expr_stmt|;
name|lm_debug
argument_list|(
literal|"-------------------- best dcgain %d ------------------------------------\n"
argument_list|,
name|best_dcgain
argument_list|)
expr_stmt|;
name|lm_debug
argument_list|(
literal|"%6d|%8x|%8x|%9x|%6x|%6x|%6x|%6x|%10x|%10x|\n"
argument_list|,
name|best_score
argument_list|,
name|rx_params
operator|.
name|dcgain
argument_list|,
name|rx_params
operator|.
name|dfe_3db_freq
argument_list|,
name|rx_params
operator|.
name|dfe_gain
argument_list|,
name|rx_params
operator|.
name|dfe_first_tap_ctrl
argument_list|,
name|rx_params
operator|.
name|dfe_secound_tap_ctrl
argument_list|,
name|rx_params
operator|.
name|dfe_third_tap_ctrl
argument_list|,
name|rx_params
operator|.
name|dfe_fourth_tap_ctrl
argument_list|,
name|rx_params
operator|.
name|low_freq_agc_gain
argument_list|,
name|rx_params
operator|.
name|high_freq_agc_boost
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_lm_retimer_boost_config
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
name|boost
init|=
literal|0
decl_stmt|;
name|uint32_t
name|boost_addr
init|=
name|al_eth_retimer_boost_addr
index|[
name|lm_context
operator|->
name|retimer_channel
index|]
index|[
name|lm_context
operator|->
name|retimer_type
index|]
decl_stmt|;
if|if
condition|(
name|lm_context
operator|->
name|mode
operator|!=
name|AL_ETH_LM_MODE_10G_DA
condition|)
block|{
name|boost
operator|=
name|al_eth_retimer_boost_value
index|[
literal|0
index|]
index|[
name|lm_context
operator|->
name|retimer_type
index|]
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RETIMER_LENS_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|lm_context
operator|->
name|da_len
operator|<=
name|al_eth_retimer_boost_lens
index|[
name|i
index|]
condition|)
block|{
name|boost
operator|=
name|al_eth_retimer_boost_value
index|[
name|i
index|]
index|[
name|lm_context
operator|->
name|retimer_type
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|RETIMER_LENS_MAX
condition|)
name|boost
operator|=
name|al_eth_retimer_boost_value
index|[
name|RETIMER_LENS_MAX
index|]
index|[
name|lm_context
operator|->
name|retimer_type
index|]
expr_stmt|;
block|}
name|lm_debug
argument_list|(
literal|"config retimer boost in channel %d (addr %x) to 0x%x\n"
argument_list|,
name|lm_context
operator|->
name|retimer_channel
argument_list|,
name|boost_addr
argument_list|,
name|boost
argument_list|)
expr_stmt|;
name|rc
operator|=
name|lm_context
operator|->
name|i2c_write
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|retimer_bus_id
argument_list|,
name|lm_context
operator|->
name|retimer_i2c_addr
argument_list|,
name|boost_addr
argument_list|,
name|boost
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|"%s: Error occurred (%d) while writing retimer "
literal|"configuration (bus-id %x i2c-addr %x)\n"
argument_list|,
name|__func__
argument_list|,
name|rc
argument_list|,
name|lm_context
operator|->
name|retimer_bus_id
argument_list|,
name|lm_context
operator|->
name|retimer_i2c_addr
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************  ************************** retimer DS25 ***************************************  ******************************************************************************/
end_comment

begin_define
define|#
directive|define
name|LM_DS25_CHANNEL_EN_REG
value|0xff
end_define

begin_define
define|#
directive|define
name|LM_DS25_CHANNEL_EN_MASK
value|0x03
end_define

begin_define
define|#
directive|define
name|LM_DS25_CHANNEL_EN_VAL
value|0x01
end_define

begin_define
define|#
directive|define
name|LM_DS25_CHANNEL_SEL_REG
value|0xfc
end_define

begin_define
define|#
directive|define
name|LM_DS25_CHANNEL_SEL_MASK
value|0xff
end_define

begin_define
define|#
directive|define
name|LM_DS25_CDR_RESET_REG
value|0x0a
end_define

begin_define
define|#
directive|define
name|LM_DS25_CDR_RESET_MASK
value|0x0c
end_define

begin_define
define|#
directive|define
name|LM_DS25_CDR_RESET_ASSERT
value|0x0c
end_define

begin_define
define|#
directive|define
name|LM_DS25_CDR_RESET_RELEASE
value|0x00
end_define

begin_define
define|#
directive|define
name|LM_DS25_SIGNAL_DETECT_REG
value|0x78
end_define

begin_define
define|#
directive|define
name|LM_DS25_SIGNAL_DETECT_MASK
value|0x20
end_define

begin_define
define|#
directive|define
name|LM_DS25_CDR_LOCK_REG
value|0x78
end_define

begin_define
define|#
directive|define
name|LM_DS25_CDR_LOCK_MASK
value|0x10
end_define

begin_define
define|#
directive|define
name|LM_DS25_DRV_PD_REG
value|0x15
end_define

begin_define
define|#
directive|define
name|LM_DS25_DRV_PD_MASK
value|0x08
end_define

begin_function
specifier|static
name|int
name|al_eth_lm_retimer_ds25_write_reg
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint8_t
name|reg_addr
parameter_list|,
name|uint8_t
name|reg_mask
parameter_list|,
name|uint8_t
name|reg_value
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|retimer_bus_id
argument_list|,
name|lm_context
operator|->
name|retimer_i2c_addr
argument_list|,
name|reg_addr
argument_list|,
operator|&
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|reg
operator|&=
operator|~
operator|(
name|reg_mask
operator|)
expr_stmt|;
name|reg
operator||=
name|reg_value
expr_stmt|;
name|rc
operator|=
name|lm_context
operator|->
name|i2c_write
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|retimer_bus_id
argument_list|,
name|lm_context
operator|->
name|retimer_i2c_addr
argument_list|,
name|reg_addr
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_lm_retimer_ds25_channel_select
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint8_t
name|channel
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
comment|/* Write to specific channel */
name|rc
operator|=
name|al_eth_lm_retimer_ds25_write_reg
argument_list|(
name|lm_context
argument_list|,
name|LM_DS25_CHANNEL_EN_REG
argument_list|,
name|LM_DS25_CHANNEL_EN_MASK
argument_list|,
name|LM_DS25_CHANNEL_EN_VAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
return|return
operator|(
name|rc
operator|)
return|;
name|rc
operator|=
name|al_eth_lm_retimer_ds25_write_reg
argument_list|(
name|lm_context
argument_list|,
name|LM_DS25_CHANNEL_SEL_REG
argument_list|,
name|LM_DS25_CHANNEL_SEL_MASK
argument_list|,
operator|(
literal|1
operator|<<
name|channel
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_lm_retimer_ds25_channel_config
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint8_t
name|channel
parameter_list|,
name|struct
name|retimer_config_reg
modifier|*
name|config
parameter_list|,
name|uint8_t
name|config_size
parameter_list|)
block|{
name|uint8_t
name|i
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|al_eth_lm_retimer_ds25_channel_select
argument_list|(
name|lm_context
argument_list|,
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
goto|goto
name|config_error
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|config_size
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|al_eth_lm_retimer_ds25_write_reg
argument_list|(
name|lm_context
argument_list|,
name|config
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|config
index|[
name|i
index|]
operator|.
name|mask
argument_list|,
name|config
index|[
name|i
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
goto|goto
name|config_error
goto|;
block|}
name|lm_debug
argument_list|(
literal|"%s: retimer channel config done for channel %d\n"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|config_error
label|:
name|al_err
argument_list|(
literal|"%s: failed to access to the retimer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_lm_retimer_ds25_cdr_reset
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|lm_debug
argument_list|(
literal|"Perform CDR reset to channel %d\n"
argument_list|,
name|channel
argument_list|)
expr_stmt|;
name|rc
operator|=
name|al_eth_lm_retimer_ds25_channel_select
argument_list|(
name|lm_context
argument_list|,
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|config_error
goto|;
name|rc
operator|=
name|al_eth_lm_retimer_ds25_write_reg
argument_list|(
name|lm_context
argument_list|,
name|LM_DS25_CDR_RESET_REG
argument_list|,
name|LM_DS25_CDR_RESET_MASK
argument_list|,
name|LM_DS25_CDR_RESET_ASSERT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|config_error
goto|;
name|rc
operator|=
name|al_eth_lm_retimer_ds25_write_reg
argument_list|(
name|lm_context
argument_list|,
name|LM_DS25_CDR_RESET_REG
argument_list|,
name|LM_DS25_CDR_RESET_MASK
argument_list|,
name|LM_DS25_CDR_RESET_RELEASE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|config_error
goto|;
return|return
literal|0
return|;
name|config_error
label|:
name|al_err
argument_list|(
literal|"%s: failed to access to the retimer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|al_eth_lm_retimer_ds25_signal_detect
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
name|reg
decl_stmt|;
name|rc
operator|=
name|al_eth_lm_retimer_ds25_channel_select
argument_list|(
name|lm_context
argument_list|,
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|config_error
goto|;
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|retimer_bus_id
argument_list|,
name|lm_context
operator|->
name|retimer_i2c_addr
argument_list|,
name|LM_DS25_SIGNAL_DETECT_REG
argument_list|,
operator|&
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|config_error
goto|;
if|if
condition|(
name|reg
operator|&
name|LM_DS25_SIGNAL_DETECT_MASK
condition|)
return|return
name|TRUE
return|;
return|return
name|FALSE
return|;
name|config_error
label|:
name|al_err
argument_list|(
literal|"%s: failed to access to the retimer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|al_eth_lm_retimer_ds25_cdr_lock
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
name|reg
decl_stmt|;
name|rc
operator|=
name|al_eth_lm_retimer_ds25_channel_select
argument_list|(
name|lm_context
argument_list|,
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|config_error
goto|;
name|rc
operator|=
name|lm_context
operator|->
name|i2c_read
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
name|lm_context
operator|->
name|retimer_bus_id
argument_list|,
name|lm_context
operator|->
name|retimer_i2c_addr
argument_list|,
name|LM_DS25_CDR_LOCK_REG
argument_list|,
operator|&
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|config_error
goto|;
if|if
condition|(
name|reg
operator|&
name|LM_DS25_CDR_LOCK_MASK
condition|)
return|return
name|TRUE
return|;
return|return
name|FALSE
return|;
name|config_error
label|:
name|al_err
argument_list|(
literal|"%s: failed to access to the retimer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|al_eth_lm_wait_for_lock
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|)
block|{
name|uint32_t
name|timeout
init|=
name|AL_ETH_LM_RETIMER_WAIT_FOR_LOCK
decl_stmt|;
name|al_bool
name|lock
init|=
name|AL_FALSE
decl_stmt|;
while|while
condition|(
operator|(
name|timeout
operator|>
literal|0
operator|)
operator|&&
operator|(
name|lock
operator|==
name|FALSE
operator|)
condition|)
block|{
name|al_msleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|timeout
operator|-=
literal|10
expr_stmt|;
name|lock
operator|=
name|retimer
index|[
name|lm_context
operator|->
name|retimer_type
index|]
operator|.
name|cdr_lock
argument_list|(
name|lm_context
argument_list|,
name|channel
argument_list|)
expr_stmt|;
block|}
name|lm_debug
argument_list|(
literal|"%s: %s to achieve CDR lock in %d msec\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|lock
operator|)
condition|?
literal|"succeed"
else|:
literal|"FAILED"
argument_list|,
operator|(
name|AL_ETH_LM_RETIMER_WAIT_FOR_LOCK
operator|-
name|timeout
operator|)
argument_list|)
expr_stmt|;
return|return
name|lock
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_eth_lm_retimer_signal_lock_check
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|uint32_t
name|channel
parameter_list|,
name|boolean_t
modifier|*
name|ready
parameter_list|)
block|{
name|al_bool
name|signal_detect
init|=
name|TRUE
decl_stmt|;
name|al_bool
name|cdr_lock
init|=
name|TRUE
decl_stmt|;
if|if
condition|(
name|retimer
index|[
name|lm_context
operator|->
name|retimer_type
index|]
operator|.
name|signal_detect
condition|)
block|{
if|if
condition|(
operator|!
name|retimer
index|[
name|lm_context
operator|->
name|retimer_type
index|]
operator|.
name|signal_detect
argument_list|(
name|lm_context
argument_list|,
name|channel
argument_list|)
condition|)
block|{
name|lm_debug
argument_list|(
literal|"no signal detected on retimer channel %d\n"
argument_list|,
name|channel
argument_list|)
expr_stmt|;
name|signal_detect
operator|=
name|AL_FALSE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|retimer
index|[
name|lm_context
operator|->
name|retimer_type
index|]
operator|.
name|cdr_lock
condition|)
block|{
name|cdr_lock
operator|=
name|retimer
index|[
name|lm_context
operator|->
name|retimer_type
index|]
operator|.
name|cdr_lock
argument_list|(
name|lm_context
argument_list|,
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cdr_lock
condition|)
block|{
if|if
condition|(
name|retimer
index|[
name|lm_context
operator|->
name|retimer_type
index|]
operator|.
name|reset
condition|)
block|{
name|retimer
index|[
name|lm_context
operator|->
name|retimer_type
index|]
operator|.
name|reset
argument_list|(
name|lm_context
argument_list|,
name|channel
argument_list|)
expr_stmt|;
name|cdr_lock
operator|=
name|al_eth_lm_wait_for_lock
argument_list|(
name|lm_context
argument_list|,
name|channel
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
name|al_info
argument_list|(
literal|"%s: (channel %d) signal %d cdr lock %d\n"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|,
name|signal_detect
argument_list|,
operator|(
name|signal_detect
operator|)
condition|?
name|cdr_lock
else|:
literal|0
argument_list|)
expr_stmt|;
operator|*
name|ready
operator|=
operator|(
operator|(
name|cdr_lock
operator|==
name|TRUE
operator|)
operator|&&
operator|(
name|signal_detect
operator|==
name|TRUE
operator|)
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_lm_retimer_ds25_full_config
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|al_bool
name|ready
decl_stmt|;
name|struct
name|retimer_config_reg
modifier|*
name|config_tx
decl_stmt|;
name|uint32_t
name|config_tx_size
decl_stmt|;
name|struct
name|retimer_config_reg
modifier|*
name|config_rx
decl_stmt|;
name|uint32_t
name|config_rx_size
decl_stmt|;
if|if
condition|(
name|lm_context
operator|->
name|mode
operator|==
name|AL_ETH_LM_MODE_25G
condition|)
block|{
name|config_tx
operator|=
name|retimer_ds25_25g_mode_tx_ch
expr_stmt|;
name|config_tx_size
operator|=
name|AL_ARR_SIZE
argument_list|(
name|retimer_ds25_25g_mode_tx_ch
argument_list|)
expr_stmt|;
name|config_rx
operator|=
name|retimer_ds25_25g_mode_rx_ch
expr_stmt|;
name|config_rx_size
operator|=
name|AL_ARR_SIZE
argument_list|(
name|retimer_ds25_25g_mode_rx_ch
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|config_tx
operator|=
name|retimer_ds25_10g_mode
expr_stmt|;
name|config_tx_size
operator|=
name|AL_ARR_SIZE
argument_list|(
name|retimer_ds25_10g_mode
argument_list|)
expr_stmt|;
name|config_rx
operator|=
name|retimer_ds25_10g_mode
expr_stmt|;
name|config_rx_size
operator|=
name|AL_ARR_SIZE
argument_list|(
name|retimer_ds25_10g_mode
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|al_eth_lm_retimer_ds25_channel_config
argument_list|(
name|lm_context
argument_list|,
name|lm_context
operator|->
name|retimer_channel
argument_list|,
name|config_rx
argument_list|,
name|config_rx_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
name|rc
operator|=
name|al_eth_lm_retimer_ds25_channel_config
argument_list|(
name|lm_context
argument_list|,
name|lm_context
operator|->
name|retimer_tx_channel
argument_list|,
name|config_tx
argument_list|,
name|config_tx_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
if|if
condition|(
name|lm_context
operator|->
name|serdes_obj
operator|->
name|type_get
argument_list|()
operator|==
name|AL_SRDS_TYPE_25G
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: serdes 25G - perform tx and rx gearbox reset\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|al_eth_gearbox_reset
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|AL_ETH_LM_GEARBOX_RESET_DELAY
argument_list|)
expr_stmt|;
block|}
name|al_eth_lm_retimer_signal_lock_check
argument_list|(
name|lm_context
argument_list|,
name|lm_context
operator|->
name|retimer_tx_channel
argument_list|,
operator|&
name|ready
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ready
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: Failed to lock tx channel!\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|lm_debug
argument_list|(
literal|"%s: retimer full configuration done\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_lm_retimer_25g_rx_adaptation
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|al_bool
name|ready
decl_stmt|;
name|al_eth_lm_retimer_signal_lock_check
argument_list|(
name|lm_context
argument_list|,
name|lm_context
operator|->
name|retimer_channel
argument_list|,
operator|&
name|ready
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ready
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: no signal detected on retimer Rx channel (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|lm_context
operator|->
name|retimer_channel
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|al_msleep
argument_list|(
name|AL_ETH_LM_SERDES_WAIT_FOR_LOCK
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_lm_check_for_link
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|boolean_t
modifier|*
name|link_up
parameter_list|)
block|{
name|struct
name|al_eth_link_status
name|status
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|al_eth_link_status_clear
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|)
expr_stmt|;
name|al_eth_link_status_get
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|link_up
operator|==
name|AL_TRUE
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s:>>>> Link state DOWN ==> UP\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|al_eth_led_set
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
name|AL_TRUE
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|link_state
operator|=
name|AL_ETH_LM_LINK_UP
expr_stmt|;
operator|*
name|link_up
operator|=
name|AL_TRUE
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|status
operator|.
name|local_fault
condition|)
block|{
name|lm_context
operator|->
name|link_state
operator|=
name|AL_ETH_LM_LINK_DOWN
expr_stmt|;
name|al_eth_led_set
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
name|AL_FALSE
argument_list|)
expr_stmt|;
name|al_err
argument_list|(
literal|"%s: Failed to establish link\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|lm_debug
argument_list|(
literal|"%s:>>>> Link state DOWN ==> DOWN_RF\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|link_state
operator|=
name|AL_ETH_LM_LINK_DOWN_RF
expr_stmt|;
name|al_eth_led_set
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
name|AL_FALSE
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|link_up
operator|=
name|AL_FALSE
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/***************************** API functions *********************************/
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|int
name|al_eth_lm_init
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|struct
name|al_eth_lm_init_params
modifier|*
name|params
parameter_list|)
block|{
name|lm_context
operator|->
name|adapter
operator|=
name|params
operator|->
name|adapter
expr_stmt|;
name|lm_context
operator|->
name|serdes_obj
operator|=
name|params
operator|->
name|serdes_obj
expr_stmt|;
name|lm_context
operator|->
name|lane
operator|=
name|params
operator|->
name|lane
expr_stmt|;
name|lm_context
operator|->
name|sfp_detection
operator|=
name|params
operator|->
name|sfp_detection
expr_stmt|;
name|lm_context
operator|->
name|sfp_bus_id
operator|=
name|params
operator|->
name|sfp_bus_id
expr_stmt|;
name|lm_context
operator|->
name|sfp_i2c_addr
operator|=
name|params
operator|->
name|sfp_i2c_addr
expr_stmt|;
name|lm_context
operator|->
name|retimer_exist
operator|=
name|params
operator|->
name|retimer_exist
expr_stmt|;
name|lm_context
operator|->
name|retimer_type
operator|=
name|params
operator|->
name|retimer_type
expr_stmt|;
name|lm_context
operator|->
name|retimer_bus_id
operator|=
name|params
operator|->
name|retimer_bus_id
expr_stmt|;
name|lm_context
operator|->
name|retimer_i2c_addr
operator|=
name|params
operator|->
name|retimer_i2c_addr
expr_stmt|;
name|lm_context
operator|->
name|retimer_channel
operator|=
name|params
operator|->
name|retimer_channel
expr_stmt|;
name|lm_context
operator|->
name|retimer_tx_channel
operator|=
name|params
operator|->
name|retimer_tx_channel
expr_stmt|;
name|lm_context
operator|->
name|default_mode
operator|=
name|params
operator|->
name|default_mode
expr_stmt|;
name|lm_context
operator|->
name|default_dac_len
operator|=
name|params
operator|->
name|default_dac_len
expr_stmt|;
name|lm_context
operator|->
name|link_training
operator|=
name|params
operator|->
name|link_training
expr_stmt|;
name|lm_context
operator|->
name|rx_equal
operator|=
name|params
operator|->
name|rx_equal
expr_stmt|;
name|lm_context
operator|->
name|static_values
operator|=
name|params
operator|->
name|static_values
expr_stmt|;
name|lm_context
operator|->
name|i2c_read
operator|=
name|params
operator|->
name|i2c_read
expr_stmt|;
name|lm_context
operator|->
name|i2c_write
operator|=
name|params
operator|->
name|i2c_write
expr_stmt|;
name|lm_context
operator|->
name|i2c_context
operator|=
name|params
operator|->
name|i2c_context
expr_stmt|;
name|lm_context
operator|->
name|get_random_byte
operator|=
name|params
operator|->
name|get_random_byte
expr_stmt|;
comment|/* eeprom_read must be provided if sfp_detection is true */
name|al_assert
argument_list|(
operator|(
name|lm_context
operator|->
name|sfp_detection
operator|==
name|FALSE
operator|)
operator|||
operator|(
name|lm_context
operator|->
name|i2c_read
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
operator|(
name|lm_context
operator|->
name|retimer_exist
operator|==
name|FALSE
operator|)
operator|||
operator|(
name|lm_context
operator|->
name|i2c_write
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|local_adv
operator|.
name|selector_field
operator|=
literal|1
expr_stmt|;
name|lm_context
operator|->
name|local_adv
operator|.
name|capability
operator|=
literal|0
expr_stmt|;
name|lm_context
operator|->
name|local_adv
operator|.
name|remote_fault
operator|=
literal|0
expr_stmt|;
name|lm_context
operator|->
name|local_adv
operator|.
name|acknowledge
operator|=
literal|0
expr_stmt|;
name|lm_context
operator|->
name|local_adv
operator|.
name|next_page
operator|=
literal|0
expr_stmt|;
name|lm_context
operator|->
name|local_adv
operator|.
name|technology
operator|=
name|AL_ETH_AN_TECH_10GBASE_KR
expr_stmt|;
name|lm_context
operator|->
name|local_adv
operator|.
name|fec_capability
operator|=
name|params
operator|->
name|kr_fec_enable
expr_stmt|;
name|lm_context
operator|->
name|mode
operator|=
name|AL_ETH_LM_MODE_DISCONNECTED
expr_stmt|;
name|lm_context
operator|->
name|serdes_tx_params_valid
operator|=
name|FALSE
expr_stmt|;
name|lm_context
operator|->
name|serdes_rx_params_valid
operator|=
name|FALSE
expr_stmt|;
name|lm_context
operator|->
name|rx_param_dirty
operator|=
literal|1
expr_stmt|;
name|lm_context
operator|->
name|tx_param_dirty
operator|=
literal|1
expr_stmt|;
name|lm_context
operator|->
name|gpio_get
operator|=
name|params
operator|->
name|gpio_get
expr_stmt|;
name|lm_context
operator|->
name|gpio_present
operator|=
name|params
operator|->
name|gpio_present
expr_stmt|;
name|lm_context
operator|->
name|max_speed
operator|=
name|params
operator|->
name|max_speed
expr_stmt|;
name|lm_context
operator|->
name|sfp_detect_force_mode
operator|=
name|params
operator|->
name|sfp_detect_force_mode
expr_stmt|;
name|lm_context
operator|->
name|lm_pause
operator|=
name|params
operator|->
name|lm_pause
expr_stmt|;
name|lm_context
operator|->
name|led_config
operator|=
name|params
operator|->
name|led_config
expr_stmt|;
name|lm_context
operator|->
name|retimer_configured
operator|=
name|FALSE
expr_stmt|;
name|lm_context
operator|->
name|link_state
operator|=
name|AL_ETH_LM_LINK_DOWN
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|al_eth_lm_link_detection
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|boolean_t
modifier|*
name|link_fault
parameter_list|,
name|enum
name|al_eth_lm_link_mode
modifier|*
name|old_mode
parameter_list|,
name|enum
name|al_eth_lm_link_mode
modifier|*
name|new_mode
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|struct
name|al_eth_link_status
name|status
decl_stmt|;
name|al_assert
argument_list|(
name|lm_context
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|old_mode
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|new_mode
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/** 	 * if Link management is disabled, report no link fault in case the link was up 	 * before and set new mode to disconnected to avoid calling to link establish 	 * if the link wasn't up. 	 */
if|if
condition|(
name|lm_context
operator|->
name|lm_pause
operator|!=
name|NULL
condition|)
block|{
name|boolean_t
name|lm_pause
init|=
name|lm_context
operator|->
name|lm_pause
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|)
decl_stmt|;
if|if
condition|(
name|lm_pause
operator|==
name|TRUE
condition|)
block|{
operator|*
name|new_mode
operator|=
name|AL_ETH_LM_MODE_DISCONNECTED
expr_stmt|;
if|if
condition|(
name|link_fault
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|lm_context
operator|->
name|link_state
operator|==
name|AL_ETH_LM_LINK_UP
condition|)
operator|*
name|link_fault
operator|=
name|FALSE
expr_stmt|;
else|else
operator|*
name|link_fault
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
block|}
operator|*
name|old_mode
operator|=
name|lm_context
operator|->
name|mode
expr_stmt|;
operator|*
name|new_mode
operator|=
name|lm_context
operator|->
name|mode
expr_stmt|;
if|if
condition|(
name|link_fault
operator|!=
name|NULL
condition|)
operator|*
name|link_fault
operator|=
name|TRUE
expr_stmt|;
switch|switch
condition|(
name|lm_context
operator|->
name|link_state
condition|)
block|{
case|case
name|AL_ETH_LM_LINK_UP
case|:
name|al_eth_link_status_get
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|link_up
condition|)
block|{
if|if
condition|(
name|link_fault
operator|!=
name|NULL
condition|)
operator|*
name|link_fault
operator|=
name|FALSE
expr_stmt|;
name|al_eth_led_set
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|status
operator|.
name|local_fault
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s:>>>> Link state UP ==> DOWN\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|link_state
operator|=
name|AL_ETH_LM_LINK_DOWN
expr_stmt|;
block|}
else|else
block|{
name|lm_debug
argument_list|(
literal|"%s:>>>> Link state UP ==> DOWN_RF\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|link_state
operator|=
name|AL_ETH_LM_LINK_DOWN_RF
expr_stmt|;
block|}
break|break;
case|case
name|AL_ETH_LM_LINK_DOWN_RF
case|:
name|al_eth_link_status_get
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|.
name|local_fault
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s:>>>> Link state DOWN_RF ==> DOWN\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|link_state
operator|=
name|AL_ETH_LM_LINK_DOWN
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|status
operator|.
name|remote_fault
operator|==
name|FALSE
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s:>>>> Link state DOWN_RF ==> UP\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|link_state
operator|=
name|AL_ETH_LM_LINK_UP
expr_stmt|;
block|}
comment|/* in case of remote fault only no need to check SFP again */
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|AL_ETH_LM_LINK_DOWN
case|:
break|break;
block|}
empty_stmt|;
name|al_eth_led_set
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|lm_context
operator|->
name|sfp_detection
condition|)
block|{
name|err
operator|=
name|al_eth_module_detect
argument_list|(
name|lm_context
argument_list|,
name|new_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|"module_detection failed!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|lm_context
operator|->
name|mode
operator|=
operator|*
name|new_mode
expr_stmt|;
block|}
else|else
block|{
name|lm_context
operator|->
name|mode
operator|=
name|lm_context
operator|->
name|default_mode
expr_stmt|;
operator|*
name|new_mode
operator|=
name|lm_context
operator|->
name|mode
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|old_mode
operator|!=
operator|*
name|new_mode
condition|)
block|{
name|al_info
argument_list|(
literal|"%s: New SFP mode detected %s -> %s\n"
argument_list|,
name|__func__
argument_list|,
name|al_eth_lm_mode_convert_to_str
argument_list|(
operator|*
name|old_mode
argument_list|)
argument_list|,
name|al_eth_lm_mode_convert_to_str
argument_list|(
operator|*
name|new_mode
argument_list|)
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|rx_param_dirty
operator|=
literal|1
expr_stmt|;
name|lm_context
operator|->
name|tx_param_dirty
operator|=
literal|1
expr_stmt|;
name|lm_context
operator|->
name|new_port
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|new_mode
operator|!=
name|AL_ETH_LM_MODE_DISCONNECTED
operator|)
operator|&&
operator|(
name|lm_context
operator|->
name|led_config
operator|)
condition|)
block|{
name|struct
name|al_eth_lm_led_config_data
name|data
init|=
block|{
literal|0
block|}
decl_stmt|;
switch|switch
condition|(
operator|*
name|new_mode
condition|)
block|{
case|case
name|AL_ETH_LM_MODE_10G_OPTIC
case|:
case|case
name|AL_ETH_LM_MODE_10G_DA
case|:
name|data
operator|.
name|speed
operator|=
name|AL_ETH_LM_LED_CONFIG_10G
expr_stmt|;
break|break;
case|case
name|AL_ETH_LM_MODE_1G
case|:
name|data
operator|.
name|speed
operator|=
name|AL_ETH_LM_LED_CONFIG_1G
expr_stmt|;
break|break;
case|case
name|AL_ETH_LM_MODE_25G
case|:
name|data
operator|.
name|speed
operator|=
name|AL_ETH_LM_LED_CONFIG_25G
expr_stmt|;
break|break;
default|default:
name|al_err
argument_list|(
literal|"%s: unknown LM mode!\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|lm_context
operator|->
name|led_config
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|al_eth_lm_link_establish
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|boolean_t
modifier|*
name|link_up
parameter_list|)
block|{
name|boolean_t
name|signal_detected
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|lm_context
operator|->
name|link_state
condition|)
block|{
case|case
name|AL_ETH_LM_LINK_UP
case|:
operator|*
name|link_up
operator|=
name|TRUE
expr_stmt|;
name|lm_debug
argument_list|(
literal|"%s: return link up\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|AL_ETH_LM_LINK_DOWN_RF
case|:
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
name|lm_debug
argument_list|(
literal|"%s: return link down (DOWN_RF)\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|AL_ETH_LM_LINK_DOWN
case|:
break|break;
block|}
empty_stmt|;
comment|/** 	 * At this point we will get LM disable only if changed to disable after link detection 	 * finished. in this case link will not be established until LM will be enable again. 	 */
if|if
condition|(
name|lm_context
operator|->
name|lm_pause
condition|)
block|{
name|boolean_t
name|lm_pause
init|=
name|lm_context
operator|->
name|lm_pause
argument_list|(
name|lm_context
operator|->
name|i2c_context
argument_list|)
decl_stmt|;
if|if
condition|(
name|lm_pause
operator|==
name|TRUE
condition|)
block|{
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
if|if
condition|(
operator|(
name|lm_context
operator|->
name|new_port
operator|)
operator|&&
operator|(
name|lm_context
operator|->
name|retimer_exist
operator|)
condition|)
block|{
name|al_eth_serdes_static_rx_params_set
argument_list|(
name|lm_context
argument_list|)
expr_stmt|;
name|al_eth_serdes_static_tx_params_set
argument_list|(
name|lm_context
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|al_eth_lm_retimer_config(lm_context); 		DELAY(AL_ETH_LM_RETIMER_LINK_STATUS_DELAY);
endif|#
directive|endif
if|if
condition|(
name|retimer
index|[
name|lm_context
operator|->
name|retimer_type
index|]
operator|.
name|config
argument_list|(
name|lm_context
argument_list|)
condition|)
block|{
name|al_info
argument_list|(
literal|"%s: failed to configure the retimer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|lm_context
operator|->
name|new_port
operator|=
name|FALSE
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lm_context
operator|->
name|retimer_exist
condition|)
block|{
if|if
condition|(
name|retimer
index|[
name|lm_context
operator|->
name|retimer_type
index|]
operator|.
name|rx_adaptation
condition|)
block|{
name|ret
operator|=
name|retimer
index|[
name|lm_context
operator|->
name|retimer_type
index|]
operator|.
name|rx_adaptation
argument_list|(
name|lm_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|lm_debug
argument_list|(
literal|"retimer rx is not ready\n"
argument_list|)
expr_stmt|;
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
name|signal_detected
operator|=
name|lm_context
operator|->
name|serdes_obj
operator|->
name|signal_is_detected
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|)
expr_stmt|;
if|if
condition|(
name|signal_detected
operator|==
name|FALSE
condition|)
block|{
comment|/* if no signal detected there is nothing to do */
name|lm_debug
argument_list|(
literal|"serdes signal is down\n"
argument_list|)
expr_stmt|;
operator|*
name|link_up
operator|=
name|AL_FALSE
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|lm_context
operator|->
name|serdes_obj
operator|->
name|type_get
argument_list|()
operator|==
name|AL_SRDS_TYPE_25G
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: serdes 25G - perform rx gearbox reset\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|al_eth_gearbox_reset
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|AL_ETH_LM_GEARBOX_RESET_DELAY
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lm_context
operator|->
name|retimer_exist
condition|)
block|{
name|DELAY
argument_list|(
name|AL_ETH_LM_RETIMER_LINK_STATUS_DELAY
argument_list|)
expr_stmt|;
name|ret
operator|=
name|al_eth_lm_check_for_link
argument_list|(
name|lm_context
argument_list|,
name|link_up
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: link is up with retimer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ret
return|;
block|}
if|if
condition|(
operator|(
name|lm_context
operator|->
name|mode
operator|==
name|AL_ETH_LM_MODE_10G_DA
operator|)
operator|&&
operator|(
name|lm_context
operator|->
name|link_training
operator|)
condition|)
block|{
name|lm_context
operator|->
name|local_adv
operator|.
name|transmitted_nonce
operator|=
name|lm_context
operator|->
name|get_random_byte
argument_list|()
expr_stmt|;
name|lm_context
operator|->
name|local_adv
operator|.
name|transmitted_nonce
operator|&=
literal|0x1f
expr_stmt|;
name|ret
operator|=
name|al_eth_an_lt_execute
argument_list|(
name|lm_context
operator|->
name|adapter
argument_list|,
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
operator|&
name|lm_context
operator|->
name|local_adv
argument_list|,
operator|&
name|lm_context
operator|->
name|partner_adv
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|rx_param_dirty
operator|=
literal|1
expr_stmt|;
name|lm_context
operator|->
name|tx_param_dirty
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|al_info
argument_list|(
literal|"%s: link training finished successfully\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|link_training_failures
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|al_eth_lm_check_for_link
argument_list|(
name|lm_context
argument_list|,
name|link_up
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: link is up with LT\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|lm_context
operator|->
name|link_training_failures
operator|++
expr_stmt|;
if|if
condition|(
name|lm_context
operator|->
name|link_training_failures
operator|>
name|AL_ETH_LT_FAILURES_TO_RESET
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: failed to establish LT %d times. reset serdes\n"
argument_list|,
name|__func__
argument_list|,
name|AL_ETH_LT_FAILURES_TO_RESET
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|serdes_obj
operator|->
name|pma_hard_reset_lane
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|serdes_obj
operator|->
name|pma_hard_reset_lane
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|lm_context
operator|->
name|link_training_failures
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|al_eth_serdes_static_tx_params_set
argument_list|(
name|lm_context
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|lm_context
operator|->
name|mode
operator|==
name|AL_ETH_LM_MODE_10G_DA
operator|)
operator|&&
operator|(
name|lm_context
operator|->
name|rx_equal
operator|)
condition|)
block|{
name|ret
operator|=
name|al_eth_rx_equal_run
argument_list|(
name|lm_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|DELAY
argument_list|(
name|AL_ETH_LM_LINK_STATUS_DELAY
argument_list|)
expr_stmt|;
name|ret
operator|=
name|al_eth_lm_check_for_link
argument_list|(
name|lm_context
argument_list|,
name|link_up
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: link is up with Rx Equalization\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
name|al_eth_serdes_static_rx_params_set
argument_list|(
name|lm_context
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|AL_ETH_LM_LINK_STATUS_DELAY
argument_list|)
expr_stmt|;
name|ret
operator|=
name|al_eth_lm_check_for_link
argument_list|(
name|lm_context
argument_list|,
name|link_up
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|lm_debug
argument_list|(
literal|"%s: link is up with static parameters\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|al_eth_lm_static_parameters_override
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|struct
name|al_serdes_adv_tx_params
modifier|*
name|tx_params
parameter_list|,
name|struct
name|al_serdes_adv_rx_params
modifier|*
name|rx_params
parameter_list|)
block|{
if|if
condition|(
name|tx_params
operator|!=
name|NULL
condition|)
block|{
name|lm_context
operator|->
name|tx_params_override
operator|=
operator|*
name|tx_params
expr_stmt|;
name|lm_context
operator|->
name|tx_param_dirty
operator|=
literal|1
expr_stmt|;
name|lm_context
operator|->
name|serdes_tx_params_valid
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|rx_params
operator|!=
name|NULL
condition|)
block|{
name|lm_context
operator|->
name|rx_params_override
operator|=
operator|*
name|rx_params
expr_stmt|;
name|lm_context
operator|->
name|rx_param_dirty
operator|=
literal|1
expr_stmt|;
name|lm_context
operator|->
name|serdes_rx_params_valid
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|al_eth_lm_static_parameters_override_disable
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|boolean_t
name|tx_params
parameter_list|,
name|boolean_t
name|rx_params
parameter_list|)
block|{
if|if
condition|(
name|tx_params
operator|!=
literal|0
condition|)
name|lm_context
operator|->
name|serdes_tx_params_valid
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|rx_params
operator|!=
literal|0
condition|)
name|lm_context
operator|->
name|serdes_tx_params_valid
operator|=
name|FALSE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|al_eth_lm_static_parameters_get
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|struct
name|al_serdes_adv_tx_params
modifier|*
name|tx_params
parameter_list|,
name|struct
name|al_serdes_adv_rx_params
modifier|*
name|rx_params
parameter_list|)
block|{
if|if
condition|(
name|tx_params
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|lm_context
operator|->
name|serdes_tx_params_valid
condition|)
operator|*
name|tx_params
operator|=
name|lm_context
operator|->
name|tx_params_override
expr_stmt|;
else|else
name|lm_context
operator|->
name|serdes_obj
operator|->
name|tx_advanced_params_get
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
name|tx_params
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rx_params
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|lm_context
operator|->
name|serdes_rx_params_valid
condition|)
operator|*
name|rx_params
operator|=
name|lm_context
operator|->
name|rx_params_override
expr_stmt|;
else|else
name|lm_context
operator|->
name|serdes_obj
operator|->
name|rx_advanced_params_get
argument_list|(
name|lm_context
operator|->
name|serdes_obj
argument_list|,
name|lm_context
operator|->
name|lane
argument_list|,
name|rx_params
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|al_eth_lm_mode_convert_to_str
parameter_list|(
name|enum
name|al_eth_lm_link_mode
name|val
parameter_list|)
block|{
switch|switch
condition|(
name|val
condition|)
block|{
case|case
name|AL_ETH_LM_MODE_DISCONNECTED
case|:
return|return
operator|(
literal|"AL_ETH_LM_MODE_DISCONNECTED"
operator|)
return|;
case|case
name|AL_ETH_LM_MODE_10G_OPTIC
case|:
return|return
operator|(
literal|"AL_ETH_LM_MODE_10G_OPTIC"
operator|)
return|;
case|case
name|AL_ETH_LM_MODE_10G_DA
case|:
return|return
operator|(
literal|"AL_ETH_LM_MODE_10G_DA"
operator|)
return|;
case|case
name|AL_ETH_LM_MODE_1G
case|:
return|return
operator|(
literal|"AL_ETH_LM_MODE_1G"
operator|)
return|;
case|case
name|AL_ETH_LM_MODE_25G
case|:
return|return
operator|(
literal|"AL_ETH_LM_MODE_25G"
operator|)
return|;
block|}
return|return
operator|(
literal|"N/A"
operator|)
return|;
block|}
end_function

begin_function
name|void
name|al_eth_lm_debug_mode_set
parameter_list|(
name|struct
name|al_eth_lm_context
modifier|*
name|lm_context
parameter_list|,
name|boolean_t
name|enable
parameter_list|)
block|{
name|lm_context
operator|->
name|debug
operator|=
name|enable
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2004 Texas A&M University  * All rights reserved.  *  * Developer: Wm. Daryl Hawkins  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Intel ICH Watchdog Timer (WDT) driver  *  * Originally developed by Wm. Daryl Hawkins of Texas A&M  * Heavily modified by<des@FreeBSD.org>  *  * This is a tricky one.  The ICH WDT can't be treated as a regular PCI  * device as it's actually an integrated function of the ICH LPC interface  * bridge.  Detection is also awkward, because we can only infer the  * presence of the watchdog timer from the fact that the machine has an  * ICH chipset, or, on ACPI 2.x systems, by the presence of the 'WDDT'  * ACPI table (although this driver does not support the ACPI detection  * method).  *  * There is one slight problem on non-ACPI or ACPI 1.x systems: we have no  * way of knowing if the WDT is permanently disabled (either by the BIOS  * or in hardware).  *  * The WDT is programmed through I/O registers in the ACPI I/O space.  * Intel swears it's always at offset 0x60, so we use that.  *  * For details about the ICH WDT, see Intel Application Note AP-725  * (document no. 292273-001).  The WDT is also described in the individual  * chipset datasheets, e.g. Intel82801EB ICH5 / 82801ER ICH5R Datasheet  * (document no. 252516-001) sections 9.10 and 9.11.  *  * ICH6/7/8 support by Takeharu KATO<takeharu1219@ybb.ne.jp>  * SoC PMC support by Denir Li<denir.li@cas-well.com>  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/watchdog.h>
end_include

begin_include
include|#
directive|include
file|<isa/isavar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/ichwd/ichwd.h>
end_include

begin_decl_stmt
specifier|static
name|struct
name|ichwd_device
name|ichwd_devices
index|[]
init|=
block|{
block|{
name|DEVICEID_82801AA
block|,
literal|"Intel 82801AA watchdog timer"
block|,
literal|1
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801AB
block|,
literal|"Intel 82801AB watchdog timer"
block|,
literal|1
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801BA
block|,
literal|"Intel 82801BA watchdog timer"
block|,
literal|2
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801BAM
block|,
literal|"Intel 82801BAM watchdog timer"
block|,
literal|2
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801CA
block|,
literal|"Intel 82801CA watchdog timer"
block|,
literal|3
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801CAM
block|,
literal|"Intel 82801CAM watchdog timer"
block|,
literal|3
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801DB
block|,
literal|"Intel 82801DB watchdog timer"
block|,
literal|4
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801DBM
block|,
literal|"Intel 82801DBM watchdog timer"
block|,
literal|4
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801E
block|,
literal|"Intel 82801E watchdog timer"
block|,
literal|5
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801EB
block|,
literal|"Intel 82801EB watchdog timer"
block|,
literal|5
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801EBR
block|,
literal|"Intel 82801EB/ER watchdog timer"
block|,
literal|5
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_6300ESB
block|,
literal|"Intel 6300ESB watchdog timer"
block|,
literal|5
block|,
literal|1
block|}
block|,
block|{
name|DEVICEID_82801FBR
block|,
literal|"Intel 82801FB/FR watchdog timer"
block|,
literal|6
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH6M
block|,
literal|"Intel ICH6M watchdog timer"
block|,
literal|6
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH6W
block|,
literal|"Intel ICH6W watchdog timer"
block|,
literal|6
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH7
block|,
literal|"Intel ICH7 watchdog timer"
block|,
literal|7
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH7DH
block|,
literal|"Intel ICH7DH watchdog timer"
block|,
literal|7
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH7M
block|,
literal|"Intel ICH7M watchdog timer"
block|,
literal|7
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH7MDH
block|,
literal|"Intel ICH7MDH watchdog timer"
block|,
literal|7
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_NM10
block|,
literal|"Intel NM10 watchdog timer"
block|,
literal|7
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH8
block|,
literal|"Intel ICH8 watchdog timer"
block|,
literal|8
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH8DH
block|,
literal|"Intel ICH8DH watchdog timer"
block|,
literal|8
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH8DO
block|,
literal|"Intel ICH8DO watchdog timer"
block|,
literal|8
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH8M
block|,
literal|"Intel ICH8M watchdog timer"
block|,
literal|8
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH8ME
block|,
literal|"Intel ICH8M-E watchdog timer"
block|,
literal|8
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_63XXESB
block|,
literal|"Intel 63XXESB watchdog timer"
block|,
literal|8
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH9
block|,
literal|"Intel ICH9 watchdog timer"
block|,
literal|9
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH9DH
block|,
literal|"Intel ICH9DH watchdog timer"
block|,
literal|9
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH9DO
block|,
literal|"Intel ICH9DO watchdog timer"
block|,
literal|9
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH9M
block|,
literal|"Intel ICH9M watchdog timer"
block|,
literal|9
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH9ME
block|,
literal|"Intel ICH9M-E watchdog timer"
block|,
literal|9
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH9R
block|,
literal|"Intel ICH9R watchdog timer"
block|,
literal|9
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH10
block|,
literal|"Intel ICH10 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH10D
block|,
literal|"Intel ICH10D watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH10DO
block|,
literal|"Intel ICH10DO watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_ICH10R
block|,
literal|"Intel ICH10R watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PCH
block|,
literal|"Intel PCH watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PCHM
block|,
literal|"Intel PCH watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_P55
block|,
literal|"Intel P55 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PM55
block|,
literal|"Intel PM55 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_H55
block|,
literal|"Intel H55 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_QM57
block|,
literal|"Intel QM57 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_H57
block|,
literal|"Intel H57 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_HM55
block|,
literal|"Intel HM55 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_Q57
block|,
literal|"Intel Q57 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_HM57
block|,
literal|"Intel HM57 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PCHMSFF
block|,
literal|"Intel PCHMSFF watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_QS57
block|,
literal|"Intel QS57 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_3400
block|,
literal|"Intel 3400 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_3420
block|,
literal|"Intel 3420 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_3450
block|,
literal|"Intel 3450 watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT0
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT1
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT2
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT3
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT4
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT5
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT6
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT7
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT8
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT9
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT10
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT11
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT12
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT13
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT14
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT15
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT16
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT17
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT18
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT19
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT20
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT21
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT22
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT23
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT24
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT25
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT26
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT27
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT28
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT29
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT30
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_CPT31
block|,
literal|"Intel Cougar Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PATSBURG_LPC1
block|,
literal|"Intel Patsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PATSBURG_LPC2
block|,
literal|"Intel Patsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT0
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT1
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT2
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT3
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT4
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT5
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT6
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT7
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT8
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT9
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT10
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT11
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT12
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT13
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT14
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT15
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT16
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT17
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT18
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT19
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT20
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT21
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT22
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT23
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT24
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT25
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT26
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT27
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT28
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT29
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT30
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_PPT31
block|,
literal|"Intel Panther Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT0
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT1
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT2
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT3
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT4
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT5
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT6
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT7
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT8
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT9
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT10
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT11
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT12
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT13
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT14
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT15
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT16
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT17
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT18
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT19
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT20
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT21
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT22
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT23
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT24
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT25
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT26
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT27
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT28
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT29
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT30
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT31
block|,
literal|"Intel Lynx Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT1
block|,
literal|"Intel Wildcat Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT2
block|,
literal|"Intel Wildcat Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT3
block|,
literal|"Intel Wildcat Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT4
block|,
literal|"Intel Wildcat Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT6
block|,
literal|"Intel Wildcat Point watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG0
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG1
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG2
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG3
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG4
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG5
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG6
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG7
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG8
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG9
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG10
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG11
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG12
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG13
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG14
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG15
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG16
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG17
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG18
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG19
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG20
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG21
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG22
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG23
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG24
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG25
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG26
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG27
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG28
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG29
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG30
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WBG31
block|,
literal|"Intel Wellsburg watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT_LP0
block|,
literal|"Intel Lynx Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT_LP1
block|,
literal|"Intel Lynx Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT_LP2
block|,
literal|"Intel Lynx Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT_LP3
block|,
literal|"Intel Lynx Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT_LP4
block|,
literal|"Intel Lynx Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT_LP5
block|,
literal|"Intel Lynx Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT_LP6
block|,
literal|"Intel Lynx Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_LPT_LP7
block|,
literal|"Intel Lynx Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT_LP1
block|,
literal|"Intel Wildcat Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT_LP2
block|,
literal|"Intel Wildcat Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT_LP3
block|,
literal|"Intel Wildcat Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT_LP5
block|,
literal|"Intel Wildcat Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT_LP6
block|,
literal|"Intel Wildcat Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT_LP7
block|,
literal|"Intel Wildcat Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_WCPT_LP9
block|,
literal|"Intel Wildcat Point-LP watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_DH89XXCC_LPC
block|,
literal|"Intel DH89xxCC watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_COLETOCRK_LPC
block|,
literal|"Intel Coleto Creek watchdog timer"
block|,
literal|10
block|,
literal|2
block|}
block|,
block|{
name|DEVICEID_AVN0
block|,
literal|"Intel Avoton/Rangeley SoC watchdog timer"
block|,
literal|10
block|,
literal|3
block|}
block|,
block|{
name|DEVICEID_AVN1
block|,
literal|"Intel Avoton/Rangeley SoC watchdog timer"
block|,
literal|10
block|,
literal|3
block|}
block|,
block|{
name|DEVICEID_AVN2
block|,
literal|"Intel Avoton/Rangeley SoC watchdog timer"
block|,
literal|10
block|,
literal|3
block|}
block|,
block|{
name|DEVICEID_AVN3
block|,
literal|"Intel Avoton/Rangeley SoC watchdog timer"
block|,
literal|10
block|,
literal|3
block|}
block|,
block|{
name|DEVICEID_BAYTRAIL
block|,
literal|"Intel Bay Trail SoC watchdog timer"
block|,
literal|10
block|,
literal|3
block|}
block|,
block|{
name|DEVICEID_BRASWELL
block|,
literal|"Intel Braswell SoC watchdog timer"
block|,
literal|10
block|,
literal|3
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|ichwd_devclass
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ichwd_read_tco_1
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|)
define|\
value|bus_read_1((sc)->tco_res, (off))
end_define

begin_define
define|#
directive|define
name|ichwd_read_tco_2
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|)
define|\
value|bus_read_2((sc)->tco_res, (off))
end_define

begin_define
define|#
directive|define
name|ichwd_read_tco_4
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|)
define|\
value|bus_read_4((sc)->tco_res, (off))
end_define

begin_define
define|#
directive|define
name|ichwd_read_smi_4
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|)
define|\
value|bus_read_4((sc)->smi_res, (off))
end_define

begin_define
define|#
directive|define
name|ichwd_read_gcs_4
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|)
define|\
value|bus_read_4((sc)->gcs_res, (off))
end_define

begin_comment
comment|/* NB: TCO version 3 devices use the gcs_res resource for the PMC register. */
end_comment

begin_define
define|#
directive|define
name|ichwd_read_pmc_4
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|)
define|\
value|bus_read_4((sc)->gcs_res, (off))
end_define

begin_define
define|#
directive|define
name|ichwd_write_tco_1
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|,
name|val
parameter_list|)
define|\
value|bus_write_1((sc)->tco_res, (off), (val))
end_define

begin_define
define|#
directive|define
name|ichwd_write_tco_2
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|,
name|val
parameter_list|)
define|\
value|bus_write_2((sc)->tco_res, (off), (val))
end_define

begin_define
define|#
directive|define
name|ichwd_write_tco_4
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|,
name|val
parameter_list|)
define|\
value|bus_write_4((sc)->tco_res, (off), (val))
end_define

begin_define
define|#
directive|define
name|ichwd_write_smi_4
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|,
name|val
parameter_list|)
define|\
value|bus_write_4((sc)->smi_res, (off), (val))
end_define

begin_define
define|#
directive|define
name|ichwd_write_gcs_4
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|,
name|val
parameter_list|)
define|\
value|bus_write_4((sc)->gcs_res, (off), (val))
end_define

begin_comment
comment|/* NB: TCO version 3 devices use the gcs_res resource for the PMC register. */
end_comment

begin_define
define|#
directive|define
name|ichwd_write_pmc_4
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|,
name|val
parameter_list|)
define|\
value|bus_write_4((sc)->gcs_res, (off), (val))
end_define

begin_define
define|#
directive|define
name|ichwd_verbose_printf
parameter_list|(
name|dev
parameter_list|,
modifier|...
parameter_list|)
define|\
value|do {						\ 		if (bootverbose)			\ 			device_printf(dev, __VA_ARGS__);\ 	} while (0)
end_define

begin_comment
comment|/*  * Disable the watchdog timeout SMI handler.  *  * Apparently, some BIOSes install handlers that reset or disable the  * watchdog timer instead of resetting the system, so we disable the SMI  * (by clearing the SMI_TCO_EN bit of the SMI_EN register) to prevent this  * from happening.  */
end_comment

begin_function
specifier|static
name|__inline
name|void
name|ichwd_smi_disable
parameter_list|(
name|struct
name|ichwd_softc
modifier|*
name|sc
parameter_list|)
block|{
name|ichwd_write_smi_4
argument_list|(
name|sc
argument_list|,
name|SMI_EN
argument_list|,
name|ichwd_read_smi_4
argument_list|(
name|sc
argument_list|,
name|SMI_EN
argument_list|)
operator|&
operator|~
name|SMI_TCO_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Enable the watchdog timeout SMI handler.  See above for details.  */
end_comment

begin_function
specifier|static
name|__inline
name|void
name|ichwd_smi_enable
parameter_list|(
name|struct
name|ichwd_softc
modifier|*
name|sc
parameter_list|)
block|{
name|ichwd_write_smi_4
argument_list|(
name|sc
argument_list|,
name|SMI_EN
argument_list|,
name|ichwd_read_smi_4
argument_list|(
name|sc
argument_list|,
name|SMI_EN
argument_list|)
operator||
name|SMI_TCO_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Check if the watchdog SMI triggering is enabled.  */
end_comment

begin_function
specifier|static
name|__inline
name|int
name|ichwd_smi_is_enabled
parameter_list|(
name|struct
name|ichwd_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
operator|(
operator|(
name|ichwd_read_smi_4
argument_list|(
name|sc
argument_list|,
name|SMI_EN
argument_list|)
operator|&
name|SMI_TCO_EN
operator|)
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Reset the watchdog status bits.  */
end_comment

begin_function
specifier|static
name|__inline
name|void
name|ichwd_sts_reset
parameter_list|(
name|struct
name|ichwd_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* 	 * The watchdog status bits are set to 1 by the hardware to 	 * indicate various conditions.  They can be cleared by software 	 * by writing a 1, not a 0. 	 */
name|ichwd_write_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO1_STS
argument_list|,
name|TCO_TIMEOUT
argument_list|)
expr_stmt|;
comment|/* 	 * According to Intel's docs, clearing SECOND_TO_STS and BOOT_STS must 	 * be done in two separate operations. 	 */
name|ichwd_write_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO2_STS
argument_list|,
name|TCO_SECOND_TO_STS
argument_list|)
expr_stmt|;
name|ichwd_write_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO2_STS
argument_list|,
name|TCO_BOOT_STS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Enable the watchdog timer by clearing the TCO_TMR_HALT bit in the  * TCO1_CNT register.  This is complicated by the need to preserve bit 9  * of that same register, and the requirement that all other bits must be  * written back as zero.  */
end_comment

begin_function
specifier|static
name|__inline
name|void
name|ichwd_tmr_enable
parameter_list|(
name|struct
name|ichwd_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|cnt
decl_stmt|;
name|cnt
operator|=
name|ichwd_read_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO1_CNT
argument_list|)
operator|&
name|TCO_CNT_PRESERVE
expr_stmt|;
name|ichwd_write_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO1_CNT
argument_list|,
name|cnt
operator|&
operator|~
name|TCO_TMR_HALT
argument_list|)
expr_stmt|;
name|sc
operator|->
name|active
operator|=
literal|1
expr_stmt|;
name|ichwd_verbose_printf
argument_list|(
name|sc
operator|->
name|device
argument_list|,
literal|"timer enabled\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Disable the watchdog timer.  See above for details.  */
end_comment

begin_function
specifier|static
name|__inline
name|void
name|ichwd_tmr_disable
parameter_list|(
name|struct
name|ichwd_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|cnt
decl_stmt|;
name|cnt
operator|=
name|ichwd_read_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO1_CNT
argument_list|)
operator|&
name|TCO_CNT_PRESERVE
expr_stmt|;
name|ichwd_write_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO1_CNT
argument_list|,
name|cnt
operator||
name|TCO_TMR_HALT
argument_list|)
expr_stmt|;
name|sc
operator|->
name|active
operator|=
literal|0
expr_stmt|;
name|ichwd_verbose_printf
argument_list|(
name|sc
operator|->
name|device
argument_list|,
literal|"timer disabled\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Reload the watchdog timer: writing anything to any of the lower five  * bits of the TCO_RLD register reloads the timer from the last value  * written to TCO_TMR.  */
end_comment

begin_function
specifier|static
name|__inline
name|void
name|ichwd_tmr_reload
parameter_list|(
name|struct
name|ichwd_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|tco_version
operator|==
literal|1
condition|)
name|ichwd_write_tco_1
argument_list|(
name|sc
argument_list|,
name|TCO_RLD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|ichwd_write_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO_RLD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set the initial timeout value.  Note that this must always be followed  * by a reload.  */
end_comment

begin_function
specifier|static
name|__inline
name|void
name|ichwd_tmr_set
parameter_list|(
name|struct
name|ichwd_softc
modifier|*
name|sc
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|)
block|{
if|if
condition|(
name|timeout
operator|<
name|TCO_RLD_TMR_MIN
condition|)
name|timeout
operator|=
name|TCO_RLD_TMR_MIN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|tco_version
operator|==
literal|1
condition|)
block|{
name|uint8_t
name|tmr_val8
init|=
name|ichwd_read_tco_1
argument_list|(
name|sc
argument_list|,
name|TCO_TMR1
argument_list|)
decl_stmt|;
name|tmr_val8
operator|&=
operator|(
operator|~
name|TCO_RLD1_TMR_MAX
operator|&
literal|0xff
operator|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|>
name|TCO_RLD1_TMR_MAX
condition|)
name|timeout
operator|=
name|TCO_RLD1_TMR_MAX
expr_stmt|;
name|tmr_val8
operator||=
name|timeout
expr_stmt|;
name|ichwd_write_tco_1
argument_list|(
name|sc
argument_list|,
name|TCO_TMR1
argument_list|,
name|tmr_val8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
name|tmr_val16
init|=
name|ichwd_read_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO_TMR2
argument_list|)
decl_stmt|;
name|tmr_val16
operator|&=
operator|(
operator|~
name|TCO_RLD2_TMR_MAX
operator|&
literal|0xffff
operator|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|>
name|TCO_RLD2_TMR_MAX
condition|)
name|timeout
operator|=
name|TCO_RLD2_TMR_MAX
expr_stmt|;
name|tmr_val16
operator||=
name|timeout
expr_stmt|;
name|ichwd_write_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO_TMR2
argument_list|,
name|tmr_val16
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|timeout
operator|=
name|timeout
expr_stmt|;
name|ichwd_verbose_printf
argument_list|(
name|sc
operator|->
name|device
argument_list|,
literal|"timeout set to %u ticks\n"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|ichwd_clear_noreboot
parameter_list|(
name|struct
name|ichwd_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|status
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
comment|/* try to clear the NO_REBOOT bit */
switch|switch
condition|(
name|sc
operator|->
name|tco_version
condition|)
block|{
case|case
literal|1
case|:
name|status
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|ich
argument_list|,
name|ICH_GEN_STA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|status
operator|&=
operator|~
name|ICH_GEN_STA_NO_REBOOT
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|ich
argument_list|,
name|ICH_GEN_STA
argument_list|,
name|status
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|ich
argument_list|,
name|ICH_GEN_STA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|ICH_GEN_STA_NO_REBOOT
condition|)
name|rc
operator|=
name|EIO
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|status
operator|=
name|ichwd_read_gcs_4
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|status
operator|&=
operator|~
name|ICH_GCS_NO_REBOOT
expr_stmt|;
name|ichwd_write_gcs_4
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|status
operator|=
name|ichwd_read_gcs_4
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|ICH_GCS_NO_REBOOT
condition|)
name|rc
operator|=
name|EIO
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|status
operator|=
name|ichwd_read_pmc_4
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|status
operator|&=
operator|~
name|ICH_PMC_NO_REBOOT
expr_stmt|;
name|ichwd_write_pmc_4
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|status
operator|=
name|ichwd_read_pmc_4
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|ICH_PMC_NO_REBOOT
condition|)
name|rc
operator|=
name|EIO
expr_stmt|;
break|break;
default|default:
name|ichwd_verbose_printf
argument_list|(
name|sc
operator|->
name|device
argument_list|,
literal|"Unknown TCO Version: %d, can't set NO_REBOOT.\n"
argument_list|,
name|sc
operator|->
name|tco_version
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|rc
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|device
argument_list|,
literal|"ICH WDT present but disabled in BIOS or hardware\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Watchdog event handler - called by the framework to enable or disable  * the watchdog or change the initial timeout value.  */
end_comment

begin_function
specifier|static
name|void
name|ichwd_event
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|unsigned
name|int
name|cmd
parameter_list|,
name|int
modifier|*
name|error
parameter_list|)
block|{
name|struct
name|ichwd_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|unsigned
name|int
name|timeout
decl_stmt|;
comment|/* convert from power-of-two-ns to WDT ticks */
name|cmd
operator|&=
name|WD_INTERVAL
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|tco_version
operator|==
literal|3
condition|)
block|{
name|timeout
operator|=
operator|(
operator|(
name|uint64_t
operator|)
literal|1
operator|<<
name|cmd
operator|)
operator|/
name|ICHWD_TCO_V3_TICK
expr_stmt|;
block|}
else|else
block|{
name|timeout
operator|=
operator|(
operator|(
name|uint64_t
operator|)
literal|1
operator|<<
name|cmd
operator|)
operator|/
name|ICHWD_TICK
expr_stmt|;
block|}
if|if
condition|(
name|cmd
condition|)
block|{
if|if
condition|(
operator|!
name|sc
operator|->
name|active
condition|)
name|ichwd_tmr_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|!=
name|sc
operator|->
name|timeout
condition|)
name|ichwd_tmr_set
argument_list|(
name|sc
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|ichwd_tmr_reload
argument_list|(
name|sc
argument_list|)
expr_stmt|;
operator|*
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|active
condition|)
name|ichwd_tmr_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|device_t
name|ichwd_find_ich_lpc_bridge
parameter_list|(
name|device_t
name|isa
parameter_list|,
name|struct
name|ichwd_device
modifier|*
modifier|*
name|id_p
parameter_list|)
block|{
name|struct
name|ichwd_device
modifier|*
name|id
decl_stmt|;
name|device_t
name|isab
decl_stmt|,
name|pci
decl_stmt|;
name|uint16_t
name|devid
decl_stmt|;
comment|/* Check whether parent ISA bridge looks familiar. */
name|isab
operator|=
name|device_get_parent
argument_list|(
name|isa
argument_list|)
expr_stmt|;
name|pci
operator|=
name|device_get_parent
argument_list|(
name|isab
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci
operator|==
name|NULL
operator|||
name|device_get_devclass
argument_list|(
name|pci
argument_list|)
operator|!=
name|devclass_find
argument_list|(
literal|"pci"
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|pci_get_vendor
argument_list|(
name|isab
argument_list|)
operator|!=
name|VENDORID_INTEL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|devid
operator|=
name|pci_get_device
argument_list|(
name|isab
argument_list|)
expr_stmt|;
for|for
control|(
name|id
operator|=
name|ichwd_devices
init|;
name|id
operator|->
name|desc
operator|!=
name|NULL
condition|;
operator|++
name|id
control|)
block|{
if|if
condition|(
name|devid
operator|==
name|id
operator|->
name|device
condition|)
block|{
if|if
condition|(
name|id_p
operator|!=
name|NULL
condition|)
operator|*
name|id_p
operator|=
name|id
expr_stmt|;
return|return
operator|(
name|isab
operator|)
return|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Look for an ICH LPC interface bridge.  If one is found, register an  * ichwd device.  There can be only one.  */
end_comment

begin_function
specifier|static
name|void
name|ichwd_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
name|struct
name|ichwd_device
modifier|*
name|id_p
decl_stmt|;
name|device_t
name|ich
init|=
name|NULL
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|base_address
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|ich
operator|=
name|ichwd_find_ich_lpc_bridge
argument_list|(
name|parent
argument_list|,
operator|&
name|id_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ich
operator|==
name|NULL
condition|)
return|return;
comment|/* good, add child to bus */
if|if
condition|(
operator|(
name|dev
operator|=
name|device_find_child
argument_list|(
name|parent
argument_list|,
name|driver
operator|->
name|name
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|dev
operator|=
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|,
name|driver
operator|->
name|name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
condition|)
return|return;
switch|switch
condition|(
name|id_p
operator|->
name|tco_version
condition|)
block|{
case|case
literal|1
case|:
break|break;
case|case
literal|2
case|:
comment|/* get RCBA (root complex base address) */
name|base_address
operator|=
name|pci_read_config
argument_list|(
name|ich
argument_list|,
name|ICH_RCBA
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bus_set_resource
argument_list|(
name|ich
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
operator|(
name|base_address
operator|&
literal|0xffffc000
operator|)
operator|+
name|ICH_GCS_OFFSET
argument_list|,
name|ICH_GCS_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|ichwd_verbose_printf
argument_list|(
name|dev
argument_list|,
literal|"Can not set TCO v%d memory resource for RCBA\n"
argument_list|,
name|id_p
operator|->
name|tco_version
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* get PBASE (Power Management Controller base address) */
name|base_address
operator|=
name|pci_read_config
argument_list|(
name|ich
argument_list|,
name|ICH_PBASE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bus_set_resource
argument_list|(
name|ich
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
operator|(
name|base_address
operator|&
literal|0xfffffe00
operator|)
operator|+
name|ICH_PMC_OFFSET
argument_list|,
name|ICH_PMC_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|ichwd_verbose_printf
argument_list|(
name|dev
argument_list|,
literal|"Can not set TCO v%d memory resource for PBASE\n"
argument_list|,
name|id_p
operator|->
name|tco_version
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ichwd_verbose_printf
argument_list|(
name|dev
argument_list|,
literal|"Can not set unknown TCO v%d memory resource for unknown base address\n"
argument_list|,
name|id_p
operator|->
name|tco_version
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ichwd_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ichwd_device
modifier|*
name|id_p
decl_stmt|;
comment|/* Do not claim some ISA PnP device by accident. */
if|if
condition|(
name|isa_get_logicalid
argument_list|(
name|dev
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|ichwd_find_ich_lpc_bridge
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|id_p
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|id_p
operator|->
name|desc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichwd_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ichwd_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ichwd_device
modifier|*
name|id_p
decl_stmt|;
name|device_t
name|ich
decl_stmt|;
name|unsigned
name|int
name|pmbase
init|=
literal|0
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|device
operator|=
name|dev
expr_stmt|;
name|ich
operator|=
name|ichwd_find_ich_lpc_bridge
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|id_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ich
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|device
argument_list|,
literal|"Can not find ICH device.\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|ich
operator|=
name|ich
expr_stmt|;
name|sc
operator|->
name|ich_version
operator|=
name|id_p
operator|->
name|ich_version
expr_stmt|;
name|sc
operator|->
name|tco_version
operator|=
name|id_p
operator|->
name|tco_version
expr_stmt|;
comment|/* get ACPI base address */
name|pmbase
operator|=
name|pci_read_config
argument_list|(
name|ich
argument_list|,
name|ICH_PMBASE
argument_list|,
literal|2
argument_list|)
operator|&
name|ICH_PMBASE_MASK
expr_stmt|;
if|if
condition|(
name|pmbase
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ICH PMBASE register is empty\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* allocate I/O register space */
name|sc
operator|->
name|smi_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|smi_res
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|sc
operator|->
name|smi_rid
argument_list|,
name|pmbase
operator|+
name|SMI_BASE
argument_list|,
name|pmbase
operator|+
name|SMI_BASE
operator|+
name|SMI_LEN
operator|-
literal|1
argument_list|,
name|SMI_LEN
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|smi_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to reserve SMI registers\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|tco_rid
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|tco_res
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|sc
operator|->
name|tco_rid
argument_list|,
name|pmbase
operator|+
name|TCO_BASE
argument_list|,
name|pmbase
operator|+
name|TCO_BASE
operator|+
name|TCO_LEN
operator|-
literal|1
argument_list|,
name|TCO_LEN
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|tco_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to reserve TCO registers\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|gcs_rid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|tco_version
operator|>=
literal|2
condition|)
block|{
name|sc
operator|->
name|gcs_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|ich
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|gcs_rid
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|gcs_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to reserve GCS registers\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
name|ichwd_clear_noreboot
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* 	 * Determine if we are coming up after a watchdog-induced reset.  Some 	 * BIOSes may clear this bit at bootup, preventing us from reporting 	 * this case on such systems.  We clear this bit in ichwd_sts_reset(). 	 */
if|if
condition|(
operator|(
name|ichwd_read_tco_2
argument_list|(
name|sc
argument_list|,
name|TCO2_STS
argument_list|)
operator|&
name|TCO_SECOND_TO_STS
operator|)
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"resuming after hardware watchdog timeout\n"
argument_list|)
expr_stmt|;
comment|/* reset the watchdog status registers */
name|ichwd_sts_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* make sure the WDT starts out inactive */
name|ichwd_tmr_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* register the watchdog event handler */
name|sc
operator|->
name|ev_tag
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|watchdog_list
argument_list|,
name|ichwd_event
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* disable the SMI handler */
name|sc
operator|->
name|smi_enabled
operator|=
name|ichwd_smi_is_enabled
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ichwd_smi_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|tco_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|tco_rid
argument_list|,
name|sc
operator|->
name|tco_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|smi_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|smi_rid
argument_list|,
name|sc
operator|->
name|smi_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|gcs_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|ich
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|gcs_rid
argument_list|,
name|sc
operator|->
name|gcs_res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichwd_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ichwd_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* halt the watchdog timer */
if|if
condition|(
name|sc
operator|->
name|active
condition|)
name|ichwd_tmr_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* enable the SMI handler */
if|if
condition|(
name|sc
operator|->
name|smi_enabled
operator|!=
literal|0
condition|)
name|ichwd_smi_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* deregister event handler */
if|if
condition|(
name|sc
operator|->
name|ev_tag
operator|!=
name|NULL
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|watchdog_list
argument_list|,
name|sc
operator|->
name|ev_tag
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ev_tag
operator|=
name|NULL
expr_stmt|;
comment|/* reset the watchdog status registers */
name|ichwd_sts_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* deallocate I/O register space */
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|tco_rid
argument_list|,
name|sc
operator|->
name|tco_res
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|smi_rid
argument_list|,
name|sc
operator|->
name|smi_res
argument_list|)
expr_stmt|;
comment|/* deallocate memory resource */
if|if
condition|(
name|sc
operator|->
name|gcs_res
condition|)
name|bus_release_resource
argument_list|(
name|sc
operator|->
name|ich
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|gcs_rid
argument_list|,
name|sc
operator|->
name|gcs_res
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|ichwd_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|ichwd_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ichwd_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ichwd_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ichwd_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|ichwd_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ichwd_driver
init|=
block|{
literal|"ichwd"
block|,
name|ichwd_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ichwd_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ichwd
argument_list|,
name|isa
argument_list|,
name|ichwd_driver
argument_list|,
name|ichwd_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


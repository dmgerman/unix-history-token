begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2001-2017, Intel Corporation   All rights reserved.    Redistribution and use in source and binary forms, with or without   modification, are permitted provided that the following conditions are met:     1. Redistributions of source code must retain the above copyright notice,       this list of conditions and the following disclaimer.     2. Redistributions in binary form must reproduce the above copyright       notice, this list of conditions and the following disclaimer in the       documentation and/or other materials provided with the distribution.     3. Neither the name of the Intel Corporation nor the names of its       contributors may be used to endorse or promote products derived from       this software without specific prior written permission.    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE   LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR   CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF   SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS   INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN   CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)   ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"ixgbe.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|IXGBE_FDIR
end_ifdef

begin_function
name|void
name|ixgbe_init_fdir
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|u32
name|hdrm
init|=
literal|32
operator|<<
name|fdir_pballoc
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|adapter
operator|->
name|feat_en
operator|&
name|IXGBE_FEATURE_FDIR
operator|)
condition|)
return|return;
name|adapter
operator|->
name|hw
operator|.
name|mac
operator|.
name|ops
operator|.
name|setup_rxpba
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
literal|0
argument_list|,
name|hdrm
argument_list|,
name|PBA_STRATEGY_EQUAL
argument_list|)
expr_stmt|;
name|ixgbe_init_fdir_signature_82599
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|fdir_pballoc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_init_fdir */
end_comment

begin_function
name|void
name|ixgbe_reinit_fdir
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|adapter
init|=
name|context
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|adapter
operator|->
name|ifp
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|adapter
operator|->
name|feat_en
operator|&
name|IXGBE_FEATURE_FDIR
operator|)
condition|)
return|return;
if|if
condition|(
name|adapter
operator|->
name|fdir_reinit
operator|!=
literal|1
condition|)
comment|/* Shouldn't happen */
return|return;
name|ixgbe_reinit_fdir_tables_82599
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|fdir_reinit
operator|=
literal|0
expr_stmt|;
comment|/* re-enable flow director interrupts */
name|IXGBE_WRITE_REG
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|IXGBE_EIMS
argument_list|,
name|IXGBE_EIMS_FLOW_DIR
argument_list|)
expr_stmt|;
comment|/* Restart the interface */
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_reinit_fdir */
end_comment

begin_comment
comment|/************************************************************************  * ixgbe_atr  *  *   Parse packet headers so that Flow Director can make  *   a hashed filter table entry allowing traffic flows  *   to be identified and kept on the same cpu.  This  *   would be a performance hit, but we only do it at  *   IXGBE_FDIR_RATE of packets.  ************************************************************************/
end_comment

begin_function
name|void
name|ixgbe_atr
parameter_list|(
name|struct
name|tx_ring
modifier|*
name|txr
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|adapter
init|=
name|txr
operator|->
name|adapter
decl_stmt|;
name|struct
name|ix_queue
modifier|*
name|que
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|th
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|uh
decl_stmt|;
name|struct
name|ether_vlan_header
modifier|*
name|eh
decl_stmt|;
name|union
name|ixgbe_atr_hash_dword
name|input
init|=
block|{
operator|.
name|dword
operator|=
literal|0
block|}
decl_stmt|;
name|union
name|ixgbe_atr_hash_dword
name|common
init|=
block|{
operator|.
name|dword
operator|=
literal|0
block|}
decl_stmt|;
name|int
name|ehdrlen
decl_stmt|,
name|ip_hlen
decl_stmt|;
name|u16
name|etype
decl_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|mp
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
name|etype
operator|=
name|eh
operator|->
name|evl_proto
expr_stmt|;
block|}
else|else
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
expr_stmt|;
name|etype
operator|=
name|eh
operator|->
name|evl_encap_proto
expr_stmt|;
block|}
comment|/* Only handling IPv4 */
if|if
condition|(
name|etype
operator|!=
name|htons
argument_list|(
name|ETHERTYPE_IP
argument_list|)
condition|)
return|return;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|ip_hlen
operator|=
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
expr_stmt|;
comment|/* check if we're UDP or TCP */
switch|switch
condition|(
name|ip
operator|->
name|ip_p
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ip
operator|+
name|ip_hlen
operator|)
expr_stmt|;
comment|/* src and dst are inverted */
name|common
operator|.
name|port
operator|.
name|dst
operator|^=
name|th
operator|->
name|th_sport
expr_stmt|;
name|common
operator|.
name|port
operator|.
name|src
operator|^=
name|th
operator|->
name|th_dport
expr_stmt|;
name|input
operator|.
name|formatted
operator|.
name|flow_type
operator|^=
name|IXGBE_ATR_FLOW_TYPE_TCPV4
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|uh
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ip
operator|+
name|ip_hlen
operator|)
expr_stmt|;
comment|/* src and dst are inverted */
name|common
operator|.
name|port
operator|.
name|dst
operator|^=
name|uh
operator|->
name|uh_sport
expr_stmt|;
name|common
operator|.
name|port
operator|.
name|src
operator|^=
name|uh
operator|->
name|uh_dport
expr_stmt|;
name|input
operator|.
name|formatted
operator|.
name|flow_type
operator|^=
name|IXGBE_ATR_FLOW_TYPE_UDPV4
expr_stmt|;
break|break;
default|default:
return|return;
block|}
name|input
operator|.
name|formatted
operator|.
name|vlan_id
operator|=
name|htobe16
argument_list|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
condition|)
name|common
operator|.
name|flex_bytes
operator|^=
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
expr_stmt|;
else|else
name|common
operator|.
name|flex_bytes
operator|^=
name|etype
expr_stmt|;
name|common
operator|.
name|ip
operator|^=
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
operator|^
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
expr_stmt|;
name|que
operator|=
operator|&
name|adapter
operator|->
name|queues
index|[
name|txr
operator|->
name|me
index|]
expr_stmt|;
comment|/* 	 * This assumes the Rx queue and Tx 	 * queue are bound to the same CPU 	 */
name|ixgbe_fdir_add_signature_filter_82599
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|input
argument_list|,
name|common
argument_list|,
name|que
operator|->
name|msix
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_atr */
end_comment

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* TASK_INIT needs this function defined regardless if it's enabled */
end_comment

begin_function
name|void
name|ixgbe_reinit_fdir
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|UNREFERENCED_2PARAMETER
argument_list|(
name|context
argument_list|,
name|pending
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_reinit_fdir */
end_comment

begin_endif
endif|#
directive|endif
end_endif

end_unit


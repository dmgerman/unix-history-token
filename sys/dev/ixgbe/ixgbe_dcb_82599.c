begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2001-2015, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"ixgbe_type.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_dcb.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_dcb_82599.h"
end_include

begin_comment
comment|/**  * ixgbe_dcb_get_tc_stats_82599 - Returns status for each traffic class  * @hw: pointer to hardware structure  * @stats: pointer to statistics structure  * @tc_count:  Number of elements in bwg_array.  *  * This function returns the status data for each of the Traffic Classes in use.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_get_tc_stats_82599
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_hw_stats
modifier|*
name|stats
parameter_list|,
name|u8
name|tc_count
parameter_list|)
block|{
name|int
name|tc
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"dcb_get_tc_stats"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tc_count
operator|>
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|)
return|return
name|IXGBE_ERR_PARAM
return|;
comment|/* Statistics pertaining to each traffic class */
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|tc_count
condition|;
name|tc
operator|++
control|)
block|{
comment|/* Transmitted Packets */
name|stats
operator|->
name|qptc
index|[
name|tc
index|]
operator|+=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_QPTC
argument_list|(
name|tc
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Transmitted Bytes (read low first to prevent missed carry) */
name|stats
operator|->
name|qbtc
index|[
name|tc
index|]
operator|+=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_QBTC_L
argument_list|(
name|tc
argument_list|)
argument_list|)
expr_stmt|;
name|stats
operator|->
name|qbtc
index|[
name|tc
index|]
operator|+=
operator|(
operator|(
call|(
name|u64
call|)
argument_list|(
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_QBTC_H
argument_list|(
name|tc
argument_list|)
argument_list|)
argument_list|)
operator|)
operator|<<
literal|32
operator|)
expr_stmt|;
comment|/* Received Packets */
name|stats
operator|->
name|qprc
index|[
name|tc
index|]
operator|+=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_QPRC
argument_list|(
name|tc
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Received Bytes (read low first to prevent missed carry) */
name|stats
operator|->
name|qbrc
index|[
name|tc
index|]
operator|+=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_QBRC_L
argument_list|(
name|tc
argument_list|)
argument_list|)
expr_stmt|;
name|stats
operator|->
name|qbrc
index|[
name|tc
index|]
operator|+=
operator|(
operator|(
call|(
name|u64
call|)
argument_list|(
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_QBRC_H
argument_list|(
name|tc
argument_list|)
argument_list|)
argument_list|)
operator|)
operator|<<
literal|32
operator|)
expr_stmt|;
comment|/* Received Dropped Packet */
name|stats
operator|->
name|qprdc
index|[
name|tc
index|]
operator|+=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_QPRDC
argument_list|(
name|tc
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_get_pfc_stats_82599 - Return CBFC status data  * @hw: pointer to hardware structure  * @stats: pointer to statistics structure  * @tc_count:  Number of elements in bwg_array.  *  * This function returns the CBFC status data for each of the Traffic Classes.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_get_pfc_stats_82599
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_hw_stats
modifier|*
name|stats
parameter_list|,
name|u8
name|tc_count
parameter_list|)
block|{
name|int
name|tc
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"dcb_get_pfc_stats"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tc_count
operator|>
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|)
return|return
name|IXGBE_ERR_PARAM
return|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|tc_count
condition|;
name|tc
operator|++
control|)
block|{
comment|/* Priority XOFF Transmitted */
name|stats
operator|->
name|pxofftxc
index|[
name|tc
index|]
operator|+=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_PXOFFTXC
argument_list|(
name|tc
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Priority XOFF Received */
name|stats
operator|->
name|pxoffrxc
index|[
name|tc
index|]
operator|+=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_PXOFFRXCNT
argument_list|(
name|tc
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_rx_arbiter_82599 - Config Rx Data arbiter  * @hw: pointer to hardware structure  * @dcb_config: pointer to ixgbe_dcb_config structure  *  * Configure Rx Packet Arbiter and credits for each traffic class.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_rx_arbiter_82599
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
modifier|*
name|refill
parameter_list|,
name|u16
modifier|*
name|max
parameter_list|,
name|u8
modifier|*
name|bwg_id
parameter_list|,
name|u8
modifier|*
name|tsa
parameter_list|,
name|u8
modifier|*
name|map
parameter_list|)
block|{
name|u32
name|reg
init|=
literal|0
decl_stmt|;
name|u32
name|credit_refill
init|=
literal|0
decl_stmt|;
name|u32
name|credit_max
init|=
literal|0
decl_stmt|;
name|u8
name|i
init|=
literal|0
decl_stmt|;
comment|/* 	 * Disable the arbiter before changing parameters 	 * (always enable recycle mode; WSP) 	 */
name|reg
operator|=
name|IXGBE_RTRPCS_RRM
operator||
name|IXGBE_RTRPCS_RAC
operator||
name|IXGBE_RTRPCS_ARBDIS
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTRPCS
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* 	 * map all UPs to TCs. up_to_tc_bitmap for each TC has corresponding 	 * bits sets for the UPs that needs to be mappped to that TC. 	 * e.g if priorities 6 and 7 are to be mapped to a TC then the 	 * up_to_tc_bitmap value for that TC will be 11000000 in binary. 	 */
name|reg
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_USER_PRIORITY
condition|;
name|i
operator|++
control|)
name|reg
operator||=
operator|(
name|map
index|[
name|i
index|]
operator|<<
operator|(
name|i
operator|*
name|IXGBE_RTRUP2TC_UP_SHIFT
operator|)
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTRUP2TC
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Configure traffic class credits and priority */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|i
operator|++
control|)
block|{
name|credit_refill
operator|=
name|refill
index|[
name|i
index|]
expr_stmt|;
name|credit_max
operator|=
name|max
index|[
name|i
index|]
expr_stmt|;
name|reg
operator|=
name|credit_refill
operator||
operator|(
name|credit_max
operator|<<
name|IXGBE_RTRPT4C_MCL_SHIFT
operator|)
expr_stmt|;
name|reg
operator||=
call|(
name|u32
call|)
argument_list|(
name|bwg_id
index|[
name|i
index|]
argument_list|)
operator|<<
name|IXGBE_RTRPT4C_BWG_SHIFT
expr_stmt|;
if|if
condition|(
name|tsa
index|[
name|i
index|]
operator|==
name|ixgbe_dcb_tsa_strict
condition|)
name|reg
operator||=
name|IXGBE_RTRPT4C_LSP
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTRPT4C
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Configure Rx packet plane (recycle mode; WSP) and 	 * enable arbiter 	 */
name|reg
operator|=
name|IXGBE_RTRPCS_RRM
operator||
name|IXGBE_RTRPCS_RAC
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTRPCS
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_tx_desc_arbiter_82599 - Config Tx Desc. arbiter  * @hw: pointer to hardware structure  * @dcb_config: pointer to ixgbe_dcb_config structure  *  * Configure Tx Descriptor Arbiter and credits for each traffic class.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_tx_desc_arbiter_82599
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
modifier|*
name|refill
parameter_list|,
name|u16
modifier|*
name|max
parameter_list|,
name|u8
modifier|*
name|bwg_id
parameter_list|,
name|u8
modifier|*
name|tsa
parameter_list|)
block|{
name|u32
name|reg
decl_stmt|,
name|max_credits
decl_stmt|;
name|u8
name|i
decl_stmt|;
comment|/* Clear the per-Tx queue credits; we use per-TC instead */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
block|{
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTDQSEL
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTDT1C
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Configure traffic class credits and priority */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|i
operator|++
control|)
block|{
name|max_credits
operator|=
name|max
index|[
name|i
index|]
expr_stmt|;
name|reg
operator|=
name|max_credits
operator|<<
name|IXGBE_RTTDT2C_MCL_SHIFT
expr_stmt|;
name|reg
operator||=
name|refill
index|[
name|i
index|]
expr_stmt|;
name|reg
operator||=
call|(
name|u32
call|)
argument_list|(
name|bwg_id
index|[
name|i
index|]
argument_list|)
operator|<<
name|IXGBE_RTTDT2C_BWG_SHIFT
expr_stmt|;
if|if
condition|(
name|tsa
index|[
name|i
index|]
operator|==
name|ixgbe_dcb_tsa_group_strict_cee
condition|)
name|reg
operator||=
name|IXGBE_RTTDT2C_GSP
expr_stmt|;
if|if
condition|(
name|tsa
index|[
name|i
index|]
operator|==
name|ixgbe_dcb_tsa_strict
condition|)
name|reg
operator||=
name|IXGBE_RTTDT2C_LSP
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTDT2C
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Configure Tx descriptor plane (recycle mode; WSP) and 	 * enable arbiter 	 */
name|reg
operator|=
name|IXGBE_RTTDCS_TDPAC
operator||
name|IXGBE_RTTDCS_TDRM
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTDCS
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_tx_data_arbiter_82599 - Config Tx Data arbiter  * @hw: pointer to hardware structure  * @dcb_config: pointer to ixgbe_dcb_config structure  *  * Configure Tx Packet Arbiter and credits for each traffic class.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_tx_data_arbiter_82599
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
modifier|*
name|refill
parameter_list|,
name|u16
modifier|*
name|max
parameter_list|,
name|u8
modifier|*
name|bwg_id
parameter_list|,
name|u8
modifier|*
name|tsa
parameter_list|,
name|u8
modifier|*
name|map
parameter_list|)
block|{
name|u32
name|reg
decl_stmt|;
name|u8
name|i
decl_stmt|;
comment|/* 	 * Disable the arbiter before changing parameters 	 * (always enable recycle mode; SP; arb delay) 	 */
name|reg
operator|=
name|IXGBE_RTTPCS_TPPAC
operator||
name|IXGBE_RTTPCS_TPRM
operator||
operator|(
name|IXGBE_RTTPCS_ARBD_DCB
operator|<<
name|IXGBE_RTTPCS_ARBD_SHIFT
operator|)
operator||
name|IXGBE_RTTPCS_ARBDIS
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTPCS
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* 	 * map all UPs to TCs. up_to_tc_bitmap for each TC has corresponding 	 * bits sets for the UPs that needs to be mappped to that TC. 	 * e.g if priorities 6 and 7 are to be mapped to a TC then the 	 * up_to_tc_bitmap value for that TC will be 11000000 in binary. 	 */
name|reg
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_USER_PRIORITY
condition|;
name|i
operator|++
control|)
name|reg
operator||=
operator|(
name|map
index|[
name|i
index|]
operator|<<
operator|(
name|i
operator|*
name|IXGBE_RTTUP2TC_UP_SHIFT
operator|)
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTUP2TC
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Configure traffic class credits and priority */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|refill
index|[
name|i
index|]
expr_stmt|;
name|reg
operator||=
call|(
name|u32
call|)
argument_list|(
name|max
index|[
name|i
index|]
argument_list|)
operator|<<
name|IXGBE_RTTPT2C_MCL_SHIFT
expr_stmt|;
name|reg
operator||=
call|(
name|u32
call|)
argument_list|(
name|bwg_id
index|[
name|i
index|]
argument_list|)
operator|<<
name|IXGBE_RTTPT2C_BWG_SHIFT
expr_stmt|;
if|if
condition|(
name|tsa
index|[
name|i
index|]
operator|==
name|ixgbe_dcb_tsa_group_strict_cee
condition|)
name|reg
operator||=
name|IXGBE_RTTPT2C_GSP
expr_stmt|;
if|if
condition|(
name|tsa
index|[
name|i
index|]
operator|==
name|ixgbe_dcb_tsa_strict
condition|)
name|reg
operator||=
name|IXGBE_RTTPT2C_LSP
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTPT2C
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Configure Tx packet plane (recycle mode; SP; arb delay) and 	 * enable arbiter 	 */
name|reg
operator|=
name|IXGBE_RTTPCS_TPPAC
operator||
name|IXGBE_RTTPCS_TPRM
operator||
operator|(
name|IXGBE_RTTPCS_ARBD_DCB
operator|<<
name|IXGBE_RTTPCS_ARBD_SHIFT
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTPCS
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_pfc_82599 - Configure priority flow control  * @hw: pointer to hardware structure  * @pfc_en: enabled pfc bitmask  * @map: priority to tc assignments indexed by priority  *  * Configure Priority Flow Control (PFC) for each traffic class.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_pfc_82599
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
name|pfc_en
parameter_list|,
name|u8
modifier|*
name|map
parameter_list|)
block|{
name|u32
name|i
decl_stmt|,
name|j
decl_stmt|,
name|fcrtl
decl_stmt|,
name|reg
decl_stmt|;
name|u8
name|max_tc
init|=
literal|0
decl_stmt|;
comment|/* Enable Transmit Priority Flow Control */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCCFG
argument_list|,
name|IXGBE_FCCFG_TFCE_PRIORITY
argument_list|)
expr_stmt|;
comment|/* Enable Receive Priority Flow Control */
name|reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MFLCN
argument_list|)
expr_stmt|;
name|reg
operator||=
name|IXGBE_MFLCN_DPF
expr_stmt|;
comment|/* 	 * X540 supports per TC Rx priority flow control.  So 	 * clear all TCs and only enable those that should be 	 * enabled. 	 */
name|reg
operator|&=
operator|~
operator|(
name|IXGBE_MFLCN_RPFCE_MASK
operator||
name|IXGBE_MFLCN_RFCE
operator|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
operator|>=
name|ixgbe_mac_X540
condition|)
name|reg
operator||=
name|pfc_en
operator|<<
name|IXGBE_MFLCN_RPFCE_SHIFT
expr_stmt|;
if|if
condition|(
name|pfc_en
condition|)
name|reg
operator||=
name|IXGBE_MFLCN_RPFCE
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MFLCN
argument_list|,
name|reg
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_USER_PRIORITY
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|map
index|[
name|i
index|]
operator|>
name|max_tc
condition|)
name|max_tc
operator|=
name|map
index|[
name|i
index|]
expr_stmt|;
block|}
comment|/* Configure PFC Tx thresholds per TC */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|max_tc
condition|;
name|i
operator|++
control|)
block|{
name|int
name|enabled
init|=
literal|0
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|IXGBE_DCB_MAX_USER_PRIORITY
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|map
index|[
name|j
index|]
operator|==
name|i
operator|)
operator|&&
operator|(
name|pfc_en
operator|&
operator|(
literal|1
operator|<<
name|j
operator|)
operator|)
condition|)
block|{
name|enabled
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|enabled
condition|)
block|{
name|reg
operator|=
operator|(
name|hw
operator|->
name|fc
operator|.
name|high_water
index|[
name|i
index|]
operator|<<
literal|10
operator|)
operator||
name|IXGBE_FCRTH_FCEN
expr_stmt|;
name|fcrtl
operator|=
operator|(
name|hw
operator|->
name|fc
operator|.
name|low_water
index|[
name|i
index|]
operator|<<
literal|10
operator|)
operator||
name|IXGBE_FCRTL_XONE
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCRTL_82599
argument_list|(
name|i
argument_list|)
argument_list|,
name|fcrtl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * In order to prevent Tx hangs when the internal Tx 			 * switch is enabled we must set the high water mark 			 * to the Rx packet buffer size - 24KB.  This allows 			 * the Tx switch to function even under heavy Rx 			 * workloads. 			 */
name|reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RXPBSIZE
argument_list|(
name|i
argument_list|)
argument_list|)
operator|-
literal|24576
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCRTL_82599
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCRTH_82599
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|i
operator|++
control|)
block|{
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCRTL_82599
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCRTH_82599
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Configure pause time (2 TCs per register) */
name|reg
operator|=
name|hw
operator|->
name|fc
operator|.
name|pause_time
operator||
operator|(
name|hw
operator|->
name|fc
operator|.
name|pause_time
operator|<<
literal|16
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
operator|/
literal|2
operator|)
condition|;
name|i
operator|++
control|)
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCTTV
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Configure flow control refresh threshold value */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCRTV
argument_list|,
name|hw
operator|->
name|fc
operator|.
name|pause_time
operator|/
literal|2
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_tc_stats_82599 - Config traffic class statistics  * @hw: pointer to hardware structure  *  * Configure queue statistics registers, all queues belonging to same traffic  * class uses a single set of queue statistics counters.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_tc_stats_82599
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_dcb_config
modifier|*
name|dcb_config
parameter_list|)
block|{
name|u32
name|reg
init|=
literal|0
decl_stmt|;
name|u8
name|i
init|=
literal|0
decl_stmt|;
name|u8
name|tc_count
init|=
literal|8
decl_stmt|;
name|bool
name|vt_mode
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|dcb_config
operator|!=
name|NULL
condition|)
block|{
name|tc_count
operator|=
name|dcb_config
operator|->
name|num_tcs
operator|.
name|pg_tcs
expr_stmt|;
name|vt_mode
operator|=
name|dcb_config
operator|->
name|vt_mode
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
operator|(
name|tc_count
operator|==
literal|8
operator|&&
name|vt_mode
operator|==
name|FALSE
operator|)
operator|||
name|tc_count
operator|==
literal|4
operator|)
condition|)
return|return
name|IXGBE_ERR_PARAM
return|;
if|if
condition|(
name|tc_count
operator|==
literal|8
operator|&&
name|vt_mode
operator|==
name|FALSE
condition|)
block|{
comment|/* 		 * Receive Queues stats setting 		 * 32 RQSMR registers, each configuring 4 queues. 		 * 		 * Set all 16 queues of each TC to the same stat 		 * with TC 'n' going to stat 'n'. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
literal|0x01010101
operator|*
operator|(
name|i
operator|/
literal|4
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RQSMR
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Transmit Queues stats setting 		 * 32 TQSM registers, each controlling 4 queues. 		 * 		 * Set all queues of each TC to the same stat 		 * with TC 'n' going to stat 'n'. 		 * Tx queues are allocated non-uniformly to TCs: 		 * 32, 32, 16, 16, 8, 8, 8, 8. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|<
literal|8
condition|)
name|reg
operator|=
literal|0x00000000
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|<
literal|16
condition|)
name|reg
operator|=
literal|0x01010101
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|<
literal|20
condition|)
name|reg
operator|=
literal|0x02020202
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|<
literal|24
condition|)
name|reg
operator|=
literal|0x03030303
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|<
literal|26
condition|)
name|reg
operator|=
literal|0x04040404
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|<
literal|28
condition|)
name|reg
operator|=
literal|0x05050505
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|<
literal|30
condition|)
name|reg
operator|=
literal|0x06060606
expr_stmt|;
else|else
name|reg
operator|=
literal|0x07070707
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_TQSM
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|tc_count
operator|==
literal|4
operator|&&
name|vt_mode
operator|==
name|FALSE
condition|)
block|{
comment|/* 		 * Receive Queues stats setting 		 * 32 RQSMR registers, each configuring 4 queues. 		 * 		 * Set all 16 queues of each TC to the same stat 		 * with TC 'n' going to stat 'n'. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|8
operator|>
literal|3
condition|)
comment|/* In 4 TC mode, odd 16-queue ranges are 				 *  not used. 				*/
continue|continue;
name|reg
operator|=
literal|0x01010101
operator|*
operator|(
name|i
operator|/
literal|8
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RQSMR
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Transmit Queues stats setting 		 * 32 TQSM registers, each controlling 4 queues. 		 * 		 * Set all queues of each TC to the same stat 		 * with TC 'n' going to stat 'n'. 		 * Tx queues are allocated non-uniformly to TCs: 		 * 64, 32, 16, 16. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|<
literal|16
condition|)
name|reg
operator|=
literal|0x00000000
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|<
literal|24
condition|)
name|reg
operator|=
literal|0x01010101
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|<
literal|28
condition|)
name|reg
operator|=
literal|0x02020202
expr_stmt|;
else|else
name|reg
operator|=
literal|0x03030303
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_TQSM
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|tc_count
operator|==
literal|4
operator|&&
name|vt_mode
operator|==
name|TRUE
condition|)
block|{
comment|/* 		 * Receive Queues stats setting 		 * 32 RQSMR registers, each configuring 4 queues. 		 * 		 * Queue Indexing in 32 VF with DCB mode maps 4 TC's to each 		 * pool. Set all 32 queues of each TC across pools to the same 		 * stat with TC 'n' going to stat 'n'. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RQSMR
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0x03020100
argument_list|)
expr_stmt|;
comment|/* 		 * Transmit Queues stats setting 		 * 32 TQSM registers, each controlling 4 queues. 		 * 		 * Queue Indexing in 32 VF with DCB mode maps 4 TC's to each 		 * pool. Set all 32 queues of each TC across pools to the same 		 * stat with TC 'n' going to stat 'n'. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_TQSM
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0x03020100
argument_list|)
expr_stmt|;
block|}
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_82599 - Configure general DCB parameters  * @hw: pointer to hardware structure  * @dcb_config: pointer to ixgbe_dcb_config structure  *  * Configure general DCB parameters.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_82599
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_dcb_config
modifier|*
name|dcb_config
parameter_list|)
block|{
name|u32
name|reg
decl_stmt|;
name|u32
name|q
decl_stmt|;
comment|/* Disable the Tx desc arbiter so that MTQC can be changed */
name|reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTDCS
argument_list|)
expr_stmt|;
name|reg
operator||=
name|IXGBE_RTTDCS_ARBDIS
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTDCS
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MRQC
argument_list|)
expr_stmt|;
if|if
condition|(
name|dcb_config
operator|->
name|num_tcs
operator|.
name|pg_tcs
operator|==
literal|8
condition|)
block|{
comment|/* Enable DCB for Rx with 8 TCs */
switch|switch
condition|(
name|reg
operator|&
name|IXGBE_MRQC_MRQE_MASK
condition|)
block|{
case|case
literal|0
case|:
case|case
name|IXGBE_MRQC_RT4TCEN
case|:
comment|/* RSS disabled cases */
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
name|IXGBE_MRQC_MRQE_MASK
operator|)
operator||
name|IXGBE_MRQC_RT8TCEN
expr_stmt|;
break|break;
case|case
name|IXGBE_MRQC_RSSEN
case|:
case|case
name|IXGBE_MRQC_RTRSS4TCEN
case|:
comment|/* RSS enabled cases */
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
name|IXGBE_MRQC_MRQE_MASK
operator|)
operator||
name|IXGBE_MRQC_RTRSS8TCEN
expr_stmt|;
break|break;
default|default:
comment|/* 			 * Unsupported value, assume stale data, 			 * overwrite no RSS 			 */
name|ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
name|IXGBE_MRQC_MRQE_MASK
operator|)
operator||
name|IXGBE_MRQC_RT8TCEN
expr_stmt|;
block|}
block|}
if|if
condition|(
name|dcb_config
operator|->
name|num_tcs
operator|.
name|pg_tcs
operator|==
literal|4
condition|)
block|{
comment|/* We support both VT-on and VT-off with 4 TCs. */
if|if
condition|(
name|dcb_config
operator|->
name|vt_mode
condition|)
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
name|IXGBE_MRQC_MRQE_MASK
operator|)
operator||
name|IXGBE_MRQC_VMDQRT4TCEN
expr_stmt|;
else|else
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
name|IXGBE_MRQC_MRQE_MASK
operator|)
operator||
name|IXGBE_MRQC_RTRSS4TCEN
expr_stmt|;
block|}
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MRQC
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Enable DCB for Tx with 8 TCs */
if|if
condition|(
name|dcb_config
operator|->
name|num_tcs
operator|.
name|pg_tcs
operator|==
literal|8
condition|)
name|reg
operator|=
name|IXGBE_MTQC_RT_ENA
operator||
name|IXGBE_MTQC_8TC_8TQ
expr_stmt|;
else|else
block|{
comment|/* We support both VT-on and VT-off with 4 TCs. */
name|reg
operator|=
name|IXGBE_MTQC_RT_ENA
operator||
name|IXGBE_MTQC_4TC_4TQ
expr_stmt|;
if|if
condition|(
name|dcb_config
operator|->
name|vt_mode
condition|)
name|reg
operator||=
name|IXGBE_MTQC_VT_ENA
expr_stmt|;
block|}
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MTQC
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Disable drop for all queues */
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
literal|128
condition|;
name|q
operator|++
control|)
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_QDE
argument_list|,
operator|(
name|IXGBE_QDE_WRITE
operator||
operator|(
name|q
operator|<<
name|IXGBE_QDE_IDX_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Enable the Tx desc arbiter */
name|reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTDCS
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|IXGBE_RTTDCS_ARBDIS
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RTTDCS
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Enable Security TX Buffer IFG for DCB */
name|reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_SECTXMINIFG
argument_list|)
expr_stmt|;
name|reg
operator||=
name|IXGBE_SECTX_DCB
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_SECTXMINIFG
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_hw_config_82599 - Configure and enable DCB  * @hw: pointer to hardware structure  * @dcb_config: pointer to ixgbe_dcb_config structure  *  * Configure dcb settings and enable dcb mode.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_hw_config_82599
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|int
name|link_speed
parameter_list|,
name|u16
modifier|*
name|refill
parameter_list|,
name|u16
modifier|*
name|max
parameter_list|,
name|u8
modifier|*
name|bwg_id
parameter_list|,
name|u8
modifier|*
name|tsa
parameter_list|,
name|u8
modifier|*
name|map
parameter_list|)
block|{
name|UNREFERENCED_1PARAMETER
argument_list|(
name|link_speed
argument_list|)
expr_stmt|;
name|ixgbe_dcb_config_rx_arbiter_82599
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwg_id
argument_list|,
name|tsa
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|ixgbe_dcb_config_tx_desc_arbiter_82599
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwg_id
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
name|ixgbe_dcb_config_tx_data_arbiter_82599
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwg_id
argument_list|,
name|tsa
argument_list|,
name|map
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

end_unit


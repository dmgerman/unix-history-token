begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2001-2017, Intel Corporation   All rights reserved.    Redistribution and use in source and binary forms, with or without   modification, are permitted provided that the following conditions are met:     1. Redistributions of source code must retain the above copyright notice,       this list of conditions and the following disclaimer.     2. Redistributions in binary form must reproduce the above copyright       notice, this list of conditions and the following disclaimer in the       documentation and/or other materials provided with the distribution.     3. Neither the name of the Intel Corporation nor the names of its       contributors may be used to endorse or promote products derived from       this software without specific prior written permission.    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE   LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR   CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF   SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS   INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN   CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)   ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"ixgbe.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|PCI_IOV
end_ifdef

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_IXGBE_SRIOV
argument_list|,
literal|"ix_sriov"
argument_list|,
literal|"ix SR-IOV allocations"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/************************************************************************  * ixgbe_pci_iov_detach  ************************************************************************/
end_comment

begin_function
name|int
name|ixgbe_pci_iov_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
name|pci_iov_detach
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/************************************************************************  * ixgbe_define_iov_schemas  ************************************************************************/
end_comment

begin_function
name|void
name|ixgbe_define_iov_schemas
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
modifier|*
name|error
parameter_list|)
block|{
name|nvlist_t
modifier|*
name|pf_schema
decl_stmt|,
modifier|*
name|vf_schema
decl_stmt|;
name|pf_schema
operator|=
name|pci_iov_schema_alloc_node
argument_list|()
expr_stmt|;
name|vf_schema
operator|=
name|pci_iov_schema_alloc_node
argument_list|()
expr_stmt|;
name|pci_iov_schema_add_unicast_mac
argument_list|(
name|vf_schema
argument_list|,
literal|"mac-addr"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pci_iov_schema_add_bool
argument_list|(
name|vf_schema
argument_list|,
literal|"mac-anti-spoof"
argument_list|,
name|IOV_SCHEMA_HASDEFAULT
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|pci_iov_schema_add_bool
argument_list|(
name|vf_schema
argument_list|,
literal|"allow-set-mac"
argument_list|,
name|IOV_SCHEMA_HASDEFAULT
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|pci_iov_schema_add_bool
argument_list|(
name|vf_schema
argument_list|,
literal|"allow-promisc"
argument_list|,
name|IOV_SCHEMA_HASDEFAULT
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
operator|*
name|error
operator|=
name|pci_iov_attach
argument_list|(
name|dev
argument_list|,
name|pf_schema
argument_list|,
name|vf_schema
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Error %d setting up SR-IOV\n"
argument_list|,
operator|*
name|error
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ixgbe_define_iov_schemas */
end_comment

begin_comment
comment|/************************************************************************  * ixgbe_align_all_queue_indices  ************************************************************************/
end_comment

begin_function
specifier|inline
name|void
name|ixgbe_align_all_queue_indices
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|index
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|adapter
operator|->
name|num_queues
condition|;
name|i
operator|++
control|)
block|{
name|index
operator|=
name|ixgbe_vf_que_index
argument_list|(
name|adapter
operator|->
name|iov_mode
argument_list|,
name|adapter
operator|->
name|pool
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|rx_rings
index|[
name|i
index|]
operator|.
name|me
operator|=
name|index
expr_stmt|;
name|adapter
operator|->
name|tx_rings
index|[
name|i
index|]
operator|.
name|me
operator|=
name|index
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Support functions for SR-IOV/VF management */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|ixgbe_send_vf_msg
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|u32
name|msg
parameter_list|)
block|{
if|if
condition|(
name|vf
operator|->
name|flags
operator|&
name|IXGBE_VF_CTS
condition|)
name|msg
operator||=
name|IXGBE_VT_MSGTYPE_CTS
expr_stmt|;
name|adapter
operator|->
name|hw
operator|.
name|mbx
operator|.
name|ops
operator|.
name|write
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
operator|&
name|msg
argument_list|,
literal|1
argument_list|,
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ixgbe_send_vf_ack
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|u32
name|msg
parameter_list|)
block|{
name|msg
operator|&=
name|IXGBE_VT_MSG_MASK
expr_stmt|;
name|ixgbe_send_vf_msg
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
operator||
name|IXGBE_VT_MSGTYPE_ACK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ixgbe_send_vf_nack
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|u32
name|msg
parameter_list|)
block|{
name|msg
operator|&=
name|IXGBE_VT_MSG_MASK
expr_stmt|;
name|ixgbe_send_vf_msg
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
operator||
name|IXGBE_VT_MSGTYPE_NACK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ixgbe_process_vf_ack
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|flags
operator|&
name|IXGBE_VF_CTS
operator|)
condition|)
name|ixgbe_send_vf_nack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|boolean_t
name|ixgbe_vf_mac_changed
parameter_list|(
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|mac
parameter_list|)
block|{
return|return
operator|(
name|bcmp
argument_list|(
name|mac
argument_list|,
name|vf
operator|->
name|ether_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|ixgbe_vf_queues
parameter_list|(
name|int
name|mode
parameter_list|)
block|{
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|IXGBE_64_VM
case|:
return|return
operator|(
literal|2
operator|)
return|;
case|case
name|IXGBE_32_VM
case|:
return|return
operator|(
literal|4
operator|)
return|;
case|case
name|IXGBE_NO_VM
case|:
default|default:
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|inline
name|int
name|ixgbe_vf_que_index
parameter_list|(
name|int
name|mode
parameter_list|,
name|int
name|vfnum
parameter_list|,
name|int
name|num
parameter_list|)
block|{
return|return
operator|(
operator|(
name|vfnum
operator|*
name|ixgbe_vf_queues
argument_list|(
name|mode
argument_list|)
operator|)
operator|+
name|num
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ixgbe_update_max_frame
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|int
name|max_frame
parameter_list|)
block|{
if|if
condition|(
name|adapter
operator|->
name|max_frame_size
operator|<
name|max_frame
condition|)
name|adapter
operator|->
name|max_frame_size
operator|=
name|max_frame
expr_stmt|;
block|}
end_function

begin_function
specifier|inline
name|u32
name|ixgbe_get_mrqc
parameter_list|(
name|int
name|iov_mode
parameter_list|)
block|{
name|u32
name|mrqc
decl_stmt|;
switch|switch
condition|(
name|iov_mode
condition|)
block|{
case|case
name|IXGBE_64_VM
case|:
name|mrqc
operator|=
name|IXGBE_MRQC_VMDQRSS64EN
expr_stmt|;
break|break;
case|case
name|IXGBE_32_VM
case|:
name|mrqc
operator|=
name|IXGBE_MRQC_VMDQRSS32EN
expr_stmt|;
break|break;
case|case
name|IXGBE_NO_VM
case|:
name|mrqc
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Unexpected SR-IOV mode %d"
argument_list|,
name|iov_mode
argument_list|)
expr_stmt|;
block|}
return|return
name|mrqc
return|;
block|}
end_function

begin_function
specifier|inline
name|u32
name|ixgbe_get_mtqc
parameter_list|(
name|int
name|iov_mode
parameter_list|)
block|{
name|uint32_t
name|mtqc
decl_stmt|;
switch|switch
condition|(
name|iov_mode
condition|)
block|{
case|case
name|IXGBE_64_VM
case|:
name|mtqc
operator|=
name|IXGBE_MTQC_64VF
operator||
name|IXGBE_MTQC_VT_ENA
expr_stmt|;
break|break;
case|case
name|IXGBE_32_VM
case|:
name|mtqc
operator|=
name|IXGBE_MTQC_32VF
operator||
name|IXGBE_MTQC_VT_ENA
expr_stmt|;
break|break;
case|case
name|IXGBE_NO_VM
case|:
name|mtqc
operator|=
name|IXGBE_MTQC_64Q_1PB
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Unexpected SR-IOV mode %d"
argument_list|,
name|iov_mode
argument_list|)
expr_stmt|;
block|}
return|return
name|mtqc
return|;
block|}
end_function

begin_function
name|void
name|ixgbe_ping_all_vfs
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|struct
name|ixgbe_vf
modifier|*
name|vf
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|adapter
operator|->
name|num_vfs
condition|;
name|i
operator|++
control|)
block|{
name|vf
operator|=
operator|&
name|adapter
operator|->
name|vfs
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|vf
operator|->
name|flags
operator|&
name|IXGBE_VF_ACTIVE
condition|)
name|ixgbe_send_vf_msg
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|IXGBE_PF_CONTROL_MSG
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ixgbe_ping_all_vfs */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_set_default_vlan
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|uint16_t
name|tag
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|vmolr
decl_stmt|,
name|vmvir
decl_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
name|vf
operator|->
name|vlan_tag
operator|=
name|tag
expr_stmt|;
name|vmolr
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VMOLR
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Do not receive packets that pass inexact filters. */
name|vmolr
operator|&=
operator|~
operator|(
name|IXGBE_VMOLR_ROMPE
operator||
name|IXGBE_VMOLR_ROPE
operator|)
expr_stmt|;
comment|/* Disable Multicast Promicuous Mode. */
name|vmolr
operator|&=
operator|~
name|IXGBE_VMOLR_MPE
expr_stmt|;
comment|/* Accept broadcasts. */
name|vmolr
operator||=
name|IXGBE_VMOLR_BAM
expr_stmt|;
if|if
condition|(
name|tag
operator|==
literal|0
condition|)
block|{
comment|/* Accept non-vlan tagged traffic. */
comment|//vmolr |= IXGBE_VMOLR_AUPE;
comment|/* Allow VM to tag outgoing traffic; no default tag. */
name|vmvir
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* Require vlan-tagged traffic. */
name|vmolr
operator|&=
operator|~
name|IXGBE_VMOLR_AUPE
expr_stmt|;
comment|/* Tag all traffic with provided vlan tag. */
name|vmvir
operator|=
operator|(
name|tag
operator||
name|IXGBE_VMVIR_VLANA_DEFAULT
operator|)
expr_stmt|;
block|}
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VMOLR
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
argument_list|,
name|vmolr
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VMVIR
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
argument_list|,
name|vmvir
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_set_default_vlan */
end_comment

begin_function
specifier|static
name|boolean_t
name|ixgbe_vf_frame_size_compatible
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|)
block|{
comment|/* 	 * Frame size compatibility between PF and VF is only a problem on 	 * 82599-based cards.  X540 and later support any combination of jumbo 	 * frames on PFs and VFs. 	 */
if|if
condition|(
name|adapter
operator|->
name|hw
operator|.
name|mac
operator|.
name|type
operator|!=
name|ixgbe_mac_82599EB
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
switch|switch
condition|(
name|vf
operator|->
name|api_ver
condition|)
block|{
case|case
name|IXGBE_API_VER_1_0
case|:
case|case
name|IXGBE_API_VER_UNKNOWN
case|:
comment|/* 		 * On legacy (1.0 and older) VF versions, we don't support jumbo 		 * frames on either the PF or the VF. 		 */
if|if
condition|(
name|adapter
operator|->
name|max_frame_size
operator|>
name|ETHER_MAX_LEN
operator|||
name|vf
operator|->
name|max_frame_size
operator|>
name|ETHER_MAX_LEN
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
return|return
operator|(
name|TRUE
operator|)
return|;
break|break;
case|case
name|IXGBE_API_VER_1_1
case|:
default|default:
comment|/* 		 * 1.1 or later VF versions always work if they aren't using 		 * jumbo frames. 		 */
if|if
condition|(
name|vf
operator|->
name|max_frame_size
operator|<=
name|ETHER_MAX_LEN
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
comment|/* 		 * Jumbo frames only work with VFs if the PF is also using jumbo 		 * frames. 		 */
if|if
condition|(
name|adapter
operator|->
name|max_frame_size
operator|<=
name|ETHER_MAX_LEN
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* ixgbe_vf_frame_size_compatible */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_process_vf_reset
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|)
block|{
name|ixgbe_vf_set_default_vlan
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|vf
operator|->
name|default_vlan
argument_list|)
expr_stmt|;
comment|// XXX clear multicast addresses
name|ixgbe_clear_rar
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|vf
operator|->
name|rar_index
argument_list|)
expr_stmt|;
name|vf
operator|->
name|api_ver
operator|=
name|IXGBE_API_VER_UNKNOWN
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_process_vf_reset */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_enable_transmit
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|vf_index
decl_stmt|,
name|vfte
decl_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
name|vf_index
operator|=
name|IXGBE_VF_INDEX
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
name|vfte
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTE
argument_list|(
name|vf_index
argument_list|)
argument_list|)
expr_stmt|;
name|vfte
operator||=
name|IXGBE_VF_BIT
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTE
argument_list|(
name|vf_index
argument_list|)
argument_list|,
name|vfte
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_enable_transmit */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_enable_receive
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|vf_index
decl_stmt|,
name|vfre
decl_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
name|vf_index
operator|=
name|IXGBE_VF_INDEX
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
name|vfre
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRE
argument_list|(
name|vf_index
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ixgbe_vf_frame_size_compatible
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
condition|)
name|vfre
operator||=
name|IXGBE_VF_BIT
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
else|else
name|vfre
operator|&=
operator|~
name|IXGBE_VF_BIT
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRE
argument_list|(
name|vf_index
argument_list|)
argument_list|,
name|vfre
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_enable_receive */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_reset_msg
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|uint32_t
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|ack
decl_stmt|;
name|uint32_t
name|resp
index|[
name|IXGBE_VF_PERMADDR_MSG_LEN
index|]
decl_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
name|ixgbe_process_vf_reset
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ixgbe_validate_mac_addr
argument_list|(
name|vf
operator|->
name|ether_addr
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ixgbe_set_rar
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|vf
operator|->
name|rar_index
argument_list|,
name|vf
operator|->
name|ether_addr
argument_list|,
name|vf
operator|->
name|pool
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|ack
operator|=
name|IXGBE_VT_MSGTYPE_ACK
expr_stmt|;
block|}
else|else
name|ack
operator|=
name|IXGBE_VT_MSGTYPE_NACK
expr_stmt|;
name|ixgbe_vf_enable_transmit
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|ixgbe_vf_enable_receive
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|vf
operator|->
name|flags
operator||=
name|IXGBE_VF_CTS
expr_stmt|;
name|resp
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_RESET
operator||
name|ack
operator||
name|IXGBE_VT_MSGTYPE_CTS
expr_stmt|;
name|bcopy
argument_list|(
name|vf
operator|->
name|ether_addr
argument_list|,
operator|&
name|resp
index|[
literal|1
index|]
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|resp
index|[
literal|3
index|]
operator|=
name|hw
operator|->
name|mac
operator|.
name|mc_filter_type
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|ops
operator|.
name|write
argument_list|(
name|hw
argument_list|,
name|resp
argument_list|,
name|IXGBE_VF_PERMADDR_MSG_LEN
argument_list|,
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_reset_msg */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_set_mac
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|uint32_t
modifier|*
name|msg
parameter_list|)
block|{
name|uint8_t
modifier|*
name|mac
decl_stmt|;
name|mac
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
index|[
literal|1
index|]
expr_stmt|;
comment|/* Check that the VF has permission to change the MAC address. */
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|flags
operator|&
name|IXGBE_VF_CAP_MAC
operator|)
operator|&&
name|ixgbe_vf_mac_changed
argument_list|(
name|vf
argument_list|,
name|mac
argument_list|)
condition|)
block|{
name|ixgbe_send_vf_nack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ixgbe_validate_mac_addr
argument_list|(
name|mac
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ixgbe_send_vf_nack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|bcopy
argument_list|(
name|mac
argument_list|,
name|vf
operator|->
name|ether_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|ixgbe_set_rar
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|vf
operator|->
name|rar_index
argument_list|,
name|vf
operator|->
name|ether_addr
argument_list|,
name|vf
operator|->
name|pool
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|ixgbe_send_vf_ack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_set_mac */
end_comment

begin_comment
comment|/*  * VF multicast addresses are set by using the appropriate bit in  * 1 of 128 32 bit addresses (4096 possible).  */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_set_mc_addr
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|u32
modifier|*
name|msg
parameter_list|)
block|{
name|u16
modifier|*
name|list
init|=
operator|(
name|u16
operator|*
operator|)
operator|&
name|msg
index|[
literal|1
index|]
decl_stmt|;
name|int
name|entries
decl_stmt|;
name|u32
name|vmolr
decl_stmt|,
name|vec_bit
decl_stmt|,
name|vec_reg
decl_stmt|,
name|mta_reg
decl_stmt|;
name|entries
operator|=
operator|(
name|msg
index|[
literal|0
index|]
operator|&
name|IXGBE_VT_MSGINFO_MASK
operator|)
operator|>>
name|IXGBE_VT_MSGINFO_SHIFT
expr_stmt|;
name|entries
operator|=
name|min
argument_list|(
name|entries
argument_list|,
name|IXGBE_MAX_VF_MC
argument_list|)
expr_stmt|;
name|vmolr
operator|=
name|IXGBE_READ_REG
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|IXGBE_VMOLR
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|vf
operator|->
name|num_mc_hashes
operator|=
name|entries
expr_stmt|;
comment|/* Set the appropriate MTA bit */
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|entries
condition|;
name|i
operator|++
control|)
block|{
name|vf
operator|->
name|mc_hash
index|[
name|i
index|]
operator|=
name|list
index|[
name|i
index|]
expr_stmt|;
name|vec_reg
operator|=
operator|(
name|vf
operator|->
name|mc_hash
index|[
name|i
index|]
operator|>>
literal|5
operator|)
operator|&
literal|0x7F
expr_stmt|;
name|vec_bit
operator|=
name|vf
operator|->
name|mc_hash
index|[
name|i
index|]
operator|&
literal|0x1F
expr_stmt|;
name|mta_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|IXGBE_MTA
argument_list|(
name|vec_reg
argument_list|)
argument_list|)
expr_stmt|;
name|mta_reg
operator||=
operator|(
literal|1
operator|<<
name|vec_bit
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|IXGBE_MTA
argument_list|(
name|vec_reg
argument_list|)
argument_list|,
name|mta_reg
argument_list|)
expr_stmt|;
block|}
name|vmolr
operator||=
name|IXGBE_VMOLR_ROMPE
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|IXGBE_VMOLR
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
argument_list|,
name|vmolr
argument_list|)
expr_stmt|;
name|ixgbe_send_vf_ack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_set_mc_addr */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_set_vlan
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|uint32_t
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|int
name|enable
decl_stmt|;
name|uint16_t
name|tag
decl_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
name|enable
operator|=
name|IXGBE_VT_MSGINFO
argument_list|(
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tag
operator|=
name|msg
index|[
literal|1
index|]
operator|&
name|IXGBE_VLVF_VLANID_MASK
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|flags
operator|&
name|IXGBE_VF_CAP_VLAN
operator|)
condition|)
block|{
name|ixgbe_send_vf_nack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* It is illegal to enable vlan tag 0. */
if|if
condition|(
name|tag
operator|==
literal|0
operator|&&
name|enable
operator|!=
literal|0
condition|)
block|{
name|ixgbe_send_vf_nack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|ixgbe_set_vfta
argument_list|(
name|hw
argument_list|,
name|tag
argument_list|,
name|vf
operator|->
name|pool
argument_list|,
name|enable
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ixgbe_send_vf_ack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_set_vlan */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_set_lpe
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|uint32_t
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|vf_max_size
decl_stmt|,
name|pf_max_size
decl_stmt|,
name|mhadd
decl_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
name|vf_max_size
operator|=
name|msg
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|vf_max_size
operator|<
name|ETHER_CRC_LEN
condition|)
block|{
comment|/* We intentionally ACK invalid LPE requests. */
name|ixgbe_send_vf_ack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|vf_max_size
operator|-=
name|ETHER_CRC_LEN
expr_stmt|;
if|if
condition|(
name|vf_max_size
operator|>
name|IXGBE_MAX_FRAME_SIZE
condition|)
block|{
comment|/* We intentionally ACK invalid LPE requests. */
name|ixgbe_send_vf_ack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|vf
operator|->
name|max_frame_size
operator|=
name|vf_max_size
expr_stmt|;
name|ixgbe_update_max_frame
argument_list|(
name|adapter
argument_list|,
name|vf
operator|->
name|max_frame_size
argument_list|)
expr_stmt|;
comment|/* 	 * We might have to disable reception to this VF if the frame size is 	 * not compatible with the config on the PF. 	 */
name|ixgbe_vf_enable_receive
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|mhadd
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MHADD
argument_list|)
expr_stmt|;
name|pf_max_size
operator|=
operator|(
name|mhadd
operator|&
name|IXGBE_MHADD_MFS_MASK
operator|)
operator|>>
name|IXGBE_MHADD_MFS_SHIFT
expr_stmt|;
if|if
condition|(
name|pf_max_size
operator|<
name|adapter
operator|->
name|max_frame_size
condition|)
block|{
name|mhadd
operator|&=
operator|~
name|IXGBE_MHADD_MFS_MASK
expr_stmt|;
name|mhadd
operator||=
name|adapter
operator|->
name|max_frame_size
operator|<<
name|IXGBE_MHADD_MFS_SHIFT
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MHADD
argument_list|,
name|mhadd
argument_list|)
expr_stmt|;
block|}
name|ixgbe_send_vf_ack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_set_lpe */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_set_macvlan
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|uint32_t
modifier|*
name|msg
parameter_list|)
block|{
comment|//XXX implement this
name|ixgbe_send_vf_nack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_set_macvlan */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_api_negotiate
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|uint32_t
modifier|*
name|msg
parameter_list|)
block|{
switch|switch
condition|(
name|msg
index|[
literal|1
index|]
condition|)
block|{
case|case
name|IXGBE_API_VER_1_0
case|:
case|case
name|IXGBE_API_VER_1_1
case|:
name|vf
operator|->
name|api_ver
operator|=
name|msg
index|[
literal|1
index|]
expr_stmt|;
name|ixgbe_send_vf_ack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|vf
operator|->
name|api_ver
operator|=
name|IXGBE_API_VER_UNKNOWN
expr_stmt|;
name|ixgbe_send_vf_nack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* ixgbe_vf_api_negotiate */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_vf_get_queues
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|,
name|uint32_t
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|resp
index|[
name|IXGBE_VF_GET_QUEUES_RESP_LEN
index|]
decl_stmt|;
name|int
name|num_queues
decl_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
comment|/* GET_QUEUES is not supported on pre-1.1 APIs. */
switch|switch
condition|(
name|msg
index|[
literal|0
index|]
condition|)
block|{
case|case
name|IXGBE_API_VER_1_0
case|:
case|case
name|IXGBE_API_VER_UNKNOWN
case|:
name|ixgbe_send_vf_nack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|resp
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_GET_QUEUES
operator||
name|IXGBE_VT_MSGTYPE_ACK
operator||
name|IXGBE_VT_MSGTYPE_CTS
expr_stmt|;
name|num_queues
operator|=
name|ixgbe_vf_queues
argument_list|(
name|adapter
operator|->
name|iov_mode
argument_list|)
expr_stmt|;
name|resp
index|[
name|IXGBE_VF_TX_QUEUES
index|]
operator|=
name|num_queues
expr_stmt|;
name|resp
index|[
name|IXGBE_VF_RX_QUEUES
index|]
operator|=
name|num_queues
expr_stmt|;
name|resp
index|[
name|IXGBE_VF_TRANS_VLAN
index|]
operator|=
operator|(
name|vf
operator|->
name|default_vlan
operator|!=
literal|0
operator|)
expr_stmt|;
name|resp
index|[
name|IXGBE_VF_DEF_QUEUE
index|]
operator|=
literal|0
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|ops
operator|.
name|write
argument_list|(
name|hw
argument_list|,
name|resp
argument_list|,
name|IXGBE_VF_GET_QUEUES_RESP_LEN
argument_list|,
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_get_queues */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_process_vf_msg
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|msg
index|[
name|IXGBE_VFMAILBOX_SIZE
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
name|error
operator|=
name|hw
operator|->
name|mbx
operator|.
name|ops
operator|.
name|read
argument_list|(
name|hw
argument_list|,
name|msg
argument_list|,
name|IXGBE_VFMAILBOX_SIZE
argument_list|,
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return;
name|CTR3
argument_list|(
name|KTR_MALLOC
argument_list|,
literal|"%s: received msg %x from %d"
argument_list|,
name|adapter
operator|->
name|ifp
operator|->
name|if_xname
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|,
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
index|[
literal|0
index|]
operator|==
name|IXGBE_VF_RESET
condition|)
block|{
name|ixgbe_vf_reset_msg
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|flags
operator|&
name|IXGBE_VF_CTS
operator|)
condition|)
block|{
name|ixgbe_send_vf_nack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|msg
index|[
literal|0
index|]
operator|&
name|IXGBE_VT_MSG_MASK
condition|)
block|{
case|case
name|IXGBE_VF_SET_MAC_ADDR
case|:
name|ixgbe_vf_set_mac
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXGBE_VF_SET_MULTICAST
case|:
name|ixgbe_vf_set_mc_addr
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXGBE_VF_SET_VLAN
case|:
name|ixgbe_vf_set_vlan
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXGBE_VF_SET_LPE
case|:
name|ixgbe_vf_set_lpe
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXGBE_VF_SET_MACVLAN
case|:
name|ixgbe_vf_set_macvlan
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXGBE_VF_API_NEGOTIATE
case|:
name|ixgbe_vf_api_negotiate
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|IXGBE_VF_GET_QUEUES
case|:
name|ixgbe_vf_get_queues
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ixgbe_send_vf_nack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|msg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ixgbe_process_vf_msg */
end_comment

begin_comment
comment|/* Tasklet for handling VF -> PF mailbox messages */
end_comment

begin_function
name|void
name|ixgbe_handle_mbx
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|adapter
decl_stmt|;
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|ixgbe_vf
modifier|*
name|vf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|adapter
operator|=
name|context
expr_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
name|IXGBE_CORE_LOCK
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|adapter
operator|->
name|num_vfs
condition|;
name|i
operator|++
control|)
block|{
name|vf
operator|=
operator|&
name|adapter
operator|->
name|vfs
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|vf
operator|->
name|flags
operator|&
name|IXGBE_VF_ACTIVE
condition|)
block|{
if|if
condition|(
name|hw
operator|->
name|mbx
operator|.
name|ops
operator|.
name|check_for_rst
argument_list|(
name|hw
argument_list|,
name|vf
operator|->
name|pool
argument_list|)
operator|==
literal|0
condition|)
name|ixgbe_process_vf_reset
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mbx
operator|.
name|ops
operator|.
name|check_for_msg
argument_list|(
name|hw
argument_list|,
name|vf
operator|->
name|pool
argument_list|)
operator|==
literal|0
condition|)
name|ixgbe_process_vf_msg
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mbx
operator|.
name|ops
operator|.
name|check_for_ack
argument_list|(
name|hw
argument_list|,
name|vf
operator|->
name|pool
argument_list|)
operator|==
literal|0
condition|)
name|ixgbe_process_vf_ack
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
expr_stmt|;
block|}
block|}
name|IXGBE_CORE_UNLOCK
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_handle_mbx */
end_comment

begin_function
name|int
name|ixgbe_init_iov
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u16
name|num_vfs
parameter_list|,
specifier|const
name|nvlist_t
modifier|*
name|config
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|adapter
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|;
name|adapter
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|iov_mode
operator|=
name|IXGBE_NO_VM
expr_stmt|;
if|if
condition|(
name|num_vfs
operator|==
literal|0
condition|)
block|{
comment|/* Would we ever get num_vfs = 0? */
name|retval
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|err_init_iov
goto|;
block|}
comment|/* 	 * We've got to reserve a VM's worth of queues for the PF, 	 * thus we go into "64 VF mode" if 32+ VFs are requested. 	 * With 64 VFs, you can only have two queues per VF. 	 * With 32 VFs, you can have up to four queues per VF. 	 */
if|if
condition|(
name|num_vfs
operator|>=
name|IXGBE_32_VM
condition|)
name|adapter
operator|->
name|iov_mode
operator|=
name|IXGBE_64_VM
expr_stmt|;
else|else
name|adapter
operator|->
name|iov_mode
operator|=
name|IXGBE_32_VM
expr_stmt|;
comment|/* Again, reserving 1 VM's worth of queues for the PF */
name|adapter
operator|->
name|pool
operator|=
name|adapter
operator|->
name|iov_mode
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|num_vfs
operator|>
name|adapter
operator|->
name|pool
operator|)
operator|||
operator|(
name|num_vfs
operator|>=
name|IXGBE_64_VM
operator|)
condition|)
block|{
name|retval
operator|=
name|ENOSPC
expr_stmt|;
goto|goto
name|err_init_iov
goto|;
block|}
name|IXGBE_CORE_LOCK
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|vfs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|adapter
operator|->
name|vfs
argument_list|)
operator|*
name|num_vfs
argument_list|,
name|M_IXGBE_SRIOV
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|->
name|vfs
operator|==
name|NULL
condition|)
block|{
name|retval
operator|=
name|ENOMEM
expr_stmt|;
name|IXGBE_CORE_UNLOCK
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
goto|goto
name|err_init_iov
goto|;
block|}
name|adapter
operator|->
name|num_vfs
operator|=
name|num_vfs
expr_stmt|;
name|adapter
operator|->
name|init_locked
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|feat_en
operator||=
name|IXGBE_FEATURE_SRIOV
expr_stmt|;
name|IXGBE_CORE_UNLOCK
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
name|err_init_iov
label|:
name|adapter
operator|->
name|num_vfs
operator|=
literal|0
expr_stmt|;
name|adapter
operator|->
name|pool
operator|=
literal|0
expr_stmt|;
name|adapter
operator|->
name|iov_mode
operator|=
name|IXGBE_NO_VM
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/* ixgbe_init_iov */
end_comment

begin_function
name|void
name|ixgbe_uninit_iov
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|struct
name|adapter
modifier|*
name|adapter
decl_stmt|;
name|uint32_t
name|pf_reg
decl_stmt|,
name|vf_reg
decl_stmt|;
name|adapter
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
name|IXGBE_CORE_LOCK
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
comment|/* Enable rx/tx for the PF and disable it for all VFs. */
name|pf_reg
operator|=
name|IXGBE_VF_INDEX
argument_list|(
name|adapter
operator|->
name|pool
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRE
argument_list|(
name|pf_reg
argument_list|)
argument_list|,
name|IXGBE_VF_BIT
argument_list|(
name|adapter
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTE
argument_list|(
name|pf_reg
argument_list|)
argument_list|,
name|IXGBE_VF_BIT
argument_list|(
name|adapter
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pf_reg
operator|==
literal|0
condition|)
name|vf_reg
operator|=
literal|1
expr_stmt|;
else|else
name|vf_reg
operator|=
literal|0
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRE
argument_list|(
name|vf_reg
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTE
argument_list|(
name|vf_reg
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VT_CTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|adapter
operator|->
name|vfs
argument_list|,
name|M_IXGBE_SRIOV
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|vfs
operator|=
name|NULL
expr_stmt|;
name|adapter
operator|->
name|num_vfs
operator|=
literal|0
expr_stmt|;
name|adapter
operator|->
name|feat_en
operator|&=
operator|~
name|IXGBE_FEATURE_SRIOV
expr_stmt|;
name|IXGBE_CORE_UNLOCK
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_uninit_iov */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_init_vf
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|ixgbe_vf
modifier|*
name|vf
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
decl_stmt|;
name|uint32_t
name|vf_index
decl_stmt|,
name|pfmbimr
decl_stmt|;
name|IXGBE_CORE_LOCK_ASSERT
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
name|hw
operator|=
operator|&
name|adapter
operator|->
name|hw
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|vf
operator|->
name|flags
operator|&
name|IXGBE_VF_ACTIVE
operator|)
condition|)
return|return;
name|vf_index
operator|=
name|IXGBE_VF_INDEX
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
name|pfmbimr
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_PFMBIMR
argument_list|(
name|vf_index
argument_list|)
argument_list|)
expr_stmt|;
name|pfmbimr
operator||=
name|IXGBE_VF_BIT
argument_list|(
name|vf
operator|->
name|pool
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_PFMBIMR
argument_list|(
name|vf_index
argument_list|)
argument_list|,
name|pfmbimr
argument_list|)
expr_stmt|;
name|ixgbe_vf_set_default_vlan
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|vf
operator|->
name|vlan_tag
argument_list|)
expr_stmt|;
comment|// XXX multicast addresses
if|if
condition|(
name|ixgbe_validate_mac_addr
argument_list|(
name|vf
operator|->
name|ether_addr
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ixgbe_set_rar
argument_list|(
operator|&
name|adapter
operator|->
name|hw
argument_list|,
name|vf
operator|->
name|rar_index
argument_list|,
name|vf
operator|->
name|ether_addr
argument_list|,
name|vf
operator|->
name|pool
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
name|ixgbe_vf_enable_transmit
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|ixgbe_vf_enable_receive
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|ixgbe_send_vf_msg
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|,
name|IXGBE_PF_CONTROL_MSG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_init_vf */
end_comment

begin_function
name|void
name|ixgbe_initialize_iov
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|struct
name|ixgbe_hw
modifier|*
name|hw
init|=
operator|&
name|adapter
operator|->
name|hw
decl_stmt|;
name|uint32_t
name|mrqc
decl_stmt|,
name|mtqc
decl_stmt|,
name|vt_ctl
decl_stmt|,
name|vf_reg
decl_stmt|,
name|gcr_ext
decl_stmt|,
name|gpie
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|adapter
operator|->
name|iov_mode
operator|==
name|IXGBE_NO_VM
condition|)
return|return;
name|IXGBE_CORE_LOCK_ASSERT
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
comment|/* RMW appropriate registers based on IOV mode */
comment|/* Read... */
name|mrqc
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MRQC
argument_list|)
expr_stmt|;
name|gcr_ext
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GCR_EXT
argument_list|)
expr_stmt|;
name|gpie
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GPIE
argument_list|)
expr_stmt|;
comment|/* Modify... */
name|mrqc
operator|&=
operator|~
name|IXGBE_MRQC_MRQE_MASK
expr_stmt|;
name|mtqc
operator|=
name|IXGBE_MTQC_VT_ENA
expr_stmt|;
comment|/* No initial MTQC read needed */
name|gcr_ext
operator||=
name|IXGBE_GCR_EXT_MSIX_EN
expr_stmt|;
name|gcr_ext
operator|&=
operator|~
name|IXGBE_GCR_EXT_VT_MODE_MASK
expr_stmt|;
name|gpie
operator|&=
operator|~
name|IXGBE_GPIE_VTMODE_MASK
expr_stmt|;
switch|switch
condition|(
name|adapter
operator|->
name|iov_mode
condition|)
block|{
case|case
name|IXGBE_64_VM
case|:
name|mrqc
operator||=
name|IXGBE_MRQC_VMDQRSS64EN
expr_stmt|;
name|mtqc
operator||=
name|IXGBE_MTQC_64VF
expr_stmt|;
name|gcr_ext
operator||=
name|IXGBE_GCR_EXT_VT_MODE_64
expr_stmt|;
name|gpie
operator||=
name|IXGBE_GPIE_VTMODE_64
expr_stmt|;
break|break;
case|case
name|IXGBE_32_VM
case|:
name|mrqc
operator||=
name|IXGBE_MRQC_VMDQRSS32EN
expr_stmt|;
name|mtqc
operator||=
name|IXGBE_MTQC_32VF
expr_stmt|;
name|gcr_ext
operator||=
name|IXGBE_GCR_EXT_VT_MODE_32
expr_stmt|;
name|gpie
operator||=
name|IXGBE_GPIE_VTMODE_32
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Unexpected SR-IOV mode %d"
argument_list|,
name|adapter
operator|->
name|iov_mode
argument_list|)
expr_stmt|;
block|}
comment|/* Write... */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MRQC
argument_list|,
name|mrqc
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MTQC
argument_list|,
name|mtqc
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GCR_EXT
argument_list|,
name|gcr_ext
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GPIE
argument_list|,
name|gpie
argument_list|)
expr_stmt|;
comment|/* Enable rx/tx for the PF. */
name|vf_reg
operator|=
name|IXGBE_VF_INDEX
argument_list|(
name|adapter
operator|->
name|pool
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRE
argument_list|(
name|vf_reg
argument_list|)
argument_list|,
name|IXGBE_VF_BIT
argument_list|(
name|adapter
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTE
argument_list|(
name|vf_reg
argument_list|)
argument_list|,
name|IXGBE_VF_BIT
argument_list|(
name|adapter
operator|->
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Allow VM-to-VM communication. */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_PFDTXGSWC
argument_list|,
name|IXGBE_PFDTXGSWC_VT_LBEN
argument_list|)
expr_stmt|;
name|vt_ctl
operator|=
name|IXGBE_VT_CTL_VT_ENABLE
operator||
name|IXGBE_VT_CTL_REPLEN
expr_stmt|;
name|vt_ctl
operator||=
operator|(
name|adapter
operator|->
name|pool
operator|<<
name|IXGBE_VT_CTL_POOL_SHIFT
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VT_CTL
argument_list|,
name|vt_ctl
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|adapter
operator|->
name|num_vfs
condition|;
name|i
operator|++
control|)
name|ixgbe_init_vf
argument_list|(
name|adapter
argument_list|,
operator|&
name|adapter
operator|->
name|vfs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_initialize_iov */
end_comment

begin_comment
comment|/* Check the max frame setting of all active VF's */
end_comment

begin_function
name|void
name|ixgbe_recalculate_max_frame
parameter_list|(
name|struct
name|adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|struct
name|ixgbe_vf
modifier|*
name|vf
decl_stmt|;
name|IXGBE_CORE_LOCK_ASSERT
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|adapter
operator|->
name|num_vfs
condition|;
name|i
operator|++
control|)
block|{
name|vf
operator|=
operator|&
name|adapter
operator|->
name|vfs
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|vf
operator|->
name|flags
operator|&
name|IXGBE_VF_ACTIVE
condition|)
name|ixgbe_update_max_frame
argument_list|(
name|adapter
argument_list|,
name|vf
operator|->
name|max_frame_size
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ixgbe_recalculate_max_frame */
end_comment

begin_function
name|int
name|ixgbe_add_vf
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u16
name|vfnum
parameter_list|,
specifier|const
name|nvlist_t
modifier|*
name|config
parameter_list|)
block|{
name|struct
name|adapter
modifier|*
name|adapter
decl_stmt|;
name|struct
name|ixgbe_vf
modifier|*
name|vf
decl_stmt|;
specifier|const
name|void
modifier|*
name|mac
decl_stmt|;
name|adapter
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|vfnum
operator|<
name|adapter
operator|->
name|num_vfs
argument_list|,
operator|(
literal|"VF index %d is out of range %d"
operator|,
name|vfnum
operator|,
name|adapter
operator|->
name|num_vfs
operator|)
argument_list|)
expr_stmt|;
name|IXGBE_CORE_LOCK
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
name|vf
operator|=
operator|&
name|adapter
operator|->
name|vfs
index|[
name|vfnum
index|]
expr_stmt|;
name|vf
operator|->
name|pool
operator|=
name|vfnum
expr_stmt|;
comment|/* RAR[0] is used by the PF so use vfnum + 1 for VF RAR. */
name|vf
operator|->
name|rar_index
operator|=
name|vfnum
operator|+
literal|1
expr_stmt|;
name|vf
operator|->
name|default_vlan
operator|=
literal|0
expr_stmt|;
name|vf
operator|->
name|max_frame_size
operator|=
name|ETHER_MAX_LEN
expr_stmt|;
name|ixgbe_update_max_frame
argument_list|(
name|adapter
argument_list|,
name|vf
operator|->
name|max_frame_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvlist_exists_binary
argument_list|(
name|config
argument_list|,
literal|"mac-addr"
argument_list|)
condition|)
block|{
name|mac
operator|=
name|nvlist_get_binary
argument_list|(
name|config
argument_list|,
literal|"mac-addr"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|mac
argument_list|,
name|vf
operator|->
name|ether_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvlist_get_bool
argument_list|(
name|config
argument_list|,
literal|"allow-set-mac"
argument_list|)
condition|)
name|vf
operator|->
name|flags
operator||=
name|IXGBE_VF_CAP_MAC
expr_stmt|;
block|}
else|else
comment|/* 		 * If the administrator has not specified a MAC address then 		 * we must allow the VF to choose one. 		 */
name|vf
operator|->
name|flags
operator||=
name|IXGBE_VF_CAP_MAC
expr_stmt|;
name|vf
operator|->
name|flags
operator||=
name|IXGBE_VF_ACTIVE
expr_stmt|;
name|ixgbe_init_vf
argument_list|(
name|adapter
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|IXGBE_CORE_UNLOCK
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ixgbe_add_vf */
end_comment

begin_else
else|#
directive|else
end_else

begin_function
name|void
name|ixgbe_handle_mbx
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|UNREFERENCED_2PARAMETER
argument_list|(
name|context
argument_list|,
name|pending
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ixgbe_handle_mbx */
end_comment

begin_function
specifier|inline
name|int
name|ixgbe_vf_que_index
parameter_list|(
name|int
name|mode
parameter_list|,
name|int
name|vfnum
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|UNREFERENCED_2PARAMETER
argument_list|(
name|mode
argument_list|,
name|vfnum
argument_list|)
expr_stmt|;
return|return
name|num
return|;
block|}
end_function

begin_comment
comment|/* ixgbe_vf_que_index */
end_comment

begin_endif
endif|#
directive|endif
end_endif

end_unit


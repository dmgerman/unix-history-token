begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2001-2017, Intel Corporation   All rights reserved.    Redistribution and use in source and binary forms, with or without   modification, are permitted provided that the following conditions are met:     1. Redistributions of source code must retain the above copyright notice,       this list of conditions and the following disclaimer.     2. Redistributions in binary form must reproduce the above copyright       notice, this list of conditions and the following disclaimer in the       documentation and/or other materials provided with the distribution.     3. Neither the name of the Intel Corporation nor the names of its       contributors may be used to endorse or promote products derived from       this software without specific prior written permission.    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE   LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR   CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF   SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS   INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN   CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)   ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"ixgbe_type.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_mbx.h"
end_include

begin_comment
comment|/**  *  ixgbe_poll_for_msg - Wait for message notification  *  @hw: pointer to the HW structure  *  @mbx_id: id of mailbox to write  *  *  returns SUCCESS if it successfully received a message notification  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_poll_for_msg
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
name|mbx_id
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|int
name|countdown
init|=
name|mbx
operator|->
name|timeout
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_poll_for_msg"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|countdown
operator|||
operator|!
name|mbx
operator|->
name|ops
operator|.
name|check_for_msg
condition|)
goto|goto
name|out
goto|;
while|while
condition|(
name|countdown
operator|&&
name|mbx
operator|->
name|ops
operator|.
name|check_for_msg
argument_list|(
name|hw
argument_list|,
name|mbx_id
argument_list|)
condition|)
block|{
name|countdown
operator|--
expr_stmt|;
if|if
condition|(
operator|!
name|countdown
condition|)
break|break;
name|usec_delay
argument_list|(
name|mbx
operator|->
name|usec_delay
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|countdown
operator|==
literal|0
condition|)
name|ERROR_REPORT2
argument_list|(
name|IXGBE_ERROR_POLLING
argument_list|,
literal|"Polling for VF%d mailbox message timedout"
argument_list|,
name|mbx_id
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|countdown
condition|?
name|IXGBE_SUCCESS
else|:
name|IXGBE_ERR_MBX
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_poll_for_ack - Wait for message acknowledgement  *  @hw: pointer to the HW structure  *  @mbx_id: id of mailbox to write  *  *  returns SUCCESS if it successfully received a message acknowledgement  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_poll_for_ack
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
name|mbx_id
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|int
name|countdown
init|=
name|mbx
operator|->
name|timeout
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_poll_for_ack"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|countdown
operator|||
operator|!
name|mbx
operator|->
name|ops
operator|.
name|check_for_ack
condition|)
goto|goto
name|out
goto|;
while|while
condition|(
name|countdown
operator|&&
name|mbx
operator|->
name|ops
operator|.
name|check_for_ack
argument_list|(
name|hw
argument_list|,
name|mbx_id
argument_list|)
condition|)
block|{
name|countdown
operator|--
expr_stmt|;
if|if
condition|(
operator|!
name|countdown
condition|)
break|break;
name|usec_delay
argument_list|(
name|mbx
operator|->
name|usec_delay
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|countdown
operator|==
literal|0
condition|)
name|ERROR_REPORT2
argument_list|(
name|IXGBE_ERROR_POLLING
argument_list|,
literal|"Polling for VF%d mailbox ack timedout"
argument_list|,
name|mbx_id
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|countdown
condition|?
name|IXGBE_SUCCESS
else|:
name|IXGBE_ERR_MBX
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_read_posted_mbx - Wait for message notification and receive message  *  @hw: pointer to the HW structure  *  @msg: The message buffer  *  @size: Length of buffer  *  @mbx_id: id of mailbox to write  *  *  returns SUCCESS if it successfully received a message notification and  *  copied it into the receive buffer.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_read_posted_mbx
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
modifier|*
name|msg
parameter_list|,
name|u16
name|size
parameter_list|,
name|u16
name|mbx_id
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_read_posted_mbx"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mbx
operator|->
name|ops
operator|.
name|read
condition|)
goto|goto
name|out
goto|;
name|ret_val
operator|=
name|ixgbe_poll_for_msg
argument_list|(
name|hw
argument_list|,
name|mbx_id
argument_list|)
expr_stmt|;
comment|/* if ack received read message, otherwise we timed out */
if|if
condition|(
operator|!
name|ret_val
condition|)
name|ret_val
operator|=
name|mbx
operator|->
name|ops
operator|.
name|read
argument_list|(
name|hw
argument_list|,
name|msg
argument_list|,
name|size
argument_list|,
name|mbx_id
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_write_posted_mbx - Write a message to the mailbox, wait for ack  *  @hw: pointer to the HW structure  *  @msg: The message buffer  *  @size: Length of buffer  *  @mbx_id: id of mailbox to write  *  *  returns SUCCESS if it successfully copied message into the buffer and  *  received an ack to that message within delay * timeout period  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_write_posted_mbx
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
modifier|*
name|msg
parameter_list|,
name|u16
name|size
parameter_list|,
name|u16
name|mbx_id
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_write_posted_mbx"
argument_list|)
expr_stmt|;
comment|/* exit if either we can't write or there isn't a defined timeout */
if|if
condition|(
operator|!
name|mbx
operator|->
name|ops
operator|.
name|write
operator|||
operator|!
name|mbx
operator|->
name|timeout
condition|)
goto|goto
name|out
goto|;
comment|/* send msg */
name|ret_val
operator|=
name|mbx
operator|->
name|ops
operator|.
name|write
argument_list|(
name|hw
argument_list|,
name|msg
argument_list|,
name|size
argument_list|,
name|mbx_id
argument_list|)
expr_stmt|;
comment|/* if msg sent wait until we receive an ack */
if|if
condition|(
operator|!
name|ret_val
condition|)
name|ret_val
operator|=
name|ixgbe_poll_for_ack
argument_list|(
name|hw
argument_list|,
name|mbx_id
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_init_mbx_ops_generic - Initialize MB function pointers  *  @hw: pointer to the HW structure  *  *  Setups up the mailbox read and write message function pointers  **/
end_comment

begin_function
name|void
name|ixgbe_init_mbx_ops_generic
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|read_posted
operator|=
name|ixgbe_read_posted_mbx
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|write_posted
operator|=
name|ixgbe_write_posted_mbx
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_read_v2p_mailbox - read v2p mailbox  *  @hw: pointer to the HW structure  *  *  This function is used to read the v2p mailbox without losing the read to  *  clear status bits.  **/
end_comment

begin_function
specifier|static
name|u32
name|ixgbe_read_v2p_mailbox
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|u32
name|v2p_mailbox
init|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFMAILBOX
argument_list|)
decl_stmt|;
name|v2p_mailbox
operator||=
name|hw
operator|->
name|mbx
operator|.
name|v2p_mailbox
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|v2p_mailbox
operator||=
name|v2p_mailbox
operator|&
name|IXGBE_VFMAILBOX_R2C_BITS
expr_stmt|;
return|return
name|v2p_mailbox
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_for_bit_vf - Determine if a status bit was set  *  @hw: pointer to the HW structure  *  @mask: bitmask for bits to be tested and cleared  *  *  This function is used to check for the read to clear bits within  *  the V2P mailbox.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_check_for_bit_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|mask
parameter_list|)
block|{
name|u32
name|v2p_mailbox
init|=
name|ixgbe_read_v2p_mailbox
argument_list|(
name|hw
argument_list|)
decl_stmt|;
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
if|if
condition|(
name|v2p_mailbox
operator|&
name|mask
condition|)
name|ret_val
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|v2p_mailbox
operator|&=
operator|~
name|mask
expr_stmt|;
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_for_msg_vf - checks to see if the PF has sent mail  *  @hw: pointer to the HW structure  *  @mbx_id: id of mailbox to check  *  *  returns SUCCESS if the PF has set the Status bit or else ERR_MBX  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_check_for_msg_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
name|mbx_id
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
name|UNREFERENCED_1PARAMETER
argument_list|(
name|mbx_id
argument_list|)
expr_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_check_for_msg_vf"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ixgbe_check_for_bit_vf
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFMAILBOX_PFSTS
argument_list|)
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|stats
operator|.
name|reqs
operator|++
expr_stmt|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_for_ack_vf - checks to see if the PF has ACK'd  *  @hw: pointer to the HW structure  *  @mbx_id: id of mailbox to check  *  *  returns SUCCESS if the PF has set the ACK bit or else ERR_MBX  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_check_for_ack_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
name|mbx_id
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
name|UNREFERENCED_1PARAMETER
argument_list|(
name|mbx_id
argument_list|)
expr_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_check_for_ack_vf"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ixgbe_check_for_bit_vf
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFMAILBOX_PFACK
argument_list|)
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|stats
operator|.
name|acks
operator|++
expr_stmt|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_for_rst_vf - checks to see if the PF has reset  *  @hw: pointer to the HW structure  *  @mbx_id: id of mailbox to check  *  *  returns TRUE if the PF has set the reset done bit or else FALSE  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_check_for_rst_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
name|mbx_id
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
name|UNREFERENCED_1PARAMETER
argument_list|(
name|mbx_id
argument_list|)
expr_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_check_for_rst_vf"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ixgbe_check_for_bit_vf
argument_list|(
name|hw
argument_list|,
operator|(
name|IXGBE_VFMAILBOX_RSTD
operator||
name|IXGBE_VFMAILBOX_RSTI
operator|)
argument_list|)
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|stats
operator|.
name|rsts
operator|++
expr_stmt|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_obtain_mbx_lock_vf - obtain mailbox lock  *  @hw: pointer to the HW structure  *  *  return SUCCESS if we obtained the mailbox lock  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_obtain_mbx_lock_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_obtain_mbx_lock_vf"
argument_list|)
expr_stmt|;
comment|/* Take ownership of the buffer */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFMAILBOX
argument_list|,
name|IXGBE_VFMAILBOX_VFU
argument_list|)
expr_stmt|;
comment|/* reserve mailbox for vf use */
if|if
condition|(
name|ixgbe_read_v2p_mailbox
argument_list|(
name|hw
argument_list|)
operator|&
name|IXGBE_VFMAILBOX_VFU
condition|)
name|ret_val
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_write_mbx_vf - Write a message to the mailbox  *  @hw: pointer to the HW structure  *  @msg: The message buffer  *  @size: Length of buffer  *  @mbx_id: id of mailbox to write  *  *  returns SUCCESS if it successfully copied message into the buffer  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_write_mbx_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
modifier|*
name|msg
parameter_list|,
name|u16
name|size
parameter_list|,
name|u16
name|mbx_id
parameter_list|)
block|{
name|s32
name|ret_val
decl_stmt|;
name|u16
name|i
decl_stmt|;
name|UNREFERENCED_1PARAMETER
argument_list|(
name|mbx_id
argument_list|)
expr_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_write_mbx_vf"
argument_list|)
expr_stmt|;
comment|/* lock the mailbox to prevent pf/vf race condition */
name|ret_val
operator|=
name|ixgbe_obtain_mbx_lock_vf
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
condition|)
goto|goto
name|out_no_write
goto|;
comment|/* flush msg and acks as we are overwriting the message buffer */
name|ixgbe_check_for_msg_vf
argument_list|(
name|hw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ixgbe_check_for_ack_vf
argument_list|(
name|hw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* copy the caller specified message to the mailbox memory buffer */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
name|IXGBE_WRITE_REG_ARRAY
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFMBMEM
argument_list|,
name|i
argument_list|,
name|msg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* update stats */
name|hw
operator|->
name|mbx
operator|.
name|stats
operator|.
name|msgs_tx
operator|++
expr_stmt|;
comment|/* Drop VFU and interrupt the PF to tell it a message has been sent */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFMAILBOX
argument_list|,
name|IXGBE_VFMAILBOX_REQ
argument_list|)
expr_stmt|;
name|out_no_write
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_read_mbx_vf - Reads a message from the inbox intended for vf  *  @hw: pointer to the HW structure  *  @msg: The message buffer  *  @size: Length of buffer  *  @mbx_id: id of mailbox to read  *  *  returns SUCCESS if it successfully read message from buffer  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_read_mbx_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
modifier|*
name|msg
parameter_list|,
name|u16
name|size
parameter_list|,
name|u16
name|mbx_id
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u16
name|i
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_read_mbx_vf"
argument_list|)
expr_stmt|;
name|UNREFERENCED_1PARAMETER
argument_list|(
name|mbx_id
argument_list|)
expr_stmt|;
comment|/* lock the mailbox to prevent pf/vf race condition */
name|ret_val
operator|=
name|ixgbe_obtain_mbx_lock_vf
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
condition|)
goto|goto
name|out_no_read
goto|;
comment|/* copy the message from the mailbox memory buffer */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
name|msg
index|[
name|i
index|]
operator|=
name|IXGBE_READ_REG_ARRAY
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFMBMEM
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* Acknowledge receipt and release mailbox, then we're done */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFMAILBOX
argument_list|,
name|IXGBE_VFMAILBOX_ACK
argument_list|)
expr_stmt|;
comment|/* update stats */
name|hw
operator|->
name|mbx
operator|.
name|stats
operator|.
name|msgs_rx
operator|++
expr_stmt|;
name|out_no_read
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_init_mbx_params_vf - set initial values for vf mailbox  *  @hw: pointer to the HW structure  *  *  Initializes the hw->mbx struct to correct values for vf mailbox  */
end_comment

begin_function
name|void
name|ixgbe_init_mbx_params_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
comment|/* start mailbox as timed out and let the reset_hw call set the timeout 	 * value to begin communications */
name|mbx
operator|->
name|timeout
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|usec_delay
operator|=
name|IXGBE_VF_MBX_INIT_DELAY
expr_stmt|;
name|mbx
operator|->
name|size
operator|=
name|IXGBE_VFMAILBOX_SIZE
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|read
operator|=
name|ixgbe_read_mbx_vf
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|write
operator|=
name|ixgbe_write_mbx_vf
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|read_posted
operator|=
name|ixgbe_read_posted_mbx
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|write_posted
operator|=
name|ixgbe_write_posted_mbx
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|check_for_msg
operator|=
name|ixgbe_check_for_msg_vf
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|check_for_ack
operator|=
name|ixgbe_check_for_ack_vf
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|check_for_rst
operator|=
name|ixgbe_check_for_rst_vf
expr_stmt|;
name|mbx
operator|->
name|stats
operator|.
name|msgs_tx
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|stats
operator|.
name|msgs_rx
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|stats
operator|.
name|reqs
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|stats
operator|.
name|acks
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|stats
operator|.
name|rsts
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|s32
name|ixgbe_check_for_bit_pf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|mask
parameter_list|,
name|s32
name|index
parameter_list|)
block|{
name|u32
name|mbvficr
init|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MBVFICR
argument_list|(
name|index
argument_list|)
argument_list|)
decl_stmt|;
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
if|if
condition|(
name|mbvficr
operator|&
name|mask
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MBVFICR
argument_list|(
name|index
argument_list|)
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_for_msg_pf - checks to see if the VF has sent mail  *  @hw: pointer to the HW structure  *  @vf_number: the VF index  *  *  returns SUCCESS if the VF has set the Status bit or else ERR_MBX  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_check_for_msg_pf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
name|vf_number
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
name|s32
name|index
init|=
name|IXGBE_MBVFICR_INDEX
argument_list|(
name|vf_number
argument_list|)
decl_stmt|;
name|u32
name|vf_bit
init|=
name|vf_number
operator|%
literal|16
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_check_for_msg_pf"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ixgbe_check_for_bit_pf
argument_list|(
name|hw
argument_list|,
name|IXGBE_MBVFICR_VFREQ_VF1
operator|<<
name|vf_bit
argument_list|,
name|index
argument_list|)
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|stats
operator|.
name|reqs
operator|++
expr_stmt|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_for_ack_pf - checks to see if the VF has ACKed  *  @hw: pointer to the HW structure  *  @vf_number: the VF index  *  *  returns SUCCESS if the VF has set the Status bit or else ERR_MBX  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_check_for_ack_pf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
name|vf_number
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
name|s32
name|index
init|=
name|IXGBE_MBVFICR_INDEX
argument_list|(
name|vf_number
argument_list|)
decl_stmt|;
name|u32
name|vf_bit
init|=
name|vf_number
operator|%
literal|16
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_check_for_ack_pf"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ixgbe_check_for_bit_pf
argument_list|(
name|hw
argument_list|,
name|IXGBE_MBVFICR_VFACK_VF1
operator|<<
name|vf_bit
argument_list|,
name|index
argument_list|)
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|stats
operator|.
name|acks
operator|++
expr_stmt|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_for_rst_pf - checks to see if the VF has reset  *  @hw: pointer to the HW structure  *  @vf_number: the VF index  *  *  returns SUCCESS if the VF has set the Status bit or else ERR_MBX  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_check_for_rst_pf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
name|vf_number
parameter_list|)
block|{
name|u32
name|reg_offset
init|=
operator|(
name|vf_number
operator|<
literal|32
operator|)
condition|?
literal|0
else|:
literal|1
decl_stmt|;
name|u32
name|vf_shift
init|=
name|vf_number
operator|%
literal|32
decl_stmt|;
name|u32
name|vflre
init|=
literal|0
decl_stmt|;
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_check_for_rst_pf"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82599EB
case|:
name|vflre
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFLRE
argument_list|(
name|reg_offset
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
case|case
name|ixgbe_mac_X540
case|:
name|vflre
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFLREC
argument_list|(
name|reg_offset
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|vflre
operator|&
operator|(
literal|1
operator|<<
name|vf_shift
operator|)
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFLREC
argument_list|(
name|reg_offset
argument_list|)
argument_list|,
operator|(
literal|1
operator|<<
name|vf_shift
operator|)
argument_list|)
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|stats
operator|.
name|rsts
operator|++
expr_stmt|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_obtain_mbx_lock_pf - obtain mailbox lock  *  @hw: pointer to the HW structure  *  @vf_number: the VF index  *  *  return SUCCESS if we obtained the mailbox lock  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_obtain_mbx_lock_pf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
name|vf_number
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|IXGBE_ERR_MBX
decl_stmt|;
name|u32
name|p2v_mailbox
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_obtain_mbx_lock_pf"
argument_list|)
expr_stmt|;
comment|/* Take ownership of the buffer */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_PFMAILBOX
argument_list|(
name|vf_number
argument_list|)
argument_list|,
name|IXGBE_PFMAILBOX_PFU
argument_list|)
expr_stmt|;
comment|/* reserve mailbox for vf use */
name|p2v_mailbox
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_PFMAILBOX
argument_list|(
name|vf_number
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2v_mailbox
operator|&
name|IXGBE_PFMAILBOX_PFU
condition|)
name|ret_val
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
else|else
name|ERROR_REPORT2
argument_list|(
name|IXGBE_ERROR_POLLING
argument_list|,
literal|"Failed to obtain mailbox lock for VF%d"
argument_list|,
name|vf_number
argument_list|)
expr_stmt|;
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_write_mbx_pf - Places a message in the mailbox  *  @hw: pointer to the HW structure  *  @msg: The message buffer  *  @size: Length of buffer  *  @vf_number: the VF index  *  *  returns SUCCESS if it successfully copied message into the buffer  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_write_mbx_pf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
modifier|*
name|msg
parameter_list|,
name|u16
name|size
parameter_list|,
name|u16
name|vf_number
parameter_list|)
block|{
name|s32
name|ret_val
decl_stmt|;
name|u16
name|i
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_write_mbx_pf"
argument_list|)
expr_stmt|;
comment|/* lock the mailbox to prevent pf/vf race condition */
name|ret_val
operator|=
name|ixgbe_obtain_mbx_lock_pf
argument_list|(
name|hw
argument_list|,
name|vf_number
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
condition|)
goto|goto
name|out_no_write
goto|;
comment|/* flush msg and acks as we are overwriting the message buffer */
name|ixgbe_check_for_msg_pf
argument_list|(
name|hw
argument_list|,
name|vf_number
argument_list|)
expr_stmt|;
name|ixgbe_check_for_ack_pf
argument_list|(
name|hw
argument_list|,
name|vf_number
argument_list|)
expr_stmt|;
comment|/* copy the caller specified message to the mailbox memory buffer */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
name|IXGBE_WRITE_REG_ARRAY
argument_list|(
name|hw
argument_list|,
name|IXGBE_PFMBMEM
argument_list|(
name|vf_number
argument_list|)
argument_list|,
name|i
argument_list|,
name|msg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Interrupt VF to tell it a message has been sent and release buffer*/
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_PFMAILBOX
argument_list|(
name|vf_number
argument_list|)
argument_list|,
name|IXGBE_PFMAILBOX_STS
argument_list|)
expr_stmt|;
comment|/* update stats */
name|hw
operator|->
name|mbx
operator|.
name|stats
operator|.
name|msgs_tx
operator|++
expr_stmt|;
name|out_no_write
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_read_mbx_pf - Read a message from the mailbox  *  @hw: pointer to the HW structure  *  @msg: The message buffer  *  @size: Length of buffer  *  @vf_number: the VF index  *  *  This function copies a message from the mailbox buffer to the caller's  *  memory buffer.  The presumption is that the caller knows that there was  *  a message due to a VF request so no polling for message is needed.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_read_mbx_pf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
modifier|*
name|msg
parameter_list|,
name|u16
name|size
parameter_list|,
name|u16
name|vf_number
parameter_list|)
block|{
name|s32
name|ret_val
decl_stmt|;
name|u16
name|i
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_read_mbx_pf"
argument_list|)
expr_stmt|;
comment|/* lock the mailbox to prevent pf/vf race condition */
name|ret_val
operator|=
name|ixgbe_obtain_mbx_lock_pf
argument_list|(
name|hw
argument_list|,
name|vf_number
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
condition|)
goto|goto
name|out_no_read
goto|;
comment|/* copy the message to the mailbox memory buffer */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
name|msg
index|[
name|i
index|]
operator|=
name|IXGBE_READ_REG_ARRAY
argument_list|(
name|hw
argument_list|,
name|IXGBE_PFMBMEM
argument_list|(
name|vf_number
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* Acknowledge the message and release buffer */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_PFMAILBOX
argument_list|(
name|vf_number
argument_list|)
argument_list|,
name|IXGBE_PFMAILBOX_ACK
argument_list|)
expr_stmt|;
comment|/* update stats */
name|hw
operator|->
name|mbx
operator|.
name|stats
operator|.
name|msgs_rx
operator|++
expr_stmt|;
name|out_no_read
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_init_mbx_params_pf - set initial values for pf mailbox  *  @hw: pointer to the HW structure  *  *  Initializes the hw->mbx struct to correct values for pf mailbox  */
end_comment

begin_function
name|void
name|ixgbe_init_mbx_params_pf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
operator|!=
name|ixgbe_mac_82599EB
operator|&&
name|hw
operator|->
name|mac
operator|.
name|type
operator|!=
name|ixgbe_mac_X550
operator|&&
name|hw
operator|->
name|mac
operator|.
name|type
operator|!=
name|ixgbe_mac_X550EM_x
operator|&&
name|hw
operator|->
name|mac
operator|.
name|type
operator|!=
name|ixgbe_mac_X550EM_a
operator|&&
name|hw
operator|->
name|mac
operator|.
name|type
operator|!=
name|ixgbe_mac_X540
condition|)
return|return;
name|mbx
operator|->
name|timeout
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|usec_delay
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|size
operator|=
name|IXGBE_VFMAILBOX_SIZE
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|read
operator|=
name|ixgbe_read_mbx_pf
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|write
operator|=
name|ixgbe_write_mbx_pf
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|read_posted
operator|=
name|ixgbe_read_posted_mbx
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|write_posted
operator|=
name|ixgbe_write_posted_mbx
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|check_for_msg
operator|=
name|ixgbe_check_for_msg_pf
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|check_for_ack
operator|=
name|ixgbe_check_for_ack_pf
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|check_for_rst
operator|=
name|ixgbe_check_for_rst_pf
expr_stmt|;
name|mbx
operator|->
name|stats
operator|.
name|msgs_tx
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|stats
operator|.
name|msgs_rx
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|stats
operator|.
name|reqs
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|stats
operator|.
name|acks
operator|=
literal|0
expr_stmt|;
name|mbx
operator|->
name|stats
operator|.
name|rsts
operator|=
literal|0
expr_stmt|;
block|}
end_function

end_unit


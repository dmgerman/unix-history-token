begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*******************************************************************************    Copyright (c) 2001-2007, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  *******************************************************************************/
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|"ixgbe_api.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_common.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_phy.h"
end_include

begin_comment
comment|/**  *  ixgbe_init_shared_code_phy - Initialize PHY shared code  *  @hw: pointer to hardware structure  **/
end_comment

begin_function
name|s32
name|ixgbe_init_shared_code_phy
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
comment|/* Assign function pointers */
name|ixgbe_assign_func_pointers_phy
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_assign_func_pointers_phy -  Assigns PHY-specific function pointers  *  @hw: pointer to hardware structure  *  *  Note, generic function pointers have already been assigned, so the  *  function pointers set here are only for PHY-specific functions.  **/
end_comment

begin_function
name|s32
name|ixgbe_assign_func_pointers_phy
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_reset_phy
operator|=
operator|&
name|ixgbe_reset_phy_generic
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_read_phy_reg
operator|=
operator|&
name|ixgbe_read_phy_reg_generic
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_write_phy_reg
operator|=
operator|&
name|ixgbe_write_phy_reg_generic
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_identify_phy
operator|=
operator|&
name|ixgbe_identify_phy_generic
expr_stmt|;
if|if
condition|(
name|ixgbe_get_media_type
argument_list|(
name|hw
argument_list|)
operator|==
name|ixgbe_media_type_copper
condition|)
block|{
comment|/* Call PHY identify routine to get the phy type */
name|ixgbe_identify_phy
argument_list|(
name|hw
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|phy
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_phy_tn
case|:
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_setup_phy_link
operator|=
operator|&
name|ixgbe_setup_tnx_phy_link
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_check_phy_link
operator|=
operator|&
name|ixgbe_check_tnx_phy_link
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_setup_phy_link_speed
operator|=
operator|&
name|ixgbe_setup_tnx_phy_link_speed
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_identify_phy_generic - Get physical layer module  *  @hw: pointer to hardware structure  *  *  Determines the physical layer module found on the current adapter.  **/
end_comment

begin_function
name|s32
name|ixgbe_identify_phy_generic
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_ERR_PHY_ADDR_INVALID
decl_stmt|;
name|u32
name|phy_addr
decl_stmt|;
for|for
control|(
name|phy_addr
operator|=
literal|0
init|;
name|phy_addr
operator|<
name|IXGBE_MAX_PHY_ADDR
condition|;
name|phy_addr
operator|++
control|)
block|{
if|if
condition|(
name|ixgbe_validate_phy_addr
argument_list|(
name|hw
argument_list|,
name|phy_addr
argument_list|)
condition|)
block|{
name|hw
operator|->
name|phy
operator|.
name|addr
operator|=
name|phy_addr
expr_stmt|;
name|ixgbe_get_phy_id
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|hw
operator|->
name|phy
operator|.
name|type
operator|=
name|ixgbe_get_phy_type_from_id
argument_list|(
name|hw
operator|->
name|phy
operator|.
name|id
argument_list|)
expr_stmt|;
name|status
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
break|break;
block|}
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_validate_phy_addr - Determines phy address is valid  *  @hw: pointer to hardware structure  *  **/
end_comment

begin_function
name|bool
name|ixgbe_validate_phy_addr
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|phy_addr
parameter_list|)
block|{
name|u16
name|phy_id
init|=
literal|0
decl_stmt|;
name|bool
name|valid
init|=
name|FALSE
decl_stmt|;
name|hw
operator|->
name|phy
operator|.
name|addr
operator|=
name|phy_addr
expr_stmt|;
name|ixgbe_read_phy_reg_generic
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_PHY_ID_HIGH
argument_list|,
name|IXGBE_MDIO_PMA_PMD_DEV_TYPE
argument_list|,
operator|&
name|phy_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy_id
operator|!=
literal|0xFFFF
operator|&&
name|phy_id
operator|!=
literal|0x0
condition|)
name|valid
operator|=
name|TRUE
expr_stmt|;
return|return
name|valid
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_phy_id - Get the phy type  *  @hw: pointer to hardware structure  *  **/
end_comment

begin_function
name|s32
name|ixgbe_get_phy_id
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|u32
name|status
decl_stmt|;
name|u16
name|phy_id_high
init|=
literal|0
decl_stmt|;
name|u16
name|phy_id_low
init|=
literal|0
decl_stmt|;
name|status
operator|=
name|ixgbe_read_phy_reg_generic
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_PHY_ID_HIGH
argument_list|,
name|IXGBE_MDIO_PMA_PMD_DEV_TYPE
argument_list|,
operator|&
name|phy_id_high
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
block|{
name|hw
operator|->
name|phy
operator|.
name|id
operator|=
call|(
name|u32
call|)
argument_list|(
name|phy_id_high
operator|<<
literal|16
argument_list|)
expr_stmt|;
name|status
operator|=
name|ixgbe_read_phy_reg_generic
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_PHY_ID_LOW
argument_list|,
name|IXGBE_MDIO_PMA_PMD_DEV_TYPE
argument_list|,
operator|&
name|phy_id_low
argument_list|)
expr_stmt|;
name|hw
operator|->
name|phy
operator|.
name|id
operator||=
call|(
name|u32
call|)
argument_list|(
name|phy_id_low
operator|&
name|IXGBE_PHY_REVISION_MASK
argument_list|)
expr_stmt|;
name|hw
operator|->
name|phy
operator|.
name|revision
operator|=
call|(
name|u32
call|)
argument_list|(
name|phy_id_low
operator|&
operator|~
name|IXGBE_PHY_REVISION_MASK
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_phy_type_from_id - Get the phy type  *  @hw: pointer to hardware structure  *  **/
end_comment

begin_function
name|enum
name|ixgbe_phy_type
name|ixgbe_get_phy_type_from_id
parameter_list|(
name|u32
name|phy_id
parameter_list|)
block|{
name|enum
name|ixgbe_phy_type
name|phy_type
decl_stmt|;
switch|switch
condition|(
name|phy_id
condition|)
block|{
case|case
name|TN1010_PHY_ID
case|:
name|phy_type
operator|=
name|ixgbe_phy_tn
expr_stmt|;
break|break;
case|case
name|QT2022_PHY_ID
case|:
name|phy_type
operator|=
name|ixgbe_phy_qt
expr_stmt|;
break|break;
default|default:
name|phy_type
operator|=
name|ixgbe_phy_unknown
expr_stmt|;
break|break;
block|}
return|return
name|phy_type
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_reset_phy_generic - Performs a PHY reset  *  @hw: pointer to hardware structure  **/
end_comment

begin_function
name|s32
name|ixgbe_reset_phy_generic
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
comment|/* 	 * Perform soft PHY reset to the PHY_XS. 	 * This will cause a soft reset to the PHY 	 */
return|return
name|ixgbe_write_phy_reg
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_PHY_XS_CONTROL
argument_list|,
name|IXGBE_MDIO_PHY_XS_DEV_TYPE
argument_list|,
name|IXGBE_MDIO_PHY_XS_RESET
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_read_phy_reg_generic - Reads a value from a specified PHY register  *  @hw: pointer to hardware structure  *  @reg_addr: 32 bit address of PHY register to read  *  @phy_data: Pointer to read data from PHY register  **/
end_comment

begin_function
name|s32
name|ixgbe_read_phy_reg_generic
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|reg_addr
parameter_list|,
name|u32
name|device_type
parameter_list|,
name|u16
modifier|*
name|phy_data
parameter_list|)
block|{
name|u32
name|command
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|u32
name|data
decl_stmt|;
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u16
name|gssr
decl_stmt|;
if|if
condition|(
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_STATUS
argument_list|)
operator|&
name|IXGBE_STATUS_LAN_ID_1
condition|)
name|gssr
operator|=
name|IXGBE_GSSR_PHY1_SM
expr_stmt|;
else|else
name|gssr
operator|=
name|IXGBE_GSSR_PHY0_SM
expr_stmt|;
if|if
condition|(
name|ixgbe_acquire_swfw_sync
argument_list|(
name|hw
argument_list|,
name|gssr
argument_list|)
operator|!=
name|IXGBE_SUCCESS
condition|)
name|status
operator|=
name|IXGBE_ERR_SWFW_SYNC
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
block|{
comment|/* Setup and write the address cycle command */
name|command
operator|=
operator|(
operator|(
name|reg_addr
operator|<<
name|IXGBE_MSCA_NP_ADDR_SHIFT
operator|)
operator||
operator|(
name|device_type
operator|<<
name|IXGBE_MSCA_DEV_TYPE_SHIFT
operator|)
operator||
operator|(
name|hw
operator|->
name|phy
operator|.
name|addr
operator|<<
name|IXGBE_MSCA_PHY_ADDR_SHIFT
operator|)
operator||
operator|(
name|IXGBE_MSCA_ADDR_CYCLE
operator||
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MSCA
argument_list|,
name|command
argument_list|)
expr_stmt|;
comment|/* 		 * Check every 10 usec to see if the address cycle completed. 		 * The MDI Command bit will clear when the operation is 		 * complete 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_MDIO_COMMAND_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|command
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MSCA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|command
operator|&
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|command
operator|&
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|!=
literal|0
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"PHY address command did not complete.\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IXGBE_ERR_PHY
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
block|{
comment|/* 			 * Address cycle complete, setup and write the read 			 * command 			 */
name|command
operator|=
operator|(
operator|(
name|reg_addr
operator|<<
name|IXGBE_MSCA_NP_ADDR_SHIFT
operator|)
operator||
operator|(
name|device_type
operator|<<
name|IXGBE_MSCA_DEV_TYPE_SHIFT
operator|)
operator||
operator|(
name|hw
operator|->
name|phy
operator|.
name|addr
operator|<<
name|IXGBE_MSCA_PHY_ADDR_SHIFT
operator|)
operator||
operator|(
name|IXGBE_MSCA_READ
operator||
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MSCA
argument_list|,
name|command
argument_list|)
expr_stmt|;
comment|/* 			 * Check every 10 usec to see if the address cycle 			 * completed. The MDI Command bit will clear when the 			 * operation is complete 			 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_MDIO_COMMAND_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|command
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MSCA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|command
operator|&
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
operator|(
name|command
operator|&
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|!=
literal|0
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"PHY read command didn't complete\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IXGBE_ERR_PHY
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * Read operation is complete.  Get the data 				 * from MSRWD 				 */
name|data
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MSRWD
argument_list|)
expr_stmt|;
name|data
operator|>>=
name|IXGBE_MSRWD_READ_DATA_SHIFT
expr_stmt|;
operator|*
name|phy_data
operator|=
call|(
name|u16
call|)
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
block|}
name|ixgbe_release_swfw_sync
argument_list|(
name|hw
argument_list|,
name|gssr
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_write_phy_reg_generic - Writes a value to specified PHY register  *  @hw: pointer to hardware structure  *  @reg_addr: 32 bit PHY register to write  *  @device_type: 5 bit device type  *  @phy_data: Data to write to the PHY register  **/
end_comment

begin_function
name|s32
name|ixgbe_write_phy_reg_generic
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|reg_addr
parameter_list|,
name|u32
name|device_type
parameter_list|,
name|u16
name|phy_data
parameter_list|)
block|{
name|u32
name|command
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u16
name|gssr
decl_stmt|;
if|if
condition|(
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_STATUS
argument_list|)
operator|&
name|IXGBE_STATUS_LAN_ID_1
condition|)
name|gssr
operator|=
name|IXGBE_GSSR_PHY1_SM
expr_stmt|;
else|else
name|gssr
operator|=
name|IXGBE_GSSR_PHY0_SM
expr_stmt|;
if|if
condition|(
name|ixgbe_acquire_swfw_sync
argument_list|(
name|hw
argument_list|,
name|gssr
argument_list|)
operator|!=
name|IXGBE_SUCCESS
condition|)
name|status
operator|=
name|IXGBE_ERR_SWFW_SYNC
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
block|{
comment|/* Put the data in the MDI single read and write data register*/
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MSRWD
argument_list|,
operator|(
name|u32
operator|)
name|phy_data
argument_list|)
expr_stmt|;
comment|/* Setup and write the address cycle command */
name|command
operator|=
operator|(
operator|(
name|reg_addr
operator|<<
name|IXGBE_MSCA_NP_ADDR_SHIFT
operator|)
operator||
operator|(
name|device_type
operator|<<
name|IXGBE_MSCA_DEV_TYPE_SHIFT
operator|)
operator||
operator|(
name|hw
operator|->
name|phy
operator|.
name|addr
operator|<<
name|IXGBE_MSCA_PHY_ADDR_SHIFT
operator|)
operator||
operator|(
name|IXGBE_MSCA_ADDR_CYCLE
operator||
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MSCA
argument_list|,
name|command
argument_list|)
expr_stmt|;
comment|/* 		 * Check every 10 usec to see if the address cycle completed. 		 * The MDI Command bit will clear when the operation is 		 * complete 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_MDIO_COMMAND_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|command
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MSCA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|command
operator|&
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|==
literal|0
condition|)
block|{
name|DEBUGFUNC
argument_list|(
literal|"PHY address cmd didn't complete\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|command
operator|&
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|!=
literal|0
condition|)
name|status
operator|=
name|IXGBE_ERR_PHY
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
block|{
comment|/* 			 * Address cycle complete, setup and write the write 			 * command 			 */
name|command
operator|=
operator|(
operator|(
name|reg_addr
operator|<<
name|IXGBE_MSCA_NP_ADDR_SHIFT
operator|)
operator||
operator|(
name|device_type
operator|<<
name|IXGBE_MSCA_DEV_TYPE_SHIFT
operator|)
operator||
operator|(
name|hw
operator|->
name|phy
operator|.
name|addr
operator|<<
name|IXGBE_MSCA_PHY_ADDR_SHIFT
operator|)
operator||
operator|(
name|IXGBE_MSCA_WRITE
operator||
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MSCA
argument_list|,
name|command
argument_list|)
expr_stmt|;
comment|/* 			 * Check every 10 usec to see if the address cycle 			 * completed. The MDI Command bit will clear when the 			 * operation is complete 			 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_MDIO_COMMAND_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|command
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_MSCA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|command
operator|&
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|==
literal|0
condition|)
block|{
name|DEBUGFUNC
argument_list|(
literal|"PHY write command did not "
literal|"complete.\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|command
operator|&
name|IXGBE_MSCA_MDI_COMMAND
operator|)
operator|!=
literal|0
condition|)
name|status
operator|=
name|IXGBE_ERR_PHY
expr_stmt|;
block|}
name|ixgbe_release_swfw_sync
argument_list|(
name|hw
argument_list|,
name|gssr
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_phy_link - Restart PHY autoneg  *  @hw: pointer to hardware structure  *  *  Restart autonegotiation and PHY and waits for completion.  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_phy_link
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
return|return
name|ixgbe_call_func
argument_list|(
name|hw
argument_list|,
name|ixgbe_func_setup_phy_link
argument_list|,
operator|(
name|hw
operator|)
argument_list|,
name|IXGBE_NOT_IMPLEMENTED
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_phy_link - Determine link and speed status  *  @hw: pointer to hardware structure  *  *  Reads a PHY register to determine if link is up and the current speed for  *  the PHY.  **/
end_comment

begin_function
name|s32
name|ixgbe_check_phy_link
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|)
block|{
return|return
name|ixgbe_call_func
argument_list|(
name|hw
argument_list|,
name|ixgbe_func_check_phy_link
argument_list|,
operator|(
name|hw
operator|,
name|speed
operator|,
name|link_up
operator|)
argument_list|,
name|IXGBE_NOT_IMPLEMENTED
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_phy_link_speed - Set auto advertise  *  @hw: pointer to hardware structure  *  @speed: new link speed  *  @autoneg: TRUE if autonegotiation enabled  *  *  Sets the auto advertised capabilities  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_phy_link_speed
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
block|{
return|return
name|ixgbe_call_func
argument_list|(
name|hw
argument_list|,
name|ixgbe_func_setup_phy_link_speed
argument_list|,
operator|(
name|hw
operator|,
name|speed
operator|,
name|autoneg
operator|,
name|autoneg_wait_to_complete
operator|)
argument_list|,
name|IXGBE_NOT_IMPLEMENTED
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_tnx_phy_link - Set and restart autoneg  *  @hw: pointer to hardware structure  *  *  Restart autonegotiation and PHY and waits for completion.  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_tnx_phy_link
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_NOT_IMPLEMENTED
decl_stmt|;
name|u32
name|time_out
decl_stmt|;
name|u32
name|max_time_out
init|=
literal|10
decl_stmt|;
name|u16
name|autoneg_speed_selection_register
init|=
literal|0x10
decl_stmt|;
name|u16
name|autoneg_restart_mask
init|=
literal|0x0200
decl_stmt|;
name|u16
name|autoneg_complete_mask
init|=
literal|0x0020
decl_stmt|;
name|u16
name|autoneg_reg
init|=
literal|0
decl_stmt|;
comment|/* 	 * Set advertisement settings in PHY based on autoneg_advertised 	 * settings. If autoneg_advertised = 0, then advertise default values 	 * txn devices cannot be "forced" to a autoneg 10G and fail.  But can 	 * for a 1G. 	 */
name|ixgbe_read_phy_reg
argument_list|(
name|hw
argument_list|,
name|autoneg_speed_selection_register
argument_list|,
name|IXGBE_MDIO_AUTO_NEG_DEV_TYPE
argument_list|,
operator|&
name|autoneg_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|phy
operator|.
name|autoneg_advertised
operator|==
name|IXGBE_LINK_SPEED_1GB_FULL
condition|)
name|autoneg_reg
operator|&=
literal|0xEFFF
expr_stmt|;
comment|/* 0 in bit 12 is 1G operation */
else|else
name|autoneg_reg
operator||=
literal|0x1000
expr_stmt|;
comment|/* 1 in bit 12 is 10G/1G operation */
name|ixgbe_write_phy_reg
argument_list|(
name|hw
argument_list|,
name|autoneg_speed_selection_register
argument_list|,
name|IXGBE_MDIO_AUTO_NEG_DEV_TYPE
argument_list|,
name|autoneg_reg
argument_list|)
expr_stmt|;
comment|/* Restart PHY autonegotiation and wait for completion */
name|ixgbe_read_phy_reg
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_AUTO_NEG_CONTROL
argument_list|,
name|IXGBE_MDIO_AUTO_NEG_DEV_TYPE
argument_list|,
operator|&
name|autoneg_reg
argument_list|)
expr_stmt|;
name|autoneg_reg
operator||=
name|autoneg_restart_mask
expr_stmt|;
name|ixgbe_write_phy_reg
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_AUTO_NEG_CONTROL
argument_list|,
name|IXGBE_MDIO_AUTO_NEG_DEV_TYPE
argument_list|,
name|autoneg_reg
argument_list|)
expr_stmt|;
comment|/* Wait for autonegotiation to finish */
for|for
control|(
name|time_out
operator|=
literal|0
init|;
name|time_out
operator|<
name|max_time_out
condition|;
name|time_out
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/* Restart PHY autonegotiation and wait for completion */
name|status
operator|=
name|ixgbe_read_phy_reg
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_AUTO_NEG_STATUS
argument_list|,
name|IXGBE_MDIO_AUTO_NEG_DEV_TYPE
argument_list|,
operator|&
name|autoneg_reg
argument_list|)
expr_stmt|;
name|autoneg_reg
operator|&=
name|autoneg_complete_mask
expr_stmt|;
if|if
condition|(
name|autoneg_reg
operator|==
name|autoneg_complete_mask
condition|)
block|{
name|status
operator|=
name|IXGBE_SUCCESS
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|time_out
operator|==
name|max_time_out
condition|)
name|status
operator|=
name|IXGBE_ERR_LINK_SETUP
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_tnx_phy_link - Determine link and speed status  *  @hw: pointer to hardware structure  *  *  Reads the VS1 register to determine if link is up and the current speed for  *  the PHY.  **/
end_comment

begin_function
name|s32
name|ixgbe_check_tnx_phy_link
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u32
name|time_out
decl_stmt|;
name|u32
name|max_time_out
init|=
literal|10
decl_stmt|;
name|u16
name|phy_link
init|=
literal|0
decl_stmt|;
name|u16
name|phy_speed
init|=
literal|0
decl_stmt|;
name|u16
name|phy_data
init|=
literal|0
decl_stmt|;
comment|/* Initialize speed and link to default case */
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
comment|/* 	 * Check current speed and link status of the PHY register. 	 * This is a vendor specific register and may have to 	 * be changed for other copper PHYs. 	 */
for|for
control|(
name|time_out
operator|=
literal|0
init|;
name|time_out
operator|<
name|max_time_out
condition|;
name|time_out
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy_link
operator|==
name|IXGBE_MDIO_VENDOR_SPECIFIC_1_LINK_STATUS
condition|)
block|{
operator|*
name|link_up
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|phy_speed
operator|==
name|IXGBE_MDIO_VENDOR_SPECIFIC_1_SPEED_STATUS
condition|)
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
break|break;
block|}
else|else
block|{
name|status
operator|=
name|ixgbe_read_phy_reg
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_VENDOR_SPECIFIC_1_STATUS
argument_list|,
name|IXGBE_MDIO_VENDOR_SPECIFIC_1_DEV_TYPE
argument_list|,
operator|&
name|phy_data
argument_list|)
expr_stmt|;
name|phy_link
operator|=
name|phy_data
operator|&
name|IXGBE_MDIO_VENDOR_SPECIFIC_1_LINK_STATUS
expr_stmt|;
name|phy_speed
operator|=
name|phy_data
operator|&
name|IXGBE_MDIO_VENDOR_SPECIFIC_1_SPEED_STATUS
expr_stmt|;
block|}
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_tnx_phy_link_speed - Sets the auto advertised capabilities  *  @hw: pointer to hardware structure  *  @speed: new link speed  *  @autoneg: TRUE if autonegotiation enabled  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_tnx_phy_link_speed
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
block|{
name|UNREFERENCED_PARAMETER
argument_list|(
name|autoneg
argument_list|)
expr_stmt|;
name|UNREFERENCED_PARAMETER
argument_list|(
name|autoneg_wait_to_complete
argument_list|)
expr_stmt|;
comment|/* 	 * Clear autoneg_advertised and set new values based on input link 	 * speed. 	 */
name|hw
operator|->
name|phy
operator|.
name|autoneg_advertised
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|speed
operator|&
name|IXGBE_LINK_SPEED_10GB_FULL
condition|)
block|{
name|hw
operator|->
name|phy
operator|.
name|autoneg_advertised
operator||=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
block|}
if|if
condition|(
name|speed
operator|&
name|IXGBE_LINK_SPEED_1GB_FULL
condition|)
block|{
name|hw
operator|->
name|phy
operator|.
name|autoneg_advertised
operator||=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
block|}
comment|/* Setup link based on the new speed settings */
name|ixgbe_setup_tnx_phy_link
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

end_unit


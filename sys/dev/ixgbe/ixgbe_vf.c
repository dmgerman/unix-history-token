begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2001-2017, Intel Corporation   All rights reserved.    Redistribution and use in source and binary forms, with or without   modification, are permitted provided that the following conditions are met:     1. Redistributions of source code must retain the above copyright notice,       this list of conditions and the following disclaimer.     2. Redistributions in binary form must reproduce the above copyright       notice, this list of conditions and the following disclaimer in the       documentation and/or other materials provided with the distribution.     3. Neither the name of the Intel Corporation nor the names of its       contributors may be used to endorse or promote products derived from       this software without specific prior written permission.    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE   LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR   CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF   SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS   INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN   CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)   ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"ixgbe.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|IXGBE_VFWRITE_REG
end_ifndef

begin_define
define|#
directive|define
name|IXGBE_VFWRITE_REG
value|IXGBE_WRITE_REG
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|IXGBE_VFREAD_REG
end_ifndef

begin_define
define|#
directive|define
name|IXGBE_VFREAD_REG
value|IXGBE_READ_REG
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  *  ixgbe_init_ops_vf - Initialize the pointers for vf  *  @hw: pointer to hardware structure  *  *  This will assign function pointers, adapter-specific functions can  *  override the assignment of generic function pointers by assigning  *  their own adapter-specific function pointers.  *  Does not touch the hardware.  **/
end_comment

begin_function
name|s32
name|ixgbe_init_ops_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
comment|/* MAC */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|init_hw
operator|=
name|ixgbe_init_hw_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|reset_hw
operator|=
name|ixgbe_reset_hw_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|start_hw
operator|=
name|ixgbe_start_hw_vf
expr_stmt|;
comment|/* Cannot clear stats on VF */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|clear_hw_cntrs
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_media_type
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_mac_addr
operator|=
name|ixgbe_get_mac_addr_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|stop_adapter
operator|=
name|ixgbe_stop_adapter_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_bus_info
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|negotiate_api_version
operator|=
name|ixgbevf_negotiate_api_version
expr_stmt|;
comment|/* Link */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|setup_link
operator|=
name|ixgbe_setup_mac_link_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|check_link
operator|=
name|ixgbe_check_mac_link_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_link_capabilities
operator|=
name|NULL
expr_stmt|;
comment|/* RAR, Multicast, VLAN */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|set_rar
operator|=
name|ixgbe_set_rar_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|set_uc_addr
operator|=
name|ixgbevf_set_uc_addr_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|init_rx_addrs
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|update_mc_addr_list
operator|=
name|ixgbe_update_mc_addr_list_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|update_xcast_mode
operator|=
name|ixgbevf_update_xcast_mode
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|enable_mc
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|disable_mc
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|clear_vfta
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|set_vfta
operator|=
name|ixgbe_set_vfta_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|set_rlpml
operator|=
name|ixgbevf_rlpml_set_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|max_tx_queues
operator|=
literal|1
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|max_rx_queues
operator|=
literal|1
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|ops
operator|.
name|init_params
operator|=
name|ixgbe_init_mbx_params_vf
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* ixgbe_virt_clr_reg - Set register to default (power on) state.  *  @hw: pointer to hardware structure  */
end_comment

begin_function
specifier|static
name|void
name|ixgbe_virt_clr_reg
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u32
name|vfsrrctl
decl_stmt|;
name|u32
name|vfdca_rxctrl
decl_stmt|;
name|u32
name|vfdca_txctrl
decl_stmt|;
comment|/* VRSRRCTL default values (BSIZEPACKET = 2048, BSIZEHEADER = 256) */
name|vfsrrctl
operator|=
literal|0x100
operator|<<
name|IXGBE_SRRCTL_BSIZEHDRSIZE_SHIFT
expr_stmt|;
name|vfsrrctl
operator||=
literal|0x800
operator|>>
name|IXGBE_SRRCTL_BSIZEPKT_SHIFT
expr_stmt|;
comment|/* DCA_RXCTRL default value */
name|vfdca_rxctrl
operator|=
name|IXGBE_DCA_RXCTRL_DESC_RRO_EN
operator||
name|IXGBE_DCA_RXCTRL_DATA_WRO_EN
operator||
name|IXGBE_DCA_RXCTRL_HEAD_WRO_EN
expr_stmt|;
comment|/* DCA_TXCTRL default value */
name|vfdca_txctrl
operator|=
name|IXGBE_DCA_TXCTRL_DESC_RRO_EN
operator||
name|IXGBE_DCA_TXCTRL_DESC_WRO_EN
operator||
name|IXGBE_DCA_TXCTRL_DATA_RRO_EN
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFPSRTYPE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
block|{
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRDH
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRDT
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRXDCTL
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFSRRCTL
argument_list|(
name|i
argument_list|)
argument_list|,
name|vfsrrctl
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTDH
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTDT
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTXDCTL
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTDWBAH
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTDWBAL
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFDCA_RXCTRL
argument_list|(
name|i
argument_list|)
argument_list|,
name|vfdca_rxctrl
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFDCA_TXCTRL
argument_list|(
name|i
argument_list|)
argument_list|,
name|vfdca_txctrl
argument_list|)
expr_stmt|;
block|}
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_start_hw_vf - Prepare hardware for Tx/Rx  *  @hw: pointer to hardware structure  *  *  Starts the hardware by filling the bus info structure and media type, clears  *  all on chip counters, initializes receive address registers, multicast  *  table, VLAN filter table, calls routine to set up link and flow control  *  settings, and leaves transmit and receive units disabled and uninitialized  **/
end_comment

begin_function
name|s32
name|ixgbe_start_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
comment|/* Clear adapter stopped flag */
name|hw
operator|->
name|adapter_stopped
operator|=
name|FALSE
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_init_hw_vf - virtual function hardware initialization  *  @hw: pointer to hardware structure  *  *  Initialize the hardware by resetting the hardware and then starting  *  the hardware  **/
end_comment

begin_function
name|s32
name|ixgbe_init_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|status
init|=
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|start_hw
argument_list|(
name|hw
argument_list|)
decl_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_mac_addr
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|mac
operator|.
name|addr
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_reset_hw_vf - Performs hardware reset  *  @hw: pointer to hardware structure  *  *  Resets the hardware by reseting the transmit and receive units, masks and  *  clears all interrupts.  **/
end_comment

begin_function
name|s32
name|ixgbe_reset_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|u32
name|timeout
init|=
name|IXGBE_VF_INIT_TIMEOUT
decl_stmt|;
name|s32
name|ret_val
init|=
name|IXGBE_ERR_INVALID_MAC_ADDR
decl_stmt|;
name|u32
name|msgbuf
index|[
name|IXGBE_VF_PERMADDR_MSG_LEN
index|]
decl_stmt|;
name|u8
modifier|*
name|addr
init|=
operator|(
name|u8
operator|*
operator|)
operator|(
operator|&
name|msgbuf
index|[
literal|1
index|]
operator|)
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbevf_reset_hw_vf"
argument_list|)
expr_stmt|;
comment|/* Call adapter stop to disable tx/rx and clear interrupts */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|stop_adapter
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* reset the api version */
name|hw
operator|->
name|api_version
operator|=
name|ixgbe_mbox_api_10
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Issuing a function level reset to MAC\n"
argument_list|)
expr_stmt|;
name|IXGBE_VFWRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFCTRL
argument_list|,
name|IXGBE_CTRL_RST
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|msec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/* we cannot reset while the RSTI / RSTD bits are asserted */
while|while
condition|(
operator|!
name|mbx
operator|->
name|ops
operator|.
name|check_for_rst
argument_list|(
name|hw
argument_list|,
literal|0
argument_list|)
operator|&&
name|timeout
condition|)
block|{
name|timeout
operator|--
expr_stmt|;
name|usec_delay
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|timeout
condition|)
return|return
name|IXGBE_ERR_RESET_FAILED
return|;
comment|/* Reset VF registers to initial values */
name|ixgbe_virt_clr_reg
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* mailbox timeout can now become active */
name|mbx
operator|->
name|timeout
operator|=
name|IXGBE_VF_MBX_INIT_TIMEOUT
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_RESET
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|write_posted
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/* 	 * set our "perm_addr" based on info provided by PF 	 * also set up the mc_filter_type which is piggy backed 	 * on the mac address in word 3 	 */
name|ret_val
operator|=
name|mbx
operator|->
name|ops
operator|.
name|read_posted
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
name|IXGBE_VF_PERMADDR_MSG_LEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
condition|)
return|return
name|ret_val
return|;
if|if
condition|(
name|msgbuf
index|[
literal|0
index|]
operator|!=
operator|(
name|IXGBE_VF_RESET
operator||
name|IXGBE_VT_MSGTYPE_ACK
operator|)
operator|&&
name|msgbuf
index|[
literal|0
index|]
operator|!=
operator|(
name|IXGBE_VF_RESET
operator||
name|IXGBE_VT_MSGTYPE_NACK
operator|)
condition|)
return|return
name|IXGBE_ERR_INVALID_MAC_ADDR
return|;
if|if
condition|(
name|msgbuf
index|[
literal|0
index|]
operator|==
operator|(
name|IXGBE_VF_RESET
operator||
name|IXGBE_VT_MSGTYPE_ACK
operator|)
condition|)
name|memcpy
argument_list|(
name|hw
operator|->
name|mac
operator|.
name|perm_addr
argument_list|,
name|addr
argument_list|,
name|IXGBE_ETH_LENGTH_OF_ADDRESS
argument_list|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|mc_filter_type
operator|=
name|msgbuf
index|[
name|IXGBE_VF_MC_TYPE_WORD
index|]
expr_stmt|;
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_stop_adapter_vf - Generic stop Tx/Rx units  *  @hw: pointer to hardware structure  *  *  Sets the adapter_stopped flag within ixgbe_hw struct. Clears interrupts,  *  disables transmit and receive units. The adapter_stopped flag is used by  *  the shared code and drivers to determine if the adapter is in a stopped  *  state and should not touch the hardware.  **/
end_comment

begin_function
name|s32
name|ixgbe_stop_adapter_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|u32
name|reg_val
decl_stmt|;
name|u16
name|i
decl_stmt|;
comment|/* 	 * Set the adapter_stopped flag so other driver functions stop touching 	 * the hardware 	 */
name|hw
operator|->
name|adapter_stopped
operator|=
name|TRUE
expr_stmt|;
comment|/* Clear interrupt mask to stop from interrupts being generated */
name|IXGBE_VFWRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VTEIMC
argument_list|,
name|IXGBE_VF_IRQ_CLEAR_MASK
argument_list|)
expr_stmt|;
comment|/* Clear any pending interrupts, flush previous writes */
name|IXGBE_VFREAD_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VTEICR
argument_list|)
expr_stmt|;
comment|/* Disable the transmit unit.  Each queue must be disabled. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|mac
operator|.
name|max_tx_queues
condition|;
name|i
operator|++
control|)
name|IXGBE_VFWRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTXDCTL
argument_list|(
name|i
argument_list|)
argument_list|,
name|IXGBE_TXDCTL_SWFLSH
argument_list|)
expr_stmt|;
comment|/* Disable the receive unit by stopping each queue */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|mac
operator|.
name|max_rx_queues
condition|;
name|i
operator|++
control|)
block|{
name|reg_val
operator|=
name|IXGBE_VFREAD_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRXDCTL
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg_val
operator|&=
operator|~
name|IXGBE_RXDCTL_ENABLE
expr_stmt|;
name|IXGBE_VFWRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRXDCTL
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
comment|/* Clear packet split and pool config */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFPSRTYPE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* flush all queues disables */
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|msec_delay
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_mta_vector - Determines bit-vector in multicast table to set  *  @hw: pointer to hardware structure  *  @mc_addr: the multicast address  *  *  Extracts the 12 bits, from a multicast address, to determine which  *  bit-vector to set in the multicast table. The hardware uses 12 bits, from  *  incoming rx multicast addresses, to determine the bit-vector to check in  *  the MTA. Which of the 4 combination, of 12-bits, the hardware uses is set  *  by the MO field of the MCSTCTRL. The MO field is set during initialization  *  to mc_filter_type.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_mta_vector
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
modifier|*
name|mc_addr
parameter_list|)
block|{
name|u32
name|vector
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|mc_filter_type
condition|)
block|{
case|case
literal|0
case|:
comment|/* use bits [47:36] of the address */
name|vector
operator|=
operator|(
operator|(
name|mc_addr
index|[
literal|4
index|]
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|mc_addr
index|[
literal|5
index|]
operator|)
operator|<<
literal|4
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* use bits [46:35] of the address */
name|vector
operator|=
operator|(
operator|(
name|mc_addr
index|[
literal|4
index|]
operator|>>
literal|3
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|mc_addr
index|[
literal|5
index|]
operator|)
operator|<<
literal|5
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* use bits [45:34] of the address */
name|vector
operator|=
operator|(
operator|(
name|mc_addr
index|[
literal|4
index|]
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|mc_addr
index|[
literal|5
index|]
operator|)
operator|<<
literal|6
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* use bits [43:32] of the address */
name|vector
operator|=
operator|(
operator|(
name|mc_addr
index|[
literal|4
index|]
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|mc_addr
index|[
literal|5
index|]
operator|)
operator|<<
literal|8
operator|)
operator|)
expr_stmt|;
break|break;
default|default:
comment|/* Invalid mc_filter_type */
name|DEBUGOUT
argument_list|(
literal|"MC filter type param set incorrectly\n"
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* vector can only be 12-bits or boundary will be exceeded */
name|vector
operator|&=
literal|0xFFF
expr_stmt|;
return|return
name|vector
return|;
block|}
end_function

begin_function
specifier|static
name|s32
name|ixgbevf_write_msg_read_ack
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
modifier|*
name|msg
parameter_list|,
name|u32
modifier|*
name|retmsg
parameter_list|,
name|u16
name|size
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|s32
name|retval
init|=
name|mbx
operator|->
name|ops
operator|.
name|write_posted
argument_list|(
name|hw
argument_list|,
name|msg
argument_list|,
name|size
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|retval
condition|)
return|return
name|retval
return|;
return|return
name|mbx
operator|->
name|ops
operator|.
name|read_posted
argument_list|(
name|hw
argument_list|,
name|retmsg
argument_list|,
name|size
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_set_rar_vf - set device MAC address  *  @hw: pointer to hardware structure  *  @index: Receive address register to write  *  @addr: Address to put into receive address register  *  @vmdq: VMDq "set" or "pool" index  *  @enable_addr: set flag that address is active  **/
end_comment

begin_function
name|s32
name|ixgbe_set_rar_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|index
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|,
name|u32
name|vmdq
parameter_list|,
name|u32
name|enable_addr
parameter_list|)
block|{
name|u32
name|msgbuf
index|[
literal|3
index|]
decl_stmt|;
name|u8
modifier|*
name|msg_addr
init|=
operator|(
name|u8
operator|*
operator|)
operator|(
operator|&
name|msgbuf
index|[
literal|1
index|]
operator|)
decl_stmt|;
name|s32
name|ret_val
decl_stmt|;
name|UNREFERENCED_3PARAMETER
argument_list|(
name|vmdq
argument_list|,
name|enable_addr
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|msgbuf
argument_list|,
literal|0
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_SET_MAC_ADDR
expr_stmt|;
name|memcpy
argument_list|(
name|msg_addr
argument_list|,
name|addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|ret_val
operator|=
name|ixgbevf_write_msg_read_ack
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
name|msgbuf
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|&=
operator|~
name|IXGBE_VT_MSGTYPE_CTS
expr_stmt|;
comment|/* if nacked the address was rejected, use "perm_addr" */
if|if
condition|(
operator|!
name|ret_val
operator|&&
operator|(
name|msgbuf
index|[
literal|0
index|]
operator|==
operator|(
name|IXGBE_VF_SET_MAC_ADDR
operator||
name|IXGBE_VT_MSGTYPE_NACK
operator|)
operator|)
condition|)
block|{
name|ixgbe_get_mac_addr_vf
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|mac
operator|.
name|addr
argument_list|)
expr_stmt|;
return|return
name|IXGBE_ERR_MBX
return|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_update_mc_addr_list_vf - Update Multicast addresses  *  @hw: pointer to the HW structure  *  @mc_addr_list: array of multicast addresses to program  *  @mc_addr_count: number of multicast addresses to program  *  @next: caller supplied function to return next address in list  *  *  Updates the Multicast Table Array.  **/
end_comment

begin_function
name|s32
name|ixgbe_update_mc_addr_list_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
modifier|*
name|mc_addr_list
parameter_list|,
name|u32
name|mc_addr_count
parameter_list|,
name|ixgbe_mc_addr_itr
name|next
parameter_list|,
name|bool
name|clear
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|u32
name|msgbuf
index|[
name|IXGBE_VFMAILBOX_SIZE
index|]
decl_stmt|;
name|u16
modifier|*
name|vector_list
init|=
operator|(
name|u16
operator|*
operator|)
operator|&
name|msgbuf
index|[
literal|1
index|]
decl_stmt|;
name|u32
name|vector
decl_stmt|;
name|u32
name|cnt
decl_stmt|,
name|i
decl_stmt|;
name|u32
name|vmdq
decl_stmt|;
name|UNREFERENCED_1PARAMETER
argument_list|(
name|clear
argument_list|)
expr_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_update_mc_addr_list_vf"
argument_list|)
expr_stmt|;
comment|/* Each entry in the list uses 1 16 bit word.  We have 30 	 * 16 bit words available in our HW msg buffer (minus 1 for the 	 * msg type).  That's 30 hash values if we pack 'em right.  If 	 * there are more than 30 MC addresses to add then punt the 	 * extras for now and then add code to handle more than 30 later. 	 * It would be unusual for a server to request that many multi-cast 	 * addresses except for in large enterprise network environments. 	 */
name|DEBUGOUT1
argument_list|(
literal|"MC Addr Count = %d\n"
argument_list|,
name|mc_addr_count
argument_list|)
expr_stmt|;
name|cnt
operator|=
operator|(
name|mc_addr_count
operator|>
literal|30
operator|)
condition|?
literal|30
else|:
name|mc_addr_count
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_SET_MULTICAST
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator||=
name|cnt
operator|<<
name|IXGBE_VT_MSGINFO_SHIFT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|vector
operator|=
name|ixgbe_mta_vector
argument_list|(
name|hw
argument_list|,
name|next
argument_list|(
name|hw
argument_list|,
operator|&
name|mc_addr_list
argument_list|,
operator|&
name|vmdq
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Hash value = 0x%03X\n"
argument_list|,
name|vector
argument_list|)
expr_stmt|;
name|vector_list
index|[
name|i
index|]
operator|=
operator|(
name|u16
operator|)
name|vector
expr_stmt|;
block|}
return|return
name|mbx
operator|->
name|ops
operator|.
name|write_posted
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
name|IXGBE_VFMAILBOX_SIZE
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbevf_update_xcast_mode - Update Multicast mode  *  @hw: pointer to the HW structure  *  @xcast_mode: new multicast mode  *  *  Updates the Multicast Mode of VF.  **/
end_comment

begin_function
name|s32
name|ixgbevf_update_xcast_mode
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|int
name|xcast_mode
parameter_list|)
block|{
name|u32
name|msgbuf
index|[
literal|2
index|]
decl_stmt|;
name|s32
name|err
decl_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|api_version
condition|)
block|{
case|case
name|ixgbe_mbox_api_12
case|:
comment|/* New modes were introduced in 1.3 version */
if|if
condition|(
name|xcast_mode
operator|>
name|IXGBEVF_XCAST_MODE_ALLMULTI
condition|)
return|return
name|IXGBE_ERR_FEATURE_NOT_SUPPORTED
return|;
comment|/* Fall through */
case|case
name|ixgbe_mbox_api_13
case|:
break|break;
default|default:
return|return
name|IXGBE_ERR_FEATURE_NOT_SUPPORTED
return|;
block|}
name|msgbuf
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_UPDATE_XCAST_MODE
expr_stmt|;
name|msgbuf
index|[
literal|1
index|]
operator|=
name|xcast_mode
expr_stmt|;
name|err
operator|=
name|ixgbevf_write_msg_read_ack
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
name|msgbuf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|msgbuf
index|[
literal|0
index|]
operator|&=
operator|~
name|IXGBE_VT_MSGTYPE_CTS
expr_stmt|;
if|if
condition|(
name|msgbuf
index|[
literal|0
index|]
operator|==
operator|(
name|IXGBE_VF_UPDATE_XCAST_MODE
operator||
name|IXGBE_VT_MSGTYPE_NACK
operator|)
condition|)
return|return
name|IXGBE_ERR_FEATURE_NOT_SUPPORTED
return|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_set_vfta_vf - Set/Unset vlan filter table address  *  @hw: pointer to the HW structure  *  @vlan: 12 bit VLAN ID  *  @vind: unused by VF drivers  *  @vlan_on: if TRUE then set bit, else clear bit  *  @vlvf_bypass: boolean flag indicating updating default pool is okay  *  *  Turn on/off specified VLAN in the VLAN filter table.  **/
end_comment

begin_function
name|s32
name|ixgbe_set_vfta_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|vlan
parameter_list|,
name|u32
name|vind
parameter_list|,
name|bool
name|vlan_on
parameter_list|,
name|bool
name|vlvf_bypass
parameter_list|)
block|{
name|u32
name|msgbuf
index|[
literal|2
index|]
decl_stmt|;
name|s32
name|ret_val
decl_stmt|;
name|UNREFERENCED_2PARAMETER
argument_list|(
name|vind
argument_list|,
name|vlvf_bypass
argument_list|)
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_SET_VLAN
expr_stmt|;
name|msgbuf
index|[
literal|1
index|]
operator|=
name|vlan
expr_stmt|;
comment|/* Setting the 8 bit field MSG INFO to TRUE indicates "add" */
name|msgbuf
index|[
literal|0
index|]
operator||=
name|vlan_on
operator|<<
name|IXGBE_VT_MSGINFO_SHIFT
expr_stmt|;
name|ret_val
operator|=
name|ixgbevf_write_msg_read_ack
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
name|msgbuf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret_val
operator|&&
operator|(
name|msgbuf
index|[
literal|0
index|]
operator|&
name|IXGBE_VT_MSGTYPE_ACK
operator|)
condition|)
return|return
name|IXGBE_SUCCESS
return|;
return|return
name|ret_val
operator||
operator|(
name|msgbuf
index|[
literal|0
index|]
operator|&
name|IXGBE_VT_MSGTYPE_NACK
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_num_of_tx_queues_vf - Get number of TX queues  *  @hw: pointer to hardware structure  *  *  Returns the number of transmit queues for the given adapter.  **/
end_comment

begin_function
name|u32
name|ixgbe_get_num_of_tx_queues_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|UNREFERENCED_1PARAMETER
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|IXGBE_VF_MAX_TX_QUEUES
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_num_of_rx_queues_vf - Get number of RX queues  *  @hw: pointer to hardware structure  *  *  Returns the number of receive queues for the given adapter.  **/
end_comment

begin_function
name|u32
name|ixgbe_get_num_of_rx_queues_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|UNREFERENCED_1PARAMETER
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|IXGBE_VF_MAX_RX_QUEUES
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_mac_addr_vf - Read device MAC address  *  @hw: pointer to the HW structure  **/
end_comment

begin_function
name|s32
name|ixgbe_get_mac_addr_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
modifier|*
name|mac_addr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_ETH_LENGTH_OF_ADDRESS
condition|;
name|i
operator|++
control|)
name|mac_addr
index|[
name|i
index|]
operator|=
name|hw
operator|->
name|mac
operator|.
name|perm_addr
index|[
name|i
index|]
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_function
name|s32
name|ixgbevf_set_uc_addr_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|index
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|u32
name|msgbuf
index|[
literal|3
index|]
decl_stmt|,
name|msgbuf_chk
decl_stmt|;
name|u8
modifier|*
name|msg_addr
init|=
operator|(
name|u8
operator|*
operator|)
operator|(
operator|&
name|msgbuf
index|[
literal|1
index|]
operator|)
decl_stmt|;
name|s32
name|ret_val
decl_stmt|;
name|memset
argument_list|(
name|msgbuf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msgbuf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * If index is one then this is the start of a new list and needs 	 * indication to the PF so it can do it's own list management. 	 * If it is zero then that tells the PF to just clear all of 	 * this VF's macvlans and there is no new list. 	 */
name|msgbuf
index|[
literal|0
index|]
operator||=
name|index
operator|<<
name|IXGBE_VT_MSGINFO_SHIFT
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator||=
name|IXGBE_VF_SET_MACVLAN
expr_stmt|;
name|msgbuf_chk
operator|=
name|msgbuf
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|addr
condition|)
name|memcpy
argument_list|(
name|msg_addr
argument_list|,
name|addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|ret_val
operator|=
name|ixgbevf_write_msg_read_ack
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
name|msgbuf
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret_val
condition|)
block|{
name|msgbuf
index|[
literal|0
index|]
operator|&=
operator|~
name|IXGBE_VT_MSGTYPE_CTS
expr_stmt|;
if|if
condition|(
name|msgbuf
index|[
literal|0
index|]
operator|==
operator|(
name|msgbuf_chk
operator||
name|IXGBE_VT_MSGTYPE_NACK
operator|)
condition|)
return|return
name|IXGBE_ERR_OUT_OF_MEM
return|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_mac_link_vf - Setup MAC link settings  *  @hw: pointer to hardware structure  *  @speed: new link speed  *  @autoneg: TRUE if autonegotiation enabled  *  @autoneg_wait_to_complete: TRUE when waiting for completion is needed  *  *  Set the link speed in the AUTOC register and restarts link.  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_mac_link_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
block|{
name|UNREFERENCED_3PARAMETER
argument_list|(
name|hw
argument_list|,
name|speed
argument_list|,
name|autoneg_wait_to_complete
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_mac_link_vf - Get link/speed status  *  @hw: pointer to hardware structure  *  @speed: pointer to link speed  *  @link_up: TRUE is link is up, FALSE otherwise  *  @autoneg_wait_to_complete: TRUE when waiting for completion is needed  *  *  Reads the links register to determine if link is up and the current speed  **/
end_comment

begin_function
name|s32
name|ixgbe_check_mac_link_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|struct
name|ixgbe_mac_info
modifier|*
name|mac
init|=
operator|&
name|hw
operator|->
name|mac
decl_stmt|;
name|s32
name|ret_val
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u32
name|links_reg
decl_stmt|;
name|u32
name|in_msg
init|=
literal|0
decl_stmt|;
name|UNREFERENCED_1PARAMETER
argument_list|(
name|autoneg_wait_to_complete
argument_list|)
expr_stmt|;
comment|/* If we were hit with a reset drop the link */
if|if
condition|(
operator|!
name|mbx
operator|->
name|ops
operator|.
name|check_for_rst
argument_list|(
name|hw
argument_list|,
literal|0
argument_list|)
operator|||
operator|!
name|mbx
operator|->
name|timeout
condition|)
name|mac
operator|->
name|get_link_status
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|mac
operator|->
name|get_link_status
condition|)
goto|goto
name|out
goto|;
comment|/* if link status is down no point in checking to see if pf is up */
name|links_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFLINKS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|links_reg
operator|&
name|IXGBE_LINKS_UP
operator|)
condition|)
goto|goto
name|out
goto|;
comment|/* for SFP+ modules and DA cables on 82599 it can take up to 500usecs 	 * before the link status is correct 	 */
if|if
condition|(
name|mac
operator|->
name|type
operator|==
name|ixgbe_mac_82599_vf
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|links_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFLINKS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|links_reg
operator|&
name|IXGBE_LINKS_UP
operator|)
condition|)
goto|goto
name|out
goto|;
block|}
block|}
switch|switch
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_SPEED_82599
condition|)
block|{
case|case
name|IXGBE_LINKS_SPEED_10G_82599
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
operator|>=
name|ixgbe_mac_X550
condition|)
block|{
if|if
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_SPEED_NON_STD
condition|)
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_2_5GB_FULL
expr_stmt|;
block|}
break|break;
case|case
name|IXGBE_LINKS_SPEED_1G_82599
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
break|break;
case|case
name|IXGBE_LINKS_SPEED_100_82599
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_100_FULL
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
operator|==
name|ixgbe_mac_X550
condition|)
block|{
if|if
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_SPEED_NON_STD
condition|)
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_5GB_FULL
expr_stmt|;
block|}
break|break;
case|case
name|IXGBE_LINKS_SPEED_10_X550EM_A
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_UNKNOWN
expr_stmt|;
comment|/* Since Reserved in older MAC's */
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
operator|>=
name|ixgbe_mac_X550
condition|)
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_10_FULL
expr_stmt|;
break|break;
default|default:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_UNKNOWN
expr_stmt|;
block|}
comment|/* if the read failed it could just be a mailbox collision, best wait 	 * until we are called again and don't report an error 	 */
if|if
condition|(
name|mbx
operator|->
name|ops
operator|.
name|read
argument_list|(
name|hw
argument_list|,
operator|&
name|in_msg
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|!
operator|(
name|in_msg
operator|&
name|IXGBE_VT_MSGTYPE_CTS
operator|)
condition|)
block|{
comment|/* msg is not CTS and is NACK we must have lost CTS status */
if|if
condition|(
name|in_msg
operator|&
name|IXGBE_VT_MSGTYPE_NACK
condition|)
name|ret_val
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* the pf is talking, if we timed out in the past we reinit */
if|if
condition|(
operator|!
name|mbx
operator|->
name|timeout
condition|)
block|{
name|ret_val
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* if we passed all the tests above then the link is up and we no 	 * longer need to check for link 	 */
name|mac
operator|->
name|get_link_status
operator|=
name|FALSE
expr_stmt|;
name|out
label|:
operator|*
name|link_up
operator|=
operator|!
name|mac
operator|->
name|get_link_status
expr_stmt|;
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbevf_rlpml_set_vf - Set the maximum receive packet length  *  @hw: pointer to the HW structure  *  @max_size: value to assign to max frame size  **/
end_comment

begin_function
name|s32
name|ixgbevf_rlpml_set_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
name|max_size
parameter_list|)
block|{
name|u32
name|msgbuf
index|[
literal|2
index|]
decl_stmt|;
name|s32
name|retval
decl_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_SET_LPE
expr_stmt|;
name|msgbuf
index|[
literal|1
index|]
operator|=
name|max_size
expr_stmt|;
name|retval
operator|=
name|ixgbevf_write_msg_read_ack
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
name|msgbuf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
condition|)
return|return
name|retval
return|;
if|if
condition|(
operator|(
name|msgbuf
index|[
literal|0
index|]
operator|&
name|IXGBE_VF_SET_LPE
operator|)
operator|&&
operator|(
name|msgbuf
index|[
literal|0
index|]
operator|&
name|IXGBE_VT_MSGTYPE_NACK
operator|)
condition|)
return|return
name|IXGBE_ERR_MBX
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbevf_negotiate_api_version - Negotiate supported API version  *  @hw: pointer to the HW structure  *  @api: integer containing requested API version  **/
end_comment

begin_function
name|int
name|ixgbevf_negotiate_api_version
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|int
name|api
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|u32
name|msg
index|[
literal|3
index|]
decl_stmt|;
comment|/* Negotiate the mailbox API version */
name|msg
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_API_NEGOTIATE
expr_stmt|;
name|msg
index|[
literal|1
index|]
operator|=
name|api
expr_stmt|;
name|msg
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|ixgbevf_write_msg_read_ack
argument_list|(
name|hw
argument_list|,
name|msg
argument_list|,
name|msg
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|msg
index|[
literal|0
index|]
operator|&=
operator|~
name|IXGBE_VT_MSGTYPE_CTS
expr_stmt|;
comment|/* Store value and return 0 on success */
if|if
condition|(
name|msg
index|[
literal|0
index|]
operator|==
operator|(
name|IXGBE_VF_API_NEGOTIATE
operator||
name|IXGBE_VT_MSGTYPE_ACK
operator|)
condition|)
block|{
name|hw
operator|->
name|api_version
operator|=
name|api
expr_stmt|;
return|return
literal|0
return|;
block|}
name|err
operator|=
name|IXGBE_ERR_INVALID_ARGUMENT
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|ixgbevf_get_queues
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|unsigned
name|int
modifier|*
name|num_tcs
parameter_list|,
name|unsigned
name|int
modifier|*
name|default_tc
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|u32
name|msg
index|[
literal|5
index|]
decl_stmt|;
comment|/* do nothing if API doesn't support ixgbevf_get_queues */
switch|switch
condition|(
name|hw
operator|->
name|api_version
condition|)
block|{
case|case
name|ixgbe_mbox_api_11
case|:
case|case
name|ixgbe_mbox_api_12
case|:
case|case
name|ixgbe_mbox_api_13
case|:
break|break;
default|default:
return|return
literal|0
return|;
block|}
comment|/* Fetch queue configuration from the PF */
name|msg
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_GET_QUEUES
expr_stmt|;
name|msg
index|[
literal|1
index|]
operator|=
name|msg
index|[
literal|2
index|]
operator|=
name|msg
index|[
literal|3
index|]
operator|=
name|msg
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|ixgbevf_write_msg_read_ack
argument_list|(
name|hw
argument_list|,
name|msg
argument_list|,
name|msg
argument_list|,
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|msg
index|[
literal|0
index|]
operator|&=
operator|~
name|IXGBE_VT_MSGTYPE_CTS
expr_stmt|;
comment|/* 		 * if we we didn't get an ACK there must have been 		 * some sort of mailbox error so we should treat it 		 * as such 		 */
if|if
condition|(
name|msg
index|[
literal|0
index|]
operator|!=
operator|(
name|IXGBE_VF_GET_QUEUES
operator||
name|IXGBE_VT_MSGTYPE_ACK
operator|)
condition|)
return|return
name|IXGBE_ERR_MBX
return|;
comment|/* record and validate values from message */
name|hw
operator|->
name|mac
operator|.
name|max_tx_queues
operator|=
name|msg
index|[
name|IXGBE_VF_TX_QUEUES
index|]
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|max_tx_queues
operator|==
literal|0
operator|||
name|hw
operator|->
name|mac
operator|.
name|max_tx_queues
operator|>
name|IXGBE_VF_MAX_TX_QUEUES
condition|)
name|hw
operator|->
name|mac
operator|.
name|max_tx_queues
operator|=
name|IXGBE_VF_MAX_TX_QUEUES
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|max_rx_queues
operator|=
name|msg
index|[
name|IXGBE_VF_RX_QUEUES
index|]
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|max_rx_queues
operator|==
literal|0
operator|||
name|hw
operator|->
name|mac
operator|.
name|max_rx_queues
operator|>
name|IXGBE_VF_MAX_RX_QUEUES
condition|)
name|hw
operator|->
name|mac
operator|.
name|max_rx_queues
operator|=
name|IXGBE_VF_MAX_RX_QUEUES
expr_stmt|;
operator|*
name|num_tcs
operator|=
name|msg
index|[
name|IXGBE_VF_TRANS_VLAN
index|]
expr_stmt|;
comment|/* in case of unknown state assume we cannot tag frames */
if|if
condition|(
operator|*
name|num_tcs
operator|>
name|hw
operator|->
name|mac
operator|.
name|max_rx_queues
condition|)
operator|*
name|num_tcs
operator|=
literal|1
expr_stmt|;
operator|*
name|default_tc
operator|=
name|msg
index|[
name|IXGBE_VF_DEF_QUEUE
index|]
expr_stmt|;
comment|/* default to queue 0 on out-of-bounds queue number */
if|if
condition|(
operator|*
name|default_tc
operator|>=
name|hw
operator|->
name|mac
operator|.
name|max_tx_queues
condition|)
operator|*
name|default_tc
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

end_unit


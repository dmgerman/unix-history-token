begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2001-2010, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"ixgbe_api.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_type.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_vf.h"
end_include

begin_function_decl
name|s32
name|ixgbe_init_ops_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_init_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_start_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_reset_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_stop_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|u32
name|ixgbe_get_num_of_tx_queues_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|u32
name|ixgbe_get_num_of_rx_queues_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_get_mac_addr_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
modifier|*
name|mac_addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_setup_mac_link_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_check_mac_link_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_set_rar_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|index
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|,
name|u32
name|vmdq
parameter_list|,
name|u32
name|enable_addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_update_mc_addr_list_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
modifier|*
name|mc_addr_list
parameter_list|,
name|u32
name|mc_addr_count
parameter_list|,
name|ixgbe_mc_addr_itr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_set_vfta_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|vlan
parameter_list|,
name|u32
name|vind
parameter_list|,
name|bool
name|vlan_on
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|IXGBE_VFWRITE_REG
end_ifndef

begin_define
define|#
directive|define
name|IXGBE_VFWRITE_REG
value|IXGBE_WRITE_REG
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|IXGBE_VFREAD_REG
end_ifndef

begin_define
define|#
directive|define
name|IXGBE_VFREAD_REG
value|IXGBE_READ_REG
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  *  ixgbe_init_ops_vf - Initialize the pointers for vf  *  @hw: pointer to hardware structure  *  *  This will assign function pointers, adapter-specific functions can  *  override the assignment of generic function pointers by assigning  *  their own adapter-specific function pointers.  *  Does not touch the hardware.  **/
end_comment

begin_function
name|s32
name|ixgbe_init_ops_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
comment|/* MAC */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|init_hw
operator|=
name|ixgbe_init_hw_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|reset_hw
operator|=
name|ixgbe_reset_hw_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|start_hw
operator|=
name|ixgbe_start_hw_vf
expr_stmt|;
comment|/* Cannot clear stats on VF */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|clear_hw_cntrs
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_media_type
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_mac_addr
operator|=
name|ixgbe_get_mac_addr_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|stop_adapter
operator|=
name|ixgbe_stop_hw_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_bus_info
operator|=
name|NULL
expr_stmt|;
comment|/* Link */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|setup_link
operator|=
name|ixgbe_setup_mac_link_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|check_link
operator|=
name|ixgbe_check_mac_link_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_link_capabilities
operator|=
name|NULL
expr_stmt|;
comment|/* RAR, Multicast, VLAN */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|set_rar
operator|=
name|ixgbe_set_rar_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|init_rx_addrs
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|update_mc_addr_list
operator|=
name|ixgbe_update_mc_addr_list_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|enable_mc
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|disable_mc
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|clear_vfta
operator|=
name|NULL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|set_vfta
operator|=
name|ixgbe_set_vfta_vf
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|max_tx_queues
operator|=
literal|1
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|max_rx_queues
operator|=
literal|1
expr_stmt|;
name|hw
operator|->
name|mbx
operator|.
name|ops
operator|.
name|init_params
operator|=
name|ixgbe_init_mbx_params_vf
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_start_hw_vf - Prepare hardware for Tx/Rx  *  @hw: pointer to hardware structure  *  *  Starts the hardware by filling the bus info structure and media type, clears  *  all on chip counters, initializes receive address registers, multicast  *  table, VLAN filter table, calls routine to set up link and flow control  *  settings, and leaves transmit and receive units disabled and uninitialized  **/
end_comment

begin_function
name|s32
name|ixgbe_start_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
comment|/* Clear adapter stopped flag */
name|hw
operator|->
name|adapter_stopped
operator|=
name|FALSE
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_init_hw_vf - virtual function hardware initialization  *  @hw: pointer to hardware structure  *  *  Initialize the hardware by resetting the hardware and then starting  *  the hardware  **/
end_comment

begin_function
name|s32
name|ixgbe_init_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|status
init|=
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|start_hw
argument_list|(
name|hw
argument_list|)
decl_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_mac_addr
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|mac
operator|.
name|addr
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_reset_hw_vf - Performs hardware reset  *  @hw: pointer to hardware structure  *  *  Resets the hardware by reseting the transmit and receive units, masks and  *  clears all interrupts.  **/
end_comment

begin_function
name|s32
name|ixgbe_reset_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|u32
name|timeout
init|=
name|IXGBE_VF_INIT_TIMEOUT
decl_stmt|;
name|s32
name|ret_val
init|=
name|IXGBE_ERR_INVALID_MAC_ADDR
decl_stmt|;
name|u32
name|ctrl
decl_stmt|,
name|msgbuf
index|[
name|IXGBE_VF_PERMADDR_MSG_LEN
index|]
decl_stmt|;
name|u8
modifier|*
name|addr
init|=
operator|(
name|u8
operator|*
operator|)
operator|(
operator|&
name|msgbuf
index|[
literal|1
index|]
operator|)
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbevf_reset_hw_vf"
argument_list|)
expr_stmt|;
comment|/* Call adapter stop to disable tx/rx and clear interrupts */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|stop_adapter
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Issuing a function level reset to MAC\n"
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|IXGBE_VFREAD_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFCTRL
argument_list|)
expr_stmt|;
name|IXGBE_VFWRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFCTRL
argument_list|,
operator|(
name|ctrl
operator||
name|IXGBE_CTRL_RST
operator|)
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* we cannot reset while the RSTI / RSTD bits are asserted */
while|while
condition|(
operator|!
name|mbx
operator|->
name|ops
operator|.
name|check_for_rst
argument_list|(
name|hw
argument_list|,
literal|0
argument_list|)
operator|&&
name|timeout
condition|)
block|{
name|timeout
operator|--
expr_stmt|;
name|usec_delay
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timeout
condition|)
block|{
comment|/* mailbox timeout can now become active */
name|mbx
operator|->
name|timeout
operator|=
name|IXGBE_VF_MBX_INIT_TIMEOUT
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_RESET
expr_stmt|;
name|mbx
operator|->
name|ops
operator|.
name|write_posted
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/* set our "perm_addr" based on info provided by PF */
comment|/* also set up the mc_filter_type which is piggy backed 		 * on the mac address in word 3 */
name|ret_val
operator|=
name|mbx
operator|->
name|ops
operator|.
name|read_posted
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
name|IXGBE_VF_PERMADDR_MSG_LEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret_val
condition|)
block|{
if|if
condition|(
name|msgbuf
index|[
literal|0
index|]
operator|==
operator|(
name|IXGBE_VF_RESET
operator||
name|IXGBE_VT_MSGTYPE_ACK
operator|)
condition|)
block|{
name|memcpy
argument_list|(
name|hw
operator|->
name|mac
operator|.
name|perm_addr
argument_list|,
name|addr
argument_list|,
name|IXGBE_ETH_LENGTH_OF_ADDRESS
argument_list|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|mc_filter_type
operator|=
name|msgbuf
index|[
name|IXGBE_VF_MC_TYPE_WORD
index|]
expr_stmt|;
block|}
else|else
block|{
name|ret_val
operator|=
name|IXGBE_ERR_INVALID_MAC_ADDR
expr_stmt|;
block|}
block|}
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_stop_hw_vf - Generic stop Tx/Rx units  *  @hw: pointer to hardware structure  *  *  Sets the adapter_stopped flag within ixgbe_hw struct. Clears interrupts,  *  disables transmit and receive units. The adapter_stopped flag is used by  *  the shared code and drivers to determine if the adapter is in a stopped  *  state and should not touch the hardware.  **/
end_comment

begin_function
name|s32
name|ixgbe_stop_hw_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|u32
name|number_of_queues
decl_stmt|;
name|u32
name|reg_val
decl_stmt|;
name|u16
name|i
decl_stmt|;
comment|/* 	 * Set the adapter_stopped flag so other driver functions stop touching 	 * the hardware 	 */
name|hw
operator|->
name|adapter_stopped
operator|=
name|TRUE
expr_stmt|;
comment|/* Disable the receive unit by stopped each queue */
name|number_of_queues
operator|=
name|hw
operator|->
name|mac
operator|.
name|max_rx_queues
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|number_of_queues
condition|;
name|i
operator|++
control|)
block|{
name|reg_val
operator|=
name|IXGBE_VFREAD_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRXDCTL
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg_val
operator|&
name|IXGBE_RXDCTL_ENABLE
condition|)
block|{
name|reg_val
operator|&=
operator|~
name|IXGBE_RXDCTL_ENABLE
expr_stmt|;
name|IXGBE_VFWRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFRXDCTL
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
block|}
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Clear interrupt mask to stop from interrupts being generated */
name|IXGBE_VFWRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VTEIMC
argument_list|,
name|IXGBE_VF_IRQ_CLEAR_MASK
argument_list|)
expr_stmt|;
comment|/* Clear any pending interrupts */
name|IXGBE_VFREAD_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VTEICR
argument_list|)
expr_stmt|;
comment|/* Disable the transmit unit.  Each queue must be disabled. */
name|number_of_queues
operator|=
name|hw
operator|->
name|mac
operator|.
name|max_tx_queues
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|number_of_queues
condition|;
name|i
operator|++
control|)
block|{
name|reg_val
operator|=
name|IXGBE_VFREAD_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTXDCTL
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg_val
operator|&
name|IXGBE_TXDCTL_ENABLE
condition|)
block|{
name|reg_val
operator|&=
operator|~
name|IXGBE_TXDCTL_ENABLE
expr_stmt|;
name|IXGBE_VFWRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTXDCTL
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_mta_vector - Determines bit-vector in multicast table to set  *  @hw: pointer to hardware structure  *  @mc_addr: the multicast address  *  *  Extracts the 12 bits, from a multicast address, to determine which  *  bit-vector to set in the multicast table. The hardware uses 12 bits, from  *  incoming rx multicast addresses, to determine the bit-vector to check in  *  the MTA. Which of the 4 combination, of 12-bits, the hardware uses is set  *  by the MO field of the MCSTCTRL. The MO field is set during initialization  *  to mc_filter_type.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_mta_vector
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
modifier|*
name|mc_addr
parameter_list|)
block|{
name|u32
name|vector
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|mc_filter_type
condition|)
block|{
case|case
literal|0
case|:
comment|/* use bits [47:36] of the address */
name|vector
operator|=
operator|(
operator|(
name|mc_addr
index|[
literal|4
index|]
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|mc_addr
index|[
literal|5
index|]
operator|)
operator|<<
literal|4
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* use bits [46:35] of the address */
name|vector
operator|=
operator|(
operator|(
name|mc_addr
index|[
literal|4
index|]
operator|>>
literal|3
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|mc_addr
index|[
literal|5
index|]
operator|)
operator|<<
literal|5
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* use bits [45:34] of the address */
name|vector
operator|=
operator|(
operator|(
name|mc_addr
index|[
literal|4
index|]
operator|>>
literal|2
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|mc_addr
index|[
literal|5
index|]
operator|)
operator|<<
literal|6
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* use bits [43:32] of the address */
name|vector
operator|=
operator|(
operator|(
name|mc_addr
index|[
literal|4
index|]
operator|)
operator||
operator|(
operator|(
operator|(
name|u16
operator|)
name|mc_addr
index|[
literal|5
index|]
operator|)
operator|<<
literal|8
operator|)
operator|)
expr_stmt|;
break|break;
default|default:
comment|/* Invalid mc_filter_type */
name|DEBUGOUT
argument_list|(
literal|"MC filter type param set incorrectly\n"
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* vector can only be 12-bits or boundary will be exceeded */
name|vector
operator|&=
literal|0xFFF
expr_stmt|;
return|return
name|vector
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_set_rar_vf - set device MAC address  *  @hw: pointer to hardware structure  *  @index: Receive address register to write  *  @addr: Address to put into receive address register  *  @vmdq: VMDq "set" or "pool" index  *  @enable_addr: set flag that address is active  **/
end_comment

begin_function
name|s32
name|ixgbe_set_rar_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|index
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|,
name|u32
name|vmdq
parameter_list|,
name|u32
name|enable_addr
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|u32
name|msgbuf
index|[
literal|3
index|]
decl_stmt|;
name|u8
modifier|*
name|msg_addr
init|=
operator|(
name|u8
operator|*
operator|)
operator|(
operator|&
name|msgbuf
index|[
literal|1
index|]
operator|)
decl_stmt|;
name|s32
name|ret_val
decl_stmt|;
name|UNREFERENCED_PARAMETER
argument_list|(
name|vmdq
argument_list|)
expr_stmt|;
name|UNREFERENCED_PARAMETER
argument_list|(
name|enable_addr
argument_list|)
expr_stmt|;
name|UNREFERENCED_PARAMETER
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|msgbuf
argument_list|,
literal|0
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_SET_MAC_ADDR
expr_stmt|;
name|memcpy
argument_list|(
name|msg_addr
argument_list|,
name|addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|ret_val
operator|=
name|mbx
operator|->
name|ops
operator|.
name|write_posted
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret_val
condition|)
name|ret_val
operator|=
name|mbx
operator|->
name|ops
operator|.
name|read_posted
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|&=
operator|~
name|IXGBE_VT_MSGTYPE_CTS
expr_stmt|;
comment|/* if nacked the address was rejected, use "perm_addr" */
if|if
condition|(
operator|!
name|ret_val
operator|&&
operator|(
name|msgbuf
index|[
literal|0
index|]
operator|==
operator|(
name|IXGBE_VF_SET_MAC_ADDR
operator||
name|IXGBE_VT_MSGTYPE_NACK
operator|)
operator|)
condition|)
name|ixgbe_get_mac_addr_vf
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|mac
operator|.
name|addr
argument_list|)
expr_stmt|;
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_update_mc_addr_list_vf - Update Multicast addresses  *  @hw: pointer to the HW structure  *  @mc_addr_list: array of multicast addresses to program  *  @mc_addr_count: number of multicast addresses to program  *  @next: caller supplied function to return next address in list  *  *  Updates the Multicast Table Array.  **/
end_comment

begin_function
name|s32
name|ixgbe_update_mc_addr_list_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
modifier|*
name|mc_addr_list
parameter_list|,
name|u32
name|mc_addr_count
parameter_list|,
name|ixgbe_mc_addr_itr
name|next
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|u32
name|msgbuf
index|[
name|IXGBE_VFMAILBOX_SIZE
index|]
decl_stmt|;
name|u16
modifier|*
name|vector_list
init|=
operator|(
name|u16
operator|*
operator|)
operator|&
name|msgbuf
index|[
literal|1
index|]
decl_stmt|;
name|u32
name|vector
decl_stmt|;
name|u32
name|cnt
decl_stmt|,
name|i
decl_stmt|;
name|u32
name|vmdq
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_update_mc_addr_list_vf"
argument_list|)
expr_stmt|;
comment|/* Each entry in the list uses 1 16 bit word.  We have 30 	 * 16 bit words available in our HW msg buffer (minus 1 for the 	 * msg type).  That's 30 hash values if we pack 'em right.  If 	 * there are more than 30 MC addresses to add then punt the 	 * extras for now and then add code to handle more than 30 later. 	 * It would be unusual for a server to request that many multi-cast 	 * addresses except for in large enterprise network environments. 	 */
name|DEBUGOUT1
argument_list|(
literal|"MC Addr Count = %d\n"
argument_list|,
name|mc_addr_count
argument_list|)
expr_stmt|;
name|cnt
operator|=
operator|(
name|mc_addr_count
operator|>
literal|30
operator|)
condition|?
literal|30
else|:
name|mc_addr_count
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_SET_MULTICAST
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator||=
name|cnt
operator|<<
name|IXGBE_VT_MSGINFO_SHIFT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|vector
operator|=
name|ixgbe_mta_vector
argument_list|(
name|hw
argument_list|,
name|next
argument_list|(
name|hw
argument_list|,
operator|&
name|mc_addr_list
argument_list|,
operator|&
name|vmdq
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGOUT1
argument_list|(
literal|"Hash value = 0x%03X\n"
argument_list|,
name|vector
argument_list|)
expr_stmt|;
name|vector_list
index|[
name|i
index|]
operator|=
operator|(
name|u16
operator|)
name|vector
expr_stmt|;
block|}
return|return
name|mbx
operator|->
name|ops
operator|.
name|write_posted
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
name|IXGBE_VFMAILBOX_SIZE
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_set_vfta_vf - Set/Unset vlan filter table address  *  @hw: pointer to the HW structure  *  @vlan: 12 bit VLAN ID  *  @vind: unused by VF drivers  *  @vlan_on: if TRUE then set bit, else clear bit  **/
end_comment

begin_function
name|s32
name|ixgbe_set_vfta_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|vlan
parameter_list|,
name|u32
name|vind
parameter_list|,
name|bool
name|vlan_on
parameter_list|)
block|{
name|struct
name|ixgbe_mbx_info
modifier|*
name|mbx
init|=
operator|&
name|hw
operator|->
name|mbx
decl_stmt|;
name|u32
name|msgbuf
index|[
literal|2
index|]
decl_stmt|;
name|UNREFERENCED_PARAMETER
argument_list|(
name|vind
argument_list|)
expr_stmt|;
name|msgbuf
index|[
literal|0
index|]
operator|=
name|IXGBE_VF_SET_VLAN
expr_stmt|;
name|msgbuf
index|[
literal|1
index|]
operator|=
name|vlan
expr_stmt|;
comment|/* Setting the 8 bit field MSG INFO to TRUE indicates "add" */
name|msgbuf
index|[
literal|0
index|]
operator||=
name|vlan_on
operator|<<
name|IXGBE_VT_MSGINFO_SHIFT
expr_stmt|;
return|return
operator|(
name|mbx
operator|->
name|ops
operator|.
name|write_posted
argument_list|(
name|hw
argument_list|,
name|msgbuf
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_num_of_tx_queues_vf - Get number of TX queues  *  @hw: pointer to hardware structure  *  *  Returns the number of transmit queues for the given adapter.  **/
end_comment

begin_function
name|u32
name|ixgbe_get_num_of_tx_queues_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|UNREFERENCED_PARAMETER
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|IXGBE_VF_MAX_TX_QUEUES
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_num_of_rx_queues_vf - Get number of RX queues  *  @hw: pointer to hardware structure  *  *  Returns the number of receive queues for the given adapter.  **/
end_comment

begin_function
name|u32
name|ixgbe_get_num_of_rx_queues_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|UNREFERENCED_PARAMETER
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|IXGBE_VF_MAX_RX_QUEUES
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_mac_addr_vf - Read device MAC address  *  @hw: pointer to the HW structure  **/
end_comment

begin_function
name|s32
name|ixgbe_get_mac_addr_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
modifier|*
name|mac_addr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_ETH_LENGTH_OF_ADDRESS
condition|;
name|i
operator|++
control|)
name|mac_addr
index|[
name|i
index|]
operator|=
name|hw
operator|->
name|mac
operator|.
name|perm_addr
index|[
name|i
index|]
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_mac_link_vf - Setup MAC link settings  *  @hw: pointer to hardware structure  *  @speed: new link speed  *  @autoneg: TRUE if autonegotiation enabled  *  @autoneg_wait_to_complete: TRUE when waiting for completion is needed  *  *  Set the link speed in the AUTOC register and restarts link.  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_mac_link_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
block|{
name|UNREFERENCED_PARAMETER
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|UNREFERENCED_PARAMETER
argument_list|(
name|speed
argument_list|)
expr_stmt|;
name|UNREFERENCED_PARAMETER
argument_list|(
name|autoneg
argument_list|)
expr_stmt|;
name|UNREFERENCED_PARAMETER
argument_list|(
name|autoneg_wait_to_complete
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_mac_link_vf - Get link/speed status  *  @hw: pointer to hardware structure  *  @speed: pointer to link speed  *  @link_up: TRUE is link is up, FALSE otherwise  *  @autoneg_wait_to_complete: TRUE when waiting for completion is needed  *  *  Reads the links register to determine if link is up and the current speed  **/
end_comment

begin_function
name|s32
name|ixgbe_check_mac_link_vf
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
block|{
name|u32
name|links_reg
decl_stmt|;
name|UNREFERENCED_PARAMETER
argument_list|(
name|autoneg_wait_to_complete
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|hw
operator|->
name|mbx
operator|.
name|ops
operator|.
name|check_for_rst
argument_list|(
name|hw
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
operator|*
name|speed
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|links_reg
operator|=
name|IXGBE_VFREAD_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFLINKS
argument_list|)
expr_stmt|;
if|if
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_UP
condition|)
operator|*
name|link_up
operator|=
name|TRUE
expr_stmt|;
else|else
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|links_reg
operator|&
name|IXGBE_LINKS_SPEED_10G_82599
operator|)
operator|==
name|IXGBE_LINKS_SPEED_10G_82599
condition|)
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
else|else
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

end_unit


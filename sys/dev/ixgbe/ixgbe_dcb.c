begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2001-2017, Intel Corporation   All rights reserved.    Redistribution and use in source and binary forms, with or without   modification, are permitted provided that the following conditions are met:     1. Redistributions of source code must retain the above copyright notice,       this list of conditions and the following disclaimer.     2. Redistributions in binary form must reproduce the above copyright       notice, this list of conditions and the following disclaimer in the       documentation and/or other materials provided with the distribution.     3. Neither the name of the Intel Corporation nor the names of its       contributors may be used to endorse or promote products derived from       this software without specific prior written permission.    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE   LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR   CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF   SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS   INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN   CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)   ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"ixgbe_type.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_dcb.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_dcb_82598.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_dcb_82599.h"
end_include

begin_comment
comment|/**  * ixgbe_dcb_calculate_tc_credits - This calculates the ieee traffic class  * credits from the configured bandwidth percentages. Credits  * are the smallest unit programmable into the underlying  * hardware. The IEEE 802.1Qaz specification do not use bandwidth  * groups so this is much simplified from the CEE case.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_calculate_tc_credits
parameter_list|(
name|u8
modifier|*
name|bw
parameter_list|,
name|u16
modifier|*
name|refill
parameter_list|,
name|u16
modifier|*
name|max
parameter_list|,
name|int
name|max_frame_size
parameter_list|)
block|{
name|int
name|min_percent
init|=
literal|100
decl_stmt|;
name|int
name|min_credit
decl_stmt|,
name|multiplier
decl_stmt|;
name|int
name|i
decl_stmt|;
name|min_credit
operator|=
operator|(
operator|(
name|max_frame_size
operator|/
literal|2
operator|)
operator|+
name|IXGBE_DCB_CREDIT_QUANTUM
operator|-
literal|1
operator|)
operator|/
name|IXGBE_DCB_CREDIT_QUANTUM
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bw
index|[
name|i
index|]
operator|<
name|min_percent
operator|&&
name|bw
index|[
name|i
index|]
condition|)
name|min_percent
operator|=
name|bw
index|[
name|i
index|]
expr_stmt|;
block|}
name|multiplier
operator|=
operator|(
name|min_credit
operator|/
name|min_percent
operator|)
operator|+
literal|1
expr_stmt|;
comment|/* Find out the hw credits for each TC */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|i
operator|++
control|)
block|{
name|int
name|val
init|=
name|min
argument_list|(
name|bw
index|[
name|i
index|]
operator|*
name|multiplier
argument_list|,
name|IXGBE_DCB_MAX_CREDIT_REFILL
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|<
name|min_credit
condition|)
name|val
operator|=
name|min_credit
expr_stmt|;
name|refill
index|[
name|i
index|]
operator|=
operator|(
name|u16
operator|)
name|val
expr_stmt|;
name|max
index|[
name|i
index|]
operator|=
name|bw
index|[
name|i
index|]
condition|?
operator|(
name|bw
index|[
name|i
index|]
operator|*
name|IXGBE_DCB_MAX_CREDIT
operator|)
operator|/
literal|100
else|:
name|min_credit
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_calculate_tc_credits_cee - Calculates traffic class credits  * @ixgbe_dcb_config: Struct containing DCB settings.  * @direction: Configuring either Tx or Rx.  *  * This function calculates the credits allocated to each traffic class.  * It should be called only after the rules are checked by  * ixgbe_dcb_check_config_cee().  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_calculate_tc_credits_cee
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_dcb_config
modifier|*
name|dcb_config
parameter_list|,
name|u32
name|max_frame_size
parameter_list|,
name|u8
name|direction
parameter_list|)
block|{
name|struct
name|ixgbe_dcb_tc_path
modifier|*
name|p
decl_stmt|;
name|u32
name|min_multiplier
init|=
literal|0
decl_stmt|;
name|u16
name|min_percent
init|=
literal|100
decl_stmt|;
name|s32
name|ret_val
init|=
name|IXGBE_SUCCESS
decl_stmt|;
comment|/* Initialization values default for Tx settings */
name|u32
name|min_credit
init|=
literal|0
decl_stmt|;
name|u32
name|credit_refill
init|=
literal|0
decl_stmt|;
name|u32
name|credit_max
init|=
literal|0
decl_stmt|;
name|u16
name|link_percentage
init|=
literal|0
decl_stmt|;
name|u8
name|bw_percent
init|=
literal|0
decl_stmt|;
name|u8
name|i
decl_stmt|;
if|if
condition|(
name|dcb_config
operator|==
name|NULL
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_ERR_CONFIG
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|min_credit
operator|=
operator|(
operator|(
name|max_frame_size
operator|/
literal|2
operator|)
operator|+
name|IXGBE_DCB_CREDIT_QUANTUM
operator|-
literal|1
operator|)
operator|/
name|IXGBE_DCB_CREDIT_QUANTUM
expr_stmt|;
comment|/* Find smallest link percentage */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
operator|&
name|dcb_config
operator|->
name|tc_config
index|[
name|i
index|]
operator|.
name|path
index|[
name|direction
index|]
expr_stmt|;
name|bw_percent
operator|=
name|dcb_config
operator|->
name|bw_percentage
index|[
name|direction
index|]
index|[
name|p
operator|->
name|bwg_id
index|]
expr_stmt|;
name|link_percentage
operator|=
name|p
operator|->
name|bwg_percent
expr_stmt|;
name|link_percentage
operator|=
operator|(
name|link_percentage
operator|*
name|bw_percent
operator|)
operator|/
literal|100
expr_stmt|;
if|if
condition|(
name|link_percentage
operator|&&
name|link_percentage
operator|<
name|min_percent
condition|)
name|min_percent
operator|=
name|link_percentage
expr_stmt|;
block|}
comment|/* 	 * The ratio between traffic classes will control the bandwidth 	 * percentages seen on the wire. To calculate this ratio we use 	 * a multiplier. It is required that the refill credits must be 	 * larger than the max frame size so here we find the smallest 	 * multiplier that will allow all bandwidth percentages to be 	 * greater than the max frame size. 	 */
name|min_multiplier
operator|=
operator|(
name|min_credit
operator|/
name|min_percent
operator|)
operator|+
literal|1
expr_stmt|;
comment|/* Find out the link percentage for each TC first */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
operator|&
name|dcb_config
operator|->
name|tc_config
index|[
name|i
index|]
operator|.
name|path
index|[
name|direction
index|]
expr_stmt|;
name|bw_percent
operator|=
name|dcb_config
operator|->
name|bw_percentage
index|[
name|direction
index|]
index|[
name|p
operator|->
name|bwg_id
index|]
expr_stmt|;
name|link_percentage
operator|=
name|p
operator|->
name|bwg_percent
expr_stmt|;
comment|/* Must be careful of integer division for very small nums */
name|link_percentage
operator|=
operator|(
name|link_percentage
operator|*
name|bw_percent
operator|)
operator|/
literal|100
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|bwg_percent
operator|>
literal|0
operator|&&
name|link_percentage
operator|==
literal|0
condition|)
name|link_percentage
operator|=
literal|1
expr_stmt|;
comment|/* Save link_percentage for reference */
name|p
operator|->
name|link_percent
operator|=
operator|(
name|u8
operator|)
name|link_percentage
expr_stmt|;
comment|/* Calculate credit refill ratio using multiplier */
name|credit_refill
operator|=
name|min
argument_list|(
name|link_percentage
operator|*
name|min_multiplier
argument_list|,
operator|(
name|u32
operator|)
name|IXGBE_DCB_MAX_CREDIT_REFILL
argument_list|)
expr_stmt|;
comment|/* Refill at least minimum credit */
if|if
condition|(
name|credit_refill
operator|<
name|min_credit
condition|)
name|credit_refill
operator|=
name|min_credit
expr_stmt|;
name|p
operator|->
name|data_credits_refill
operator|=
operator|(
name|u16
operator|)
name|credit_refill
expr_stmt|;
comment|/* Calculate maximum credit for the TC */
name|credit_max
operator|=
operator|(
name|link_percentage
operator|*
name|IXGBE_DCB_MAX_CREDIT
operator|)
operator|/
literal|100
expr_stmt|;
comment|/* 		 * Adjustment based on rule checking, if the percentage 		 * of a TC is too small, the maximum credit may not be 		 * enough to send out a jumbo frame in data plane arbitration. 		 */
if|if
condition|(
name|credit_max
operator|<
name|min_credit
condition|)
name|credit_max
operator|=
name|min_credit
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|IXGBE_DCB_TX_CONFIG
condition|)
block|{
comment|/* 			 * Adjustment based on rule checking, if the 			 * percentage of a TC is too small, the maximum 			 * credit may not be enough to send out a TSO 			 * packet in descriptor plane arbitration. 			 */
if|if
condition|(
name|credit_max
operator|&&
operator|(
name|credit_max
operator|<
name|IXGBE_DCB_MIN_TSO_CREDIT
operator|)
operator|&&
operator|(
name|hw
operator|->
name|mac
operator|.
name|type
operator|==
name|ixgbe_mac_82598EB
operator|)
condition|)
name|credit_max
operator|=
name|IXGBE_DCB_MIN_TSO_CREDIT
expr_stmt|;
name|dcb_config
operator|->
name|tc_config
index|[
name|i
index|]
operator|.
name|desc_credits_max
operator|=
operator|(
name|u16
operator|)
name|credit_max
expr_stmt|;
block|}
name|p
operator|->
name|data_credits_max
operator|=
operator|(
name|u16
operator|)
name|credit_max
expr_stmt|;
block|}
name|out
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_unpack_pfc_cee - Unpack dcb_config PFC info  * @cfg: dcb configuration to unpack into hardware consumable fields  * @map: user priority to traffic class map  * @pfc_up: u8 to store user priority PFC bitmask  *  * This unpacks the dcb configuration PFC info which is stored per  * traffic class into a 8bit user priority bitmask that can be  * consumed by hardware routines. The priority to tc map must be  * updated before calling this routine to use current up-to maps.  */
end_comment

begin_function
name|void
name|ixgbe_dcb_unpack_pfc_cee
parameter_list|(
name|struct
name|ixgbe_dcb_config
modifier|*
name|cfg
parameter_list|,
name|u8
modifier|*
name|map
parameter_list|,
name|u8
modifier|*
name|pfc_up
parameter_list|)
block|{
name|struct
name|ixgbe_dcb_tc_config
modifier|*
name|tc_config
init|=
operator|&
name|cfg
operator|->
name|tc_config
index|[
literal|0
index|]
decl_stmt|;
name|int
name|up
decl_stmt|;
comment|/* 	 * If the TC for this user priority has PFC enabled then set the 	 * matching bit in 'pfc_up' to reflect that PFC is enabled. 	 */
for|for
control|(
operator|*
name|pfc_up
operator|=
literal|0
operator|,
name|up
operator|=
literal|0
init|;
name|up
operator|<
name|IXGBE_DCB_MAX_USER_PRIORITY
condition|;
name|up
operator|++
control|)
block|{
if|if
condition|(
name|tc_config
index|[
name|map
index|[
name|up
index|]
index|]
operator|.
name|pfc
operator|!=
name|ixgbe_dcb_pfc_disabled
condition|)
operator|*
name|pfc_up
operator||=
literal|1
operator|<<
name|up
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ixgbe_dcb_unpack_refill_cee
parameter_list|(
name|struct
name|ixgbe_dcb_config
modifier|*
name|cfg
parameter_list|,
name|int
name|direction
parameter_list|,
name|u16
modifier|*
name|refill
parameter_list|)
block|{
name|struct
name|ixgbe_dcb_tc_config
modifier|*
name|tc_config
init|=
operator|&
name|cfg
operator|->
name|tc_config
index|[
literal|0
index|]
decl_stmt|;
name|int
name|tc
decl_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|tc
operator|++
control|)
name|refill
index|[
name|tc
index|]
operator|=
name|tc_config
index|[
name|tc
index|]
operator|.
name|path
index|[
name|direction
index|]
operator|.
name|data_credits_refill
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ixgbe_dcb_unpack_max_cee
parameter_list|(
name|struct
name|ixgbe_dcb_config
modifier|*
name|cfg
parameter_list|,
name|u16
modifier|*
name|max
parameter_list|)
block|{
name|struct
name|ixgbe_dcb_tc_config
modifier|*
name|tc_config
init|=
operator|&
name|cfg
operator|->
name|tc_config
index|[
literal|0
index|]
decl_stmt|;
name|int
name|tc
decl_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|tc
operator|++
control|)
name|max
index|[
name|tc
index|]
operator|=
name|tc_config
index|[
name|tc
index|]
operator|.
name|desc_credits_max
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ixgbe_dcb_unpack_bwgid_cee
parameter_list|(
name|struct
name|ixgbe_dcb_config
modifier|*
name|cfg
parameter_list|,
name|int
name|direction
parameter_list|,
name|u8
modifier|*
name|bwgid
parameter_list|)
block|{
name|struct
name|ixgbe_dcb_tc_config
modifier|*
name|tc_config
init|=
operator|&
name|cfg
operator|->
name|tc_config
index|[
literal|0
index|]
decl_stmt|;
name|int
name|tc
decl_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|tc
operator|++
control|)
name|bwgid
index|[
name|tc
index|]
operator|=
name|tc_config
index|[
name|tc
index|]
operator|.
name|path
index|[
name|direction
index|]
operator|.
name|bwg_id
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ixgbe_dcb_unpack_tsa_cee
parameter_list|(
name|struct
name|ixgbe_dcb_config
modifier|*
name|cfg
parameter_list|,
name|int
name|direction
parameter_list|,
name|u8
modifier|*
name|tsa
parameter_list|)
block|{
name|struct
name|ixgbe_dcb_tc_config
modifier|*
name|tc_config
init|=
operator|&
name|cfg
operator|->
name|tc_config
index|[
literal|0
index|]
decl_stmt|;
name|int
name|tc
decl_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|tc
operator|++
control|)
name|tsa
index|[
name|tc
index|]
operator|=
name|tc_config
index|[
name|tc
index|]
operator|.
name|path
index|[
name|direction
index|]
operator|.
name|tsa
expr_stmt|;
block|}
end_function

begin_function
name|u8
name|ixgbe_dcb_get_tc_from_up
parameter_list|(
name|struct
name|ixgbe_dcb_config
modifier|*
name|cfg
parameter_list|,
name|int
name|direction
parameter_list|,
name|u8
name|up
parameter_list|)
block|{
name|struct
name|ixgbe_dcb_tc_config
modifier|*
name|tc_config
init|=
operator|&
name|cfg
operator|->
name|tc_config
index|[
literal|0
index|]
decl_stmt|;
name|u8
name|prio_mask
init|=
literal|1
operator|<<
name|up
decl_stmt|;
name|u8
name|tc
init|=
name|cfg
operator|->
name|num_tcs
operator|.
name|pg_tcs
decl_stmt|;
comment|/* If tc is 0 then DCB is likely not enabled or supported */
if|if
condition|(
operator|!
name|tc
condition|)
goto|goto
name|out
goto|;
comment|/* 	 * Test from maximum TC to 1 and report the first match we find.  If 	 * we find no match we can assume that the TC is 0 since the TC must 	 * be set for all user priorities 	 */
for|for
control|(
name|tc
operator|--
init|;
name|tc
condition|;
name|tc
operator|--
control|)
block|{
if|if
condition|(
name|prio_mask
operator|&
name|tc_config
index|[
name|tc
index|]
operator|.
name|path
index|[
name|direction
index|]
operator|.
name|up_to_tc_bitmap
condition|)
break|break;
block|}
name|out
label|:
return|return
name|tc
return|;
block|}
end_function

begin_function
name|void
name|ixgbe_dcb_unpack_map_cee
parameter_list|(
name|struct
name|ixgbe_dcb_config
modifier|*
name|cfg
parameter_list|,
name|int
name|direction
parameter_list|,
name|u8
modifier|*
name|map
parameter_list|)
block|{
name|u8
name|up
decl_stmt|;
for|for
control|(
name|up
operator|=
literal|0
init|;
name|up
operator|<
name|IXGBE_DCB_MAX_USER_PRIORITY
condition|;
name|up
operator|++
control|)
name|map
index|[
name|up
index|]
operator|=
name|ixgbe_dcb_get_tc_from_up
argument_list|(
name|cfg
argument_list|,
name|direction
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config - Struct containing DCB settings.  * @dcb_config: Pointer to DCB config structure  *  * This function checks DCB rules for DCB settings.  * The following rules are checked:  * 1. The sum of bandwidth percentages of all Bandwidth Groups must total 100%.  * 2. The sum of bandwidth percentages of all Traffic Classes within a Bandwidth  *    Group must total 100.  * 3. A Traffic Class should not be set to both Link Strict Priority  *    and Group Strict Priority.  * 4. Link strict Bandwidth Groups can only have link strict traffic classes  *    with zero bandwidth.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_check_config_cee
parameter_list|(
name|struct
name|ixgbe_dcb_config
modifier|*
name|dcb_config
parameter_list|)
block|{
name|struct
name|ixgbe_dcb_tc_path
modifier|*
name|p
decl_stmt|;
name|s32
name|ret_val
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u8
name|i
decl_stmt|,
name|j
decl_stmt|,
name|bw
init|=
literal|0
decl_stmt|,
name|bw_id
decl_stmt|;
name|u8
name|bw_sum
index|[
literal|2
index|]
index|[
name|IXGBE_DCB_MAX_BW_GROUP
index|]
decl_stmt|;
name|bool
name|link_strict
index|[
literal|2
index|]
index|[
name|IXGBE_DCB_MAX_BW_GROUP
index|]
decl_stmt|;
name|memset
argument_list|(
name|bw_sum
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bw_sum
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|link_strict
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|link_strict
argument_list|)
argument_list|)
expr_stmt|;
comment|/* First Tx, then Rx */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
comment|/* Check each traffic class for rule violation */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
condition|;
name|j
operator|++
control|)
block|{
name|p
operator|=
operator|&
name|dcb_config
operator|->
name|tc_config
index|[
name|j
index|]
operator|.
name|path
index|[
name|i
index|]
expr_stmt|;
name|bw
operator|=
name|p
operator|->
name|bwg_percent
expr_stmt|;
name|bw_id
operator|=
name|p
operator|->
name|bwg_id
expr_stmt|;
if|if
condition|(
name|bw_id
operator|>=
name|IXGBE_DCB_MAX_BW_GROUP
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_ERR_CONFIG
expr_stmt|;
goto|goto
name|err_config
goto|;
block|}
if|if
condition|(
name|p
operator|->
name|tsa
operator|==
name|ixgbe_dcb_tsa_strict
condition|)
block|{
name|link_strict
index|[
name|i
index|]
index|[
name|bw_id
index|]
operator|=
name|TRUE
expr_stmt|;
comment|/* Link strict should have zero bandwidth */
if|if
condition|(
name|bw
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_ERR_CONFIG
expr_stmt|;
goto|goto
name|err_config
goto|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|bw
condition|)
block|{
comment|/* 				 * Traffic classes without link strict 				 * should have non-zero bandwidth. 				 */
name|ret_val
operator|=
name|IXGBE_ERR_CONFIG
expr_stmt|;
goto|goto
name|err_config
goto|;
block|}
name|bw_sum
index|[
name|i
index|]
index|[
name|bw_id
index|]
operator|+=
name|bw
expr_stmt|;
block|}
name|bw
operator|=
literal|0
expr_stmt|;
comment|/* Check each bandwidth group for rule violation */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|IXGBE_DCB_MAX_BW_GROUP
condition|;
name|j
operator|++
control|)
block|{
name|bw
operator|+=
name|dcb_config
operator|->
name|bw_percentage
index|[
name|i
index|]
index|[
name|j
index|]
expr_stmt|;
comment|/* 			 * Sum of bandwidth percentages of all traffic classes 			 * within a Bandwidth Group must total 100 except for 			 * link strict group (zero bandwidth). 			 */
if|if
condition|(
name|link_strict
index|[
name|i
index|]
index|[
name|j
index|]
condition|)
block|{
if|if
condition|(
name|bw_sum
index|[
name|i
index|]
index|[
name|j
index|]
condition|)
block|{
comment|/* 					 * Link strict group should have zero 					 * bandwidth. 					 */
name|ret_val
operator|=
name|IXGBE_ERR_CONFIG
expr_stmt|;
goto|goto
name|err_config
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|bw_sum
index|[
name|i
index|]
index|[
name|j
index|]
operator|!=
name|IXGBE_DCB_BW_PERCENT
operator|&&
name|bw_sum
index|[
name|i
index|]
index|[
name|j
index|]
operator|!=
literal|0
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_ERR_CONFIG
expr_stmt|;
goto|goto
name|err_config
goto|;
block|}
block|}
if|if
condition|(
name|bw
operator|!=
name|IXGBE_DCB_BW_PERCENT
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_ERR_CONFIG
expr_stmt|;
goto|goto
name|err_config
goto|;
block|}
block|}
name|err_config
label|:
name|DEBUGOUT2
argument_list|(
literal|"DCB error code %d while checking %s settings.\n"
argument_list|,
name|ret_val
argument_list|,
operator|(
name|i
operator|==
name|IXGBE_DCB_TX_CONFIG
operator|)
condition|?
literal|"Tx"
else|:
literal|"Rx"
argument_list|)
expr_stmt|;
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_get_tc_stats - Returns status of each traffic class  * @hw: pointer to hardware structure  * @stats: pointer to statistics structure  * @tc_count:  Number of elements in bwg_array.  *  * This function returns the status data for each of the Traffic Classes in use.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_get_tc_stats
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_hw_stats
modifier|*
name|stats
parameter_list|,
name|u8
name|tc_count
parameter_list|)
block|{
name|s32
name|ret
init|=
name|IXGBE_NOT_IMPLEMENTED
decl_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82598EB
case|:
name|ret
operator|=
name|ixgbe_dcb_get_tc_stats_82598
argument_list|(
name|hw
argument_list|,
name|stats
argument_list|,
name|tc_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_82599EB
case|:
case|case
name|ixgbe_mac_X540
case|:
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_82599_SUPPORT
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|NO_X540_SUPPORT
argument_list|)
name|ret
operator|=
name|ixgbe_dcb_get_tc_stats_82599
argument_list|(
name|hw
argument_list|,
name|stats
argument_list|,
name|tc_count
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_get_pfc_stats - Returns CBFC status of each traffic class  * @hw: pointer to hardware structure  * @stats: pointer to statistics structure  * @tc_count:  Number of elements in bwg_array.  *  * This function returns the CBFC status data for each of the Traffic Classes.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_get_pfc_stats
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_hw_stats
modifier|*
name|stats
parameter_list|,
name|u8
name|tc_count
parameter_list|)
block|{
name|s32
name|ret
init|=
name|IXGBE_NOT_IMPLEMENTED
decl_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82598EB
case|:
name|ret
operator|=
name|ixgbe_dcb_get_pfc_stats_82598
argument_list|(
name|hw
argument_list|,
name|stats
argument_list|,
name|tc_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_82599EB
case|:
case|case
name|ixgbe_mac_X540
case|:
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_82599_SUPPORT
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|NO_X540_SUPPORT
argument_list|)
name|ret
operator|=
name|ixgbe_dcb_get_pfc_stats_82599
argument_list|(
name|hw
argument_list|,
name|stats
argument_list|,
name|tc_count
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_rx_arbiter_cee - Config Rx arbiter  * @hw: pointer to hardware structure  * @dcb_config: pointer to ixgbe_dcb_config structure  *  * Configure Rx Data Arbiter and credits for each traffic class.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_rx_arbiter_cee
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_dcb_config
modifier|*
name|dcb_config
parameter_list|)
block|{
name|s32
name|ret
init|=
name|IXGBE_NOT_IMPLEMENTED
decl_stmt|;
name|u8
name|tsa
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|u8
name|bwgid
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|u8
name|map
index|[
name|IXGBE_DCB_MAX_USER_PRIORITY
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|u16
name|refill
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|u16
name|max
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ixgbe_dcb_unpack_refill_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|refill
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_max_cee
argument_list|(
name|dcb_config
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_bwgid_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|bwgid
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_tsa_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_map_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|map
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82598EB
case|:
name|ret
operator|=
name|ixgbe_dcb_config_rx_arbiter_82598
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_82599EB
case|:
case|case
name|ixgbe_mac_X540
case|:
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_82599_SUPPORT
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|NO_X540_SUPPORT
argument_list|)
name|ret
operator|=
name|ixgbe_dcb_config_rx_arbiter_82599
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwgid
argument_list|,
name|tsa
argument_list|,
name|map
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_tx_desc_arbiter_cee - Config Tx Desc arbiter  * @hw: pointer to hardware structure  * @dcb_config: pointer to ixgbe_dcb_config structure  *  * Configure Tx Descriptor Arbiter and credits for each traffic class.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_tx_desc_arbiter_cee
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_dcb_config
modifier|*
name|dcb_config
parameter_list|)
block|{
name|s32
name|ret
init|=
name|IXGBE_NOT_IMPLEMENTED
decl_stmt|;
name|u8
name|tsa
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|u8
name|bwgid
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|u16
name|refill
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|u16
name|max
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|ixgbe_dcb_unpack_refill_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|refill
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_max_cee
argument_list|(
name|dcb_config
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_bwgid_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|bwgid
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_tsa_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82598EB
case|:
name|ret
operator|=
name|ixgbe_dcb_config_tx_desc_arbiter_82598
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwgid
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_82599EB
case|:
case|case
name|ixgbe_mac_X540
case|:
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_82599_SUPPORT
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|NO_X540_SUPPORT
argument_list|)
name|ret
operator|=
name|ixgbe_dcb_config_tx_desc_arbiter_82599
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwgid
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_tx_data_arbiter_cee - Config Tx data arbiter  * @hw: pointer to hardware structure  * @dcb_config: pointer to ixgbe_dcb_config structure  *  * Configure Tx Data Arbiter and credits for each traffic class.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_tx_data_arbiter_cee
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_dcb_config
modifier|*
name|dcb_config
parameter_list|)
block|{
name|s32
name|ret
init|=
name|IXGBE_NOT_IMPLEMENTED
decl_stmt|;
name|u8
name|tsa
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|u8
name|bwgid
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|u8
name|map
index|[
name|IXGBE_DCB_MAX_USER_PRIORITY
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|u16
name|refill
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|u16
name|max
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|ixgbe_dcb_unpack_refill_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|refill
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_max_cee
argument_list|(
name|dcb_config
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_bwgid_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|bwgid
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_tsa_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_map_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|map
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82598EB
case|:
name|ret
operator|=
name|ixgbe_dcb_config_tx_data_arbiter_82598
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwgid
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_82599EB
case|:
case|case
name|ixgbe_mac_X540
case|:
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_82599_SUPPORT
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|NO_X540_SUPPORT
argument_list|)
name|ret
operator|=
name|ixgbe_dcb_config_tx_data_arbiter_82599
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwgid
argument_list|,
name|tsa
argument_list|,
name|map
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_pfc_cee - Config priority flow control  * @hw: pointer to hardware structure  * @dcb_config: pointer to ixgbe_dcb_config structure  *  * Configure Priority Flow Control for each traffic class.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_pfc_cee
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_dcb_config
modifier|*
name|dcb_config
parameter_list|)
block|{
name|s32
name|ret
init|=
name|IXGBE_NOT_IMPLEMENTED
decl_stmt|;
name|u8
name|pfc_en
decl_stmt|;
name|u8
name|map
index|[
name|IXGBE_DCB_MAX_USER_PRIORITY
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ixgbe_dcb_unpack_map_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_pfc_cee
argument_list|(
name|dcb_config
argument_list|,
name|map
argument_list|,
operator|&
name|pfc_en
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82598EB
case|:
name|ret
operator|=
name|ixgbe_dcb_config_pfc_82598
argument_list|(
name|hw
argument_list|,
name|pfc_en
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_82599EB
case|:
case|case
name|ixgbe_mac_X540
case|:
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_82599_SUPPORT
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|NO_X540_SUPPORT
argument_list|)
name|ret
operator|=
name|ixgbe_dcb_config_pfc_82599
argument_list|(
name|hw
argument_list|,
name|pfc_en
argument_list|,
name|map
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_config_tc_stats - Config traffic class statistics  * @hw: pointer to hardware structure  *  * Configure queue statistics registers, all queues belonging to same traffic  * class uses a single set of queue statistics counters.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_tc_stats
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|ret
init|=
name|IXGBE_NOT_IMPLEMENTED
decl_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82598EB
case|:
name|ret
operator|=
name|ixgbe_dcb_config_tc_stats_82598
argument_list|(
name|hw
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_82599EB
case|:
case|case
name|ixgbe_mac_X540
case|:
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_82599_SUPPORT
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|NO_X540_SUPPORT
argument_list|)
name|ret
operator|=
name|ixgbe_dcb_config_tc_stats_82599
argument_list|(
name|hw
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * ixgbe_dcb_hw_config_cee - Config and enable DCB  * @hw: pointer to hardware structure  * @dcb_config: pointer to ixgbe_dcb_config structure  *  * Configure dcb settings and enable dcb mode.  */
end_comment

begin_function
name|s32
name|ixgbe_dcb_hw_config_cee
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|struct
name|ixgbe_dcb_config
modifier|*
name|dcb_config
parameter_list|)
block|{
name|s32
name|ret
init|=
name|IXGBE_NOT_IMPLEMENTED
decl_stmt|;
name|u8
name|pfc_en
decl_stmt|;
name|u8
name|tsa
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|u8
name|bwgid
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|u8
name|map
index|[
name|IXGBE_DCB_MAX_USER_PRIORITY
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|u16
name|refill
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
name|u16
name|max
index|[
name|IXGBE_DCB_MAX_TRAFFIC_CLASS
index|]
decl_stmt|;
comment|/* Unpack CEE standard containers */
name|ixgbe_dcb_unpack_refill_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|refill
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_max_cee
argument_list|(
name|dcb_config
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_bwgid_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|bwgid
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_tsa_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
name|ixgbe_dcb_unpack_map_cee
argument_list|(
name|dcb_config
argument_list|,
name|IXGBE_DCB_TX_CONFIG
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|setup_rxpba
argument_list|(
name|hw
argument_list|,
name|dcb_config
operator|->
name|num_tcs
operator|.
name|pg_tcs
argument_list|,
literal|0
argument_list|,
name|dcb_config
operator|->
name|rx_pba_cfg
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82598EB
case|:
name|ret
operator|=
name|ixgbe_dcb_hw_config_82598
argument_list|(
name|hw
argument_list|,
name|dcb_config
operator|->
name|link_speed
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwgid
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_82599EB
case|:
case|case
name|ixgbe_mac_X540
case|:
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_82599_SUPPORT
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|NO_X540_SUPPORT
argument_list|)
name|ixgbe_dcb_config_82599
argument_list|(
name|hw
argument_list|,
name|dcb_config
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ixgbe_dcb_hw_config_82599
argument_list|(
name|hw
argument_list|,
name|dcb_config
operator|->
name|link_speed
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwgid
argument_list|,
name|tsa
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|ixgbe_dcb_config_tc_stats_82599
argument_list|(
name|hw
argument_list|,
name|dcb_config
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
if|if
condition|(
operator|!
name|ret
operator|&&
name|dcb_config
operator|->
name|pfc_mode_enable
condition|)
block|{
name|ixgbe_dcb_unpack_pfc_cee
argument_list|(
name|dcb_config
argument_list|,
name|map
argument_list|,
operator|&
name|pfc_en
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ixgbe_dcb_config_pfc
argument_list|(
name|hw
argument_list|,
name|pfc_en
argument_list|,
name|map
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Helper routines to abstract HW specifics from DCB netlink ops */
end_comment

begin_function
name|s32
name|ixgbe_dcb_config_pfc
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
name|pfc_en
parameter_list|,
name|u8
modifier|*
name|map
parameter_list|)
block|{
name|int
name|ret
init|=
name|IXGBE_ERR_PARAM
decl_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82598EB
case|:
name|ret
operator|=
name|ixgbe_dcb_config_pfc_82598
argument_list|(
name|hw
argument_list|,
name|pfc_en
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_82599EB
case|:
case|case
name|ixgbe_mac_X540
case|:
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_82599_SUPPORT
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|NO_X540_SUPPORT
argument_list|)
name|ret
operator|=
name|ixgbe_dcb_config_pfc_82599
argument_list|(
name|hw
argument_list|,
name|pfc_en
argument_list|,
name|map
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|s32
name|ixgbe_dcb_hw_config
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u16
modifier|*
name|refill
parameter_list|,
name|u16
modifier|*
name|max
parameter_list|,
name|u8
modifier|*
name|bwg_id
parameter_list|,
name|u8
modifier|*
name|tsa
parameter_list|,
name|u8
modifier|*
name|map
parameter_list|)
block|{
switch|switch
condition|(
name|hw
operator|->
name|mac
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_mac_82598EB
case|:
name|ixgbe_dcb_config_rx_arbiter_82598
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
name|ixgbe_dcb_config_tx_desc_arbiter_82598
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwg_id
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
name|ixgbe_dcb_config_tx_data_arbiter_82598
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwg_id
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
break|break;
case|case
name|ixgbe_mac_82599EB
case|:
case|case
name|ixgbe_mac_X540
case|:
case|case
name|ixgbe_mac_X550
case|:
case|case
name|ixgbe_mac_X550EM_x
case|:
case|case
name|ixgbe_mac_X550EM_a
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|NO_82599_SUPPORT
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|NO_X540_SUPPORT
argument_list|)
name|ixgbe_dcb_config_rx_arbiter_82599
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwg_id
argument_list|,
name|tsa
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|ixgbe_dcb_config_tx_desc_arbiter_82599
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwg_id
argument_list|,
name|tsa
argument_list|)
expr_stmt|;
name|ixgbe_dcb_config_tx_data_arbiter_82599
argument_list|(
name|hw
argument_list|,
name|refill
argument_list|,
name|max
argument_list|,
name|bwg_id
argument_list|,
name|tsa
argument_list|,
name|map
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


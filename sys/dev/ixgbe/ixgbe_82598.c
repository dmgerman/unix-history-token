begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************    Copyright (c) 2001-2008, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  ******************************************************************************/
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"ixgbe_type.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_api.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_common.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_phy.h"
end_include

begin_function_decl
name|s32
name|ixgbe_init_ops_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixgbe_get_link_capabilities_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|autoneg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_get_copper_link_capabilities_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|autoneg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|enum
name|ixgbe_media_type
name|ixgbe_get_media_type_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_setup_fc_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|s32
name|packetbuf_num
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_fc_enable_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|s32
name|packetbuf_num
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixgbe_setup_mac_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixgbe_check_mac_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|,
name|bool
name|link_up_wait_to_complete
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixgbe_setup_mac_link_speed_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixgbe_setup_copper_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixgbe_setup_copper_link_speed_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|NO_82598_A0_SUPPORT
end_ifndef

begin_function_decl
name|s32
name|ixgbe_reset_hw_rev_0_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|s32
name|ixgbe_reset_hw_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_set_vmdq_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|rar
parameter_list|,
name|u32
name|vmdq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixgbe_clear_vmdq_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|rar
parameter_list|,
name|u32
name|vmdq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_set_vfta_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|vlan
parameter_list|,
name|u32
name|vind
parameter_list|,
name|bool
name|vlan_on
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixgbe_clear_vfta_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixgbe_blink_led_stop_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|s32
name|ixgbe_blink_led_start_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_read_analog_reg8_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u8
modifier|*
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_write_analog_reg8_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u8
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_read_i2c_eeprom_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
name|byte_offset
parameter_list|,
name|u8
modifier|*
name|eeprom_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|u32
name|ixgbe_get_supported_physical_layer_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**  *  ixgbe_init_ops_82598 - Inits func ptrs and MAC type  *  @hw: pointer to hardware structure  *  *  Initialize the function pointers and assign the MAC type for 82598.  *  Does not touch the hardware.  **/
end_comment

begin_function
name|s32
name|ixgbe_init_ops_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|struct
name|ixgbe_mac_info
modifier|*
name|mac
init|=
operator|&
name|hw
operator|->
name|mac
decl_stmt|;
name|struct
name|ixgbe_phy_info
modifier|*
name|phy
init|=
operator|&
name|hw
operator|->
name|phy
decl_stmt|;
name|s32
name|ret_val
decl_stmt|;
name|u16
name|list_offset
decl_stmt|,
name|data_offset
decl_stmt|;
name|ret_val
operator|=
name|ixgbe_init_phy_ops_generic
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|ret_val
operator|=
name|ixgbe_init_ops_generic
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* MAC */
ifndef|#
directive|ifndef
name|NO_82598_A0_SUPPORT
if|if
condition|(
name|hw
operator|->
name|revision_id
operator|==
literal|0
condition|)
name|mac
operator|->
name|ops
operator|.
name|reset_hw
operator|=
operator|&
name|ixgbe_reset_hw_rev_0_82598
expr_stmt|;
else|else
name|mac
operator|->
name|ops
operator|.
name|reset_hw
operator|=
operator|&
name|ixgbe_reset_hw_82598
expr_stmt|;
else|#
directive|else
name|mac
operator|->
name|ops
operator|.
name|reset_hw
operator|=
operator|&
name|ixgbe_reset_hw_82598
expr_stmt|;
endif|#
directive|endif
name|mac
operator|->
name|ops
operator|.
name|get_media_type
operator|=
operator|&
name|ixgbe_get_media_type_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|get_supported_physical_layer
operator|=
operator|&
name|ixgbe_get_supported_physical_layer_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|read_analog_reg8
operator|=
operator|&
name|ixgbe_read_analog_reg8_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|write_analog_reg8
operator|=
operator|&
name|ixgbe_write_analog_reg8_82598
expr_stmt|;
comment|/* LEDs */
name|mac
operator|->
name|ops
operator|.
name|blink_led_start
operator|=
operator|&
name|ixgbe_blink_led_start_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|blink_led_stop
operator|=
operator|&
name|ixgbe_blink_led_stop_82598
expr_stmt|;
comment|/* RAR, Multicast, VLAN */
name|mac
operator|->
name|ops
operator|.
name|set_vmdq
operator|=
operator|&
name|ixgbe_set_vmdq_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|clear_vmdq
operator|=
operator|&
name|ixgbe_clear_vmdq_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|set_vfta
operator|=
operator|&
name|ixgbe_set_vfta_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|clear_vfta
operator|=
operator|&
name|ixgbe_clear_vfta_82598
expr_stmt|;
comment|/* Flow Control */
name|mac
operator|->
name|ops
operator|.
name|setup_fc
operator|=
operator|&
name|ixgbe_setup_fc_82598
expr_stmt|;
comment|/* Link */
name|mac
operator|->
name|ops
operator|.
name|check_link
operator|=
operator|&
name|ixgbe_check_mac_link_82598
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|ops
operator|.
name|get_media_type
argument_list|(
name|hw
argument_list|)
operator|==
name|ixgbe_media_type_copper
condition|)
block|{
name|mac
operator|->
name|ops
operator|.
name|setup_link
operator|=
operator|&
name|ixgbe_setup_copper_link_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|setup_link_speed
operator|=
operator|&
name|ixgbe_setup_copper_link_speed_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|get_link_capabilities
operator|=
operator|&
name|ixgbe_get_copper_link_capabilities_82598
expr_stmt|;
block|}
else|else
block|{
name|mac
operator|->
name|ops
operator|.
name|setup_link
operator|=
operator|&
name|ixgbe_setup_mac_link_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|setup_link_speed
operator|=
operator|&
name|ixgbe_setup_mac_link_speed_82598
expr_stmt|;
name|mac
operator|->
name|ops
operator|.
name|get_link_capabilities
operator|=
operator|&
name|ixgbe_get_link_capabilities_82598
expr_stmt|;
block|}
name|mac
operator|->
name|mcft_size
operator|=
literal|128
expr_stmt|;
name|mac
operator|->
name|vft_size
operator|=
literal|128
expr_stmt|;
name|mac
operator|->
name|num_rar_entries
operator|=
literal|16
expr_stmt|;
name|mac
operator|->
name|max_tx_queues
operator|=
literal|32
expr_stmt|;
name|mac
operator|->
name|max_rx_queues
operator|=
literal|64
expr_stmt|;
comment|/* SFP+ Module */
name|phy
operator|->
name|ops
operator|.
name|read_i2c_eeprom
operator|=
operator|&
name|ixgbe_read_i2c_eeprom_82598
expr_stmt|;
comment|/* Call PHY identify routine to get the phy type */
name|phy
operator|->
name|ops
operator|.
name|identify
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* PHY Init */
switch|switch
condition|(
name|hw
operator|->
name|phy
operator|.
name|type
condition|)
block|{
case|case
name|ixgbe_phy_tn
case|:
name|phy
operator|->
name|ops
operator|.
name|check_link
operator|=
operator|&
name|ixgbe_check_phy_link_tnx
expr_stmt|;
name|phy
operator|->
name|ops
operator|.
name|get_firmware_version
operator|=
operator|&
name|ixgbe_get_phy_firmware_version_tnx
expr_stmt|;
break|break;
case|case
name|ixgbe_phy_nl
case|:
name|phy
operator|->
name|ops
operator|.
name|reset
operator|=
operator|&
name|ixgbe_reset_phy_nl
expr_stmt|;
comment|/* Call SFP+ identify routine to get the SFP+ module type */
name|ret_val
operator|=
name|phy
operator|->
name|ops
operator|.
name|identify_sfp
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
operator|!=
name|IXGBE_SUCCESS
condition|)
goto|goto
name|out
goto|;
elseif|else
if|if
condition|(
name|hw
operator|->
name|phy
operator|.
name|sfp_type
operator|==
name|ixgbe_sfp_type_unknown
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_ERR_SFP_NOT_SUPPORTED
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Check to see if SFP+ module is supported */
name|ret_val
operator|=
name|ixgbe_get_sfp_init_sequence_offsets
argument_list|(
name|hw
argument_list|,
operator|&
name|list_offset
argument_list|,
operator|&
name|data_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
operator|!=
name|IXGBE_SUCCESS
condition|)
block|{
name|ret_val
operator|=
name|IXGBE_ERR_SFP_NOT_SUPPORTED
expr_stmt|;
goto|goto
name|out
goto|;
block|}
break|break;
default|default:
break|break;
block|}
name|out
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_link_capabilities_82598 - Determines link capabilities  *  @hw: pointer to hardware structure  *  @speed: pointer to link speed  *  @autoneg: boolean auto-negotiation value  *  *  Determines the link capabilities by reading the AUTOC register.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_get_link_capabilities_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|autoneg
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|s32
name|autoc_reg
decl_stmt|;
name|autoc_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
condition|)
block|{
name|autoc_reg
operator|&=
operator|~
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
expr_stmt|;
name|autoc_reg
operator|&=
operator|~
name|IXGBE_AUTOC_LMS_MASK
expr_stmt|;
name|autoc_reg
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
expr_stmt|;
name|autoc_reg
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
expr_stmt|;
block|}
switch|switch
condition|(
name|autoc_reg
operator|&
name|IXGBE_AUTOC_LMS_MASK
condition|)
block|{
case|case
name|IXGBE_AUTOC_LMS_1G_LINK_NO_AN
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
operator|*
name|autoneg
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
name|IXGBE_AUTOC_LMS_10G_LINK_NO_AN
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
operator|*
name|autoneg
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
name|IXGBE_AUTOC_LMS_1G_AN
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
operator|*
name|autoneg
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|IXGBE_AUTOC_LMS_KX4_AN
case|:
case|case
name|IXGBE_AUTOC_LMS_KX4_AN_1G_AN
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_UNKNOWN
expr_stmt|;
if|if
condition|(
name|autoc_reg
operator|&
name|IXGBE_AUTOC_KX4_SUPP
condition|)
operator|*
name|speed
operator||=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
if|if
condition|(
name|autoc_reg
operator|&
name|IXGBE_AUTOC_KX_SUPP
condition|)
operator|*
name|speed
operator||=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
operator|*
name|autoneg
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|IXGBE_ERR_LINK_SETUP
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_copper_link_capabilities_82598 - Determines link capabilities  *  @hw: pointer to hardware structure  *  @speed: pointer to link speed  *  @autoneg: boolean auto-negotiation value  *  *  Determines the link capabilities by reading the AUTOC register.  **/
end_comment

begin_function
name|s32
name|ixgbe_get_copper_link_capabilities_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|autoneg
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_ERR_LINK_SETUP
decl_stmt|;
name|u16
name|speed_ability
decl_stmt|;
operator|*
name|speed
operator|=
literal|0
expr_stmt|;
operator|*
name|autoneg
operator|=
name|TRUE
expr_stmt|;
name|status
operator|=
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|read_reg
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_PHY_SPEED_ABILITY
argument_list|,
name|IXGBE_MDIO_PMA_PMD_DEV_TYPE
argument_list|,
operator|&
name|speed_ability
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
block|{
if|if
condition|(
name|speed_ability
operator|&
name|IXGBE_MDIO_PHY_SPEED_10G
condition|)
operator|*
name|speed
operator||=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
if|if
condition|(
name|speed_ability
operator|&
name|IXGBE_MDIO_PHY_SPEED_1G
condition|)
operator|*
name|speed
operator||=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_media_type_82598 - Determines media type  *  @hw: pointer to hardware structure  *  *  Returns the media type (fiber, copper, backplane)  **/
end_comment

begin_function
specifier|static
name|enum
name|ixgbe_media_type
name|ixgbe_get_media_type_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|ixgbe_media_type
name|media_type
decl_stmt|;
comment|/* Media type for I82598 is based on device ID */
switch|switch
condition|(
name|hw
operator|->
name|device_id
condition|)
block|{
case|case
name|IXGBE_DEV_ID_82598
case|:
comment|/* Default device ID is mezzanine card KX/KX4 */
name|media_type
operator|=
name|ixgbe_media_type_backplane
expr_stmt|;
break|break;
case|case
name|IXGBE_DEV_ID_82598AF_DUAL_PORT
case|:
case|case
name|IXGBE_DEV_ID_82598AF_SINGLE_PORT
case|:
case|case
name|IXGBE_DEV_ID_82598EB_CX4
case|:
case|case
name|IXGBE_DEV_ID_82598_CX4_DUAL_PORT
case|:
case|case
name|IXGBE_DEV_ID_82598_DA_DUAL_PORT
case|:
case|case
name|IXGBE_DEV_ID_82598_SR_DUAL_PORT_EM
case|:
case|case
name|IXGBE_DEV_ID_82598EB_XF_LR
case|:
case|case
name|IXGBE_DEV_ID_82598EB_SFP_LOM
case|:
name|media_type
operator|=
name|ixgbe_media_type_fiber
expr_stmt|;
break|break;
case|case
name|IXGBE_DEV_ID_82598AT
case|:
name|media_type
operator|=
name|ixgbe_media_type_copper
expr_stmt|;
break|break;
default|default:
name|media_type
operator|=
name|ixgbe_media_type_unknown
expr_stmt|;
break|break;
block|}
return|return
name|media_type
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_fc_enable_82598 - Enable flow control  *  @hw: pointer to hardware structure  *  @packetbuf_num: packet buffer number (0-7)  *  *  Enable flow control according to the current settings.  **/
end_comment

begin_function
name|s32
name|ixgbe_fc_enable_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|s32
name|packetbuf_num
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u32
name|fctrl_reg
decl_stmt|;
name|u32
name|rmcs_reg
decl_stmt|;
name|u32
name|reg
decl_stmt|;
name|DEBUGFUNC
argument_list|(
literal|"ixgbe_fc_enable_82598"
argument_list|)
expr_stmt|;
name|fctrl_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCTRL
argument_list|)
expr_stmt|;
name|fctrl_reg
operator|&=
operator|~
operator|(
name|IXGBE_FCTRL_RFCE
operator||
name|IXGBE_FCTRL_RPFCE
operator|)
expr_stmt|;
name|rmcs_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RMCS
argument_list|)
expr_stmt|;
name|rmcs_reg
operator|&=
operator|~
operator|(
name|IXGBE_RMCS_TFCE_PRIORITY
operator||
name|IXGBE_RMCS_TFCE_802_3X
operator|)
expr_stmt|;
comment|/* 	 * The possible values of fc.current_mode are: 	 * 0: Flow control is completely disabled 	 * 1: Rx flow control is enabled (we can receive pause frames, 	 *    but not send pause frames). 	 * 2:  Tx flow control is enabled (we can send pause frames but 	 *     we do not support receiving pause frames). 	 * 3: Both Rx and Tx flow control (symmetric) are enabled. 	 * other: Invalid. 	 */
switch|switch
condition|(
name|hw
operator|->
name|fc
operator|.
name|current_mode
condition|)
block|{
case|case
name|ixgbe_fc_none
case|:
comment|/* Flow control completely disabled by software override. */
break|break;
case|case
name|ixgbe_fc_rx_pause
case|:
comment|/* 		 * Rx Flow control is enabled and Tx Flow control is 		 * disabled by software override. Since there really 		 * isn't a way to advertise that we are capable of RX 		 * Pause ONLY, we will advertise that we support both 		 * symmetric and asymmetric Rx PAUSE.  Later, we will 		 * disable the adapter's ability to send PAUSE frames. 		 */
name|fctrl_reg
operator||=
name|IXGBE_FCTRL_RFCE
expr_stmt|;
break|break;
case|case
name|ixgbe_fc_tx_pause
case|:
comment|/* 		 * Tx Flow control is enabled, and Rx Flow control is 		 * disabled by software override. 		 */
name|rmcs_reg
operator||=
name|IXGBE_RMCS_TFCE_802_3X
expr_stmt|;
break|break;
case|case
name|ixgbe_fc_full
case|:
comment|/* Flow control (both Rx and Tx) is enabled by SW override. */
name|fctrl_reg
operator||=
name|IXGBE_FCTRL_RFCE
expr_stmt|;
name|rmcs_reg
operator||=
name|IXGBE_RMCS_TFCE_802_3X
expr_stmt|;
break|break;
default|default:
name|DEBUGOUT
argument_list|(
literal|"Flow control param set incorrectly\n"
argument_list|)
expr_stmt|;
name|ret_val
operator|=
operator|-
name|IXGBE_ERR_CONFIG
expr_stmt|;
goto|goto
name|out
goto|;
break|break;
block|}
comment|/* Enable 802.3x based flow control settings. */
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCTRL
argument_list|,
name|fctrl_reg
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RMCS
argument_list|,
name|rmcs_reg
argument_list|)
expr_stmt|;
comment|/* Set up and enable Rx high/low water mark thresholds, enable XON. */
if|if
condition|(
name|hw
operator|->
name|fc
operator|.
name|current_mode
operator|&
name|ixgbe_fc_tx_pause
condition|)
block|{
if|if
condition|(
name|hw
operator|->
name|fc
operator|.
name|send_xon
condition|)
block|{
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCRTL
argument_list|(
name|packetbuf_num
argument_list|)
argument_list|,
operator|(
name|hw
operator|->
name|fc
operator|.
name|low_water
operator||
name|IXGBE_FCRTL_XONE
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCRTL
argument_list|(
name|packetbuf_num
argument_list|)
argument_list|,
name|hw
operator|->
name|fc
operator|.
name|low_water
argument_list|)
expr_stmt|;
block|}
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCRTH
argument_list|(
name|packetbuf_num
argument_list|)
argument_list|,
operator|(
name|hw
operator|->
name|fc
operator|.
name|high_water
operator||
name|IXGBE_FCRTH_FCEN
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Configure pause time (2 TCs per register) */
name|reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCTTV
argument_list|(
name|packetbuf_num
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|packetbuf_num
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|reg
operator|=
operator|(
name|reg
operator|&
literal|0xFFFF0000
operator|)
operator||
name|hw
operator|->
name|fc
operator|.
name|pause_time
expr_stmt|;
else|else
name|reg
operator|=
operator|(
name|reg
operator|&
literal|0x0000FFFF
operator|)
operator||
operator|(
name|hw
operator|->
name|fc
operator|.
name|pause_time
operator|<<
literal|16
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCTTV
argument_list|(
name|packetbuf_num
operator|/
literal|2
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_FCRTV
argument_list|,
operator|(
name|hw
operator|->
name|fc
operator|.
name|pause_time
operator|>>
literal|1
operator|)
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_fc_82598 - Set up flow control  *  @hw: pointer to hardware structure  *  *  Sets up flow control.  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_fc_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|s32
name|packetbuf_num
parameter_list|)
block|{
name|s32
name|ret_val
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|ixgbe_link_speed
name|speed
decl_stmt|;
name|bool
name|link_up
decl_stmt|;
comment|/* Validate the packetbuf configuration */
if|if
condition|(
name|packetbuf_num
operator|<
literal|0
operator|||
name|packetbuf_num
operator|>
literal|7
condition|)
block|{
name|DEBUGOUT1
argument_list|(
literal|"Invalid packet buffer number [%d], expected range is"
literal|" 0-7\n"
argument_list|,
name|packetbuf_num
argument_list|)
expr_stmt|;
name|ret_val
operator|=
name|IXGBE_ERR_INVALID_LINK_SETTINGS
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Validate the water mark configuration.  Zero water marks are invalid 	 * because it causes the controller to just blast out fc packets. 	 */
if|if
condition|(
operator|!
name|hw
operator|->
name|fc
operator|.
name|low_water
operator|||
operator|!
name|hw
operator|->
name|fc
operator|.
name|high_water
operator|||
operator|!
name|hw
operator|->
name|fc
operator|.
name|pause_time
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"Invalid water mark configuration\n"
argument_list|)
expr_stmt|;
name|ret_val
operator|=
name|IXGBE_ERR_INVALID_LINK_SETTINGS
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Validate the requested mode.  Strict IEEE mode does not allow 	 * ixgbe_fc_rx_pause because it will cause testing anomalies. 	 */
if|if
condition|(
name|hw
operator|->
name|fc
operator|.
name|strict_ieee
operator|&&
name|hw
operator|->
name|fc
operator|.
name|requested_mode
operator|==
name|ixgbe_fc_rx_pause
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"ixgbe_fc_rx_pause not valid in strict IEEE mode\n"
argument_list|)
expr_stmt|;
name|ret_val
operator|=
name|IXGBE_ERR_INVALID_LINK_SETTINGS
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * 10gig parts do not have a word in the EEPROM to determine the 	 * default flow control setting, so we explicitly set it to full. 	 */
if|if
condition|(
name|hw
operator|->
name|fc
operator|.
name|requested_mode
operator|==
name|ixgbe_fc_default
condition|)
name|hw
operator|->
name|fc
operator|.
name|requested_mode
operator|=
name|ixgbe_fc_full
expr_stmt|;
comment|/* 	 * Save off the requested flow control mode for use later.  Depending 	 * on the link partner's capabilities, we may or may not use this mode. 	 */
name|hw
operator|->
name|fc
operator|.
name|current_mode
operator|=
name|hw
operator|->
name|fc
operator|.
name|requested_mode
expr_stmt|;
comment|/* Decide whether to use autoneg or not. */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|check_link
argument_list|(
name|hw
argument_list|,
operator|&
name|speed
argument_list|,
operator|&
name|link_up
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|phy
operator|.
name|multispeed_fiber
operator|&&
operator|(
name|speed
operator|==
name|IXGBE_LINK_SPEED_1GB_FULL
operator|)
condition|)
name|ret_val
operator|=
name|ixgbe_fc_autoneg
argument_list|(
name|hw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_val
condition|)
goto|goto
name|out
goto|;
name|ret_val
operator|=
name|ixgbe_fc_enable_82598
argument_list|(
name|hw
argument_list|,
name|packetbuf_num
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret_val
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_mac_link_82598 - Configures MAC link settings  *  @hw: pointer to hardware structure  *  *  Configures link settings based on values in the ixgbe_hw struct.  *  Restarts the link.  Performs autonegotiation if needed.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_setup_mac_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|u32
name|autoc_reg
decl_stmt|;
name|u32
name|links_reg
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|autoc_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
condition|)
block|{
name|autoc_reg
operator|&=
operator|~
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
expr_stmt|;
name|autoc_reg
operator|&=
operator|~
name|IXGBE_AUTOC_LMS_MASK
expr_stmt|;
name|autoc_reg
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
expr_stmt|;
name|autoc_reg
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|,
name|autoc_reg
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|msec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
comment|/* Restart link */
name|autoc_reg
operator||=
name|IXGBE_AUTOC_AN_RESTART
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|,
name|autoc_reg
argument_list|)
expr_stmt|;
comment|/* Only poll for autoneg to complete if specified to do so */
if|if
condition|(
name|hw
operator|->
name|phy
operator|.
name|autoneg_wait_to_complete
condition|)
block|{
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|==
name|IXGBE_AUTOC_LMS_KX4_AN
operator|||
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|==
name|IXGBE_AUTOC_LMS_KX4_AN_1G_AN
condition|)
block|{
name|links_reg
operator|=
literal|0
expr_stmt|;
comment|/* Just in case Autoneg time = 0 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_AUTO_NEG_TIME
condition|;
name|i
operator|++
control|)
block|{
name|links_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_LINKS
argument_list|)
expr_stmt|;
if|if
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_KX_AN_COMP
condition|)
break|break;
name|msec_delay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|links_reg
operator|&
name|IXGBE_LINKS_KX_AN_COMP
operator|)
condition|)
block|{
name|status
operator|=
name|IXGBE_ERR_AUTONEG_NOT_COMPLETE
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Autonegotiation did not complete.\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Set up flow control */
name|status
operator|=
name|ixgbe_setup_fc_82598
argument_list|(
name|hw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Add delay to filter out noises during initial link setup */
name|msec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_mac_link_82598 - Get link/speed status  *  @hw: pointer to hardware structure  *  @speed: pointer to link speed  *  @link_up: TRUE is link is up, FALSE otherwise  *  @link_up_wait_to_complete: bool used to wait for link up or not  *  *  Reads the links register to determine if link is up and the current speed  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_check_mac_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|,
name|bool
name|link_up_wait_to_complete
parameter_list|)
block|{
name|u32
name|links_reg
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|u16
name|link_reg
decl_stmt|,
name|adapt_comp_reg
decl_stmt|;
comment|/* 	 * SERDES PHY requires us to read link status from undocumented 	 * register 0xC79F.  Bit 0 set indicates link is up/ready; clear 	 * indicates link down.  OxC00C is read to check that the XAUI lanes 	 * are active.  Bit 0 clear indicates active; set indicates inactive. 	 */
if|if
condition|(
name|hw
operator|->
name|phy
operator|.
name|type
operator|==
name|ixgbe_phy_nl
condition|)
block|{
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|read_reg
argument_list|(
name|hw
argument_list|,
literal|0xC79F
argument_list|,
name|IXGBE_TWINAX_DEV
argument_list|,
operator|&
name|link_reg
argument_list|)
expr_stmt|;
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|read_reg
argument_list|(
name|hw
argument_list|,
literal|0xC79F
argument_list|,
name|IXGBE_TWINAX_DEV
argument_list|,
operator|&
name|link_reg
argument_list|)
expr_stmt|;
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|read_reg
argument_list|(
name|hw
argument_list|,
literal|0xC00C
argument_list|,
name|IXGBE_TWINAX_DEV
argument_list|,
operator|&
name|adapt_comp_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|link_up_wait_to_complete
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_LINK_UP_TIME
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|link_reg
operator|&
literal|1
operator|)
operator|&&
operator|(
operator|(
name|adapt_comp_reg
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
operator|*
name|link_up
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
else|else
block|{
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
block|}
name|msec_delay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|read_reg
argument_list|(
name|hw
argument_list|,
literal|0xC79F
argument_list|,
name|IXGBE_TWINAX_DEV
argument_list|,
operator|&
name|link_reg
argument_list|)
expr_stmt|;
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|read_reg
argument_list|(
name|hw
argument_list|,
literal|0xC00C
argument_list|,
name|IXGBE_TWINAX_DEV
argument_list|,
operator|&
name|adapt_comp_reg
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|link_reg
operator|&
literal|1
operator|)
operator|&&
operator|(
operator|(
name|adapt_comp_reg
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
condition|)
operator|*
name|link_up
operator|=
name|TRUE
expr_stmt|;
else|else
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|link_up
operator|==
name|FALSE
condition|)
goto|goto
name|out
goto|;
block|}
name|links_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_LINKS
argument_list|)
expr_stmt|;
if|if
condition|(
name|link_up_wait_to_complete
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_LINK_UP_TIME
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_UP
condition|)
block|{
operator|*
name|link_up
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
else|else
block|{
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
block|}
name|msec_delay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|links_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_LINKS
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_UP
condition|)
operator|*
name|link_up
operator|=
name|TRUE
expr_stmt|;
else|else
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_SPEED
condition|)
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
else|else
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
name|out
label|:
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_mac_link_speed_82598 - Set MAC link speed  *  @hw: pointer to hardware structure  *  @speed: new link speed  *  @autoneg: TRUE if autonegotiation enabled  *  @autoneg_wait_to_complete: TRUE when waiting for completion is needed  *  *  Set the link speed in the AUTOC register and restarts link.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_setup_mac_link_speed_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
comment|/* If speed is 10G, then check for CX4 or XAUI. */
if|if
condition|(
operator|(
name|speed
operator|==
name|IXGBE_LINK_SPEED_10GB_FULL
operator|)
operator|&&
operator|(
operator|!
operator|(
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|&
name|IXGBE_AUTOC_10G_KX4
operator|)
operator|)
condition|)
block|{
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
name|IXGBE_AUTOC_LMS_10G_LINK_NO_AN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|speed
operator|==
name|IXGBE_LINK_SPEED_1GB_FULL
operator|)
operator|&&
operator|(
operator|!
name|autoneg
operator|)
condition|)
block|{
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
name|IXGBE_AUTOC_LMS_1G_LINK_NO_AN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|autoneg
condition|)
block|{
comment|/* BX mode - Autonegotiate 1G */
if|if
condition|(
operator|!
operator|(
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|&
name|IXGBE_AUTOC_1G_PMA_PMD
operator|)
condition|)
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
name|IXGBE_AUTOC_LMS_1G_AN
expr_stmt|;
else|else
comment|/* KX/KX4 mode */
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
name|IXGBE_AUTOC_LMS_KX4_AN_1G_AN
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|IXGBE_ERR_LINK_SETUP
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
block|{
name|hw
operator|->
name|phy
operator|.
name|autoneg_wait_to_complete
operator|=
name|autoneg_wait_to_complete
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
operator|=
name|TRUE
expr_stmt|;
comment|/* 		 * Setup and restart the link based on the new values in 		 * ixgbe_hw This will write the AUTOC register based on the new 		 * stored values 		 */
name|status
operator|=
name|ixgbe_setup_mac_link_82598
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_copper_link_82598 - Setup copper link settings  *  @hw: pointer to hardware structure  *  *  Configures link settings based on values in the ixgbe_hw struct.  *  Restarts the link.  Performs autonegotiation if needed.  Restart  *  phy and wait for autonegotiate to finish.  Then synchronize the  *  MAC and PHY.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_setup_copper_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|status
decl_stmt|;
comment|/* Restart autonegotiation on PHY */
name|status
operator|=
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|setup_link
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Set MAC to KX/KX4 autoneg, which defaults to Parallel detection */
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|=
operator|(
name|IXGBE_AUTOC_10G_KX4
operator||
name|IXGBE_AUTOC_1G_KX
operator|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
name|IXGBE_AUTOC_LMS_KX4_AN
expr_stmt|;
comment|/* Set up MAC */
name|ixgbe_setup_mac_link_82598
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_copper_link_speed_82598 - Set the PHY autoneg advertised field  *  @hw: pointer to hardware structure  *  @speed: new link speed  *  @autoneg: TRUE if autonegotiation enabled  *  @autoneg_wait_to_complete: TRUE if waiting is needed to complete  *  *  Sets the link speed in the AUTOC register in the MAC and restarts link.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_setup_copper_link_speed_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
block|{
name|s32
name|status
decl_stmt|;
comment|/* Setup the PHY according to input speed */
name|status
operator|=
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|setup_link_speed
argument_list|(
name|hw
argument_list|,
name|speed
argument_list|,
name|autoneg
argument_list|,
name|autoneg_wait_to_complete
argument_list|)
expr_stmt|;
comment|/* Set MAC to KX/KX4 autoneg, which defaults to Parallel detection */
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|=
operator|(
name|IXGBE_AUTOC_10G_KX4
operator||
name|IXGBE_AUTOC_1G_KX
operator|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
name|IXGBE_AUTOC_LMS_KX4_AN
expr_stmt|;
comment|/* Set up MAC */
name|ixgbe_setup_mac_link_82598
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NO_82598_A0_SUPPORT
end_ifndef

begin_comment
comment|/**  *  ixgbe_reset_hw_rev_0_82598 - Performs hardware reset  *  @hw: pointer to hardware structure  *  *  Resets the hardware by resetting the transmit and receive units, masks and  *  clears all interrupts, performing a PHY reset, and performing a link (MAC)  *  reset.  **/
end_comment

begin_function
name|s32
name|ixgbe_reset_hw_rev_0_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u32
name|ctrl
decl_stmt|;
name|u32
name|gheccr
decl_stmt|;
name|u32
name|autoc
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|u32
name|resets
decl_stmt|;
comment|/* Call adapter stop to disable tx/rx and clear interrupts */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|stop_adapter
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Reset PHY */
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|reset
argument_list|(
name|hw
argument_list|)
expr_stmt|;
for|for
control|(
name|resets
operator|=
literal|0
init|;
name|resets
operator|<
literal|10
condition|;
name|resets
operator|++
control|)
block|{
comment|/* 		 * Prevent the PCI-E bus from from hanging by disabling PCI-E 		 * master access and verify no pending requests before reset 		 */
if|if
condition|(
name|ixgbe_disable_pcie_master
argument_list|(
name|hw
argument_list|)
operator|!=
name|IXGBE_SUCCESS
condition|)
block|{
name|status
operator|=
name|IXGBE_ERR_MASTER_REQUESTS_PENDING
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"PCI-E Master disable polling has failed.\n"
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Issue global reset to the MAC.  This needs to be a SW reset. 		 * If link reset is used, it might reset the MAC when mng is 		 * using it. 		 */
name|ctrl
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|,
operator|(
name|ctrl
operator||
name|IXGBE_CTRL_RST
operator|)
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* 		 * Poll for reset bit to self-clear indicating reset is 		 * complete 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctrl
operator|&
name|IXGBE_CTRL_RST
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ctrl
operator|&
name|IXGBE_CTRL_RST
condition|)
block|{
name|status
operator|=
name|IXGBE_ERR_RESET_FAILED
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Reset polling failed to complete.\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|msec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|gheccr
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GHECCR
argument_list|)
expr_stmt|;
name|gheccr
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|21
operator|)
operator||
operator|(
literal|1
operator|<<
literal|18
operator|)
operator||
operator|(
literal|1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GHECCR
argument_list|,
name|gheccr
argument_list|)
expr_stmt|;
comment|/* 	 * AUTOC register which stores link settings gets cleared 	 * and reloaded from EEPROM after reset. We need to restore 	 * our stored value from init in case SW changed the attach 	 * type or speed.  If this is the first time and link settings 	 * have not been stored, store default settings from AUTOC. 	 */
name|autoc
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
condition|)
block|{
name|autoc
operator|&=
operator|~
operator|(
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
operator|)
expr_stmt|;
name|autoc
operator|&=
operator|~
operator|(
name|IXGBE_AUTOC_LMS_MASK
operator|)
expr_stmt|;
name|autoc
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
expr_stmt|;
name|autoc
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|,
name|autoc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|=
operator|(
name|autoc
operator|&
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
operator|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
operator|(
name|autoc
operator|&
name|IXGBE_AUTOC_LMS_MASK
operator|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* Store the permanent mac address */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_mac_addr
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|mac
operator|.
name|perm_addr
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NO_A0_SUPPORT */
end_comment

begin_comment
comment|/**  *  ixgbe_reset_hw_82598 - Performs hardware reset  *  @hw: pointer to hardware structure  *  *  Resets the hardware by resetting the transmit and receive units, masks and  *  clears all interrupts, performing a PHY reset, and performing a link (MAC)  *  reset.  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_reset_hw_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u32
name|ctrl
decl_stmt|;
name|u32
name|gheccr
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|u32
name|autoc
decl_stmt|;
name|u8
name|analog_val
decl_stmt|;
comment|/* Call adapter stop to disable tx/rx and clear interrupts */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|stop_adapter
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* 	 * Power up the Atlas Tx lanes if they are currently powered down. 	 * Atlas Tx lanes are powered down for MAC loopback tests, but 	 * they are not automatically restored on reset. 	 */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|read_analog_reg8
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLAS_PDN_LPBK
argument_list|,
operator|&
name|analog_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|analog_val
operator|&
name|IXGBE_ATLAS_PDN_TX_REG_EN
condition|)
block|{
comment|/* Enable Tx Atlas so packets can be transmitted again */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|read_analog_reg8
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLAS_PDN_LPBK
argument_list|,
operator|&
name|analog_val
argument_list|)
expr_stmt|;
name|analog_val
operator|&=
operator|~
name|IXGBE_ATLAS_PDN_TX_REG_EN
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|write_analog_reg8
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLAS_PDN_LPBK
argument_list|,
name|analog_val
argument_list|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|read_analog_reg8
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLAS_PDN_10G
argument_list|,
operator|&
name|analog_val
argument_list|)
expr_stmt|;
name|analog_val
operator|&=
operator|~
name|IXGBE_ATLAS_PDN_TX_10G_QL_ALL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|write_analog_reg8
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLAS_PDN_10G
argument_list|,
name|analog_val
argument_list|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|read_analog_reg8
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLAS_PDN_1G
argument_list|,
operator|&
name|analog_val
argument_list|)
expr_stmt|;
name|analog_val
operator|&=
operator|~
name|IXGBE_ATLAS_PDN_TX_1G_QL_ALL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|write_analog_reg8
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLAS_PDN_1G
argument_list|,
name|analog_val
argument_list|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|read_analog_reg8
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLAS_PDN_AN
argument_list|,
operator|&
name|analog_val
argument_list|)
expr_stmt|;
name|analog_val
operator|&=
operator|~
name|IXGBE_ATLAS_PDN_TX_AN_QL_ALL
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|write_analog_reg8
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLAS_PDN_AN
argument_list|,
name|analog_val
argument_list|)
expr_stmt|;
block|}
comment|/* Reset PHY */
if|if
condition|(
name|hw
operator|->
name|phy
operator|.
name|reset_disable
operator|==
name|FALSE
condition|)
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|reset
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* 	 * Prevent the PCI-E bus from from hanging by disabling PCI-E master 	 * access and verify no pending requests before reset 	 */
if|if
condition|(
name|ixgbe_disable_pcie_master
argument_list|(
name|hw
argument_list|)
operator|!=
name|IXGBE_SUCCESS
condition|)
block|{
name|status
operator|=
name|IXGBE_ERR_MASTER_REQUESTS_PENDING
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"PCI-E Master disable polling has failed.\n"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Issue global reset to the MAC.  This needs to be a SW reset. 	 * If link reset is used, it might reset the MAC when mng is using it 	 */
name|ctrl
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|,
operator|(
name|ctrl
operator||
name|IXGBE_CTRL_RST
operator|)
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Poll for reset bit to self-clear indicating reset is complete */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctrl
operator|&
name|IXGBE_CTRL_RST
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ctrl
operator|&
name|IXGBE_CTRL_RST
condition|)
block|{
name|status
operator|=
name|IXGBE_ERR_RESET_FAILED
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Reset polling failed to complete.\n"
argument_list|)
expr_stmt|;
block|}
name|msec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|gheccr
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GHECCR
argument_list|)
expr_stmt|;
name|gheccr
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|21
operator|)
operator||
operator|(
literal|1
operator|<<
literal|18
operator|)
operator||
operator|(
literal|1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GHECCR
argument_list|,
name|gheccr
argument_list|)
expr_stmt|;
comment|/* 	 * AUTOC register which stores link settings gets cleared 	 * and reloaded from EEPROM after reset. We need to restore 	 * our stored value from init in case SW changed the attach 	 * type or speed.  If this is the first time and link settings 	 * have not been stored, store default settings from AUTOC. 	 */
name|autoc
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
condition|)
block|{
name|autoc
operator|&=
operator|~
operator|(
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
operator|)
expr_stmt|;
name|autoc
operator|&=
operator|~
operator|(
name|IXGBE_AUTOC_LMS_MASK
operator|)
expr_stmt|;
name|autoc
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
expr_stmt|;
name|autoc
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|,
name|autoc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|=
operator|(
name|autoc
operator|&
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
operator|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
operator|(
name|autoc
operator|&
name|IXGBE_AUTOC_LMS_MASK
operator|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* Store the permanent mac address */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|get_mac_addr
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|mac
operator|.
name|perm_addr
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_set_vmdq_82598 - Associate a VMDq set index with a rx address  *  @hw: pointer to hardware struct  *  @rar: receive address register index to associate with a VMDq index  *  @vmdq: VMDq set index  **/
end_comment

begin_function
name|s32
name|ixgbe_set_vmdq_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|rar
parameter_list|,
name|u32
name|vmdq
parameter_list|)
block|{
name|u32
name|rar_high
decl_stmt|;
name|rar_high
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RAH
argument_list|(
name|rar
argument_list|)
argument_list|)
expr_stmt|;
name|rar_high
operator|&=
operator|~
name|IXGBE_RAH_VIND_MASK
expr_stmt|;
name|rar_high
operator||=
operator|(
operator|(
name|vmdq
operator|<<
name|IXGBE_RAH_VIND_SHIFT
operator|)
operator|&
name|IXGBE_RAH_VIND_MASK
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RAH
argument_list|(
name|rar
argument_list|)
argument_list|,
name|rar_high
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_clear_vmdq_82598 - Disassociate a VMDq set index from an rx address  *  @hw: pointer to hardware struct  *  @rar: receive address register index to associate with a VMDq index  *  @vmdq: VMDq clear index (not used in 82598, but elsewhere)  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_clear_vmdq_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|rar
parameter_list|,
name|u32
name|vmdq
parameter_list|)
block|{
name|u32
name|rar_high
decl_stmt|;
name|u32
name|rar_entries
init|=
name|hw
operator|->
name|mac
operator|.
name|num_rar_entries
decl_stmt|;
name|UNREFERENCED_PARAMETER
argument_list|(
name|vmdq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rar
operator|<
name|rar_entries
condition|)
block|{
name|rar_high
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RAH
argument_list|(
name|rar
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rar_high
operator|&
name|IXGBE_RAH_VIND_MASK
condition|)
block|{
name|rar_high
operator|&=
operator|~
name|IXGBE_RAH_VIND_MASK
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_RAH
argument_list|(
name|rar
argument_list|)
argument_list|,
name|rar_high
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DEBUGOUT1
argument_list|(
literal|"RAR index %d is out of range.\n"
argument_list|,
name|rar
argument_list|)
expr_stmt|;
block|}
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_set_vfta_82598 - Set VLAN filter table  *  @hw: pointer to hardware structure  *  @vlan: VLAN id to write to VLAN filter  *  @vind: VMDq output index that maps queue to VLAN id in VFTA  *  @vlan_on: boolean flag to turn on/off VLAN in VFTA  *  *  Turn on/off specified VLAN in the VLAN filter table.  **/
end_comment

begin_function
name|s32
name|ixgbe_set_vfta_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|vlan
parameter_list|,
name|u32
name|vind
parameter_list|,
name|bool
name|vlan_on
parameter_list|)
block|{
name|u32
name|regindex
decl_stmt|;
name|u32
name|bitindex
decl_stmt|;
name|u32
name|bits
decl_stmt|;
name|u32
name|vftabyte
decl_stmt|;
if|if
condition|(
name|vlan
operator|>
literal|4095
condition|)
return|return
name|IXGBE_ERR_PARAM
return|;
comment|/* Determine 32-bit word position in array */
name|regindex
operator|=
operator|(
name|vlan
operator|>>
literal|5
operator|)
operator|&
literal|0x7F
expr_stmt|;
comment|/* upper seven bits */
comment|/* Determine the location of the (VMD) queue index */
name|vftabyte
operator|=
operator|(
operator|(
name|vlan
operator|>>
literal|3
operator|)
operator|&
literal|0x03
operator|)
expr_stmt|;
comment|/* bits (4:3) indicating byte array */
name|bitindex
operator|=
operator|(
name|vlan
operator|&
literal|0x7
operator|)
operator|<<
literal|2
expr_stmt|;
comment|/* lower 3 bits indicate nibble */
comment|/* Set the nibble for VMD queue index */
name|bits
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTAVIND
argument_list|(
name|vftabyte
argument_list|,
name|regindex
argument_list|)
argument_list|)
expr_stmt|;
name|bits
operator|&=
operator|(
operator|~
operator|(
literal|0x0F
operator|<<
name|bitindex
operator|)
operator|)
expr_stmt|;
name|bits
operator||=
operator|(
name|vind
operator|<<
name|bitindex
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTAVIND
argument_list|(
name|vftabyte
argument_list|,
name|regindex
argument_list|)
argument_list|,
name|bits
argument_list|)
expr_stmt|;
comment|/* Determine the location of the bit for this VLAN id */
name|bitindex
operator|=
name|vlan
operator|&
literal|0x1F
expr_stmt|;
comment|/* lower five bits */
name|bits
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTA
argument_list|(
name|regindex
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vlan_on
condition|)
comment|/* Turn on this VLAN id */
name|bits
operator||=
operator|(
literal|1
operator|<<
name|bitindex
operator|)
expr_stmt|;
else|else
comment|/* Turn off this VLAN id */
name|bits
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|bitindex
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTA
argument_list|(
name|regindex
argument_list|)
argument_list|,
name|bits
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_clear_vfta_82598 - Clear VLAN filter table  *  @hw: pointer to hardware structure  *  *  Clears the VLAN filer table, and the VMDq index associated with the filter  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_clear_vfta_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|u32
name|offset
decl_stmt|;
name|u32
name|vlanbyte
decl_stmt|;
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
name|hw
operator|->
name|mac
operator|.
name|vft_size
condition|;
name|offset
operator|++
control|)
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTA
argument_list|(
name|offset
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|vlanbyte
operator|=
literal|0
init|;
name|vlanbyte
operator|<
literal|4
condition|;
name|vlanbyte
operator|++
control|)
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
name|hw
operator|->
name|mac
operator|.
name|vft_size
condition|;
name|offset
operator|++
control|)
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_VFTAVIND
argument_list|(
name|vlanbyte
argument_list|,
name|offset
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_blink_led_start_82598 - Blink LED based on index.  *  @hw: pointer to hardware structure  *  @index: led number to blink  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_blink_led_start_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|index
parameter_list|)
block|{
name|ixgbe_link_speed
name|speed
init|=
literal|0
decl_stmt|;
name|bool
name|link_up
init|=
literal|0
decl_stmt|;
name|u32
name|autoc_reg
init|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|)
decl_stmt|;
name|u32
name|led_reg
init|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_LEDCTL
argument_list|)
decl_stmt|;
comment|/* 	 * Link must be up to auto-blink the LEDs on the 82598EB MAC; 	 * force it if link is down. 	 */
name|hw
operator|->
name|mac
operator|.
name|ops
operator|.
name|check_link
argument_list|(
name|hw
argument_list|,
operator|&
name|speed
argument_list|,
operator|&
name|link_up
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|link_up
condition|)
block|{
name|autoc_reg
operator||=
name|IXGBE_AUTOC_FLU
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|,
name|autoc_reg
argument_list|)
expr_stmt|;
name|msec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|led_reg
operator|&=
operator|~
name|IXGBE_LED_MODE_MASK
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|led_reg
operator||=
name|IXGBE_LED_BLINK
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_LEDCTL
argument_list|,
name|led_reg
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_blink_led_stop_82598 - Stop blinking LED based on index.  *  @hw: pointer to hardware structure  *  @index: led number to stop blinking  **/
end_comment

begin_function
specifier|static
name|s32
name|ixgbe_blink_led_stop_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|index
parameter_list|)
block|{
name|u32
name|autoc_reg
init|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|)
decl_stmt|;
name|u32
name|led_reg
init|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_LEDCTL
argument_list|)
decl_stmt|;
name|autoc_reg
operator|&=
operator|~
name|IXGBE_AUTOC_FLU
expr_stmt|;
name|autoc_reg
operator||=
name|IXGBE_AUTOC_AN_RESTART
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|,
name|autoc_reg
argument_list|)
expr_stmt|;
name|led_reg
operator|&=
operator|~
name|IXGBE_LED_MODE_MASK
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|led_reg
operator|&=
operator|~
name|IXGBE_LED_BLINK
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|led_reg
operator||=
name|IXGBE_LED_LINK_ACTIVE
operator|<<
name|IXGBE_LED_MODE_SHIFT
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_LEDCTL
argument_list|,
name|led_reg
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_read_analog_reg8_82598 - Reads 8 bit Atlas analog register  *  @hw: pointer to hardware structure  *  @reg: analog register to read  *  @val: read value  *  *  Performs read operation to Atlas analog register specified.  **/
end_comment

begin_function
name|s32
name|ixgbe_read_analog_reg8_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u8
modifier|*
name|val
parameter_list|)
block|{
name|u32
name|atlas_ctl
decl_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLASCTL
argument_list|,
name|IXGBE_ATLASCTL_WRITE_CMD
operator||
operator|(
name|reg
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|atlas_ctl
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLASCTL
argument_list|)
expr_stmt|;
operator|*
name|val
operator|=
operator|(
name|u8
operator|)
name|atlas_ctl
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_write_analog_reg8_82598 - Writes 8 bit Atlas analog register  *  @hw: pointer to hardware structure  *  @reg: atlas register to write  *  @val: value to write  *  *  Performs write operation to Atlas analog register specified.  **/
end_comment

begin_function
name|s32
name|ixgbe_write_analog_reg8_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u32
name|reg
parameter_list|,
name|u8
name|val
parameter_list|)
block|{
name|u32
name|atlas_ctl
decl_stmt|;
name|atlas_ctl
operator|=
operator|(
name|reg
operator|<<
literal|8
operator|)
operator||
name|val
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_ATLASCTL
argument_list|,
name|atlas_ctl
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
name|usec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_read_i2c_eeprom_82598 - Reads 8 bit word over I2C interface.  *  @hw: pointer to hardware structure  *  @byte_offset: EEPROM byte offset to read  *  @eeprom_data: value read  *  *  Performs 8 byte read operation to SFP module's EEPROM over I2C interface.  **/
end_comment

begin_function
name|s32
name|ixgbe_read_i2c_eeprom_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|u8
name|byte_offset
parameter_list|,
name|u8
modifier|*
name|eeprom_data
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u16
name|sfp_addr
init|=
literal|0
decl_stmt|;
name|u16
name|sfp_data
init|=
literal|0
decl_stmt|;
name|u16
name|sfp_stat
init|=
literal|0
decl_stmt|;
name|u32
name|i
decl_stmt|;
if|if
condition|(
name|hw
operator|->
name|phy
operator|.
name|type
operator|==
name|ixgbe_phy_nl
condition|)
block|{
comment|/* 		 * NetLogic phy SDA/SCL registers are at addresses 0xC30A to 		 * 0xC30D. These registers are used to talk to the SFP+ 		 * module's EEPROM through the SDA/SCL (I2C) interface. 		 */
name|sfp_addr
operator|=
operator|(
name|IXGBE_I2C_EEPROM_DEV_ADDR
operator|<<
literal|8
operator|)
operator|+
name|byte_offset
expr_stmt|;
name|sfp_addr
operator|=
operator|(
name|sfp_addr
operator||
name|IXGBE_I2C_EEPROM_READ_MASK
operator|)
expr_stmt|;
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|write_reg
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_PMA_PMD_SDA_SCL_ADDR
argument_list|,
name|IXGBE_MDIO_PMA_PMD_DEV_TYPE
argument_list|,
name|sfp_addr
argument_list|)
expr_stmt|;
comment|/* Poll status */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|read_reg
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_PMA_PMD_SDA_SCL_STAT
argument_list|,
name|IXGBE_MDIO_PMA_PMD_DEV_TYPE
argument_list|,
operator|&
name|sfp_stat
argument_list|)
expr_stmt|;
name|sfp_stat
operator|=
name|sfp_stat
operator|&
name|IXGBE_I2C_EEPROM_STATUS_MASK
expr_stmt|;
if|if
condition|(
name|sfp_stat
operator|!=
name|IXGBE_I2C_EEPROM_STATUS_IN_PROGRESS
condition|)
break|break;
name|msec_delay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sfp_stat
operator|!=
name|IXGBE_I2C_EEPROM_STATUS_PASS
condition|)
block|{
name|DEBUGOUT
argument_list|(
literal|"EEPROM read did not pass.\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IXGBE_ERR_SFP_NOT_PRESENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Read data */
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|read_reg
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_PMA_PMD_SDA_SCL_DATA
argument_list|,
name|IXGBE_MDIO_PMA_PMD_DEV_TYPE
argument_list|,
operator|&
name|sfp_data
argument_list|)
expr_stmt|;
operator|*
name|eeprom_data
operator|=
call|(
name|u8
call|)
argument_list|(
name|sfp_data
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|IXGBE_ERR_PHY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_supported_physical_layer_82598 - Returns physical layer type  *  @hw: pointer to hardware structure  *  *  Determines physical layer capabilities of the current configuration.  **/
end_comment

begin_function
name|u32
name|ixgbe_get_supported_physical_layer_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|u32
name|physical_layer
init|=
name|IXGBE_PHYSICAL_LAYER_UNKNOWN
decl_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|device_id
condition|)
block|{
case|case
name|IXGBE_DEV_ID_82598
case|:
comment|/* Default device ID is mezzanine card KX/KX4 */
name|physical_layer
operator|=
operator|(
name|IXGBE_PHYSICAL_LAYER_10GBASE_KX4
operator||
name|IXGBE_PHYSICAL_LAYER_1000BASE_KX
operator|)
expr_stmt|;
break|break;
case|case
name|IXGBE_DEV_ID_82598EB_CX4
case|:
case|case
name|IXGBE_DEV_ID_82598_CX4_DUAL_PORT
case|:
name|physical_layer
operator|=
name|IXGBE_PHYSICAL_LAYER_10GBASE_CX4
expr_stmt|;
break|break;
case|case
name|IXGBE_DEV_ID_82598_DA_DUAL_PORT
case|:
name|physical_layer
operator|=
name|IXGBE_PHYSICAL_LAYER_SFP_PLUS_CU
expr_stmt|;
break|break;
case|case
name|IXGBE_DEV_ID_82598AF_DUAL_PORT
case|:
case|case
name|IXGBE_DEV_ID_82598AF_SINGLE_PORT
case|:
case|case
name|IXGBE_DEV_ID_82598_SR_DUAL_PORT_EM
case|:
name|physical_layer
operator|=
name|IXGBE_PHYSICAL_LAYER_10GBASE_SR
expr_stmt|;
break|break;
case|case
name|IXGBE_DEV_ID_82598EB_XF_LR
case|:
name|physical_layer
operator|=
name|IXGBE_PHYSICAL_LAYER_10GBASE_LR
expr_stmt|;
break|break;
case|case
name|IXGBE_DEV_ID_82598AT
case|:
name|physical_layer
operator|=
operator|(
name|IXGBE_PHYSICAL_LAYER_10GBASE_T
operator||
name|IXGBE_PHYSICAL_LAYER_1000BASE_T
operator|)
expr_stmt|;
break|break;
case|case
name|IXGBE_DEV_ID_82598EB_SFP_LOM
case|:
name|hw
operator|->
name|phy
operator|.
name|ops
operator|.
name|identify_sfp
argument_list|(
name|hw
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hw
operator|->
name|phy
operator|.
name|sfp_type
condition|)
block|{
case|case
name|ixgbe_sfp_type_da_cu
case|:
name|physical_layer
operator|=
name|IXGBE_PHYSICAL_LAYER_SFP_PLUS_CU
expr_stmt|;
break|break;
case|case
name|ixgbe_sfp_type_sr
case|:
name|physical_layer
operator|=
name|IXGBE_PHYSICAL_LAYER_10GBASE_SR
expr_stmt|;
break|break;
case|case
name|ixgbe_sfp_type_lr
case|:
name|physical_layer
operator|=
name|IXGBE_PHYSICAL_LAYER_10GBASE_LR
expr_stmt|;
break|break;
default|default:
name|physical_layer
operator|=
name|IXGBE_PHYSICAL_LAYER_UNKNOWN
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|physical_layer
operator|=
name|IXGBE_PHYSICAL_LAYER_UNKNOWN
expr_stmt|;
break|break;
block|}
return|return
name|physical_layer
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*******************************************************************************    Copyright (c) 2001-2007, Intel Corporation    All rights reserved.      Redistribution and use in source and binary forms, with or without    modification, are permitted provided that the following conditions are met:       1. Redistributions of source code must retain the above copyright notice,        this list of conditions and the following disclaimer.       2. Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.       3. Neither the name of the Intel Corporation nor the names of its        contributors may be used to endorse or promote products derived from        this software without specific prior written permission.      THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE    ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR    CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF    SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS    INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN    CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   POSSIBILITY OF SUCH DAMAGE.  *******************************************************************************/
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|"ixgbe_type.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_api.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_common.h"
end_include

begin_include
include|#
directive|include
file|"ixgbe_phy.h"
end_include

begin_define
define|#
directive|define
name|IXGBE_82598_MAX_TX_QUEUES
value|32
end_define

begin_define
define|#
directive|define
name|IXGBE_82598_MAX_RX_QUEUES
value|64
end_define

begin_define
define|#
directive|define
name|IXGBE_82598_RAR_ENTRIES
value|16
end_define

begin_function_decl
name|s32
name|ixgbe_init_shared_code_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_assign_func_pointers_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_get_link_settings_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|autoneg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_get_copper_link_settings_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|autoneg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|enum
name|ixgbe_media_type
name|ixgbe_get_media_type_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|u32
name|ixgbe_get_num_of_tx_queues_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|u32
name|ixgbe_get_num_of_rx_queues_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_setup_mac_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_check_mac_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_setup_mac_link_speed_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_setup_copper_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_check_copper_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|s32
name|ixgbe_setup_copper_link_speed_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|NO_82598_A0_SUPPORT
end_ifndef

begin_function_decl
name|s32
name|ixgbe_reset_hw_rev_0_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|s32
name|ixgbe_reset_hw_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|u32
name|ixgbe_get_num_rx_addrs_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**  *  ixgbe_init_shared_code_82598 - Inits func ptrs and MAC type  *  @hw: pointer to hardware structure  *  *  Initialize the shared code for 82598. This will assign function pointers  *  and assign the MAC type.  Does not touch the hardware.  **/
end_comment

begin_function
name|s32
name|ixgbe_init_shared_code_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
comment|/* Set MAC type */
name|hw
operator|->
name|mac
operator|.
name|type
operator|=
name|ixgbe_mac_82598EB
expr_stmt|;
comment|/* Assign function pointers */
name|ixgbe_assign_func_pointers_82598
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_assign_func_pointers_82598 - Assigns 82598-specific funtion pointers  *  @hw: pointer to hardware structure  *  *  Note - Generic function pointers have already been assigned, so the  *  function pointers set here are only for 82598-specific functions.  **/
end_comment

begin_function
name|s32
name|ixgbe_assign_func_pointers_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_get_media_type
operator|=
operator|&
name|ixgbe_get_media_type_82598
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_get_num_of_tx_queues
operator|=
operator|&
name|ixgbe_get_num_of_tx_queues_82598
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_get_num_of_rx_queues
operator|=
operator|&
name|ixgbe_get_num_of_rx_queues_82598
expr_stmt|;
ifndef|#
directive|ifndef
name|NO_82598_A0_SUPPORT
if|if
condition|(
name|hw
operator|->
name|revision_id
operator|==
literal|0
condition|)
block|{
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_reset_hw
operator|=
operator|&
name|ixgbe_reset_hw_rev_0_82598
expr_stmt|;
block|}
else|else
block|{
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_reset_hw
operator|=
operator|&
name|ixgbe_reset_hw_82598
expr_stmt|;
block|}
else|#
directive|else
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_reset_hw
operator|=
operator|&
name|ixgbe_reset_hw_82598
expr_stmt|;
endif|#
directive|endif
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_get_num_rx_addrs
operator|=
operator|&
name|ixgbe_get_num_rx_addrs_82598
expr_stmt|;
comment|/* Link */
if|if
condition|(
name|ixgbe_get_media_type
argument_list|(
name|hw
argument_list|)
operator|==
name|ixgbe_media_type_copper
condition|)
block|{
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_setup_link
operator|=
operator|&
name|ixgbe_setup_copper_link_82598
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_check_link
operator|=
operator|&
name|ixgbe_check_copper_link_82598
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_setup_link_speed
operator|=
operator|&
name|ixgbe_setup_copper_link_speed_82598
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_get_link_settings
operator|=
operator|&
name|ixgbe_get_copper_link_settings_82598
expr_stmt|;
block|}
else|else
block|{
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_setup_link
operator|=
operator|&
name|ixgbe_setup_mac_link_82598
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_check_link
operator|=
operator|&
name|ixgbe_check_mac_link_82598
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_setup_link_speed
operator|=
operator|&
name|ixgbe_setup_mac_link_speed_82598
expr_stmt|;
name|hw
operator|->
name|func
operator|.
name|ixgbe_func_get_link_settings
operator|=
operator|&
name|ixgbe_get_link_settings_82598
expr_stmt|;
block|}
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_link_settings_82598 - Determines default link settings  *  @hw: pointer to hardware structure  *  @speed: pointer to link speed  *  @autoneg: boolean auto-negotiation value  *  *  Determines the default link settings by reading the AUTOC register.  **/
end_comment

begin_function
name|s32
name|ixgbe_get_link_settings_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|autoneg
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|s32
name|autoc_reg
decl_stmt|;
name|autoc_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
condition|)
block|{
name|autoc_reg
operator|&=
operator|~
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
expr_stmt|;
name|autoc_reg
operator|&=
operator|~
name|IXGBE_AUTOC_LMS_MASK
expr_stmt|;
name|autoc_reg
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
expr_stmt|;
name|autoc_reg
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
expr_stmt|;
block|}
switch|switch
condition|(
name|autoc_reg
operator|&
name|IXGBE_AUTOC_LMS_MASK
condition|)
block|{
case|case
name|IXGBE_AUTOC_LMS_1G_LINK_NO_AN
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
operator|*
name|autoneg
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
name|IXGBE_AUTOC_LMS_10G_LINK_NO_AN
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
operator|*
name|autoneg
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
name|IXGBE_AUTOC_LMS_1G_AN
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
operator|*
name|autoneg
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|IXGBE_AUTOC_LMS_KX4_AN
case|:
case|case
name|IXGBE_AUTOC_LMS_KX4_AN_1G_AN
case|:
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_UNKNOWN
expr_stmt|;
if|if
condition|(
name|autoc_reg
operator|&
name|IXGBE_AUTOC_KX4_SUPP
condition|)
block|{
operator|*
name|speed
operator||=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
block|}
if|if
condition|(
name|autoc_reg
operator|&
name|IXGBE_AUTOC_KX_SUPP
condition|)
block|{
operator|*
name|speed
operator||=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
block|}
operator|*
name|autoneg
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|IXGBE_ERR_LINK_SETUP
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_copper_link_settings_82598 - Determines default link settings  *  @hw: pointer to hardware structure  *  @speed: pointer to link speed  *  @autoneg: boolean auto-negotiation value  *  *  Determines the default link settings by reading the AUTOC register.  **/
end_comment

begin_function
name|s32
name|ixgbe_get_copper_link_settings_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|autoneg
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_ERR_LINK_SETUP
decl_stmt|;
name|u16
name|speed_ability
decl_stmt|;
operator|*
name|speed
operator|=
literal|0
expr_stmt|;
operator|*
name|autoneg
operator|=
name|TRUE
expr_stmt|;
name|status
operator|=
name|ixgbe_read_phy_reg
argument_list|(
name|hw
argument_list|,
name|IXGBE_MDIO_PHY_SPEED_ABILITY
argument_list|,
name|IXGBE_MDIO_PMA_PMD_DEV_TYPE
argument_list|,
operator|&
name|speed_ability
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
block|{
if|if
condition|(
name|speed_ability
operator|&
name|IXGBE_MDIO_PHY_SPEED_10G
condition|)
operator|*
name|speed
operator||=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
if|if
condition|(
name|speed_ability
operator|&
name|IXGBE_MDIO_PHY_SPEED_1G
condition|)
operator|*
name|speed
operator||=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_media_type_82598 - Determines media type  *  @hw: pointer to hardware structure  *  *  Returns the media type (fiber, copper, backplane)  **/
end_comment

begin_function
name|enum
name|ixgbe_media_type
name|ixgbe_get_media_type_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|enum
name|ixgbe_media_type
name|media_type
decl_stmt|;
comment|/* Media type for I82598 is based on device ID */
switch|switch
condition|(
name|hw
operator|->
name|device_id
condition|)
block|{
case|case
name|IXGBE_DEV_ID_82598
case|:
comment|/* Default device ID is mezzanine card KX/KX4 */
name|media_type
operator|=
name|ixgbe_media_type_backplane
expr_stmt|;
break|break;
case|case
name|IXGBE_DEV_ID_82598_FPGA
case|:
case|case
name|IXGBE_DEV_ID_82598AF_DUAL_PORT
case|:
case|case
name|IXGBE_DEV_ID_82598AF_SINGLE_PORT
case|:
name|media_type
operator|=
name|ixgbe_media_type_fiber
expr_stmt|;
break|break;
case|case
name|IXGBE_DEV_ID_82598AT_DUAL_PORT
case|:
name|media_type
operator|=
name|ixgbe_media_type_copper
expr_stmt|;
break|break;
default|default:
name|media_type
operator|=
name|ixgbe_media_type_unknown
expr_stmt|;
break|break;
block|}
return|return
name|media_type
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_num_of_tx_queues_82598 - Get number of TX queues  *  @hw: pointer to hardware structure  *  *  Returns the number of transmit queues for the given adapter.  **/
end_comment

begin_function
name|u32
name|ixgbe_get_num_of_tx_queues_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
if|if
condition|(
name|hw
operator|->
name|device_id
operator|==
name|IXGBE_DEV_ID_82598_FPGA
condition|)
return|return
literal|8
return|;
return|return
name|IXGBE_82598_MAX_TX_QUEUES
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_num_of_rx_queues_82598 - Get number of RX queues  *  @hw: pointer to hardware structure  *  *  Returns the number of receive queues for the given adapter.  **/
end_comment

begin_function
name|u32
name|ixgbe_get_num_of_rx_queues_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
if|if
condition|(
name|hw
operator|->
name|device_id
operator|==
name|IXGBE_DEV_ID_82598_FPGA
condition|)
return|return
literal|8
return|;
return|return
name|IXGBE_82598_MAX_RX_QUEUES
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_mac_link_82598 - Configures MAC link settings  *  @hw: pointer to hardware structure  *  *  Configures link settings based on values in the ixgbe_hw struct.  *  Restarts the link.  Performs autonegotiation if needed.  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_mac_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|u32
name|autoc_reg
decl_stmt|;
name|u32
name|links_reg
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|autoc_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
condition|)
block|{
name|autoc_reg
operator|&=
operator|~
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
expr_stmt|;
name|autoc_reg
operator|&=
operator|~
name|IXGBE_AUTOC_LMS_MASK
expr_stmt|;
name|autoc_reg
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
expr_stmt|;
name|autoc_reg
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|,
name|autoc_reg
argument_list|)
expr_stmt|;
name|msec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
comment|/* Restart link */
name|autoc_reg
operator||=
name|IXGBE_AUTOC_AN_RESTART
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|,
name|autoc_reg
argument_list|)
expr_stmt|;
comment|/* Only poll for autoneg to complete if specified to do so */
if|if
condition|(
name|hw
operator|->
name|phy
operator|.
name|autoneg_wait_to_complete
condition|)
block|{
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|==
name|IXGBE_AUTOC_LMS_KX4_AN
operator|||
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|==
name|IXGBE_AUTOC_LMS_KX4_AN_1G_AN
condition|)
block|{
name|links_reg
operator|=
literal|0
expr_stmt|;
comment|/* Just in case Autoneg time = 0 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IXGBE_AUTO_NEG_TIME
condition|;
name|i
operator|++
control|)
block|{
name|links_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_LINKS
argument_list|)
expr_stmt|;
if|if
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_KX_AN_COMP
condition|)
break|break;
name|msec_delay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|links_reg
operator|&
name|IXGBE_LINKS_KX_AN_COMP
operator|)
condition|)
block|{
name|status
operator|=
name|IXGBE_ERR_AUTONEG_NOT_COMPLETE
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Autonegotiation did not complete.\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Add delay to filter out noises during initial link setup */
name|msec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_mac_link_82598 - Get link/speed status  *  @hw: pointer to hardware structure  *  @speed: pointer to link speed  *  @link_up: TRUE is link is up, FALSE otherwise  *  *  Reads the links register to determine if link is up and the current speed  **/
end_comment

begin_function
name|s32
name|ixgbe_check_mac_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|)
block|{
name|u32
name|links_reg
decl_stmt|;
name|links_reg
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_LINKS
argument_list|)
expr_stmt|;
if|if
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_UP
condition|)
operator|*
name|link_up
operator|=
name|TRUE
expr_stmt|;
else|else
operator|*
name|link_up
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|links_reg
operator|&
name|IXGBE_LINKS_SPEED
condition|)
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_10GB_FULL
expr_stmt|;
else|else
operator|*
name|speed
operator|=
name|IXGBE_LINK_SPEED_1GB_FULL
expr_stmt|;
return|return
name|IXGBE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_mac_link_speed_82598 - Set MAC link speed  *  @hw: pointer to hardware structure  *  @speed: new link speed  *  @autoneg: TRUE if auto-negotiation enabled  *  @autoneg_wait_to_complete: TRUE if waiting is needed to complete  *  *  Set the link speed in the AUTOC register and restarts link.  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_mac_link_speed_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
comment|/* If speed is 10G, then check for CX4 or XAUI. */
if|if
condition|(
operator|(
name|speed
operator|==
name|IXGBE_LINK_SPEED_10GB_FULL
operator|)
operator|&&
operator|(
operator|!
operator|(
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|&
name|IXGBE_AUTOC_10G_KX4
operator|)
operator|)
condition|)
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
name|IXGBE_AUTOC_LMS_10G_LINK_NO_AN
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|speed
operator|==
name|IXGBE_LINK_SPEED_1GB_FULL
operator|)
operator|&&
operator|(
operator|!
name|autoneg
operator|)
condition|)
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
name|IXGBE_AUTOC_LMS_1G_LINK_NO_AN
expr_stmt|;
elseif|else
if|if
condition|(
name|autoneg
condition|)
block|{
comment|/* BX mode - Autonegotiate 1G */
if|if
condition|(
operator|!
operator|(
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|&
name|IXGBE_AUTOC_1G_PMA_PMD
operator|)
condition|)
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
name|IXGBE_AUTOC_LMS_1G_AN
expr_stmt|;
else|else
comment|/* KX/KX4 mode */
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
name|IXGBE_AUTOC_LMS_KX4_AN_1G_AN
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|IXGBE_ERR_LINK_SETUP
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
block|{
name|hw
operator|->
name|phy
operator|.
name|autoneg_wait_to_complete
operator|=
name|autoneg_wait_to_complete
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
operator|=
name|TRUE
expr_stmt|;
comment|/* 		 * Setup and restart the link based on the new values in 		 * ixgbe_hw This will write the AUTOC register based on the new 		 * stored values 		 */
name|ixgbe_setup_mac_link_82598
argument_list|(
name|hw
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_copper_link_82598 - Setup copper link settings  *  @hw: pointer to hardware structure  *  *  Configures link settings based on values in the ixgbe_hw struct.  *  Restarts the link.  Performs autonegotiation if needed.  Restart  *  phy and wait for autonegotiate to finish.  Then synchronize the  *  MAC and PHY.  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_copper_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|status
decl_stmt|;
name|ixgbe_link_speed
name|speed
init|=
literal|0
decl_stmt|;
name|bool
name|link_up
init|=
name|FALSE
decl_stmt|;
comment|/* Set up MAC */
name|ixgbe_setup_mac_link_82598
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Restart autonegotiation on PHY */
name|status
operator|=
name|ixgbe_setup_phy_link
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Synchronize MAC to PHY speed */
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
name|status
operator|=
name|ixgbe_check_link
argument_list|(
name|hw
argument_list|,
operator|&
name|speed
argument_list|,
operator|&
name|link_up
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_check_copper_link_82598 - Syncs MAC& PHY link settings  *  @hw: pointer to hardware structure  *  @speed: pointer to link speed  *  @link_up: TRUE if link is up, FALSE otherwise  *  *  Reads the mac link, phy link, and synchronizes the MAC to PHY.  **/
end_comment

begin_function
name|s32
name|ixgbe_check_copper_link_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
modifier|*
name|speed
parameter_list|,
name|bool
modifier|*
name|link_up
parameter_list|)
block|{
name|s32
name|status
decl_stmt|;
name|ixgbe_link_speed
name|phy_speed
init|=
literal|0
decl_stmt|;
name|bool
name|phy_link
init|=
name|FALSE
decl_stmt|;
comment|/* This is the speed and link the MAC is set at */
name|ixgbe_check_mac_link_82598
argument_list|(
name|hw
argument_list|,
name|speed
argument_list|,
name|link_up
argument_list|)
expr_stmt|;
comment|/* 	 * Check current speed and link status of the PHY register. 	 * This is a vendor specific register and may have to 	 * be changed for other copper PHYs. 	 */
name|status
operator|=
name|ixgbe_check_phy_link
argument_list|(
name|hw
argument_list|,
operator|&
name|phy_speed
argument_list|,
operator|&
name|phy_link
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|==
name|IXGBE_SUCCESS
operator|)
operator|&&
operator|(
name|phy_link
operator|)
condition|)
block|{
comment|/* 		 * Check current link status of the MACs link's register 		 * matches that of the speed in the PHY register 		 */
if|if
condition|(
operator|*
name|speed
operator|!=
name|phy_speed
condition|)
block|{
comment|/* 			 * The copper PHY requires 82598 attach type to be XAUI 			 * for 10G and BX for 1G 			 */
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|=
operator|(
name|IXGBE_AUTOC_10G_XAUI
operator||
name|IXGBE_AUTOC_1G_BX
operator|)
expr_stmt|;
comment|/* Synchronize the MAC speed to the PHY speed */
name|status
operator|=
name|ixgbe_setup_mac_link_speed_82598
argument_list|(
name|hw
argument_list|,
name|phy_speed
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
name|ixgbe_check_mac_link_82598
argument_list|(
name|hw
argument_list|,
name|speed
argument_list|,
name|link_up
argument_list|)
expr_stmt|;
else|else
name|status
operator|=
name|IXGBE_ERR_LINK_SETUP
expr_stmt|;
block|}
block|}
else|else
block|{
operator|*
name|link_up
operator|=
name|phy_link
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_setup_copper_link_speed_82598 - Set the PHY autoneg advertised field  *  @hw: pointer to hardware structure  *  @speed: new link speed  *  @autoneg: TRUE if autonegotiation enabled  *  @autoneg_wait_to_complete: TRUE if waiting is needed to complete  *  *  Sets the link speed in the AUTOC register in the MAC and restarts link.  **/
end_comment

begin_function
name|s32
name|ixgbe_setup_copper_link_speed_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|,
name|ixgbe_link_speed
name|speed
parameter_list|,
name|bool
name|autoneg
parameter_list|,
name|bool
name|autoneg_wait_to_complete
parameter_list|)
block|{
name|s32
name|status
decl_stmt|;
name|bool
name|link_up
init|=
literal|0
decl_stmt|;
comment|/* Setup the PHY according to input speed */
name|status
operator|=
name|ixgbe_setup_phy_link_speed
argument_list|(
name|hw
argument_list|,
name|speed
argument_list|,
name|autoneg
argument_list|,
name|autoneg_wait_to_complete
argument_list|)
expr_stmt|;
comment|/* Synchronize MAC to PHY speed */
if|if
condition|(
name|status
operator|==
name|IXGBE_SUCCESS
condition|)
name|status
operator|=
name|ixgbe_check_link
argument_list|(
name|hw
argument_list|,
operator|&
name|speed
argument_list|,
operator|&
name|link_up
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NO_82598_A0_SUPPORT
end_ifndef

begin_comment
comment|/**  *  ixgbe_reset_hw_rev_0_82598 - Performs hardware reset  *  @hw: pointer to hardware structure  *  *  Resets the hardware by reseting the transmit and receive units, masks and  *  clears all interrupts, performing a PHY reset, and performing a link (MAC)  *  reset.  **/
end_comment

begin_function
name|s32
name|ixgbe_reset_hw_rev_0_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u32
name|ctrl
decl_stmt|;
name|u32
name|gheccr
decl_stmt|;
name|u32
name|autoc
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|u32
name|resets
decl_stmt|;
comment|/* Call adapter stop to disable tx/rx and clear interrupts */
name|ixgbe_stop_adapter
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Reset PHY */
name|ixgbe_reset_phy
argument_list|(
name|hw
argument_list|)
expr_stmt|;
for|for
control|(
name|resets
operator|=
literal|0
init|;
name|resets
operator|<
literal|10
condition|;
name|resets
operator|++
control|)
block|{
comment|/* 		 * Prevent the PCI-E bus from from hanging by disabling PCI-E 		 * master access and verify no pending requests before reset 		 */
if|if
condition|(
name|ixgbe_disable_pcie_master
argument_list|(
name|hw
argument_list|)
operator|!=
name|IXGBE_SUCCESS
condition|)
block|{
name|status
operator|=
name|IXGBE_ERR_MASTER_REQUESTS_PENDING
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"PCI-E Master disable polling has failed.\n"
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Issue global reset to the MAC.  This needs to be a SW reset. 		 * If link reset is used, it might reset the MAC when mng is 		 * using it. 		 */
name|ctrl
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|,
operator|(
name|ctrl
operator||
name|IXGBE_CTRL_RST
operator|)
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* 		 * Poll for reset bit to self-clear indicating reset is 		 * complete 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctrl
operator|&
name|IXGBE_CTRL_RST
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ctrl
operator|&
name|IXGBE_CTRL_RST
condition|)
block|{
name|status
operator|=
name|IXGBE_ERR_RESET_FAILED
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Reset polling failed to complete.\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|msec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|gheccr
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GHECCR
argument_list|)
expr_stmt|;
name|gheccr
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|21
operator|)
operator||
operator|(
literal|1
operator|<<
literal|18
operator|)
operator||
operator|(
literal|1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GHECCR
argument_list|,
name|gheccr
argument_list|)
expr_stmt|;
comment|/* 	 * AUTOC register which stores link settings gets cleared 	 * and reloaded from EEPROM after reset. We need to restore 	 * our stored value from init in case SW changed the attach 	 * type or speed.  If this is the first time and link settings 	 * have not been stored, store default settings from AUTOC. 	 */
name|autoc
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
condition|)
block|{
name|autoc
operator|&=
operator|~
operator|(
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
operator|)
expr_stmt|;
name|autoc
operator|&=
operator|~
operator|(
name|IXGBE_AUTOC_LMS_MASK
operator|)
expr_stmt|;
name|autoc
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
expr_stmt|;
name|autoc
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|,
name|autoc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|=
operator|(
name|autoc
operator|&
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
operator|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
operator|(
name|autoc
operator|&
name|IXGBE_AUTOC_LMS_MASK
operator|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* Store the permanent mac address */
name|ixgbe_get_mac_addr
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|mac
operator|.
name|perm_addr
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NO_A0_SUPPORT */
end_comment

begin_comment
comment|/**  *  ixgbe_reset_hw_82598 - Performs hardware reset  *  @hw: pointer to hardware structure  *  *  Resets the hardware by reseting the transmit and receive units, masks and  *  clears all interrupts, performing a PHY reset, and performing a link (MAC)  *  reset.  **/
end_comment

begin_function
name|s32
name|ixgbe_reset_hw_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|s32
name|status
init|=
name|IXGBE_SUCCESS
decl_stmt|;
name|u32
name|ctrl
decl_stmt|;
name|u32
name|gheccr
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|u32
name|autoc
decl_stmt|;
comment|/* Call adapter stop to disable tx/rx and clear interrupts */
name|ixgbe_stop_adapter
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Reset PHY */
name|ixgbe_reset_phy
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* 	 * Prevent the PCI-E bus from from hanging by disabling PCI-E master 	 * access and verify no pending requests before reset 	 */
if|if
condition|(
name|ixgbe_disable_pcie_master
argument_list|(
name|hw
argument_list|)
operator|!=
name|IXGBE_SUCCESS
condition|)
block|{
name|status
operator|=
name|IXGBE_ERR_MASTER_REQUESTS_PENDING
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"PCI-E Master disable polling has failed.\n"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Issue global reset to the MAC.  This needs to be a SW reset. 	 * If link reset is used, it might reset the MAC when mng is using it 	 */
name|ctrl
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|,
operator|(
name|ctrl
operator||
name|IXGBE_CTRL_RST
operator|)
argument_list|)
expr_stmt|;
name|IXGBE_WRITE_FLUSH
argument_list|(
name|hw
argument_list|)
expr_stmt|;
comment|/* Poll for reset bit to self-clear indicating reset is complete */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|usec_delay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctrl
operator|&
name|IXGBE_CTRL_RST
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ctrl
operator|&
name|IXGBE_CTRL_RST
condition|)
block|{
name|status
operator|=
name|IXGBE_ERR_RESET_FAILED
expr_stmt|;
name|DEBUGOUT
argument_list|(
literal|"Reset polling failed to complete.\n"
argument_list|)
expr_stmt|;
block|}
name|msec_delay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|gheccr
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GHECCR
argument_list|)
expr_stmt|;
name|gheccr
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|21
operator|)
operator||
operator|(
literal|1
operator|<<
literal|18
operator|)
operator||
operator|(
literal|1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_GHECCR
argument_list|,
name|gheccr
argument_list|)
expr_stmt|;
comment|/* 	 * AUTOC register which stores link settings gets cleared 	 * and reloaded from EEPROM after reset. We need to restore 	 * our stored value from init in case SW changed the attach 	 * type or speed.  If this is the first time and link settings 	 * have not been stored, store default settings from AUTOC. 	 */
name|autoc
operator|=
name|IXGBE_READ_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
condition|)
block|{
name|autoc
operator|&=
operator|~
operator|(
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
operator|)
expr_stmt|;
name|autoc
operator|&=
operator|~
operator|(
name|IXGBE_AUTOC_LMS_MASK
operator|)
expr_stmt|;
name|autoc
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
expr_stmt|;
name|autoc
operator||=
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
expr_stmt|;
name|IXGBE_WRITE_REG
argument_list|(
name|hw
argument_list|,
name|IXGBE_AUTOC
argument_list|,
name|autoc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hw
operator|->
name|mac
operator|.
name|link_attach_type
operator|=
operator|(
name|autoc
operator|&
name|IXGBE_AUTOC_LMS_ATTACH_TYPE
operator|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_mode_select
operator|=
operator|(
name|autoc
operator|&
name|IXGBE_AUTOC_LMS_MASK
operator|)
expr_stmt|;
name|hw
operator|->
name|mac
operator|.
name|link_settings_loaded
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* Store the permanent mac address */
name|ixgbe_get_mac_addr
argument_list|(
name|hw
argument_list|,
name|hw
operator|->
name|mac
operator|.
name|perm_addr
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  ixgbe_get_num_rx_addrs_82598 - Get RX address registers  *  @hw: pointer to hardware structure  *  *  Returns the of RAR entries for the given adapter.  **/
end_comment

begin_function
name|u32
name|ixgbe_get_num_rx_addrs_82598
parameter_list|(
name|struct
name|ixgbe_hw
modifier|*
name|hw
parameter_list|)
block|{
name|UNREFERENCED_PARAMETER
argument_list|(
name|hw
argument_list|)
expr_stmt|;
return|return
name|IXGBE_82598_RAR_ENTRIES
return|;
block|}
end_function

end_unit


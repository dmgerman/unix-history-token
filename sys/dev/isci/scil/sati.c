begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * This file is provided under a dual BSD/GPLv2 license.  When using or  * redistributing this file, you may do so under either license.  *  * GPL LICENSE SUMMARY  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of version 2 of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it will be useful, but  * WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.  * The full GNU General Public License is included in this distribution  * in the file called LICENSE.GPL.  *  * BSD LICENSE  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in  *     the documentation and/or other materials provided with the  *     distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/**  * @file  * @brief This file contains all of the method implementations that  *        can be utilized by a user to perform SCSI-to-ATA Translation.  *        SATI adheres to the www.t10.org SAT specification.  *  * For situations where compliance is not observed, the SATI will  * return an error indication (most likely INVALID FIELD IN CDB sense data).  */
end_comment

begin_include
include|#
directive|include
file|<dev/isci/scil/sati.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_callbacks.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_report_luns.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_inquiry.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_mode_sense_6.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_mode_sense_10.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_mode_select.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_test_unit_ready.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_read_capacity.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_read.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_write.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_verify.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_synchronize_cache.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_lun_reset.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_start_stop_unit.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_request_sense.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_write_long.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_reassign_blocks.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_log_sense.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_abort_task_set.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_unmap.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_passthrough.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_write_and_verify.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_read_buffer.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_write_buffer.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_ata.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_scsi.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_sat.h>
end_include

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* P R I V A T E   M E T H O D S
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * @brief This method performs the translation of ATA error register values  *        into SCSI sense data.  *        For more information on the parameter passed to this method please  *        reference the sati_translate_response() method.  *  * @param[in] error This parameter specifies the contents of the ATA error  *            register to be translated.  *  * @return none  */
end_comment

begin_function
name|void
name|sati_translate_error
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|,
name|U8
name|error
parameter_list|)
block|{
if|if
condition|(
name|error
operator|&
name|ATA_ERROR_REG_NO_MEDIA_BIT
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_NOT_READY
argument_list|,
name|SCSI_ASC_MEDIUM_NOT_PRESENT
argument_list|,
name|SCSI_ASCQ_MEDIUM_NOT_PRESENT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|&
name|ATA_ERROR_REG_MEDIA_CHANGE_BIT
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_UNIT_ATTENTION
argument_list|,
name|SCSI_ASC_NOT_READY_TO_READY_CHANGE
argument_list|,
name|SCSI_ASCQ_NOT_READY_TO_READY_CHANGE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|&
name|ATA_ERROR_REG_MEDIA_CHANGE_REQUEST_BIT
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_UNIT_ATTENTION
argument_list|,
name|SCSI_ASC_MEDIUM_REMOVAL_REQUEST
argument_list|,
name|SCSI_ASCQ_MEDIUM_REMOVAL_REQUEST
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|&
name|ATA_ERROR_REG_ID_NOT_FOUND_BIT
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_ILLEGAL_REQUEST
argument_list|,
name|SCSI_ASC_LBA_OUT_OF_RANGE
argument_list|,
name|SCSI_ASCQ_LBA_OUT_OF_RANGE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|&
name|ATA_ERROR_REG_UNCORRECTABLE_BIT
condition|)
block|{
comment|//Mark the Sequence state as a read error so more sense data
comment|//can be returned later
name|sequence
operator|->
name|state
operator|=
name|SATI_SEQUENCE_STATE_READ_ERROR
expr_stmt|;
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_MEDIUM_ERROR
argument_list|,
name|SCSI_ASC_UNRECOVERED_READ_ERROR
argument_list|,
name|SCSI_ASCQ_UNRECOVERED_READ_ERROR
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|sequence
operator|->
name|data_direction
operator|==
name|SATI_DATA_DIRECTION_OUT
operator|)
operator|&&
operator|(
name|error
operator|&
name|ATA_ERROR_REG_WRITE_PROTECTED_BIT
operator|)
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_DATA_PROTECT
argument_list|,
name|SCSI_ASC_WRITE_PROTECTED
argument_list|,
name|SCSI_ASCQ_WRITE_PROTECTED
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|&
name|ATA_ERROR_REG_ICRC_BIT
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_ABORTED_COMMAND
argument_list|,
name|SCSI_ASC_IU_CRC_ERROR_DETECTED
argument_list|,
name|SCSI_ASCQ_IU_CRC_ERROR_DETECTED
argument_list|)
expr_stmt|;
block|}
else|else
comment|// (error& ATA_ERROR_REG_ABORT_BIT)
block|{
comment|// The ABORT bit has the lowest precedence of all errors.
comment|// As a result, it is at the bottom of the conditional
comment|// statement.
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_ABORTED_COMMAND
argument_list|,
name|SCSI_ASC_NO_ADDITIONAL_SENSE
argument_list|,
name|SCSI_ASCQ_NO_ADDITIONAL_SENSE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method translates the supplied ATA payload data into the  *        corresponding SCSI data.  This is necessary for SCSI commands  *        that have well-defined payload data associated with them (e.g.  *        READ CAPACITY).  *  * @param[in]  sequence This parameter specifies the sequence  *             data associated with the translation.  * @param[in]  ata_io This parameter specifies the ATA payload  *             buffer location and size to be translated.  * @param[out] scsi_output_data This parameter specifies the SCSI payload  *             memory area into which the translator is to write.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|sati_translate_data
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|ata_input_data
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|)
block|{
comment|// Update the device capabilities in the odd/crazy event something changed.
name|sati_device_update_capabilities
argument_list|(
name|sequence
operator|->
name|device
argument_list|,
operator|(
name|ATA_IDENTIFY_DEVICE_DATA_T
operator|*
operator|)
name|ata_input_data
argument_list|)
expr_stmt|;
comment|// Look at the first byte to determine the SCSI command to translate.
switch|switch
condition|(
name|sequence
operator|->
name|type
condition|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_INQUIRY
argument_list|)
case|case
name|SATI_SEQUENCE_INQUIRY_STANDARD
case|:
name|sati_inquiry_standard_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_INQUIRY_SERIAL_NUMBER
case|:
name|sati_inquiry_serial_number_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_INQUIRY_DEVICE_ID
case|:
name|sati_inquiry_device_id_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_INQUIRY_BLOCK_DEVICE
case|:
name|sati_inquiry_block_device_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_INQUIRY_ATA_INFORMATION
case|:
name|sati_inquiry_ata_information_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_INQUIRY)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_READ_CAPACITY
argument_list|)
case|case
name|SATI_SEQUENCE_READ_CAPACITY_10
case|:
name|sati_read_capacity_10_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_READ_CAPACITY_16
case|:
name|sati_read_capacity_16_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_READ_CAPACITY)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_MODE_SENSE
argument_list|)
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_CACHING
case|:
name|sati_mode_sense_6_caching_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_INFORMATIONAL_EXCP_CONTROL
case|:
name|sati_mode_sense_6_informational_excp_control_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_READ_WRITE_ERROR
case|:
name|sati_mode_sense_6_read_write_error_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_DISCONNECT_RECONNECT
case|:
name|sati_mode_sense_6_disconnect_reconnect_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_CONTROL
case|:
name|sati_mode_sense_6_control_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_ALL_PAGES
case|:
name|sati_mode_sense_6_all_pages_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_POWER_CONDITION
case|:
name|sati_mode_sense_6_power_condition_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_POWER_CONDITION
case|:
name|sati_mode_sense_10_power_condition_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_CACHING
case|:
name|sati_mode_sense_10_caching_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_INFORMATIONAL_EXCP_CONTROL
case|:
name|sati_mode_sense_10_informational_excp_control_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_READ_WRITE_ERROR
case|:
name|sati_mode_sense_10_read_write_error_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_DISCONNECT_RECONNECT
case|:
name|sati_mode_sense_10_disconnect_reconnect_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_CONTROL
case|:
name|sati_mode_sense_10_control_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_ALL_PAGES
case|:
name|sati_mode_sense_10_all_pages_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_MODE_SENSE)
default|default:
break|break;
block|}
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* P U B L I C   M E T H O D S
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_function
name|SATI_STATUS
name|sati_translate_command
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|SATI_DEVICE_T
modifier|*
name|sati_device
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|,
name|void
modifier|*
name|ata_io
parameter_list|)
block|{
name|SATI_STATUS
name|status
init|=
name|SATI_FAILURE
decl_stmt|;
name|U8
modifier|*
name|cdb
init|=
name|sati_cb_get_cdb_address
argument_list|(
name|scsi_io
argument_list|)
decl_stmt|;
comment|//No sense response has been set for the translation sequence yet
name|sequence
operator|->
name|is_sense_response_set
operator|=
name|FALSE
expr_stmt|;
comment|// Default to no translation response required
name|sequence
operator|->
name|is_translate_response_required
operator|=
name|FALSE
expr_stmt|;
comment|// Assign sati_device to sequence
name|sequence
operator|->
name|device
operator|=
name|sati_device
expr_stmt|;
comment|/**     * Fail any I/O request with LUN != 0     */
if|if
condition|(
name|sati_cb_get_lun
argument_list|(
name|scsi_io
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_ILLEGAL_REQUEST
argument_list|,
name|SCSI_ASC_LOGICAL_UNIT_NOT_SUPPORTED
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|SATI_FAILURE_CHECK_RESPONSE_DATA
return|;
block|}
comment|/**     * SAT dictates:     * - the NACA bit in the control byte (last byte) must be 0     */
if|if
condition|(
operator|(
name|sati_get_cdb_byte
argument_list|(
name|cdb
argument_list|,
name|sati_cb_get_cdb_length
argument_list|(
name|scsi_io
argument_list|)
operator|-
literal|1
argument_list|)
operator|&
name|SCSI_CONTROL_BYTE_NACA_BIT_ENABLE
operator|)
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_ILLEGAL_REQUEST
argument_list|,
name|SCSI_ASC_INVALID_FIELD_IN_CDB
argument_list|,
name|SCSI_ASCQ_INVALID_FIELD_IN_CDB
argument_list|)
expr_stmt|;
return|return
name|SATI_FAILURE_CHECK_RESPONSE_DATA
return|;
block|}
comment|/**     * Per SAT "Error and sense reporting" section.  All subsequent IOs after     * a device fault should receive INTERNAL TARGET FAILURE sense data.     */
if|if
condition|(
name|sati_device
operator|->
name|state
operator|==
name|SATI_DEVICE_STATE_DEVICE_FAULT_OCCURRED
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_HARDWARE_ERROR
argument_list|,
name|SCSI_ASC_INTERNAL_TARGET_FAILURE
argument_list|,
name|SCSI_ASCQ_INTERNAL_TARGET_FAILURE
argument_list|)
expr_stmt|;
return|return
name|SATI_FAILURE_CHECK_RESPONSE_DATA
return|;
block|}
if|if
condition|(
name|sequence
operator|->
name|state
operator|==
name|SATI_SEQUENCE_STATE_INITIAL
condition|)
block|{
name|sequence
operator|->
name|command_specific_data
operator|.
name|scratch
operator|=
literal|0
expr_stmt|;
name|sequence
operator|->
name|number_data_bytes_set
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SATI_TRANSPORT_SUPPORTS_SATA
block|{
name|U8
modifier|*
name|register_fis
init|=
name|sati_cb_get_h2d_register_fis_address
argument_list|(
name|ata_io
argument_list|)
decl_stmt|;
name|sati_set_sata_command_flag
argument_list|(
name|register_fis
argument_list|)
expr_stmt|;
name|sati_set_sata_fis_type
argument_list|(
name|register_fis
argument_list|,
name|SATA_FIS_TYPE_REGH2D
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|// SATI_TRANSPORT_SUPPORTS_SATA
comment|// Look at the first byte to determine the SCSI command to translate.
switch|switch
condition|(
name|sati_get_cdb_byte
argument_list|(
name|cdb
argument_list|,
literal|0
argument_list|)
condition|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_REPORT_LUNS
argument_list|)
case|case
name|SCSI_REPORT_LUNS
case|:
name|status
operator|=
name|sati_report_luns_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_REPORT_LUNS)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_INQUIRY
argument_list|)
case|case
name|SCSI_INQUIRY
case|:
name|status
operator|=
name|sati_inquiry_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_INQUIRY)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_MODE_SENSE
argument_list|)
case|case
name|SCSI_MODE_SENSE_6
case|:
name|status
operator|=
name|sati_mode_sense_6_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_MODE_SENSE_10
case|:
name|status
operator|=
name|sati_mode_sense_10_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_MODE_SENSE)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_MODE_SELECT
argument_list|)
case|case
name|SCSI_MODE_SELECT_6
case|:
name|status
operator|=
name|sati_mode_select_6_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_MODE_SELECT_10
case|:
name|status
operator|=
name|sati_mode_select_10_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_MODE_SELECT)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_TEST_UNIT_READY
argument_list|)
case|case
name|SCSI_TEST_UNIT_READY
case|:
name|status
operator|=
name|sati_test_unit_ready_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_TEST_UNIT_READY)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_READ_CAPACITY
argument_list|)
case|case
name|SCSI_READ_CAPACITY_10
case|:
name|status
operator|=
name|sati_read_capacity_10_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_SERVICE_ACTION_IN_16
case|:
if|if
condition|(
operator|(
name|sati_get_cdb_byte
argument_list|(
name|cdb
argument_list|,
literal|1
argument_list|)
operator|&
name|SCSI_SERVICE_ACTION_MASK
operator|)
operator|==
name|SCSI_SERVICE_ACTION_IN_CODES_READ_CAPACITY_16
condition|)
name|status
operator|=
name|sati_read_capacity_16_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
else|else
name|status
operator|=
name|SATI_FAILURE_CHECK_RESPONSE_DATA
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_READ_CAPACITY)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_REQUEST_SENSE
argument_list|)
case|case
name|SCSI_REQUEST_SENSE
case|:
name|status
operator|=
name|sati_request_sense_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_REQUEST_SENSE)
case|case
name|SCSI_READ_6
case|:
name|status
operator|=
name|sati_read_6_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_READ_10
case|:
name|status
operator|=
name|sati_read_10_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_READ_12
case|:
name|status
operator|=
name|sati_read_12_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_READ_16
case|:
name|status
operator|=
name|sati_read_16_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_WRITE_6
case|:
name|status
operator|=
name|sati_write_6_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_WRITE_10
case|:
name|status
operator|=
name|sati_write_10_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_WRITE_12
case|:
name|status
operator|=
name|sati_write_12_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_WRITE_16
case|:
name|status
operator|=
name|sati_write_16_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_VERIFY
argument_list|)
case|case
name|SCSI_VERIFY_10
case|:
name|status
operator|=
name|sati_verify_10_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_VERIFY_12
case|:
name|status
operator|=
name|sati_verify_12_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_VERIFY_16
case|:
name|status
operator|=
name|sati_verify_16_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_VERIFY)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_WRITE_AND_VERIFY
argument_list|)
expr|\
operator|&&
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_VERIFY
argument_list|)
expr|\
operator|&&
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_WRITE
argument_list|)
case|case
name|SCSI_WRITE_AND_VERIFY_10
case|:
name|status
operator|=
name|sati_write_and_verify_10_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_WRITE_AND_VERIFY_12
case|:
name|status
operator|=
name|sati_write_and_verify_12_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_WRITE_AND_VERIFY_16
case|:
name|status
operator|=
name|sati_write_and_verify_16_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|//    !defined(DISABLE_SATI_WRITE_AND_VERIFY)
comment|//&& !defined(DISABLE_SATI_VERIFY)
comment|//&& !defined(DISABLE_SATI_WRITE)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_REASSIGN_BLOCKS
argument_list|)
case|case
name|SCSI_REASSIGN_BLOCKS
case|:
name|status
operator|=
name|sati_reassign_blocks_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_REASSIGN_BLOCKS)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_SYNCHRONIZE_CACHE
argument_list|)
case|case
name|SCSI_SYNCHRONIZE_CACHE_10
case|:
case|case
name|SCSI_SYNCHRONIZE_CACHE_16
case|:
name|status
operator|=
name|sati_synchronize_cache_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_SYNCHRONIZE_CACHE)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_START_STOP_UNIT
argument_list|)
case|case
name|SCSI_START_STOP_UNIT
case|:
name|status
operator|=
name|sati_start_stop_unit_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_START_STOP_UNIT)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_WRITE_LONG
argument_list|)
case|case
name|SCSI_WRITE_LONG_10
case|:
case|case
name|SCSI_WRITE_LONG_16
case|:
name|status
operator|=
name|sati_write_long_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_WRITE_LONG)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_LOG_SENSE
argument_list|)
case|case
name|SCSI_LOG_SENSE
case|:
name|status
operator|=
name|sati_log_sense_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_LOG_SENSE)
case|case
name|SCSI_PERSISTENT_RESERVE_IN
case|:
case|case
name|SCSI_PERSISTENT_RESERVE_OUT
case|:
comment|//These commands are not supported by SATI
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_ILLEGAL_REQUEST
argument_list|,
name|SCSI_ASC_INVALID_COMMAND_OPERATION_CODE
argument_list|,
name|SCSI_ASCQ_INVALID_COMMAND_OPERATION_CODE
argument_list|)
expr_stmt|;
comment|//returning status now to keep sense data set above
return|return
name|SATI_FAILURE_CHECK_RESPONSE_DATA
return|;
break|break;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_UNMAP
argument_list|)
case|case
name|SCSI_UNMAP
case|:
name|status
operator|=
name|sati_unmap_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_UNMAP)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_ATA_PASSTHROUGH
argument_list|)
case|case
name|SCSI_ATA_PASSTHRU_12
case|:
name|status
operator|=
name|sati_passthrough_12_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_ATA_PASSTHRU_16
case|:
name|status
operator|=
name|sati_passthrough_16_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !define(DISABLE_SATI_ATA_PASSTHRU)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_READ_BUFFER
argument_list|)
case|case
name|SCSI_READ_BUFFER
case|:
name|status
operator|=
name|sati_read_buffer_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|//!defined(DISABLE_SATI_READ_BUFFER)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_WRITE_BUFFER
argument_list|)
case|case
name|SCSI_WRITE_BUFFER
case|:
name|status
operator|=
name|sati_write_buffer_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|//!defined(DISABLE_SATI_WRITE_BUFFER)
default|default:
name|status
operator|=
name|SATI_FAILURE_CHECK_RESPONSE_DATA
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|status
operator|==
name|SATI_FAILURE_CHECK_RESPONSE_DATA
operator|)
operator|&&
operator|!
operator|(
name|sequence
operator|->
name|is_sense_response_set
operator|)
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_ILLEGAL_REQUEST
argument_list|,
name|SCSI_ASC_INVALID_FIELD_IN_CDB
argument_list|,
name|SCSI_ASCQ_INVALID_FIELD_IN_CDB
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// -----------------------------------------------------------------------------
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_TASK_MANAGEMENT
argument_list|)
end_if

begin_function
name|SATI_STATUS
name|sati_translate_task_management
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|SATI_DEVICE_T
modifier|*
name|sati_device
parameter_list|,
name|void
modifier|*
name|scsi_task
parameter_list|,
name|void
modifier|*
name|ata_io
parameter_list|)
block|{
name|SATI_STATUS
name|status
init|=
name|SATI_FAILURE
decl_stmt|;
name|U8
name|task_function
init|=
name|sati_cb_get_task_function
argument_list|(
name|scsi_task
argument_list|)
decl_stmt|;
name|sequence
operator|->
name|device
operator|=
name|sati_device
expr_stmt|;
switch|switch
condition|(
name|task_function
condition|)
block|{
comment|/**        * @todo We need to update the ABORT_TASK and ABORT_TASK_SET to be        *       SAT compliant.        */
case|case
name|SCSI_TASK_REQUEST_ABORT_TASK
case|:
case|case
name|SCSI_TASK_REQUEST_LOGICAL_UNIT_RESET
case|:
name|status
operator|=
name|sati_lun_reset_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_task
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_TASK_REQUEST_ABORT_TASK_SET
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_ABORT_TASK_SET
argument_list|)
name|status
operator|=
name|sati_abort_task_set_translate_command
argument_list|(
name|sequence
argument_list|,
name|scsi_task
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
else|#
directive|else
name|status
operator|=
name|SATI_FAILURE
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
name|status
operator|=
name|SATI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// !defined(DISABLE_SATI_TASK_MANAGEMENT)
end_comment

begin_comment
comment|// -----------------------------------------------------------------------------
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_INQUIRY
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_READY_CAPACITY
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_MODE_SENSE
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_MODE_SELECT
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_REASSIGN_BLOCKS
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_START_STOP_UNIT
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_REQUEST_SENSE
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_WRITE_LONG
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_LOG_SENSE
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_UNMAP
argument_list|)
end_if

begin_function
specifier|static
name|SATI_STATUS
name|sati_check_data_io
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|)
block|{
if|if
condition|(
name|sequence
operator|->
name|state
operator|==
name|SATI_SEQUENCE_STATE_INCOMPLETE
condition|)
block|{
return|return
name|SATI_SEQUENCE_INCOMPLETE
return|;
block|}
elseif|else
if|if
condition|(
name|sequence
operator|->
name|number_data_bytes_set
operator|<
name|sequence
operator|->
name|allocation_length
condition|)
block|{
return|return
name|SATI_COMPLETE_IO_DONE_EARLY
return|;
block|}
else|else
block|{
return|return
name|SATI_COMPLETE
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|//    !defined(DISABLE_SATI_INQUIRY)
end_comment

begin_comment
comment|// || !defined(DISABLE_SATI_READY_CAPACITY)
end_comment

begin_comment
comment|// || !defined(DISABLE_SATI_MODE_SENSE)
end_comment

begin_comment
comment|// || !defined(DISABLE_SATI_MODE_SELECT)
end_comment

begin_comment
comment|// || !defined(DISABLE_SATI_REASSIGN_BLOCKS)
end_comment

begin_comment
comment|// || !defined(DISABLE_SATI_START_STOP_UNIT)
end_comment

begin_comment
comment|// || !defined(DISABLE_SATI_REQUEST_SENSE)
end_comment

begin_comment
comment|// || !defined(DISABLE_SATI_WRITE_LONG)
end_comment

begin_comment
comment|// || !defined(DISABLE_SATI_LOG_SENSE)
end_comment

begin_comment
comment|// || !defined(DISABLE_SATI_UNMAP)
end_comment

begin_comment
comment|// -----------------------------------------------------------------------------
end_comment

begin_function
name|SATI_STATUS
name|sati_translate_command_response
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|,
name|void
modifier|*
name|ata_io
parameter_list|)
block|{
name|SATI_STATUS
name|status
init|=
name|SATI_COMPLETE
decl_stmt|;
name|U8
modifier|*
name|register_fis
init|=
name|sati_cb_get_d2h_register_fis_address
argument_list|(
name|ata_io
argument_list|)
decl_stmt|;
name|U8
name|ata_status
decl_stmt|;
comment|/**     * If the device fault bit is set in the status register, then     * set the sense data and return.     */
name|ata_status
operator|=
operator|(
name|U8
operator|)
name|sati_get_ata_status
argument_list|(
name|register_fis
argument_list|)
expr_stmt|;
if|if
condition|(
name|ata_status
operator|&
name|ATA_STATUS_REG_DEVICE_FAULT_BIT
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_HARDWARE_ERROR
argument_list|,
name|SCSI_ASC_INTERNAL_TARGET_FAILURE
argument_list|,
name|SCSI_ASCQ_INTERNAL_TARGET_FAILURE
argument_list|)
expr_stmt|;
name|sequence
operator|->
name|device
operator|->
name|state
operator|=
name|SATI_DEVICE_STATE_DEVICE_FAULT_OCCURRED
expr_stmt|;
comment|// Make sure that the terminate sequence is called to allow
comment|// translation logic to perform any cleanup before the IO is completed.
name|sati_sequence_terminate
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
return|return
name|SATI_FAILURE_CHECK_RESPONSE_DATA
return|;
block|}
comment|// Look at the sequence type to determine the response translation method
comment|// to invoke.
switch|switch
condition|(
name|sequence
operator|->
name|type
condition|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_TEST_UNIT_READY
argument_list|)
case|case
name|SATI_SEQUENCE_TEST_UNIT_READY
case|:
name|status
operator|=
name|sati_test_unit_ready_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_TEST_UNIT_READY)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_INQUIRY
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_READY_CAPACITY
argument_list|)
expr|\
operator|||
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_MODE_SENSE
argument_list|)
case|case
name|SATI_SEQUENCE_INQUIRY_EXECUTE_DEVICE_DIAG
case|:
if|if
condition|(
name|ata_status
operator|&
name|ATA_STATUS_REG_ERROR_BIT
condition|)
block|{
name|U8
name|error
init|=
operator|(
name|U8
operator|)
name|sati_get_ata_error
argument_list|(
name|register_fis
argument_list|)
decl_stmt|;
name|status
operator|=
name|SATI_FAILURE_CHECK_RESPONSE_DATA
expr_stmt|;
name|sati_translate_error
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sati_inquiry_ata_information_finish_translation
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SATI_SEQUENCE_INQUIRY_STANDARD
case|:
case|case
name|SATI_SEQUENCE_INQUIRY_SUPPORTED_PAGES
case|:
case|case
name|SATI_SEQUENCE_INQUIRY_SERIAL_NUMBER
case|:
case|case
name|SATI_SEQUENCE_INQUIRY_BLOCK_DEVICE
case|:
case|case
name|SATI_SEQUENCE_INQUIRY_ATA_INFORMATION
case|:
case|case
name|SATI_SEQUENCE_INQUIRY_DEVICE_ID
case|:
case|case
name|SATI_SEQUENCE_READ_CAPACITY_10
case|:
case|case
name|SATI_SEQUENCE_READ_CAPACITY_16
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_CACHING
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_INFORMATIONAL_EXCP_CONTROL
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_READ_WRITE_ERROR
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_DISCONNECT_RECONNECT
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_CONTROL
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_POWER_CONDITION
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_6_ALL_PAGES
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_CACHING
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_INFORMATIONAL_EXCP_CONTROL
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_READ_WRITE_ERROR
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_CONTROL
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_POWER_CONDITION
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_DISCONNECT_RECONNECT
case|:
case|case
name|SATI_SEQUENCE_MODE_SENSE_10_ALL_PAGES
case|:
comment|// Did an error occur during the IO request?
if|if
condition|(
name|ata_status
operator|&
name|ATA_STATUS_REG_ERROR_BIT
condition|)
block|{
name|U8
name|error
init|=
operator|(
name|U8
operator|)
name|sati_get_ata_error
argument_list|(
name|register_fis
argument_list|)
decl_stmt|;
name|status
operator|=
name|SATI_FAILURE_CHECK_RESPONSE_DATA
expr_stmt|;
name|sati_translate_error
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|void
modifier|*
name|ata_data
init|=
name|sati_cb_get_ata_data_address
argument_list|(
name|ata_io
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_data
operator|==
name|NULL
condition|)
block|{
name|status
operator|=
name|SATI_FAILURE
expr_stmt|;
block|}
else|else
block|{
name|sati_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
endif|#
directive|endif
comment|//    !defined(DISABLE_SATI_INQUIRY)
comment|//&& !defined(DISABLE_SATI_READY_CAPACITY)
comment|//&& !defined(DISABLE_SATI_MODE_SENSE)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_MODE_SELECT
argument_list|)
case|case
name|SATI_SEQUENCE_MODE_SELECT_MODE_PAGE_CACHING
case|:
name|status
operator|=
name|sati_mode_select_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SATI_COMPLETE
condition|)
block|{
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SATI_SEQUENCE_MODE_SELECT_MODE_POWER_CONDITION
case|:
case|case
name|SATI_SEQUENCE_MODE_SELECT_MODE_INFORMATION_EXCEPT_CONTROL
case|:
comment|// Did an error occur during the IO request?
if|if
condition|(
name|ata_status
operator|&
name|ATA_STATUS_REG_ERROR_BIT
condition|)
block|{
name|U8
name|error
init|=
operator|(
name|U8
operator|)
name|sati_get_ata_error
argument_list|(
name|register_fis
argument_list|)
decl_stmt|;
name|status
operator|=
name|SATI_FAILURE_CHECK_RESPONSE_DATA
expr_stmt|;
name|sati_translate_error
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_MODE_SELECT)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_WRITE_AND_VERIFY
argument_list|)
case|case
name|SATI_SEQUENCE_WRITE_AND_VERIFY
case|:
if|if
condition|(
name|ata_status
operator|&
name|ATA_STATUS_REG_ERROR_BIT
condition|)
block|{
name|U8
name|error
init|=
operator|(
name|U8
operator|)
name|sati_get_ata_error
argument_list|(
name|register_fis
argument_list|)
decl_stmt|;
name|sati_translate_error
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
name|SATI_FAILURE_CHECK_RESPONSE_DATA
return|;
block|}
else|else
block|{
name|status
operator|=
name|sati_write_and_verify_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_WRITE_AND_VERIFY)
case|case
name|SATI_SEQUENCE_READ_6
case|:
case|case
name|SATI_SEQUENCE_READ_10
case|:
case|case
name|SATI_SEQUENCE_READ_12
case|:
case|case
name|SATI_SEQUENCE_READ_16
case|:
case|case
name|SATI_SEQUENCE_WRITE_6
case|:
case|case
name|SATI_SEQUENCE_WRITE_10
case|:
case|case
name|SATI_SEQUENCE_WRITE_12
case|:
case|case
name|SATI_SEQUENCE_WRITE_16
case|:
case|case
name|SATI_SEQUENCE_VERIFY_10
case|:
case|case
name|SATI_SEQUENCE_VERIFY_12
case|:
case|case
name|SATI_SEQUENCE_VERIFY_16
case|:
case|case
name|SATI_SEQUENCE_SYNCHRONIZE_CACHE
case|:
if|if
condition|(
name|ata_status
operator|&
name|ATA_STATUS_REG_ERROR_BIT
condition|)
block|{
name|U8
name|error
init|=
operator|(
name|U8
operator|)
name|sati_get_ata_error
argument_list|(
name|register_fis
argument_list|)
decl_stmt|;
name|status
operator|=
name|SATI_FAILURE_CHECK_RESPONSE_DATA
expr_stmt|;
name|sati_translate_error
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|sequence
operator|->
name|state
operator|==
name|SATI_SEQUENCE_STATE_READ_ERROR
condition|)
block|{
name|sati_scsi_read_error_sense_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_MEDIUM_ERROR
argument_list|,
name|SCSI_ASC_UNRECOVERED_READ_ERROR
argument_list|,
name|SCSI_ASCQ_UNRECOVERED_READ_ERROR
argument_list|)
expr_stmt|;
name|sequence
operator|->
name|state
operator|=
name|SATI_SEQUENCE_STATE_FINAL
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// We haven't satisified the transfer count from the original
comment|// SCSI CDB.  As a result, we need to re-issue the command
comment|// with updated logical block address and transfer count.
if|if
condition|(
name|sequence
operator|->
name|command_specific_data
operator|.
name|scratch
condition|)
block|{
comment|/** @todo update the contents of the CDB directly?  Should be                 *  done during previous command translation?                 */
name|status
operator|=
name|SATI_SEQUENCE_INCOMPLETE
expr_stmt|;
block|}
block|}
break|break;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_READ_BUFFER
argument_list|)
case|case
name|SATI_SEQUENCE_READ_BUFFER
case|:
name|status
operator|=
name|sati_read_buffer_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SATI_COMPLETE
condition|)
block|{
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|//!defined(DISABLE_SATI_READ_BUFFER)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_WRITE_BUFFER
argument_list|)
case|case
name|SATI_SEQUENCE_WRITE_BUFFER
case|:
case|case
name|SATI_SEQUENCE_WRITE_BUFFER_MICROCODE
case|:
name|status
operator|=
name|sati_write_buffer_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|//!defined(DISABLE_SATI_WRITE_BUFFER)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_REASSIGN_BLOCKS
argument_list|)
case|case
name|SATI_SEQUENCE_REASSIGN_BLOCKS
case|:
name|status
operator|=
name|sati_reassign_blocks_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SATI_COMPLETE
condition|)
block|{
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_REASSIGN_BLOCKS)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_START_STOP_UNIT
argument_list|)
case|case
name|SATI_SEQUENCE_START_STOP_UNIT
case|:
name|status
operator|=
name|sati_start_stop_unit_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SATI_COMPLETE
condition|)
block|{
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_START_STOP_UNIT)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_REQUEST_SENSE
argument_list|)
case|case
name|SATI_SEQUENCE_REQUEST_SENSE_SMART_RETURN_STATUS
case|:
case|case
name|SATI_SEQUENCE_REQUEST_SENSE_CHECK_POWER_MODE
case|:
name|status
operator|=
name|sati_request_sense_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SATI_COMPLETE
condition|)
block|{
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_REQUEST_SENSE)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_WRITE_LONG
argument_list|)
case|case
name|SATI_SEQUENCE_WRITE_LONG
case|:
name|status
operator|=
name|sati_write_long_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SATI_COMPLETE
condition|)
block|{
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_WRITE_LONG)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_LOG_SENSE
argument_list|)
case|case
name|SATI_SEQUENCE_LOG_SENSE_SUPPORTED_LOG_PAGE
case|:
case|case
name|SATI_SEQUENCE_LOG_SENSE_SELF_TEST_LOG_PAGE
case|:
case|case
name|SATI_SEQUENCE_LOG_SENSE_EXTENDED_SELF_TEST_LOG_PAGE
case|:
case|case
name|SATI_SEQUENCE_LOG_SENSE_INFO_EXCEPTION_LOG_PAGE
case|:
name|status
operator|=
name|sati_log_sense_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SATI_COMPLETE
condition|)
block|{
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_LOG_SENSE)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_UNMAP
argument_list|)
case|case
name|SATI_SEQUENCE_UNMAP
case|:
name|status
operator|=
name|sati_unmap_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SATI_COMPLETE
condition|)
block|{
name|status
operator|=
name|sati_check_data_io
argument_list|(
name|sequence
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_UNMAP)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_ATA_PASSTHROUGH
argument_list|)
case|case
name|SATI_SEQUENCE_ATA_PASSTHROUGH_12
case|:
case|case
name|SATI_SEQUENCE_ATA_PASSTHROUGH_16
case|:
name|status
operator|=
name|sati_passthrough_translate_response
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_ATA_PASSTHROUGH)
default|default:
name|status
operator|=
name|SATI_FAILURE_INVALID_SEQUENCE_TYPE
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// -----------------------------------------------------------------------------
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_TASK_MANAGEMENT
argument_list|)
end_if

begin_function
name|SATI_STATUS
name|sati_translate_task_response
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|,
name|void
modifier|*
name|ata_io
parameter_list|)
block|{
name|SATI_STATUS
name|status
init|=
name|SATI_FAILURE_CHECK_RESPONSE_DATA
decl_stmt|;
name|U8
modifier|*
name|register_fis
init|=
name|sati_cb_get_d2h_register_fis_address
argument_list|(
name|ata_io
argument_list|)
decl_stmt|;
name|U8
name|ata_status
decl_stmt|;
comment|/**     * If the device fault bit is set in the status register, then     * set the sense data and return.     */
name|ata_status
operator|=
operator|(
name|U8
operator|)
name|sati_get_ata_status
argument_list|(
name|register_fis
argument_list|)
expr_stmt|;
if|if
condition|(
name|ata_status
operator|&
name|ATA_STATUS_REG_DEVICE_FAULT_BIT
condition|)
block|{
name|sati_scsi_response_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_TASK_MGMT_FUNC_FAILED
argument_list|)
expr_stmt|;
return|return
name|SATI_FAILURE_CHECK_RESPONSE_DATA
return|;
block|}
comment|// Look at the sequence type to determine the response translation method
comment|// to invoke.
switch|switch
condition|(
name|sequence
operator|->
name|type
condition|)
block|{
case|case
name|SATI_SEQUENCE_LUN_RESET
case|:
if|if
condition|(
name|ata_status
operator|&
name|ATA_STATUS_REG_ERROR_BIT
condition|)
block|{
name|sati_scsi_response_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_TASK_MGMT_FUNC_FAILED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sati_scsi_response_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_TASK_MGMT_FUNC_COMPLETE
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|SATI_COMPLETE
expr_stmt|;
break|break;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_ABORT_TASK_SET
argument_list|)
case|case
name|SATI_SEQUENCE_ABORT_TASK_SET
case|:
if|if
condition|(
name|ata_status
operator|&
name|ATA_STATUS_REG_ERROR_BIT
condition|)
block|{
name|sati_scsi_response_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_TASK_MGMT_FUNC_FAILED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|void
modifier|*
name|ata_data
init|=
name|sati_cb_get_ata_data_address
argument_list|(
name|ata_io
argument_list|)
decl_stmt|;
if|if
condition|(
name|ata_data
operator|==
name|NULL
condition|)
block|{
name|status
operator|=
name|SATI_FAILURE
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|sati_abort_task_set_translate_data
argument_list|(
name|sequence
argument_list|,
name|ata_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
endif|#
directive|endif
comment|// !defined(DISABLE_SATI_ABORT_TASK_SET)
default|default:
name|status
operator|=
name|SATI_FAILURE_INVALID_SEQUENCE_TYPE
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// !defined(DISABLE_SATI_TASK_MANAGEMENT)
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|ENABLE_MINIMUM_MEMORY_MODE
argument_list|)
end_if

begin_function
name|U32
name|sati_get_sat_compliance_version
parameter_list|(
name|void
parameter_list|)
block|{
return|return
literal|2
return|;
comment|// Compliant with SAT-2.
block|}
end_function

begin_function
name|U32
name|sati_get_sat_compliance_version_revision
parameter_list|(
name|void
parameter_list|)
block|{
return|return
literal|7
return|;
comment|// Compliant with SAT-2 revision 7.
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// !defined(ENABLE_MINIMUM_MEMORY_MODE)
end_comment

begin_function
name|U16
name|sati_get_number_data_bytes_set
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|)
block|{
return|return
name|sequence
operator|->
name|number_data_bytes_set
return|;
block|}
end_function

begin_function
name|void
name|sati_sequence_construct
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|)
block|{
name|sequence
operator|->
name|state
operator|=
name|SATI_SEQUENCE_STATE_INITIAL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sati_sequence_terminate
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|,
name|void
modifier|*
name|ata_io
parameter_list|)
block|{
comment|// Decode the sequence type to determine how to handle the termination
comment|// of the the translation method.
switch|switch
condition|(
name|sequence
operator|->
name|type
condition|)
block|{
case|case
name|SATI_SEQUENCE_UNMAP
case|:
name|sati_unmap_terminate
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|ata_io
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

end_unit


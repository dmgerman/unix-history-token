begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * This file is provided under a dual BSD/GPLv2 license.  When using or  * redistributing this file, you may do so under either license.  *  * GPL LICENSE SUMMARY  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of version 2 of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it will be useful, but  * WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.  * The full GNU General Public License is included in this distribution  * in the file called LICENSE.GPL.  *  * BSD LICENSE  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in  *     the documentation and/or other materials provided with the  *     distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/**  * @file  *  * @brief This file contains the method implementations required to  *        translate the SCSI inquiry command.  *        The following (VPD) pages are currently supported:  *        - Standard  *        - Supported Pages  *        - Unit Serial Number  *        - Device Identification  */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_SATI_INQUIRY
argument_list|)
end_if

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_inquiry.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_callbacks.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sati_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_ata.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_scsi.h>
end_include

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* P R I V A T E   M E T H O D S
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/** * @brief This method builds the SCSI data associated with the SATI product *        revision that is commonly used on the Standard inquiry response and *        the ATA information page. * * @param[in]  sequence This parameter specifies the translator sequence *             object to be utilized during data translation. * @param[in]  ata_input_data This parameter specifies ata data received from *             the remote device. * @param[out] scsi_io This parameter specifies the user IO request for *             which to construct the standard inquiry data. * * @return none */
end_comment

begin_function
specifier|static
name|void
name|sati_inquiry_construct_product_revision
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|ata_input_data
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|)
block|{
name|ATA_IDENTIFY_DEVICE_DATA_T
modifier|*
name|identify
init|=
operator|(
name|ATA_IDENTIFY_DEVICE_DATA_T
operator|*
operator|)
name|ata_input_data
decl_stmt|;
comment|// Fill in the product revision level field.
comment|// Per SAT, copy portions of the firmware revision that is not filled
comment|// with spaces.  Some devices left-align their firmware rev ID, while
comment|// others right-align.
if|if
condition|(
operator|(
name|identify
operator|->
name|firmware_revision
index|[
literal|4
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|identify
operator|->
name|firmware_revision
index|[
literal|5
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|identify
operator|->
name|firmware_revision
index|[
literal|6
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|identify
operator|->
name|firmware_revision
index|[
literal|7
index|]
operator|==
literal|0x20
operator|)
condition|)
block|{
name|sati_ata_identify_device_copy_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|32
argument_list|,
name|ata_input_data
argument_list|,
name|ATA_IDENTIFY_DEVICE_GET_OFFSET
argument_list|(
name|firmware_revision
argument_list|)
argument_list|,
literal|4
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Since the last 4 bytes of the firmware revision are not spaces,
comment|// utilize these bytes as the firmware revision in the inquiry data.
name|sati_ata_identify_device_copy_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|32
argument_list|,
name|ata_input_data
argument_list|,
name|ATA_IDENTIFY_DEVICE_GET_OFFSET
argument_list|(
name|firmware_revision
argument_list|)
operator|+
literal|4
argument_list|,
literal|4
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* P U B L I C   M E T H O D S
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * @brief This method builds the SCSI data associated with a SCSI standard  *        inquiry request.  *  * @param[in]  sequence This parameter specifies the translator sequence  *             object to be utilized during data translation.  * @param[in]  ata_input_data This parameter specifies ata data received from  *             the remote device.  * @param[out] scsi_io This parameter specifies the user IO request for  *             which to construct the standard inquiry data.  *  * @return none  */
end_comment

begin_function
name|void
name|sati_inquiry_standard_translate_data
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|ata_input_data
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|)
block|{
name|ATA_IDENTIFY_DEVICE_DATA_T
modifier|*
name|identify
init|=
operator|(
name|ATA_IDENTIFY_DEVICE_DATA_T
operator|*
operator|)
name|ata_input_data
decl_stmt|;
name|U32
name|index
decl_stmt|;
comment|// Device type is disk, attached to this lun.
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|0
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|// If the device indicates it's a removable media device, then set the
comment|// RMB bit
if|if
condition|(
name|identify
operator|->
name|general_config_bits
operator|&
name|ATA_IDENTIFY_REMOVABLE_MEDIA_ENABLE
condition|)
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|1
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
else|else
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|1
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|2
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
comment|// Indicate SPC-3 support
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|3
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
comment|// Response Format SPC-3
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|4
argument_list|,
literal|62
argument_list|)
expr_stmt|;
comment|// 62 Additional Data Bytes.
comment|// n-4 per the spec, we end at
comment|// byte 66, so 66-4.
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|5
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|6
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|7
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
comment|// Enable Cmd Queueing
comment|// The Vender identification field is set to "ATA     "
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|8
argument_list|,
literal|0x41
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|9
argument_list|,
literal|0x54
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|10
argument_list|,
literal|0x41
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|11
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|12
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|13
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|14
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|15
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|// Fill in the product ID field.
name|sati_ata_identify_device_copy_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|16
argument_list|,
name|ata_input_data
argument_list|,
name|ATA_IDENTIFY_DEVICE_GET_OFFSET
argument_list|(
name|model_number
argument_list|)
argument_list|,
literal|16
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|sati_inquiry_construct_product_revision
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
comment|// Set the remaining fields up to the version descriptors to 0.
for|for
control|(
name|index
operator|=
literal|36
init|;
name|index
operator|<
literal|58
condition|;
name|index
operator|++
control|)
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|index
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// Add version descriptors for the various protocols in play.
comment|// SAM-4
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|58
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|59
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
comment|// SAS-2
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|60
argument_list|,
literal|0x0C
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|61
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|// SPC-4
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|62
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|63
argument_list|,
literal|0x60
argument_list|)
expr_stmt|;
comment|// SBC-3
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|64
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|65
argument_list|,
literal|0xC0
argument_list|)
expr_stmt|;
comment|// ATA/ATAPI-8 ACS
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|66
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|67
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method builds the SCSI data associated with an SCSI inquiry  *        for the supported VPD pages page.  *  * @param[in]  sequence This parameter specifies the translator sequence  *             object to be utilized during data translation.  * @param[out] scsi_io This parameter specifies the user IO request for  *             which to construct the supported VPD page information.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|sati_inquiry_supported_pages_translate_data
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|)
block|{
comment|// Formulate the SCSI output data for the caller.
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// Qualifier and Device Type
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|1
argument_list|,
name|SCSI_INQUIRY_SUPPORTED_PAGES_PAGE
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// Reserved.
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|// # VPD pages supported
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|4
argument_list|,
name|SCSI_INQUIRY_SUPPORTED_PAGES_PAGE
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|5
argument_list|,
name|SCSI_INQUIRY_UNIT_SERIAL_NUM_PAGE
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|6
argument_list|,
name|SCSI_INQUIRY_DEVICE_ID_PAGE
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|7
argument_list|,
name|SCSI_INQUIRY_ATA_INFORMATION_PAGE
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|8
argument_list|,
name|SCSI_INQUIRY_BLOCK_DEVICE_PAGE
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// End of the list
block|}
end_function

begin_comment
comment|/**  * @brief This method builds the SCSI data associated with a request for  *        the unit serial number vital product data (VPD) page.  *  * @param[in]  sequence This parameter specifies the translator sequence  *             object to be utilized during data translation.  * @param[in]  ata_input_data This parameter specifies ata data received from  *             the remote device.  * @param[out] scsi_io This parameter specifies the user IO request for  *             which to construct the unit serial number data.  *  * @return none  */
end_comment

begin_function
name|void
name|sati_inquiry_serial_number_translate_data
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|ata_input_data
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|)
block|{
comment|// Peripheral qualifier (0x0, currently connected)
comment|// Peripheral device type (0x0 direct-access block device)
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|0
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|1
argument_list|,
name|SCSI_INQUIRY_UNIT_SERIAL_NUM_PAGE
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|2
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|// Reserved
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|3
argument_list|,
name|ATA_IDENTIFY_SERIAL_NUMBER_LEN
argument_list|)
expr_stmt|;
name|sati_ata_identify_device_copy_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|4
argument_list|,
name|ata_input_data
argument_list|,
name|ATA_IDENTIFY_DEVICE_GET_OFFSET
argument_list|(
name|serial_number
argument_list|)
argument_list|,
name|ATA_IDENTIFY_SERIAL_NUMBER_LEN
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** * @brief This method builds the SCSI data associated with a request for *        the Block Device Characteristics vital product data (VPD) page. * * @param[in]  sequence This parameter specifies the translator sequence *             object to be utilized during data translation. * @param[in]  ata_input_data This parameter specifies ata data received from *             the remote device. * @param[out] scsi_io This parameter specifies the user IO request for *             which to construct the unit serial number data. * * @return none */
end_comment

begin_function
name|void
name|sati_inquiry_block_device_translate_data
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|ata_input_data
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|)
block|{
name|ATA_IDENTIFY_DEVICE_DATA_T
modifier|*
name|identify
init|=
operator|(
name|ATA_IDENTIFY_DEVICE_DATA_T
operator|*
operator|)
name|ata_input_data
decl_stmt|;
name|U32
name|offset
decl_stmt|;
comment|// Peripheral qualifier (0x0, currently connected)
comment|// Peripheral device type (0x0 direct-access block device)
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|0
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|1
argument_list|,
name|SCSI_INQUIRY_BLOCK_DEVICE_PAGE
argument_list|)
expr_stmt|;
comment|//PAGE LENGTH 0x003C
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|2
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|3
argument_list|,
name|SCSI_INQUIRY_BLOCK_DEVICE_LENGTH
argument_list|)
expr_stmt|;
name|sati_ata_identify_device_copy_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|4
argument_list|,
name|ata_input_data
argument_list|,
name|ATA_IDENTIFY_DEVICE_GET_OFFSET
argument_list|(
name|nominal_media_rotation_rate
argument_list|)
argument_list|,
literal|2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|6
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|7
argument_list|,
operator|(
name|identify
operator|->
name|device_nominal_form_factor
operator|&
literal|0x0F
operator|)
comment|// only need bits 0-3
argument_list|)
expr_stmt|;
comment|//bytes 8-63 are reserved
for|for
control|(
name|offset
operator|=
literal|8
init|;
name|offset
operator|<
literal|63
condition|;
name|offset
operator|++
control|)
block|{
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|offset
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method builds the SCSI data associated with a request for  *        the device identification vital product data (VPD) page.  *  * @param[in]  sequence This parameter specifies the translator sequence  *             object to be utilized during data translation.  * @param[in]  ata_input_data This parameter specifies ata data received from  *             the remote device.  * @param[out] scsi_io This parameter specifies the user IO request for  *             which to construct the device ID page.  *  * @return none  */
end_comment

begin_function
name|void
name|sati_inquiry_device_id_translate_data
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|ata_input_data
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|)
block|{
name|ATA_IDENTIFY_DEVICE_DATA_T
modifier|*
name|identify
init|=
operator|(
name|ATA_IDENTIFY_DEVICE_DATA_T
operator|*
operator|)
name|ata_input_data
decl_stmt|;
name|U16
name|byte_offset
init|=
literal|4
decl_stmt|;
name|U16
name|page_length
decl_stmt|;
comment|// Peripheral qualifier (0x0, currently connected)
comment|// Peripheral device type (0x0 direct-access block device)
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|0
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|1
argument_list|,
name|SCSI_INQUIRY_DEVICE_ID_PAGE
argument_list|)
expr_stmt|;
comment|/**     * If World Wide Names are supported by this target, then build an     * identification descriptor using the WWN.     */
if|if
condition|(
name|identify
operator|->
name|command_set_supported_extention
operator|&
name|ATA_IDENTIFY_COMMAND_SET_WWN_SUPPORT_ENABLE
condition|)
block|{
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|4
argument_list|,
name|SCSI_FC_PROTOCOL_IDENTIFIER
operator||
name|SCSI_BINARY_CODE_SET
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|5
argument_list|,
name|SCSI_LUN_ASSOCIATION
operator||
name|SCSI_NAA_IDENTIFIER_TYPE
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|7
argument_list|,
literal|0x08
argument_list|)
expr_stmt|;
comment|// WWN are 8 bytes long
comment|// Copy data from the identify device world wide name field into the
comment|// buffer.
name|sati_ata_identify_device_copy_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|8
argument_list|,
name|ata_input_data
argument_list|,
name|ATA_IDENTIFY_DEVICE_GET_OFFSET
argument_list|(
name|world_wide_name
argument_list|)
argument_list|,
name|ATA_IDENTIFY_WWN_LEN
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|byte_offset
operator|=
literal|16
expr_stmt|;
block|}
comment|/**     * Build a identification descriptor using the model number& serial number.     */
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
name|SCSI_FC_PROTOCOL_IDENTIFIER
operator||
name|SCSI_ASCII_CODE_SET
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
name|SCSI_LUN_ASSOCIATION
operator||
name|SCSI_T10_IDENTIFIER_TYPE
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
comment|// Identifier length (8 bytes for "ATA     " + 40 bytes from ATA IDENTIFY
comment|// model number field + 20 bytes from ATA IDENTIFY serial number field.
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|8
operator|+
operator|(
name|ATA_IDENTIFY_SERIAL_NUMBER_LEN
operator|)
operator|+
operator|(
name|ATA_IDENTIFY_MODEL_NUMBER_LEN
operator|)
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
comment|// Per SAT, write "ATA     ".
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|0x41
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|0x54
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|0x41
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
comment|// Copy data from the identify device model number field into the
comment|// buffer and update the byte_offset.
name|sati_ata_identify_device_copy_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
name|ata_input_data
argument_list|,
name|ATA_IDENTIFY_DEVICE_GET_OFFSET
argument_list|(
name|model_number
argument_list|)
argument_list|,
name|ATA_IDENTIFY_MODEL_NUMBER_LEN
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|byte_offset
operator|+=
name|ATA_IDENTIFY_MODEL_NUMBER_LEN
expr_stmt|;
comment|// Copy data from the identify device serial number field into the
comment|// buffer and update the byte_offset.
name|sati_ata_identify_device_copy_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
name|ata_input_data
argument_list|,
name|ATA_IDENTIFY_DEVICE_GET_OFFSET
argument_list|(
name|serial_number
argument_list|)
argument_list|,
name|ATA_IDENTIFY_SERIAL_NUMBER_LEN
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|byte_offset
operator|+=
name|ATA_IDENTIFY_SERIAL_NUMBER_LEN
expr_stmt|;
comment|/**     * If the target is contained in a SAS Domain, then build a target port     * ID descriptor using the SAS address.     */
if|#
directive|if
name|defined
argument_list|(
name|SATI_TRANSPORT_SUPPORTS_SAS
argument_list|)
expr|\
operator|&&
name|defined
argument_list|(
name|DISABLE_MSFT_SCSI_COMPLIANCE_SUPPORT
argument_list|)
block|{
name|SCI_SAS_ADDRESS_T
name|sas_address
decl_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
name|SCSI_SAS_PROTOCOL_IDENTIFIER
operator||
name|SCSI_BINARY_CODE_SET
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
name|SCSI_PIV_ENABLE
operator||
name|SCSI_TARGET_PORT_ASSOCIATION
operator||
name|SCSI_NAA_IDENTIFIER_TYPE
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|byte_offset
operator|++
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|// SAS Addr=8 bytes
name|byte_offset
operator|++
expr_stmt|;
name|sati_cb_device_get_sas_address
argument_list|(
name|scsi_io
argument_list|,
operator|&
name|sas_address
argument_list|)
expr_stmt|;
comment|// Store the SAS address in the target port descriptor.
name|sati_set_data_dword
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
name|sas_address
operator|.
name|high
argument_list|)
expr_stmt|;
name|byte_offset
operator|+=
literal|4
expr_stmt|;
name|sati_set_data_dword
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|byte_offset
argument_list|,
name|sas_address
operator|.
name|low
argument_list|)
expr_stmt|;
name|byte_offset
operator|+=
literal|4
expr_stmt|;
block|}
endif|#
directive|endif
comment|// SATI_TRANSPORT_SUPPORTS_SAS&& DISABLE_MSFT_SCSI_COMPLIANCE_SUPPORT
comment|/**     * Set the Page length field.  The page length is n-3, where n is the     * last offset in the page (considered page length - 4).     */
name|page_length
operator|=
name|byte_offset
operator|-
literal|4
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|2
argument_list|,
call|(
name|U8
call|)
argument_list|(
operator|(
name|page_length
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|3
argument_list|,
call|(
name|U8
call|)
argument_list|(
name|page_length
operator|&
literal|0x00FF
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** * @brief This method builds the SCSI data associated with a request for *        the  ATA information vital product data (VPD) page. * * @param[in]  sequence This parameter specifies the translator sequence *             object to be utilized during data translation. * @param[in]  ata_input_data This parameter specifies ata data received from *             a identify device command processed by the remote device. * @param[out] scsi_io This parameter specifies the user IO request for *             which to construct the ATA information page. * * @return none */
end_comment

begin_function
name|SATI_STATUS
name|sati_inquiry_ata_information_translate_data
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|ata_input_data
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|)
block|{
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|0
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|1
argument_list|,
name|SCSI_INQUIRY_ATA_INFORMATION_PAGE
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|2
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|3
argument_list|,
literal|0x38
argument_list|)
expr_stmt|;
comment|//Reserved SAT2r07
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|4
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|5
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|6
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|7
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|// The Vender identification field is set to "ATA     "
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|8
argument_list|,
literal|0x41
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|9
argument_list|,
literal|0x54
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|10
argument_list|,
literal|0x41
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|11
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|12
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|13
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|14
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|15
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|//SAT Product identification
name|sati_ata_identify_device_copy_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|16
argument_list|,
name|ata_input_data
argument_list|,
name|ATA_IDENTIFY_DEVICE_GET_OFFSET
argument_list|(
name|model_number
argument_list|)
argument_list|,
literal|16
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|//SAT Product Revision level bytes 32-35
name|sati_inquiry_construct_product_revision
argument_list|(
name|sequence
argument_list|,
name|ata_input_data
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
comment|//skipping ATA device signature for now
comment|//Command code
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|56
argument_list|,
literal|0xEC
argument_list|)
expr_stmt|;
comment|//Reserved SAT2r07
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|57
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|58
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|59
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|//copy all ATA identify device data
name|sati_ata_identify_device_copy_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|60
argument_list|,
name|ata_input_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ATA_IDENTIFY_DEVICE_DATA_T
argument_list|)
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|//Need to send ATA Execute Device Diagnostic command still
name|sequence
operator|->
name|state
operator|=
name|SATI_SEQUENCE_STATE_INCOMPLETE
expr_stmt|;
return|return
name|SATI_SEQUENCE_INCOMPLETE
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method will translate the inquiry SCSI command into  *        an ATA IDENTIFY DEVICE command.  It will handle several different  *        VPD pages and the standard inquiry page.  *        For more information on the parameters passed to this method,  *        please reference sati_translate_command().  *  * @return Indicate if the command translation succeeded.  * @retval SCI_SUCCESS This is returned if the command translation was  *         successful.  * @retval SATI_FAILURE_CHECK_RESPONSE_DATA This value is returned if  *         the page isn't supported, or the page code  *         field is not zero when the EVPD bit is 0.  */
end_comment

begin_function
name|SATI_STATUS
name|sati_inquiry_translate_command
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|,
name|void
modifier|*
name|ata_io
parameter_list|)
block|{
name|U8
modifier|*
name|cdb
init|=
name|sati_cb_get_cdb_address
argument_list|(
name|scsi_io
argument_list|)
decl_stmt|;
comment|/**     * SPC dictates:     * - that the page code field must be 0, if VPD enable is 0.     */
if|if
condition|(
operator|(
operator|(
name|sati_get_cdb_byte
argument_list|(
name|cdb
argument_list|,
literal|1
argument_list|)
operator|&
name|SCSI_INQUIRY_EVPD_ENABLE
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|sati_get_cdb_byte
argument_list|(
name|cdb
argument_list|,
literal|2
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_ILLEGAL_REQUEST
argument_list|,
name|SCSI_ASC_INVALID_FIELD_IN_CDB
argument_list|,
name|SCSI_ASCQ_INVALID_FIELD_IN_CDB
argument_list|)
expr_stmt|;
return|return
name|SATI_FAILURE_CHECK_RESPONSE_DATA
return|;
block|}
comment|// Set the data length based on the allocation length field in the CDB.
name|sequence
operator|->
name|allocation_length
operator|=
operator|(
name|sati_get_cdb_byte
argument_list|(
name|cdb
argument_list|,
literal|3
argument_list|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|sati_get_cdb_byte
argument_list|(
name|cdb
argument_list|,
literal|4
argument_list|)
operator|)
expr_stmt|;
comment|// Check to see if there was a request for the vital product data or just
comment|// the standard inquiry.
if|if
condition|(
name|sati_get_cdb_byte
argument_list|(
name|cdb
argument_list|,
literal|1
argument_list|)
operator|&
name|SCSI_INQUIRY_EVPD_ENABLE
condition|)
block|{
comment|// Parse the page code to determine which translator to invoke.
switch|switch
condition|(
name|sati_get_cdb_byte
argument_list|(
name|cdb
argument_list|,
literal|2
argument_list|)
condition|)
block|{
case|case
name|SCSI_INQUIRY_SUPPORTED_PAGES_PAGE
case|:
name|sequence
operator|->
name|type
operator|=
name|SATI_SEQUENCE_INQUIRY_SUPPORTED_PAGES
expr_stmt|;
name|sati_inquiry_supported_pages_translate_data
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|)
expr_stmt|;
return|return
name|SATI_COMPLETE
return|;
break|break;
case|case
name|SCSI_INQUIRY_UNIT_SERIAL_NUM_PAGE
case|:
name|sequence
operator|->
name|type
operator|=
name|SATI_SEQUENCE_INQUIRY_SERIAL_NUMBER
expr_stmt|;
break|break;
case|case
name|SCSI_INQUIRY_DEVICE_ID_PAGE
case|:
name|sequence
operator|->
name|type
operator|=
name|SATI_SEQUENCE_INQUIRY_DEVICE_ID
expr_stmt|;
break|break;
case|case
name|SCSI_INQUIRY_ATA_INFORMATION_PAGE
case|:
if|if
condition|(
name|sequence
operator|->
name|state
operator|==
name|SATI_SEQUENCE_STATE_INCOMPLETE
condition|)
block|{
name|sati_ata_execute_device_diagnostic_construct
argument_list|(
name|ata_io
argument_list|,
name|sequence
argument_list|)
expr_stmt|;
name|sequence
operator|->
name|type
operator|=
name|SATI_SEQUENCE_INQUIRY_EXECUTE_DEVICE_DIAG
expr_stmt|;
block|}
else|else
block|{
name|sequence
operator|->
name|type
operator|=
name|SATI_SEQUENCE_INQUIRY_ATA_INFORMATION
expr_stmt|;
block|}
break|break;
case|case
name|SCSI_INQUIRY_BLOCK_DEVICE_PAGE
case|:
name|sequence
operator|->
name|type
operator|=
name|SATI_SEQUENCE_INQUIRY_BLOCK_DEVICE
expr_stmt|;
break|break;
default|default:
name|sati_scsi_sense_data_construct
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|SCSI_STATUS_CHECK_CONDITION
argument_list|,
name|SCSI_SENSE_ILLEGAL_REQUEST
argument_list|,
name|SCSI_ASC_INVALID_FIELD_IN_CDB
argument_list|,
name|SCSI_ASCQ_INVALID_FIELD_IN_CDB
argument_list|)
expr_stmt|;
return|return
name|SATI_FAILURE_CHECK_RESPONSE_DATA
return|;
break|break;
block|}
block|}
else|else
block|{
name|sequence
operator|->
name|type
operator|=
name|SATI_SEQUENCE_INQUIRY_STANDARD
expr_stmt|;
block|}
name|sati_ata_identify_device_construct
argument_list|(
name|ata_io
argument_list|,
name|sequence
argument_list|)
expr_stmt|;
return|return
name|SATI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/** * @brief This method finishes the construction of the SCSI data associated          with a request for the  ATA information vital product data (VPD) page.          The ATA device signature is written into the data response from the          task fle registers after issuing a Execute Device Diagnostic command. * * @param[in]  sequence This parameter specifies the translator sequence *             object to be utilized during data translation. * @param[out] scsi_io This parameter specifies the user IO request for *             which to construct the ATA information page. * @param[in]  ata_io This parameter specifies the ATA payload *             buffer location and size to be translated. * * @return none */
end_comment

begin_function
name|void
name|sati_inquiry_ata_information_finish_translation
parameter_list|(
name|SATI_TRANSLATOR_SEQUENCE_T
modifier|*
name|sequence
parameter_list|,
name|void
modifier|*
name|scsi_io
parameter_list|,
name|void
modifier|*
name|ata_io
parameter_list|)
block|{
name|U8
modifier|*
name|register_fis
init|=
name|sati_cb_get_d2h_register_fis_address
argument_list|(
name|ata_io
argument_list|)
decl_stmt|;
name|U32
name|offset
decl_stmt|;
comment|//SATA transport
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|36
argument_list|,
literal|0x34
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|37
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|38
argument_list|,
operator|(
name|U8
operator|)
name|sati_get_ata_status
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|39
argument_list|,
operator|(
name|U8
operator|)
name|sati_get_ata_error
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|40
argument_list|,
name|sati_get_ata_lba_low
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|41
argument_list|,
name|sati_get_ata_lba_mid
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|42
argument_list|,
name|sati_get_ata_lba_high
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|43
argument_list|,
name|sati_get_ata_device
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|44
argument_list|,
name|sati_get_ata_lba_low_ext
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|45
argument_list|,
name|sati_get_ata_lba_mid_ext
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|46
argument_list|,
name|sati_get_ata_lba_high_ext
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|47
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|48
argument_list|,
name|sati_get_ata_sector_count
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
literal|49
argument_list|,
name|sati_get_ata_sector_count_exp
argument_list|(
name|register_fis
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
literal|50
init|;
name|offset
operator|<
literal|56
condition|;
name|offset
operator|++
control|)
block|{
name|sati_set_data_byte
argument_list|(
name|sequence
argument_list|,
name|scsi_io
argument_list|,
name|offset
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
block|}
name|sequence
operator|->
name|state
operator|=
name|SATI_SEQUENCE_STATE_FINAL
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// !defined(DISABLE_SATI_INQUIRY)
end_comment

end_unit


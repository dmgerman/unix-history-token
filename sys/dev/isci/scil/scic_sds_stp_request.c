begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * This file is provided under a dual BSD/GPLv2 license.  When using or  * redistributing this file, you may do so under either license.  *  * GPL LICENSE SUMMARY  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of version 2 of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it will be useful, but  * WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.  * The full GNU General Public License is included in this distribution  * in the file called LICENSE.GPL.  *  * BSD LICENSE  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in  *     the documentation and/or other materials provided with the  *     distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_sat.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_sata.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sci_types.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_remote_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_user_callback.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_remote_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_stp_request.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_stp_pio_request.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_logger.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/sci_environment.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sci_base_state_machine.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scu_task_context.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_ata.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sci_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_logger.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_request.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_stp_request.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scu_completion_codes.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scu_event_codes.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sci_base_state.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_unsolicited_frame_control.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_io_request.h>
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_ATAPI
argument_list|)
end_if

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_stp_packet_request.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * This macro returns the address of the stp h2d reg fis buffer in the io  * request memory  */
end_comment

begin_define
define|#
directive|define
name|scic_sds_stp_request_get_h2d_reg_buffer_unaligned
parameter_list|(
name|memory
parameter_list|)
define|\
value|((SATA_FIS_REG_H2D_T *)( \       ((char *)(memory)) + sizeof(SCIC_SDS_STP_REQUEST_T) \    ))
end_define

begin_comment
comment|/**  * This macro aligns the stp command buffer in DWORD alignment */
end_comment

begin_define
define|#
directive|define
name|scic_sds_stp_request_align_h2d_reg_buffer
parameter_list|(
name|address
parameter_list|)
define|\
value|((SATA_FIS_REG_H2D_T *)( \       (((POINTER_UINT)(address)) + (sizeof(U32) - 1)) \& ~(sizeof(U32)- 1) \       ))
end_define

begin_comment
comment|/**  * This macro returns the DWORD-aligned stp command buffer */
end_comment

begin_define
define|#
directive|define
name|scic_sds_stp_request_get_h2d_reg_buffer
parameter_list|(
name|memory
parameter_list|)
define|\
value|((SATA_FIS_REG_H2D_T *)  \        ((char *)scic_sds_stp_request_align_h2d_reg_buffer( \        (char *) scic_sds_stp_request_get_h2d_reg_buffer_unaligned(memory) \    )))
end_define

begin_comment
comment|/**  * This macro returns the address of the stp response buffer in the io  * request memory  */
end_comment

begin_define
define|#
directive|define
name|scic_sds_stp_request_get_response_buffer_unaligned
parameter_list|(
name|memory
parameter_list|)
define|\
value|((SATA_FIS_REG_D2H_T *)( \          ((char *)(scic_sds_stp_request_get_h2d_reg_buffer(memory))) \        + sizeof(SATA_FIS_REG_H2D_T) \    ))
end_define

begin_comment
comment|/**  * This macro aligns the stp response buffer in DWORD alignment */
end_comment

begin_define
define|#
directive|define
name|scic_sds_stp_request_align_response_buffer
parameter_list|(
name|address
parameter_list|)
define|\
value|((SATA_FIS_REG_D2H_T *)( \       (((POINTER_UINT)(address)) + (sizeof(U32) - 1)) \& ~(sizeof(U32)- 1) \    ))
end_define

begin_comment
comment|/**  * This macro returns the DWORD-aligned stp response buffer */
end_comment

begin_define
define|#
directive|define
name|scic_sds_stp_request_get_response_buffer
parameter_list|(
name|memory
parameter_list|)
define|\
value|((SATA_FIS_REG_D2H_T *)  \       ((char *)scic_sds_stp_request_align_response_buffer( \          (char *)scic_sds_stp_request_get_response_buffer_unaligned(memory) \    )))
end_define

begin_comment
comment|/**  * This macro returns the address of the task context buffer in the io  * request memory  */
end_comment

begin_define
define|#
directive|define
name|scic_sds_stp_request_get_task_context_buffer_unaligned
parameter_list|(
name|memory
parameter_list|)
define|\
value|((SCU_TASK_CONTEXT_T *)( \         ((char *)(scic_sds_stp_request_get_response_buffer(memory))) \       + sizeof(SCI_SSP_RESPONSE_IU_T) \    ))
end_define

begin_comment
comment|/**  * This macro returns the aligned task context buffer  */
end_comment

begin_define
define|#
directive|define
name|scic_sds_stp_request_get_task_context_buffer
parameter_list|(
name|memory
parameter_list|)
define|\
value|((SCU_TASK_CONTEXT_T *)( \       ((char *)scic_sds_request_align_task_context_buffer( \          (char *)scic_sds_stp_request_get_task_context_buffer_unaligned(memory)) \     )))
end_define

begin_comment
comment|/**  * This macro returns the address of the sgl elment pairs in the io request  * memory buffer  */
end_comment

begin_define
define|#
directive|define
name|scic_sds_stp_request_get_sgl_element_buffer
parameter_list|(
name|memory
parameter_list|)
define|\
value|((SCU_SGL_ELEMENT_PAIR_T *)( \         ((char *)(scic_sds_stp_request_get_task_context_buffer(memory))) \       + sizeof(SCU_TASK_CONTEXT_T) \     ))
end_define

begin_comment
comment|/**  * This method return the memory space commonly required for STP IO and  * task requests.  *  * @return U32  */
end_comment

begin_function
specifier|static
name|U32
name|scic_sds_stp_common_request_get_object_size
parameter_list|(
name|void
parameter_list|)
block|{
return|return
sizeof|sizeof
argument_list|(
name|SCIC_SDS_STP_REQUEST_T
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|SATA_FIS_REG_H2D_T
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|SATA_FIS_REG_D2H_T
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|SCU_TASK_CONTEXT_T
argument_list|)
operator|+
name|CACHE_LINE_SIZE
return|;
block|}
end_function

begin_comment
comment|/**  * This method return the memory space required for STP PIO requests.  *  * @return U32  */
end_comment

begin_function
name|U32
name|scic_sds_stp_request_get_object_size
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|scic_sds_stp_common_request_get_object_size
argument_list|()
operator|+
sizeof|sizeof
argument_list|(
name|SCU_SGL_ELEMENT_PAIR_T
argument_list|)
operator|*
name|SCU_MAX_SGL_ELEMENT_PAIRS
return|;
block|}
end_function

begin_comment
comment|/**  * This method return the memory space required for STP task requests.  *  * @return U32  */
end_comment

begin_function
name|U32
name|scic_sds_stp_task_request_get_object_size
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|scic_sds_stp_common_request_get_object_size
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/**  *  *  * @param[in] this_request  */
end_comment

begin_function
name|void
name|scic_sds_stp_request_assign_buffers
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|request
parameter_list|)
block|{
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|request
decl_stmt|;
name|this_request
operator|->
name|parent
operator|.
name|command_buffer
operator|=
name|scic_sds_stp_request_get_h2d_reg_buffer
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
name|this_request
operator|->
name|parent
operator|.
name|response_buffer
operator|=
name|scic_sds_stp_request_get_response_buffer
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
name|this_request
operator|->
name|parent
operator|.
name|sgl_element_pair_buffer
operator|=
name|scic_sds_stp_request_get_sgl_element_buffer
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
name|this_request
operator|->
name|parent
operator|.
name|sgl_element_pair_buffer
operator|=
name|scic_sds_request_align_sgl_element_buffer
argument_list|(
name|this_request
operator|->
name|parent
operator|.
name|sgl_element_pair_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_request
operator|->
name|parent
operator|.
name|was_tag_assigned_by_user
operator|==
name|FALSE
condition|)
block|{
name|this_request
operator|->
name|parent
operator|.
name|task_context_buffer
operator|=
name|scic_sds_stp_request_get_task_context_buffer
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method is will fill in the SCU Task Context for any type of  *        SATA request.  This is called from the various SATA constructors.  *  * @pre The general io request construction is complete.  * @pre The buffer assignment for the command buffer is complete.  *  * @param[in] this_request The general IO request object which is to be used  *       in constructing the SCU task context.  * @param[in] task_context The buffer pointer for the SCU task context which  *       is being constructed.  *  * @return none  *  * @todo Revisit task context construction to determine what is common for  *       SSP/SMP/STP task context structures.  */
end_comment

begin_function
name|void
name|scu_sata_reqeust_construct_task_context
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|SCU_TASK_CONTEXT_T
modifier|*
name|task_context
parameter_list|)
block|{
name|SCI_PHYSICAL_ADDRESS
name|physical_address
decl_stmt|;
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|owning_controller
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|target_device
decl_stmt|;
name|SCIC_SDS_PORT_T
modifier|*
name|target_port
decl_stmt|;
name|owning_controller
operator|=
name|scic_sds_request_get_controller
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
name|target_device
operator|=
name|scic_sds_request_get_device
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
name|target_port
operator|=
name|scic_sds_request_get_port
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
comment|// Fill in the TC with the its required data
name|task_context
operator|->
name|abort
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|priority
operator|=
name|SCU_TASK_PRIORITY_NORMAL
expr_stmt|;
name|task_context
operator|->
name|initiator_request
operator|=
literal|1
expr_stmt|;
name|task_context
operator|->
name|connection_rate
operator|=
name|scic_remote_device_get_connection_rate
argument_list|(
name|target_device
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|protocol_engine_index
operator|=
name|scic_sds_controller_get_protocol_engine_group
argument_list|(
name|owning_controller
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|logical_port_index
operator|=
name|scic_sds_port_get_index
argument_list|(
name|target_port
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|protocol_type
operator|=
name|SCU_TASK_CONTEXT_PROTOCOL_STP
expr_stmt|;
name|task_context
operator|->
name|valid
operator|=
name|SCU_TASK_CONTEXT_VALID
expr_stmt|;
name|task_context
operator|->
name|context_type
operator|=
name|SCU_TASK_CONTEXT_TYPE
expr_stmt|;
name|task_context
operator|->
name|remote_node_index
operator|=
name|scic_sds_remote_device_get_index
argument_list|(
name|this_request
operator|->
name|target_device
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|command_code
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|link_layer_control
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|do_not_dma_ssp_good_response
operator|=
literal|1
expr_stmt|;
name|task_context
operator|->
name|strict_ordering
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|control_frame
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|timeout_enable
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|block_guard_enable
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|address_modifier
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|task_phase
operator|=
literal|0x01
expr_stmt|;
name|task_context
operator|->
name|ssp_command_iu_length
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|SATA_FIS_REG_H2D_T
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
expr_stmt|;
comment|// Set the first word of the H2D REG FIS
name|task_context
operator|->
name|type
operator|.
name|words
index|[
literal|0
index|]
operator|=
operator|*
operator|(
name|U32
operator|*
operator|)
name|this_request
operator|->
name|command_buffer
expr_stmt|;
if|if
condition|(
name|this_request
operator|->
name|was_tag_assigned_by_user
condition|)
block|{
comment|// Build the task context now since we have already read the data
name|this_request
operator|->
name|post_context
operator|=
operator|(
name|SCU_CONTEXT_COMMAND_REQUEST_TYPE_POST_TC
operator||
operator|(
name|scic_sds_controller_get_protocol_engine_group
argument_list|(
name|owning_controller
argument_list|)
operator|<<
name|SCU_CONTEXT_COMMAND_PROTOCOL_ENGINE_GROUP_SHIFT
operator|)
operator||
operator|(
name|scic_sds_port_get_index
argument_list|(
name|target_port
argument_list|)
operator|<<
name|SCU_CONTEXT_COMMAND_LOGICAL_PORT_SHIFT
operator|)
operator||
name|scic_sds_io_tag_get_index
argument_list|(
name|this_request
operator|->
name|io_tag
argument_list|)
operator|)
expr_stmt|;
block|}
else|else
block|{
comment|// Build the task context now since we have already read the data
name|this_request
operator|->
name|post_context
operator|=
operator|(
name|SCU_CONTEXT_COMMAND_REQUEST_TYPE_POST_TC
operator||
operator|(
name|scic_sds_controller_get_protocol_engine_group
argument_list|(
name|owning_controller
argument_list|)
operator|<<
name|SCU_CONTEXT_COMMAND_PROTOCOL_ENGINE_GROUP_SHIFT
operator|)
operator||
operator|(
name|scic_sds_port_get_index
argument_list|(
name|target_port
argument_list|)
operator|<<
name|SCU_CONTEXT_COMMAND_LOGICAL_PORT_SHIFT
operator|)
comment|// This is not assigned because we have to wait until we get a TCi
operator|)
expr_stmt|;
block|}
comment|// Copy the physical address for the command buffer to the SCU Task Context
comment|// We must offset the command buffer by 4 bytes because the first 4 bytes are
comment|// transfered in the body of the TC
name|scic_cb_io_request_get_physical_address
argument_list|(
name|scic_sds_request_get_controller
argument_list|(
name|this_request
argument_list|)
argument_list|,
name|this_request
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|this_request
operator|->
name|command_buffer
operator|)
operator|+
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
argument_list|,
operator|&
name|physical_address
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|command_iu_upper
operator|=
name|sci_cb_physical_address_upper
argument_list|(
name|physical_address
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|command_iu_lower
operator|=
name|sci_cb_physical_address_lower
argument_list|(
name|physical_address
argument_list|)
expr_stmt|;
comment|// SATA Requests do not have a response buffer
name|task_context
operator|->
name|response_iu_upper
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|response_iu_lower
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform any general sata request construction.  *  * @todo What part of SATA IO request construction is general?  *  * @param[in] this_request  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_stp_non_ncq_request_construct
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|)
block|{
name|this_request
operator|->
name|has_started_substate_machine
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform request construction common to all types of  * STP requests that are optimized by the silicon (i.e. UDMA, NCQ).  *  * @param[in,out] this_request This parameter specifies the request to be  *                constructed as an optimized request.  * @param[in] optimized_task_type This parameter specifies whether the  *            request is to be an UDMA request or a NCQ request.  *            - A value of 0 indicates UDMA.  *            - A value of 1 indicates NCQ.  *  * @return This method returns an indication as to whether the construction  *         was successful.  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_stp_optimized_request_construct
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U8
name|optimized_task_type
parameter_list|,
name|U32
name|transfer_length
parameter_list|,
name|SCI_IO_REQUEST_DATA_DIRECTION
name|data_direction
parameter_list|)
block|{
name|SCU_TASK_CONTEXT_T
modifier|*
name|task_context
init|=
name|this_request
operator|->
name|task_context_buffer
decl_stmt|;
comment|// Build the STP task context structure
name|scu_sata_reqeust_construct_task_context
argument_list|(
name|this_request
argument_list|,
name|task_context
argument_list|)
expr_stmt|;
comment|// Copy over the number of bytes to be transfered
name|task_context
operator|->
name|transfer_length_bytes
operator|=
name|transfer_length
expr_stmt|;
if|if
condition|(
name|data_direction
operator|==
name|SCI_IO_REQUEST_DATA_OUT
condition|)
block|{
comment|// The difference between the DMA IN and DMA OUT request task type
comment|// values are consistent with the difference between FPDMA READ
comment|// and FPDMA WRITE values.  Add the supplied task type parameter
comment|// to this difference to set the task type properly for this
comment|// DATA OUT (WRITE) case.
name|task_context
operator|->
name|task_type
operator|=
name|optimized_task_type
operator|+
operator|(
name|SCU_TASK_TYPE_DMA_OUT
operator|-
name|SCU_TASK_TYPE_DMA_IN
operator|)
expr_stmt|;
block|}
else|else
block|{
comment|// For the DATA IN (READ) case, simply save the supplied
comment|// optimized task type.
name|task_context
operator|->
name|task_type
operator|=
name|optimized_task_type
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method performs the operations common to all SATA/STP requests  * utilizing the raw frame method.  *  * @param[in] this_request This parameter specifies the STP request object  *            for which to construct a RAW command frame task context.  * @param[in] task_context This parameter specifies the SCU specific  *            task context buffer to construct.  *  * @return none  */
end_comment

begin_function
name|void
name|scu_stp_raw_request_construct_task_context
parameter_list|(
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|SCU_TASK_CONTEXT_T
modifier|*
name|task_context
parameter_list|)
block|{
name|scu_sata_reqeust_construct_task_context
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|task_context
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|control_frame
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|priority
operator|=
name|SCU_TASK_PRIORITY_NORMAL
expr_stmt|;
name|task_context
operator|->
name|task_type
operator|=
name|SCU_TASK_TYPE_SATA_RAW_FRAME
expr_stmt|;
name|task_context
operator|->
name|type
operator|.
name|stp
operator|.
name|fis_type
operator|=
name|SATA_FIS_TYPE_REGH2D
expr_stmt|;
name|task_context
operator|->
name|transfer_length_bytes
operator|=
sizeof|sizeof
argument_list|(
name|SATA_FIS_REG_H2D_T
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will construct the STP Non-data request and its associated  * TC data.  A non-data request essentially behaves like a 0 length read  * request in the SCU.  *  * @param[in] this_request This parameter specifies the core request  *            object to construction into an STP/SATA non-data request.  *  * @return This method currently always returns SCI_SUCCESS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_stp_non_data_request_construct
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|)
block|{
name|scic_sds_stp_non_ncq_request_construct
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
comment|// Build the STP task context structure
name|scu_stp_raw_request_construct_task_context
argument_list|(
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|this_request
argument_list|,
name|this_request
operator|->
name|task_context_buffer
argument_list|)
expr_stmt|;
name|sci_base_state_machine_construct
argument_list|(
operator|&
name|this_request
operator|->
name|started_substate_machine
argument_list|,
operator|&
name|this_request
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_sds_stp_request_started_non_data_substate_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_NON_DATA_AWAIT_H2D_COMPLETION_SUBSTATE
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_function
name|SCI_STATUS
name|scic_sds_stp_soft_reset_request_construct
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|)
block|{
name|scic_sds_stp_non_ncq_request_construct
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
comment|// Build the STP task context structure
name|scu_stp_raw_request_construct_task_context
argument_list|(
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|this_request
argument_list|,
name|this_request
operator|->
name|task_context_buffer
argument_list|)
expr_stmt|;
name|sci_base_state_machine_construct
argument_list|(
operator|&
name|this_request
operator|->
name|started_substate_machine
argument_list|,
operator|&
name|this_request
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_sds_stp_request_started_soft_reset_substate_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_H2D_ASSERTED_COMPLETION_SUBSTATE
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method constructs the SATA request object.  *  * @param[in] this_request  * @param[in] sat_protocol  * @param[in] transfer_length  * @param[in] data_direction  * @param[in] copy_rx_frame  * @param[in] do_translate_sgl This parameter specifies whether SGL  *            translation should be performed or if the user is handling  *            it.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_io_request_construct_sata
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U8
name|sat_protocol
parameter_list|,
name|U32
name|transfer_length
parameter_list|,
name|SCI_IO_REQUEST_DATA_DIRECTION
name|data_direction
parameter_list|,
name|BOOL
name|copy_rx_frame
parameter_list|,
name|BOOL
name|do_translate_sgl
parameter_list|)
block|{
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|this_request
operator|->
name|protocol
operator|=
name|SCIC_STP_PROTOCOL
expr_stmt|;
name|this_request
operator|->
name|sat_protocol
operator|=
name|sat_protocol
expr_stmt|;
switch|switch
condition|(
name|sat_protocol
condition|)
block|{
case|case
name|SAT_PROTOCOL_FPDMA
case|:
name|scic_sds_stp_optimized_request_construct
argument_list|(
name|this_request
argument_list|,
name|SCU_TASK_TYPE_FPDMAQ_READ
argument_list|,
name|transfer_length
argument_list|,
name|data_direction
argument_list|)
expr_stmt|;
comment|// Copy over the SGL elements
if|if
condition|(
name|do_translate_sgl
operator|==
name|TRUE
condition|)
name|scic_sds_request_build_sgl
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_PROTOCOL_UDMA_DATA_IN
case|:
case|case
name|SAT_PROTOCOL_UDMA_DATA_OUT
case|:
name|scic_sds_stp_non_ncq_request_construct
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
name|scic_sds_stp_optimized_request_construct
argument_list|(
name|this_request
argument_list|,
name|SCU_TASK_TYPE_DMA_IN
argument_list|,
name|transfer_length
argument_list|,
name|data_direction
argument_list|)
expr_stmt|;
comment|// Copy over the SGL elements
if|if
condition|(
name|do_translate_sgl
operator|==
name|TRUE
condition|)
name|scic_sds_request_build_sgl
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
name|sci_base_state_machine_construct
argument_list|(
operator|&
name|this_request
operator|->
name|started_substate_machine
argument_list|,
operator|&
name|this_request
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_sds_stp_request_started_udma_substate_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_UDMA_AWAIT_TC_COMPLETION_SUBSTATE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_PROTOCOL_PIO_DATA_IN
case|:
case|case
name|SAT_PROTOCOL_PIO_DATA_OUT
case|:
name|status
operator|=
name|scic_sds_stp_pio_request_construct
argument_list|(
name|this_request
argument_list|,
name|sat_protocol
argument_list|,
name|copy_rx_frame
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_PROTOCOL_ATA_HARD_RESET
case|:
case|case
name|SAT_PROTOCOL_SOFT_RESET
case|:
name|status
operator|=
name|scic_sds_stp_soft_reset_request_construct
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_PROTOCOL_NON_DATA
case|:
name|status
operator|=
name|scic_sds_stp_non_data_request_construct
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_ATAPI
argument_list|)
case|case
name|SAT_PROTOCOL_PACKET_NON_DATA
case|:
case|case
name|SAT_PROTOCOL_PACKET_DMA_DATA_IN
case|:
case|case
name|SAT_PROTOCOL_PACKET_DMA_DATA_OUT
case|:
case|case
name|SAT_PROTOCOL_PACKET_PIO_DATA_IN
case|:
case|case
name|SAT_PROTOCOL_PACKET_PIO_DATA_OUT
case|:
name|status
operator|=
name|scic_sds_stp_packet_request_construct
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_translate_sgl
operator|==
name|TRUE
condition|)
name|scic_sds_request_build_sgl
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|SAT_PROTOCOL_DMA_QUEUED
case|:
case|case
name|SAT_PROTOCOL_DMA
case|:
case|case
name|SAT_PROTOCOL_DEVICE_DIAGNOSTIC
case|:
case|case
name|SAT_PROTOCOL_DEVICE_RESET
case|:
case|case
name|SAT_PROTOCOL_RETURN_RESPONSE_INFO
case|:
default|default:
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"SCIC IO Request 0x%x received un-handled SAT Protocol %d.\n"
operator|,
name|this_request
operator|,
name|sat_protocol
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_request_initialize_state_logging
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_CONSTRUCTED
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//* SCIC Interface Implementation
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_function
name|void
name|scic_stp_io_request_set_ncq_tag
parameter_list|(
name|SCI_IO_REQUEST_HANDLE_T
name|scic_io_request
parameter_list|,
name|U16
name|ncq_tag
parameter_list|)
block|{
comment|/**     * @note This could be made to return an error to the user if the user     *       attempts to set the NCQ tag in the wrong state.     */
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|scic_io_request
decl_stmt|;
name|this_request
operator|->
name|task_context_buffer
operator|->
name|type
operator|.
name|stp
operator|.
name|ncq_tag
operator|=
name|ncq_tag
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|void
modifier|*
name|scic_stp_io_request_get_h2d_reg_address
parameter_list|(
name|SCI_IO_REQUEST_HANDLE_T
name|scic_io_request
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|scic_io_request
decl_stmt|;
return|return
name|this_request
operator|->
name|command_buffer
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|void
modifier|*
name|scic_stp_io_request_get_d2h_reg_address
parameter_list|(
name|SCI_IO_REQUEST_HANDLE_T
name|scic_io_request
parameter_list|)
block|{
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|scic_io_request
decl_stmt|;
return|return
operator|&
name|this_request
operator|->
name|d2h_reg_fis
return|;
block|}
end_function

begin_comment
comment|/**  * Get the next SGL element from the request.  *    - Check on which SGL element pair we are working  *    - if working on SLG pair element A  *       - advance to element B  *    - else  *       - check to see if there are more SGL element pairs  *           for this IO request  *       - if there are more SGL element pairs  *          - advance to the next pair and return element A  *  * @param[in] this_request  *  * @return SCU_SGL_ELEMENT_T*  */
end_comment

begin_function
name|SCU_SGL_ELEMENT_T
modifier|*
name|scic_sds_stp_request_pio_get_next_sgl
parameter_list|(
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
parameter_list|)
block|{
name|SCU_SGL_ELEMENT_T
modifier|*
name|current_sgl
decl_stmt|;
if|if
condition|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_set
operator|==
name|SCU_SGL_ELEMENT_PAIR_A
condition|)
block|{
if|if
condition|(
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|B
operator|.
name|address_lower
operator|==
literal|0
operator|)
operator|&&
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|B
operator|.
name|address_upper
operator|==
literal|0
operator|)
condition|)
block|{
name|current_sgl
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_set
operator|=
name|SCU_SGL_ELEMENT_PAIR_B
expr_stmt|;
name|current_sgl
operator|=
operator|&
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|B
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|next_pair_lower
operator|==
literal|0
operator|)
operator|&&
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|next_pair_upper
operator|==
literal|0
operator|)
condition|)
block|{
name|current_sgl
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|=
name|scic_sds_request_get_sgl_element_pair
argument_list|(
operator|&
operator|(
name|this_request
operator|->
name|parent
operator|)
argument_list|,
operator|++
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|sgl_pair_index
argument_list|)
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_set
operator|=
name|SCU_SGL_ELEMENT_PAIR_A
expr_stmt|;
name|current_sgl
operator|=
operator|&
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|A
operator|)
expr_stmt|;
block|}
block|}
return|return
name|current_sgl
return|;
block|}
end_function

begin_comment
comment|/**  * This method will construct the SATA PIO request.  *  * @param[in] scic_io_request The core request object which is cast to a SATA  *            PIO request object.  *  * @return This method returns an indication as to whether the construction  *         was successful.  * @retval SCI_SUCCESS Currently this method always returns this value.  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_stp_pio_request_construct
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|scic_io_request
parameter_list|,
name|U8
name|sat_protocol
parameter_list|,
name|BOOL
name|copy_rx_frame
parameter_list|)
block|{
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
decl_stmt|;
name|this_request
operator|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|scic_io_request
expr_stmt|;
name|scic_sds_stp_non_ncq_request_construct
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|)
expr_stmt|;
name|scu_stp_raw_request_construct_task_context
argument_list|(
name|this_request
argument_list|,
name|this_request
operator|->
name|parent
operator|.
name|task_context_buffer
argument_list|)
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|current_transfer_bytes
operator|=
literal|0
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|ending_error
operator|=
literal|0
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|ending_status
operator|=
literal|0
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_offset
operator|=
literal|0
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_set
operator|=
name|SCU_SGL_ELEMENT_PAIR_A
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|sat_protocol
operator|=
name|sat_protocol
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|sgl_pair_index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|copy_rx_frame
operator|)
operator|||
operator|(
name|sat_protocol
operator|==
name|SAT_PROTOCOL_PIO_DATA_OUT
operator|)
condition|)
block|{
name|scic_sds_request_build_sgl
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|)
expr_stmt|;
comment|// Since the IO request copy of the TC contains the same data as
comment|// the actual TC this pointer is vaild for either.
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|=
operator|&
name|this_request
operator|->
name|parent
operator|.
name|task_context_buffer
operator|->
name|sgl_pair_ab
expr_stmt|;
block|}
else|else
block|{
comment|// The user does not want the data copied to the SGL buffer location
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|=
name|NULL
expr_stmt|;
block|}
name|sci_base_state_machine_construct
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|started_substate_machine
argument_list|,
operator|&
name|this_request
operator|->
name|parent
operator|.
name|parent
operator|.
name|parent
argument_list|,
name|scic_sds_stp_request_started_pio_substate_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_H2D_COMPLETION_SUBSTATE
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* STP NON-DATA STATE MACHINE
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * This method processes a TC completion.  The expected TC completion is  * for the transmission of the H2D register FIS containing the SATA/STP  * non-data request.  *  * @param[in] this_request  * @param[in] completion_code  *  * @return This method always successfully processes the TC completion.  * @retval SCI_SUCCESS This value is always returned.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_non_data_await_h2d_tc_completion_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U32
name|completion_code
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_sds_stp_request_non_data_await_h2d_tc_completion_handler(0x%x, 0x%x) enter\n"
operator|,
name|this_request
operator|,
name|completion_code
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SCU_GET_COMPLETION_TL_STATUS
argument_list|(
name|completion_code
argument_list|)
condition|)
block|{
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_GOOD
argument_list|)
case|:
name|scic_sds_request_set_status
argument_list|(
name|this_request
argument_list|,
name|SCU_TASK_DONE_GOOD
argument_list|,
name|SCI_SUCCESS
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_NON_DATA_AWAIT_D2H_SUBSTATE
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|// All other completion status cause the IO to be complete.  If a NAK
comment|// was received, then it is up to the user to retry the request.
name|scic_sds_request_set_status
argument_list|(
name|this_request
argument_list|,
name|SCU_NORMALIZE_COMPLETION_STATUS
argument_list|(
name|completion_code
argument_list|)
argument_list|,
name|SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method processes frames received from the target while waiting  * for a device to host register FIS.  If a non-register FIS is received  * during this time, it is treated as a protocol violation from an  * IO perspective.  *  * @param[in] request This parameter specifies the request for which a  *            frame has been received.  * @param[in] frame_index This parameter specifies the index of the frame  *            that has been received.  *  * @return Indicate if the received frame was processed successfully.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_non_data_await_d2h_frame_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|request
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SATA_FIS_HEADER_T
modifier|*
name|frame_header
decl_stmt|;
name|U32
modifier|*
name|frame_buffer
decl_stmt|;
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|request
decl_stmt|;
comment|// Save off the controller, so that we do not touch the request after it
comment|//  is completed.
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|owning_controller
init|=
name|this_request
operator|->
name|parent
operator|.
name|owning_controller
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_sds_stp_request_non_data_await_d2h_frame_handler(0x%x, 0x%x) enter\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|scic_sds_unsolicited_frame_control_get_header
argument_list|(
operator|&
operator|(
name|owning_controller
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_header
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
switch|switch
condition|(
name|frame_header
operator|->
name|fis_type
condition|)
block|{
case|case
name|SATA_FIS_TYPE_REGD2H
case|:
name|scic_sds_unsolicited_frame_control_get_buffer
argument_list|(
operator|&
operator|(
name|owning_controller
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_buffer
argument_list|)
expr_stmt|;
name|scic_sds_controller_copy_sata_response
argument_list|(
operator|&
name|this_request
operator|->
name|d2h_reg_fis
argument_list|,
operator|(
name|U32
operator|*
operator|)
name|frame_header
argument_list|,
name|frame_buffer
argument_list|)
expr_stmt|;
comment|// The command has completed with error
name|scic_sds_request_set_status
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|SCU_TASK_DONE_CHECK_RESPONSE
argument_list|,
name|SCI_FAILURE_IO_RESPONSE_VALID
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"IO Request:0x%x Frame Id:%d protocol violation occurred\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|)
argument_list|)
expr_stmt|;
name|scic_sds_request_set_status
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|SCU_TASK_DONE_UNEXP_FIS
argument_list|,
name|SCI_FAILURE_PROTOCOL_VIOLATION
argument_list|)
expr_stmt|;
break|break;
block|}
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
comment|// Frame has been decoded return it to the controller
name|scic_sds_controller_release_frame
argument_list|(
name|owning_controller
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"SCIC IO Request 0x%x could not get frame header for frame index %d, status %x\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCIC_SDS_IO_REQUEST_STATE_HANDLER_T
name|scic_sds_stp_request_started_non_data_substate_handler_table
index|[
name|SCIC_SDS_STP_REQUEST_STARTED_NON_DATA_MAX_SUBSTATES
index|]
init|=
block|{
comment|// SCIC_SDS_STP_REQUEST_STARTED_NON_DATA_AWAIT_H2D_COMPLETION_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_stp_request_non_data_await_h2d_tc_completion_handler
block|,
name|scic_sds_request_default_event_handler
block|,
name|scic_sds_request_default_frame_handler
block|}
block|,
comment|// SCIC_SDS_STP_REQUEST_STARTED_NON_DATA_AWAIT_D2H_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_request_default_tc_completion_handler
block|,
name|scic_sds_request_default_event_handler
block|,
name|scic_sds_stp_request_non_data_await_d2h_frame_handler
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_non_data_await_h2d_completion_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_non_data_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_NON_DATA_AWAIT_H2D_COMPLETION_SUBSTATE
argument_list|)
expr_stmt|;
name|scic_sds_remote_device_set_working_request
argument_list|(
name|this_request
operator|->
name|target_device
argument_list|,
name|this_request
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_non_data_await_d2h_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_non_data_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_NON_DATA_AWAIT_D2H_SUBSTATE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCI_BASE_STATE_T
name|scic_sds_stp_request_started_non_data_substate_table
index|[
name|SCIC_SDS_STP_REQUEST_STARTED_NON_DATA_MAX_SUBSTATES
index|]
init|=
block|{
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_NON_DATA_AWAIT_H2D_COMPLETION_SUBSTATE
block|,
name|scic_sds_stp_request_started_non_data_await_h2d_completion_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_NON_DATA_AWAIT_D2H_SUBSTATE
block|,
name|scic_sds_stp_request_started_non_data_await_d2h_enter
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* STP PIO STATE MACHINE
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_define
define|#
directive|define
name|SCU_MAX_FRAME_BUFFER_SIZE
value|0x400
end_define

begin_comment
comment|// 1K is the maximum SCU frame data payload
end_comment

begin_comment
comment|/**  * This function will transmit DATA_FIS from (current sgl + offset) for input parameter length.  * current sgl and offset is alreay stored in the IO request  *  * @param[in] this_request  * @param[in] length  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_pio_data_out_trasmit_data_frame
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U32
name|length
parameter_list|)
block|{
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|SCU_SGL_ELEMENT_T
modifier|*
name|current_sgl
decl_stmt|;
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_sds_stp_request
init|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|this_request
decl_stmt|;
comment|// Recycle the TC and reconstruct it for sending out DATA FIS containing
comment|// for the data from current_sgl+offset for the input length
name|SCU_TASK_CONTEXT_T
modifier|*
name|task_context
init|=
name|scic_sds_controller_get_task_context_buffer
argument_list|(
name|this_request
operator|->
name|owning_controller
argument_list|,
name|this_request
operator|->
name|io_tag
argument_list|)
decl_stmt|;
if|if
condition|(
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_set
operator|==
name|SCU_SGL_ELEMENT_PAIR_A
condition|)
block|{
name|current_sgl
operator|=
operator|&
operator|(
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|A
operator|)
expr_stmt|;
block|}
else|else
block|{
name|current_sgl
operator|=
operator|&
operator|(
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|B
operator|)
expr_stmt|;
block|}
comment|//update the TC
name|task_context
operator|->
name|command_iu_upper
operator|=
name|current_sgl
operator|->
name|address_upper
expr_stmt|;
name|task_context
operator|->
name|command_iu_lower
operator|=
name|current_sgl
operator|->
name|address_lower
expr_stmt|;
name|task_context
operator|->
name|transfer_length_bytes
operator|=
name|length
expr_stmt|;
name|task_context
operator|->
name|type
operator|.
name|stp
operator|.
name|fis_type
operator|=
name|SATA_FIS_TYPE_DATA
expr_stmt|;
comment|// send the new TC out.
name|status
operator|=
name|this_request
operator|->
name|owning_controller
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|continue_io_handler
argument_list|(
operator|&
name|this_request
operator|->
name|owning_controller
operator|->
name|parent
argument_list|,
operator|&
name|this_request
operator|->
name|target_device
operator|->
name|parent
argument_list|,
operator|&
name|this_request
operator|->
name|parent
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  *  * @param[in] this_request  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_pio_data_out_transmit_data
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_sds_request
parameter_list|)
block|{
name|SCU_SGL_ELEMENT_T
modifier|*
name|current_sgl
decl_stmt|;
name|U32
name|sgl_offset
decl_stmt|;
name|U32
name|remaining_bytes_in_current_sgl
init|=
literal|0
decl_stmt|;
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_sds_stp_request
init|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|this_sds_request
decl_stmt|;
name|sgl_offset
operator|=
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_offset
expr_stmt|;
if|if
condition|(
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_set
operator|==
name|SCU_SGL_ELEMENT_PAIR_A
condition|)
block|{
name|current_sgl
operator|=
operator|&
operator|(
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|A
operator|)
expr_stmt|;
name|remaining_bytes_in_current_sgl
operator|=
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|A
operator|.
name|length
operator|-
name|sgl_offset
expr_stmt|;
block|}
else|else
block|{
name|current_sgl
operator|=
operator|&
operator|(
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|B
operator|)
expr_stmt|;
name|remaining_bytes_in_current_sgl
operator|=
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|B
operator|.
name|length
operator|-
name|sgl_offset
expr_stmt|;
block|}
if|if
condition|(
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|>=
name|remaining_bytes_in_current_sgl
condition|)
block|{
comment|//recycle the TC and send the H2D Data FIS from (current sgl + sgl_offset) and length = remaining_bytes_in_current_sgl
name|status
operator|=
name|scic_sds_stp_request_pio_data_out_trasmit_data_frame
argument_list|(
name|this_sds_request
argument_list|,
name|remaining_bytes_in_current_sgl
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|-=
name|remaining_bytes_in_current_sgl
expr_stmt|;
name|sgl_offset
operator|=
literal|0
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|<
name|remaining_bytes_in_current_sgl
condition|)
block|{
comment|//recycle the TC and send the H2D Data FIS from (current sgl + sgl_offset) and length = type.pio.pio_transfer_bytes
name|scic_sds_stp_request_pio_data_out_trasmit_data_frame
argument_list|(
name|this_sds_request
argument_list|,
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
comment|//Sgl offset will be adjusted and saved for future
name|sgl_offset
operator|+=
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
expr_stmt|;
name|current_sgl
operator|->
name|address_lower
operator|+=
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
expr_stmt|;
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|this_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_offset
operator|=
name|sgl_offset
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * Copy the data from the buffer for the length specified to the IO reqeust  * SGL specified data region.  *  * @param[in] this_request The request that is used for the SGL processing.  * @param[in] data_buffer The buffer of data to be copied.  * @param[in] length  The length of the data transfer.  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_pio_data_in_copy_data_buffer
parameter_list|(
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U8
modifier|*
name|data_buffer
parameter_list|,
name|U32
name|length
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SCU_SGL_ELEMENT_T
modifier|*
name|current_sgl
decl_stmt|;
name|U32
name|sgl_offset
decl_stmt|;
name|U32
name|data_offset
decl_stmt|;
name|U8
modifier|*
name|source_address
decl_stmt|;
comment|// Initial setup to get the current working SGL and the offset within the buffer
name|current_sgl
operator|=
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_set
operator|==
name|SCU_SGL_ELEMENT_PAIR_A
operator|)
condition|?
operator|&
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|A
operator|)
else|:
operator|&
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|->
name|B
operator|)
expr_stmt|;
name|sgl_offset
operator|=
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_offset
expr_stmt|;
name|source_address
operator|=
name|data_buffer
expr_stmt|;
name|data_offset
operator|=
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|current_transfer_bytes
expr_stmt|;
name|status
operator|=
name|SCI_SUCCESS
expr_stmt|;
comment|// While we are still doing Ok and there is more data to transfer
while|while
condition|(
operator|(
name|length
operator|>
literal|0
operator|)
operator|&&
operator|(
name|status
operator|==
name|SCI_SUCCESS
operator|)
condition|)
block|{
if|if
condition|(
name|current_sgl
operator|->
name|length
operator|==
name|sgl_offset
condition|)
block|{
comment|// This SGL has been exauhasted so we need to get the next SGL
name|current_sgl
operator|=
name|scic_sds_stp_request_pio_get_next_sgl
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|current_sgl
operator|==
name|NULL
condition|)
name|status
operator|=
name|SCI_FAILURE
expr_stmt|;
else|else
name|sgl_offset
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|ENABLE_OSSL_COPY_BUFFER
name|scic_cb_io_request_copy_buffer
argument_list|(
name|this_request
argument_list|,
name|data_buffer
argument_list|,
name|data_offset
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|length
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|U8
modifier|*
name|destination_address
decl_stmt|;
name|U32
name|copy_length
decl_stmt|;
name|destination_address
operator|=
operator|(
name|U8
operator|*
operator|)
name|scic_cb_io_request_get_virtual_address_from_sgl
argument_list|(
name|this_request
argument_list|,
name|data_offset
argument_list|)
expr_stmt|;
name|copy_length
operator|=
name|MIN
argument_list|(
name|length
argument_list|,
name|current_sgl
operator|->
name|length
operator|-
name|sgl_offset
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|destination_address
argument_list|,
name|source_address
argument_list|,
name|copy_length
argument_list|)
expr_stmt|;
name|length
operator|-=
name|copy_length
expr_stmt|;
name|sgl_offset
operator|+=
name|copy_length
expr_stmt|;
name|data_offset
operator|+=
name|copy_length
expr_stmt|;
name|source_address
operator|+=
name|copy_length
expr_stmt|;
endif|#
directive|endif
block|}
block|}
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_offset
operator|=
name|sgl_offset
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * Copy the data buffer to the io request data region.  *  * @param[in] this_request The PIO DATA IN request that is to receive the  *       data.  * @param[in] data_buffer The buffer to copy from.  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_pio_data_in_copy_data
parameter_list|(
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U8
modifier|*
name|data_buffer
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
comment|// If there is less than 1K remaining in the transfer request
comment|// copy just the data for the transfer
if|if
condition|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|<
name|SCU_MAX_FRAME_BUFFER_SIZE
condition|)
block|{
name|status
operator|=
name|scic_sds_stp_request_pio_data_in_copy_data_buffer
argument_list|(
name|this_request
argument_list|,
name|data_buffer
argument_list|,
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
comment|// All data for this PIO request has now been copied, so we don't
comment|//  technically need to update current_transfer_bytes here - just
comment|//  doing it for completeness.
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|current_transfer_bytes
operator|+=
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// We are transfering the whole frame so copy
name|status
operator|=
name|scic_sds_stp_request_pio_data_in_copy_data_buffer
argument_list|(
name|this_request
argument_list|,
name|data_buffer
argument_list|,
name|SCU_MAX_FRAME_BUFFER_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|-=
name|SCU_MAX_FRAME_BUFFER_SIZE
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|current_transfer_bytes
operator|+=
name|SCU_MAX_FRAME_BUFFER_SIZE
expr_stmt|;
block|}
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  *  * @param[in] this_request  * @param[in] completion_code  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_pio_await_h2d_completion_tc_completion_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U32
name|completion_code
parameter_list|)
block|{
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_sds_stp_request_pio_data_in_await_h2d_completion_tc_completion_handler(0x%x, 0x%x) enter\n"
operator|,
name|this_request
operator|,
name|completion_code
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SCU_GET_COMPLETION_TL_STATUS
argument_list|(
name|completion_code
argument_list|)
condition|)
block|{
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_GOOD
argument_list|)
case|:
name|scic_sds_request_set_status
argument_list|(
name|this_request
argument_list|,
name|SCU_TASK_DONE_GOOD
argument_list|,
name|SCI_SUCCESS
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_FRAME_SUBSTATE
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|// All other completion status cause the IO to be complete.  If a NAK
comment|// was received, then it is up to the user to retry the request.
name|scic_sds_request_set_status
argument_list|(
name|this_request
argument_list|,
name|SCU_NORMALIZE_COMPLETION_STATUS
argument_list|(
name|completion_code
argument_list|)
argument_list|,
name|SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  *  * @param[in] this_request  * @param[in] frame_index  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_pio_await_frame_frame_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|request
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SATA_FIS_HEADER_T
modifier|*
name|frame_header
decl_stmt|;
name|U32
modifier|*
name|frame_buffer
decl_stmt|;
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
decl_stmt|;
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|owning_controller
decl_stmt|;
name|this_request
operator|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|request
expr_stmt|;
comment|// Save off the controller, so that we do not touch the request after it
comment|//  is completed.
name|owning_controller
operator|=
name|this_request
operator|->
name|parent
operator|.
name|owning_controller
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_sds_stp_request_pio_data_in_await_frame_frame_handler(0x%x, 0x%x) enter\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|scic_sds_unsolicited_frame_control_get_header
argument_list|(
operator|&
operator|(
name|owning_controller
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_header
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
switch|switch
condition|(
name|frame_header
operator|->
name|fis_type
condition|)
block|{
case|case
name|SATA_FIS_TYPE_PIO_SETUP
case|:
comment|// Get from the frame buffer the PIO Setup Data
name|scic_sds_unsolicited_frame_control_get_buffer
argument_list|(
operator|&
operator|(
name|owning_controller
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_buffer
argument_list|)
expr_stmt|;
comment|// Get the data from the PIO Setup
comment|// The SCU Hardware returns first word in the frame_header and the rest
comment|// of the data is in the frame buffer so we need to back up one dword
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|=
call|(
name|U16
call|)
argument_list|(
operator|(
name|SATA_FIS_PIO_SETUP_T
operator|*
operator|)
operator|(
operator|&
name|frame_buffer
index|[
operator|-
literal|1
index|]
operator|)
argument_list|)
operator|->
name|transfter_count
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|ending_status
operator|=
call|(
name|U8
call|)
argument_list|(
operator|(
name|SATA_FIS_PIO_SETUP_T
operator|*
operator|)
operator|(
operator|&
name|frame_buffer
index|[
operator|-
literal|1
index|]
operator|)
argument_list|)
operator|->
name|ending_status
expr_stmt|;
name|scic_sds_controller_copy_sata_response
argument_list|(
operator|&
name|this_request
operator|->
name|d2h_reg_fis
argument_list|,
operator|(
name|U32
operator|*
operator|)
name|frame_header
argument_list|,
name|frame_buffer
argument_list|)
expr_stmt|;
name|this_request
operator|->
name|d2h_reg_fis
operator|.
name|status
operator|=
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|ending_status
expr_stmt|;
comment|//The next state is dependent on whether the request was PIO Data-in or Data out
if|if
condition|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|sat_protocol
operator|==
name|SAT_PROTOCOL_PIO_DATA_IN
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_DATA_IN_AWAIT_DATA_SUBSTATE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|sat_protocol
operator|==
name|SAT_PROTOCOL_PIO_DATA_OUT
condition|)
block|{
comment|//Transmit data
name|status
operator|=
name|scic_sds_stp_request_pio_data_out_transmit_data
argument_list|(
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_DATA_OUT_TRANSMIT_DATA_SUBSTATE
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|SATA_FIS_TYPE_SETDEVBITS
case|:
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_FRAME_SUBSTATE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SATA_FIS_TYPE_REGD2H
case|:
if|if
condition|(
operator|(
name|frame_header
operator|->
name|status
operator|&
name|ATA_STATUS_REG_BSY_BIT
operator|)
operator|==
literal|0
condition|)
block|{
name|scic_sds_unsolicited_frame_control_get_buffer
argument_list|(
operator|&
operator|(
name|owning_controller
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_buffer
argument_list|)
expr_stmt|;
name|scic_sds_controller_copy_sata_response
argument_list|(
operator|&
name|this_request
operator|->
name|d2h_reg_fis
argument_list|,
operator|(
name|U32
operator|*
operator|)
name|frame_header
argument_list|,
name|frame_buffer
argument_list|)
expr_stmt|;
name|scic_sds_request_set_status
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|SCU_TASK_DONE_CHECK_RESPONSE
argument_list|,
name|SCI_FAILURE_IO_RESPONSE_VALID
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Now why is the drive sending a D2H Register FIS when it is still busy?
comment|// Do nothing since we are still in the right state.
name|SCIC_LOG_INFO
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"SCIC PIO Request 0x%x received D2H Register FIS with BSY status 0x%x\n"
operator|,
name|this_request
operator|,
name|frame_header
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
comment|// Frame is decoded return it to the controller
name|scic_sds_controller_release_frame
argument_list|(
name|owning_controller
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"SCIC IO Request 0x%x could not get frame header for frame index %d, status %x\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  *  * @param[in] this_request  * @param[in] frame_index  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_pio_data_in_await_data_frame_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|request
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SATA_FIS_HEADER_T
modifier|*
name|frame_header
decl_stmt|;
name|SATA_FIS_DATA_T
modifier|*
name|frame_buffer
decl_stmt|;
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
decl_stmt|;
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|owning_controller
decl_stmt|;
name|this_request
operator|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|request
expr_stmt|;
comment|// Save off the controller, so that we do not touch the request after it
comment|//  is completed.
name|owning_controller
operator|=
name|this_request
operator|->
name|parent
operator|.
name|owning_controller
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_sds_stp_request_pio_data_in_await_data_frame_handler(0x%x, 0x%x) enter\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|scic_sds_unsolicited_frame_control_get_header
argument_list|(
operator|&
operator|(
name|owning_controller
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_header
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
if|if
condition|(
name|frame_header
operator|->
name|fis_type
operator|==
name|SATA_FIS_TYPE_DATA
condition|)
block|{
if|if
condition|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|request_current
operator|.
name|sgl_pair
operator|==
name|NULL
condition|)
block|{
name|this_request
operator|->
name|parent
operator|.
name|saved_rx_frame_index
operator|=
name|frame_index
expr_stmt|;
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|scic_sds_unsolicited_frame_control_get_buffer
argument_list|(
operator|&
operator|(
name|owning_controller
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_buffer
argument_list|)
expr_stmt|;
name|status
operator|=
name|scic_sds_stp_request_pio_data_in_copy_data
argument_list|(
name|this_request
argument_list|,
operator|(
name|U8
operator|*
operator|)
name|frame_buffer
argument_list|)
expr_stmt|;
comment|// Frame is decoded return it to the controller
name|scic_sds_controller_release_frame
argument_list|(
name|owning_controller
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
block|}
comment|// Check for the end of the transfer, are there more bytes remaining
comment|// for this data transfer
if|if
condition|(
operator|(
name|status
operator|==
name|SCI_SUCCESS
operator|)
operator|&&
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|this_request
operator|->
name|type
operator|.
name|pio
operator|.
name|ending_status
operator|&
name|ATA_STATUS_REG_BSY_BIT
operator|)
operator|==
literal|0
condition|)
block|{
name|scic_sds_request_set_status
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|SCU_TASK_DONE_CHECK_RESPONSE
argument_list|,
name|SCI_FAILURE_IO_RESPONSE_VALID
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_FRAME_SUBSTATE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"SCIC PIO Request 0x%x received frame %d with fis type 0x%02x when expecting a data fis.\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|,
name|frame_header
operator|->
name|fis_type
operator|)
argument_list|)
expr_stmt|;
name|scic_sds_request_set_status
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|SCU_TASK_DONE_GOOD
argument_list|,
name|SCI_FAILURE_IO_REQUIRES_SCSI_ABORT
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
comment|// Frame is decoded return it to the controller
name|scic_sds_controller_release_frame
argument_list|(
name|owning_controller
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"SCIC IO Request 0x%x could not get frame header for frame index %d, status %x\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  *  *  * @param[in] this_request  * @param[in] completion_code  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_pio_data_out_await_data_transmit_completion_tc_completion_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U32
name|completion_code
parameter_list|)
block|{
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|BOOL
name|all_frames_transferred
init|=
name|FALSE
decl_stmt|;
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_scic_sds_stp_request
init|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|this_request
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_sds_stp_request_pio_data_in_await_h2d_completion_tc_completion_handler(0x%x, 0x%x) enter\n"
operator|,
name|this_request
operator|,
name|completion_code
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SCU_GET_COMPLETION_TL_STATUS
argument_list|(
name|completion_code
argument_list|)
condition|)
block|{
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_GOOD
argument_list|)
case|:
comment|//Transmit data
if|if
condition|(
name|this_scic_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|scic_sds_stp_request_pio_data_out_transmit_data
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
if|if
condition|(
name|this_scic_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|==
literal|0
condition|)
name|all_frames_transferred
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|this_scic_sds_stp_request
operator|->
name|type
operator|.
name|pio
operator|.
name|pio_transfer_bytes
operator|==
literal|0
condition|)
block|{
comment|//this will happen if the all data is written at the first time after the pio setup fis is recieved
name|all_frames_transferred
operator|=
name|TRUE
expr_stmt|;
block|}
comment|//all data transferred.
if|if
condition|(
name|all_frames_transferred
condition|)
block|{
comment|//Change the state to SCIC_SDS_STP_REQUEST_STARTED_PIO_DATA_IN_AWAIT_FRAME_SUBSTATE
comment|//and wait for PIO_SETUP fis / or D2H REg fis.
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_FRAME_SUBSTATE
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|// All other completion status cause the IO to be complete.  If a NAK
comment|// was received, then it is up to the user to retry the request.
name|scic_sds_request_set_status
argument_list|(
name|this_request
argument_list|,
name|SCU_NORMALIZE_COMPLETION_STATUS
argument_list|(
name|completion_code
argument_list|)
argument_list|,
name|SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * This method will handle any link layer events while waiting for the data  * frame.  *  * @param[in] request This is the request which is receiving the event.  * @param[in] event_code This is the event code that the request on which the  *       request is expected to take action.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  * @retval SCI_FAILURE  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_pio_data_in_await_data_event_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|request
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_specifier
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_TASK_DONE_CRC_ERR
operator|<<
name|SCU_EVENT_SPECIFIC_CODE_SHIFT
case|:
comment|// We are waiting for data and the SCU has R_ERR the data frame.
comment|// Go back to waiting for the D2H Register FIS
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|request
operator|->
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_FRAME_SUBSTATE
argument_list|)
expr_stmt|;
name|status
operator|=
name|SCI_SUCCESS
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"SCIC PIO Request 0x%x received unexpected event 0x%08x\n"
operator|,
name|request
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
comment|/// @todo Should we fail the PIO request when we get an unexpected event?
name|status
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCIC_SDS_IO_REQUEST_STATE_HANDLER_T
name|scic_sds_stp_request_started_pio_substate_handler_table
index|[
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_MAX_SUBSTATES
index|]
init|=
block|{
comment|// SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_H2D_COMPLETION_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_stp_request_pio_await_h2d_completion_tc_completion_handler
block|,
name|scic_sds_request_default_event_handler
block|,
name|scic_sds_request_default_frame_handler
block|}
block|,
comment|// SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_FRAME_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
comment|//scic_sds_stp_pio_request_data_in_await_frame_abort_handler,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_request_default_tc_completion_handler
block|,
name|scic_sds_request_default_event_handler
block|,
name|scic_sds_stp_request_pio_await_frame_frame_handler
block|}
block|,
comment|// SCIC_SDS_STP_REQUEST_STARTED_PIO_DATA_IN_AWAIT_DATA_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
comment|//scic_sds_stp_pio_request_data_in_await_data_abort_handler,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_request_default_tc_completion_handler
block|,
name|scic_sds_stp_request_pio_data_in_await_data_event_handler
block|,
name|scic_sds_stp_request_pio_data_in_await_data_frame_handler
block|}
block|,
comment|//SCIC_SDS_STP_REQUEST_STARTED_PIO_DATA_OUT_TRANSMIT_DATA_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_stp_request_pio_data_out_await_data_transmit_completion_tc_completion_handler
block|,
name|scic_sds_request_default_event_handler
block|,
name|scic_sds_request_default_frame_handler
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_pio_await_h2d_completion_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_pio_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_H2D_COMPLETION_SUBSTATE
argument_list|)
expr_stmt|;
name|scic_sds_remote_device_set_working_request
argument_list|(
name|this_request
operator|->
name|target_device
argument_list|,
name|this_request
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_pio_await_frame_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_pio_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_FRAME_SUBSTATE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_pio_data_in_await_data_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_pio_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_DATA_IN_AWAIT_DATA_SUBSTATE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_pio_data_out_transmit_data_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_pio_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_DATA_OUT_TRANSMIT_DATA_SUBSTATE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCI_BASE_STATE_T
name|scic_sds_stp_request_started_pio_substate_table
index|[
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_MAX_SUBSTATES
index|]
init|=
block|{
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_H2D_COMPLETION_SUBSTATE
block|,
name|scic_sds_stp_request_started_pio_await_h2d_completion_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_AWAIT_FRAME_SUBSTATE
block|,
name|scic_sds_stp_request_started_pio_await_frame_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_DATA_IN_AWAIT_DATA_SUBSTATE
block|,
name|scic_sds_stp_request_started_pio_data_in_await_data_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_PIO_DATA_OUT_TRANSMIT_DATA_SUBSTATE
block|,
name|scic_sds_stp_request_started_pio_data_out_transmit_data_enter
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* UDMA REQUEST STATE MACHINE
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_function
specifier|static
name|void
name|scic_sds_stp_request_udma_complete_request
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U32
name|scu_status
parameter_list|,
name|SCI_STATUS
name|sci_status
parameter_list|)
block|{
name|scic_sds_request_set_status
argument_list|(
name|this_request
argument_list|,
name|scu_status
argument_list|,
name|sci_status
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  *  * @param[in] this_request  * @param[in] frame_index  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_udma_general_frame_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SATA_FIS_HEADER_T
modifier|*
name|frame_header
decl_stmt|;
name|U32
modifier|*
name|frame_buffer
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_sds_stp_pio_request_data_in_await_frame_frame_handler(0x%x, 0x%x) enter\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|scic_sds_unsolicited_frame_control_get_header
argument_list|(
operator|&
name|this_request
operator|->
name|owning_controller
operator|->
name|uf_control
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_header
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|==
name|SCI_SUCCESS
operator|)
operator|&&
operator|(
name|frame_header
operator|->
name|fis_type
operator|==
name|SATA_FIS_TYPE_REGD2H
operator|)
condition|)
block|{
name|scic_sds_unsolicited_frame_control_get_buffer
argument_list|(
operator|&
name|this_request
operator|->
name|owning_controller
operator|->
name|uf_control
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_buffer
argument_list|)
expr_stmt|;
name|scic_sds_controller_copy_sata_response
argument_list|(
operator|&
operator|(
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|this_request
operator|)
operator|->
name|d2h_reg_fis
argument_list|,
operator|(
name|U32
operator|*
operator|)
name|frame_header
argument_list|,
name|frame_buffer
argument_list|)
expr_stmt|;
block|}
name|scic_sds_controller_release_frame
argument_list|(
name|this_request
operator|->
name|owning_controller
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method process TC completions while in the state where  *        we are waiting for TC completions.  *  * @param[in] this_request  * @param[in] completion_code  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_udma_await_tc_completion_tc_completion_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|request
parameter_list|,
name|U32
name|completion_code
parameter_list|)
block|{
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|request
decl_stmt|;
switch|switch
condition|(
name|SCU_GET_COMPLETION_TL_STATUS
argument_list|(
name|completion_code
argument_list|)
condition|)
block|{
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_GOOD
argument_list|)
case|:
name|scic_sds_stp_request_udma_complete_request
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|SCU_TASK_DONE_GOOD
argument_list|,
name|SCI_SUCCESS
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_UNEXP_FIS
argument_list|)
case|:
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_REG_ERR
argument_list|)
case|:
comment|// We must check ther response buffer to see if the D2H Register FIS was
comment|// received before we got the TC completion.
if|if
condition|(
name|this_request
operator|->
name|d2h_reg_fis
operator|.
name|fis_type
operator|==
name|SATA_FIS_TYPE_REGD2H
condition|)
block|{
name|scic_sds_remote_device_suspend
argument_list|(
name|this_request
operator|->
name|parent
operator|.
name|target_device
argument_list|,
name|SCU_EVENT_SPECIFIC
argument_list|(
name|SCU_NORMALIZE_COMPLETION_STATUS
argument_list|(
name|completion_code
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|scic_sds_stp_request_udma_complete_request
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|SCU_TASK_DONE_CHECK_RESPONSE
argument_list|,
name|SCI_FAILURE_IO_RESPONSE_VALID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// If we have an error completion status for the TC then we can expect a
comment|// D2H register FIS from the device so we must change state to wait for it
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_UDMA_AWAIT_D2H_REG_FIS_SUBSTATE
argument_list|)
expr_stmt|;
block|}
break|break;
comment|/// @todo Check to see if any of these completion status need to wait for
comment|///       the device to host register fis.
comment|/// @todo We can retry the command for SCU_TASK_DONE_CMD_LL_R_ERR - this comes only for B0
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_INV_FIS_LEN
argument_list|)
case|:
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_MAX_PLD_ERR
argument_list|)
case|:
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_LL_R_ERR
argument_list|)
case|:
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_CMD_LL_R_ERR
argument_list|)
case|:
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_CRC_ERR
argument_list|)
case|:
name|scic_sds_remote_device_suspend
argument_list|(
name|this_request
operator|->
name|parent
operator|.
name|target_device
argument_list|,
name|SCU_EVENT_SPECIFIC
argument_list|(
name|SCU_NORMALIZE_COMPLETION_STATUS
argument_list|(
name|completion_code
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|// Fall through to the default case
default|default:
comment|// All other completion status cause the IO to be complete.
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"SCIC IO Request 0x%x returning CONTROLLER_SPECIFIC_IO_ERR for completion code 0x%x\n"
operator|,
operator|&
name|this_request
operator|->
name|parent
operator|,
name|completion_code
operator|)
argument_list|)
expr_stmt|;
name|scic_sds_stp_request_udma_complete_request
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|SCU_NORMALIZE_COMPLETION_STATUS
argument_list|(
name|completion_code
argument_list|)
argument_list|,
name|SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_udma_await_d2h_reg_fis_frame_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
comment|// Use the general frame handler to copy the resposne data
name|status
operator|=
name|scic_sds_stp_request_udma_general_frame_handler
argument_list|(
name|this_request
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_stp_request_udma_complete_request
argument_list|(
name|this_request
argument_list|,
name|SCU_TASK_DONE_CHECK_RESPONSE
argument_list|,
name|SCI_FAILURE_IO_RESPONSE_VALID
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCIC_SDS_IO_REQUEST_STATE_HANDLER_T
name|scic_sds_stp_request_started_udma_substate_handler_table
index|[
name|SCIC_SDS_STP_REQUEST_STARTED_UDMA_MAX_SUBSTATES
index|]
init|=
block|{
comment|// SCIC_SDS_STP_REQUEST_STARTED_UDMA_AWAIT_TC_COMPLETION_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_stp_request_udma_await_tc_completion_tc_completion_handler
block|,
name|scic_sds_request_default_event_handler
block|,
name|scic_sds_stp_request_udma_general_frame_handler
block|}
block|,
comment|// SCIC_SDS_STP_REQUEST_STARTED_UDMA_AWAIT_D2H_REG_FIS_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_request_default_tc_completion_handler
block|,
name|scic_sds_request_default_event_handler
block|,
name|scic_sds_stp_request_udma_await_d2h_reg_fis_frame_handler
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  *  *  * @param[in] object  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_udma_await_tc_completion_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_udma_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_UDMA_AWAIT_TC_COMPLETION_SUBSTATE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This state is entered when there is an TC completion failure.  The hardware  * received an unexpected condition while processing the IO request and now  * will UF the D2H register FIS to complete the IO.  *  * @param[in] object  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_udma_await_d2h_reg_fis_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_udma_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_UDMA_AWAIT_D2H_REG_FIS_SUBSTATE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCI_BASE_STATE_T
name|scic_sds_stp_request_started_udma_substate_table
index|[
name|SCIC_SDS_STP_REQUEST_STARTED_UDMA_MAX_SUBSTATES
index|]
init|=
block|{
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_UDMA_AWAIT_TC_COMPLETION_SUBSTATE
block|,
name|scic_sds_stp_request_started_udma_await_tc_completion_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_UDMA_AWAIT_D2H_REG_FIS_SUBSTATE
block|,
name|scic_sds_stp_request_started_udma_await_d2h_reg_fis_enter
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* STP SOFT RESET STATE MACHINE
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * This method processes a TC completion.  The expected TC completion is  * for the transmission of the H2D register FIS containing the SATA/STP  * non-data request.  *  * @param[in] this_request  * @param[in] completion_code  *  * @return This method always successfully processes the TC completion.  * @retval SCI_SUCCESS This value is always returned.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_soft_reset_await_h2d_asserted_tc_completion_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U32
name|completion_code
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_sds_stp_request_soft_reset_await_h2d_tc_completion_handler(0x%x, 0x%x) enter\n"
operator|,
name|this_request
operator|,
name|completion_code
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SCU_GET_COMPLETION_TL_STATUS
argument_list|(
name|completion_code
argument_list|)
condition|)
block|{
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_GOOD
argument_list|)
case|:
name|scic_sds_request_set_status
argument_list|(
name|this_request
argument_list|,
name|SCU_TASK_DONE_GOOD
argument_list|,
name|SCI_SUCCESS
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_H2D_DIAGNOSTIC_COMPLETION_SUBSTATE
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|// All other completion status cause the IO to be complete.  If a NAK
comment|// was received, then it is up to the user to retry the request.
name|scic_sds_request_set_status
argument_list|(
name|this_request
argument_list|,
name|SCU_NORMALIZE_COMPLETION_STATUS
argument_list|(
name|completion_code
argument_list|)
argument_list|,
name|SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method processes a TC completion.  The expected TC completion is  * for the transmission of the H2D register FIS containing the SATA/STP  * non-data request.  *  * @param[in] this_request  * @param[in] completion_code  *  * @return This method always successfully processes the TC completion.  * @retval SCI_SUCCESS This value is always returned.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_soft_reset_await_h2d_diagnostic_tc_completion_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
parameter_list|,
name|U32
name|completion_code
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_sds_stp_request_soft_reset_await_h2d_tc_completion_handler(0x%x, 0x%x) enter\n"
operator|,
name|this_request
operator|,
name|completion_code
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SCU_GET_COMPLETION_TL_STATUS
argument_list|(
name|completion_code
argument_list|)
condition|)
block|{
case|case
name|SCU_MAKE_COMPLETION_STATUS
argument_list|(
name|SCU_TASK_DONE_GOOD
argument_list|)
case|:
name|scic_sds_request_set_status
argument_list|(
name|this_request
argument_list|,
name|SCU_TASK_DONE_GOOD
argument_list|,
name|SCI_SUCCESS
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|started_substate_machine
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_D2H_RESPONSE_FRAME_SUBSTATE
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|// All other completion status cause the IO to be complete.  If a NAK
comment|// was received, then it is up to the user to retry the request.
name|scic_sds_request_set_status
argument_list|(
name|this_request
argument_list|,
name|SCU_NORMALIZE_COMPLETION_STATUS
argument_list|(
name|completion_code
argument_list|)
argument_list|,
name|SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method processes frames received from the target while waiting  * for a device to host register FIS.  If a non-register FIS is received  * during this time, it is treated as a protocol violation from an  * IO perspective.  *  * @param[in] request This parameter specifies the request for which a  *            frame has been received.  * @param[in] frame_index This parameter specifies the index of the frame  *            that has been received.  *  * @return Indicate if the received frame was processed successfully.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_stp_request_soft_reset_await_d2h_frame_handler
parameter_list|(
name|SCIC_SDS_REQUEST_T
modifier|*
name|request
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SATA_FIS_HEADER_T
modifier|*
name|frame_header
decl_stmt|;
name|U32
modifier|*
name|frame_buffer
decl_stmt|;
name|SCIC_SDS_STP_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_STP_REQUEST_T
operator|*
operator|)
name|request
decl_stmt|;
comment|// Save off the controller, so that we do not touch the request after it
comment|//  is completed.
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|owning_controller
init|=
name|this_request
operator|->
name|parent
operator|.
name|owning_controller
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_sds_stp_request_soft_reset_await_d2h_frame_handler(0x%x, 0x%x) enter\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|scic_sds_unsolicited_frame_control_get_header
argument_list|(
operator|&
operator|(
name|owning_controller
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_header
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
switch|switch
condition|(
name|frame_header
operator|->
name|fis_type
condition|)
block|{
case|case
name|SATA_FIS_TYPE_REGD2H
case|:
name|scic_sds_unsolicited_frame_control_get_buffer
argument_list|(
operator|&
operator|(
name|owning_controller
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_buffer
argument_list|)
expr_stmt|;
name|scic_sds_controller_copy_sata_response
argument_list|(
operator|&
name|this_request
operator|->
name|d2h_reg_fis
argument_list|,
operator|(
name|U32
operator|*
operator|)
name|frame_header
argument_list|,
name|frame_buffer
argument_list|)
expr_stmt|;
comment|// The command has completed with error
name|scic_sds_request_set_status
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|SCU_TASK_DONE_CHECK_RESPONSE
argument_list|,
name|SCI_FAILURE_IO_RESPONSE_VALID
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"IO Request:0x%x Frame Id:%d protocol violation occurred\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|)
argument_list|)
expr_stmt|;
name|scic_sds_request_set_status
argument_list|(
operator|&
name|this_request
operator|->
name|parent
argument_list|,
name|SCU_TASK_DONE_UNEXP_FIS
argument_list|,
name|SCI_FAILURE_PROTOCOL_VIOLATION
argument_list|)
expr_stmt|;
break|break;
block|}
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_request
operator|->
name|parent
operator|.
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REQUEST_STATE_COMPLETED
argument_list|)
expr_stmt|;
comment|// Frame has been decoded return it to the controller
name|scic_sds_controller_release_frame
argument_list|(
name|owning_controller
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"SCIC IO Request 0x%x could not get frame header for frame index %d, status %x\n"
operator|,
name|this_request
operator|,
name|frame_index
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCIC_SDS_IO_REQUEST_STATE_HANDLER_T
name|scic_sds_stp_request_started_soft_reset_substate_handler_table
index|[
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_MAX_SUBSTATES
index|]
init|=
block|{
comment|// SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_H2D_ASSERTED_COMPLETION_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_stp_request_soft_reset_await_h2d_asserted_tc_completion_handler
block|,
name|scic_sds_request_default_event_handler
block|,
name|scic_sds_request_default_frame_handler
block|}
block|,
comment|// SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_H2D_DIAGNOSTIC_COMPLETION_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_stp_request_soft_reset_await_h2d_diagnostic_tc_completion_handler
block|,
name|scic_sds_request_default_event_handler
block|,
name|scic_sds_request_default_frame_handler
block|}
block|,
comment|// SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_D2H_RESPONSE_FRAME_SUBSTATE
block|{
block|{
name|scic_sds_request_default_start_handler
block|,
name|scic_sds_request_started_state_abort_handler
block|,
name|scic_sds_request_default_complete_handler
block|,
name|scic_sds_request_default_destruct_handler
block|}
block|,
name|scic_sds_request_default_tc_completion_handler
block|,
name|scic_sds_request_default_event_handler
block|,
name|scic_sds_stp_request_soft_reset_await_d2h_frame_handler
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_soft_reset_await_h2d_asserted_completion_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_soft_reset_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_H2D_ASSERTED_COMPLETION_SUBSTATE
argument_list|)
expr_stmt|;
name|scic_sds_remote_device_set_working_request
argument_list|(
name|this_request
operator|->
name|target_device
argument_list|,
name|this_request
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_soft_reset_await_h2d_diagnostic_completion_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SATA_FIS_REG_H2D_T
modifier|*
name|h2d_fis
decl_stmt|;
name|SCU_TASK_CONTEXT_T
modifier|*
name|task_context
decl_stmt|;
comment|// Clear the SRST bit
name|h2d_fis
operator|=
name|scic_stp_io_request_get_h2d_reg_address
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
name|h2d_fis
operator|->
name|control
operator|=
literal|0
expr_stmt|;
comment|// Clear the TC control bit
name|task_context
operator|=
name|scic_sds_controller_get_task_context_buffer
argument_list|(
name|this_request
operator|->
name|owning_controller
argument_list|,
name|this_request
operator|->
name|io_tag
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|control_frame
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|this_request
operator|->
name|owning_controller
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|continue_io_handler
argument_list|(
operator|&
name|this_request
operator|->
name|owning_controller
operator|->
name|parent
argument_list|,
operator|&
name|this_request
operator|->
name|target_device
operator|->
name|parent
argument_list|,
operator|&
name|this_request
operator|->
name|parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_soft_reset_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_H2D_DIAGNOSTIC_COMPLETION_SUBSTATE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|scic_sds_stp_request_started_soft_reset_await_d2h_response_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_request
argument_list|,
name|scic_sds_stp_request_started_soft_reset_substate_handler_table
argument_list|,
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_D2H_RESPONSE_FRAME_SUBSTATE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCI_BASE_STATE_T
name|scic_sds_stp_request_started_soft_reset_substate_table
index|[
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_MAX_SUBSTATES
index|]
init|=
block|{
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_H2D_ASSERTED_COMPLETION_SUBSTATE
block|,
name|scic_sds_stp_request_started_soft_reset_await_h2d_asserted_completion_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_H2D_DIAGNOSTIC_COMPLETION_SUBSTATE
block|,
name|scic_sds_stp_request_started_soft_reset_await_h2d_diagnostic_completion_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCIC_SDS_STP_REQUEST_STARTED_SOFT_RESET_AWAIT_D2H_RESPONSE_FRAME_SUBSTATE
block|,
name|scic_sds_stp_request_started_soft_reset_await_d2h_response_enter
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_io_request_construct_basic_sata
parameter_list|(
name|SCI_IO_REQUEST_HANDLE_T
name|scic_io_request
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SCIC_SDS_REQUEST_T
modifier|*
name|request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|scic_io_request
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|scic_io_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_io_request_construct_basic_sata(0x%x) enter\n"
operator|,
name|scic_io_request
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|scic_sds_io_request_construct_sata
argument_list|(
name|request
argument_list|,
name|scic_cb_request_get_sat_protocol
argument_list|(
name|request
operator|->
name|user_request
argument_list|)
argument_list|,
name|scic_cb_io_request_get_transfer_length
argument_list|(
name|request
operator|->
name|user_request
argument_list|)
argument_list|,
name|scic_cb_io_request_get_data_direction
argument_list|(
name|request
operator|->
name|user_request
argument_list|)
argument_list|,
name|scic_cb_io_request_do_copy_rx_frames
argument_list|(
name|request
operator|->
name|user_request
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_io_request_construct_advanced_sata
parameter_list|(
name|SCI_IO_REQUEST_HANDLE_T
name|scic_io_request
parameter_list|,
name|SCIC_IO_SATA_PARAMETERS_T
modifier|*
name|io_parameters
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SCIC_SDS_REQUEST_T
modifier|*
name|request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|scic_io_request
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|scic_io_request
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_STP_IO_REQUEST
operator|,
literal|"scic_io_request_construct_basic_sata(0x%x) enter\n"
operator|,
name|scic_io_request
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|scic_sds_io_request_construct_sata
argument_list|(
name|request
argument_list|,
name|scic_cb_request_get_sat_protocol
argument_list|(
name|request
operator|->
name|user_request
argument_list|)
argument_list|,
name|scic_sds_request_get_sgl_element_pair
argument_list|(
name|request
argument_list|,
literal|0
argument_list|)
operator|->
name|A
operator|.
name|length
argument_list|,
name|scic_cb_io_request_get_data_direction
argument_list|(
name|request
operator|->
name|user_request
argument_list|)
argument_list|,
name|scic_cb_io_request_do_copy_rx_frames
argument_list|(
name|request
operator|->
name|user_request
argument_list|)
argument_list|,
name|io_parameters
operator|->
name|do_translate_sgl
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

end_unit


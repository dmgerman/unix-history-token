begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * This file is provided under a dual BSD/GPLv2 license.  When using or  * redistributing this file, you may do so under either license.  *  * GPL LICENSE SUMMARY  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of version 2 of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it will be useful, but  * WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.  * The full GNU General Public License is included in this distribution  * in the file called LICENSE.GPL.  *  * BSD LICENSE  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in  *     the documentation and/or other materials provided with the  *     distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/**  * @file  *  * @brief This file contains the implementation of the SCIC_SDS_PHY public and  *        protected methods.  */
end_comment

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_user_callback.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_phy.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_phy.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_port.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_controller_registers.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_phy_registers.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_logger.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_remote_node_context.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sci_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scu_event_codes.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sci_base_state.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_ata.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_sata.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sci_base_state_machine.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_port_registers.h>
end_include

begin_define
define|#
directive|define
name|SCIC_SDS_PHY_MIN_TIMER_COUNT
value|(SCI_MAX_PHYS)
end_define

begin_define
define|#
directive|define
name|SCIC_SDS_PHY_MAX_TIMER_COUNT
value|(SCI_MAX_PHYS)
end_define

begin_comment
comment|// Maximum arbitration wait time in micro-seconds
end_comment

begin_define
define|#
directive|define
name|SCIC_SDS_PHY_MAX_ARBITRATION_WAIT_TIME
value|(700)
end_define

begin_define
define|#
directive|define
name|AFE_REGISTER_WRITE_DELAY
value|10
end_define

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//* SCIC SDS PHY Internal Methods
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * @brief This method will initialize the phy transport layer registers  *  * @param[in] this_phy  * @param[in] transport_layer_registers  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_transport_layer_initialization
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|SCU_TRANSPORT_LAYER_REGISTERS_T
modifier|*
name|transport_layer_registers
parameter_list|)
block|{
name|U32
name|tl_control
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_link_layer_initialization(this_phy:0x%x, link_layer_registers:0x%x)\n"
operator|,
name|this_phy
operator|,
name|transport_layer_registers
operator|)
argument_list|)
expr_stmt|;
name|this_phy
operator|->
name|transport_layer_registers
operator|=
name|transport_layer_registers
expr_stmt|;
name|SCU_STPTLDARNI_WRITE
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX
argument_list|)
expr_stmt|;
comment|// Hardware team recommends that we enable the STP prefetch for all transports
name|tl_control
operator|=
name|SCU_TLCR_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|tl_control
operator||=
name|SCU_TLCR_GEN_BIT
argument_list|(
name|STP_WRITE_DATA_PREFETCH
argument_list|)
expr_stmt|;
name|SCU_TLCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|tl_control
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method will initialize the phy link layer registers  *  * @param[in] this_phy  * @param[in] link_layer_registers  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_link_layer_initialization
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|SCU_LINK_LAYER_REGISTERS_T
modifier|*
name|link_layer_registers
parameter_list|)
block|{
name|U32
name|phy_configuration
decl_stmt|;
name|SAS_CAPABILITIES_T
name|phy_capabilities
decl_stmt|;
name|U32
name|parity_check
init|=
literal|0
decl_stmt|;
name|U32
name|parity_count
init|=
literal|0
decl_stmt|;
name|U32
name|link_layer_control
decl_stmt|;
name|U32
name|phy_timer_timeout_values
decl_stmt|;
name|U32
name|clksm_value
init|=
literal|0
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_link_layer_initialization(this_phy:0x%x, link_layer_registers:0x%x)\n"
operator|,
name|this_phy
operator|,
name|link_layer_registers
operator|)
argument_list|)
expr_stmt|;
name|this_phy
operator|->
name|link_layer_registers
operator|=
name|link_layer_registers
expr_stmt|;
comment|// Set our IDENTIFY frame data
define|#
directive|define
name|SCI_END_DEVICE
value|0x01
name|SCU_SAS_TIID_WRITE
argument_list|(
name|this_phy
argument_list|,
operator|(
name|SCU_SAS_TIID_GEN_BIT
argument_list|(
name|SMP_INITIATOR
argument_list|)
operator||
name|SCU_SAS_TIID_GEN_BIT
argument_list|(
name|SSP_INITIATOR
argument_list|)
operator||
name|SCU_SAS_TIID_GEN_BIT
argument_list|(
name|STP_INITIATOR
argument_list|)
operator||
name|SCU_SAS_TIID_GEN_BIT
argument_list|(
name|DA_SATA_HOST
argument_list|)
operator||
name|SCU_SAS_TIID_GEN_VAL
argument_list|(
name|DEVICE_TYPE
argument_list|,
name|SCI_END_DEVICE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|// Write the device SAS Address
name|SCU_SAS_TIDNH_WRITE
argument_list|(
name|this_phy
argument_list|,
literal|0xFEDCBA98
argument_list|)
expr_stmt|;
name|SCU_SAS_TIDNL_WRITE
argument_list|(
name|this_phy
argument_list|,
name|this_phy
operator|->
name|phy_index
argument_list|)
expr_stmt|;
comment|// Write the source SAS Address
name|SCU_SAS_TISSAH_WRITE
argument_list|(
name|this_phy
argument_list|,
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|oem_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|sas_address
operator|.
name|sci_format
operator|.
name|high
argument_list|)
expr_stmt|;
name|SCU_SAS_TISSAL_WRITE
argument_list|(
name|this_phy
argument_list|,
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|oem_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|sas_address
operator|.
name|sci_format
operator|.
name|low
argument_list|)
expr_stmt|;
comment|// Clear and Set the PHY Identifier
name|SCU_SAS_TIPID_WRITE
argument_list|(
name|this_phy
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|SCU_SAS_TIPID_WRITE
argument_list|(
name|this_phy
argument_list|,
name|SCU_SAS_TIPID_GEN_VALUE
argument_list|(
name|ID
argument_list|,
name|this_phy
operator|->
name|phy_index
argument_list|)
argument_list|)
expr_stmt|;
comment|// Change the initial state of the phy configuration register
name|phy_configuration
operator|=
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
comment|// Hold OOB state machine in reset
name|phy_configuration
operator||=
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_RESET
argument_list|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|phy_configuration
argument_list|)
expr_stmt|;
comment|// Configure the SNW capabilities
name|phy_capabilities
operator|.
name|u
operator|.
name|all
operator|=
literal|0
expr_stmt|;
name|phy_capabilities
operator|.
name|u
operator|.
name|bits
operator|.
name|start
operator|=
literal|1
expr_stmt|;
name|phy_capabilities
operator|.
name|u
operator|.
name|bits
operator|.
name|gen3_without_ssc_supported
operator|=
literal|1
expr_stmt|;
name|phy_capabilities
operator|.
name|u
operator|.
name|bits
operator|.
name|gen2_without_ssc_supported
operator|=
literal|1
expr_stmt|;
name|phy_capabilities
operator|.
name|u
operator|.
name|bits
operator|.
name|gen1_without_ssc_supported
operator|=
literal|1
expr_stmt|;
comment|/*     * Set up SSC settings according to version of OEM Parameters.     */
block|{
name|U8
name|header_version
decl_stmt|,
name|enable_sata
decl_stmt|,
name|enable_sas
decl_stmt|,
name|sata_spread
decl_stmt|,
name|sas_type
decl_stmt|,
name|sas_spread
decl_stmt|;
name|OEM_SSC_PARAMETERS_T
name|ssc
decl_stmt|;
name|header_version
operator|=
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|oem_parameters_version
expr_stmt|;
name|ssc
operator|.
name|bf
operator|.
name|ssc_sata_tx_spread_level
operator|=
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|oem_parameters
operator|.
name|sds1
operator|.
name|controller
operator|.
name|ssc_sata_tx_spread_level
expr_stmt|;
name|ssc
operator|.
name|bf
operator|.
name|ssc_sas_tx_spread_level
operator|=
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|oem_parameters
operator|.
name|sds1
operator|.
name|controller
operator|.
name|ssc_sas_tx_spread_level
expr_stmt|;
name|ssc
operator|.
name|bf
operator|.
name|ssc_sas_tx_type
operator|=
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|oem_parameters
operator|.
name|sds1
operator|.
name|controller
operator|.
name|ssc_sas_tx_type
expr_stmt|;
name|enable_sata
operator|=
name|enable_sas
operator|=
name|sata_spread
operator|=
name|sas_type
operator|=
name|sas_spread
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|header_version
operator|==
name|SCI_OEM_PARAM_VER_1_0
condition|)
block|{
comment|/*             * Version 1.0 is merely turning SSC on to default values.;             */
if|if
condition|(
name|ssc
operator|.
name|do_enable_ssc
operator|!=
literal|0
condition|)
block|{
name|enable_sas
operator|=
name|enable_sata
operator|=
name|TRUE
expr_stmt|;
name|sas_type
operator|=
literal|0x0
expr_stmt|;
comment|// Downspreading
name|sata_spread
operator|=
literal|0x2
expr_stmt|;
comment|// +0 to -1419 PPM
name|sas_spread
operator|=
literal|0x2
expr_stmt|;
comment|// +0 to -1419 PPM
block|}
block|}
else|else
comment|// header_version>= SCI_OEM_PARAM_VER_1_1
block|{
comment|/*            * Version 1.1 can turn on SAS and SATA independently and            * specify spread levels. Also can specify spread type for SAS.            */
if|if
condition|(
operator|(
name|sata_spread
operator|=
name|ssc
operator|.
name|bf
operator|.
name|ssc_sata_tx_spread_level
operator|)
operator|!=
literal|0
condition|)
name|enable_sata
operator|=
name|TRUE
expr_stmt|;
comment|// Downspreading only
if|if
condition|(
operator|(
name|sas_spread
operator|=
name|ssc
operator|.
name|bf
operator|.
name|ssc_sas_tx_spread_level
operator|)
operator|!=
literal|0
condition|)
block|{
name|enable_sas
operator|=
name|TRUE
expr_stmt|;
name|sas_type
operator|=
name|ssc
operator|.
name|bf
operator|.
name|ssc_sas_tx_type
expr_stmt|;
block|}
block|}
if|if
condition|(
name|enable_sas
operator|==
name|TRUE
condition|)
block|{
name|U32
name|reg_val
init|=
name|scu_afe_register_read
argument_list|(
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
argument_list|,
name|scu_afe_xcvr
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|afe_xcvr_control0
argument_list|)
decl_stmt|;
name|reg_val
operator||=
operator|(
literal|0x00100000
operator||
operator|(
operator|(
operator|(
name|U32
operator|)
name|sas_type
operator|)
operator|<<
literal|19
operator|)
operator|)
expr_stmt|;
name|scu_afe_register_write
argument_list|(
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
argument_list|,
name|scu_afe_xcvr
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|afe_xcvr_control0
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
name|reg_val
operator|=
name|scu_afe_register_read
argument_list|(
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
argument_list|,
name|scu_afe_xcvr
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|afe_tx_ssc_control
argument_list|)
expr_stmt|;
name|reg_val
operator||=
operator|(
operator|(
call|(
name|U32
call|)
argument_list|(
name|sas_spread
argument_list|)
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|scu_afe_register_write
argument_list|(
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
argument_list|,
name|scu_afe_xcvr
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|afe_tx_ssc_control
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
name|phy_capabilities
operator|.
name|u
operator|.
name|bits
operator|.
name|gen3_with_ssc_supported
operator|=
literal|1
expr_stmt|;
name|phy_capabilities
operator|.
name|u
operator|.
name|bits
operator|.
name|gen2_with_ssc_supported
operator|=
literal|1
expr_stmt|;
name|phy_capabilities
operator|.
name|u
operator|.
name|bits
operator|.
name|gen1_with_ssc_supported
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|enable_sata
operator|==
name|TRUE
condition|)
block|{
name|U32
name|reg_val
init|=
name|scu_afe_register_read
argument_list|(
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
argument_list|,
name|scu_afe_xcvr
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|afe_tx_ssc_control
argument_list|)
decl_stmt|;
name|reg_val
operator||=
operator|(
name|U32
operator|)
name|sata_spread
expr_stmt|;
name|scu_afe_register_write
argument_list|(
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
argument_list|,
name|scu_afe_xcvr
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|afe_tx_ssc_control
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
name|reg_val
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|stp_control
argument_list|)
expr_stmt|;
name|reg_val
operator||=
call|(
name|U32
call|)
argument_list|(
literal|1
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|stp_control
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
block|}
comment|// The SAS specification indicates that the phy_capabilities that
comment|// are transmitted shall have an even parity.  Calculate the parity.
name|parity_check
operator|=
name|phy_capabilities
operator|.
name|u
operator|.
name|all
expr_stmt|;
while|while
condition|(
name|parity_check
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|parity_check
operator|&
literal|0x1
condition|)
name|parity_count
operator|++
expr_stmt|;
name|parity_check
operator|>>=
literal|1
expr_stmt|;
block|}
comment|// If parity indicates there are an odd number of bits set, then
comment|// set the parity bit to 1 in the phy capabilities.
if|if
condition|(
operator|(
name|parity_count
operator|%
literal|2
operator|)
operator|!=
literal|0
condition|)
name|phy_capabilities
operator|.
name|u
operator|.
name|bits
operator|.
name|parity
operator|=
literal|1
expr_stmt|;
name|SCU_SAS_PHYCAP_WRITE
argument_list|(
name|this_phy
argument_list|,
name|phy_capabilities
operator|.
name|u
operator|.
name|all
argument_list|)
expr_stmt|;
comment|// Set the enable spinup period but disable the ability to send notify enable spinup
name|SCU_SAS_ENSPINUP_WRITE
argument_list|(
name|this_phy
argument_list|,
name|SCU_ENSPINUP_GEN_VAL
argument_list|(
name|COUNT
argument_list|,
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|user_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|notify_enable_spin_up_insertion_frequency
argument_list|)
argument_list|)
expr_stmt|;
comment|// Write the ALIGN Insertion Ferequency for connected phy and inpendent of connected state
name|clksm_value
operator|=
name|SCU_ALIGN_INSERTION_FREQUENCY_GEN_VAL
argument_list|(
name|CONNECTED
argument_list|,
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|user_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|in_connection_align_insertion_frequency
argument_list|)
expr_stmt|;
name|clksm_value
operator||=
name|SCU_ALIGN_INSERTION_FREQUENCY_GEN_VAL
argument_list|(
name|GENERAL
argument_list|,
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|user_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|align_insertion_frequency
argument_list|)
expr_stmt|;
name|SCU_SAS_CLKSM_WRITE
argument_list|(
name|this_phy
argument_list|,
name|clksm_value
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|PBG_HBA_A0_BUILD
argument_list|)
operator|||
name|defined
argument_list|(
name|PBG_HBA_A2_BUILD
argument_list|)
operator|||
name|defined
argument_list|(
name|PBG_HBA_BETA_BUILD
argument_list|)
comment|/// @todo Provide a way to write this register correctly
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|afe_lookup_table_control
argument_list|,
literal|0x02108421
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|PBG_BUILD
argument_list|)
if|if
condition|(
operator|(
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|pci_revision
operator|==
name|SCIC_SDS_PCI_REVISION_C0
operator|)
operator|||
operator|(
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|pci_revision
operator|==
name|SCIC_SDS_PCI_REVISION_C1
operator|)
condition|)
block|{
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|afe_lookup_table_control
argument_list|,
literal|0x04210400
argument_list|)
expr_stmt|;
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|sas_primitive_timeout
argument_list|,
literal|0x20A7C05
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|afe_lookup_table_control
argument_list|,
literal|0x02108421
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/// @todo Provide a way to write this register correctly
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|afe_lookup_table_control
argument_list|,
literal|0x0e739ce7
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|link_layer_control
operator|=
name|SCU_SAS_LLCTL_GEN_VAL
argument_list|(
name|NO_OUTBOUND_TASK_TIMEOUT
argument_list|,
operator|(
name|U8
operator|)
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|user_parameters
operator|.
name|sds1
operator|.
name|no_outbound_task_timeout
argument_list|)
expr_stmt|;
if|#
directive|if
name|PHY_MAX_LINK_SPEED_GENERATION
operator|==
name|SCIC_SDS_PARM_GEN1_SPEED
define|#
directive|define
name|COMPILED_MAX_LINK_RATE
value|SCU_SAS_LINK_LAYER_CONTROL_MAX_LINK_RATE_GEN1
elif|#
directive|elif
name|PHY_MAX_LINK_SPEED_GENERATION
operator|==
name|SCIC_SDS_PARM_GEN2_SPEED
define|#
directive|define
name|COMPILED_MAX_LINK_RATE
value|SCU_SAS_LINK_LAYER_CONTROL_MAX_LINK_RATE_GEN2
else|#
directive|else
define|#
directive|define
name|COMPILED_MAX_LINK_RATE
value|SCU_SAS_LINK_LAYER_CONTROL_MAX_LINK_RATE_GEN3
endif|#
directive|endif
comment|// PHY_MAX_LINK_SPEED_GENERATION
if|if
condition|(
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|user_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|max_speed_generation
operator|==
name|SCIC_SDS_PARM_GEN3_SPEED
condition|)
block|{
name|link_layer_control
operator||=
name|SCU_SAS_LLCTL_GEN_VAL
argument_list|(
name|MAX_LINK_RATE
argument_list|,
name|COMPILED_MAX_LINK_RATE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|user_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|max_speed_generation
operator|==
name|SCIC_SDS_PARM_GEN2_SPEED
condition|)
block|{
name|link_layer_control
operator||=
name|SCU_SAS_LLCTL_GEN_VAL
argument_list|(
name|MAX_LINK_RATE
argument_list|,
name|MIN
argument_list|(
name|SCU_SAS_LINK_LAYER_CONTROL_MAX_LINK_RATE_GEN2
argument_list|,
name|COMPILED_MAX_LINK_RATE
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|link_layer_control
operator||=
name|SCU_SAS_LLCTL_GEN_VAL
argument_list|(
name|MAX_LINK_RATE
argument_list|,
name|MIN
argument_list|(
name|SCU_SAS_LINK_LAYER_CONTROL_MAX_LINK_RATE_GEN1
argument_list|,
name|COMPILED_MAX_LINK_RATE
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|link_layer_control
argument_list|,
name|link_layer_control
argument_list|)
expr_stmt|;
name|phy_timer_timeout_values
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|phy_timer_timeout_values
argument_list|)
expr_stmt|;
comment|// Clear the default 0x36 (54us) RATE_CHANGE timeout value.
name|phy_timer_timeout_values
operator|&=
operator|~
name|SCU_SAS_PHYTOV_GEN_VAL
argument_list|(
name|RATE_CHANGE
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
comment|// Set RATE_CHANGE timeout value to 0x3B (59us).  This ensures SCU can
comment|//  lock with 3Gb drive when SCU max rate is set to 1.5Gb.
name|phy_timer_timeout_values
operator||=
name|SCU_SAS_PHYTOV_GEN_VAL
argument_list|(
name|RATE_CHANGE
argument_list|,
literal|0x3B
argument_list|)
expr_stmt|;
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|phy_timer_timeout_values
argument_list|,
name|phy_timer_timeout_values
argument_list|)
expr_stmt|;
comment|// Program the max ARB time for the PHY to 700us so we inter-operate with
comment|// the PMC expander which shuts down PHYs if the expander PHY generates too
comment|// many breaks.  This time value will guarantee that the initiator PHY will
comment|// generate the break.
if|#
directive|if
name|defined
argument_list|(
name|PBG_HBA_A0_BUILD
argument_list|)
operator|||
name|defined
argument_list|(
name|PBG_HBA_A2_BUILD
argument_list|)
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|maximum_arbitration_wait_timer_timeout
argument_list|,
name|SCIC_SDS_PHY_MAX_ARBITRATION_WAIT_TIME
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|// defined(PBG_HBA_A0_BUILD) || defined(PBG_HBA_A2_BUILD)
comment|// Disable the link layer hang detection timer
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|link_layer_hang_detection_timeout
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|// We can exit the initial state to the stopped state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_base_state_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCI_BASE_PHY_STATE_STOPPED
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This function will handle the sata SIGNATURE FIS timeout condition.  It  * will restart the starting substate machine since we dont know what has  * actually happening.  *  * @param[in] cookie This object is cast to the SCIC_SDS_PHY_T object.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_phy_sata_timeout
parameter_list|(
name|SCI_OBJECT_HANDLE_T
name|cookie
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
init|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|cookie
decl_stmt|;
name|SCIC_LOG_INFO
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"SCIC SDS Phy 0x%x did not receive signature fis before timeout.\n"
operator|,
name|this_phy
operator|)
argument_list|)
expr_stmt|;
name|sci_base_state_machine_stop
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_base_state_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCI_BASE_PHY_STATE_STARTING
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//* SCIC SDS PHY External Methods
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * @brief This method returns the object size for a phy object.  *  * @return U32  */
end_comment

begin_function
name|U32
name|scic_sds_phy_get_object_size
parameter_list|(
name|void
parameter_list|)
block|{
return|return
sizeof|sizeof
argument_list|(
name|SCIC_SDS_PHY_T
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the minimum number of timers required for a  *        phy object.  *  * @return U32  */
end_comment

begin_function
name|U32
name|scic_sds_phy_get_min_timer_count
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|SCIC_SDS_PHY_MIN_TIMER_COUNT
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the maximum number of timers required for a  *        phy object.  *  * @return U32  */
end_comment

begin_function
name|U32
name|scic_sds_phy_get_max_timer_count
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|SCIC_SDS_PHY_MAX_TIMER_COUNT
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SCI_LOGGING
end_ifdef

begin_function
specifier|static
name|void
name|scic_sds_phy_initialize_state_logging
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|sci_base_state_machine_logger_initialize
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine_logger
argument_list|,
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_cb_logger_log_states
argument_list|,
literal|"SCIC_SDS_PHY_T"
argument_list|,
literal|"base state machine"
argument_list|,
name|SCIC_LOG_OBJECT_PHY
argument_list|)
expr_stmt|;
name|sci_base_state_machine_logger_initialize
argument_list|(
operator|&
name|this_phy
operator|->
name|starting_substate_machine_logger
argument_list|,
operator|&
name|this_phy
operator|->
name|starting_substate_machine
argument_list|,
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_cb_logger_log_states
argument_list|,
literal|"SCIC_SDS_PHY_T"
argument_list|,
literal|"starting substate machine"
argument_list|,
name|SCIC_LOG_OBJECT_PHY
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// SCI_LOGGING
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SCIC_DEBUG_ENABLED
end_ifdef

begin_comment
comment|/**  * Debug code to record the state transitions in the phy  *  * @param our_observer  * @param the_state_machine  */
end_comment

begin_function
name|void
name|scic_sds_phy_observe_state_change
parameter_list|(
name|SCI_BASE_OBSERVER_T
modifier|*
name|our_observer
parameter_list|,
name|SCI_BASE_SUBJECT_T
modifier|*
name|the_subject
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|SCI_BASE_STATE_MACHINE_T
modifier|*
name|the_state_machine
decl_stmt|;
name|U8
name|transition_requestor
decl_stmt|;
name|U32
name|base_state_id
decl_stmt|;
name|U32
name|starting_substate_id
decl_stmt|;
name|the_state_machine
operator|=
operator|(
name|SCI_BASE_STATE_MACHINE_T
operator|*
operator|)
name|the_subject
expr_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|the_state_machine
operator|->
name|state_machine_owner
expr_stmt|;
if|if
condition|(
name|the_state_machine
operator|==
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
condition|)
block|{
name|transition_requestor
operator|=
literal|0x01
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|the_state_machine
operator|==
operator|&
name|this_phy
operator|->
name|starting_substate_machine
condition|)
block|{
name|transition_requestor
operator|=
literal|0x02
expr_stmt|;
block|}
else|else
block|{
name|transition_requestor
operator|=
literal|0xFF
expr_stmt|;
block|}
name|base_state_id
operator|=
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
expr_stmt|;
name|starting_substate_id
operator|=
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_phy
operator|->
name|starting_substate_machine
argument_list|)
expr_stmt|;
name|this_phy
operator|->
name|state_record
operator|.
name|state_transition_table
index|[
name|this_phy
operator|->
name|state_record
operator|.
name|index
operator|++
index|]
operator|=
operator|(
operator|(
name|transition_requestor
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
name|U8
operator|)
name|base_state_id
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|U8
operator|)
name|starting_substate_id
operator|)
operator|)
expr_stmt|;
name|this_phy
operator|->
name|state_record
operator|.
name|index
operator|=
name|this_phy
operator|->
name|state_record
operator|.
name|index
operator|&
operator|(
name|MAX_STATE_TRANSITION_RECORD
operator|-
literal|1
operator|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// SCIC_DEBUG_ENABLED
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SCIC_DEBUG_ENABLED
end_ifdef

begin_comment
comment|/**  * This method initializes the state record debug information for the phy  * object.  *  * @pre The state machines for the phy object must be constructed before this  *      function is called.  *  * @param this_phy The phy which is being initialized.  */
end_comment

begin_function
name|void
name|scic_sds_phy_initialize_state_recording
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|this_phy
operator|->
name|state_record
operator|.
name|index
operator|=
literal|0
expr_stmt|;
name|sci_base_observer_initialize
argument_list|(
operator|&
name|this_phy
operator|->
name|state_record
operator|.
name|base_state_observer
argument_list|,
name|scic_sds_phy_observe_state_change
argument_list|,
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
operator|.
name|parent
argument_list|)
expr_stmt|;
name|sci_base_observer_initialize
argument_list|(
operator|&
name|this_phy
operator|->
name|state_record
operator|.
name|starting_state_observer
argument_list|,
name|scic_sds_phy_observe_state_change
argument_list|,
operator|&
name|this_phy
operator|->
name|starting_substate_machine
operator|.
name|parent
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// SCIC_DEBUG_ENABLED
end_comment

begin_comment
comment|/**  * @brief This method will construct the SCIC_SDS_PHY object  *  * @param[in] this_phy  * @param[in] owning_port  * @param[in] phy_index  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_phy_construct
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|SCIC_SDS_PORT_T
modifier|*
name|owning_port
parameter_list|,
name|U8
name|phy_index
parameter_list|)
block|{
comment|// Call the base constructor first
comment|// Copy the logger from the port (this could be the dummy port)
name|sci_base_phy_construct
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
argument_list|,
name|sci_base_object_get_logger
argument_list|(
name|owning_port
argument_list|)
argument_list|,
name|scic_sds_phy_state_table
argument_list|)
expr_stmt|;
comment|// Copy the rest of the input data to our locals
name|this_phy
operator|->
name|owning_port
operator|=
name|owning_port
expr_stmt|;
name|this_phy
operator|->
name|phy_index
operator|=
name|phy_index
expr_stmt|;
name|this_phy
operator|->
name|bcn_received_while_port_unassigned
operator|=
name|FALSE
expr_stmt|;
name|this_phy
operator|->
name|protocol
operator|=
name|SCIC_SDS_PHY_PROTOCOL_UNKNOWN
expr_stmt|;
name|this_phy
operator|->
name|link_layer_registers
operator|=
name|NULL
expr_stmt|;
name|this_phy
operator|->
name|max_negotiated_speed
operator|=
name|SCI_SAS_NO_LINK_RATE
expr_stmt|;
name|this_phy
operator|->
name|sata_timeout_timer
operator|=
name|NULL
expr_stmt|;
comment|// Clear out the identification buffer data
name|memset
argument_list|(
operator|&
name|this_phy
operator|->
name|phy_type
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|this_phy
operator|->
name|phy_type
argument_list|)
argument_list|)
expr_stmt|;
comment|// Clear out the error counter data
name|memset
argument_list|(
name|this_phy
operator|->
name|error_counter
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|this_phy
operator|->
name|error_counter
argument_list|)
argument_list|)
expr_stmt|;
comment|// Initialize the substate machines
name|sci_base_state_machine_construct
argument_list|(
operator|&
name|this_phy
operator|->
name|starting_substate_machine
argument_list|,
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_sds_phy_starting_substates
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_INITIAL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SCI_LOGGING
name|scic_sds_phy_initialize_state_logging
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|// SCI_LOGGING
ifdef|#
directive|ifdef
name|SCIC_DEBUG_ENABLED
name|scic_sds_phy_initialize_state_recording
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|// SCIC_DEBUG_ENABLED
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the port currently containing this phy.  *        If the phy is currently contained by the dummy port, then  *        the phy is considered to not be part of a port.  *  * @param[in] this_phy This parameter specifies the phy for which to  *            retrieve the containing port.  *  * @return This method returns a handle to a port that contains  *         the supplied phy.  * @retval SCI_INVALID_HANDLE This value is returned if the phy is not  *         part of a real port (i.e. it's contained in the dummy port).  * @retval !SCI_INVALID_HANDLE All other values indicate a handle/pointer  *         to the port containing the phy.  */
end_comment

begin_function
name|SCI_PORT_HANDLE_T
name|scic_sds_phy_get_port
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_phy_get_port(0x%x) enter\n"
operator|,
name|this_phy
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|scic_sds_port_get_index
argument_list|(
name|this_phy
operator|->
name|owning_port
argument_list|)
operator|==
name|SCIC_SDS_DUMMY_PORT
condition|)
return|return
name|SCI_INVALID_HANDLE
return|;
return|return
name|this_phy
operator|->
name|owning_port
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method will assign a port to the phy object.  *  * @param[in, out] this_phy This parameter specifies the phy for which  *    to assign a port object.  * @param[in] the_port This parameter is the port to assing to the phy.  */
end_comment

begin_function
name|void
name|scic_sds_phy_set_port
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|SCIC_SDS_PORT_T
modifier|*
name|the_port
parameter_list|)
block|{
name|this_phy
operator|->
name|owning_port
operator|=
name|the_port
expr_stmt|;
if|if
condition|(
name|this_phy
operator|->
name|bcn_received_while_port_unassigned
condition|)
block|{
name|this_phy
operator|->
name|bcn_received_while_port_unassigned
operator|=
name|FALSE
expr_stmt|;
name|scic_sds_port_broadcast_change_received
argument_list|(
name|this_phy
operator|->
name|owning_port
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method will initialize the constructed phy  *  * @param[in] this_phy  * @param[in] link_layer_registers  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_initialize
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|void
modifier|*
name|transport_layer_registers
parameter_list|,
name|SCU_LINK_LAYER_REGISTERS_T
modifier|*
name|link_layer_registers
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_initialize(this_phy:0x%x, link_layer_registers:0x%x)\n"
operator|,
name|this_phy
operator|,
name|link_layer_registers
operator|)
argument_list|)
expr_stmt|;
comment|// Perfrom the initialization of the TL hardware
name|scic_sds_phy_transport_layer_initialization
argument_list|(
name|this_phy
argument_list|,
name|transport_layer_registers
argument_list|)
expr_stmt|;
comment|// Perofrm the initialization of the PE hardware
name|scic_sds_phy_link_layer_initialization
argument_list|(
name|this_phy
argument_list|,
name|link_layer_registers
argument_list|)
expr_stmt|;
comment|// There is nothing that needs to be done in this state just
comment|// transition to the stopped state.
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_base_state_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCI_BASE_PHY_STATE_STOPPED
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method assigns the direct attached device ID for this phy.  *  * @param[in] this_phy The phy for which the direct attached device id is to  *       be assigned.  * @param[in] device_id The direct attached device ID to assign to the phy.  *       This will either be the RNi for the device or an invalid RNi if there  *       is no current device assigned to the phy.  */
end_comment

begin_function
name|void
name|scic_sds_phy_setup_transport
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|device_id
parameter_list|)
block|{
name|U32
name|tl_control
decl_stmt|;
name|SCU_STPTLDARNI_WRITE
argument_list|(
name|this_phy
argument_list|,
name|device_id
argument_list|)
expr_stmt|;
comment|// The read should guarntee that the first write gets posted
comment|// before the next write
name|tl_control
operator|=
name|SCU_TLCR_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|tl_control
operator||=
name|SCU_TLCR_GEN_BIT
argument_list|(
name|CLEAR_TCI_NCQ_MAPPING_TABLE
argument_list|)
expr_stmt|;
name|SCU_TLCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|tl_control
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This function will perform the register reads/writes to suspend the SCU  * hardware protocol engine.  *  * @param[in,out] this_phy The phy object to be suspended.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_phy_suspend
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|U32
name|scu_sas_pcfg_value
decl_stmt|;
name|scu_sas_pcfg_value
operator|=
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|scu_sas_pcfg_value
operator||=
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|SUSPEND_PROTOCOL_ENGINE
argument_list|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|scu_sas_pcfg_value
argument_list|)
expr_stmt|;
name|scic_sds_phy_setup_transport
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This function will perform the register reads/writes required to resume the  * SCU hardware protocol engine.  *  * @param[in,out] this_phy The phy object to resume.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_phy_resume
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|U32
name|scu_sas_pcfg_value
decl_stmt|;
name|scu_sas_pcfg_value
operator|=
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|scu_sas_pcfg_value
operator|&=
operator|~
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|SUSPEND_PROTOCOL_ENGINE
argument_list|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|scu_sas_pcfg_value
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the local sas address assigned to this phy.  *  * @param[in] this_phy This parameter specifies the phy for which  *            to retrieve the local SAS address.  * @param[out] sas_address This parameter specifies the location into  *             which to copy the local SAS address.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_phy_get_sas_address
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|SCI_SAS_ADDRESS_T
modifier|*
name|sas_address
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_get_sas_address(this_phy:0x%x, sas_address:0x%x)\n"
operator|,
name|this_phy
operator|,
name|sas_address
operator|)
argument_list|)
expr_stmt|;
name|sas_address
operator|->
name|high
operator|=
name|SCU_SAS_TISSAH_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|sas_address
operator|->
name|low
operator|=
name|SCU_SAS_TISSAL_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the remote end-point (i.e. attached)  *        sas address assigned to this phy.  *  * @param[in] this_phy This parameter specifies the phy for which  *            to retrieve the remote end-point SAS address.  * @param[out] sas_address This parameter specifies the location into  *             which to copy the remote end-point SAS address.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_phy_get_attached_sas_address
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|SCI_SAS_ADDRESS_T
modifier|*
name|sas_address
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_get_attached_sas_address(0x%x, 0x%x) enter\n"
operator|,
name|this_phy
operator|,
name|sas_address
operator|)
argument_list|)
expr_stmt|;
name|sas_address
operator|->
name|high
operator|=
name|this_phy
operator|->
name|phy_type
operator|.
name|sas
operator|.
name|identify_address_frame_buffer
operator|.
name|sas_address
operator|.
name|high
expr_stmt|;
name|sas_address
operator|->
name|low
operator|=
name|this_phy
operator|->
name|phy_type
operator|.
name|sas
operator|.
name|identify_address_frame_buffer
operator|.
name|sas_address
operator|.
name|low
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the supported protocols assigned to  *        this phy  *  * @param[in] this_phy  * @param[out] protocols  */
end_comment

begin_function
name|void
name|scic_sds_phy_get_protocols
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_PROTOCOLS_T
modifier|*
name|protocols
parameter_list|)
block|{
name|U32
name|tiid_value
init|=
name|SCU_SAS_TIID_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
comment|//Check each bit of this register. please refer to
comment|//SAS Transmit Identification Register (SAS_TIID).
if|if
condition|(
name|tiid_value
operator|&
literal|0x2
condition|)
name|protocols
operator|->
name|u
operator|.
name|bits
operator|.
name|smp_target
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tiid_value
operator|&
literal|0x4
condition|)
name|protocols
operator|->
name|u
operator|.
name|bits
operator|.
name|stp_target
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tiid_value
operator|&
literal|0x8
condition|)
name|protocols
operator|->
name|u
operator|.
name|bits
operator|.
name|ssp_target
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tiid_value
operator|&
literal|0x200
condition|)
name|protocols
operator|->
name|u
operator|.
name|bits
operator|.
name|smp_initiator
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|tiid_value
operator|&
literal|0x400
operator|)
condition|)
name|protocols
operator|->
name|u
operator|.
name|bits
operator|.
name|stp_initiator
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tiid_value
operator|&
literal|0x800
condition|)
name|protocols
operator|->
name|u
operator|.
name|bits
operator|.
name|ssp_initiator
operator|=
literal|1
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_get_protocols(this_phy:0x%x, protocols:0x%x)\n"
operator|,
name|this_phy
operator|,
name|protocols
operator|->
name|u
operator|.
name|all
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method returns the supported protocols for the attached phy.  If this  * is a SAS phy the protocols are returned from the identify address frame.  * If this is a SATA phy then protocols are made up and the target phy is an  * STP target phy.  *  * @note The caller will get the entire set of bits for the protocol value.  *  * @param[in] this_phy The parameter is the phy object for which the attached  *       phy protcols are to be returned.  * @param[out] protocols The parameter is the returned protocols for the  *       attached phy.  */
end_comment

begin_function
name|void
name|scic_sds_phy_get_attached_phy_protocols
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_PROTOCOLS_T
modifier|*
name|protocols
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_get_attached_phy_protocols(this_phy:0x%x, protocols:0x%x[0x%x])\n"
operator|,
name|this_phy
operator|,
name|protocols
operator|,
name|protocols
operator|->
name|u
operator|.
name|all
operator|)
argument_list|)
expr_stmt|;
name|protocols
operator|->
name|u
operator|.
name|all
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|this_phy
operator|->
name|protocol
operator|==
name|SCIC_SDS_PHY_PROTOCOL_SAS
condition|)
block|{
name|protocols
operator|->
name|u
operator|.
name|all
operator|=
name|this_phy
operator|->
name|phy_type
operator|.
name|sas
operator|.
name|identify_address_frame_buffer
operator|.
name|protocols
operator|.
name|u
operator|.
name|all
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|this_phy
operator|->
name|protocol
operator|==
name|SCIC_SDS_PHY_PROTOCOL_SATA
condition|)
block|{
name|protocols
operator|->
name|u
operator|.
name|bits
operator|.
name|stp_target
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method release resources in for a scic phy.  *  * @param[in] controller This parameter specifies the core controller, one of  *            its phy's resources are to be released.  * @param[in] this_phy This parameter specifies the phy whose resource is to  *            be released.  */
end_comment

begin_function
name|void
name|scic_sds_phy_release_resource
parameter_list|(
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|controller
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_release_resource(0x%x, 0x%x)\n"
operator|,
name|controller
operator|,
name|this_phy
operator|)
argument_list|)
expr_stmt|;
comment|//Currently, the only resource to be released is a timer.
if|if
condition|(
name|this_phy
operator|->
name|sata_timeout_timer
operator|!=
name|NULL
condition|)
block|{
name|scic_cb_timer_destroy
argument_list|(
name|controller
argument_list|,
name|this_phy
operator|->
name|sata_timeout_timer
argument_list|)
expr_stmt|;
name|this_phy
operator|->
name|sata_timeout_timer
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//* SCIC SDS PHY Handler Redirects
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * @brief This method will attempt to reset the phy.  This  *        request is only valid when the phy is in an ready  *        state  *  * @param[in] this_phy  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_reset
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_reset(this_phy:0x%08x)\n"
operator|,
name|this_phy
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_phy
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|reset_handler
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method will process the event code recieved.  *  * @param[in] this_phy  * @param[in] event_code  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_event_handler(this_phy:0x%08x, event_code:%x)\n"
operator|,
name|this_phy
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_phy
operator|->
name|state_handlers
operator|->
name|event_handler
argument_list|(
name|this_phy
argument_list|,
name|event_code
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method will process the frame index recieved.  *  * @param[in] this_phy  * @param[in] frame_index  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_frame_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_frame_handler(this_phy:0x%08x, frame_index:%d)\n"
operator|,
name|this_phy
operator|,
name|frame_index
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_phy
operator|->
name|state_handlers
operator|->
name|frame_handler
argument_list|(
name|this_phy
argument_list|,
name|frame_index
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method will give the phy permission to consume power  *  * @param[in] this_phy  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_consume_power_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sds_phy_consume_power_handler(this_phy:0x%08x)\n"
operator|,
name|this_phy
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_phy
operator|->
name|state_handlers
operator|->
name|consume_power_handler
argument_list|(
name|this_phy
argument_list|)
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//* SCIC PHY Public Methods
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_function
name|SCI_STATUS
name|scic_phy_get_properties
parameter_list|(
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|,
name|SCIC_PHY_PROPERTIES_T
modifier|*
name|properties
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|U8
name|max_speed_generation
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_phy_get_properties(0x%x, 0x%x) enter\n"
operator|,
name|this_phy
operator|,
name|properties
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|==
name|SCI_INVALID_HANDLE
condition|)
block|{
return|return
name|SCI_FAILURE_INVALID_PHY
return|;
block|}
name|memset
argument_list|(
name|properties
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|SCIC_PHY_PROPERTIES_T
argument_list|)
argument_list|)
expr_stmt|;
comment|//get max link rate of this phy set by user.
name|max_speed_generation
operator|=
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|user_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|max_speed_generation
expr_stmt|;
name|properties
operator|->
name|negotiated_link_rate
operator|=
name|this_phy
operator|->
name|max_negotiated_speed
expr_stmt|;
if|if
condition|(
name|max_speed_generation
operator|==
name|SCIC_SDS_PARM_GEN3_SPEED
condition|)
name|properties
operator|->
name|max_link_rate
operator|=
name|SCI_SAS_600_GB
expr_stmt|;
elseif|else
if|if
condition|(
name|max_speed_generation
operator|==
name|SCIC_SDS_PARM_GEN2_SPEED
condition|)
name|properties
operator|->
name|max_link_rate
operator|=
name|SCI_SAS_300_GB
expr_stmt|;
else|else
name|properties
operator|->
name|max_link_rate
operator|=
name|SCI_SAS_150_GB
expr_stmt|;
name|properties
operator|->
name|index
operator|=
name|this_phy
operator|->
name|phy_index
expr_stmt|;
name|properties
operator|->
name|owning_port
operator|=
name|scic_sds_phy_get_port
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|scic_sds_phy_get_protocols
argument_list|(
name|this_phy
argument_list|,
operator|&
name|properties
operator|->
name|transmit_iaf
operator|.
name|protocols
argument_list|)
expr_stmt|;
name|properties
operator|->
name|transmit_iaf
operator|.
name|sas_address
operator|.
name|high
operator|=
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|oem_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|sas_address
operator|.
name|sci_format
operator|.
name|high
expr_stmt|;
name|properties
operator|->
name|transmit_iaf
operator|.
name|sas_address
operator|.
name|low
operator|=
name|this_phy
operator|->
name|owning_port
operator|->
name|owning_controller
operator|->
name|oem_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|this_phy
operator|->
name|phy_index
index|]
operator|.
name|sas_address
operator|.
name|sci_format
operator|.
name|low
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_sas_phy_get_properties
parameter_list|(
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|,
name|SCIC_SAS_PHY_PROPERTIES_T
modifier|*
name|properties
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sas_phy_get_properties(0x%x, 0x%x) enter\n"
operator|,
name|this_phy
operator|,
name|properties
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_phy
operator|->
name|protocol
operator|==
name|SCIC_SDS_PHY_PROTOCOL_SAS
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|properties
operator|->
name|received_iaf
argument_list|,
operator|&
name|this_phy
operator|->
name|phy_type
operator|.
name|sas
operator|.
name|identify_address_frame_buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_T
argument_list|)
argument_list|)
expr_stmt|;
name|properties
operator|->
name|received_capabilities
operator|.
name|u
operator|.
name|all
operator|=
name|SCU_SAS_RECPHYCAP_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
return|return
name|SCI_FAILURE
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_sata_phy_get_properties
parameter_list|(
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|,
name|SCIC_SATA_PHY_PROPERTIES_T
modifier|*
name|properties
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sata_phy_get_properties(0x%x, 0x%x) enter\n"
operator|,
name|this_phy
operator|,
name|properties
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_phy
operator|->
name|protocol
operator|==
name|SCIC_SDS_PHY_PROTOCOL_SATA
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|properties
operator|->
name|signature_fis
argument_list|,
operator|&
name|this_phy
operator|->
name|phy_type
operator|.
name|sata
operator|.
name|signature_fis_buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|SATA_FIS_REG_D2H_T
argument_list|)
argument_list|)
expr_stmt|;
comment|/// @todo add support for port selectors.
name|properties
operator|->
name|is_port_selector_present
operator|=
name|FALSE
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
return|return
name|SCI_FAILURE
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_PORT_SELECTORS
argument_list|)
end_if

begin_function
name|SCI_STATUS
name|scic_sata_phy_send_port_selection_signal
parameter_list|(
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_sata_phy_send_port_selection_signals(0x%x) enter\n"
operator|,
name|this_phy
operator|)
argument_list|)
expr_stmt|;
comment|/// @todo To be implemented
name|ASSERT
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// !defined(DISABLE_PORT_SELECTORS)
end_comment

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_PHY_COUNTERS
argument_list|)
end_if

begin_function
name|SCI_STATUS
name|scic_phy_enable_counter
parameter_list|(
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|,
name|SCIC_PHY_COUNTER_ID_T
name|counter_id
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_phy_enable_counter(0x%x, 0x%x) enter\n"
operator|,
name|this_phy
operator|,
name|counter_id
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|counter_id
condition|)
block|{
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DONE_ACK_NAK_TIMEOUT
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator||=
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_RX_DONE_ACK_NAK_TIMEOUT_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_DONE_ACK_NAK_TIMEOUT
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator||=
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_TX_DONE_ACK_NAK_TIMEOUT_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCIC_PHY_COUNTER_INACTIVITY_TIMER_EXPIRED
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator||=
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_INACTIVITY_TIMER_EXPIRED_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DONE_CREDIT_TIMEOUT
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator||=
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_RX_DONE_CREDIT_TIMEOUT_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_DONE_CREDIT_TIMEOUT
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator||=
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_TX_DONE_CREDIT_TIMEOUT_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_CREDIT_BLOCKED
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator||=
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_RX_CREDIT_BLOCKED_RECEIVED_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
comment|// These error counters are enabled by default, and cannot be
comment|//  disabled.  Return SCI_SUCCESS to denote that they are
comment|//  enabled, hiding the fact that enabling the counter is
comment|//  a no-op.
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME
case|:
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_FRAME
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_DWORD
case|:
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_FRAME_DWORD
case|:
case|case
name|SCIC_PHY_COUNTER_LOSS_OF_SYNC_ERROR
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DISPARITY_ERROR
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_CRC_ERROR
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_SHORT_FRAME
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_WITHOUT_CREDIT
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_AFTER_DONE
case|:
case|case
name|SCIC_PHY_COUNTER_SN_DWORD_SYNC_ERROR
case|:
break|break;
default|default:
name|status
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_phy_disable_counter
parameter_list|(
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|,
name|SCIC_PHY_COUNTER_ID_T
name|counter_id
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_phy_disable_counter(0x%x, 0x%x) enter\n"
operator|,
name|this_phy
operator|,
name|counter_id
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|counter_id
condition|)
block|{
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DONE_ACK_NAK_TIMEOUT
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_RX_DONE_ACK_NAK_TIMEOUT_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_DONE_ACK_NAK_TIMEOUT
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_TX_DONE_ACK_NAK_TIMEOUT_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCIC_PHY_COUNTER_INACTIVITY_TIMER_EXPIRED
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_INACTIVITY_TIMER_EXPIRED_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DONE_CREDIT_TIMEOUT
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_RX_DONE_CREDIT_TIMEOUT_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_DONE_CREDIT_TIMEOUT
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_TX_DONE_CREDIT_TIMEOUT_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_CREDIT_BLOCKED
case|:
block|{
name|U32
name|control
init|=
name|SCU_SAS_ECENCR_READ
argument_list|(
name|this_phy
argument_list|)
decl_stmt|;
name|control
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|SCU_ERR_CNT_RX_CREDIT_BLOCKED_RECEIVED_INDEX
operator|)
expr_stmt|;
name|SCU_SAS_ECENCR_WRITE
argument_list|(
name|this_phy
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
break|break;
comment|// These error counters cannot be disabled, so return SCI_FAILURE.
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME
case|:
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_FRAME
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_DWORD
case|:
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_FRAME_DWORD
case|:
case|case
name|SCIC_PHY_COUNTER_LOSS_OF_SYNC_ERROR
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DISPARITY_ERROR
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_CRC_ERROR
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_SHORT_FRAME
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_WITHOUT_CREDIT
case|:
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_AFTER_DONE
case|:
case|case
name|SCIC_PHY_COUNTER_SN_DWORD_SYNC_ERROR
case|:
default|default:
name|status
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_phy_get_counter
parameter_list|(
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|,
name|SCIC_PHY_COUNTER_ID_T
name|counter_id
parameter_list|,
name|U32
modifier|*
name|data
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_phy_get_counter(0x%x, 0x%x) enter\n"
operator|,
name|this_phy
operator|,
name|counter_id
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|counter_id
condition|)
block|{
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|received_frame_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_FRAME
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|transmit_frame_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_DWORD
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|received_dword_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_FRAME_DWORD
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|transmit_dword_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_LOSS_OF_SYNC_ERROR
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|loss_of_sync_error_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DISPARITY_ERROR
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|running_disparity_error_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_CRC_ERROR
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|received_frame_crc_error_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DONE_ACK_NAK_TIMEOUT
case|:
operator|*
name|data
operator|=
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_RX_DONE_ACK_NAK_TIMEOUT_INDEX
index|]
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_DONE_ACK_NAK_TIMEOUT
case|:
operator|*
name|data
operator|=
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_TX_DONE_ACK_NAK_TIMEOUT_INDEX
index|]
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_INACTIVITY_TIMER_EXPIRED
case|:
operator|*
name|data
operator|=
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_INACTIVITY_TIMER_EXPIRED_INDEX
index|]
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DONE_CREDIT_TIMEOUT
case|:
operator|*
name|data
operator|=
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_RX_DONE_CREDIT_TIMEOUT_INDEX
index|]
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_DONE_CREDIT_TIMEOUT
case|:
operator|*
name|data
operator|=
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_TX_DONE_CREDIT_TIMEOUT_INDEX
index|]
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_CREDIT_BLOCKED
case|:
operator|*
name|data
operator|=
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_RX_CREDIT_BLOCKED_RECEIVED_INDEX
index|]
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_SHORT_FRAME
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|received_short_frame_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_WITHOUT_CREDIT
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|received_frame_without_credit_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_AFTER_DONE
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|received_frame_after_done_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_SN_DWORD_SYNC_ERROR
case|:
operator|*
name|data
operator|=
name|scu_link_layer_register_read
argument_list|(
name|this_phy
argument_list|,
name|phy_reset_problem_count
argument_list|)
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_phy_clear_counter
parameter_list|(
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|,
name|SCIC_PHY_COUNTER_ID_T
name|counter_id
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_phy_clear_counter(0x%x, 0x%x) enter\n"
operator|,
name|this_phy
operator|,
name|counter_id
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|counter_id
condition|)
block|{
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|received_frame_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_FRAME
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|transmit_frame_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_DWORD
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|received_dword_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_FRAME_DWORD
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|transmit_dword_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_LOSS_OF_SYNC_ERROR
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|loss_of_sync_error_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DISPARITY_ERROR
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|running_disparity_error_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_CRC_ERROR
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|received_frame_crc_error_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DONE_ACK_NAK_TIMEOUT
case|:
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_RX_DONE_ACK_NAK_TIMEOUT_INDEX
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_DONE_ACK_NAK_TIMEOUT
case|:
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_TX_DONE_ACK_NAK_TIMEOUT_INDEX
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_INACTIVITY_TIMER_EXPIRED
case|:
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_INACTIVITY_TIMER_EXPIRED_INDEX
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_DONE_CREDIT_TIMEOUT
case|:
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_RX_DONE_CREDIT_TIMEOUT_INDEX
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_TRANSMITTED_DONE_CREDIT_TIMEOUT
case|:
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_TX_DONE_CREDIT_TIMEOUT_INDEX
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_CREDIT_BLOCKED
case|:
name|this_phy
operator|->
name|error_counter
index|[
name|SCU_ERR_CNT_RX_CREDIT_BLOCKED_RECEIVED_INDEX
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_SHORT_FRAME
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|received_short_frame_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_WITHOUT_CREDIT
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|received_frame_without_credit_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_RECEIVED_FRAME_AFTER_DONE
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|received_frame_after_done_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCIC_PHY_COUNTER_SN_DWORD_SYNC_ERROR
case|:
name|scu_link_layer_register_write
argument_list|(
name|this_phy
argument_list|,
name|phy_reset_problem_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|SCI_FAILURE
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// !defined(DISABLE_PHY_COUNTERS)
end_comment

begin_function
name|SCI_STATUS
name|scic_phy_stop
parameter_list|(
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_phy_stop(this_phy:0x%x)\n"
operator|,
name|this_phy
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_phy
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|stop_handler
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_function
name|SCI_STATUS
name|scic_phy_start
parameter_list|(
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"scic_phy_start(this_phy:0x%x)\n"
operator|,
name|this_phy
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_phy
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|start_handler
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* PHY STATE MACHINE
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//***************************************************************************
end_comment

begin_comment
comment|//*  DEFAULT HANDLERS
end_comment

begin_comment
comment|//***************************************************************************
end_comment

begin_comment
comment|/**  * This is the default method for phy a start request.  It will report a  * warning and exit.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_default_start_handler
parameter_list|(
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"SCIC Phy 0x%08x requested to start from invalid state %d\n"
operator|,
name|this_phy
operator|,
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for phy a stop request.  It will report a  * warning and exit.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_default_stop_handler
parameter_list|(
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"SCIC Phy 0x%08x requested to stop from invalid state %d\n"
operator|,
name|this_phy
operator|,
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for phy a reset request.  It will report a  * warning and exit.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_default_reset_handler
parameter_list|(
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"SCIC Phy 0x%08x requested to reset from invalid state %d\n"
operator|,
name|this_phy
operator|,
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for phy a destruct request.  It will report a  * warning and exit.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_default_destroy_handler
parameter_list|(
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
comment|/// @todo Implement something for the default
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"SCIC Phy 0x%08x requested to destroy from invalid state %d\n"
operator|,
name|this_phy
operator|,
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a phy frame handling request.  It will  * report a warning, release the frame and exit.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  * @param[in] frame_index This is the frame index that was received from the  *       SCU hardware.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_default_frame_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"SCIC Phy 0x%08x recieved unexpected frame data %d while in state %d\n"
operator|,
name|this_phy
operator|,
name|frame_index
operator|,
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|scic_sds_controller_release_frame
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a phy event handler.  It will report a  * warning and exit.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  * @param[in] event_code This is the event code that was received from the SCU  *       hardware.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_default_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"SCIC Phy 0x%08x received unexpected event status %x while in state %d\n"
operator|,
name|this_phy
operator|,
name|event_code
operator|,
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a phy consume power handler.  It will report  * a warning and exit.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_phy_default_consume_power_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator|,
literal|"SCIC Phy 0x%08x given unexpected permission to consume power while in state %d\n"
operator|,
name|this_phy
operator|,
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* PHY STOPPED STATE HANDLERS
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * This method takes the SCIC_SDS_PHY from a stopped state and attempts to  * start it.  *    - The phy state machine is transitioned to the  *      SCI_BASE_PHY_STATE_STARTING.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_stopped_state_start_handler
parameter_list|(
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
comment|// Create the SIGNATURE FIS Timeout timer for this phy
name|this_phy
operator|->
name|sata_timeout_timer
operator|=
name|scic_cb_timer_create
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|scic_sds_phy_sata_timeout
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_phy
operator|->
name|sata_timeout_timer
operator|!=
name|NULL
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_base_state_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCI_BASE_PHY_STATE_STARTING
argument_list|)
expr_stmt|;
block|}
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method takes the SCIC_SDS_PHY from a stopped state and destroys it.  *    - This function takes no action.  *  * @todo Shouldnt this function transition the SCI_BASE_PHY::state_machine to  *        the SCI_BASE_PHY_STATE_FINAL?  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_stopped_state_destroy_handler
parameter_list|(
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
comment|/// @todo what do we actually need to do here?
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* PHY STARTING STATE HANDLERS
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|// All of these state handlers are mapped to the starting sub-state machine
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* PHY READY STATE HANDLERS
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * This method takes the SCIC_SDS_PHY from a ready state and attempts to stop  * it.  *    - The phy state machine is transitioned to the SCI_BASE_PHY_STATE_STOPPED.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_ready_state_stop_handler
parameter_list|(
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_base_state_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCI_BASE_PHY_STATE_STOPPED
argument_list|)
expr_stmt|;
name|scic_sds_controller_link_down
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|scic_sds_phy_get_port
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method takes the SCIC_SDS_PHY from a ready state and attempts to reset  * it.  *    - The phy state machine is transitioned to the SCI_BASE_PHY_STATE_STARTING.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_ready_state_reset_handler
parameter_list|(
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_base_state_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCI_BASE_PHY_STATE_RESETTING
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method request the SCIC_SDS_PHY handle the received event.  The only  * event that we are interested in while in the ready state is the link  * failure event.  *    - decoded event is a link failure  *       - transition the SCIC_SDS_PHY back to the SCI_BASE_PHY_STATE_STARTING  *         state.  *    - any other event recived will report a warning message  *  * @param[in] phy This is the SCIC_SDS_PHY object which has received the  *       event.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS if the event received is a link failure  * @retval SCI_FAILURE_INVALID_STATE for any other event received.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_ready_state_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|SCI_STATUS
name|result
init|=
name|SCI_FAILURE
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_LINK_FAILURE
case|:
comment|// Link failure change state back to the starting state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_base_state_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCI_BASE_PHY_STATE_STARTING
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_SUCCESS
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_BROADCAST_CHANGE
case|:
comment|// Broadcast change received. Notify the port.
if|if
condition|(
name|scic_sds_phy_get_port
argument_list|(
name|this_phy
argument_list|)
operator|!=
name|SCI_INVALID_HANDLE
condition|)
name|scic_sds_port_broadcast_change_received
argument_list|(
name|this_phy
operator|->
name|owning_port
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
else|else
name|this_phy
operator|->
name|bcn_received_while_port_unassigned
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_ERR_CNT
argument_list|(
name|RX_CREDIT_BLOCKED_RECEIVED
argument_list|)
case|:
case|case
name|SCU_EVENT_ERR_CNT
argument_list|(
name|TX_DONE_CREDIT_TIMEOUT
argument_list|)
case|:
case|case
name|SCU_EVENT_ERR_CNT
argument_list|(
name|RX_DONE_CREDIT_TIMEOUT
argument_list|)
case|:
case|case
name|SCU_EVENT_ERR_CNT
argument_list|(
name|INACTIVITY_TIMER_EXPIRED
argument_list|)
case|:
case|case
name|SCU_EVENT_ERR_CNT
argument_list|(
name|TX_DONE_ACK_NAK_TIMEOUT
argument_list|)
case|:
case|case
name|SCU_EVENT_ERR_CNT
argument_list|(
name|RX_DONE_ACK_NAK_TIMEOUT
argument_list|)
case|:
block|{
name|U32
name|error_counter_index
init|=
name|scu_get_event_specifier
argument_list|(
name|event_code
argument_list|)
operator|>>
name|SCU_EVENT_SPECIFIC_CODE_SHIFT
decl_stmt|;
name|this_phy
operator|->
name|error_counter
index|[
name|error_counter_index
index|]
operator|++
expr_stmt|;
name|result
operator|=
name|SCI_SUCCESS
expr_stmt|;
block|}
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_RECEIVED_EVENTS
operator|,
literal|"SCIC PHY 0x%x ready state machine recieved unexpected event_code %x\n"
operator|,
name|this_phy
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_FAILURE_INVALID_STATE
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_comment
comment|/**  * This is the resetting state event handler.  *  * @param[in] this_phy This is the SCIC_SDS_PHY object which is receiving the  *       event.  * @param[in] event_code This is the event code to be processed.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_resetting_state_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|SCI_STATUS
name|result
init|=
name|SCI_FAILURE
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_HARD_RESET_TRANSMITTED
case|:
comment|// Link failure change state back to the starting state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_base_state_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCI_BASE_PHY_STATE_STARTING
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_SUCCESS
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_RECEIVED_EVENTS
operator|,
literal|"SCIC PHY 0x%x resetting state machine recieved unexpected event_code %x\n"
operator|,
name|this_phy
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_FAILURE_INVALID_STATE
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCIC_SDS_PHY_STATE_HANDLER_T
name|scic_sds_phy_state_handler_table
index|[
name|SCI_BASE_PHY_MAX_STATES
index|]
init|=
block|{
comment|// SCI_BASE_PHY_STATE_INITIAL
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_default_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_default_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCI_BASE_PHY_STATE_STOPPED
block|{
block|{
name|scic_sds_phy_stopped_state_start_handler
block|,
name|scic_sds_phy_default_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_stopped_state_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_default_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCI_BASE_PHY_STATE_STARTING
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_default_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_default_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCI_BASE_PHY_STATE_READY
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_ready_state_stop_handler
block|,
name|scic_sds_phy_ready_state_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_ready_state_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCI_BASE_PHY_STATE_RESETTING
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_default_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_resetting_state_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCI_BASE_PHY_STATE_FINAL
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_default_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_default_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  PHY STATE PRIVATE METHODS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|/**  * This method will stop the SCIC_SDS_PHY object. This does not reset the  * protocol engine it just suspends it and places it in a state where it will  * not cause the end device to power up.  *  * @param[in] this_phy This is the SCIC_SDS_PHY object to stop.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scu_link_layer_stop_protocol_engine
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|U32
name|scu_sas_pcfg_value
decl_stmt|;
name|U32
name|enable_spinup_value
decl_stmt|;
comment|// Suspend the protocol engine and place it in a sata spinup hold state
name|scu_sas_pcfg_value
operator|=
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|scu_sas_pcfg_value
operator||=
operator|(
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_RESET
argument_list|)
operator||
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|SUSPEND_PROTOCOL_ENGINE
argument_list|)
operator||
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|SATA_SPINUP_HOLD
argument_list|)
operator|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|scu_sas_pcfg_value
argument_list|)
expr_stmt|;
comment|// Disable the notify enable spinup primitives
name|enable_spinup_value
operator|=
name|SCU_SAS_ENSPINUP_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|enable_spinup_value
operator|&=
operator|~
name|SCU_ENSPINUP_GEN_BIT
argument_list|(
name|ENABLE
argument_list|)
expr_stmt|;
name|SCU_SAS_ENSPINUP_WRITE
argument_list|(
name|this_phy
argument_list|,
name|enable_spinup_value
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will start the OOB/SN state machine for this SCIC_SDS_PHY  * object.  *  * @param[in] this_phy This is the SCIC_SDS_PHY object on which to start the  *       OOB/SN state machine.  */
end_comment

begin_function
specifier|static
name|void
name|scu_link_layer_start_oob
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|U32
name|scu_sas_pcfg_value
decl_stmt|;
comment|/* Reset OOB sequence - start */
name|scu_sas_pcfg_value
operator|=
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|scu_sas_pcfg_value
operator|&=
operator|~
operator|(
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_RESET
argument_list|)
operator||
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|HARD_RESET
argument_list|)
operator|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|scu_sas_pcfg_value
argument_list|)
expr_stmt|;
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
comment|/* Reset OOB sequence - end */
comment|/* Start OOB sequence - start */
name|scu_sas_pcfg_value
operator|=
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|scu_sas_pcfg_value
operator||=
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_ENABLE
argument_list|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|scu_sas_pcfg_value
argument_list|)
expr_stmt|;
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
comment|/* Start OOB sequence - end */
block|}
end_function

begin_comment
comment|/**  * This method will transmit a hard reset request on the specified phy. The  * SCU hardware requires that we reset the OOB state machine and set the hard  * reset bit in the phy configuration register.  * We then must start OOB over with the hard reset bit set.  *  * @param[in] this_phy  */
end_comment

begin_function
specifier|static
name|void
name|scu_link_layer_tx_hard_reset
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|U32
name|phy_configuration_value
decl_stmt|;
comment|// SAS Phys must wait for the HARD_RESET_TX event notification to transition
comment|// to the starting state.
name|phy_configuration_value
operator|=
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|phy_configuration_value
operator||=
operator|(
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|HARD_RESET
argument_list|)
operator||
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_RESET
argument_list|)
operator|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|phy_configuration_value
argument_list|)
expr_stmt|;
comment|// Now take the OOB state machine out of reset
name|phy_configuration_value
operator||=
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_ENABLE
argument_list|)
expr_stmt|;
name|phy_configuration_value
operator|&=
operator|~
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_RESET
argument_list|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|phy_configuration_value
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  PHY BASE STATE METHODS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCI_BASE_PHY_STATE_INITIAL.  *    - This function sets the state handlers for the phy object base state  * machine initial state.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_initial_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_base_state_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCI_BASE_PHY_STATE_INITIAL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCI_BASE_PHY_STATE_INITIAL.  *    - This function sets the state handlers for the phy object base state  * machine initial state.  *    - The SCU hardware is requested to stop the protocol engine.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_stopped_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
comment|/// @todo We need to get to the controller to place this PE in a reset state
name|scic_sds_phy_set_base_state_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCI_BASE_PHY_STATE_STOPPED
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_phy
operator|->
name|sata_timeout_timer
operator|!=
name|NULL
condition|)
block|{
name|scic_cb_timer_destroy
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
operator|->
name|sata_timeout_timer
argument_list|)
expr_stmt|;
name|this_phy
operator|->
name|sata_timeout_timer
operator|=
name|NULL
expr_stmt|;
block|}
name|scu_link_layer_stop_protocol_engine
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCI_BASE_PHY_STATE_STARTING.  *    - This function sets the state handlers for the phy object base state  * machine starting state.  *    - The SCU hardware is requested to start OOB/SN on this protocol engine.  *    - The phy starting substate machine is started.  *    - If the previous state was the ready state then the  *      SCIC_SDS_CONTROLLER is informed that the phy has gone link down.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_base_state_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCI_BASE_PHY_STATE_STARTING
argument_list|)
expr_stmt|;
name|scu_link_layer_stop_protocol_engine
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|scu_link_layer_start_oob
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
comment|// We don't know what kind of phy we are going to be just yet
name|this_phy
operator|->
name|protocol
operator|=
name|SCIC_SDS_PHY_PROTOCOL_UNKNOWN
expr_stmt|;
name|this_phy
operator|->
name|bcn_received_while_port_unassigned
operator|=
name|FALSE
expr_stmt|;
comment|// Change over to the starting substate machine to continue
name|sci_base_state_machine_start
argument_list|(
operator|&
name|this_phy
operator|->
name|starting_substate_machine
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
operator|.
name|previous_state_id
operator|==
name|SCI_BASE_PHY_STATE_READY
condition|)
block|{
name|scic_sds_controller_link_down
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|scic_sds_phy_get_port
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCI_BASE_PHY_STATE_READY.  *    - This function sets the state handlers for the phy object base state  * machine ready state.  *    - The SCU hardware protocol engine is resumed.  *    - The SCIC_SDS_CONTROLLER is informed that the phy object has gone link  *      up.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_ready_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_base_state_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCI_BASE_PHY_STATE_READY
argument_list|)
expr_stmt|;
name|scic_sds_controller_link_up
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|scic_sds_phy_get_port
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * exiting the SCI_BASE_PHY_STATE_INITIAL. This function suspends the SCU  * hardware protocol engine represented by this SCIC_SDS_PHY object.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_ready_state_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_suspend
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCI_BASE_PHY_STATE_RESETTING.  *    - This function sets the state handlers for the phy object base state  * machine resetting state.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_resetting_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_base_state_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCI_BASE_PHY_STATE_RESETTING
argument_list|)
expr_stmt|;
comment|// The phy is being reset, therefore deactivate it from the port.
comment|// In the resetting state we don't notify the user regarding
comment|// link up and link down notifications.
name|scic_sds_port_deactivate_phy
argument_list|(
name|this_phy
operator|->
name|owning_port
argument_list|,
name|this_phy
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_phy
operator|->
name|protocol
operator|==
name|SCIC_SDS_PHY_PROTOCOL_SAS
condition|)
block|{
name|scu_link_layer_tx_hard_reset
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// The SCU does not need to have a descrete reset state so just go back to
comment|// the starting state.
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_phy
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_PHY_STATE_STARTING
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCI_BASE_PHY_STATE_FINAL.  *    - This function sets the state handlers for the phy object base state  * machine final state.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_final_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_base_state_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCI_BASE_PHY_STATE_FINAL
argument_list|)
expr_stmt|;
comment|// Nothing to do here
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCI_BASE_STATE_T
name|scic_sds_phy_state_table
index|[
name|SCI_BASE_PHY_MAX_STATES
index|]
init|=
block|{
block|{
name|SCI_BASE_PHY_STATE_INITIAL
block|,
name|scic_sds_phy_initial_state_enter
block|,
name|NULL
block|,    }
block|,
block|{
name|SCI_BASE_PHY_STATE_STOPPED
block|,
name|scic_sds_phy_stopped_state_enter
block|,
name|NULL
block|,    }
block|,
block|{
name|SCI_BASE_PHY_STATE_STARTING
block|,
name|scic_sds_phy_starting_state_enter
block|,
name|NULL
block|,    }
block|,
block|{
name|SCI_BASE_PHY_STATE_READY
block|,
name|scic_sds_phy_ready_state_enter
block|,
name|scic_sds_phy_ready_state_exit
block|,    }
block|,
block|{
name|SCI_BASE_PHY_STATE_RESETTING
block|,
name|scic_sds_phy_resetting_state_enter
block|,
name|NULL
block|,    }
block|,
block|{
name|SCI_BASE_PHY_STATE_FINAL
block|,
name|scic_sds_phy_final_state_enter
block|,
name|NULL
block|,    }
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* PHY STARTING SUB-STATE MACHINE
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//* SCIC SDS PHY HELPER FUNCTIONS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * This method continues the link training for the phy as if it were a SAS PHY  * instead of a SATA PHY. This is done because the completion queue had a SAS  * PHY DETECTED event when the state machine was expecting a SATA PHY event.  *  * @param[in] this_phy The phy object that received SAS PHY DETECTED.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_start_sas_link_training
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|U32
name|phy_control
decl_stmt|;
name|phy_control
operator|=
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|phy_control
operator||=
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|SATA_SPINUP_HOLD
argument_list|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|phy_control
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_phy
operator|->
name|starting_substate_machine
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SAS_SPEED_EN
argument_list|)
expr_stmt|;
name|this_phy
operator|->
name|protocol
operator|=
name|SCIC_SDS_PHY_PROTOCOL_SAS
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method continues the link training for the phy as if it were a SATA  * PHY instead of a SAS PHY.  This is done because the completion queue had a  * SATA SPINUP HOLD event when the state machine was expecting a SAS PHY  * event.  *  * @param[in] this_phy The phy object that received a SATA SPINUP HOLD event  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_start_sata_link_training
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_phy
operator|->
name|starting_substate_machine
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_POWER
argument_list|)
expr_stmt|;
name|this_phy
operator|->
name|protocol
operator|=
name|SCIC_SDS_PHY_PROTOCOL_SATA
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method performs processing common to all protocols upon  *        completion of link training.  *  * @param[in,out] this_phy This parameter specifies the phy object for which  *                link training has completed.  * @param[in]     max_link_rate This parameter specifies the maximum link  *                rate to be associated with this phy.  * @param[in]     next_state This parameter specifies the next state for the  *                phy's starting sub-state machine.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_complete_link_training
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|SCI_SAS_LINK_RATE
name|max_link_rate
parameter_list|,
name|U32
name|next_state
parameter_list|)
block|{
name|this_phy
operator|->
name|max_negotiated_speed
operator|=
name|max_link_rate
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|next_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method restarts the SCIC_SDS_PHY objects base state machine in the  * starting state from any starting substate.  *  * @param[in] this_phy The SCIC_SDS_PHY object to restart.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_phy_restart_starting_state
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
comment|// Stop the current substate machine
name|sci_base_state_machine_stop
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|)
expr_stmt|;
comment|// Re-enter the base state machine starting state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_base_state_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCI_BASE_PHY_STATE_STARTING
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//* SCIC SDS PHY general handlers
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_general_stop_handler
parameter_list|(
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
expr_stmt|;
name|sci_base_state_machine_stop
argument_list|(
operator|&
name|this_phy
operator|->
name|starting_substate_machine
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|phy
operator|->
name|state_machine
argument_list|,
name|SCI_BASE_PHY_STATE_STOPPED
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//* SCIC SDS PHY EVENT_HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * This method is called when an event notification is received for the phy  * object when in the state SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SPEED_EN.  *    - decode the event  *       - sas phy detected causes a state transition to the wait for speed  *         event notification.  *       - any other events log a warning message and set a failure status  *  * @param[in] phy This SCIC_SDS_PHY object which has received an event.  * @param[in] event_code This is the event code which the phy object is to  *       decode.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS on any valid event notification  * @retval SCI_FAILURE on any unexpected event notifation  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_ossp_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|U32
name|result
init|=
name|SCI_SUCCESS
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_SAS_PHY_DETECTED
case|:
name|scic_sds_phy_start_sas_link_training
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|this_phy
operator|->
name|is_in_link_training
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SATA_SPINUP_HOLD
case|:
name|scic_sds_phy_start_sata_link_training
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|this_phy
operator|->
name|is_in_link_training
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_RECEIVED_EVENTS
operator|,
literal|"PHY starting substate machine recieved unexpected event_code %x\n"
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * This method is called when an event notification is received for the phy  * object when in the state SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SPEED_EN.  *    - decode the event  *       - sas phy detected returns us back to this state.  *       - speed event detected causes a state transition to the wait for iaf.  *       - identify timeout is an un-expected event and the state machine is  *         restarted.  *       - link failure events restart the starting state machine  *       - any other events log a warning message and set a failure status  *  * @param[in] phy This SCIC_SDS_PHY object which has received an event.  * @param[in] event_code This is the event code which the phy object is to  *       decode.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS on any valid event notification  * @retval SCI_FAILURE on any unexpected event notifation  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_sas_phy_speed_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|U32
name|result
init|=
name|SCI_SUCCESS
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_SAS_PHY_DETECTED
case|:
comment|// Why is this being reported again by the controller?
comment|// We would re-enter this state so just stay here
break|break;
case|case
name|SCU_EVENT_SAS_15
case|:
case|case
name|SCU_EVENT_SAS_15_SSC
case|:
name|scic_sds_phy_complete_link_training
argument_list|(
name|this_phy
argument_list|,
name|SCI_SAS_150_GB
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_IAF_UF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SAS_30
case|:
case|case
name|SCU_EVENT_SAS_30_SSC
case|:
name|scic_sds_phy_complete_link_training
argument_list|(
name|this_phy
argument_list|,
name|SCI_SAS_300_GB
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_IAF_UF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SAS_60
case|:
case|case
name|SCU_EVENT_SAS_60_SSC
case|:
name|scic_sds_phy_complete_link_training
argument_list|(
name|this_phy
argument_list|,
name|SCI_SAS_600_GB
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_IAF_UF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SATA_SPINUP_HOLD
case|:
comment|// We were doing SAS PHY link training and received a SATA PHY event
comment|// continue OOB/SN as if this were a SATA PHY
name|scic_sds_phy_start_sata_link_training
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_LINK_FAILURE
case|:
comment|// Link failure change state back to the starting state
name|scic_sds_phy_restart_starting_state
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_RECEIVED_EVENTS
operator|,
literal|"PHY starting substate machine recieved unexpected event_code %x\n"
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * This method is called when an event notification is received for the phy  * object when in the state SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_IAF_UF.  *    - decode the event  *       - sas phy detected event backs up the state machine to the await  *         speed notification.  *       - identify timeout is an un-expected event and the state machine is  *         restarted.  *       - link failure events restart the starting state machine  *       - any other events log a warning message and set a failure status  *  * @param[in] phy This SCIC_SDS_PHY object which has received an event.  * @param[in] event_code This is the event code which the phy object is to  *       decode.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS on any valid event notification  * @retval SCI_FAILURE on any unexpected event notifation  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_iaf_uf_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|U32
name|result
init|=
name|SCI_SUCCESS
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_SAS_PHY_DETECTED
case|:
comment|// Backup the state machine
name|scic_sds_phy_start_sas_link_training
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SATA_SPINUP_HOLD
case|:
comment|// We were doing SAS PHY link training and received a SATA PHY event
comment|// continue OOB/SN as if this were a SATA PHY
name|scic_sds_phy_start_sata_link_training
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_RECEIVED_IDENTIFY_TIMEOUT
case|:
case|case
name|SCU_EVENT_LINK_FAILURE
case|:
case|case
name|SCU_EVENT_HARD_RESET_RECEIVED
case|:
comment|// Start the oob/sn state machine over again
name|scic_sds_phy_restart_starting_state
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_RECEIVED_EVENTS
operator|,
literal|"PHY starting substate machine recieved unexpected event_code %x\n"
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * This method is called when an event notification is received for the phy  * object when in the state SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_POWER.  *    - decode the event  *       - link failure events restart the starting state machine  *       - any other events log a warning message and set a failure status  *  * @param[in] phy This SCIC_SDS_PHY object which has received an event.  * @param[in] event_code This is the event code which the phy object is to  *       decode.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS on a link failure event  * @retval SCI_FAILURE on any unexpected event notifation  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_sas_power_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|U32
name|result
init|=
name|SCI_SUCCESS
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_LINK_FAILURE
case|:
comment|// Link failure change state back to the starting state
name|scic_sds_phy_restart_starting_state
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_RECEIVED_EVENTS
operator|,
literal|"PHY starting substate machine recieved unexpected event_code %x\n"
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * This method is called when an event notification is received for the phy  * object when in the state SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_POWER.  *    - decode the event  *       - link failure events restart the starting state machine  *       - sata spinup hold events are ignored since they are expected  *       - any other events log a warning message and set a failure status  *  * @param[in] phy This SCIC_SDS_PHY object which has received an event.  * @param[in] event_code This is the event code which the phy object is to  *       decode.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS on a link failure event  * @retval SCI_FAILURE on any unexpected event notifation  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_sata_power_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|U32
name|result
init|=
name|SCI_SUCCESS
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_LINK_FAILURE
case|:
comment|// Link failure change state back to the starting state
name|scic_sds_phy_restart_starting_state
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SATA_SPINUP_HOLD
case|:
comment|// These events are received every 10ms and are expected while in this state
break|break;
case|case
name|SCU_EVENT_SAS_PHY_DETECTED
case|:
comment|// There has been a change in the phy type before OOB/SN for the
comment|// SATA finished start down the SAS link traning path.
name|scic_sds_phy_start_sas_link_training
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_RECEIVED_EVENTS
operator|,
literal|"PHY starting substate machine recieved unexpected event_code %x\n"
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * This method is called when an event notification is received for the phy  * object when in the state SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_PHY_EN.  *    - decode the event  *       - link failure events restart the starting state machine  *       - sata spinup hold events are ignored since they are expected  *       - sata phy detected event change to the wait speed event  *       - any other events log a warning message and set a failure status  *  * @param[in] phy This SCIC_SDS_PHY object which has received an event.  * @param[in] event_code This is the event code which the phy object is to  *       decode.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS on a link failure event  * @retval SCI_FAILURE on any unexpected event notifation  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_sata_phy_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|U32
name|result
init|=
name|SCI_SUCCESS
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_LINK_FAILURE
case|:
comment|// Link failure change state back to the starting state
name|scic_sds_phy_restart_starting_state
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SATA_SPINUP_HOLD
case|:
comment|// These events might be received since we dont know how many may be in
comment|// the completion queue while waiting for power
break|break;
case|case
name|SCU_EVENT_SATA_PHY_DETECTED
case|:
name|this_phy
operator|->
name|protocol
operator|=
name|SCIC_SDS_PHY_PROTOCOL_SATA
expr_stmt|;
comment|// We have received the SATA PHY notification change state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_SPEED_EN
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SAS_PHY_DETECTED
case|:
comment|// There has been a change in the phy type before OOB/SN for the
comment|// SATA finished start down the SAS link traning path.
name|scic_sds_phy_start_sas_link_training
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_RECEIVED_EVENTS
operator|,
literal|"PHY starting substate machine recieved unexpected event_code %x\n"
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * This method is called when an event notification is received for the phy  * object when in the state  * SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_SPEED_EN.  *    - decode the event  *       - sata phy detected returns us back to this state.  *       - speed event detected causes a state transition to the wait for  *         signature.  *       - link failure events restart the starting state machine  *       - any other events log a warning message and set a failure status  *  * @param[in] phy This SCIC_SDS_PHY object which has received an event.  * @param[in] event_code This is the event code which the phy object is to  *       decode.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS on any valid event notification  * @retval SCI_FAILURE on any unexpected event notifation  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_sata_speed_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|U32
name|result
init|=
name|SCI_SUCCESS
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_SATA_PHY_DETECTED
case|:
comment|// The hardware reports multiple SATA PHY detected events
comment|// ignore the extras
break|break;
case|case
name|SCU_EVENT_SATA_15
case|:
case|case
name|SCU_EVENT_SATA_15_SSC
case|:
name|scic_sds_phy_complete_link_training
argument_list|(
name|this_phy
argument_list|,
name|SCI_SAS_150_GB
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SIG_FIS_UF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SATA_30
case|:
case|case
name|SCU_EVENT_SATA_30_SSC
case|:
name|scic_sds_phy_complete_link_training
argument_list|(
name|this_phy
argument_list|,
name|SCI_SAS_300_GB
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SIG_FIS_UF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SATA_60
case|:
case|case
name|SCU_EVENT_SATA_60_SSC
case|:
name|scic_sds_phy_complete_link_training
argument_list|(
name|this_phy
argument_list|,
name|SCI_SAS_600_GB
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SIG_FIS_UF
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_LINK_FAILURE
case|:
comment|// Link failure change state back to the starting state
name|scic_sds_phy_restart_starting_state
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_SAS_PHY_DETECTED
case|:
comment|// There has been a change in the phy type before OOB/SN for the
comment|// SATA finished start down the SAS link traning path.
name|scic_sds_phy_start_sas_link_training
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_RECEIVED_EVENTS
operator|,
literal|"PHY starting substate machine recieved unexpected event_code %x\n"
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * This method is called when an event notification is received for the phy  * object when in the state SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SIG_FIS_UF.  *    - decode the event  *       - sas phy detected event backs up the state machine to the await  *         speed notification.  *       - identify timeout is an un-expected event and the state machine is  *         restarted.  *       - link failure events restart the starting state machine  *       - any other events log a warning message and set a failure status  *  * @param[in] phy This SCIC_SDS_PHY object which has received an event.  * @param[in] event_code This is the event code which the phy object is to  *       decode.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS on any valid event notification  * @retval SCI_FAILURE on any unexpected event notifation  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_sig_fis_event_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|U32
name|result
init|=
name|SCI_SUCCESS
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_SATA_PHY_DETECTED
case|:
comment|// Backup the state machine
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_SPEED_EN
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_LINK_FAILURE
case|:
comment|// Link failure change state back to the starting state
name|scic_sds_phy_restart_starting_state
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_RECEIVED_EVENTS
operator|,
literal|"PHY starting substate machine recieved unexpected event_code %x\n"
operator|,
name|event_code
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_FAILURE
expr_stmt|;
break|break;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  SCIC SDS PHY FRAME_HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * This method decodes the unsolicited frame when the SCIC_SDS_PHY is in the  * SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_IAF_UF.  *    - Get the UF Header  *    - If the UF is an IAF  *       - Copy IAF data to local phy object IAF data buffer.  *       - Change starting substate to wait power.  *    - else  *       - log warning message of unexpected unsolicted frame  *    - release frame buffer  *  * @param[in] phy This is SCIC_SDS_PHY object which is being requested to  *       decode the frame data.  * @param[in] frame_index This is the index of the unsolicited frame which was  *       received for this phy.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_iaf_uf_frame_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCI_STATUS
name|result
decl_stmt|;
name|U32
modifier|*
name|frame_words
decl_stmt|;
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_T
modifier|*
name|identify_frame
decl_stmt|;
name|result
operator|=
name|scic_sds_unsolicited_frame_control_get_header
argument_list|(
operator|&
operator|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_words
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SCI_SUCCESS
condition|)
block|{
return|return
name|result
return|;
block|}
name|frame_words
index|[
literal|0
index|]
operator|=
name|SCIC_SWAP_DWORD
argument_list|(
name|frame_words
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|identify_frame
operator|=
operator|(
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_T
operator|*
operator|)
name|frame_words
expr_stmt|;
if|if
condition|(
name|identify_frame
operator|->
name|address_frame_type
operator|==
literal|0
condition|)
block|{
comment|// Byte swap the rest of the frame so we can make
comment|// a copy of the buffer
name|frame_words
index|[
literal|1
index|]
operator|=
name|SCIC_SWAP_DWORD
argument_list|(
name|frame_words
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|frame_words
index|[
literal|2
index|]
operator|=
name|SCIC_SWAP_DWORD
argument_list|(
name|frame_words
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|frame_words
index|[
literal|3
index|]
operator|=
name|SCIC_SWAP_DWORD
argument_list|(
name|frame_words
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|frame_words
index|[
literal|4
index|]
operator|=
name|SCIC_SWAP_DWORD
argument_list|(
name|frame_words
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|frame_words
index|[
literal|5
index|]
operator|=
name|SCIC_SWAP_DWORD
argument_list|(
name|frame_words
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|this_phy
operator|->
name|phy_type
operator|.
name|sas
operator|.
name|identify_address_frame_buffer
argument_list|,
name|identify_frame
argument_list|,
sizeof|sizeof
argument_list|(
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_T
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|identify_frame
operator|->
name|protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|smp_target
condition|)
block|{
comment|// We got the IAF for an expander PHY go to the final state since
comment|// there are no power requirements for expander phys.
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_FINAL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// We got the IAF we can now go to the await spinup semaphore state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SAS_POWER
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|SCI_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_UNSOLICITED_FRAMES
operator|,
literal|"PHY starting substate machine recieved unexpected frame id %x\n"
operator|,
name|frame_index
operator|)
argument_list|)
expr_stmt|;
block|}
comment|// Regardless of the result release this frame since we are done with it
name|scic_sds_controller_release_frame
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * This method decodes the unsolicited frame when the SCIC_SDS_PHY is in the  * SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SIG_FIS_UF.  *    - Get the UF Header  *    - If the UF is an SIGNATURE FIS  *       - Copy IAF data to local phy object SIGNATURE FIS data buffer.  *    - else  *       - log warning message of unexpected unsolicted frame  *    - release frame buffer  *  * @param[in] phy This is SCIC_SDS_PHY object which is being requested to  *       decode the frame data.  * @param[in] frame_index This is the index of the unsolicited frame which was  *       received for this phy.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  *  * @todo Must decode the SIGNATURE FIS data  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_sig_fis_frame_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCI_STATUS
name|result
decl_stmt|;
name|U32
modifier|*
name|frame_words
decl_stmt|;
name|SATA_FIS_HEADER_T
modifier|*
name|fis_frame_header
decl_stmt|;
name|U32
modifier|*
name|fis_frame_data
decl_stmt|;
name|result
operator|=
name|scic_sds_unsolicited_frame_control_get_header
argument_list|(
operator|&
operator|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_words
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SCI_SUCCESS
condition|)
block|{
return|return
name|result
return|;
block|}
name|fis_frame_header
operator|=
operator|(
name|SATA_FIS_HEADER_T
operator|*
operator|)
name|frame_words
expr_stmt|;
if|if
condition|(
operator|(
name|fis_frame_header
operator|->
name|fis_type
operator|==
name|SATA_FIS_TYPE_REGD2H
operator|)
operator|&&
operator|!
operator|(
name|fis_frame_header
operator|->
name|status
operator|&
name|ATA_STATUS_REG_BSY_BIT
operator|)
condition|)
block|{
name|scic_sds_unsolicited_frame_control_get_buffer
argument_list|(
operator|&
operator|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|fis_frame_data
argument_list|)
expr_stmt|;
name|scic_sds_controller_copy_sata_response
argument_list|(
operator|&
name|this_phy
operator|->
name|phy_type
operator|.
name|sata
operator|.
name|signature_fis_buffer
argument_list|,
name|frame_words
argument_list|,
name|fis_frame_data
argument_list|)
expr_stmt|;
comment|// We got the IAF we can now go to the await spinup semaphore state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_FINAL
argument_list|)
expr_stmt|;
name|result
operator|=
name|SCI_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_phy
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PHY
operator||
name|SCIC_LOG_OBJECT_UNSOLICITED_FRAMES
operator|,
literal|"PHY starting substate machine recieved unexpected frame id %x\n"
operator|,
name|frame_index
operator|)
argument_list|)
expr_stmt|;
block|}
comment|// Regardless of the result release this frame since we are done with it
name|scic_sds_controller_release_frame
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//* SCIC SDS PHY POWER_HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * This method is called by the SCIC_SDS_CONTROLLER when the phy object is  * granted power.  *    - The notify enable spinups are turned on for this phy object  *    - The phy state machine is transitioned to the  *    SCIC_SDS_PHY_STARTING_SUBSTATE_FINAL.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_sas_power_consume_power_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|U32
name|enable_spinup
decl_stmt|;
name|enable_spinup
operator|=
name|SCU_SAS_ENSPINUP_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|enable_spinup
operator||=
name|SCU_ENSPINUP_GEN_BIT
argument_list|(
name|ENABLE
argument_list|)
expr_stmt|;
name|SCU_SAS_ENSPINUP_WRITE
argument_list|(
name|this_phy
argument_list|,
name|enable_spinup
argument_list|)
expr_stmt|;
comment|// Change state to the final state this substate machine has run to completion
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_FINAL
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method is called by the SCIC_SDS_CONTROLLER when the phy object is  * granted power.  *    - The phy state machine is transitioned to the  *    SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_PHY_EN.  *  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_phy_starting_substate_await_sata_power_consume_power_handler
parameter_list|(
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
name|U32
name|scu_sas_pcfg_value
decl_stmt|;
comment|// Release the spinup hold state and reset the OOB state machine
name|scu_sas_pcfg_value
operator|=
name|SCU_SAS_PCFG_READ
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|scu_sas_pcfg_value
operator|&=
operator|~
operator|(
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|SATA_SPINUP_HOLD
argument_list|)
operator||
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_ENABLE
argument_list|)
operator|)
expr_stmt|;
name|scu_sas_pcfg_value
operator||=
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_RESET
argument_list|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|scu_sas_pcfg_value
argument_list|)
expr_stmt|;
comment|// Now restart the OOB operation
name|scu_sas_pcfg_value
operator|&=
operator|~
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_RESET
argument_list|)
expr_stmt|;
name|scu_sas_pcfg_value
operator||=
name|SCU_SAS_PCFG_GEN_BIT
argument_list|(
name|OOB_ENABLE
argument_list|)
expr_stmt|;
name|SCU_SAS_PCFG_WRITE
argument_list|(
name|this_phy
argument_list|,
name|scu_sas_pcfg_value
argument_list|)
expr_stmt|;
comment|// Change state to the final state this substate machine has run to completion
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_PHY_EN
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCIC_SDS_PHY_STATE_HANDLER_T
name|scic_sds_phy_starting_substate_handler_table
index|[
name|SCIC_SDS_PHY_STARTING_MAX_SUBSTATES
index|]
init|=
block|{
comment|// SCIC_SDS_PHY_STARTING_SUBSTATE_INITIAL
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_starting_substate_general_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_default_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_OSSP_EN
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_starting_substate_general_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_starting_substate_await_ossp_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SAS_SPEED_EN
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_starting_substate_general_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_starting_substate_await_sas_phy_speed_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_IAF_UF
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_default_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_starting_substate_await_iaf_uf_frame_handler
block|,
name|scic_sds_phy_starting_substate_await_iaf_uf_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SAS_POWER
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_starting_substate_general_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_starting_substate_await_sas_power_event_handler
block|,
name|scic_sds_phy_starting_substate_await_sas_power_consume_power_handler
block|}
block|,
comment|// SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_POWER,
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_starting_substate_general_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_starting_substate_await_sata_power_event_handler
block|,
name|scic_sds_phy_starting_substate_await_sata_power_consume_power_handler
block|}
block|,
comment|// SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_PHY_EN,
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_starting_substate_general_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_starting_substate_await_sata_phy_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_SPEED_EN,
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_starting_substate_general_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_starting_substate_await_sata_speed_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SIG_FIS_UF,
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_starting_substate_general_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_starting_substate_await_sig_fis_frame_handler
block|,
name|scic_sds_phy_starting_substate_await_sig_fis_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|,
comment|// SCIC_SDS_PHY_STARTING_SUBSTATE_FINAL
block|{
block|{
name|scic_sds_phy_default_start_handler
block|,
name|scic_sds_phy_starting_substate_general_stop_handler
block|,
name|scic_sds_phy_default_reset_handler
block|,
name|scic_sds_phy_default_destroy_handler
block|}
block|,
name|scic_sds_phy_default_frame_handler
block|,
name|scic_sds_phy_default_event_handler
block|,
name|scic_sds_phy_default_consume_power_handler
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * This macro sets the starting substate handlers by state_id  */
end_comment

begin_define
define|#
directive|define
name|scic_sds_phy_set_starting_substate_handlers
parameter_list|(
name|phy
parameter_list|,
name|state_id
parameter_list|)
define|\
value|scic_sds_phy_set_state_handlers( \       (phy), \&scic_sds_phy_starting_substate_handler_table[(state_id)] \    )
end_define

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  PHY STARTING SUBSTATE METHODS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCIC_SDS_PHY_STARTING_SUBSTATE_INITIAL.  *    - The initial state handlers are put in place for the SCIC_SDS_PHY  *      object.  *    - The state is changed to the wait phy type event notification.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_initial_substate_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_starting_substate_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_INITIAL
argument_list|)
expr_stmt|;
comment|// This is just an temporary state go off to the starting state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_starting_substate_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_OSSP_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_PHY_TYPE_EN.  *    - Set the SCIC_SDS_PHY object state handlers for this state.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_ossp_en_substate_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_starting_substate_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_OSSP_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SPEED_EN.  *    - Set the SCIC_SDS_PHY object state handlers for this state.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sas_speed_en_substate_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_starting_substate_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SAS_SPEED_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_IAF_UF.  *    - Set the SCIC_SDS_PHY object state handlers for this state.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_iaf_uf_substate_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_starting_substate_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_IAF_UF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SAS_POWER.  *    - Set the SCIC_SDS_PHY object state handlers for this state.  *    - Add this phy object to the power control queue  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sas_power_substate_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_starting_substate_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SAS_POWER
argument_list|)
expr_stmt|;
name|scic_sds_controller_power_control_queue_insert
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * exiting the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SAS_POWER.  *    - Remove the SCIC_SDS_PHY object from the power control queue.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sas_power_substate_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_controller_power_control_queue_remove
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_POWER.  *    - Set the SCIC_SDS_PHY object state handlers for this state.  *    - Add this phy object to the power control queue  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sata_power_substate_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_starting_substate_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_POWER
argument_list|)
expr_stmt|;
name|scic_sds_controller_power_control_queue_insert
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * exiting the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_POWER.  *    - Remove the SCIC_SDS_PHY object from the power control queue.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sata_power_substate_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_controller_power_control_queue_remove
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_PHY_EN.  *    - Set the SCIC_SDS_PHY object state handlers for this state.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sata_phy_substate_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_starting_substate_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_PHY_EN
argument_list|)
expr_stmt|;
name|scic_cb_timer_start
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
operator|->
name|sata_timeout_timer
argument_list|,
name|SCIC_SDS_SATA_LINK_TRAINING_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * exiting the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_SPEED_EN.  *    - stop the timer that was started on entry to await sata phy  *      event notification  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sata_phy_substate_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_cb_timer_stop
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
operator|->
name|sata_timeout_timer
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_SPEED_EN.  *    - Set the SCIC_SDS_PHY object state handlers for this state.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sata_speed_substate_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_starting_substate_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_SPEED_EN
argument_list|)
expr_stmt|;
name|scic_cb_timer_start
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
operator|->
name|sata_timeout_timer
argument_list|,
name|SCIC_SDS_SATA_LINK_TRAINING_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * exiting the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_SPEED_EN.  *    - stop the timer that was started on entry to await sata phy  *      event notification  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sata_speed_substate_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_cb_timer_stop
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
operator|->
name|sata_timeout_timer
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SIG_FIS_UF.  *    - Set the SCIC_SDS_PHY object state handlers for this state.  *    - Start the SIGNATURE FIS timeout timer  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sig_fis_uf_substate_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|BOOL
name|continue_to_ready_state
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_starting_substate_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SIG_FIS_UF
argument_list|)
expr_stmt|;
name|continue_to_ready_state
operator|=
name|scic_sds_port_link_detected
argument_list|(
name|this_phy
operator|->
name|owning_port
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
if|if
condition|(
name|continue_to_ready_state
condition|)
block|{
comment|// Clear the PE suspend condition so we can actually receive SIG FIS
comment|// The hardware will not respond to the XRDY until the PE suspend
comment|// condition is cleared.
name|scic_sds_phy_resume
argument_list|(
name|this_phy
argument_list|)
expr_stmt|;
name|scic_cb_timer_start
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
operator|->
name|sata_timeout_timer
argument_list|,
name|SCIC_SDS_SIGNATURE_FIS_TIMEOUT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this_phy
operator|->
name|is_in_link_training
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * exiting the SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SIG_FIS_UF.  *    - Stop the SIGNATURE FIS timeout timer.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_await_sig_fis_uf_substate_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_cb_timer_stop
argument_list|(
name|scic_sds_phy_get_controller
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|this_phy
operator|->
name|sata_timeout_timer
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PHY on  * entering the SCIC_SDS_PHY_STARTING_SUBSTATE_FINAL.  *    - Set the SCIC_SDS_PHY object state handlers for this state.  *    - Change base state machine to the ready state.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PHY object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_phy_starting_final_substate_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
decl_stmt|;
name|this_phy
operator|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_phy_set_starting_substate_handlers
argument_list|(
name|this_phy
argument_list|,
name|SCIC_SDS_PHY_STARTING_SUBSTATE_FINAL
argument_list|)
expr_stmt|;
comment|// State machine has run to completion so exit out and change
comment|// the base state machine to the ready state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_phy_get_base_state_machine
argument_list|(
name|this_phy
argument_list|)
argument_list|,
name|SCI_BASE_PHY_STATE_READY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCI_BASE_STATE_T
name|scic_sds_phy_starting_substates
index|[
name|SCIC_SDS_PHY_STARTING_MAX_SUBSTATES
index|]
init|=
block|{
block|{
name|SCIC_SDS_PHY_STARTING_SUBSTATE_INITIAL
block|,
name|scic_sds_phy_starting_initial_substate_enter
block|,
name|NULL
block|,    }
block|,
block|{
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_OSSP_EN
block|,
name|scic_sds_phy_starting_await_ossp_en_substate_enter
block|,
name|NULL
block|,    }
block|,
block|{
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SAS_SPEED_EN
block|,
name|scic_sds_phy_starting_await_sas_speed_en_substate_enter
block|,
name|NULL
block|,    }
block|,
block|{
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_IAF_UF
block|,
name|scic_sds_phy_starting_await_iaf_uf_substate_enter
block|,
name|NULL
block|,    }
block|,
block|{
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SAS_POWER
block|,
name|scic_sds_phy_starting_await_sas_power_substate_enter
block|,
name|scic_sds_phy_starting_await_sas_power_substate_exit
block|,    }
block|,
block|{
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_POWER
block|,
name|scic_sds_phy_starting_await_sata_power_substate_enter
block|,
name|scic_sds_phy_starting_await_sata_power_substate_exit
block|}
block|,
block|{
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_PHY_EN
block|,
name|scic_sds_phy_starting_await_sata_phy_substate_enter
block|,
name|scic_sds_phy_starting_await_sata_phy_substate_exit
block|}
block|,
block|{
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SATA_SPEED_EN
block|,
name|scic_sds_phy_starting_await_sata_speed_substate_enter
block|,
name|scic_sds_phy_starting_await_sata_speed_substate_exit
block|}
block|,
block|{
name|SCIC_SDS_PHY_STARTING_SUBSTATE_AWAIT_SIG_FIS_UF
block|,
name|scic_sds_phy_starting_await_sig_fis_uf_substate_enter
block|,
name|scic_sds_phy_starting_await_sig_fis_uf_substate_exit
block|}
block|,
block|{
name|SCIC_SDS_PHY_STARTING_SUBSTATE_FINAL
block|,
name|scic_sds_phy_starting_final_substate_enter
block|,
name|NULL
block|,    }
block|}
decl_stmt|;
end_decl_stmt

end_unit


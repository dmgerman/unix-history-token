begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * This file is provided under a dual BSD/GPLv2 license.  When using or  * redistributing this file, you may do so under either license.  *  * GPL LICENSE SUMMARY  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of version 2 of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it will be useful, but  * WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.  * The full GNU General Public License is included in this distribution  * in the file called LICENSE.GPL.  *  * BSD LICENSE  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in  *     the documentation and/or other materials provided with the  *     distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/**  * @file  *  * @brief This file contains the methods for the SCIF_SAS_SMP_REMMOTE object's  *           clear affiliation activity.  */
end_comment

begin_include
include|#
directive|include
file|<dev/isci/scil/sci_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scif_sas_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scif_sas_remote_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scif_sas_logger.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scif_sas_smp_remote_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scif_sas_smp_io_request.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_sas.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_io_request.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_remote_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scif_sas_smp_phy.h>
end_include

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* P R I V A T E   M E T H O D S
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * @brief This method finds the next smp phy (from the anchor_phy) that link to  *           a SATA end device.  *  * @param[in] fw_device the framework SMP device that is clearing affiliation for  *               its remote SATA devices'  *  * @return SCIF_SAS_SMP_PHY_T a smp phy, to which clear affiliation phy control command  *            is to be sent.  */
end_comment

begin_function
specifier|static
name|SCIF_SAS_SMP_PHY_T
modifier|*
name|scif_sas_smp_remote_device_find_next_smp_phy_link_to_sata
parameter_list|(
name|SCIF_SAS_SMP_PHY_T
modifier|*
name|anchor_phy
parameter_list|)
block|{
name|SCI_FAST_LIST_ELEMENT_T
modifier|*
name|element
init|=
operator|&
name|anchor_phy
operator|->
name|list_element
decl_stmt|;
name|SCIF_SAS_SMP_PHY_T
modifier|*
name|curr_smp_phy
init|=
name|NULL
decl_stmt|;
while|while
condition|(
name|element
operator|!=
name|NULL
condition|)
block|{
name|curr_smp_phy
operator|=
operator|(
name|SCIF_SAS_SMP_PHY_T
operator|*
operator|)
name|sci_fast_list_get_object
argument_list|(
name|element
argument_list|)
expr_stmt|;
name|element
operator|=
name|sci_fast_list_get_next
argument_list|(
name|element
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr_smp_phy
operator|->
name|attached_device_type
operator|==
name|SMP_END_DEVICE_ONLY
operator|&&
name|curr_smp_phy
operator|->
name|u
operator|.
name|end_device
operator|!=
name|NULL
condition|)
block|{
name|SMP_DISCOVER_RESPONSE_PROTOCOLS_T
name|dev_protocols
decl_stmt|;
name|scic_remote_device_get_protocols
argument_list|(
name|curr_smp_phy
operator|->
name|u
operator|.
name|end_device
operator|->
name|core_object
argument_list|,
operator|&
name|dev_protocols
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|attached_stp_target
condition|)
return|return
name|curr_smp_phy
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* P U B L I C   M E T H O D S
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * @brief This method starts the clear affiliation activity for a  *           smp device's remote SATA devices.  *  * @param[in] fw_device the framework SMP device that is clearing affiliation for  *               its remote SATA devices.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_sas_smp_remote_device_start_clear_affiliation
parameter_list|(
name|SCIF_SAS_REMOTE_DEVICE_T
modifier|*
name|fw_device
parameter_list|)
block|{
name|SCIF_SAS_SMP_REMOTE_DEVICE_T
modifier|*
name|smp_device
init|=
operator|&
name|fw_device
operator|->
name|protocol_device
operator|.
name|smp_device
decl_stmt|;
name|SCIF_SAS_SMP_PHY_T
modifier|*
name|phy_to_clear_affiliation
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|smp_device
operator|->
name|smp_phy_list
operator|.
name|list_head
operator|!=
name|NULL
condition|)
block|{
name|phy_to_clear_affiliation
operator|=
name|scif_sas_smp_remote_device_find_next_smp_phy_link_to_sata
argument_list|(
operator|(
name|SCIF_SAS_SMP_PHY_T
operator|*
operator|)
name|smp_device
operator|->
name|smp_phy_list
operator|.
name|list_head
operator|->
name|object
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy_to_clear_affiliation
operator|!=
name|NULL
condition|)
block|{
name|smp_device
operator|->
name|curr_clear_affiliation_phy
operator|=
name|phy_to_clear_affiliation
expr_stmt|;
comment|//set current activity
name|fw_device
operator|->
name|protocol_device
operator|.
name|smp_device
operator|.
name|current_activity
operator|=
name|SCIF_SAS_SMP_REMOTE_DEVICE_ACTIVITY_CLEAR_AFFILIATION
expr_stmt|;
comment|//Set current_smp_request to PHY CONTROL.
name|fw_device
operator|->
name|protocol_device
operator|.
name|smp_device
operator|.
name|current_smp_request
operator|=
name|SMP_FUNCTION_PHY_CONTROL
expr_stmt|;
comment|//reset discover_to_start flag.
name|fw_device
operator|->
name|protocol_device
operator|.
name|smp_device
operator|.
name|scheduled_activity
operator|=
name|SCIF_SAS_SMP_REMOTE_DEVICE_ACTIVITY_NONE
expr_stmt|;
comment|//build PHY Control (clear affiliation) to the phy.
name|scif_sas_smp_request_construct_phy_control
argument_list|(
name|fw_device
operator|->
name|domain
operator|->
name|controller
argument_list|,
name|fw_device
argument_list|,
name|PHY_OPERATION_CLEAR_AFFILIATION
argument_list|,
name|phy_to_clear_affiliation
operator|->
name|phy_identifier
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|//issue DPC to start this request.
name|scif_cb_start_internal_io_task_schedule
argument_list|(
name|fw_device
operator|->
name|domain
operator|->
name|controller
argument_list|,
name|scif_sas_controller_start_high_priority_io
argument_list|,
name|fw_device
operator|->
name|domain
operator|->
name|controller
argument_list|)
expr_stmt|;
block|}
else|else
name|scif_sas_smp_remote_device_finish_clear_affiliation
argument_list|(
name|fw_device
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method continues the clear affiliation activity for a  *           smp device's remote SATA devices.  *  * @param[in] fw_device the framework SMP device that is clearing affiliation for  *               its remote SATA devices.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_sas_smp_remote_device_continue_clear_affiliation
parameter_list|(
name|SCIF_SAS_REMOTE_DEVICE_T
modifier|*
name|fw_device
parameter_list|)
block|{
name|SCIF_SAS_SMP_REMOTE_DEVICE_T
modifier|*
name|smp_device
init|=
operator|&
name|fw_device
operator|->
name|protocol_device
operator|.
name|smp_device
decl_stmt|;
comment|//search from next immediate smp phy.
name|SCIF_SAS_SMP_PHY_T
modifier|*
name|phy_to_clear_affiliation
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|smp_device
operator|->
name|curr_clear_affiliation_phy
operator|->
name|list_element
operator|.
name|next
operator|!=
name|NULL
condition|)
block|{
name|phy_to_clear_affiliation
operator|=
name|scif_sas_smp_remote_device_find_next_smp_phy_link_to_sata
argument_list|(
name|smp_device
operator|->
name|curr_clear_affiliation_phy
operator|->
name|list_element
operator|.
name|next
operator|->
name|object
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy_to_clear_affiliation
operator|!=
name|NULL
condition|)
block|{
name|smp_device
operator|->
name|curr_clear_affiliation_phy
operator|=
name|phy_to_clear_affiliation
expr_stmt|;
comment|//build PHY Control (clear affiliation) to the phy.
name|scif_sas_smp_request_construct_phy_control
argument_list|(
name|fw_device
operator|->
name|domain
operator|->
name|controller
argument_list|,
name|fw_device
argument_list|,
name|PHY_OPERATION_CLEAR_AFFILIATION
argument_list|,
name|phy_to_clear_affiliation
operator|->
name|phy_identifier
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|scif_sas_smp_remote_device_finish_clear_affiliation
argument_list|(
name|fw_device
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method finishes the clear affiliation activity for a  *           smp device's remote SATA devices. It then notify the domain it fihishes  *           the clear affiliation activity.  *  * @param[in] fw_device the framework SMP device that is clearing affiliation for  *               its remote SATA devices.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_sas_smp_remote_device_finish_clear_affiliation
parameter_list|(
name|SCIF_SAS_REMOTE_DEVICE_T
modifier|*
name|fw_device
parameter_list|)
block|{
name|SCIF_SAS_DOMAIN_T
modifier|*
name|fw_domain
init|=
name|fw_device
operator|->
name|domain
decl_stmt|;
name|scif_sas_smp_remote_device_clear
argument_list|(
name|fw_device
argument_list|)
expr_stmt|;
comment|//let domain continue to clear affiliation on other smp devices.
name|scif_sas_domain_continue_clear_affiliation
argument_list|(
name|fw_domain
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


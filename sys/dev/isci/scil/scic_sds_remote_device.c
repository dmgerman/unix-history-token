begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * This file is provided under a dual BSD/GPLv2 license.  When using or  * redistributing this file, you may do so under either license.  *  * GPL LICENSE SUMMARY  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of version 2 of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it will be useful, but  * WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.  * The full GNU General Public License is included in this distribution  * in the file called LICENSE.GPL.  *  * BSD LICENSE  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in  *     the documentation and/or other materials provided with the  *     distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/**  * @file  *  * @brief This file contains the implementation of remote device, it's  *        methods and state machine.  */
end_comment

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_sas.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sci_util.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_port.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_phy.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_remote_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_port.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_phy.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_remote_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_request.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_logger.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_user_callback.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_logger.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_remote_node_context.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scu_event_codes.h>
end_include

begin_define
define|#
directive|define
name|SCIC_SDS_REMOTE_DEVICE_RESET_TIMEOUT
value|(1000)
end_define

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  CORE REMOTE DEVICE PUBLIC METHODS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_function
name|U32
name|scic_remote_device_get_object_size
parameter_list|(
name|void
parameter_list|)
block|{
return|return
sizeof|sizeof
argument_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|SCIC_SDS_REMOTE_NODE_CONTEXT_T
argument_list|)
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|void
name|scic_remote_device_construct
parameter_list|(
name|SCI_PORT_HANDLE_T
name|port
parameter_list|,
name|void
modifier|*
name|remote_device_memory
parameter_list|,
name|SCI_REMOTE_DEVICE_HANDLE_T
modifier|*
name|new_remote_device_handle
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device_memory
decl_stmt|;
name|SCIC_SDS_PORT_T
modifier|*
name|the_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|the_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_construct(0x%x, 0x%x, 0x%x) enter\n"
operator|,
name|port
operator|,
name|remote_device_memory
operator|,
name|new_remote_device_handle
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|remote_device_memory
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|new_remote_device_handle
operator|=
name|this_device
expr_stmt|;
name|this_device
operator|->
name|owning_port
operator|=
name|the_port
expr_stmt|;
name|this_device
operator|->
name|started_request_count
operator|=
literal|0
expr_stmt|;
name|this_device
operator|->
name|rnc
operator|=
operator|(
name|SCIC_SDS_REMOTE_NODE_CONTEXT_T
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|this_device
operator|+
sizeof|sizeof
argument_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
argument_list|)
operator|)
expr_stmt|;
name|sci_base_remote_device_construct
argument_list|(
operator|&
name|this_device
operator|->
name|parent
argument_list|,
name|sci_base_object_get_logger
argument_list|(
name|the_port
argument_list|)
argument_list|,
name|scic_sds_remote_device_state_table
argument_list|)
expr_stmt|;
name|scic_sds_remote_node_context_construct
argument_list|(
name|this_device
argument_list|,
name|this_device
operator|->
name|rnc
argument_list|,
name|SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX
argument_list|)
expr_stmt|;
name|sci_object_set_association
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|this_device
argument_list|)
expr_stmt|;
name|scic_sds_remote_device_initialize_state_logging
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_remote_device_da_construct
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|U16
name|remote_node_index
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
decl_stmt|;
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_PROTOCOLS_T
name|protocols
decl_stmt|;
name|SCIC_PORT_PROPERTIES_T
name|properties
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
operator|->
name|owning_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_da_construct(0x%x) enter\n"
operator|,
name|remote_device
operator|)
argument_list|)
expr_stmt|;
comment|// This information is request to determine how many remote node context
comment|// entries will be needed to store the remote node.
name|scic_sds_port_get_attached_protocols
argument_list|(
name|this_device
operator|->
name|owning_port
argument_list|,
operator|&
name|protocols
argument_list|)
expr_stmt|;
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|all
operator|=
name|protocols
operator|.
name|u
operator|.
name|all
expr_stmt|;
name|this_device
operator|->
name|is_direct_attached
operator|=
name|TRUE
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_ATAPI
argument_list|)
name|this_device
operator|->
name|is_atapi
operator|=
name|scic_sds_remote_device_is_atapi
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|scic_port_get_properties
argument_list|(
name|this_device
operator|->
name|owning_port
argument_list|,
operator|&
name|properties
argument_list|)
expr_stmt|;
comment|//Get accurate port width from port's phy mask for a DA device.
name|SCI_GET_BITS_SET_COUNT
argument_list|(
name|properties
operator|.
name|phy_mask
argument_list|,
name|this_device
operator|->
name|device_port_width
argument_list|)
expr_stmt|;
name|status
operator|=
name|scic_sds_controller_allocate_remote_node_context
argument_list|(
name|this_device
operator|->
name|owning_port
operator|->
name|owning_controller
argument_list|,
name|this_device
argument_list|,
operator|&
name|remote_node_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_remote_node_context_set_remote_node_index
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|remote_node_index
argument_list|)
expr_stmt|;
name|scic_sds_port_get_attached_sas_address
argument_list|(
name|this_device
operator|->
name|owning_port
argument_list|,
operator|&
name|this_device
operator|->
name|device_address
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|attached_ssp_target
condition|)
block|{
name|this_device
operator|->
name|has_ready_substate_machine
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|attached_stp_target
condition|)
block|{
name|this_device
operator|->
name|has_ready_substate_machine
operator|=
name|TRUE
expr_stmt|;
name|sci_base_state_machine_construct
argument_list|(
operator|&
name|this_device
operator|->
name|ready_substate_machine
argument_list|,
operator|&
name|this_device
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_sds_stp_remote_device_ready_substate_table
argument_list|,
name|SCIC_SDS_STP_REMOTE_DEVICE_READY_SUBSTATE_IDLE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|attached_smp_target
condition|)
block|{
name|this_device
operator|->
name|has_ready_substate_machine
operator|=
name|TRUE
expr_stmt|;
comment|//add the SMP ready substate machine construction here
name|sci_base_state_machine_construct
argument_list|(
operator|&
name|this_device
operator|->
name|ready_substate_machine
argument_list|,
operator|&
name|this_device
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_sds_smp_remote_device_ready_substate_table
argument_list|,
name|SCIC_SDS_SMP_REMOTE_DEVICE_READY_SUBSTATE_IDLE
argument_list|)
expr_stmt|;
block|}
name|this_device
operator|->
name|connection_rate
operator|=
name|scic_sds_port_get_max_allowed_speed
argument_list|(
name|this_device
operator|->
name|owning_port
argument_list|)
expr_stmt|;
comment|/// @todo Should I assign the port width by reading all of the phys on the port?
name|this_device
operator|->
name|device_port_width
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|void
name|scic_sds_remote_device_get_info_from_smp_discover_response
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|SMP_RESPONSE_DISCOVER_T
modifier|*
name|discover_response
parameter_list|)
block|{
comment|// decode discover_response to set sas_address to this_device.
name|this_device
operator|->
name|device_address
operator|.
name|high
operator|=
name|discover_response
operator|->
name|attached_sas_address
operator|.
name|high
expr_stmt|;
name|this_device
operator|->
name|device_address
operator|.
name|low
operator|=
name|discover_response
operator|->
name|attached_sas_address
operator|.
name|low
expr_stmt|;
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|all
operator|=
name|discover_response
operator|->
name|protocols
operator|.
name|u
operator|.
name|all
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_remote_device_ea_construct
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|,
name|SMP_RESPONSE_DISCOVER_T
modifier|*
name|discover_response
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|the_controller
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
operator|->
name|owning_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_ea_sas_construct0x%x, 0x%x) enter\n"
operator|,
name|remote_device
operator|,
name|discover_response
operator|)
argument_list|)
expr_stmt|;
name|the_controller
operator|=
name|scic_sds_port_get_controller
argument_list|(
name|this_device
operator|->
name|owning_port
argument_list|)
expr_stmt|;
name|scic_sds_remote_device_get_info_from_smp_discover_response
argument_list|(
name|this_device
argument_list|,
name|discover_response
argument_list|)
expr_stmt|;
name|status
operator|=
name|scic_sds_controller_allocate_remote_node_context
argument_list|(
name|the_controller
argument_list|,
name|this_device
argument_list|,
operator|&
name|this_device
operator|->
name|rnc
operator|->
name|remote_node_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
if|if
condition|(
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|attached_ssp_target
condition|)
block|{
name|this_device
operator|->
name|has_ready_substate_machine
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|attached_smp_target
condition|)
block|{
name|this_device
operator|->
name|has_ready_substate_machine
operator|=
name|TRUE
expr_stmt|;
comment|//add the SMP ready substate machine construction here
name|sci_base_state_machine_construct
argument_list|(
operator|&
name|this_device
operator|->
name|ready_substate_machine
argument_list|,
operator|&
name|this_device
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_sds_smp_remote_device_ready_substate_table
argument_list|,
name|SCIC_SDS_SMP_REMOTE_DEVICE_READY_SUBSTATE_IDLE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|attached_stp_target
condition|)
block|{
name|this_device
operator|->
name|has_ready_substate_machine
operator|=
name|TRUE
expr_stmt|;
name|sci_base_state_machine_construct
argument_list|(
operator|&
name|this_device
operator|->
name|ready_substate_machine
argument_list|,
operator|&
name|this_device
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_sds_stp_remote_device_ready_substate_table
argument_list|,
name|SCIC_SDS_STP_REMOTE_DEVICE_READY_SUBSTATE_IDLE
argument_list|)
expr_stmt|;
block|}
comment|// For SAS-2 the physical link rate is actually a logical link
comment|// rate that incorporates multiplexing.  The SCU doesn't
comment|// incorporate multiplexing and for the purposes of the
comment|// connection the logical link rate is that same as the
comment|// physical.  Furthermore, the SAS-2 and SAS-1.1 fields overlay
comment|// one another, so this code works for both situations.
name|this_device
operator|->
name|connection_rate
operator|=
name|MIN
argument_list|(
name|scic_sds_port_get_max_allowed_speed
argument_list|(
name|this_device
operator|->
name|owning_port
argument_list|)
argument_list|,
name|discover_response
operator|->
name|u2
operator|.
name|sas1_1
operator|.
name|negotiated_physical_link_rate
argument_list|)
expr_stmt|;
comment|/// @todo Should I assign the port width by reading all of the phys on the port?
name|this_device
operator|->
name|device_port_width
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_remote_device_destruct
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_destruct(0x%x) enter\n"
operator|,
name|remote_device
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|destruct_handler
argument_list|(
operator|&
name|this_device
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_WIDE_PORTED_TARGETS
argument_list|)
end_if

begin_function
name|SCI_STATUS
name|scic_remote_device_set_port_width
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|,
name|U8
name|new_port_width
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_set_port_width(0x%x, 0x%x) enter\n"
operator|,
name|remote_device
operator|,
name|new_port_width
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_port_width
operator|!=
literal|0
condition|)
block|{
name|this_device
operator|->
name|device_port_width
operator|=
name|new_port_width
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
else|else
return|return
name|SCI_FAILURE
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|U8
name|scic_remote_device_get_port_width
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_get_port_width(0x%x) enter\n"
operator|,
name|remote_device
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|U8
operator|)
name|this_device
operator|->
name|device_port_width
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// !defined(DISABLE_WIDE_PORTED_TARGETS)
end_comment

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_remote_device_start
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|,
name|U32
name|timeout
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_start(0x%x, 0x%x) enter\n"
operator|,
name|remote_device
operator|,
name|timeout
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|start_handler
argument_list|(
operator|&
name|this_device
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_remote_device_stop
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|,
name|U32
name|timeout
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_stop(0x%x, 0x%x) enter\n"
operator|,
name|remote_device
operator|,
name|timeout
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|stop_handler
argument_list|(
operator|&
name|this_device
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method invokes the remote device reset handler.  *  * @param[in] this_device The remote device for which the reset is being  *       requested.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_remote_device_reset
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_reset(0x%x) enter\n"
operator|,
name|remote_device
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|reset_handler
argument_list|(
operator|&
name|this_device
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method invokes the remote device reset handler.  *  * @param[in] this_device The remote device for which the reset is being  *       requested.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_remote_device_reset_complete
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_reset_complete(0x%x) enter\n"
operator|,
name|remote_device
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|reset_complete_handler
argument_list|(
operator|&
name|this_device
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method invokes the remote device reset handler.  *  * @param[in] this_device The remote device for which the reset is being  *       requested.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|U32
name|scic_remote_device_get_suggested_reset_timeout
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_get_suggested_reset_timeout(0x%x) enter\n"
operator|,
name|remote_device
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|attached_stp_target
condition|)
block|{
return|return
name|SCIC_SDS_SIGNATURE_FIS_TIMEOUT
return|;
block|}
return|return
name|SCIC_SDS_REMOTE_DEVICE_RESET_TIMEOUT
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_remote_device_set_max_connection_rate
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|,
name|SCI_SAS_LINK_RATE
name|connection_rate
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_set_max_connection_rate(0x%x, 0x%x) enter\n"
operator|,
name|remote_device
operator|,
name|connection_rate
operator|)
argument_list|)
expr_stmt|;
name|this_device
operator|->
name|connection_rate
operator|=
name|connection_rate
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_SAS_LINK_RATE
name|scic_remote_device_get_connection_rate
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_get_connection_rate(0x%x) enter\n"
operator|,
name|remote_device
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_device
operator|->
name|connection_rate
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|void
name|scic_remote_device_get_protocols
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|,
name|SMP_DISCOVER_RESPONSE_PROTOCOLS_T
modifier|*
name|protocols
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_get_protocols(0x%x) enter\n"
operator|,
name|remote_device
operator|)
argument_list|)
expr_stmt|;
name|protocols
operator|->
name|u
operator|.
name|all
operator|=
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|all
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|void
name|scic_remote_device_get_sas_address
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|,
name|SCI_SAS_ADDRESS_T
modifier|*
name|sas_address
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|remote_device
expr_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator|,
literal|"scic_remote_device_get_sas_address(0x%x, 0x%x) enter\n"
operator|,
name|remote_device
operator|,
name|sas_address
operator|)
argument_list|)
expr_stmt|;
name|sas_address
operator|->
name|low
operator|=
name|this_device
operator|->
name|device_address
operator|.
name|low
expr_stmt|;
name|sas_address
operator|->
name|high
operator|=
name|this_device
operator|->
name|device_address
operator|.
name|high
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_ATAPI
argument_list|)
end_if

begin_function
name|BOOL
name|scic_remote_device_is_atapi
parameter_list|(
name|SCI_REMOTE_DEVICE_HANDLE_T
name|device_handle
parameter_list|)
block|{
return|return
operator|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device_handle
operator|)
operator|->
name|is_atapi
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  SCU DRIVER STANDARD (SDS) REMOTE DEVICE IMPLEMENTATIONS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * Remote device timer requirements  */
end_comment

begin_define
define|#
directive|define
name|SCIC_SDS_REMOTE_DEVICE_MINIMUM_TIMER_COUNT
value|(0)
end_define

begin_define
define|#
directive|define
name|SCIC_SDS_REMOTE_DEVICE_MAXIMUM_TIMER_COUNT
value|(SCI_MAX_REMOTE_DEVICES)
end_define

begin_comment
comment|/**  * @brief This method returns the minimum number of timers required for all  *        remote devices.  *  * @return U32  */
end_comment

begin_function
name|U32
name|scic_sds_remote_device_get_min_timer_count
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|SCIC_SDS_REMOTE_DEVICE_MINIMUM_TIMER_COUNT
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the maximum number of timers requried for all  *        remote devices.  *  * @return U32  */
end_comment

begin_function
name|U32
name|scic_sds_remote_device_get_max_timer_count
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|SCIC_SDS_REMOTE_DEVICE_MAXIMUM_TIMER_COUNT
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SCI_LOGGING
end_ifdef

begin_comment
comment|/**  * This method will enable and turn on state transition logging for the remote  * device object.  *  * @param[in] this_device The device for which state transition logging is to  *       be enabled.  *  * @return Nothing  */
end_comment

begin_function
name|void
name|scic_sds_remote_device_initialize_state_logging
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|)
block|{
name|sci_base_state_machine_logger_initialize
argument_list|(
operator|&
name|this_device
operator|->
name|parent
operator|.
name|state_machine_logger
argument_list|,
operator|&
name|this_device
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
operator|&
name|this_device
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_cb_logger_log_states
argument_list|,
literal|"SCIC_SDS_REMOTE_DEVICE_T"
argument_list|,
literal|"base state machine"
argument_list|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_device
operator|->
name|has_ready_substate_machine
condition|)
block|{
name|sci_base_state_machine_logger_initialize
argument_list|(
operator|&
name|this_device
operator|->
name|ready_substate_machine_logger
argument_list|,
operator|&
name|this_device
operator|->
name|ready_substate_machine
argument_list|,
operator|&
name|this_device
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_cb_logger_log_states
argument_list|,
literal|"SCIC_SDS_REMOTE_DEVICE_T"
argument_list|,
literal|"ready substate machine"
argument_list|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method will stop the state machine logging for this object and should  * be called before the object is destroyed.  *  * @param[in] this_device The device on which to stop logging state  *       transitions.  *  * @return Nothing  */
end_comment

begin_function
name|void
name|scic_sds_remote_device_deinitialize_state_logging
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|)
block|{
name|sci_base_state_machine_logger_deinitialize
argument_list|(
operator|&
name|this_device
operator|->
name|parent
operator|.
name|state_machine_logger
argument_list|,
operator|&
name|this_device
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_device
operator|->
name|has_ready_substate_machine
condition|)
block|{
name|sci_base_state_machine_logger_deinitialize
argument_list|(
operator|&
name|this_device
operator|->
name|ready_substate_machine_logger
argument_list|,
operator|&
name|this_device
operator|->
name|ready_substate_machine
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * This method invokes the remote device suspend state handler.  *  * @param[in] this_device The remote device for which the suspend is being  *       requested.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_suspend
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|suspend_type
parameter_list|)
block|{
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|suspend_handler
argument_list|(
name|this_device
argument_list|,
name|suspend_type
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method invokes the remote device resume state handler.  *  * @param[in] this_device The remote device for which the resume is being  *       requested.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_resume
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|)
block|{
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|resume_handler
argument_list|(
name|this_device
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method invokes the frame handler for the remote device state machine  *  * @param[in] this_device The remote device for which the event handling is  *       being requested.  * @param[in] frame_index This is the frame index that is being processed.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_frame_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|frame_handler
argument_list|(
name|this_device
argument_list|,
name|frame_index
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method invokes the remote device event handler.  *  * @param[in] this_device The remote device for which the event handling is  *       being requested.  * @param[in] event_code This is the event code that is to be processed.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_event_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|event_handler
argument_list|(
name|this_device
argument_list|,
name|event_code
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method invokes the remote device start io handler.  *  * @param[in] controller The controller that is starting the io request.  * @param[in] this_device The remote device for which the start io handling is  *       being requested.  * @param[in] io_request The io request that is being started.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_start_io
parameter_list|(
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|controller
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
parameter_list|)
block|{
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|start_io_handler
argument_list|(
operator|&
name|this_device
operator|->
name|parent
argument_list|,
operator|&
name|io_request
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method invokes the remote device complete io handler.  *  * @param[in] controller The controller that is completing the io request.  * @param[in] this_device The remote device for which the complete io handling  *       is being requested.  * @param[in] io_request The io request that is being completed.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_complete_io
parameter_list|(
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|controller
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
parameter_list|)
block|{
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|complete_io_handler
argument_list|(
operator|&
name|this_device
operator|->
name|parent
argument_list|,
operator|&
name|io_request
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method invokes the remote device start task handler.  *  * @param[in] controller The controller that is starting the task request.  * @param[in] this_device The remote device for which the start task handling  *       is being requested.  * @param[in] io_request The task request that is being started.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_start_task
parameter_list|(
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|controller
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
parameter_list|)
block|{
return|return
name|this_device
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|start_task_handler
argument_list|(
operator|&
name|this_device
operator|->
name|parent
argument_list|,
operator|&
name|io_request
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method takes the request and bulids an appropriate SCU context for the  * request and then requests the controller to post the request.  *  * @param[in] this_device  * @param[in] request  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_remote_device_post_request
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|request
parameter_list|)
block|{
name|U32
name|context
decl_stmt|;
name|context
operator|=
name|scic_sds_remote_device_build_command_context
argument_list|(
name|this_device
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|scic_sds_controller_post_request
argument_list|(
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|context
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_ATAPI
argument_list|)
end_if

begin_comment
comment|/**  * This method check the signature fis of a stp device to decide whether  * a device is atapi or not.  *  * @param[in] this_device The device to be checked.  *  * @return TRUE if a device is atapi device. False if a device is not atapi.  */
end_comment

begin_function
name|BOOL
name|scic_sds_remote_device_is_atapi
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|)
block|{
if|if
condition|(
operator|!
name|this_device
operator|->
name|target_protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|attached_stp_target
condition|)
return|return
name|FALSE
return|;
elseif|else
if|if
condition|(
name|this_device
operator|->
name|is_direct_attached
condition|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|phy
decl_stmt|;
name|SCIC_SATA_PHY_PROPERTIES_T
name|properties
decl_stmt|;
name|SATA_FIS_REG_D2H_T
modifier|*
name|signature_fis
decl_stmt|;
name|phy
operator|=
name|scic_sds_port_get_a_connected_phy
argument_list|(
name|this_device
operator|->
name|owning_port
argument_list|)
expr_stmt|;
name|scic_sata_phy_get_properties
argument_list|(
name|phy
argument_list|,
operator|&
name|properties
argument_list|)
expr_stmt|;
comment|//decode the signature fis.
name|signature_fis
operator|=
operator|&
operator|(
name|properties
operator|.
name|signature_fis
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|signature_fis
operator|->
name|sector_count
operator|==
literal|0x01
operator|)
operator|&&
operator|(
name|signature_fis
operator|->
name|lba_low
operator|==
literal|0x01
operator|)
operator|&&
operator|(
name|signature_fis
operator|->
name|lba_mid
operator|==
literal|0x14
operator|)
operator|&&
operator|(
name|signature_fis
operator|->
name|lba_high
operator|==
literal|0xEB
operator|)
operator|&&
operator|(
operator|(
name|signature_fis
operator|->
name|device
operator|&
literal|0x5F
operator|)
operator|==
literal|0x00
operator|)
condition|)
block|{
comment|// An ATA device supporting the PACKET command set.
return|return
name|TRUE
return|;
block|}
else|else
return|return
name|FALSE
return|;
block|}
else|else
block|{
comment|//Expander supported ATAPI device is not currently supported.
return|return
name|FALSE
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// !defined(DISABLE_ATAPI)
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* REMOTE DEVICE STATE MACHINE
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * This method is called once the remote node context is ready to be  * freed.  The remote device can now report that its stop operation is  * complete.  *  * @param[in] user_parameter This is cast to a remote device object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_cb_remote_device_rnc_destruct_complete
parameter_list|(
name|void
modifier|*
name|user_parameter
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|user_parameter
expr_stmt|;
name|ASSERT
argument_list|(
name|this_device
operator|->
name|started_request_count
operator|==
literal|0
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_STOPPED
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method is called once the remote node context has transisitioned to a  * ready state.  This is the indication that the remote device object can also  * transition to ready.  *  * @param[in] user_parameter This is cast to a remote device object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_resume_complete_handler
parameter_list|(
name|void
modifier|*
name|user_parameter
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
decl_stmt|;
name|this_device
operator|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|user_parameter
expr_stmt|;
if|if
condition|(
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_device
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
operator|!=
name|SCI_BASE_REMOTE_DEVICE_STATE_READY
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_device
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_READY
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method will perform the STP request start processing common  * to IO requests and task requests of all types.  *  * @param[in] device This parameter specifies the device for which the  *            request is being started.  * @param[in] request This parameter specifies the request being started.  * @param[in] status This parameter specifies the current start operation  *            status.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_remote_device_start_request
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|the_request
parameter_list|,
name|SCI_STATUS
name|status
parameter_list|)
block|{
comment|// We still have a fault in starting the io complete it on the port
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
name|scic_sds_remote_device_increment_request_count
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
else|else
block|{
name|this_device
operator|->
name|owning_port
operator|->
name|state_handlers
operator|->
name|complete_io_handler
argument_list|(
name|this_device
operator|->
name|owning_port
argument_list|,
name|this_device
argument_list|,
name|the_request
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method will continue to post tc for a STP request. This method usually  * serves as a callback when RNC gets resumed during a task management sequence.  *  * @param[in] request This parameter specifies the request being continued.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_remote_device_continue_request
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|)
block|{
comment|// we need to check if this request is still valid to continue.
if|if
condition|(
name|this_device
operator|->
name|working_request
operator|!=
name|NULL
condition|)
block|{
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
name|this_device
operator|->
name|working_request
decl_stmt|;
name|this_request
operator|->
name|owning_controller
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|continue_io_handler
argument_list|(
operator|&
name|this_request
operator|->
name|owning_controller
operator|->
name|parent
argument_list|,
operator|&
name|this_request
operator|->
name|target_device
operator|->
name|parent
argument_list|,
operator|&
name|this_request
operator|->
name|parent
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method will terminate all of the IO requests in the  *        controllers IO request table that were targeted for this  *        device.  *  * @param[in]  this_device This parameter specifies the remote device  *             for which to attempt to terminate all requests.  *  * @return This method returns an indication as to whether all requests  *         were successfully terminated.  If a single request fails to  *         be terminated, then this method will return the failure.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_terminate_requests
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|)
block|{
return|return
name|scic_sds_terminate_reqests
argument_list|(
name|this_device
operator|->
name|owning_port
operator|->
name|owning_controller
argument_list|,
name|this_device
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  DEFAULT STATE HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * This method is the default start handler.  It logs a warning and returns a  * failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_start_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to start while in wrong state %d\n"
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default stop handler.  It logs a warning and returns a  * failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_stop_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to stop while in wrong state %d\n"
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default fail handler.  It logs a warning and returns a  * failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_fail_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to fail while in wrong state %d\n"
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default destruct handler.  It logs a warning and returns  * a failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_destruct_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to destroy while in wrong state %d\n"
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default reset handler.  It logs a warning and returns a  * failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_reset_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to reset while in wrong state %d\n"
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default reset complete handler.  It logs a warning and  * returns a failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_reset_complete_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to complete reset while in wrong state %d\n"
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default suspend handler.  It logs a warning and returns  * a failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_suspend_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|suspend_type
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device 0x%x requested to suspend %d while in wrong state %d\n"
operator|,
name|this_device
operator|,
name|suspend_type
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
name|this_device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default resume handler.  It logs a warning and returns a  * failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_resume_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to resume while in wrong state %d\n"
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
name|this_device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|SCI_LOGGING
argument_list|)
end_if

begin_comment
comment|/**  *  This is a private method for emitting log messages related to events reported  *  to the remote device from the controller object.  *  *  @param [in] this_device This is the device object that is receiving the  *         event.  *  @param [in] event_code The event code to process.  *  *  @return None  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_emit_event_log_message
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|event_code
parameter_list|,
name|char
modifier|*
name|message_guts
parameter_list|,
name|BOOL
name|ready_state
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote device 0x%x (state %d) received %s %x while in the %sready %s%d\n"
operator|,
name|this_device
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
name|this_device
argument_list|)
argument_list|)
operator|,
name|message_guts
operator|,
name|event_code
operator|,
operator|(
name|ready_state
operator|)
condition|?
literal|""
else|:
literal|"not "
operator|,
operator|(
name|this_device
operator|->
name|has_ready_substate_machine
operator|)
condition|?
literal|"substate "
else|:
literal|""
operator|,
operator|(
name|this_device
operator|->
name|has_ready_substate_machine
operator|)
condition|?
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_device
operator|->
name|ready_substate_machine
argument_list|)
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|// defined(SCI_LOGGING)
end_comment

begin_define
define|#
directive|define
name|scic_sds_emit_event_log_message
parameter_list|(
name|device
parameter_list|,
name|event_code
parameter_list|,
name|message
parameter_list|,
name|state
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// defined(SCI_LOGGING)
end_comment

begin_comment
comment|/**  * This method is the default event handler.  It will call the RNC state  * machine handler for any RNC events otherwise it will log a warning and  * returns a failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  * @param[in] event_code The event code that the SCIC_SDS_CONTROLLER wants the  *       device object to process.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_core_event_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|event_code
parameter_list|,
name|BOOL
name|is_ready_state
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
switch|switch
condition|(
name|scu_get_event_type
argument_list|(
name|event_code
argument_list|)
condition|)
block|{
case|case
name|SCU_EVENT_TYPE_RNC_OPS_MISC
case|:
case|case
name|SCU_EVENT_TYPE_RNC_SUSPEND_TX
case|:
case|case
name|SCU_EVENT_TYPE_RNC_SUSPEND_TX_RX
case|:
name|status
operator|=
name|scic_sds_remote_node_context_event_handler
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|event_code
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCU_EVENT_TYPE_PTX_SCHEDULE_EVENT
case|:
if|if
condition|(
name|scu_get_event_code
argument_list|(
name|event_code
argument_list|)
operator|==
name|SCU_EVENT_IT_NEXUS_TIMEOUT
condition|)
block|{
name|status
operator|=
name|SCI_SUCCESS
expr_stmt|;
comment|// Suspend the associated RNC
name|scic_sds_remote_node_context_suspend
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|SCI_SOFTWARE_SUSPENSION
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|scic_sds_emit_event_log_message
argument_list|(
name|this_device
argument_list|,
name|event_code
argument_list|,
operator|(
name|is_ready_state
operator|)
condition|?
literal|"I_T_Nexus_Timeout event"
else|:
literal|"I_T_Nexus_Timeout event in wrong state"
argument_list|,
name|is_ready_state
argument_list|)
expr_stmt|;
break|break;
block|}
comment|// Else, fall through and treat as unhandled...
default|default:
name|scic_sds_emit_event_log_message
argument_list|(
name|this_device
argument_list|,
name|event_code
argument_list|,
operator|(
name|is_ready_state
operator|)
condition|?
literal|"unexpected event"
else|:
literal|"unexpected event in wrong state"
argument_list|,
name|is_ready_state
argument_list|)
expr_stmt|;
name|status
operator|=
name|SCI_FAILURE_INVALID_STATE
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default event handler.  It will call the RNC state  * machine handler for any RNC events otherwise it will log a warning and  * returns a failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  * @param[in] event_code The event code that the SCIC_SDS_CONTROLLER wants the  *       device object to process.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_event_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
return|return
name|scic_sds_remote_device_core_event_handler
argument_list|(
name|this_device
argument_list|,
name|event_code
argument_list|,
name|FALSE
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default unsolicited frame handler.  It logs a warning,  * releases the frame and returns a failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  * @param[in] frame_index The frame index for which the SCIC_SDS_CONTROLLER  *       wants this device object to process.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_frame_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to handle frame %x while in wrong state %d\n"
operator|,
name|frame_index
operator|,
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_device
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|// Return the frame back to the controller
name|scic_sds_controller_release_frame
argument_list|(
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default start io handler.  It logs a warning and returns  * a failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  * @param[in] request The SCI_BASE_REQUEST which is then cast into a  *       SCIC_SDS_IO_REQUEST to start.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_start_request_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCI_BASE_REQUEST_T
modifier|*
name|request
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to start io request %x while in wrong state %d\n"
operator|,
name|request
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default complete io handler.  It logs a warning and  * returns a failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  * @param[in] request The SCI_BASE_REQUEST which is then cast into a  *       SCIC_SDS_IO_REQUEST to complete.  *  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_complete_request_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCI_BASE_REQUEST_T
modifier|*
name|request
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to complete io_request %x while in wrong state %d\n"
operator|,
name|request
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the default continue io handler.  It logs a warning and  * returns a failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  * @param[in] request The SCI_BASE_REQUEST which is then cast into a  *       SCIC_SDS_IO_REQUEST to continue.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_default_continue_request_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCI_BASE_REQUEST_T
modifier|*
name|request
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_SSP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_SMP_REMOTE_TARGET
operator||
name|SCIC_LOG_OBJECT_STP_REMOTE_TARGET
operator|,
literal|"SCIC Remote Device requested to continue io request %x while in wrong state %d\n"
operator|,
name|request
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the general suspend handler.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_general_suspend_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|suspend_type
parameter_list|)
block|{
return|return
name|scic_sds_remote_node_context_suspend
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|suspend_type
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the general suspend handler.  It logs a warning and returns  * a failure.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_general_resume_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|)
block|{
return|return
name|scic_sds_remote_node_context_resume
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  NORMAL STATE HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * This method is a general ssp frame handler.  In most cases the device  * object needs to route the unsolicited frame processing to the io request  * object.  This method decodes the tag for the io request object and routes  * the unsolicited frame to that object.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is then cast into a  *       SCIC_SDS_REMOTE_DEVICE.  * @param[in] frame_index The frame index for which the SCIC_SDS_CONTROLLER  *       wants this device object to process.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_general_frame_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCI_STATUS
name|result
decl_stmt|;
name|SCI_SSP_FRAME_HEADER_T
modifier|*
name|frame_header
decl_stmt|;
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
decl_stmt|;
name|result
operator|=
name|scic_sds_unsolicited_frame_control_get_header
argument_list|(
operator|&
operator|(
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
operator|->
name|uf_control
operator|)
argument_list|,
name|frame_index
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|frame_header
argument_list|)
expr_stmt|;
if|if
condition|(
name|SCI_SUCCESS
operator|==
name|result
condition|)
block|{
name|io_request
operator|=
name|scic_sds_controller_get_io_request_from_tag
argument_list|(
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|frame_header
operator|->
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|io_request
operator|==
name|SCI_INVALID_HANDLE
operator|)
operator|||
operator|(
name|io_request
operator|->
name|target_device
operator|!=
name|this_device
operator|)
condition|)
block|{
comment|// We could not map this tag to a valid IO request
comment|// Just toss the frame and continue
name|scic_sds_controller_release_frame
argument_list|(
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// The IO request is now in charge of releasing the frame
name|result
operator|=
name|io_request
operator|->
name|state_handlers
operator|->
name|frame_handler
argument_list|(
name|io_request
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  *  This is a common method for handling events reported to the remote device  *  from the controller object.  *  *  @param [in] this_device This is the device object that is receiving the  *         event.  *  @param [in] event_code The event code to process.  *  *  @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_general_event_handler
parameter_list|(
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
return|return
name|scic_sds_remote_device_core_event_handler
argument_list|(
name|this_device
argument_list|,
name|event_code
argument_list|,
name|TRUE
argument_list|)
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  STOPPED STATE HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * This method takes the SCIC_SDS_REMOTE_DEVICE from a stopped state and  * attempts to start it.   The RNC buffer for the device is constructed and  * the device state machine is transitioned to the  * SCIC_BASE_REMOTE_DEVICE_STATE_STARTING.  *  * @param[in] device  *  * @return SCI_STATUS  * @retval SCI_SUCCESS if there is an RNC buffer available to construct the  *         remote device.  * @retval SCI_FAILURE_INSUFFICIENT_RESOURCES if there is no RNC buffer  *         available in which to construct the remote device.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_stopped_state_start_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCI_STATUS
name|status
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
name|status
operator|=
name|scic_sds_remote_node_context_resume
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|scic_sds_remote_device_resume_complete_handler
argument_list|,
name|this_device
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_STARTING
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * This method will stop a SCIC_SDS_REMOTE_DEVICE that is already in a stopped  * state.  This is not considered an error since the device is already  * stopped.  *  * @param[in] this_device The SCI_BASE_REMOTE_DEVICE which is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_stopped_state_stop_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|this_device
parameter_list|)
block|{
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method will destruct a SCIC_SDS_REMOTE_DEVICE that is in a stopped  * state.  This is the only state from which a destruct request will succeed.  * The RNi for this SCIC_SDS_REMOTE_DEVICE is returned to the free pool and  * the device object transitions to the SCI_BASE_REMOTE_DEVICE_STATE_FINAL.  *  * @param[in] this_device The SCI_BASE_REMOTE_DEVICE which is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_stopped_state_destruct_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|the_controller
init|=
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
decl_stmt|;
name|the_controller
operator|->
name|remote_device_sequence
index|[
name|this_device
operator|->
name|rnc
operator|->
name|remote_node_index
index|]
operator|++
expr_stmt|;
name|scic_sds_controller_free_remote_node_context
argument_list|(
name|the_controller
argument_list|,
name|this_device
argument_list|,
name|this_device
operator|->
name|rnc
operator|->
name|remote_node_index
argument_list|)
expr_stmt|;
name|scic_sds_remote_node_context_set_remote_node_index
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_FINAL
argument_list|)
expr_stmt|;
name|scic_sds_remote_device_deinitialize_state_logging
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  STARTING STATE HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_starting_state_stop_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
comment|/*     * This device has not yet started so there had better be no IO requests     */
name|ASSERT
argument_list|(
name|this_device
operator|->
name|started_request_count
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/*     * Destroy the remote node context     */
name|scic_sds_remote_node_context_destruct
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|scic_sds_cb_remote_device_rnc_destruct_complete
argument_list|,
name|this_device
argument_list|)
expr_stmt|;
comment|/*     * Transition to the stopping state and wait for the remote node to     * complete being posted and invalidated.     */
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_STOPPING
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  INITIALIZING STATE HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/* There is nothing to do here for SSP devices */
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  READY STATE HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * This method is the default stop handler for the SCIC_SDS_REMOTE_DEVICE  * ready substate machine. It will stop the current substate machine and  * transition the base state machine to SCI_BASE_REMOTE_DEVICE_STATE_STOPPING.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE object which is cast to a  *       SCIC_SDS_REMOTE_DEVICE object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_ready_state_stop_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
comment|// Request the parent state machine to transition to the stopping state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_STOPPING
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_device
operator|->
name|started_request_count
operator|==
literal|0
condition|)
block|{
name|scic_sds_remote_node_context_destruct
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|scic_sds_cb_remote_device_rnc_destruct_complete
argument_list|,
name|this_device
argument_list|)
expr_stmt|;
block|}
else|else
name|status
operator|=
name|scic_sds_remote_device_terminate_requests
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * This is the ready state device reset handler  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE object which is cast to a  *       SCIC_SDS_REMOTE_DEVICE object.  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_remote_device_ready_state_reset_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
comment|// Request the parent state machine to transition to the stopping state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_RESETTING
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method will attempt to start a task request for this device object.  * The remote device object will issue the start request for the task and if  * successful it will start the request for the port object then increment its  * own requet count.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is cast to a  *       SCIC_SDS_REMOTE_DEVICE for which the request is to be started.  * @param[in] request The SCI_BASE_REQUEST which is cast to a  *       SCIC_SDS_IO_REQUEST that is to be started.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS if the task request is started for this device object.  * @retval SCI_FAILURE_INSUFFICIENT_RESOURCES if the io request object could  *         not get the resources to start.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_ready_state_start_task_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCI_BASE_REQUEST_T
modifier|*
name|request
parameter_list|)
block|{
name|SCI_STATUS
name|result
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
name|SCIC_SDS_REQUEST_T
modifier|*
name|task_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|request
decl_stmt|;
comment|// See if the port is in a state where we can start the IO request
name|result
operator|=
name|scic_sds_port_start_io
argument_list|(
name|scic_sds_remote_device_get_port
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|this_device
argument_list|,
name|task_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|result
operator|=
name|scic_sds_remote_node_context_start_task
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|task_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|result
operator|=
name|scic_sds_request_start
argument_list|(
name|task_request
argument_list|)
expr_stmt|;
block|}
name|scic_sds_remote_device_start_request
argument_list|(
name|this_device
argument_list|,
name|task_request
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * This method will attempt to start an io request for this device object. The  * remote device object will issue the start request for the io and if  * successful it will start the request for the port object then increment its  * own requet count.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is cast to a  *       SCIC_SDS_REMOTE_DEVICE for which the request is to be started.  * @param[in] request The SCI_BASE_REQUEST which is cast to a  *       SCIC_SDS_IO_REQUEST that is to be started.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS if the io request is started for this device object.  * @retval SCI_FAILURE_INSUFFICIENT_RESOURCES if the io request object could  *         not get the resources to start.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_ready_state_start_io_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCI_BASE_REQUEST_T
modifier|*
name|request
parameter_list|)
block|{
name|SCI_STATUS
name|result
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|request
decl_stmt|;
comment|// See if the port is in a state where we can start the IO request
name|result
operator|=
name|scic_sds_port_start_io
argument_list|(
name|scic_sds_remote_device_get_port
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|this_device
argument_list|,
name|io_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|result
operator|=
name|scic_sds_remote_node_context_start_io
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|io_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|result
operator|=
name|scic_sds_request_start
argument_list|(
name|io_request
argument_list|)
expr_stmt|;
block|}
name|scic_sds_remote_device_start_request
argument_list|(
name|this_device
argument_list|,
name|io_request
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * This method will complete the request for the remote device object.  The  * method will call the completion handler for the request object and if  * successful it will complete the request on the port object then decrement  * its own started_request_count.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is cast to a  *       SCIC_SDS_REMOTE_DEVICE for which the request is to be completed.  * @param[in] request The SCI_BASE_REQUEST which is cast to a  *       SCIC_SDS_IO_REQUEST that is to be completed.  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_ready_state_complete_request_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCI_BASE_REQUEST_T
modifier|*
name|request
parameter_list|)
block|{
name|SCI_STATUS
name|result
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
name|SCIC_SDS_REQUEST_T
modifier|*
name|the_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|request
decl_stmt|;
name|result
operator|=
name|scic_sds_request_complete
argument_list|(
name|the_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|SCI_SUCCESS
condition|)
block|{
comment|// See if the port is in a state where we can start the IO request
name|result
operator|=
name|scic_sds_port_complete_io
argument_list|(
name|scic_sds_remote_device_get_port
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|this_device
argument_list|,
name|the_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_remote_device_decrement_request_count
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  STOPPING STATE HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * This method will stop a SCIC_SDS_REMOTE_DEVICE that is already in the  * SCI_BASE_REMOTE_DEVICE_STATE_STOPPING state. This is not considered an  * error since we allow a stop request on a device that is alreay stopping or  * stopped.  *  * @param[in] this_device The SCI_BASE_REMOTE_DEVICE which is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_stopping_state_stop_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
comment|// All requests should have been terminated, but if there is an
comment|// attempt to stop a device already in the stopping state, then
comment|// try again to terminate.
return|return
name|scic_sds_remote_device_terminate_requests
argument_list|(
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method completes requests for this SCIC_SDS_REMOTE_DEVICE while it is  * in the SCI_BASE_REMOTE_DEVICE_STATE_STOPPING state. This method calls the  * complete method for the request object and if that is successful the port  * object is called to complete the task request. Then the device object  * itself completes the task request. If SCIC_SDS_REMOTE_DEVICE  * started_request_count goes to 0 and the invalidate RNC request has  * completed the device object can transition to the  * SCI_BASE_REMOTE_DEVICE_STATE_STOPPED.  *  * @param[in] device The device object for which the request is completing.  * @param[in] request The task request that is being completed.  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_stopping_state_complete_request_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCI_BASE_REQUEST_T
modifier|*
name|request
parameter_list|)
block|{
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|request
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
name|status
operator|=
name|scic_sds_request_complete
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|status
operator|=
name|scic_sds_port_complete_io
argument_list|(
name|scic_sds_remote_device_get_port
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|this_device
argument_list|,
name|this_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_remote_device_decrement_request_count
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
if|if
condition|(
name|scic_sds_remote_device_get_request_count
argument_list|(
name|this_device
argument_list|)
operator|==
literal|0
condition|)
block|{
name|scic_sds_remote_node_context_destruct
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|scic_sds_cb_remote_device_rnc_destruct_complete
argument_list|,
name|this_device
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  RESETTING STATE HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|/**  * This method will complete the reset operation when the device is in the  * resetting state.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is to be cast into a  *       SCIC_SDS_REMOTE_DEVICE object.  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_resetting_state_reset_complete_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_device
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_READY
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method will stop the remote device while in the resetting state.  *  * @param[in] device The SCI_BASE_REMOTE_DEVICE which is to be cast into a  *       SCIC_SDS_REMOTE_DEVICE object.  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_resetting_state_stop_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_device
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_STOPPING
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method completes requests for this SCIC_SDS_REMOTE_DEVICE while it is  * in the SCI_BASE_REMOTE_DEVICE_STATE_RESETTING state. This method calls the  * complete method for the request object and if that is successful the port  * object is called to complete the task request. Then the device object  * itself completes the task request.  *  * @param[in] device The device object for which the request is completing.  * @param[in] request The task request that is being completed.  *  * @return SCI_STATUS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_remote_device_resetting_state_complete_request_handler
parameter_list|(
name|SCI_BASE_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCI_BASE_REQUEST_T
modifier|*
name|request
parameter_list|)
block|{
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|SCIC_SDS_REQUEST_T
modifier|*
name|this_request
init|=
operator|(
name|SCIC_SDS_REQUEST_T
operator|*
operator|)
name|request
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|device
decl_stmt|;
name|status
operator|=
name|scic_sds_request_complete
argument_list|(
name|this_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|status
operator|=
name|scic_sds_port_complete_io
argument_list|(
name|scic_sds_remote_device_get_port
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|this_device
argument_list|,
name|this_request
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_remote_device_decrement_request_count
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|//*****************************************************************************
end_comment

begin_comment
comment|//*  FAILED STATE HANDLERS
end_comment

begin_comment
comment|//*****************************************************************************
end_comment

begin_decl_stmt
name|SCIC_SDS_REMOTE_DEVICE_STATE_HANDLER_T
name|scic_sds_remote_device_state_handler_table
index|[
name|SCI_BASE_REMOTE_DEVICE_MAX_STATES
index|]
init|=
block|{
comment|// SCI_BASE_REMOTE_DEVICE_STATE_INITIAL
block|{
block|{
name|scic_sds_remote_device_default_start_handler
block|,
name|scic_sds_remote_device_default_stop_handler
block|,
name|scic_sds_remote_device_default_fail_handler
block|,
name|scic_sds_remote_device_default_destruct_handler
block|,
name|scic_sds_remote_device_default_reset_handler
block|,
name|scic_sds_remote_device_default_reset_complete_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|,
name|scic_sds_remote_device_default_continue_request_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|}
block|,
name|scic_sds_remote_device_default_suspend_handler
block|,
name|scic_sds_remote_device_default_resume_handler
block|,
name|scic_sds_remote_device_default_event_handler
block|,
name|scic_sds_remote_device_default_frame_handler
block|}
block|,
comment|// SCI_BASE_REMOTE_DEVICE_STATE_STOPPED
block|{
block|{
name|scic_sds_remote_device_stopped_state_start_handler
block|,
name|scic_sds_remote_device_stopped_state_stop_handler
block|,
name|scic_sds_remote_device_default_fail_handler
block|,
name|scic_sds_remote_device_stopped_state_destruct_handler
block|,
name|scic_sds_remote_device_default_reset_handler
block|,
name|scic_sds_remote_device_default_reset_complete_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|,
name|scic_sds_remote_device_default_continue_request_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|}
block|,
name|scic_sds_remote_device_default_suspend_handler
block|,
name|scic_sds_remote_device_default_resume_handler
block|,
name|scic_sds_remote_device_default_event_handler
block|,
name|scic_sds_remote_device_default_frame_handler
block|}
block|,
comment|// SCI_BASE_REMOTE_DEVICE_STATE_STARTING
block|{
block|{
name|scic_sds_remote_device_default_start_handler
block|,
name|scic_sds_remote_device_starting_state_stop_handler
block|,
name|scic_sds_remote_device_default_fail_handler
block|,
name|scic_sds_remote_device_default_destruct_handler
block|,
name|scic_sds_remote_device_default_reset_handler
block|,
name|scic_sds_remote_device_default_reset_complete_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|,
name|scic_sds_remote_device_default_continue_request_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|}
block|,
name|scic_sds_remote_device_default_suspend_handler
block|,
name|scic_sds_remote_device_default_resume_handler
block|,
name|scic_sds_remote_device_general_event_handler
block|,
name|scic_sds_remote_device_default_frame_handler
block|}
block|,
comment|// SCI_BASE_REMOTE_DEVICE_STATE_READY
block|{
block|{
name|scic_sds_remote_device_default_start_handler
block|,
name|scic_sds_remote_device_ready_state_stop_handler
block|,
name|scic_sds_remote_device_default_fail_handler
block|,
name|scic_sds_remote_device_default_destruct_handler
block|,
name|scic_sds_remote_device_ready_state_reset_handler
block|,
name|scic_sds_remote_device_default_reset_complete_handler
block|,
name|scic_sds_remote_device_ready_state_start_io_handler
block|,
name|scic_sds_remote_device_ready_state_complete_request_handler
block|,
name|scic_sds_remote_device_default_continue_request_handler
block|,
name|scic_sds_remote_device_ready_state_start_task_handler
block|,
name|scic_sds_remote_device_ready_state_complete_request_handler
block|}
block|,
name|scic_sds_remote_device_general_suspend_handler
block|,
name|scic_sds_remote_device_general_resume_handler
block|,
name|scic_sds_remote_device_general_event_handler
block|,
name|scic_sds_remote_device_general_frame_handler
block|,    }
block|,
comment|// SCI_BASE_REMOTE_DEVICE_STATE_STOPPING
block|{
block|{
name|scic_sds_remote_device_default_start_handler
block|,
name|scic_sds_remote_device_stopping_state_stop_handler
block|,
name|scic_sds_remote_device_default_fail_handler
block|,
name|scic_sds_remote_device_default_destruct_handler
block|,
name|scic_sds_remote_device_default_reset_handler
block|,
name|scic_sds_remote_device_default_reset_complete_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_stopping_state_complete_request_handler
block|,
name|scic_sds_remote_device_default_continue_request_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_stopping_state_complete_request_handler
block|}
block|,
name|scic_sds_remote_device_default_suspend_handler
block|,
name|scic_sds_remote_device_default_resume_handler
block|,
name|scic_sds_remote_device_general_event_handler
block|,
name|scic_sds_remote_device_general_frame_handler
block|}
block|,
comment|// SCI_BASE_REMOTE_DEVICE_STATE_FAILED
block|{
block|{
name|scic_sds_remote_device_default_start_handler
block|,
name|scic_sds_remote_device_default_stop_handler
block|,
name|scic_sds_remote_device_default_fail_handler
block|,
name|scic_sds_remote_device_default_destruct_handler
block|,
name|scic_sds_remote_device_default_reset_handler
block|,
name|scic_sds_remote_device_default_reset_complete_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|,
name|scic_sds_remote_device_default_continue_request_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|}
block|,
name|scic_sds_remote_device_default_suspend_handler
block|,
name|scic_sds_remote_device_default_resume_handler
block|,
name|scic_sds_remote_device_default_event_handler
block|,
name|scic_sds_remote_device_general_frame_handler
block|}
block|,
comment|// SCI_BASE_REMOTE_DEVICE_STATE_RESETTING
block|{
block|{
name|scic_sds_remote_device_default_start_handler
block|,
name|scic_sds_remote_device_resetting_state_stop_handler
block|,
name|scic_sds_remote_device_default_fail_handler
block|,
name|scic_sds_remote_device_default_destruct_handler
block|,
name|scic_sds_remote_device_default_reset_handler
block|,
name|scic_sds_remote_device_resetting_state_reset_complete_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_resetting_state_complete_request_handler
block|,
name|scic_sds_remote_device_default_continue_request_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_resetting_state_complete_request_handler
block|}
block|,
name|scic_sds_remote_device_default_suspend_handler
block|,
name|scic_sds_remote_device_default_resume_handler
block|,
name|scic_sds_remote_device_default_event_handler
block|,
name|scic_sds_remote_device_general_frame_handler
block|}
block|,
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_WIDE_PORTED_TARGETS
argument_list|)
comment|// SCI_BASE_REMOTE_DEVICE_STATE_UPDATING_PORT_WIDTH - unused by SCIC
block|{
block|{
name|scic_sds_remote_device_default_start_handler
block|,
name|scic_sds_remote_device_default_stop_handler
block|,
name|scic_sds_remote_device_default_fail_handler
block|,
name|scic_sds_remote_device_default_destruct_handler
block|,
name|scic_sds_remote_device_default_reset_handler
block|,
name|scic_sds_remote_device_default_reset_complete_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|,
name|scic_sds_remote_device_default_continue_request_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|}
block|,
name|scic_sds_remote_device_default_suspend_handler
block|,
name|scic_sds_remote_device_default_resume_handler
block|,
name|scic_sds_remote_device_default_event_handler
block|,
name|scic_sds_remote_device_default_frame_handler
block|}
block|,
endif|#
directive|endif
comment|// SCI_BASE_REMOTE_DEVICE_STATE_FINAL
block|{
block|{
name|scic_sds_remote_device_default_start_handler
block|,
name|scic_sds_remote_device_default_stop_handler
block|,
name|scic_sds_remote_device_default_fail_handler
block|,
name|scic_sds_remote_device_default_destruct_handler
block|,
name|scic_sds_remote_device_default_reset_handler
block|,
name|scic_sds_remote_device_default_reset_complete_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|,
name|scic_sds_remote_device_default_continue_request_handler
block|,
name|scic_sds_remote_device_default_start_request_handler
block|,
name|scic_sds_remote_device_default_complete_request_handler
block|}
block|,
name|scic_sds_remote_device_default_suspend_handler
block|,
name|scic_sds_remote_device_default_resume_handler
block|,
name|scic_sds_remote_device_default_event_handler
block|,
name|scic_sds_remote_device_default_frame_handler
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * This is the enter method for the SCI_BASE_REMOTE_DEVICE_STATE_INITIAL it  * immediatly transitions the remote device object to the stopped state.  *  * @param[in] object This is the SCI_BASE_OBJECT that is cast into a  *            SCIC_SDS_REMOTE_DEVICE.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_initial_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_device
argument_list|,
name|scic_sds_remote_device_state_handler_table
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_INITIAL
argument_list|)
expr_stmt|;
comment|// Initial state is a transitional state to the stopped state
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_remote_device_get_base_state_machine
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_STOPPED
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This is the enter method for the SCI_BASE_REMOTE_DEVICE_STATE_INITIAL it  * sets the stopped state handlers and if this state is entered from the  * SCI_BASE_REMOTE_DEVICE_STATE_STOPPING then the SCI User is informed that  * the device stop is complete.  *  * @param[in] object This is the SCI_BASE_OBJECT that is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_stopped_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_device
argument_list|,
name|scic_sds_remote_device_state_handler_table
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_STOPPED
argument_list|)
expr_stmt|;
comment|// If we are entering from the stopping state let the SCI User know that
comment|// the stop operation has completed.
if|if
condition|(
name|this_device
operator|->
name|parent
operator|.
name|state_machine
operator|.
name|previous_state_id
operator|==
name|SCI_BASE_REMOTE_DEVICE_STATE_STOPPING
condition|)
block|{
name|scic_cb_remote_device_stop_complete
argument_list|(
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|this_device
argument_list|,
name|SCI_SUCCESS
argument_list|)
expr_stmt|;
block|}
name|scic_sds_controller_remote_device_stopped
argument_list|(
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
argument_list|,
name|this_device
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This is the enter method for the SCI_BASE_REMOTE_DEVICE_STATE_STARTING it  * sets the starting state handlers, sets the device not ready, and posts the  * remote node context to the hardware.  *  * @param[in] object This is the SCI_BASE_OBJECT that is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_starting_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|the_controller
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|object
decl_stmt|;
name|the_controller
operator|=
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_device
argument_list|,
name|scic_sds_remote_device_state_handler_table
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_STARTING
argument_list|)
expr_stmt|;
name|scic_cb_remote_device_not_ready
argument_list|(
name|the_controller
argument_list|,
name|this_device
argument_list|,
name|SCIC_REMOTE_DEVICE_NOT_READY_START_REQUESTED
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This is the enter method for the SCI_BASE_REMOTE_DEVICE_STATE_READY it sets  * the ready state handlers, and starts the ready substate machine.  *  * @param[in] object This is the SCI_BASE_OBJECT that is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_ready_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|the_controller
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|object
decl_stmt|;
name|the_controller
operator|=
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_device
argument_list|,
name|scic_sds_remote_device_state_handler_table
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_READY
argument_list|)
expr_stmt|;
comment|/// @todo Check the device object for the proper return code for this
comment|///       callback
name|scic_cb_remote_device_start_complete
argument_list|(
name|the_controller
argument_list|,
name|this_device
argument_list|,
name|SCI_SUCCESS
argument_list|)
expr_stmt|;
name|scic_sds_controller_remote_device_started
argument_list|(
name|the_controller
argument_list|,
name|this_device
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_device
operator|->
name|has_ready_substate_machine
condition|)
block|{
name|sci_base_state_machine_start
argument_list|(
operator|&
name|this_device
operator|->
name|ready_substate_machine
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|scic_cb_remote_device_ready
argument_list|(
name|the_controller
argument_list|,
name|this_device
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This is the exit method for the SCI_BASE_REMOTE_DEVICE_STATE_READY it does  * nothing.  *  * @param[in] object This is the SCI_BASE_OBJECT that is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_ready_state_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|the_controller
decl_stmt|;
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|object
decl_stmt|;
name|the_controller
operator|=
name|scic_sds_remote_device_get_controller
argument_list|(
name|this_device
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_device
operator|->
name|has_ready_substate_machine
condition|)
block|{
name|sci_base_state_machine_stop
argument_list|(
operator|&
name|this_device
operator|->
name|ready_substate_machine
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|scic_cb_remote_device_not_ready
argument_list|(
name|the_controller
argument_list|,
name|this_device
argument_list|,
name|SCIC_REMOTE_DEVICE_NOT_READY_STOP_REQUESTED
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This is the enter method for the SCI_BASE_REMOTE_DEVICE_STATE_STOPPING it  * sets the stopping state handlers and posts an RNC invalidate request to the  * SCU hardware.  *  * @param[in] object This is the SCI_BASE_OBJECT that is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_stopping_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_device
argument_list|,
name|scic_sds_remote_device_state_handler_table
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_STOPPING
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This is the enter method for the SCI_BASE_REMOTE_DEVICE_STATE_FAILED it  * sets the stopping state handlers.  *  * @param[in] object This is the SCI_BASE_OBJECT that is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_failed_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_device
argument_list|,
name|scic_sds_remote_device_state_handler_table
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_FAILED
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This is the enter method for the SCI_BASE_REMOTE_DEVICE_STATE_RESETTING it  * sets the resetting state handlers.  *  * @param[in] object This is the SCI_BASE_OBJECT that is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_resetting_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_device
argument_list|,
name|scic_sds_remote_device_state_handler_table
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_RESETTING
argument_list|)
expr_stmt|;
name|scic_sds_remote_node_context_suspend
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|SCI_SOFTWARE_SUSPENSION
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This is the exit method for the SCI_BASE_REMOTE_DEVICE_STATE_RESETTING it  * does nothing.  *  * @param[in] object This is the SCI_BASE_OBJECT that is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_resetting_state_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|object
decl_stmt|;
name|scic_sds_remote_node_context_resume
argument_list|(
name|this_device
operator|->
name|rnc
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This is the enter method for the SCI_BASE_REMOTE_DEVICE_STATE_FINAL it sets  * the final state handlers.  *  * @param[in] object This is the SCI_BASE_OBJECT that is cast into a  *       SCIC_SDS_REMOTE_DEVICE.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_remote_device_final_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|this_device
init|=
operator|(
name|SCIC_SDS_REMOTE_DEVICE_T
operator|*
operator|)
name|object
decl_stmt|;
name|SET_STATE_HANDLER
argument_list|(
name|this_device
argument_list|,
name|scic_sds_remote_device_state_handler_table
argument_list|,
name|SCI_BASE_REMOTE_DEVICE_STATE_FINAL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCI_BASE_STATE_T
name|scic_sds_remote_device_state_table
index|[
name|SCI_BASE_REMOTE_DEVICE_MAX_STATES
index|]
init|=
block|{
block|{
name|SCI_BASE_REMOTE_DEVICE_STATE_INITIAL
block|,
name|scic_sds_remote_device_initial_state_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCI_BASE_REMOTE_DEVICE_STATE_STOPPED
block|,
name|scic_sds_remote_device_stopped_state_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCI_BASE_REMOTE_DEVICE_STATE_STARTING
block|,
name|scic_sds_remote_device_starting_state_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCI_BASE_REMOTE_DEVICE_STATE_READY
block|,
name|scic_sds_remote_device_ready_state_enter
block|,
name|scic_sds_remote_device_ready_state_exit
block|}
block|,
block|{
name|SCI_BASE_REMOTE_DEVICE_STATE_STOPPING
block|,
name|scic_sds_remote_device_stopping_state_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCI_BASE_REMOTE_DEVICE_STATE_FAILED
block|,
name|scic_sds_remote_device_failed_state_enter
block|,
name|NULL
block|}
block|,
block|{
name|SCI_BASE_REMOTE_DEVICE_STATE_RESETTING
block|,
name|scic_sds_remote_device_resetting_state_enter
block|,
name|scic_sds_remote_device_resetting_state_exit
block|}
block|,
if|#
directive|if
operator|!
name|defined
argument_list|(
name|DISABLE_WIDE_PORTED_TARGETS
argument_list|)
block|{
comment|//Not used by SCIC
name|SCI_BASE_REMOTE_DEVICE_STATE_UPDATING_PORT_WIDTH
block|,
name|NULL
block|,
name|NULL
block|}
block|,
endif|#
directive|endif
comment|//#if !defined(DISABLE_WIDE_PORTED_TARGETS)
block|{
name|SCI_BASE_REMOTE_DEVICE_STATE_FINAL
block|,
name|scic_sds_remote_device_final_state_enter
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

end_unit


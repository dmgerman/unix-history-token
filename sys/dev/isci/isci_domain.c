begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * BSD LICENSE  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in  *     the documentation and/or other materials provided with the  *     distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/isci/isci.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_periph.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_periph.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scif_domain.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scif_remote_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scif_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scif_user_callback.h>
end_include

begin_comment
comment|/**  * @brief This callback method informs the framework user that something  *        in the supplied domain has changed (e.g. a device was added or  *        removed).  *  * This callback is called by the framework outside of discovery or  * target reset processes.  Specifically, domain changes occurring  * during these processes are handled by the framework.  For example,  * in the case of Serial Attached SCSI, reception of a BROADCAST (CHANGE)  * during discovery will cause discovery to restart.  Thus, discovery  * does not complete until all BCNs are processed. Note, during controller  * stopping/reset process, the framework user should not expect this call  * back.  *  * @param[in]  controller This parameter specifies the controller object  *             with which this callback is associated.  * @param[in]  domain This parameter specifies the domain object with  *             which this callback is associated.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_cb_domain_change_notification
parameter_list|(
name|SCI_CONTROLLER_HANDLE_T
name|controller
parameter_list|,
name|SCI_DOMAIN_HANDLE_T
name|domain
parameter_list|)
block|{
name|struct
name|ISCI_CONTROLLER
modifier|*
name|isci_controller
init|=
operator|(
expr|struct
name|ISCI_CONTROLLER
operator|*
operator|)
name|sci_object_get_association
argument_list|(
name|controller
argument_list|)
decl_stmt|;
comment|/* When the controller start is complete, we will explicitly discover 	 *  all of the domains then.  This is because SCIF will not allow 	 *  any I/O to start until the controller is ready, meaning internal SMP 	 *  requests triggered by domain discovery won't work until the controller 	 *  is ready. 	 */
if|if
condition|(
name|isci_controller
operator|->
name|is_started
operator|==
name|TRUE
condition|)
name|scif_domain_discover
argument_list|(
name|domain
argument_list|,
name|scif_domain_get_suggested_discover_timeout
argument_list|(
name|domain
argument_list|)
argument_list|,
name|DEVICE_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This callback method informs the framework user that a previously  *        requested discovery operation on the domain has completed.  *  * @param[in]  controller This parameter specifies the controller object  *             with which this callback is associated.  * @param[in]  domain This parameter specifies the domain object with  *             which this callback is associated.  * @param[in]  completion_status This parameter indicates the results of the  *             discovery operation.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_cb_domain_discovery_complete
parameter_list|(
name|SCI_CONTROLLER_HANDLE_T
name|controller
parameter_list|,
name|SCI_DOMAIN_HANDLE_T
name|domain
parameter_list|,
name|SCI_STATUS
name|completion_status
parameter_list|)
block|{
if|if
condition|(
name|completion_status
operator|!=
name|SCI_SUCCESS
condition|)
name|isci_log_message
argument_list|(
literal|0
argument_list|,
literal|"ISCI"
argument_list|,
literal|"scif_cb_domain_discovery_complete status = 0x%x\n"
argument_list|,
name|completion_status
argument_list|)
expr_stmt|;
name|isci_controller_domain_discovery_complete
argument_list|(
operator|(
expr|struct
name|ISCI_CONTROLLER
operator|*
operator|)
name|sci_object_get_association
argument_list|(
name|controller
argument_list|)
argument_list|,
operator|(
expr|struct
name|ISCI_DOMAIN
operator|*
operator|)
name|sci_object_get_association
argument_list|(
name|domain
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This callback method informs the framework user that a previously  *        requested reset operation on the domain has completed.  *  * @param[in]  controller This parameter specifies the controller object  *             with which this callback is associated.  * @param[in]  domain This parameter specifies the domain object with  *             which this callback is associated.  * @param[in]  completion_status This parameter indicates the results of the  *             reset operation.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_cb_domain_reset_complete
parameter_list|(
name|SCI_CONTROLLER_HANDLE_T
name|controller
parameter_list|,
name|SCI_DOMAIN_HANDLE_T
name|domain
parameter_list|,
name|SCI_STATUS
name|completion_status
parameter_list|)
block|{  }
end_function

begin_comment
comment|/**  * @brief This callback method informs the framework user that the domain  *        is ready and capable of processing IO requests for devices found  *        inside it.  *  * @param[in]  controller This parameter specifies the controller object  *             with which this callback is associated.  * @param[in]  domain This parameter specifies the domain object with  *             which this callback is associated.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_cb_domain_ready
parameter_list|(
name|SCI_CONTROLLER_HANDLE_T
name|controller
parameter_list|,
name|SCI_DOMAIN_HANDLE_T
name|domain
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|struct
name|ISCI_DOMAIN
modifier|*
name|isci_domain
init|=
name|sci_object_get_association
argument_list|(
name|domain
argument_list|)
decl_stmt|;
name|struct
name|ISCI_CONTROLLER
modifier|*
name|isci_controller
init|=
name|sci_object_get_association
argument_list|(
name|controller
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SCI_MAX_REMOTE_DEVICES
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ISCI_REMOTE_DEVICE
modifier|*
name|remote_device
init|=
name|isci_controller
operator|->
name|remote_device
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|remote_device
operator|!=
name|NULL
operator|&&
name|remote_device
operator|->
name|domain
operator|==
name|isci_domain
condition|)
name|isci_remote_device_release_device_queue
argument_list|(
name|remote_device
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This callback method informs the framework user that the domain  *        is no longer ready. Thus, it is incapable of processing IO  *        requests for devices found inside it.  *  * @param[in]  controller This parameter specifies the controller object  *             with which this callback is associated.  * @param[in]  domain This parameter specifies the domain object with  *             which this callback is associated.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_cb_domain_not_ready
parameter_list|(
name|SCI_CONTROLLER_HANDLE_T
name|controller
parameter_list|,
name|SCI_DOMAIN_HANDLE_T
name|domain
parameter_list|)
block|{  }
end_function

begin_comment
comment|/**  * @brief This callback method informs the framework user that a new  *        direct attached device was found in the domain.  *  * @param[in]  controller This parameter specifies the controller object  *             with which this callback is associated.  * @param[in]  domain This parameter specifies the domain object with  *             which this callback is associated.  * @param[in]  sas_address This parameter specifies the SAS address of  *             the new device.  * @param[in]  protocols This parameter specifies the protocols  *             supported by the newly discovered device.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_cb_domain_da_device_added
parameter_list|(
name|SCI_CONTROLLER_HANDLE_T
name|controller
parameter_list|,
name|SCI_DOMAIN_HANDLE_T
name|domain
parameter_list|,
name|SCI_SAS_ADDRESS_T
modifier|*
name|sas_address
parameter_list|,
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_PROTOCOLS_T
modifier|*
name|protocols
parameter_list|)
block|{
name|struct
name|ISCI_REMOTE_DEVICE
modifier|*
name|remote_device
decl_stmt|;
name|struct
name|ISCI_DOMAIN
modifier|*
name|isci_domain
init|=
operator|(
expr|struct
name|ISCI_DOMAIN
operator|*
operator|)
name|sci_object_get_association
argument_list|(
name|domain
argument_list|)
decl_stmt|;
comment|/* 	 * For direct-attached devices, do not pull the device object from 	 *  the pool.  Rather, use the one stored in the domain object which 	 *  will ensure that we always get consistent target ids for direct 	 *  attached devices. 	 */
name|remote_device
operator|=
name|isci_domain
operator|->
name|da_remote_device
expr_stmt|;
name|scif_remote_device_construct
argument_list|(
name|domain
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|remote_device
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ISCI_REMOTE_DEVICE
argument_list|)
argument_list|,
operator|&
operator|(
name|remote_device
operator|->
name|sci_object
operator|)
argument_list|)
expr_stmt|;
name|sci_object_set_association
argument_list|(
name|remote_device
operator|->
name|sci_object
argument_list|,
name|remote_device
argument_list|)
expr_stmt|;
name|scif_remote_device_da_construct
argument_list|(
name|remote_device
operator|->
name|sci_object
argument_list|,
name|sas_address
argument_list|,
name|protocols
argument_list|)
expr_stmt|;
comment|/* We do not put the device in the ISCI_CONTROLLER's device array yet. 	 *  That will happen once the device becomes ready (see 	 *  scif_cb_remote_device_ready). 	 */
name|remote_device
operator|->
name|domain
operator|=
name|isci_domain
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This callback method informs the framework user that a new  *        expander attached device was found in the domain.  *  * @param[in]  controller This parameter specifies the controller object  *             with which this callback is associated.  * @param[in]  domain This parameter specifies the domain object with  *             which this callback is associated.  * @param[in]  containing_device This parameter specifies the remote  *             device that contains the device that was added.  * @param[in]  smp_response This parameter specifies the SMP response  *             data associated with the newly discovered device.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_cb_domain_ea_device_added
parameter_list|(
name|SCI_CONTROLLER_HANDLE_T
name|controller
parameter_list|,
name|SCI_DOMAIN_HANDLE_T
name|domain
parameter_list|,
name|SCI_REMOTE_DEVICE_HANDLE_T
name|containing_device
parameter_list|,
name|SMP_RESPONSE_DISCOVER_T
modifier|*
name|smp_response
parameter_list|)
block|{
name|struct
name|ISCI_REMOTE_DEVICE
modifier|*
name|remote_device
decl_stmt|;
name|struct
name|ISCI_DOMAIN
modifier|*
name|isci_domain
init|=
operator|(
expr|struct
name|ISCI_DOMAIN
operator|*
operator|)
name|sci_object_get_association
argument_list|(
name|domain
argument_list|)
decl_stmt|;
name|struct
name|ISCI_CONTROLLER
modifier|*
name|isci_controller
init|=
operator|(
expr|struct
name|ISCI_CONTROLLER
operator|*
operator|)
name|sci_object_get_association
argument_list|(
name|controller
argument_list|)
decl_stmt|;
name|sci_pool_get
argument_list|(
name|isci_controller
operator|->
name|remote_device_pool
argument_list|,
name|remote_device
argument_list|)
expr_stmt|;
name|scif_remote_device_construct
argument_list|(
name|domain
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|remote_device
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ISCI_REMOTE_DEVICE
argument_list|)
argument_list|,
operator|&
operator|(
name|remote_device
operator|->
name|sci_object
operator|)
argument_list|)
expr_stmt|;
name|sci_object_set_association
argument_list|(
name|remote_device
operator|->
name|sci_object
argument_list|,
name|remote_device
argument_list|)
expr_stmt|;
name|scif_remote_device_ea_construct
argument_list|(
name|remote_device
operator|->
name|sci_object
argument_list|,
name|containing_device
argument_list|,
name|smp_response
argument_list|)
expr_stmt|;
comment|/* We do not put the device in the ISCI_CONTROLLER's device array yet. 	 *  That will happen once the device becomes ready (see 	 *  scif_cb_remote_device_ready). 	 */
name|remote_device
operator|->
name|domain
operator|=
name|isci_domain
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This callback method informs the framework user that a device  *        has been removed from the domain.  *  * @param[in]  controller This parameter specifies the controller object  *             with which this callback is associated.  * @param[in]  domain This parameter specifies the domain object with  *             which this callback is associated.  * @param[in]  remote_device This parameter specifies the device object with  *             which this callback is associated.  *  * @return none  */
end_comment

begin_function
name|void
name|scif_cb_domain_device_removed
parameter_list|(
name|SCI_CONTROLLER_HANDLE_T
name|controller
parameter_list|,
name|SCI_DOMAIN_HANDLE_T
name|domain
parameter_list|,
name|SCI_REMOTE_DEVICE_HANDLE_T
name|remote_device
parameter_list|)
block|{
name|struct
name|ISCI_REMOTE_DEVICE
modifier|*
name|isci_remote_device
init|=
operator|(
expr|struct
name|ISCI_REMOTE_DEVICE
operator|*
operator|)
name|sci_object_get_association
argument_list|(
name|remote_device
argument_list|)
decl_stmt|;
name|struct
name|ISCI_DOMAIN
modifier|*
name|isci_domain
init|=
operator|(
expr|struct
name|ISCI_DOMAIN
operator|*
operator|)
name|sci_object_get_association
argument_list|(
name|domain
argument_list|)
decl_stmt|;
name|struct
name|ISCI_CONTROLLER
modifier|*
name|isci_controller
init|=
operator|(
expr|struct
name|ISCI_CONTROLLER
operator|*
operator|)
name|sci_object_get_association
argument_list|(
name|controller
argument_list|)
decl_stmt|;
name|uint32_t
name|path
init|=
name|cam_sim_path
argument_list|(
name|isci_controller
operator|->
name|sim
argument_list|)
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
init|=
name|xpt_alloc_ccb_nowait
argument_list|()
decl_stmt|;
name|isci_controller
operator|->
name|remote_device
index|[
name|isci_remote_device
operator|->
name|index
index|]
operator|=
name|NULL
expr_stmt|;
name|xpt_create_path
argument_list|(
operator|&
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|xpt_periph
argument_list|,
name|path
argument_list|,
name|isci_remote_device
operator|->
name|index
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
expr_stmt|;
name|xpt_rescan
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
name|scif_remote_device_destruct
argument_list|(
name|remote_device
argument_list|)
expr_stmt|;
comment|/* 	 * Only put the remote device back into the pool if it was an 	 *  expander-attached device. 	 */
if|if
condition|(
name|isci_remote_device
operator|!=
name|isci_domain
operator|->
name|da_remote_device
condition|)
name|sci_pool_put
argument_list|(
name|isci_controller
operator|->
name|remote_device_pool
argument_list|,
name|isci_remote_device
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isci_domain_construct
parameter_list|(
name|struct
name|ISCI_DOMAIN
modifier|*
name|domain
parameter_list|,
name|uint32_t
name|domain_index
parameter_list|,
name|struct
name|ISCI_CONTROLLER
modifier|*
name|controller
parameter_list|)
block|{
name|scif_controller_get_domain_handle
argument_list|(
name|controller
operator|->
name|scif_controller_handle
argument_list|,
name|domain_index
argument_list|,
operator|&
name|domain
operator|->
name|sci_object
argument_list|)
expr_stmt|;
name|domain
operator|->
name|index
operator|=
name|domain_index
expr_stmt|;
name|domain
operator|->
name|controller
operator|=
name|controller
expr_stmt|;
name|sci_object_set_association
argument_list|(
name|domain
operator|->
name|sci_object
argument_list|,
operator|(
name|void
operator|*
operator|)
name|domain
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


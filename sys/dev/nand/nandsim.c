begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2009-2012 Semihalf  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/* Simulated NAND controller driver */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<dev/nand/nand.h>
end_include

begin_include
include|#
directive|include
file|<dev/nand/nandsim.h>
end_include

begin_include
include|#
directive|include
file|<dev/nand/nandsim_chip.h>
end_include

begin_include
include|#
directive|include
file|<dev/nand/nandsim_log.h>
end_include

begin_include
include|#
directive|include
file|<dev/nand/nandsim_swap.h>
end_include

begin_decl_stmt
name|struct
name|sim_param
name|sim
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sim_ctrl_conf
name|ctrls
index|[
name|MAX_SIM_DEV
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|cdev
modifier|*
name|nandsim_dev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_ioctl_t
name|nandsim_ioctl
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|nandsim_init_sim_param
parameter_list|(
name|struct
name|sim_param
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_create_ctrl
parameter_list|(
name|struct
name|sim_ctrl
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_destroy_ctrl
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_ctrl_status
parameter_list|(
name|struct
name|sim_ctrl
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_create_chip
parameter_list|(
name|struct
name|sim_chip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_destroy_chip
parameter_list|(
name|struct
name|sim_ctrl_chip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_chip_status
parameter_list|(
name|struct
name|sim_chip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_start_ctrl
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_stop_ctrl
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_inject_error
parameter_list|(
name|struct
name|sim_error
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_get_block_state
parameter_list|(
name|struct
name|sim_block_state
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_set_block_state
parameter_list|(
name|struct
name|sim_block_state
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_modify
parameter_list|(
name|struct
name|sim_mod
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_dump
parameter_list|(
name|struct
name|sim_dump
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_restore
parameter_list|(
name|struct
name|sim_dump
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nandsim_freeze
parameter_list|(
name|struct
name|sim_ctrl_chip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nandsim_print_log
parameter_list|(
name|struct
name|sim_log
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|nandsim_chip
modifier|*
name|get_nandsim_chip
parameter_list|(
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|cdevsw
name|nandsim_cdevsw
init|=
block|{
operator|.
name|d_version
operator|=
name|D_VERSION
block|,
operator|.
name|d_flags
operator|=
name|D_NEEDGIANT
block|,
operator|.
name|d_ioctl
operator|=
name|nandsim_ioctl
block|,
operator|.
name|d_name
operator|=
literal|"nandsim"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|nandsim_ioctl
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|NANDSIM_SIM_PARAM
case|:
name|nandsim_init_sim_param
argument_list|(
operator|(
expr|struct
name|sim_param
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_CREATE_CTRL
case|:
name|ret
operator|=
name|nandsim_create_ctrl
argument_list|(
operator|(
expr|struct
name|sim_ctrl
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_DESTROY_CTRL
case|:
name|ret
operator|=
name|nandsim_destroy_ctrl
argument_list|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_STATUS_CTRL
case|:
name|ret
operator|=
name|nandsim_ctrl_status
argument_list|(
operator|(
expr|struct
name|sim_ctrl
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_CREATE_CHIP
case|:
name|ret
operator|=
name|nandsim_create_chip
argument_list|(
operator|(
expr|struct
name|sim_chip
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_DESTROY_CHIP
case|:
name|ret
operator|=
name|nandsim_destroy_chip
argument_list|(
operator|(
expr|struct
name|sim_ctrl_chip
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_STATUS_CHIP
case|:
name|ret
operator|=
name|nandsim_chip_status
argument_list|(
operator|(
expr|struct
name|sim_chip
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_MODIFY
case|:
name|ret
operator|=
name|nandsim_modify
argument_list|(
operator|(
expr|struct
name|sim_mod
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_START_CTRL
case|:
name|ret
operator|=
name|nandsim_start_ctrl
argument_list|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_STOP_CTRL
case|:
name|ret
operator|=
name|nandsim_stop_ctrl
argument_list|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_INJECT_ERROR
case|:
name|ret
operator|=
name|nandsim_inject_error
argument_list|(
operator|(
expr|struct
name|sim_error
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_SET_BLOCK_STATE
case|:
name|ret
operator|=
name|nandsim_set_block_state
argument_list|(
operator|(
expr|struct
name|sim_block_state
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_GET_BLOCK_STATE
case|:
name|ret
operator|=
name|nandsim_get_block_state
argument_list|(
operator|(
expr|struct
name|sim_block_state
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_PRINT_LOG
case|:
name|nandsim_print_log
argument_list|(
operator|(
expr|struct
name|sim_log
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_DUMP
case|:
name|ret
operator|=
name|nandsim_dump
argument_list|(
operator|(
expr|struct
name|sim_dump
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_RESTORE
case|:
name|ret
operator|=
name|nandsim_restore
argument_list|(
operator|(
expr|struct
name|sim_dump
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|NANDSIM_FREEZE
case|:
name|ret
operator|=
name|nandsim_freeze
argument_list|(
operator|(
expr|struct
name|sim_ctrl_chip
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nandsim_init_sim_param
parameter_list|(
name|struct
name|sim_param
modifier|*
name|param
parameter_list|)
block|{
if|if
condition|(
operator|!
name|param
condition|)
return|return;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"log level:%d output %d"
argument_list|,
name|param
operator|->
name|log_level
argument_list|,
name|param
operator|->
name|log_output
argument_list|)
expr_stmt|;
name|nandsim_log_level
operator|=
name|param
operator|->
name|log_level
expr_stmt|;
name|nandsim_log_output
operator|=
name|param
operator|->
name|log_output
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_create_ctrl
parameter_list|(
name|struct
name|sim_ctrl
modifier|*
name|ctrl
parameter_list|)
block|{
name|struct
name|sim_ctrl_conf
modifier|*
name|sim_ctrl
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"create controller num:%d cs:%d"
argument_list|,
name|ctrl
operator|->
name|num
argument_list|,
name|ctrl
operator|->
name|num_cs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|->
name|num
operator|>=
name|MAX_SIM_DEV
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|sim_ctrl
operator|=
operator|&
name|ctrls
index|[
name|ctrl
operator|->
name|num
index|]
expr_stmt|;
if|if
condition|(
name|sim_ctrl
operator|->
name|created
condition|)
return|return
operator|(
name|EEXIST
operator|)
return|;
name|sim_ctrl
operator|->
name|num
operator|=
name|ctrl
operator|->
name|num
expr_stmt|;
name|sim_ctrl
operator|->
name|num_cs
operator|=
name|ctrl
operator|->
name|num_cs
expr_stmt|;
name|sim_ctrl
operator|->
name|ecc
operator|=
name|ctrl
operator|->
name|ecc
expr_stmt|;
name|memcpy
argument_list|(
name|sim_ctrl
operator|->
name|ecc_layout
argument_list|,
name|ctrl
operator|->
name|ecc_layout
argument_list|,
name|MAX_ECC_BYTES
operator|*
sizeof|sizeof
argument_list|(
name|ctrl
operator|->
name|ecc_layout
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|sim_ctrl
operator|->
name|filename
argument_list|,
name|ctrl
operator|->
name|filename
argument_list|,
name|FILENAME_SIZE
argument_list|)
expr_stmt|;
name|sim_ctrl
operator|->
name|created
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_destroy_ctrl
parameter_list|(
name|int
name|ctrl_num
parameter_list|)
block|{
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"destroy controller num:%d"
argument_list|,
name|ctrl_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|ctrls
index|[
name|ctrl_num
index|]
operator|.
name|created
condition|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
if|if
condition|(
name|ctrls
index|[
name|ctrl_num
index|]
operator|.
name|running
condition|)
block|{
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
name|memset
argument_list|(
operator|&
name|ctrls
index|[
name|ctrl_num
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ctrls
index|[
name|ctrl_num
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_ctrl_status
parameter_list|(
name|struct
name|sim_ctrl
modifier|*
name|ctrl
parameter_list|)
block|{
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"status controller num:%d cs:%d"
argument_list|,
name|ctrl
operator|->
name|num
argument_list|,
name|ctrl
operator|->
name|num_cs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|->
name|num
operator|>=
name|MAX_SIM_DEV
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|ctrl
operator|->
name|num_cs
operator|=
name|ctrls
index|[
name|ctrl
operator|->
name|num
index|]
operator|.
name|num_cs
expr_stmt|;
name|ctrl
operator|->
name|ecc
operator|=
name|ctrls
index|[
name|ctrl
operator|->
name|num
index|]
operator|.
name|ecc
expr_stmt|;
name|memcpy
argument_list|(
name|ctrl
operator|->
name|ecc_layout
argument_list|,
name|ctrls
index|[
name|ctrl
operator|->
name|num
index|]
operator|.
name|ecc_layout
argument_list|,
name|MAX_ECC_BYTES
operator|*
sizeof|sizeof
argument_list|(
name|ctrl
operator|->
name|ecc_layout
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ctrl
operator|->
name|filename
argument_list|,
name|ctrls
index|[
name|ctrl
operator|->
name|num
index|]
operator|.
name|filename
argument_list|,
name|FILENAME_SIZE
argument_list|)
expr_stmt|;
name|ctrl
operator|->
name|running
operator|=
name|ctrls
index|[
name|ctrl
operator|->
name|num
index|]
operator|.
name|running
expr_stmt|;
name|ctrl
operator|->
name|created
operator|=
name|ctrls
index|[
name|ctrl
operator|->
name|num
index|]
operator|.
name|created
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_create_chip
parameter_list|(
name|struct
name|sim_chip
modifier|*
name|chip
parameter_list|)
block|{
name|struct
name|sim_chip
modifier|*
name|sim_chip
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"create chip num:%d at ctrl:%d"
argument_list|,
name|chip
operator|->
name|num
argument_list|,
name|chip
operator|->
name|ctrl_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|chip
operator|->
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
operator|||
name|chip
operator|->
name|num
operator|>=
name|MAX_CTRL_CS
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|ctrls
index|[
name|chip
operator|->
name|ctrl_num
index|]
operator|.
name|chips
index|[
name|chip
operator|->
name|num
index|]
condition|)
block|{
return|return
operator|(
name|EEXIST
operator|)
return|;
block|}
name|sim_chip
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sim_chip
argument_list|)
argument_list|,
name|M_NANDSIM
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|sim_chip
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|sim_chip
argument_list|,
name|chip
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sim_chip
argument_list|)
argument_list|)
expr_stmt|;
name|ctrls
index|[
name|chip
operator|->
name|ctrl_num
index|]
operator|.
name|chips
index|[
name|chip
operator|->
name|num
index|]
operator|=
name|sim_chip
expr_stmt|;
name|sim_chip
operator|->
name|created
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_destroy_chip
parameter_list|(
name|struct
name|sim_ctrl_chip
modifier|*
name|chip
parameter_list|)
block|{
name|struct
name|sim_ctrl_conf
modifier|*
name|ctrl_conf
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"destroy chip num:%d at ctrl:%d"
argument_list|,
name|chip
operator|->
name|chip_num
argument_list|,
name|chip
operator|->
name|ctrl_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|chip
operator|->
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
operator|||
name|chip
operator|->
name|chip_num
operator|>=
name|MAX_CTRL_CS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|ctrl_conf
operator|=
operator|&
name|ctrls
index|[
name|chip
operator|->
name|ctrl_num
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|ctrl_conf
operator|->
name|created
operator|||
operator|!
name|ctrl_conf
operator|->
name|chips
index|[
name|chip
operator|->
name|chip_num
index|]
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
if|if
condition|(
name|ctrl_conf
operator|->
name|running
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
name|free
argument_list|(
name|ctrl_conf
operator|->
name|chips
index|[
name|chip
operator|->
name|chip_num
index|]
argument_list|,
name|M_NANDSIM
argument_list|)
expr_stmt|;
name|ctrl_conf
operator|->
name|chips
index|[
name|chip
operator|->
name|chip_num
index|]
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_chip_status
parameter_list|(
name|struct
name|sim_chip
modifier|*
name|chip
parameter_list|)
block|{
name|struct
name|sim_ctrl_conf
modifier|*
name|ctrl_conf
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"status for chip num:%d at ctrl:%d"
argument_list|,
name|chip
operator|->
name|num
argument_list|,
name|chip
operator|->
name|ctrl_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|chip
operator|->
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
operator|&&
name|chip
operator|->
name|num
operator|>=
name|MAX_CTRL_CS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|ctrl_conf
operator|=
operator|&
name|ctrls
index|[
name|chip
operator|->
name|ctrl_num
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|ctrl_conf
operator|->
name|chips
index|[
name|chip
operator|->
name|num
index|]
condition|)
name|chip
operator|->
name|created
operator|=
literal|0
expr_stmt|;
else|else
name|memcpy
argument_list|(
name|chip
argument_list|,
name|ctrl_conf
operator|->
name|chips
index|[
name|chip
operator|->
name|num
index|]
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|chip
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_start_ctrl
parameter_list|(
name|int
name|num
parameter_list|)
block|{
name|device_t
name|nexus
decl_stmt|,
name|ndev
decl_stmt|;
name|devclass_t
name|nexus_devclass
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"start ctlr num:%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|>=
name|MAX_SIM_DEV
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|!
name|ctrls
index|[
name|num
index|]
operator|.
name|created
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
if|if
condition|(
name|ctrls
index|[
name|num
index|]
operator|.
name|running
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
comment|/* We will add our device as a child of the nexus0 device */
if|if
condition|(
operator|!
operator|(
name|nexus_devclass
operator|=
name|devclass_find
argument_list|(
literal|"nexus"
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|nexus
operator|=
name|devclass_get_device
argument_list|(
name|nexus_devclass
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
comment|/* 	 * Create a newbus device representing this frontend instance 	 * 	 * XXX powerpc nexus doesn't implement bus_add_child, so child 	 * must be added by device_add_child(). 	 */
if|#
directive|if
name|defined
argument_list|(
name|__powerpc__
argument_list|)
name|ndev
operator|=
name|device_add_child
argument_list|(
name|nexus
argument_list|,
literal|"nandsim"
argument_list|,
name|num
argument_list|)
expr_stmt|;
else|#
directive|else
name|ndev
operator|=
name|BUS_ADD_CHILD
argument_list|(
name|nexus
argument_list|,
literal|0
argument_list|,
literal|"nandsim"
argument_list|,
name|num
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|ndev
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|ret
operator|=
name|device_probe_and_attach
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|ctrls
index|[
name|num
index|]
operator|.
name|sim_ctrl_dev
operator|=
name|ndev
expr_stmt|;
name|ctrls
index|[
name|num
index|]
operator|.
name|running
operator|=
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_stop_ctrl
parameter_list|(
name|int
name|num
parameter_list|)
block|{
name|device_t
name|nexus
decl_stmt|;
name|devclass_t
name|nexus_devclass
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"stop controller num:%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|>=
name|MAX_SIM_DEV
condition|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|ctrls
index|[
name|num
index|]
operator|.
name|created
operator|||
operator|!
name|ctrls
index|[
name|num
index|]
operator|.
name|running
condition|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
comment|/* We will add our device as a child of the nexus0 device */
if|if
condition|(
operator|!
operator|(
name|nexus_devclass
operator|=
name|devclass_find
argument_list|(
literal|"nexus"
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|nexus
operator|=
name|devclass_get_device
argument_list|(
name|nexus_devclass
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrls
index|[
name|num
index|]
operator|.
name|sim_ctrl_dev
condition|)
block|{
name|ret
operator|=
name|device_delete_child
argument_list|(
name|nexus
argument_list|,
name|ctrls
index|[
name|num
index|]
operator|.
name|sim_ctrl_dev
argument_list|)
expr_stmt|;
name|ctrls
index|[
name|num
index|]
operator|.
name|sim_ctrl_dev
operator|=
name|NULL
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|ctrls
index|[
name|num
index|]
operator|.
name|running
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|nandsim_chip
modifier|*
name|get_nandsim_chip
parameter_list|(
name|uint8_t
name|ctrl_num
parameter_list|,
name|uint8_t
name|chip_num
parameter_list|)
block|{
name|struct
name|nandsim_softc
modifier|*
name|sc
decl_stmt|;
if|if
condition|(
operator|!
name|ctrls
index|[
name|ctrl_num
index|]
operator|.
name|sim_ctrl_dev
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|ctrls
index|[
name|ctrl_num
index|]
operator|.
name|sim_ctrl_dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|sc
operator|->
name|chips
index|[
name|chip_num
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nandsim_print_log
parameter_list|(
name|struct
name|sim_log
modifier|*
name|sim_log
parameter_list|)
block|{
name|struct
name|nandsim_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|len1
decl_stmt|,
name|len2
decl_stmt|;
if|if
condition|(
operator|!
name|ctrls
index|[
name|sim_log
operator|->
name|ctrl_num
index|]
operator|.
name|sim_ctrl_dev
condition|)
return|return;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|ctrls
index|[
name|sim_log
operator|->
name|ctrl_num
index|]
operator|.
name|sim_ctrl_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|log_buff
condition|)
block|{
name|len1
operator|=
name|strlen
argument_list|(
operator|&
name|sc
operator|->
name|log_buff
index|[
name|sc
operator|->
name|log_idx
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|len1
operator|>=
name|sim_log
operator|->
name|len
condition|)
name|len1
operator|=
name|sim_log
operator|->
name|len
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|sc
operator|->
name|log_buff
index|[
name|sc
operator|->
name|log_idx
operator|+
literal|1
index|]
argument_list|,
name|sim_log
operator|->
name|log
argument_list|,
name|len1
argument_list|)
expr_stmt|;
name|len2
operator|=
name|strlen
argument_list|(
name|sc
operator|->
name|log_buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|len2
operator|>=
operator|(
name|sim_log
operator|->
name|len
operator|-
name|len1
operator|)
condition|)
name|len2
operator|=
operator|(
name|sim_log
operator|->
name|len
operator|-
name|len1
operator|)
expr_stmt|;
name|copyout
argument_list|(
name|sc
operator|->
name|log_buff
argument_list|,
operator|&
name|sim_log
operator|->
name|log
index|[
name|len1
index|]
argument_list|,
name|len2
argument_list|)
expr_stmt|;
name|sim_log
operator|->
name|len
operator|=
name|len1
operator|+
name|len2
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_inject_error
parameter_list|(
name|struct
name|sim_error
modifier|*
name|error
parameter_list|)
block|{
name|struct
name|nandsim_chip
modifier|*
name|chip
decl_stmt|;
name|struct
name|block_space
modifier|*
name|bs
decl_stmt|;
name|struct
name|onfi_params
modifier|*
name|param
decl_stmt|;
name|int
name|page
decl_stmt|,
name|page_size
decl_stmt|,
name|block
decl_stmt|,
name|offset
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"inject error for chip %d at ctrl %d\n"
argument_list|,
name|error
operator|->
name|chip_num
argument_list|,
name|error
operator|->
name|ctrl_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|->
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
operator|||
name|error
operator|->
name|chip_num
operator|>=
name|MAX_CTRL_CS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|!
name|ctrls
index|[
name|error
operator|->
name|ctrl_num
index|]
operator|.
name|created
operator|||
operator|!
name|ctrls
index|[
name|error
operator|->
name|ctrl_num
index|]
operator|.
name|running
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|chip
operator|=
name|get_nandsim_chip
argument_list|(
name|error
operator|->
name|ctrl_num
argument_list|,
name|error
operator|->
name|chip_num
argument_list|)
expr_stmt|;
name|param
operator|=
operator|&
name|chip
operator|->
name|params
expr_stmt|;
name|page_size
operator|=
name|param
operator|->
name|bytes_per_page
operator|+
name|param
operator|->
name|spare_bytes_per_page
expr_stmt|;
name|block
operator|=
name|error
operator|->
name|page_num
operator|/
name|param
operator|->
name|pages_per_block
expr_stmt|;
name|page
operator|=
name|error
operator|->
name|page_num
operator|%
name|param
operator|->
name|pages_per_block
expr_stmt|;
name|bs
operator|=
name|get_bs
argument_list|(
name|chip
operator|->
name|swap
argument_list|,
name|block
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bs
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|offset
operator|=
operator|(
name|page
operator|*
name|page_size
operator|)
operator|+
name|error
operator|->
name|column
expr_stmt|;
name|memset
argument_list|(
operator|&
name|bs
operator|->
name|blk_ptr
index|[
name|offset
index|]
argument_list|,
name|error
operator|->
name|pattern
argument_list|,
name|error
operator|->
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_set_block_state
parameter_list|(
name|struct
name|sim_block_state
modifier|*
name|bs
parameter_list|)
block|{
name|struct
name|onfi_params
modifier|*
name|params
decl_stmt|;
name|struct
name|nandsim_chip
modifier|*
name|chip
decl_stmt|;
name|int
name|blocks
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"set block state for %d:%d block %d\n"
argument_list|,
name|bs
operator|->
name|chip_num
argument_list|,
name|bs
operator|->
name|ctrl_num
argument_list|,
name|bs
operator|->
name|block_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|bs
operator|->
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
operator|||
name|bs
operator|->
name|chip_num
operator|>=
name|MAX_CTRL_CS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|chip
operator|=
name|get_nandsim_chip
argument_list|(
name|bs
operator|->
name|ctrl_num
argument_list|,
name|bs
operator|->
name|chip_num
argument_list|)
expr_stmt|;
name|params
operator|=
operator|&
name|chip
operator|->
name|params
expr_stmt|;
name|blocks
operator|=
name|params
operator|->
name|luns
operator|*
name|params
operator|->
name|blocks_per_lun
expr_stmt|;
if|if
condition|(
name|bs
operator|->
name|block_num
operator|>
name|blocks
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|chip
operator|->
name|blk_state
index|[
name|bs
operator|->
name|block_num
index|]
operator|.
name|is_bad
operator|=
name|bs
operator|->
name|state
expr_stmt|;
if|if
condition|(
name|bs
operator|->
name|wearout
operator|>=
literal|0
condition|)
name|chip
operator|->
name|blk_state
index|[
name|bs
operator|->
name|block_num
index|]
operator|.
name|wear_lev
operator|=
name|bs
operator|->
name|wearout
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_get_block_state
parameter_list|(
name|struct
name|sim_block_state
modifier|*
name|bs
parameter_list|)
block|{
name|struct
name|onfi_params
modifier|*
name|params
decl_stmt|;
name|struct
name|nandsim_chip
modifier|*
name|chip
decl_stmt|;
name|int
name|blocks
decl_stmt|;
if|if
condition|(
name|bs
operator|->
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
operator|||
name|bs
operator|->
name|chip_num
operator|>=
name|MAX_CTRL_CS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"get block state for %d:%d block %d\n"
argument_list|,
name|bs
operator|->
name|chip_num
argument_list|,
name|bs
operator|->
name|ctrl_num
argument_list|,
name|bs
operator|->
name|block_num
argument_list|)
expr_stmt|;
name|chip
operator|=
name|get_nandsim_chip
argument_list|(
name|bs
operator|->
name|ctrl_num
argument_list|,
name|bs
operator|->
name|chip_num
argument_list|)
expr_stmt|;
name|params
operator|=
operator|&
name|chip
operator|->
name|params
expr_stmt|;
name|blocks
operator|=
name|params
operator|->
name|luns
operator|*
name|params
operator|->
name|blocks_per_lun
expr_stmt|;
if|if
condition|(
name|bs
operator|->
name|block_num
operator|>
name|blocks
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|bs
operator|->
name|state
operator|=
name|chip
operator|->
name|blk_state
index|[
name|bs
operator|->
name|block_num
index|]
operator|.
name|is_bad
expr_stmt|;
name|bs
operator|->
name|wearout
operator|=
name|chip
operator|->
name|blk_state
index|[
name|bs
operator|->
name|block_num
index|]
operator|.
name|wear_lev
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_dump
parameter_list|(
name|struct
name|sim_dump
modifier|*
name|dump
parameter_list|)
block|{
name|struct
name|nandsim_chip
modifier|*
name|chip
decl_stmt|;
name|struct
name|block_space
modifier|*
name|bs
decl_stmt|;
name|int
name|blk_size
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"dump chip %d %d\n"
argument_list|,
name|dump
operator|->
name|ctrl_num
argument_list|,
name|dump
operator|->
name|chip_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump
operator|->
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
operator|||
name|dump
operator|->
name|chip_num
operator|>=
name|MAX_CTRL_CS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|chip
operator|=
name|get_nandsim_chip
argument_list|(
name|dump
operator|->
name|ctrl_num
argument_list|,
name|dump
operator|->
name|chip_num
argument_list|)
expr_stmt|;
name|blk_size
operator|=
name|chip
operator|->
name|cg
operator|.
name|block_size
operator|+
operator|(
name|chip
operator|->
name|cg
operator|.
name|oob_size
operator|*
name|chip
operator|->
name|cg
operator|.
name|pgs_per_blk
operator|)
expr_stmt|;
name|bs
operator|=
name|get_bs
argument_list|(
name|chip
operator|->
name|swap
argument_list|,
name|dump
operator|->
name|block_num
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bs
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|dump
operator|->
name|len
operator|>
name|blk_size
condition|)
name|dump
operator|->
name|len
operator|=
name|blk_size
expr_stmt|;
name|copyout
argument_list|(
name|bs
operator|->
name|blk_ptr
argument_list|,
name|dump
operator|->
name|data
argument_list|,
name|dump
operator|->
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_restore
parameter_list|(
name|struct
name|sim_dump
modifier|*
name|dump
parameter_list|)
block|{
name|struct
name|nandsim_chip
modifier|*
name|chip
decl_stmt|;
name|struct
name|block_space
modifier|*
name|bs
decl_stmt|;
name|int
name|blk_size
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"restore chip %d %d\n"
argument_list|,
name|dump
operator|->
name|ctrl_num
argument_list|,
name|dump
operator|->
name|chip_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump
operator|->
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
operator|||
name|dump
operator|->
name|chip_num
operator|>=
name|MAX_CTRL_CS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|chip
operator|=
name|get_nandsim_chip
argument_list|(
name|dump
operator|->
name|ctrl_num
argument_list|,
name|dump
operator|->
name|chip_num
argument_list|)
expr_stmt|;
name|blk_size
operator|=
name|chip
operator|->
name|cg
operator|.
name|block_size
operator|+
operator|(
name|chip
operator|->
name|cg
operator|.
name|oob_size
operator|*
name|chip
operator|->
name|cg
operator|.
name|pgs_per_blk
operator|)
expr_stmt|;
name|bs
operator|=
name|get_bs
argument_list|(
name|chip
operator|->
name|swap
argument_list|,
name|dump
operator|->
name|block_num
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bs
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|dump
operator|->
name|len
operator|>
name|blk_size
condition|)
name|dump
operator|->
name|len
operator|=
name|blk_size
expr_stmt|;
name|copyin
argument_list|(
name|dump
operator|->
name|data
argument_list|,
name|bs
operator|->
name|blk_ptr
argument_list|,
name|dump
operator|->
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_freeze
parameter_list|(
name|struct
name|sim_ctrl_chip
modifier|*
name|ctrl_chip
parameter_list|)
block|{
name|struct
name|nandsim_chip
modifier|*
name|chip
decl_stmt|;
if|if
condition|(
name|ctrl_chip
operator|->
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
operator|||
name|ctrl_chip
operator|->
name|chip_num
operator|>=
name|MAX_CTRL_CS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|chip
operator|=
name|get_nandsim_chip
argument_list|(
name|ctrl_chip
operator|->
name|ctrl_num
argument_list|,
name|ctrl_chip
operator|->
name|chip_num
argument_list|)
expr_stmt|;
name|nandsim_chip_freeze
argument_list|(
name|chip
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_modify
parameter_list|(
name|struct
name|sim_mod
modifier|*
name|mod
parameter_list|)
block|{
name|struct
name|sim_chip
modifier|*
name|sim_conf
init|=
name|NULL
decl_stmt|;
name|struct
name|nandsim_chip
modifier|*
name|sim_chip
init|=
name|NULL
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_SIM
argument_list|,
literal|"modify ctlr %d chip %d"
argument_list|,
name|mod
operator|->
name|ctrl_num
argument_list|,
name|mod
operator|->
name|chip_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|mod
operator|->
name|field
operator|!=
name|SIM_MOD_LOG_LEVEL
condition|)
block|{
if|if
condition|(
name|mod
operator|->
name|ctrl_num
operator|>=
name|MAX_SIM_DEV
operator|||
name|mod
operator|->
name|chip_num
operator|>=
name|MAX_CTRL_CS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sim_conf
operator|=
name|ctrls
index|[
name|mod
operator|->
name|ctrl_num
index|]
operator|.
name|chips
index|[
name|mod
operator|->
name|chip_num
index|]
expr_stmt|;
name|sim_chip
operator|=
name|get_nandsim_chip
argument_list|(
name|mod
operator|->
name|ctrl_num
argument_list|,
name|mod
operator|->
name|chip_num
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|mod
operator|->
name|field
condition|)
block|{
case|case
name|SIM_MOD_LOG_LEVEL
case|:
name|nandsim_log_level
operator|=
name|mod
operator|->
name|new_value
expr_stmt|;
break|break;
case|case
name|SIM_MOD_ERASE_TIME
case|:
name|sim_conf
operator|->
name|erase_time
operator|=
name|sim_chip
operator|->
name|erase_delay
operator|=
name|mod
operator|->
name|new_value
expr_stmt|;
break|break;
case|case
name|SIM_MOD_PROG_TIME
case|:
name|sim_conf
operator|->
name|prog_time
operator|=
name|sim_chip
operator|->
name|prog_delay
operator|=
name|mod
operator|->
name|new_value
expr_stmt|;
break|break;
case|case
name|SIM_MOD_READ_TIME
case|:
name|sim_conf
operator|->
name|read_time
operator|=
name|sim_chip
operator|->
name|read_delay
operator|=
name|mod
operator|->
name|new_value
expr_stmt|;
break|break;
case|case
name|SIM_MOD_ERROR_RATIO
case|:
name|sim_conf
operator|->
name|error_ratio
operator|=
name|mod
operator|->
name|new_value
expr_stmt|;
name|sim_chip
operator|->
name|error_ratio
operator|=
name|mod
operator|->
name|new_value
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nandsim_modevent
parameter_list|(
name|module_t
name|mod
name|__unused
parameter_list|,
name|int
name|type
parameter_list|,
name|void
modifier|*
name|data
name|__unused
parameter_list|)
block|{
name|struct
name|sim_ctrl_chip
name|chip_ctrl
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MOD_LOAD
case|:
name|nandsim_dev
operator|=
name|make_dev
argument_list|(
operator|&
name|nandsim_cdevsw
argument_list|,
literal|0
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_WHEEL
argument_list|,
literal|0600
argument_list|,
literal|"nandsim.ioctl"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MOD_UNLOAD
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_SIM_DEV
condition|;
name|i
operator|++
control|)
block|{
name|nandsim_stop_ctrl
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|chip_ctrl
operator|.
name|ctrl_num
operator|=
name|i
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|MAX_CTRL_CS
condition|;
name|j
operator|++
control|)
block|{
name|chip_ctrl
operator|.
name|chip_num
operator|=
name|j
expr_stmt|;
name|nandsim_destroy_chip
argument_list|(
operator|&
name|chip_ctrl
argument_list|)
expr_stmt|;
block|}
name|nandsim_destroy_ctrl
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
name|destroy_dev
argument_list|(
name|nandsim_dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|MOD_SHUTDOWN
case|:
break|break;
default|default:
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|DEV_MODULE
argument_list|(
name|nandsim
argument_list|,
name|nandsim_modevent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|nandsim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|nandsim
argument_list|,
name|nand
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|nandsim
argument_list|,
name|alq
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2009-2012 Semihalf  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/* Generic NAND driver */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<dev/nand/nand.h>
end_include

begin_include
include|#
directive|include
file|<dev/nand/nandbus.h>
end_include

begin_include
include|#
directive|include
file|"nfc_if.h"
end_include

begin_include
include|#
directive|include
file|"nand_if.h"
end_include

begin_include
include|#
directive|include
file|"nandbus_if.h"
end_include

begin_function_decl
specifier|static
name|int
name|onfi_nand_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|large_nand_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|small_nand_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_nand_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_nand_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_erase_block
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_erase_block_intlv
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_read_page
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_read_oob
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_program_page
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_program_page_intlv
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_program_oob
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_is_blk_bad
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_get_ecc
parameter_list|(
name|device_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generic_correct_ecc
parameter_list|(
name|device_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|small_read_page
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|small_read_oob
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|small_program_page
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|small_program_oob
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|onfi_is_blk_bad
parameter_list|(
name|device_t
parameter_list|,
name|uint32_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|onfi_read_parameter
parameter_list|(
name|struct
name|nand_chip
modifier|*
parameter_list|,
name|struct
name|onfi_chip_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nand_send_address
parameter_list|(
name|device_t
parameter_list|,
name|int32_t
parameter_list|,
name|int32_t
parameter_list|,
name|int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|onand_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|onfi_nand_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|generic_nand_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|generic_nand_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_read_page
argument_list|,
name|generic_read_page
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_program_page
argument_list|,
name|generic_program_page
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_program_page_intlv
argument_list|,
name|generic_program_page_intlv
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_read_oob
argument_list|,
name|generic_read_oob
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_program_oob
argument_list|,
name|generic_program_oob
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_erase_block
argument_list|,
name|generic_erase_block
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_erase_block_intlv
argument_list|,
name|generic_erase_block_intlv
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_is_blk_bad
argument_list|,
name|onfi_is_blk_bad
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_get_ecc
argument_list|,
name|generic_get_ecc
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_correct_ecc
argument_list|,
name|generic_correct_ecc
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|lnand_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|large_nand_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|generic_nand_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|generic_nand_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_read_page
argument_list|,
name|generic_read_page
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_program_page
argument_list|,
name|generic_program_page
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_read_oob
argument_list|,
name|generic_read_oob
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_program_oob
argument_list|,
name|generic_program_oob
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_erase_block
argument_list|,
name|generic_erase_block
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_is_blk_bad
argument_list|,
name|generic_is_blk_bad
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_get_ecc
argument_list|,
name|generic_get_ecc
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_correct_ecc
argument_list|,
name|generic_correct_ecc
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|snand_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|small_nand_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|generic_nand_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|generic_nand_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_read_page
argument_list|,
name|small_read_page
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_program_page
argument_list|,
name|small_program_page
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_read_oob
argument_list|,
name|small_read_oob
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_program_oob
argument_list|,
name|small_program_oob
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_erase_block
argument_list|,
name|generic_erase_block
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_is_blk_bad
argument_list|,
name|generic_is_blk_bad
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_get_ecc
argument_list|,
name|generic_get_ecc
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|nand_correct_ecc
argument_list|,
name|generic_correct_ecc
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|devclass_t
name|onand_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|devclass_t
name|lnand_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|devclass_t
name|snand_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|driver_t
name|onand_driver
init|=
block|{
literal|"onand"
block|,
name|onand_methods
block|,
expr|sizeof
operator|(
expr|struct
name|nand_chip
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|driver_t
name|lnand_driver
init|=
block|{
literal|"lnand"
block|,
name|lnand_methods
block|,
expr|sizeof
operator|(
expr|struct
name|nand_chip
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|driver_t
name|snand_driver
init|=
block|{
literal|"snand"
block|,
name|snand_methods
block|,
expr|sizeof
operator|(
expr|struct
name|nand_chip
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|onand
argument_list|,
name|nandbus
argument_list|,
name|onand_driver
argument_list|,
name|onand_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|lnand
argument_list|,
name|nandbus
argument_list|,
name|lnand_driver
argument_list|,
name|lnand_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|snand
argument_list|,
name|nandbus
argument_list|,
name|snand_driver
argument_list|,
name|snand_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|onfi_nand_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nandbus_ivar
modifier|*
name|ivar
decl_stmt|;
name|ivar
operator|=
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ivar
operator|&&
name|ivar
operator|->
name|is_onfi
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"ONFI compliant NAND"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|large_nand_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nandbus_ivar
modifier|*
name|ivar
decl_stmt|;
name|ivar
operator|=
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ivar
operator|&&
operator|!
name|ivar
operator|->
name|is_onfi
operator|&&
name|ivar
operator|->
name|params
operator|->
name|page_size
operator|>=
literal|512
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|ivar
operator|->
name|params
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|small_nand_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nandbus_ivar
modifier|*
name|ivar
decl_stmt|;
name|ivar
operator|=
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ivar
operator|&&
operator|!
name|ivar
operator|->
name|is_onfi
operator|&&
name|ivar
operator|->
name|params
operator|->
name|page_size
operator|==
literal|512
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|ivar
operator|->
name|params
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_nand_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|struct
name|nandbus_ivar
modifier|*
name|ivar
decl_stmt|;
name|struct
name|onfi_chip_params
modifier|*
name|onfi_chip_params
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|,
name|nfc
decl_stmt|;
name|int
name|err
decl_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|chip
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|ivar
operator|=
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|chip
operator|->
name|id
operator|.
name|man_id
operator|=
name|ivar
operator|->
name|man_id
expr_stmt|;
name|chip
operator|->
name|id
operator|.
name|dev_id
operator|=
name|ivar
operator|->
name|dev_id
expr_stmt|;
name|chip
operator|->
name|num
operator|=
name|ivar
operator|->
name|cs
expr_stmt|;
comment|/* TODO remove when HW ECC supported */
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|nfc
operator|=
name|device_get_parent
argument_list|(
name|nandbus
argument_list|)
expr_stmt|;
name|chip
operator|->
name|nand
operator|=
name|device_get_softc
argument_list|(
name|nfc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ivar
operator|->
name|is_onfi
condition|)
block|{
name|onfi_chip_params
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|onfi_chip_params
argument_list|)
argument_list|,
name|M_NAND
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|onfi_chip_params
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
if|if
condition|(
name|onfi_read_parameter
argument_list|(
name|chip
argument_list|,
name|onfi_chip_params
argument_list|)
condition|)
block|{
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"Could not read parameter page!\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|onfi_chip_params
argument_list|,
name|M_NAND
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|nand_onfi_set_params
argument_list|(
name|chip
argument_list|,
name|onfi_chip_params
argument_list|)
expr_stmt|;
comment|/* Set proper column and row cycles */
name|ivar
operator|->
name|cols
operator|=
operator|(
name|onfi_chip_params
operator|->
name|address_cycles
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
name|ivar
operator|->
name|rows
operator|=
name|onfi_chip_params
operator|->
name|address_cycles
operator|&
literal|0xf
expr_stmt|;
name|free
argument_list|(
name|onfi_chip_params
argument_list|,
name|M_NAND
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nand_set_params
argument_list|(
name|chip
argument_list|,
name|ivar
operator|->
name|params
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|nand_init_stat
argument_list|(
name|chip
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|generic_nand_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|nand_init_bbt
argument_list|(
name|chip
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|generic_nand_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|nand_make_dev
argument_list|(
name|chip
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|generic_nand_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|create_geom_disk
argument_list|(
name|chip
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|generic_nand_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_nand_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|nand_destroy_bbt
argument_list|(
name|chip
argument_list|)
expr_stmt|;
name|destroy_geom_disk
argument_list|(
name|chip
argument_list|)
expr_stmt|;
name|nand_destroy_dev
argument_list|(
name|chip
argument_list|)
expr_stmt|;
name|nand_destroy_stat
argument_list|(
name|chip
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|can_write
parameter_list|(
name|device_t
name|nandbus
parameter_list|)
block|{
name|uint8_t
name|status
decl_stmt|;
if|if
condition|(
name|NANDBUS_WAIT_READY
argument_list|(
name|nandbus
argument_list|,
operator|&
name|status
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
operator|(
name|status
operator|&
name|NAND_STATUS_WP
operator|)
condition|)
block|{
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"Chip is write-protected"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_fail
parameter_list|(
name|device_t
name|nandbus
parameter_list|)
block|{
name|uint8_t
name|status
decl_stmt|;
name|NANDBUS_WAIT_READY
argument_list|(
name|nandbus
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|NAND_STATUS_FAIL
condition|)
block|{
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"Status failed %x"
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|onfi_crc
parameter_list|(
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|uint16_t
name|crc
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|bufptr
decl_stmt|;
name|bufptr
operator|=
name|buf
expr_stmt|;
name|crc
operator|=
literal|0x4f4e
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|buflen
condition|;
name|j
operator|++
control|)
block|{
name|crc
operator|^=
operator|*
name|bufptr
operator|++
operator|<<
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|crc
operator|&
literal|0x8000
condition|)
name|crc
operator|=
operator|(
name|crc
operator|<<
literal|1
operator|)
operator|^
literal|0x8005
expr_stmt|;
else|else
name|crc
operator|<<=
literal|1
expr_stmt|;
block|}
return|return
name|crc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|onfi_read_parameter
parameter_list|(
name|struct
name|nand_chip
modifier|*
name|chip
parameter_list|,
name|struct
name|onfi_chip_params
modifier|*
name|chip_params
parameter_list|)
block|{
name|device_t
name|nandbus
decl_stmt|;
name|struct
name|onfi_params
name|params
decl_stmt|;
name|int
name|found
decl_stmt|,
name|sigcount
decl_stmt|,
name|trycopy
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"read parameter"
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|chip
operator|->
name|dev
argument_list|)
expr_stmt|;
name|NANDBUS_SELECT_CS
argument_list|(
name|nandbus
argument_list|,
name|chip
operator|->
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_READ_PARAMETER
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|nand_send_address
argument_list|(
name|chip
operator|->
name|dev
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
name|PAGE_PARAMETER_DEF
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|NANDBUS_START_COMMAND
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* 	 * XXX Bogus DELAY, we really need a nandbus_wait_ready() here, but it's 	 * not accessible from here (static to nandbus). 	 */
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* 	 * The ONFI spec mandates a minimum of three copies of the parameter 	 * data, so loop up to 3 times trying to find good data.  Each copy is 	 * validated by a signature of "ONFI" and a crc. There is a very strange 	 * rule that the signature is valid if any 2 of the 4 bytes are correct. 	 */
for|for
control|(
name|found
operator|=
literal|0
operator|,
name|trycopy
operator|=
literal|0
init|;
operator|!
name|found
operator|&&
name|trycopy
operator|<
literal|3
condition|;
name|trycopy
operator|++
control|)
block|{
name|NANDBUS_READ_BUFFER
argument_list|(
name|nandbus
argument_list|,
operator|&
name|params
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|onfi_params
argument_list|)
argument_list|)
expr_stmt|;
name|sigcount
operator|=
name|params
operator|.
name|signature
index|[
literal|0
index|]
operator|==
literal|'O'
expr_stmt|;
name|sigcount
operator|+=
name|params
operator|.
name|signature
index|[
literal|1
index|]
operator|==
literal|'N'
expr_stmt|;
name|sigcount
operator|+=
name|params
operator|.
name|signature
index|[
literal|2
index|]
operator|==
literal|'F'
expr_stmt|;
name|sigcount
operator|+=
name|params
operator|.
name|signature
index|[
literal|3
index|]
operator|==
literal|'I'
expr_stmt|;
if|if
condition|(
name|sigcount
operator|<
literal|2
condition|)
continue|continue;
if|if
condition|(
name|onfi_crc
argument_list|(
operator|&
name|params
argument_list|,
literal|254
argument_list|)
operator|!=
name|params
operator|.
name|crc
condition|)
continue|continue;
name|found
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|chip_params
operator|->
name|luns
operator|=
name|params
operator|.
name|luns
expr_stmt|;
name|chip_params
operator|->
name|blocks_per_lun
operator|=
name|le32dec
argument_list|(
operator|&
name|params
operator|.
name|blocks_per_lun
argument_list|)
expr_stmt|;
name|chip_params
operator|->
name|pages_per_block
operator|=
name|le32dec
argument_list|(
operator|&
name|params
operator|.
name|pages_per_block
argument_list|)
expr_stmt|;
name|chip_params
operator|->
name|bytes_per_page
operator|=
name|le32dec
argument_list|(
operator|&
name|params
operator|.
name|bytes_per_page
argument_list|)
expr_stmt|;
name|chip_params
operator|->
name|spare_bytes_per_page
operator|=
name|le32dec
argument_list|(
operator|&
name|params
operator|.
name|spare_bytes_per_page
argument_list|)
expr_stmt|;
name|chip_params
operator|->
name|t_bers
operator|=
name|le16dec
argument_list|(
operator|&
name|params
operator|.
name|t_bers
argument_list|)
expr_stmt|;
name|chip_params
operator|->
name|t_prog
operator|=
name|le16dec
argument_list|(
operator|&
name|params
operator|.
name|t_prog
argument_list|)
expr_stmt|;
name|chip_params
operator|->
name|t_r
operator|=
name|le16dec
argument_list|(
operator|&
name|params
operator|.
name|t_r
argument_list|)
expr_stmt|;
name|chip_params
operator|->
name|t_ccs
operator|=
name|le16dec
argument_list|(
operator|&
name|params
operator|.
name|t_ccs
argument_list|)
expr_stmt|;
name|chip_params
operator|->
name|features
operator|=
name|le16dec
argument_list|(
operator|&
name|params
operator|.
name|features
argument_list|)
expr_stmt|;
name|chip_params
operator|->
name|address_cycles
operator|=
name|params
operator|.
name|address_cycles
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_read_page
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint8_t
name|start_command
parameter_list|,
name|uint8_t
name|end_command
parameter_list|,
name|uint32_t
name|row
parameter_list|,
name|uint32_t
name|column
parameter_list|)
block|{
name|device_t
name|nandbus
init|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
decl_stmt|;
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|start_command
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|nand_send_address
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
name|column
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|end_command
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|NANDBUS_START_COMMAND
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_read_page
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|page
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|struct
name|page_stat
modifier|*
name|pg_stat
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|uint32_t
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p raw read page %x[%x] at %x"
argument_list|,
name|nand
argument_list|,
name|page
argument_list|,
name|len
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|nand_check_page_boundary
argument_list|(
name|chip
argument_list|,
name|page
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|page_to_row
argument_list|(
operator|&
name|chip
operator|->
name|chip_geom
argument_list|,
name|page
argument_list|,
operator|&
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_read_page
argument_list|(
name|nand
argument_list|,
name|NAND_CMD_READ
argument_list|,
name|NAND_CMD_READ_END
argument_list|,
name|row
argument_list|,
name|offset
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|DELAY
argument_list|(
name|chip
operator|->
name|t_r
argument_list|)
expr_stmt|;
name|NANDBUS_READ_BUFFER
argument_list|(
name|nandbus
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|pg_stat
operator|=
operator|&
operator|(
name|chip
operator|->
name|pg_stat
index|[
name|page
index|]
operator|)
expr_stmt|;
name|pg_stat
operator|->
name|page_raw_read
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_read_oob
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|page
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|uint32_t
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p raw read oob %x[%x] at %x"
argument_list|,
name|nand
argument_list|,
name|page
argument_list|,
name|len
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|nand_check_page_boundary
argument_list|(
name|chip
argument_list|,
name|page
argument_list|)
condition|)
block|{
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"page boundary check failed: %08x\n"
argument_list|,
name|page
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|page_to_row
argument_list|(
operator|&
name|chip
operator|->
name|chip_geom
argument_list|,
name|page
argument_list|,
operator|&
name|row
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|chip
operator|->
name|chip_geom
operator|.
name|page_size
expr_stmt|;
if|if
condition|(
name|send_read_page
argument_list|(
name|nand
argument_list|,
name|NAND_CMD_READ
argument_list|,
name|NAND_CMD_READ_END
argument_list|,
name|row
argument_list|,
name|offset
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|DELAY
argument_list|(
name|chip
operator|->
name|t_r
argument_list|)
expr_stmt|;
name|NANDBUS_READ_BUFFER
argument_list|(
name|nandbus
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_start_program_page
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|row
parameter_list|,
name|uint32_t
name|column
parameter_list|)
block|{
name|device_t
name|nandbus
init|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
decl_stmt|;
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_PROG
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|nand_send_address
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
name|column
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_end_program_page
parameter_list|(
name|device_t
name|nandbus
parameter_list|,
name|uint8_t
name|end_command
parameter_list|)
block|{
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|end_command
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|NANDBUS_START_COMMAND
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_program_page
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|page
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|struct
name|page_stat
modifier|*
name|pg_stat
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|uint32_t
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p raw prog page %x[%x] at %x"
argument_list|,
name|nand
argument_list|,
name|page
argument_list|,
name|len
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|nand_check_page_boundary
argument_list|(
name|chip
argument_list|,
name|page
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|page_to_row
argument_list|(
operator|&
name|chip
operator|->
name|chip_geom
argument_list|,
name|page
argument_list|,
operator|&
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|can_write
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|send_start_program_page
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
name|offset
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|NANDBUS_WRITE_BUFFER
argument_list|(
name|nandbus
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_end_program_page
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_PROG_END
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|DELAY
argument_list|(
name|chip
operator|->
name|t_prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|pg_stat
operator|=
operator|&
operator|(
name|chip
operator|->
name|pg_stat
index|[
name|page
index|]
operator|)
expr_stmt|;
name|pg_stat
operator|->
name|page_raw_written
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_program_page_intlv
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|page
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|struct
name|page_stat
modifier|*
name|pg_stat
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|uint32_t
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p raw prog page %x[%x] at %x"
argument_list|,
name|nand
argument_list|,
name|page
argument_list|,
name|len
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|nand_check_page_boundary
argument_list|(
name|chip
argument_list|,
name|page
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|page_to_row
argument_list|(
operator|&
name|chip
operator|->
name|chip_geom
argument_list|,
name|page
argument_list|,
operator|&
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|can_write
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|send_start_program_page
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
name|offset
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|NANDBUS_WRITE_BUFFER
argument_list|(
name|nandbus
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_end_program_page
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_PROG_INTLV
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|DELAY
argument_list|(
name|chip
operator|->
name|t_prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|pg_stat
operator|=
operator|&
operator|(
name|chip
operator|->
name|pg_stat
index|[
name|page
index|]
operator|)
expr_stmt|;
name|pg_stat
operator|->
name|page_raw_written
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_program_oob
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|page
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|uint32_t
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p raw prog oob %x[%x] at %x"
argument_list|,
name|nand
argument_list|,
name|page
argument_list|,
name|len
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|nand_check_page_boundary
argument_list|(
name|chip
argument_list|,
name|page
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|page_to_row
argument_list|(
operator|&
name|chip
operator|->
name|chip_geom
argument_list|,
name|page
argument_list|,
operator|&
name|row
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|chip
operator|->
name|chip_geom
operator|.
name|page_size
expr_stmt|;
if|if
condition|(
operator|!
name|can_write
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|send_start_program_page
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
name|offset
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|NANDBUS_WRITE_BUFFER
argument_list|(
name|nandbus
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_end_program_page
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_PROG_END
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|DELAY
argument_list|(
name|chip
operator|->
name|t_prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_erase_block
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|row
parameter_list|,
name|uint8_t
name|second_command
parameter_list|)
block|{
name|device_t
name|nandbus
init|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
decl_stmt|;
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_ERASE
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|nand_send_address
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|second_command
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|NANDBUS_START_COMMAND
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_erase_block
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|block
parameter_list|)
block|{
name|struct
name|block_stat
modifier|*
name|blk_stat
decl_stmt|;
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|int
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p erase block  %x"
argument_list|,
name|nand
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|block
operator|>=
operator|(
name|chip
operator|->
name|chip_geom
operator|.
name|blks_per_lun
operator|*
name|chip
operator|->
name|chip_geom
operator|.
name|luns
operator|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|row
operator|=
operator|(
name|block
operator|<<
name|chip
operator|->
name|chip_geom
operator|.
name|blk_shift
operator|)
operator|&
name|chip
operator|->
name|chip_geom
operator|.
name|blk_mask
expr_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p erase block  row %x"
argument_list|,
name|nand
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|can_write
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|send_erase_block
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
name|NAND_CMD_ERASE_END
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|chip
operator|->
name|t_bers
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|blk_stat
operator|=
operator|&
operator|(
name|chip
operator|->
name|blk_stat
index|[
name|block
index|]
operator|)
expr_stmt|;
name|blk_stat
operator|->
name|block_erased
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_erase_block_intlv
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|block
parameter_list|)
block|{
name|struct
name|block_stat
modifier|*
name|blk_stat
decl_stmt|;
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|int
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p erase block  %x"
argument_list|,
name|nand
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|block
operator|>=
operator|(
name|chip
operator|->
name|chip_geom
operator|.
name|blks_per_lun
operator|*
name|chip
operator|->
name|chip_geom
operator|.
name|luns
operator|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|row
operator|=
operator|(
name|block
operator|<<
name|chip
operator|->
name|chip_geom
operator|.
name|blk_shift
operator|)
operator|&
name|chip
operator|->
name|chip_geom
operator|.
name|blk_mask
expr_stmt|;
if|if
condition|(
operator|!
name|can_write
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|send_erase_block
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
name|NAND_CMD_ERASE_INTLV
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|chip
operator|->
name|t_bers
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|blk_stat
operator|=
operator|&
operator|(
name|chip
operator|->
name|blk_stat
index|[
name|block
index|]
operator|)
expr_stmt|;
name|blk_stat
operator|->
name|block_erased
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|onfi_is_blk_bad
parameter_list|(
name|device_t
name|device
parameter_list|,
name|uint32_t
name|block_number
parameter_list|,
name|uint8_t
modifier|*
name|bad
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|int
name|page_number
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|err
decl_stmt|;
name|uint8_t
modifier|*
name|oob
decl_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|device
argument_list|)
expr_stmt|;
name|oob
operator|=
name|malloc
argument_list|(
name|chip
operator|->
name|chip_geom
operator|.
name|oob_size
argument_list|,
name|M_NAND
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oob
condition|)
block|{
name|device_printf
argument_list|(
name|device
argument_list|,
literal|"%s: cannot allocate oob\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|page_number
operator|=
name|block_number
operator|*
name|chip
operator|->
name|chip_geom
operator|.
name|pgs_per_blk
expr_stmt|;
operator|*
name|bad
operator|=
literal|0
expr_stmt|;
comment|/* Check OOB of first and last page */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
operator|,
name|page_number
operator|+=
name|chip
operator|->
name|chip_geom
operator|.
name|pgs_per_blk
operator|-
literal|1
control|)
block|{
name|err
operator|=
name|generic_read_oob
argument_list|(
name|device
argument_list|,
name|page_number
argument_list|,
name|oob
argument_list|,
name|chip
operator|->
name|chip_geom
operator|.
name|oob_size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|device
argument_list|,
literal|"%s: cannot allocate oob\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|oob
argument_list|,
name|M_NAND
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|chip
operator|->
name|chip_geom
operator|.
name|oob_size
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|oob
index|[
name|j
index|]
condition|)
block|{
operator|*
name|bad
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|oob
argument_list|,
name|M_NAND
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
name|free
argument_list|(
name|oob
argument_list|,
name|M_NAND
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_small_read_page
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint8_t
name|start_command
parameter_list|,
name|uint32_t
name|row
parameter_list|,
name|uint32_t
name|column
parameter_list|)
block|{
name|device_t
name|nandbus
init|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
decl_stmt|;
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|start_command
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|nand_send_address
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
name|column
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|NANDBUS_START_COMMAND
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|small_read_page
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|page
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|struct
name|page_stat
modifier|*
name|pg_stat
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|uint32_t
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p small read page %x[%x] at %x"
argument_list|,
name|nand
argument_list|,
name|page
argument_list|,
name|len
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|nand_check_page_boundary
argument_list|(
name|chip
argument_list|,
name|page
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|page_to_row
argument_list|(
operator|&
name|chip
operator|->
name|chip_geom
argument_list|,
name|page
argument_list|,
operator|&
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|<
literal|256
condition|)
block|{
if|if
condition|(
name|send_small_read_page
argument_list|(
name|nand
argument_list|,
name|NAND_CMD_SMALLA
argument_list|,
name|row
argument_list|,
name|offset
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
else|else
block|{
name|offset
operator|-=
literal|256
expr_stmt|;
if|if
condition|(
name|send_small_read_page
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_SMALLB
argument_list|,
name|row
argument_list|,
name|offset
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|DELAY
argument_list|(
name|chip
operator|->
name|t_r
argument_list|)
expr_stmt|;
name|NANDBUS_READ_BUFFER
argument_list|(
name|nandbus
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|pg_stat
operator|=
operator|&
operator|(
name|chip
operator|->
name|pg_stat
index|[
name|page
index|]
operator|)
expr_stmt|;
name|pg_stat
operator|->
name|page_raw_read
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|small_read_oob
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|page
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|struct
name|page_stat
modifier|*
name|pg_stat
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|uint32_t
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p small read oob %x[%x] at %x"
argument_list|,
name|nand
argument_list|,
name|page
argument_list|,
name|len
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|nand_check_page_boundary
argument_list|(
name|chip
argument_list|,
name|page
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|page_to_row
argument_list|(
operator|&
name|chip
operator|->
name|chip_geom
argument_list|,
name|page
argument_list|,
operator|&
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_small_read_page
argument_list|(
name|nand
argument_list|,
name|NAND_CMD_SMALLOOB
argument_list|,
name|row
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|DELAY
argument_list|(
name|chip
operator|->
name|t_r
argument_list|)
expr_stmt|;
name|NANDBUS_READ_BUFFER
argument_list|(
name|nandbus
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|pg_stat
operator|=
operator|&
operator|(
name|chip
operator|->
name|pg_stat
index|[
name|page
index|]
operator|)
expr_stmt|;
name|pg_stat
operator|->
name|page_raw_read
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|small_program_page
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|page
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|uint32_t
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p small prog page %x[%x] at %x"
argument_list|,
name|nand
argument_list|,
name|page
argument_list|,
name|len
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|nand_check_page_boundary
argument_list|(
name|chip
argument_list|,
name|page
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|page_to_row
argument_list|(
operator|&
name|chip
operator|->
name|chip_geom
argument_list|,
name|page
argument_list|,
operator|&
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|can_write
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|offset
operator|<
literal|256
condition|)
block|{
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_SMALLA
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_SMALLB
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|send_start_program_page
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
name|offset
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|NANDBUS_WRITE_BUFFER
argument_list|(
name|nandbus
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_end_program_page
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_PROG_END
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|DELAY
argument_list|(
name|chip
operator|->
name|t_prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|small_program_oob
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|uint32_t
name|page
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|uint32_t
name|row
decl_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"%p small prog oob %x[%x] at %x"
argument_list|,
name|nand
argument_list|,
name|page
argument_list|,
name|len
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|nand_check_page_boundary
argument_list|(
name|chip
argument_list|,
name|page
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|page_to_row
argument_list|(
operator|&
name|chip
operator|->
name|chip_geom
argument_list|,
name|page
argument_list|,
operator|&
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|can_write
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|NANDBUS_SEND_COMMAND
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_SMALLOOB
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|send_start_program_page
argument_list|(
name|nand
argument_list|,
name|row
argument_list|,
name|offset
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|NANDBUS_WRITE_BUFFER
argument_list|(
name|nandbus
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_end_program_page
argument_list|(
name|nandbus
argument_list|,
name|NAND_CMD_PROG_END
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|DELAY
argument_list|(
name|chip
operator|->
name|t_prog
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_fail
argument_list|(
name|nandbus
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nand_send_address
parameter_list|(
name|device_t
name|nand
parameter_list|,
name|int32_t
name|row
parameter_list|,
name|int32_t
name|col
parameter_list|,
name|int8_t
name|id
parameter_list|)
block|{
name|struct
name|nandbus_ivar
modifier|*
name|ivar
decl_stmt|;
name|device_t
name|nandbus
decl_stmt|;
name|uint8_t
name|addr
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|nandbus
operator|=
name|device_get_parent
argument_list|(
name|nand
argument_list|)
expr_stmt|;
name|ivar
operator|=
name|device_get_ivars
argument_list|(
name|nand
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|!=
operator|-
literal|1
condition|)
block|{
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"send_address: send id %02x"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|err
operator|=
name|NANDBUS_SEND_ADDRESS
argument_list|(
name|nandbus
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|err
operator|&&
name|col
operator|!=
operator|-
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ivar
operator|->
name|cols
condition|;
name|i
operator|++
operator|,
name|col
operator|>>=
literal|8
control|)
block|{
name|addr
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|col
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"send_address: send address column "
literal|"%02x"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|err
operator|=
name|NANDBUS_SEND_ADDRESS
argument_list|(
name|nandbus
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|err
operator|&&
name|row
operator|!=
operator|-
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ivar
operator|->
name|rows
condition|;
name|i
operator|++
operator|,
name|row
operator|>>=
literal|8
control|)
block|{
name|addr
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|row
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|nand_debug
argument_list|(
name|NDBG_GEN
argument_list|,
literal|"send_address: send address row "
literal|"%02x"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|err
operator|=
name|NANDBUS_SEND_ADDRESS
argument_list|(
name|nandbus
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
block|}
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_is_blk_bad
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint32_t
name|block
parameter_list|,
name|uint8_t
modifier|*
name|bad
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
decl_stmt|;
name|int
name|page_number
decl_stmt|,
name|err
decl_stmt|,
name|i
decl_stmt|;
name|uint8_t
modifier|*
name|oob
decl_stmt|;
name|chip
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|oob
operator|=
name|malloc
argument_list|(
name|chip
operator|->
name|chip_geom
operator|.
name|oob_size
argument_list|,
name|M_NAND
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oob
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: cannot allocate OOB\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|page_number
operator|=
name|block
operator|*
name|chip
operator|->
name|chip_geom
operator|.
name|pgs_per_blk
expr_stmt|;
operator|*
name|bad
operator|=
literal|0
expr_stmt|;
comment|/* Check OOB of first and second page */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|NAND_READ_OOB
argument_list|(
name|dev
argument_list|,
name|page_number
operator|+
name|i
argument_list|,
name|oob
argument_list|,
name|chip
operator|->
name|chip_geom
operator|.
name|oob_size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: cannot allocate OOB\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|oob
argument_list|,
name|M_NAND
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|oob
index|[
literal|0
index|]
condition|)
block|{
operator|*
name|bad
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|oob
argument_list|,
name|M_NAND
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|free
argument_list|(
name|oob
argument_list|,
name|M_NAND
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_get_ecc
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|void
modifier|*
name|ecc
parameter_list|,
name|int
modifier|*
name|needwrite
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|chip_geom
modifier|*
name|cg
init|=
operator|&
name|chip
operator|->
name|chip_geom
decl_stmt|;
return|return
operator|(
name|NANDBUS_GET_ECC
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|buf
argument_list|,
name|cg
operator|->
name|page_size
argument_list|,
name|ecc
argument_list|,
name|needwrite
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|generic_correct_ecc
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|void
modifier|*
name|readecc
parameter_list|,
name|void
modifier|*
name|calcecc
parameter_list|)
block|{
name|struct
name|nand_chip
modifier|*
name|chip
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|chip_geom
modifier|*
name|cg
init|=
operator|&
name|chip
operator|->
name|chip_geom
decl_stmt|;
return|return
operator|(
name|NANDBUS_CORRECT_ECC
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|buf
argument_list|,
name|cg
operator|->
name|page_size
argument_list|,
name|readecc
argument_list|,
name|calcecc
argument_list|)
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|int nand_chng_read_col(device_t nand, uint32_t col, void *buf, size_t len) { 	struct nand_chip *chip; 	device_t nandbus;  	chip = device_get_softc(nand); 	nandbus = device_get_parent(nand);  	if (NANDBUS_SEND_COMMAND(nandbus, NAND_CMD_CHNG_READ_COL)) 		return (ENXIO);  	if (NANDBUS_SEND_ADDRESS(nandbus, -1, col, -1)) 		return (ENXIO);  	if (NANDBUS_SEND_COMMAND(nandbus, NAND_CMD_CHNG_READ_COL_END)) 		return (ENXIO);  	if (NANDBUS_START_COMMAND(nandbus)) 		return (ENXIO);  	if (buf != NULL&& len> 0) 		NANDBUS_READ_BUFFER(nandbus, buf, len);  	return (0); }  int nand_chng_write_col(device_t dev, uint32_t col, void *buf,     size_t len) { 	struct nand_chip *chip; 	device_t nandbus;  	chip = device_get_softc(dev); 	nandbus = device_get_parent(dev);  	if (NANDBUS_SEND_COMMAND(nandbus, NAND_CMD_CHNG_WRITE_COL)) 		return (ENXIO);  	if (NANDBUS_SEND_ADDRESS(nandbus, -1, col, -1)) 		return (ENXIO);  	if (buf != NULL&& len> 0) 		NANDBUS_WRITE_BUFFER(nandbus, buf, len);  	if (NANDBUS_SEND_COMMAND(nandbus, NAND_CMD_CHNG_READ_COL_END)) 		return (ENXIO);  	if (NANDBUS_START_COMMAND(nandbus)) 		return (ENXIO);  	return (0); }  int nand_copyback_read(device_t dev, uint32_t page, uint32_t col,     void *buf, size_t len) { 	struct nand_chip *chip; 	struct page_stat *pg_stat; 	device_t nandbus; 	uint32_t row;  	nand_debug(NDBG_GEN," raw read page %x[%x] at %x", page, col, len); 	chip = device_get_softc(dev); 	nandbus = device_get_parent(dev);  	if (nand_check_page_boundary(chip, page)) 		return (ENXIO);  	page_to_row(&chip->chip_geom, page,&row);  	if (send_read_page(nand, NAND_CMD_READ, NAND_CMD_READ_CPBK, row, 0)) 		return (ENXIO);  	DELAY(chip->t_r); 	if (check_fail(nandbus)) 		return (ENXIO);  	if (buf != NULL&& len> 0) 		NANDBUS_READ_BUFFER(nandbus, buf, len);  	pg_stat =&(chip->pg_stat[page]); 	pg_stat->page_raw_read++;  	return (0); }  int nand_copyback_prog(device_t dev, uint32_t page, uint32_t col,     void *buf, size_t len) { 	struct nand_chip *chip; 	struct page_stat *pg_stat; 	device_t nandbus; 	uint32_t row;  	nand_debug(NDBG_GEN,"copyback prog page %x[%x]",  page, len); 	chip = device_get_softc(dev); 	nandbus = device_get_parent(dev);  	if (nand_check_page_boundary(chip, page)) 		return (ENXIO);  	page_to_row(&chip->chip_geom, page,&row);  	if (!can_write(nandbus)) 		return (ENXIO);  	if (NANDBUS_SEND_COMMAND(nandbus, NAND_CMD_CHNG_WRITE_COL)) 		return (ENXIO);  	if (NANDBUS_SEND_ADDRESS(nandbus, row, col, -1)) 		return (ENXIO);  	if (buf != NULL&& len> 0) 		NANDBUS_WRITE_BUFFER(nandbus, buf, len);  	if (send_end_program_page(nandbus, NAND_CMD_PROG_END)) 		return (ENXIO);  	DELAY(chip->t_prog);  	if (check_fail(nandbus)) 		return (ENXIO);  	pg_stat =&(chip->pg_stat[page]); 	pg_stat->page_raw_written++;  	return (0); }  int nand_copyback_prog_intlv(device_t dev, uint32_t page) { 	struct nand_chip *chip; 	struct page_stat *pg_stat; 	device_t nandbus; 	uint32_t row;  	nand_debug(NDBG_GEN,"cache prog page %x", page); 	chip = device_get_softc(dev); 	nandbus = device_get_parent(dev);  	if (nand_check_page_boundary(chip, page)) 		return (ENXIO);  	page_to_row(&chip->chip_geom, page,&row);  	if (!can_write(nandbus)) 		return (ENXIO);  	if (send_start_program_page(nand, row, 0)) 		return (ENXIO);  	if (send_end_program_page(nandbus, NAND_CMD_PROG_INTLV)) 		return (ENXIO);  	DELAY(chip->t_prog);  	if (check_fail(nandbus)) 		return (ENXIO);  	pg_stat =&(chip->pg_stat[page]); 	pg_stat->page_raw_written++;  	return (0); }  int nand_prog_cache(device_t dev, uint32_t page, uint32_t col,     void *buf, size_t len, uint8_t end) { 	struct nand_chip *chip; 	struct page_stat *pg_stat; 	device_t nandbus; 	uint32_t row; 	uint8_t command;  	nand_debug(NDBG_GEN,"cache prog page %x[%x]",  page, len); 	chip = device_get_softc(dev); 	nandbus = device_get_parent(dev);  	if (nand_check_page_boundary(chip, page)) 		return (ENXIO);  	page_to_row(&chip->chip_geom, page,&row);  	if (!can_write(nandbus)) 		return (ENXIO);  	if (send_start_program_page(dev, row, 0)) 		return (ENXIO);  	NANDBUS_WRITE_BUFFER(nandbus, buf, len);  	if (end) 		command = NAND_CMD_PROG_END; 	else 		command = NAND_CMD_PROG_CACHE;  	if (send_end_program_page(nandbus, command)) 		return (ENXIO);  	DELAY(chip->t_prog);  	if (check_fail(nandbus)) 		return (ENXIO);  	pg_stat =&(chip->pg_stat[page]); 	pg_stat->page_raw_written++;  	return (0); }  int nand_read_cache(device_t dev, uint32_t page, uint32_t col,     void *buf, size_t len, uint8_t end) { 	struct nand_chip *chip; 	struct page_stat *pg_stat; 	device_t nandbus; 	uint32_t row; 	uint8_t command;  	nand_debug(NDBG_GEN,"cache read page %x[%x] ", page, len); 	chip = device_get_softc(dev); 	nandbus = device_get_parent(dev);  	if (nand_check_page_boundary(chip, page)) 		return (ENXIO);  	page_to_row(&chip->chip_geom, page,&row);  	if (page != -1) { 		if (NANDBUS_SEND_COMMAND(nandbus, NAND_CMD_READ)) 			return (ENXIO);  		if (NANDBUS_SEND_ADDRESS(nandbus, row, col, -1)) 			return (ENXIO); 	}  	if (end) 		command = NAND_CMD_READ_CACHE_END; 	else 		command = NAND_CMD_READ_CACHE;  	if (NANDBUS_SEND_COMMAND(nandbus, command)) 		return (ENXIO);  	if (NANDBUS_START_COMMAND(nandbus)) 		return (ENXIO);  	DELAY(chip->t_r); 	if (check_fail(nandbus)) 		return (ENXIO);  	if (buf != NULL&& len> 0) 		NANDBUS_READ_BUFFER(nandbus, buf, len);  	pg_stat =&(chip->pg_stat[page]); 	pg_stat->page_raw_read++;  	return (0); }  int nand_get_feature(device_t dev, uint8_t feat, void *buf) { 	struct nand_chip *chip; 	device_t nandbus;  	nand_debug(NDBG_GEN,"nand get feature");  	chip = device_get_softc(dev); 	nandbus = device_get_parent(dev);  	if (NANDBUS_SEND_COMMAND(nandbus, NAND_CMD_GET_FEATURE)) 		return (ENXIO);  	if (NANDBUS_SEND_ADDRESS(nandbus, -1, -1, feat)) 		return (ENXIO);  	if (NANDBUS_START_COMMAND(nandbus)) 		return (ENXIO);  	DELAY(chip->t_r); 	NANDBUS_READ_BUFFER(nandbus, buf, 4);  	return (0); }  int nand_set_feature(device_t dev, uint8_t feat, void *buf) { 	struct nand_chip *chip; 	device_t nandbus;  	nand_debug(NDBG_GEN,"nand set feature");  	chip = device_get_softc(dev); 	nandbus = device_get_parent(dev);  	if (NANDBUS_SEND_COMMAND(nandbus, NAND_CMD_SET_FEATURE)) 		return (ENXIO);  	if (NANDBUS_SEND_ADDRESS(nandbus, -1, -1, feat)) 		return (ENXIO);  	NANDBUS_WRITE_BUFFER(nandbus, buf, 4);  	if (NANDBUS_START_COMMAND(nandbus)) 		return (ENXIO);  	return (0); }
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2011-2013 Qlogic Corporation  * All rights reserved.  *  *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  *  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  *  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  *  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  *  POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * File: qla_os.c  * Author : David C Somayajulu, Qlogic Corporation, Aliso Viejo, CA 92656.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"qla_os.h"
end_include

begin_include
include|#
directive|include
file|"qla_reg.h"
end_include

begin_include
include|#
directive|include
file|"qla_hw.h"
end_include

begin_include
include|#
directive|include
file|"qla_def.h"
end_include

begin_include
include|#
directive|include
file|"qla_inline.h"
end_include

begin_include
include|#
directive|include
file|"qla_ver.h"
end_include

begin_include
include|#
directive|include
file|"qla_glbl.h"
end_include

begin_include
include|#
directive|include
file|"qla_dbg.h"
end_include

begin_comment
comment|/*  * Some PCI Configuration Space Related Defines  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_VENDOR_QLOGIC
end_ifndef

begin_define
define|#
directive|define
name|PCI_VENDOR_QLOGIC
value|0x1077
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_PRODUCT_QLOGIC_ISP8020
end_ifndef

begin_define
define|#
directive|define
name|PCI_PRODUCT_QLOGIC_ISP8020
value|0x8020
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|PCI_QLOGIC_ISP8020
define|\
value|((PCI_PRODUCT_QLOGIC_ISP8020<< 16) | PCI_VENDOR_QLOGIC)
end_define

begin_comment
comment|/*  * static functions  */
end_comment

begin_function_decl
specifier|static
name|int
name|qla_alloc_parent_dma_tag
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_free_parent_dma_tag
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_alloc_xmt_bufs
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_free_xmt_bufs
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_alloc_rcv_bufs
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_free_rcv_bufs
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_init_ifnet
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_sysctl_get_stats
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_release
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_dmamap_callback
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_stop
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_send
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m_headp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_tx_done
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Hooks to the Operating Systems  */
end_comment

begin_function_decl
specifier|static
name|int
name|qla_pci_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_pci_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_pci_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|qla_pci_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|qla_pci_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|qla_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|qla_pci_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|qla_pci_driver
init|=
block|{
literal|"ql"
block|,
name|qla_pci_methods
block|,
sizeof|sizeof
argument_list|(
name|qla_host_t
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|qla80xx_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|qla80xx
argument_list|,
name|pci
argument_list|,
name|qla_pci_driver
argument_list|,
name|qla80xx_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|qla80xx
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|qla80xx
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_QLA8XXXBUF
argument_list|,
literal|"qla80xxbuf"
argument_list|,
literal|"Buffers for qla80xx driver"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|uint32_t
name|std_replenish
init|=
literal|8
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|jumbo_replenish
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|rcv_pkt_thres
init|=
literal|128
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|rcv_pkt_thres_d
init|=
literal|32
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|snd_pkt_thres
init|=
literal|16
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|free_pkt_thres
init|=
operator|(
name|NUM_TX_DESCRIPTORS
operator|/
literal|2
operator|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|dev_str
index|[
literal|64
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Name:	qla_pci_probe  * Function:	Validate the PCI device to be a QLA80XX device  */
end_comment

begin_function
specifier|static
name|int
name|qla_pci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
switch|switch
condition|(
operator|(
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|)
condition|)
block|{
case|case
name|PCI_QLOGIC_ISP8020
case|:
name|snprintf
argument_list|(
name|dev_str
argument_list|,
sizeof|sizeof
argument_list|(
name|dev_str
argument_list|)
argument_list|,
literal|"%s v%d.%d.%d"
argument_list|,
literal|"Qlogic ISP 80xx PCI CNA Adapter-Ethernet Function"
argument_list|,
name|QLA_VERSION_MAJOR
argument_list|,
name|QLA_VERSION_MINOR
argument_list|,
name|QLA_VERSION_BUILD
argument_list|)
expr_stmt|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|dev_str
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"%s: %s\n "
argument_list|,
name|__func__
argument_list|,
name|dev_str
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_add_sysctls
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"stats"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
argument_list|,
literal|0
argument_list|,
name|qla_sysctl_get_stats
argument_list|,
literal|"I"
argument_list|,
literal|"Statistics"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"fw_version"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|ha
operator|->
name|fw_ver_str
argument_list|,
literal|0
argument_list|,
literal|"firmware version"
argument_list|)
expr_stmt|;
name|dbg_level
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"debug"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|dbg_level
argument_list|,
name|dbg_level
argument_list|,
literal|"Debug Level"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"std_replenish"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|std_replenish
argument_list|,
name|std_replenish
argument_list|,
literal|"Threshold for Replenishing Standard Frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"jumbo_replenish"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|jumbo_replenish
argument_list|,
name|jumbo_replenish
argument_list|,
literal|"Threshold for Replenishing Jumbo Frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rcv_pkt_thres"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|rcv_pkt_thres
argument_list|,
name|rcv_pkt_thres
argument_list|,
literal|"Threshold for # of rcv pkts to trigger indication isr"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rcv_pkt_thres_d"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|rcv_pkt_thres_d
argument_list|,
name|rcv_pkt_thres_d
argument_list|,
literal|"Threshold for # of rcv pkts to trigger indication defered"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"snd_pkt_thres"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|snd_pkt_thres
argument_list|,
name|snd_pkt_thres
argument_list|,
literal|"Threshold for # of snd packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"free_pkt_thres"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|free_pkt_thres
argument_list|,
name|free_pkt_thres
argument_list|,
literal|"Threshold for # of packets to free at a time"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_watchdog
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|qla_host_t
modifier|*
name|ha
init|=
name|arg
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|hw
operator|=
operator|&
name|ha
operator|->
name|hw
expr_stmt|;
name|ifp
operator|=
name|ha
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|qla_watchdog_exit
condition|)
return|return;
if|if
condition|(
operator|!
name|ha
operator|->
name|flags
operator|.
name|qla_watchdog_pause
condition|)
block|{
if|if
condition|(
name|qla_le32_to_host
argument_list|(
operator|*
operator|(
name|hw
operator|->
name|tx_cons
operator|)
argument_list|)
operator|!=
name|hw
operator|->
name|txr_comp
condition|)
block|{
name|taskqueue_enqueue
argument_list|(
name|ha
operator|->
name|tx_tq
argument_list|,
operator|&
name|ha
operator|->
name|tx_task
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_head
operator|!=
name|NULL
operator|)
operator|&&
name|QL_RUNNING
argument_list|(
name|ifp
argument_list|)
condition|)
block|{
name|taskqueue_enqueue
argument_list|(
name|ha
operator|->
name|tx_tq
argument_list|,
operator|&
name|ha
operator|->
name|tx_task
argument_list|)
expr_stmt|;
block|}
block|}
name|ha
operator|->
name|watchdog_ticks
operator|=
name|ha
operator|->
name|watchdog_ticks
operator|++
operator|%
literal|1000
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|ha
operator|->
name|tx_callout
argument_list|,
name|QLA_WATCHDOG_CALLOUT_TICKS
argument_list|,
name|qla_watchdog
argument_list|,
name|ha
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name:	qla_pci_attach  * Function:	attaches the device to the operating system  */
end_comment

begin_function
specifier|static
name|int
name|qla_pci_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|qla_host_t
modifier|*
name|ha
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|rsrc_len
decl_stmt|,
name|i
decl_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ha
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot get softc\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|memset
argument_list|(
name|ha
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_host_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|!=
name|PCI_PRODUCT_QLOGIC_ISP8020
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"device is not ISP8020\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|ha
operator|->
name|pci_func
operator|=
name|pci_get_function
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ha
operator|->
name|pci_dev
operator|=
name|dev
expr_stmt|;
name|pci_enable_busmaster
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ha
operator|->
name|reg_rid
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ha
operator|->
name|pci_reg
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|ha
operator|->
name|reg_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|pci_reg
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map any ports\n"
argument_list|)
expr_stmt|;
goto|goto
name|qla_pci_attach_err
goto|;
block|}
name|rsrc_len
operator|=
operator|(
name|uint32_t
operator|)
name|bus_get_resource_count
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ha
operator|->
name|reg_rid
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|ha
operator|->
name|hw_lock
argument_list|,
literal|"qla80xx_hw_lock"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|ha
operator|->
name|tx_lock
argument_list|,
literal|"qla80xx_tx_lock"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|ha
operator|->
name|rx_lock
argument_list|,
literal|"qla80xx_rx_lock"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|ha
operator|->
name|rxj_lock
argument_list|,
literal|"qla80xx_rxj_lock"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|lock_init
operator|=
literal|1
expr_stmt|;
name|ha
operator|->
name|msix_count
operator|=
name|pci_msix_count
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|msix_count
operator|<
name|qla_get_msix_count
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: msix_count[%d] not enough\n"
argument_list|,
name|__func__
argument_list|,
name|ha
operator|->
name|msix_count
argument_list|)
expr_stmt|;
goto|goto
name|qla_pci_attach_err
goto|;
block|}
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: ha %p irq %p pci_func 0x%x rsrc_count 0x%08x"
literal|" msix_count 0x%x pci_reg %p\n"
operator|,
name|__func__
operator|,
name|ha
operator|,
name|ha
operator|->
name|irq
operator|,
name|ha
operator|->
name|pci_func
operator|,
name|rsrc_len
operator|,
name|ha
operator|->
name|msix_count
operator|,
name|ha
operator|->
name|pci_reg
operator|)
argument_list|)
expr_stmt|;
name|ha
operator|->
name|msix_count
operator|=
name|qla_get_msix_count
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_alloc_msix
argument_list|(
name|dev
argument_list|,
operator|&
name|ha
operator|->
name|msix_count
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: pci_alloc_msi[%d] failed\n"
argument_list|,
name|__func__
argument_list|,
name|ha
operator|->
name|msix_count
argument_list|)
expr_stmt|;
name|ha
operator|->
name|msix_count
operator|=
literal|0
expr_stmt|;
goto|goto
name|qla_pci_attach_err
goto|;
block|}
name|TASK_INIT
argument_list|(
operator|&
name|ha
operator|->
name|tx_task
argument_list|,
literal|0
argument_list|,
name|qla_tx_done
argument_list|,
name|ha
argument_list|)
expr_stmt|;
name|ha
operator|->
name|tx_tq
operator|=
name|taskqueue_create_fast
argument_list|(
literal|"qla_txq"
argument_list|,
name|M_NOWAIT
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|ha
operator|->
name|tx_tq
argument_list|)
expr_stmt|;
name|taskqueue_start_threads
argument_list|(
operator|&
name|ha
operator|->
name|tx_tq
argument_list|,
literal|1
argument_list|,
name|PI_NET
argument_list|,
literal|"%s txq"
argument_list|,
name|device_get_nameunit
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|msix_count
condition|;
name|i
operator|++
control|)
block|{
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq_rid
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|ha
operator|=
name|ha
expr_stmt|;
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq_rid
argument_list|,
operator|(
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|qla_pci_attach_err
goto|;
block|}
if|if
condition|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
argument_list|,
operator|(
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
operator|)
argument_list|,
name|NULL
argument_list|,
name|qla_isr
argument_list|,
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
argument_list|,
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|handle
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not setup interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|qla_pci_attach_err
goto|;
block|}
name|TASK_INIT
argument_list|(
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|rcv_task
argument_list|,
literal|0
argument_list|,
name|qla_rcv
argument_list|,\
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|rcv_tq
operator|=
name|taskqueue_create_fast
argument_list|(
literal|"qla_rcvq"
argument_list|,
name|M_NOWAIT
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|rcv_tq
argument_list|)
expr_stmt|;
name|taskqueue_start_threads
argument_list|(
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|rcv_tq
argument_list|,
literal|1
argument_list|,
name|PI_NET
argument_list|,
literal|"%s rcvq"
argument_list|,
name|device_get_nameunit
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|qla_add_sysctls
argument_list|(
name|ha
argument_list|)
expr_stmt|;
comment|/* add hardware specific sysctls */
name|qla_hw_add_sysctls
argument_list|(
name|ha
argument_list|)
expr_stmt|;
comment|/* initialize hardware */
if|if
condition|(
name|qla_init_hw
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: qla_init_hw failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qla_pci_attach_err
goto|;
block|}
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: firmware[%d.%d.%d.%d]\n"
argument_list|,
name|__func__
argument_list|,
name|ha
operator|->
name|fw_ver_major
argument_list|,
name|ha
operator|->
name|fw_ver_minor
argument_list|,
name|ha
operator|->
name|fw_ver_sub
argument_list|,
name|ha
operator|->
name|fw_ver_build
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|ha
operator|->
name|fw_ver_str
argument_list|,
sizeof|sizeof
argument_list|(
name|ha
operator|->
name|fw_ver_str
argument_list|)
argument_list|,
literal|"%d.%d.%d.%d"
argument_list|,
name|ha
operator|->
name|fw_ver_major
argument_list|,
name|ha
operator|->
name|fw_ver_minor
argument_list|,
name|ha
operator|->
name|fw_ver_sub
argument_list|,
name|ha
operator|->
name|fw_ver_build
argument_list|)
expr_stmt|;
comment|//qla_get_hw_caps(ha);
name|qla_read_mac_addr
argument_list|(
name|ha
argument_list|)
expr_stmt|;
comment|/* allocate parent dma tag */
if|if
condition|(
name|qla_alloc_parent_dma_tag
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: qla_alloc_parent_dma_tag failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qla_pci_attach_err
goto|;
block|}
comment|/* alloc all dma buffers */
if|if
condition|(
name|qla_alloc_dma
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: qla_alloc_dma failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qla_pci_attach_err
goto|;
block|}
comment|/* create the o.s ethernet interface */
name|qla_init_ifnet
argument_list|(
name|dev
argument_list|,
name|ha
argument_list|)
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|qla_watchdog_active
operator|=
literal|1
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|qla_watchdog_pause
operator|=
literal|1
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|ha
operator|->
name|tx_callout
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* create ioctl device interface */
if|if
condition|(
name|qla_make_cdev
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: qla_make_cdev failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qla_pci_attach_err
goto|;
block|}
name|callout_reset
argument_list|(
operator|&
name|ha
operator|->
name|tx_callout
argument_list|,
name|QLA_WATCHDOG_CALLOUT_TICKS
argument_list|,
name|qla_watchdog
argument_list|,
name|ha
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: exit 0\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|qla_pci_attach_err
label|:
name|qla_release
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: exit ENXIO\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name:	qla_pci_detach  * Function:	Unhooks the device from the operating system  */
end_comment

begin_function
specifier|static
name|int
name|qla_pci_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|qla_host_t
modifier|*
name|ha
init|=
name|NULL
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ha
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot get softc\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|ifp
operator|=
name|ha
operator|->
name|ifp
expr_stmt|;
name|QLA_LOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|qla_stop
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QLA_UNLOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|tx_tq
condition|)
block|{
name|taskqueue_drain
argument_list|(
name|ha
operator|->
name|tx_tq
argument_list|,
operator|&
name|ha
operator|->
name|tx_task
argument_list|)
expr_stmt|;
name|taskqueue_free
argument_list|(
name|ha
operator|->
name|tx_tq
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|msix_count
condition|;
name|i
operator|++
control|)
block|{
name|taskqueue_drain
argument_list|(
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|rcv_tq
argument_list|,
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|rcv_task
argument_list|)
expr_stmt|;
name|taskqueue_free
argument_list|(
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|rcv_tq
argument_list|)
expr_stmt|;
block|}
name|qla_release
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: exit\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * SYSCTL Related Callbacks  */
end_comment

begin_function
specifier|static
name|int
name|qla_sysctl_get_stats
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|qla_host_t
modifier|*
name|ha
decl_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|ret
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|ha
operator|=
operator|(
name|qla_host_t
operator|*
operator|)
name|arg1
expr_stmt|;
comment|//qla_get_stats(ha);
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: called ret %d\n"
operator|,
name|__func__
operator|,
name|ret
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name:	qla_release  * Function:	Releases the resources allocated for the device  */
end_comment

begin_function
specifier|static
name|void
name|qla_release
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|qla_del_cdev
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|qla_watchdog_active
condition|)
name|ha
operator|->
name|flags
operator|.
name|qla_watchdog_exit
operator|=
literal|1
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|ha
operator|->
name|tx_callout
argument_list|)
expr_stmt|;
name|qla_mdelay
argument_list|(
name|__func__
argument_list|,
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|ifp
operator|!=
name|NULL
condition|)
name|ether_ifdetach
argument_list|(
name|ha
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|qla_free_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_free_parent_dma_tag
argument_list|(
name|ha
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|msix_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|handle
condition|)
operator|(
name|void
operator|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
condition|)
operator|(
name|void
operator|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq_rid
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|msix_count
condition|)
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|lock_init
condition|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|ha
operator|->
name|tx_lock
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|ha
operator|->
name|rx_lock
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|ha
operator|->
name|rxj_lock
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|ha
operator|->
name|hw_lock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|pci_reg
condition|)
operator|(
name|void
operator|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ha
operator|->
name|reg_rid
argument_list|,
name|ha
operator|->
name|pci_reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * DMA Related Functions  */
end_comment

begin_function
specifier|static
name|void
name|qla_dmamap_callback
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
operator|*
operator|(
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|)
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"%s: bus_dmamap_load failed (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return;
block|}
name|QL_ASSERT
argument_list|(
operator|(
name|nsegs
operator|==
literal|1
operator|)
argument_list|,
operator|(
literal|"%s: %d segments returned!"
operator|,
name|__func__
operator|,
name|nsegs
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|)
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|qla_alloc_dmabuf
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|qla_dma_t
modifier|*
name|dma_buf
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|bus_addr_t
name|b_addr
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|bus_dma_tag_create
argument_list|(
name|ha
operator|->
name|parent_tag
argument_list|,
comment|/* parent */
name|dma_buf
operator|->
name|alignment
argument_list|,
operator|(
call|(
name|bus_size_t
call|)
argument_list|(
literal|1ULL
operator|<<
literal|32
argument_list|)
operator|)
argument_list|,
comment|/* boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|dma_buf
operator|->
name|size
argument_list|,
comment|/* maxsize */
literal|1
argument_list|,
comment|/* nsegments */
name|dma_buf
operator|->
name|size
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|dma_buf
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: could not create dma tag\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qla_alloc_dmabuf_exit
goto|;
block|}
name|ret
operator|=
name|bus_dmamem_alloc
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|dma_buf
operator|->
name|dma_b
argument_list|,
operator|(
name|BUS_DMA_ZERO
operator||
name|BUS_DMA_COHERENT
operator||
name|BUS_DMA_NOWAIT
operator|)
argument_list|,
operator|&
name|dma_buf
operator|->
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: bus_dmamem_alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qla_alloc_dmabuf_exit
goto|;
block|}
name|ret
operator|=
name|bus_dmamap_load
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|,
name|dma_buf
operator|->
name|dma_map
argument_list|,
name|dma_buf
operator|->
name|dma_b
argument_list|,
name|dma_buf
operator|->
name|size
argument_list|,
name|qla_dmamap_callback
argument_list|,
operator|&
name|b_addr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|||
operator|!
name|b_addr
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|,
name|dma_buf
operator|->
name|dma_b
argument_list|,
name|dma_buf
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|qla_alloc_dmabuf_exit
goto|;
block|}
name|dma_buf
operator|->
name|dma_addr
operator|=
name|b_addr
expr_stmt|;
name|qla_alloc_dmabuf_exit
label|:
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: exit ret 0x%08x tag %p map %p b %p sz 0x%x\n"
operator|,
name|__func__
operator|,
name|ret
operator|,
operator|(
name|void
operator|*
operator|)
name|dma_buf
operator|->
name|dma_tag
operator|,
operator|(
name|void
operator|*
operator|)
name|dma_buf
operator|->
name|dma_map
operator|,
operator|(
name|void
operator|*
operator|)
name|dma_buf
operator|->
name|dma_b
operator|,
name|dma_buf
operator|->
name|size
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|qla_free_dmabuf
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|qla_dma_t
modifier|*
name|dma_buf
parameter_list|)
block|{
name|bus_dmamap_unload
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|,
name|dma_buf
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|,
name|dma_buf
operator|->
name|dma_b
argument_list|,
name|dma_buf
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_alloc_parent_dma_tag
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
comment|/*          * Allocate parent DMA Tag          */
name|ret
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
comment|/* parent */
literal|1
argument_list|,
operator|(
call|(
name|bus_size_t
call|)
argument_list|(
literal|1ULL
operator|<<
literal|32
argument_list|)
operator|)
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
comment|/* maxsize */
literal|0
argument_list|,
comment|/* nsegments */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|ha
operator|->
name|parent_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: could not create parent dma tag\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ha
operator|->
name|flags
operator|.
name|parent_tag
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_free_parent_dma_tag
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|parent_tag
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|ha
operator|->
name|parent_tag
argument_list|)
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|parent_tag
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Name: qla_init_ifnet  * Function: Creates the Network Device Interface and Registers it with the O.S  */
end_comment

begin_function
specifier|static
name|void
name|qla_init_ifnet
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|ha
operator|->
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"%s: cannot if_alloc()\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|qla_init
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|ha
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|qla_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|qla_start
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|qla_get_ifq_snd_maxlen
argument_list|(
name|ha
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|qla_get_ifq_snd_maxlen
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|ha
operator|->
name|max_frame_size
operator|=
name|ifp
operator|->
name|if_mtu
operator|+
name|ETHER_HDR_LEN
operator|+
name|ETHER_CRC_LEN
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|qla_get_mac_addr
argument_list|(
name|ha
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator|=
name|IFCAP_HWCSUM
operator||
name|IFCAP_TSO4
operator||
name|IFCAP_JUMBO_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWTAGGING
operator||
name|IFCAP_VLAN_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_LINKSTATE
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|&&
operator|(
name|__FreeBSD_version
operator|<
literal|900002
operator|)
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_watchdog
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* #if defined(__FreeBSD_version)&& (__FreeBSD_version< 900002) */
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
name|ifp
operator|->
name|if_hdrlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_vlan_header
argument_list|)
expr_stmt|;
name|ifmedia_init
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
name|IFM_IMASK
argument_list|,
name|qla_media_change
argument_list|,
name|qla_media_status
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|qla_get_optics
argument_list|(
name|ha
argument_list|)
operator||
name|IFM_FDX
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|IFM_AUTO
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|IFM_AUTO
operator|)
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: exit\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_init_locked
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ha
operator|->
name|ifp
decl_stmt|;
name|qla_stop
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|qla_alloc_xmt_bufs
argument_list|(
name|ha
argument_list|)
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
name|qla_alloc_rcv_bufs
argument_list|(
name|ha
argument_list|)
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
name|qla_config_lro
argument_list|(
name|ha
argument_list|)
condition|)
return|return;
name|bcopy
argument_list|(
name|IF_LLADDR
argument_list|(
name|ha
operator|->
name|ifp
argument_list|)
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mac_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|=
name|CSUM_TCP
operator||
name|CSUM_UDP
operator||
name|CSUM_TSO
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|stop_rcv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|qla_init_hw_if
argument_list|(
name|ha
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ifp
operator|=
name|ha
operator|->
name|ifp
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|qla_watchdog_pause
operator|=
literal|0
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|qla_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
operator|(
name|qla_host_t
operator|*
operator|)
name|arg
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|QLA_LOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|qla_init_locked
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QLA_UNLOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: exit\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_set_multi
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|add_multi
parameter_list|)
block|{
name|uint8_t
name|mta
index|[
name|Q8_MAX_NUM_MULTICAST_ADDRS
operator|*
name|Q8_MAC_ADDR_LEN
index|]
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|int
name|mcnt
init|=
literal|0
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ha
operator|->
name|ifp
decl_stmt|;
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
if|if
condition|(
name|mcnt
operator|==
name|Q8_MAX_NUM_MULTICAST_ADDRS
condition|)
break|break;
name|bcopy
argument_list|(
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
argument_list|,
operator|&
name|mta
index|[
name|mcnt
operator|*
name|Q8_MAC_ADDR_LEN
index|]
argument_list|,
name|Q8_MAC_ADDR_LEN
argument_list|)
expr_stmt|;
name|mcnt
operator|++
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|qla_hw_set_multi
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|,
name|mcnt
argument_list|,
name|add_multi
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
init|=
operator|(
expr|struct
name|ifaddr
operator|*
operator|)
name|data
decl_stmt|;
name|qla_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
operator|(
name|qla_host_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFADDR
case|:
name|QL_DPRINT4
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: SIOCSIFADDR (0x%lx)\n"
operator|,
name|__func__
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_UP
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|QLA_LOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|qla_init_locked
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QLA_UNLOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
name|QL_DPRINT4
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: SIOCSIFADDR (0x%lx) ipv4 [0x%08x]\n"
operator|,
name|__func__
operator|,
name|cmd
operator|,
name|ntohl
argument_list|(
name|IA_SIN
argument_list|(
name|ifa
argument_list|)
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|arp_ifinit
argument_list|(
name|ifp
argument_list|,
name|ifa
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntohl
argument_list|(
name|IA_SIN
argument_list|(
name|ifa
argument_list|)
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
operator|!=
name|INADDR_ANY
condition|)
block|{
name|qla_config_ipv4_addr
argument_list|(
name|ha
argument_list|,
operator|(
name|IA_SIN
argument_list|(
name|ifa
argument_list|)
operator|->
name|sin_addr
operator|.
name|s_addr
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFMTU
case|:
name|QL_DPRINT4
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: SIOCSIFMTU (0x%lx)\n"
operator|,
name|__func__
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifr
operator|->
name|ifr_mtu
operator|>
name|QLA_MAX_FRAME_SIZE
operator|-
name|ETHER_HDR_LEN
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
name|QLA_LOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_mtu
operator|=
name|ifr
operator|->
name|ifr_mtu
expr_stmt|;
name|ha
operator|->
name|max_frame_size
operator|=
name|ifp
operator|->
name|if_mtu
operator|+
name|ETHER_HDR_LEN
operator|+
name|ETHER_CRC_LEN
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|ret
operator|=
name|qla_set_max_mtu
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|max_frame_size
argument_list|,
operator|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
operator|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
argument_list|)
expr_stmt|;
block|}
name|QLA_UNLOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFFLAGS
case|:
name|QL_DPRINT4
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: SIOCSIFFLAGS (0x%lx)\n"
operator|,
name|__func__
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|ha
operator|->
name|if_flags
operator|)
operator|&
name|IFF_PROMISC
condition|)
block|{
name|qla_set_promisc
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|ha
operator|->
name|if_flags
operator|)
operator|&
name|IFF_ALLMULTI
condition|)
block|{
name|qla_set_allmulti
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|QLA_LOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|qla_init_locked
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|ha
operator|->
name|max_frame_size
operator|=
name|ifp
operator|->
name|if_mtu
operator|+
name|ETHER_HDR_LEN
operator|+
name|ETHER_CRC_LEN
expr_stmt|;
name|ret
operator|=
name|qla_set_max_mtu
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|max_frame_size
argument_list|,
operator|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
operator|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
argument_list|)
expr_stmt|;
name|QLA_UNLOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|QLA_LOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|qla_stop
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|ha
operator|->
name|if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|QLA_UNLOCK
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCADDMULTI
case|:
name|QL_DPRINT4
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: %s (0x%lx)\n"
operator|,
name|__func__
operator|,
literal|"SIOCADDMULTI"
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|qla_set_multi
argument_list|(
name|ha
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCDELMULTI
case|:
name|QL_DPRINT4
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: %s (0x%lx)\n"
operator|,
name|__func__
operator|,
literal|"SIOCDELMULTI"
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|qla_set_multi
argument_list|(
name|ha
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|QL_DPRINT4
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: SIOCSIFMEDIA/SIOCGIFMEDIA (0x%lx)\n"
operator|,
name|__func__
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|ha
operator|->
name|media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFCAP
case|:
block|{
name|int
name|mask
init|=
name|ifr
operator|->
name|ifr_reqcap
operator|^
name|ifp
operator|->
name|if_capenable
decl_stmt|;
name|QL_DPRINT4
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: SIOCSIFCAP (0x%lx)\n"
operator|,
name|__func__
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_HWCSUM
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_HWCSUM
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO4
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO4
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO6
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO6
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWTAGGING
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
name|qla_init
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|VLAN_CAPABILITIES
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|QL_DPRINT4
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: default (0x%lx)\n"
operator|,
name|__func__
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|qla_host_t
modifier|*
name|ha
decl_stmt|;
name|struct
name|ifmedia
modifier|*
name|ifm
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ha
operator|=
operator|(
name|qla_host_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|ifm
operator|=
operator|&
name|ha
operator|->
name|media
expr_stmt|;
if|if
condition|(
name|IFM_TYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|!=
name|IFM_ETHER
condition|)
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: exit\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|qla_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
operator|(
name|qla_host_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
expr_stmt|;
name|qla_update_link_state
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|link_up
condition|)
block|{
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator||=
operator|(
name|IFM_FDX
operator||
name|qla_get_optics
argument_list|(
name|ha
argument_list|)
operator|)
expr_stmt|;
block|}
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: exit (%s)\n"
operator|,
name|__func__
operator|,
expr|\
operator|(
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|link_up
condition|?
literal|"link_up"
else|:
literal|"link_down"
operator|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|qla_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m_head
decl_stmt|;
name|qla_host_t
modifier|*
name|ha
init|=
operator|(
name|qla_host_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mtx_trylock
argument_list|(
operator|&
name|ha
operator|->
name|tx_lock
argument_list|)
condition|)
block|{
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: mtx_trylock(&ha->tx_lock) failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
condition|)
block|{
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: !IFF_DRV_RUNNING\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|QLA_TX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|ha
operator|->
name|watchdog_ticks
condition|)
name|qla_update_link_state
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|link_up
condition|)
block|{
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: link down\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|QLA_TX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_head
operator|!=
name|NULL
condition|)
block|{
name|IF_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_head
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: m_head == NULL\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|qla_send
argument_list|(
name|ha
argument_list|,
operator|&
name|m_head
argument_list|)
condition|)
block|{
if|if
condition|(
name|m_head
operator|==
name|NULL
condition|)
break|break;
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: PREPEND\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
name|IF_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Send a copy of the frame to the BPF listener */
name|ETHER_BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
block|}
name|QLA_TX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: exit\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_send
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m_headp
parameter_list|)
block|{
name|bus_dma_segment_t
name|segs
index|[
name|QLA_MAX_SEGMENTS
index|]
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|int
name|nsegs
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|uint32_t
name|tx_idx
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m_head
init|=
operator|*
name|m_headp
decl_stmt|;
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|bus_dmamap_create
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|map
argument_list|)
operator|)
condition|)
block|{
name|ha
operator|->
name|err_tx_dmamap_create
operator|++
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: bus_dmamap_create failed[%d, %d]\n"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|,
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
name|ret
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|map
argument_list|,
name|m_head
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|EFBIG
condition|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: EFBIG [%d]\n"
operator|,
name|__func__
operator|,
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
operator|)
argument_list|)
expr_stmt|;
name|m
operator|=
name|m_defrag
argument_list|(
name|m_head
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|ha
operator|->
name|err_tx_defrag
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_headp
operator|=
name|NULL
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: m_defrag() = NULL [%d]\n"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|m_head
operator|=
name|m
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|map
argument_list|,
name|m_head
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
operator|)
condition|)
block|{
name|ha
operator|->
name|err_tx_dmamap_load
operator|++
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: bus_dmamap_load_mbuf_sg failed0[%d, %d]\n"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|,
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ENOMEM
condition|)
block|{
name|m_freem
argument_list|(
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_headp
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|ret
condition|)
block|{
name|ha
operator|->
name|err_tx_dmamap_load
operator|++
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: bus_dmamap_load_mbuf_sg failed1[%d, %d]\n"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|,
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ENOMEM
condition|)
block|{
name|m_freem
argument_list|(
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_headp
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
name|QL_ASSERT
argument_list|(
operator|(
name|nsegs
operator|!=
literal|0
operator|)
argument_list|,
operator|(
literal|"qla_send: empty packet"
operator|)
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ret
operator|=
name|qla_hw_send
argument_list|(
name|ha
argument_list|,
name|segs
argument_list|,
name|nsegs
argument_list|,
operator|&
name|tx_idx
argument_list|,
name|m_head
argument_list|)
operator|)
condition|)
block|{
name|ha
operator|->
name|tx_buf
index|[
name|tx_idx
index|]
operator|.
name|m_head
operator|=
name|m_head
expr_stmt|;
name|ha
operator|->
name|tx_buf
index|[
name|tx_idx
index|]
operator|.
name|map
operator|=
name|map
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ret
operator|==
name|EINVAL
condition|)
block|{
name|m_freem
argument_list|(
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_headp
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: exit\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_stop
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ha
operator|->
name|ifp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|qla_watchdog_pause
operator|=
literal|1
expr_stmt|;
name|qla_mdelay
argument_list|(
name|__func__
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|stop_rcv
operator|=
literal|1
expr_stmt|;
name|qla_hw_stop_rcv
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_del_hw_if
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_free_lro
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_free_xmt_bufs
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_free_rcv_bufs
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_OACTIVE
operator||
name|IFF_DRV_RUNNING
operator|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Buffer Management Functions for Transmit and Receive Rings  */
end_comment

begin_function
specifier|static
name|int
name|qla_alloc_xmt_bufs
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|NULL
argument_list|,
comment|/* parent */
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, bounds */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|QLA_MAX_TSO_FRAME_SIZE
argument_list|,
comment|/* maxsize */
name|QLA_MAX_SEGMENTS
argument_list|,
comment|/* nsegments */
name|PAGE_SIZE
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
operator|&
name|ha
operator|->
name|tx_tag
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: tx_tag alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|tx_buf
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|qla_tx_buf_t
argument_list|)
operator|*
name|NUM_TX_DESCRIPTORS
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Release mbuf after it sent on the wire  */
end_comment

begin_function
specifier|static
name|void
name|qla_clear_tx_buf
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|qla_tx_buf_t
modifier|*
name|txb
parameter_list|)
block|{
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|txb
operator|->
name|m_head
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|txb
operator|->
name|map
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|txb
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|txb
operator|->
name|m_head
argument_list|)
expr_stmt|;
name|txb
operator|->
name|m_head
operator|=
name|NULL
expr_stmt|;
block|}
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: exit\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_free_xmt_bufs
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_TX_DESCRIPTORS
condition|;
name|i
operator|++
control|)
name|qla_clear_tx_buf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|tx_buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|tx_tag
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|)
expr_stmt|;
name|ha
operator|->
name|tx_tag
operator|=
name|NULL
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|tx_buf
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|qla_tx_buf_t
argument_list|)
operator|*
name|NUM_TX_DESCRIPTORS
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qla_alloc_rcv_bufs
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|qla_rx_buf_t
modifier|*
name|rxb
decl_stmt|;
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|NULL
argument_list|,
comment|/* parent */
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, bounds */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|MJUM9BYTES
argument_list|,
comment|/* maxsize */
literal|1
argument_list|,
comment|/* nsegments */
name|MJUM9BYTES
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
operator|&
name|ha
operator|->
name|rx_tag
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: rx_tag alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|rx_buf
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|qla_rx_buf_t
argument_list|)
operator|*
name|NUM_RX_DESCRIPTORS
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|rx_jbuf
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|qla_rx_buf_t
argument_list|)
operator|*
name|NUM_RX_JUMBO_DESCRIPTORS
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_SDS_RINGS
condition|;
name|i
operator|++
control|)
block|{
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|sdsr_next
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|rxb_free
operator|=
name|NULL
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|rx_free
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|rxjb_free
operator|=
name|NULL
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|rxj_free
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_RX_DESCRIPTORS
condition|;
name|i
operator|++
control|)
block|{
name|rxb
operator|=
operator|&
name|ha
operator|->
name|rx_buf
index|[
name|i
index|]
expr_stmt|;
name|ret
operator|=
name|bus_dmamap_create
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|rxb
operator|->
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: dmamap[%d] failed\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|ha
operator|->
name|rx_buf
index|[
name|j
index|]
operator|.
name|map
argument_list|)
expr_stmt|;
block|}
goto|goto
name|qla_alloc_rcv_bufs_failed
goto|;
block|}
block|}
name|qla_init_hw_rcv_descriptors
argument_list|(
name|ha
argument_list|,
name|RDS_RING_INDEX_NORMAL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_RX_DESCRIPTORS
condition|;
name|i
operator|++
control|)
block|{
name|rxb
operator|=
operator|&
name|ha
operator|->
name|rx_buf
index|[
name|i
index|]
expr_stmt|;
name|rxb
operator|->
name|handle
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ret
operator|=
name|qla_get_mbuf
argument_list|(
name|ha
argument_list|,
name|rxb
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
comment|/* 		 	 * set the physical address in the corresponding 			 * descriptor entry in the receive ring/queue for the 			 * hba  			 */
name|qla_set_hw_rcv_desc
argument_list|(
name|ha
argument_list|,
name|RDS_RING_INDEX_NORMAL
argument_list|,
name|i
argument_list|,
name|rxb
operator|->
name|handle
argument_list|,
name|rxb
operator|->
name|paddr
argument_list|,
operator|(
name|rxb
operator|->
name|m_head
operator|)
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: qla_get_mbuf [standard(%d)] failed\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rxb
operator|->
name|map
argument_list|)
expr_stmt|;
goto|goto
name|qla_alloc_rcv_bufs_failed
goto|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_RX_JUMBO_DESCRIPTORS
condition|;
name|i
operator|++
control|)
block|{
name|rxb
operator|=
operator|&
name|ha
operator|->
name|rx_jbuf
index|[
name|i
index|]
expr_stmt|;
name|ret
operator|=
name|bus_dmamap_create
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|rxb
operator|->
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: dmamap[%d] failed\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|ha
operator|->
name|rx_jbuf
index|[
name|j
index|]
operator|.
name|map
argument_list|)
expr_stmt|;
block|}
goto|goto
name|qla_alloc_rcv_bufs_failed
goto|;
block|}
block|}
name|qla_init_hw_rcv_descriptors
argument_list|(
name|ha
argument_list|,
name|RDS_RING_INDEX_JUMBO
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_RX_JUMBO_DESCRIPTORS
condition|;
name|i
operator|++
control|)
block|{
name|rxb
operator|=
operator|&
name|ha
operator|->
name|rx_jbuf
index|[
name|i
index|]
expr_stmt|;
name|rxb
operator|->
name|handle
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ret
operator|=
name|qla_get_mbuf
argument_list|(
name|ha
argument_list|,
name|rxb
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
comment|/* 		 	 * set the physical address in the corresponding 			 * descriptor entry in the receive ring/queue for the 			 * hba  			 */
name|qla_set_hw_rcv_desc
argument_list|(
name|ha
argument_list|,
name|RDS_RING_INDEX_JUMBO
argument_list|,
name|i
argument_list|,
name|rxb
operator|->
name|handle
argument_list|,
name|rxb
operator|->
name|paddr
argument_list|,
operator|(
name|rxb
operator|->
name|m_head
operator|)
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: qla_get_mbuf [jumbo(%d)] failed\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rxb
operator|->
name|map
argument_list|)
expr_stmt|;
goto|goto
name|qla_alloc_rcv_bufs_failed
goto|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|qla_alloc_rcv_bufs_failed
label|:
name|qla_free_rcv_bufs
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_free_rcv_bufs
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|qla_rx_buf_t
modifier|*
name|rxb
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_RX_DESCRIPTORS
condition|;
name|i
operator|++
control|)
block|{
name|rxb
operator|=
operator|&
name|ha
operator|->
name|rx_buf
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rxb
operator|->
name|m_head
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rxb
operator|->
name|map
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rxb
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rxb
operator|->
name|m_head
argument_list|)
expr_stmt|;
name|rxb
operator|->
name|m_head
operator|=
name|NULL
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_RX_JUMBO_DESCRIPTORS
condition|;
name|i
operator|++
control|)
block|{
name|rxb
operator|=
operator|&
name|ha
operator|->
name|rx_jbuf
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rxb
operator|->
name|m_head
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rxb
operator|->
name|map
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rxb
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rxb
operator|->
name|m_head
argument_list|)
expr_stmt|;
name|rxb
operator|->
name|m_head
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ha
operator|->
name|rx_tag
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|)
expr_stmt|;
name|ha
operator|->
name|rx_tag
operator|=
name|NULL
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|rx_buf
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|qla_rx_buf_t
argument_list|)
operator|*
name|NUM_RX_DESCRIPTORS
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ha
operator|->
name|rx_jbuf
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|qla_rx_buf_t
argument_list|)
operator|*
name|NUM_RX_JUMBO_DESCRIPTORS
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_SDS_RINGS
condition|;
name|i
operator|++
control|)
block|{
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|sdsr_next
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|rxb_free
operator|=
name|NULL
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|rx_free
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|rxjb_free
operator|=
name|NULL
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|rxj_free
operator|=
literal|0
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|int
name|qla_get_mbuf
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|qla_rx_buf_t
modifier|*
name|rxb
parameter_list|,
name|struct
name|mbuf
modifier|*
name|nmp
parameter_list|,
name|uint32_t
name|jumbo
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mp
init|=
name|nmp
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: jumbo(0x%x) enter\n"
operator|,
name|__func__
operator|,
name|jumbo
operator|)
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|ha
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
name|mp
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|jumbo
condition|)
block|{
name|mp
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|==
name|NULL
condition|)
block|{
name|ha
operator|->
name|err_m_getcl
operator|++
expr_stmt|;
name|ret
operator|=
name|ENOBUFS
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: m_getcl failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|exit_qla_get_mbuf
goto|;
block|}
name|mp
operator|->
name|m_len
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MCLBYTES
expr_stmt|;
block|}
else|else
block|{
name|mp
operator|=
name|m_getjcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|MJUM9BYTES
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|==
name|NULL
condition|)
block|{
name|ha
operator|->
name|err_m_getjcl
operator|++
expr_stmt|;
name|ret
operator|=
name|ENOBUFS
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: m_getjcl failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|exit_qla_get_mbuf
goto|;
block|}
name|mp
operator|->
name|m_len
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MJUM9BYTES
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|jumbo
condition|)
name|mp
operator|->
name|m_len
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MCLBYTES
expr_stmt|;
else|else
name|mp
operator|->
name|m_len
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MJUM9BYTES
expr_stmt|;
name|mp
operator|->
name|m_data
operator|=
name|mp
operator|->
name|m_ext
operator|.
name|ext_buf
expr_stmt|;
name|mp
operator|->
name|m_next
operator|=
name|NULL
expr_stmt|;
block|}
name|offset
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|unsigned
name|long
name|long
operator|)
name|mp
operator|->
name|m_data
operator|&
literal|0x7ULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|offset
operator|=
literal|8
operator|-
name|offset
expr_stmt|;
name|m_adj
argument_list|(
name|mp
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Using memory from the mbuf cluster pool, invoke the bus_dma 	 * machinery to arrange the memory mapping. 	 */
name|ret
operator|=
name|bus_dmamap_load
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rxb
operator|->
name|map
argument_list|,
name|mtod
argument_list|(
name|mp
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|mp
operator|->
name|m_len
argument_list|,
name|qla_dmamap_callback
argument_list|,
operator|&
name|rxb
operator|->
name|paddr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|||
operator|!
name|rxb
operator|->
name|paddr
condition|)
block|{
name|m_free
argument_list|(
name|mp
argument_list|)
expr_stmt|;
name|rxb
operator|->
name|m_head
operator|=
name|NULL
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: bus_dmamap_load failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|exit_qla_get_mbuf
goto|;
block|}
name|rxb
operator|->
name|m_head
operator|=
name|mp
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rxb
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|exit_qla_get_mbuf
label|:
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: exit ret = 0x%08x\n"
operator|,
name|__func__
operator|,
name|ret
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qla_tx_done
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|qla_host_t
modifier|*
name|ha
init|=
name|context
decl_stmt|;
name|qla_hw_tx_done
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_start
argument_list|(
name|ha
operator|->
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


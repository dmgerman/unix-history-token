begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2011-2012 Qlogic Corporation  * All rights reserved.  *  *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  *  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  *  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  *  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  *  POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * File: qla_hw.c  * Author : David C Somayajulu, Qlogic Corporation, Aliso Viejo, CA 92656.  * Content: Contains Hardware dependant functions  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"qla_os.h"
end_include

begin_include
include|#
directive|include
file|"qla_reg.h"
end_include

begin_include
include|#
directive|include
file|"qla_hw.h"
end_include

begin_include
include|#
directive|include
file|"qla_def.h"
end_include

begin_include
include|#
directive|include
file|"qla_inline.h"
end_include

begin_include
include|#
directive|include
file|"qla_ver.h"
end_include

begin_include
include|#
directive|include
file|"qla_glbl.h"
end_include

begin_include
include|#
directive|include
file|"qla_dbg.h"
end_include

begin_decl_stmt
specifier|static
name|uint32_t
name|sysctl_num_rds_rings
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|sysctl_num_sds_rings
init|=
literal|4
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Static Functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|qla_init_cntxt_regions
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_issue_cmd
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|qla_cdrp_t
modifier|*
name|cdrp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_fw_cmd
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|void
modifier|*
name|fw_cmd
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_config_mac_addr
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mac_addr
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|,
name|uint32_t
name|add_multi
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_del_rcv_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_init_rcv_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_del_xmt_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_init_xmt_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_get_max_rds
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_get_max_sds
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_get_max_rules
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_get_max_rcv_cntxts
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_get_max_tx_cntxts
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_get_max_mtu
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_get_max_lro
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qla_get_flow_control
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qla_hw_tx_done_locked
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|qla_get_msix_count
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
return|return
operator|(
name|sysctl_num_sds_rings
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_hw_add_sysctls  * Function: Add P3Plus specific sysctls  */
end_comment

begin_function
name|void
name|qla_hw_add_sysctls
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"num_rds_rings"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sysctl_num_rds_rings
argument_list|,
name|sysctl_num_rds_rings
argument_list|,
literal|"Number of Rcv Descriptor Rings"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"num_sds_rings"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sysctl_num_sds_rings
argument_list|,
name|sysctl_num_sds_rings
argument_list|,
literal|"Number of Status Descriptor Rings"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_free_dma  * Function: Frees the DMA'able memory allocated in qla_alloc_dma()  */
end_comment

begin_function
name|void
name|qla_free_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|context
condition|)
block|{
name|qla_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|context
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|context
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|sds_ring
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
name|qla_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|sds_ring
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|rds_ring
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
condition|;
name|i
operator|++
control|)
name|qla_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|rds_ring
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|tx_ring
condition|)
block|{
name|qla_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|tx_ring
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|tx_ring
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Name: qla_alloc_dma  * Function: Allocates DMA'able memory for Tx/Rx Rings, Tx/Rx Contexts.  */
end_comment

begin_function
name|int
name|qla_alloc_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|size
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
operator|=
operator|(
name|uint16_t
operator|)
name|sysctl_num_rds_rings
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
operator|=
operator|(
name|uint16_t
operator|)
name|sysctl_num_sds_rings
expr_stmt|;
comment|/* 	 * Allocate Transmit Ring 	 */
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|tx_ring
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|tx_ring
operator|.
name|size
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
operator|)
operator|*
name|NUM_TX_DESCRIPTORS
expr_stmt|;
if|if
condition|(
name|qla_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|tx_ring
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: tx ring alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qla_alloc_dma_exit
goto|;
block|}
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|tx_ring
operator|=
literal|1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: tx_ring phys %p virt %p\n"
operator|,
name|__func__
operator|,
operator|(
name|void
operator|*
operator|)
operator|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|tx_ring
operator|.
name|dma_addr
operator|)
operator|,
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|tx_ring
operator|.
name|dma_b
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Allocate Receive Descriptor Rings 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
condition|;
name|i
operator|++
control|)
block|{
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|RDS_RING_INDEX_NORMAL
condition|)
block|{
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|size
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_recv_desc_t
argument_list|)
operator|)
operator|*
name|NUM_RX_DESCRIPTORS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
name|RDS_RING_INDEX_JUMBO
condition|)
block|{
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|size
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_recv_desc_t
argument_list|)
operator|)
operator|*
name|NUM_RX_JUMBO_DESCRIPTORS
expr_stmt|;
block|}
else|else
break|break;
if|if
condition|(
name|qla_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|QL_DPRINT4
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: rds ring alloc failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
name|qla_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|rds_ring
index|[
name|j
index|]
argument_list|)
expr_stmt|;
goto|goto
name|qla_alloc_dma_exit
goto|;
block|}
name|QL_DPRINT4
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: rx_ring[%d] phys %p virt %p\n"
operator|,
name|__func__
operator|,
name|i
operator|,
operator|(
name|void
operator|*
operator|)
operator|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|dma_addr
operator|)
operator|,
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|dma_b
operator|)
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|rds_ring
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Allocate Status Descriptor Rings 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|size
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|q80_stat_desc_t
argument_list|)
operator|)
operator|*
name|NUM_STATUS_DESCRIPTORS
expr_stmt|;
if|if
condition|(
name|qla_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: sds ring alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
name|qla_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|j
index|]
argument_list|)
expr_stmt|;
goto|goto
name|qla_alloc_dma_exit
goto|;
block|}
name|QL_DPRINT4
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: sds_ring[%d] phys %p virt %p\n"
operator|,
name|__func__
operator|,
name|i
operator|,
operator|(
name|void
operator|*
operator|)
operator|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|dma_addr
operator|)
operator|,
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|dma_b
operator|)
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|sds_ring
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Allocate Context Area 	 */
name|size
operator|=
name|QL_ALIGN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cntxt_req_t
argument_list|)
operator|)
argument_list|,
name|QL_BUFFER_ALIGN
argument_list|)
expr_stmt|;
name|size
operator|+=
name|QL_ALIGN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cntxt_rsp_t
argument_list|)
operator|)
argument_list|,
name|QL_BUFFER_ALIGN
argument_list|)
expr_stmt|;
name|size
operator|+=
name|QL_ALIGN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_rcv_cntxt_req_t
argument_list|)
operator|)
argument_list|,
name|QL_BUFFER_ALIGN
argument_list|)
expr_stmt|;
name|size
operator|+=
name|QL_ALIGN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_rcv_cntxt_rsp_t
argument_list|)
operator|)
argument_list|,
name|QL_BUFFER_ALIGN
argument_list|)
expr_stmt|;
name|size
operator|+=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
comment|/* for tx consumer index */
name|size
operator|=
name|QL_ALIGN
argument_list|(
name|size
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|context
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|context
operator|.
name|size
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|qla_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|context
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: context alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qla_alloc_dma_exit
goto|;
block|}
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|flags
operator|.
name|context
operator|=
literal|1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: context phys %p virt %p\n"
operator|,
name|__func__
operator|,
operator|(
name|void
operator|*
operator|)
operator|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|context
operator|.
name|dma_addr
operator|)
operator|,
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|context
operator|.
name|dma_b
operator|)
argument_list|)
expr_stmt|;
name|qla_init_cntxt_regions
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|qla_alloc_dma_exit
label|:
name|qla_free_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_init_cntxt_regions  * Function: Initializes Tx/Rx Contexts.  */
end_comment

begin_function
specifier|static
name|void
name|qla_init_cntxt_regions
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_hw_t
modifier|*
name|hw
decl_stmt|;
name|q80_tx_cntxt_req_t
modifier|*
name|tx_cntxt_req
decl_stmt|;
name|q80_rcv_cntxt_req_t
modifier|*
name|rx_cntxt_req
decl_stmt|;
name|bus_addr_t
name|phys_addr
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|hw
operator|=
operator|&
name|ha
operator|->
name|hw
expr_stmt|;
name|hw
operator|->
name|tx_ring_base
operator|=
name|hw
operator|->
name|dma_buf
operator|.
name|tx_ring
operator|.
name|dma_b
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
name|hw
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|sds_ring_base
operator|=
operator|(
name|q80_stat_desc_t
operator|*
operator|)
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|dma_b
expr_stmt|;
name|phys_addr
operator|=
name|hw
operator|->
name|dma_buf
operator|.
name|context
operator|.
name|dma_addr
expr_stmt|;
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|hw
operator|->
name|dma_buf
operator|.
name|context
operator|.
name|dma_b
argument_list|,
literal|0
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|context
operator|.
name|size
argument_list|)
expr_stmt|;
name|hw
operator|->
name|tx_cntxt_req
operator|=
operator|(
name|q80_tx_cntxt_req_t
operator|*
operator|)
name|hw
operator|->
name|dma_buf
operator|.
name|context
operator|.
name|dma_b
expr_stmt|;
name|hw
operator|->
name|tx_cntxt_req_paddr
operator|=
name|phys_addr
expr_stmt|;
name|size
operator|=
name|QL_ALIGN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cntxt_req_t
argument_list|)
operator|)
argument_list|,
name|QL_BUFFER_ALIGN
argument_list|)
expr_stmt|;
name|hw
operator|->
name|tx_cntxt_rsp
operator|=
operator|(
name|q80_tx_cntxt_rsp_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|hw
operator|->
name|tx_cntxt_req
operator|+
name|size
operator|)
expr_stmt|;
name|hw
operator|->
name|tx_cntxt_rsp_paddr
operator|=
name|hw
operator|->
name|tx_cntxt_req_paddr
operator|+
name|size
expr_stmt|;
name|size
operator|=
name|QL_ALIGN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cntxt_rsp_t
argument_list|)
operator|)
argument_list|,
name|QL_BUFFER_ALIGN
argument_list|)
expr_stmt|;
name|hw
operator|->
name|rx_cntxt_req
operator|=
operator|(
name|q80_rcv_cntxt_req_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|hw
operator|->
name|tx_cntxt_rsp
operator|+
name|size
operator|)
expr_stmt|;
name|hw
operator|->
name|rx_cntxt_req_paddr
operator|=
name|hw
operator|->
name|tx_cntxt_rsp_paddr
operator|+
name|size
expr_stmt|;
name|size
operator|=
name|QL_ALIGN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_rcv_cntxt_req_t
argument_list|)
operator|)
argument_list|,
name|QL_BUFFER_ALIGN
argument_list|)
expr_stmt|;
name|hw
operator|->
name|rx_cntxt_rsp
operator|=
operator|(
name|q80_rcv_cntxt_rsp_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|hw
operator|->
name|rx_cntxt_req
operator|+
name|size
operator|)
expr_stmt|;
name|hw
operator|->
name|rx_cntxt_rsp_paddr
operator|=
name|hw
operator|->
name|rx_cntxt_req_paddr
operator|+
name|size
expr_stmt|;
name|size
operator|=
name|QL_ALIGN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_rcv_cntxt_rsp_t
argument_list|)
operator|)
argument_list|,
name|QL_BUFFER_ALIGN
argument_list|)
expr_stmt|;
name|hw
operator|->
name|tx_cons
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|hw
operator|->
name|rx_cntxt_rsp
operator|+
name|size
operator|)
expr_stmt|;
name|hw
operator|->
name|tx_cons_paddr
operator|=
name|hw
operator|->
name|rx_cntxt_rsp_paddr
operator|+
name|size
expr_stmt|;
comment|/* 	 * Initialize the Transmit Context Request so that we don't need to 	 * do it everytime we need to create a context 	 */
name|tx_cntxt_req
operator|=
name|hw
operator|->
name|tx_cntxt_req
expr_stmt|;
name|tx_cntxt_req
operator|->
name|rsp_dma_addr
operator|=
name|qla_host_to_le64
argument_list|(
name|hw
operator|->
name|tx_cntxt_rsp_paddr
argument_list|)
expr_stmt|;
name|tx_cntxt_req
operator|->
name|cmd_cons_dma_addr
operator|=
name|qla_host_to_le64
argument_list|(
name|hw
operator|->
name|tx_cons_paddr
argument_list|)
expr_stmt|;
name|tx_cntxt_req
operator|->
name|caps
index|[
literal|0
index|]
operator|=
name|qla_host_to_le32
argument_list|(
operator|(
name|CNTXT_CAP0_BASEFW
operator||
name|CNTXT_CAP0_LEGACY_MN
operator||
name|CNTXT_CAP0_LSO
operator|)
argument_list|)
expr_stmt|;
name|tx_cntxt_req
operator|->
name|intr_mode
operator|=
name|qla_host_to_le32
argument_list|(
name|CNTXT_INTR_MODE_SHARED
argument_list|)
expr_stmt|;
name|tx_cntxt_req
operator|->
name|phys_addr
operator|=
name|qla_host_to_le64
argument_list|(
name|hw
operator|->
name|dma_buf
operator|.
name|tx_ring
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
name|tx_cntxt_req
operator|->
name|num_entries
operator|=
name|qla_host_to_le32
argument_list|(
name|NUM_TX_DESCRIPTORS
argument_list|)
expr_stmt|;
comment|/* 	 * Initialize the Receive Context Request 	 */
name|rx_cntxt_req
operator|=
name|hw
operator|->
name|rx_cntxt_req
expr_stmt|;
name|rx_cntxt_req
operator|->
name|rx_req
operator|.
name|rsp_dma_addr
operator|=
name|qla_host_to_le64
argument_list|(
name|hw
operator|->
name|rx_cntxt_rsp_paddr
argument_list|)
expr_stmt|;
name|rx_cntxt_req
operator|->
name|rx_req
operator|.
name|caps
index|[
literal|0
index|]
operator|=
name|qla_host_to_le32
argument_list|(
name|CNTXT_CAP0_BASEFW
operator||
name|CNTXT_CAP0_LEGACY_MN
operator||
name|CNTXT_CAP0_JUMBO
operator||
name|CNTXT_CAP0_LRO
operator||
name|CNTXT_CAP0_HW_LRO
argument_list|)
expr_stmt|;
name|rx_cntxt_req
operator|->
name|rx_req
operator|.
name|intr_mode
operator|=
name|qla_host_to_le32
argument_list|(
name|CNTXT_INTR_MODE_SHARED
argument_list|)
expr_stmt|;
name|rx_cntxt_req
operator|->
name|rx_req
operator|.
name|rds_intr_mode
operator|=
name|qla_host_to_le32
argument_list|(
name|CNTXT_INTR_MODE_UNIQUE
argument_list|)
expr_stmt|;
name|rx_cntxt_req
operator|->
name|rx_req
operator|.
name|rds_ring_offset
operator|=
literal|0
expr_stmt|;
name|rx_cntxt_req
operator|->
name|rx_req
operator|.
name|sds_ring_offset
operator|=
name|qla_host_to_le32
argument_list|(
operator|(
name|hw
operator|->
name|num_rds_rings
operator|*
sizeof|sizeof
argument_list|(
name|q80_rq_rds_ring_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|rx_cntxt_req
operator|->
name|rx_req
operator|.
name|num_rds_rings
operator|=
name|qla_host_to_le16
argument_list|(
name|hw
operator|->
name|num_rds_rings
argument_list|)
expr_stmt|;
name|rx_cntxt_req
operator|->
name|rx_req
operator|.
name|num_sds_rings
operator|=
name|qla_host_to_le16
argument_list|(
name|hw
operator|->
name|num_sds_rings
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|num_rds_rings
condition|;
name|i
operator|++
control|)
block|{
name|rx_cntxt_req
operator|->
name|rds_req
index|[
name|i
index|]
operator|.
name|phys_addr
operator|=
name|qla_host_to_le64
argument_list|(
name|hw
operator|->
name|dma_buf
operator|.
name|rds_ring
index|[
name|i
index|]
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|RDS_RING_INDEX_NORMAL
condition|)
block|{
name|rx_cntxt_req
operator|->
name|rds_req
index|[
name|i
index|]
operator|.
name|buf_size
operator|=
name|qla_host_to_le64
argument_list|(
name|MCLBYTES
argument_list|)
expr_stmt|;
name|rx_cntxt_req
operator|->
name|rds_req
index|[
name|i
index|]
operator|.
name|size
operator|=
name|qla_host_to_le32
argument_list|(
name|NUM_RX_DESCRIPTORS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rx_cntxt_req
operator|->
name|rds_req
index|[
name|i
index|]
operator|.
name|buf_size
operator|=
name|qla_host_to_le64
argument_list|(
name|MJUM9BYTES
argument_list|)
expr_stmt|;
name|rx_cntxt_req
operator|->
name|rds_req
index|[
name|i
index|]
operator|.
name|size
operator|=
name|qla_host_to_le32
argument_list|(
name|NUM_RX_JUMBO_DESCRIPTORS
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|rx_cntxt_req
operator|->
name|sds_req
index|[
name|i
index|]
operator|.
name|phys_addr
operator|=
name|qla_host_to_le64
argument_list|(
name|hw
operator|->
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|dma_addr
argument_list|)
expr_stmt|;
name|rx_cntxt_req
operator|->
name|sds_req
index|[
name|i
index|]
operator|.
name|size
operator|=
name|qla_host_to_le32
argument_list|(
name|NUM_STATUS_DESCRIPTORS
argument_list|)
expr_stmt|;
name|rx_cntxt_req
operator|->
name|sds_req
index|[
name|i
index|]
operator|.
name|msi_index
operator|=
name|qla_host_to_le16
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: tx_cntxt_req = %p paddr %p\n"
operator|,
name|__func__
operator|,
name|hw
operator|->
name|tx_cntxt_req
operator|,
operator|(
name|void
operator|*
operator|)
name|hw
operator|->
name|tx_cntxt_req_paddr
operator|)
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: tx_cntxt_rsp = %p paddr %p\n"
operator|,
name|__func__
operator|,
name|hw
operator|->
name|tx_cntxt_rsp
operator|,
operator|(
name|void
operator|*
operator|)
name|hw
operator|->
name|tx_cntxt_rsp_paddr
operator|)
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: rx_cntxt_req = %p paddr %p\n"
operator|,
name|__func__
operator|,
name|hw
operator|->
name|rx_cntxt_req
operator|,
operator|(
name|void
operator|*
operator|)
name|hw
operator|->
name|rx_cntxt_req_paddr
operator|)
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: rx_cntxt_rsp = %p paddr %p\n"
operator|,
name|__func__
operator|,
name|hw
operator|->
name|rx_cntxt_rsp
operator|,
operator|(
name|void
operator|*
operator|)
name|hw
operator|->
name|rx_cntxt_rsp_paddr
operator|)
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: tx_cons      = %p paddr %p\n"
operator|,
name|__func__
operator|,
name|hw
operator|->
name|tx_cons
operator|,
operator|(
name|void
operator|*
operator|)
name|hw
operator|->
name|tx_cons_paddr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_issue_cmd  * Function: Issues commands on the CDRP interface and returns responses.  */
end_comment

begin_function
specifier|static
name|int
name|qla_issue_cmd
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|qla_cdrp_t
modifier|*
name|cdrp
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|uint32_t
name|signature
decl_stmt|;
name|uint32_t
name|count
init|=
literal|400
decl_stmt|;
comment|/* 4 seconds or 400 10ms intervals */
name|uint32_t
name|data
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|signature
operator|=
literal|0xcafe0000
operator||
literal|0x0100
operator||
name|ha
operator|->
name|pci_func
expr_stmt|;
name|ret
operator|=
name|qla_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q8_SEM5_LOCK
argument_list|,
literal|0
argument_list|,
operator|(
name|uint32_t
operator|)
name|ha
operator|->
name|pci_func
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: SEM5_LOCK lock failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
name|WRITE_OFFSET32
argument_list|(
name|ha
argument_list|,
name|Q8_NX_CDRP_SIGNATURE
argument_list|,
name|signature
argument_list|)
expr_stmt|;
name|WRITE_OFFSET32
argument_list|(
name|ha
argument_list|,
name|Q8_NX_CDRP_ARG1
argument_list|,
operator|(
name|cdrp
operator|->
name|cmd_arg1
operator|)
argument_list|)
expr_stmt|;
name|WRITE_OFFSET32
argument_list|(
name|ha
argument_list|,
name|Q8_NX_CDRP_ARG2
argument_list|,
operator|(
name|cdrp
operator|->
name|cmd_arg2
operator|)
argument_list|)
expr_stmt|;
name|WRITE_OFFSET32
argument_list|(
name|ha
argument_list|,
name|Q8_NX_CDRP_ARG3
argument_list|,
operator|(
name|cdrp
operator|->
name|cmd_arg3
operator|)
argument_list|)
expr_stmt|;
name|WRITE_OFFSET32
argument_list|(
name|ha
argument_list|,
name|Q8_NX_CDRP_CMD_RSP
argument_list|,
name|cdrp
operator|->
name|cmd
argument_list|)
expr_stmt|;
while|while
condition|(
name|count
condition|)
block|{
name|qla_mdelay
argument_list|(
name|__func__
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|data
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_NX_CDRP_CMD_RSP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
operator|(
name|data
operator|&
literal|0x80000000
operator|)
operator|)
condition|)
break|break;
name|count
operator|--
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|!
name|count
operator|)
operator|||
operator|(
name|data
operator|!=
literal|1
operator|)
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|cdrp
operator|->
name|rsp
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_NX_CDRP_CMD_RSP
argument_list|)
expr_stmt|;
name|cdrp
operator|->
name|rsp_arg1
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_NX_CDRP_ARG1
argument_list|)
expr_stmt|;
name|cdrp
operator|->
name|rsp_arg2
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_NX_CDRP_ARG2
argument_list|)
expr_stmt|;
name|cdrp
operator|->
name|rsp_arg3
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_NX_CDRP_ARG3
argument_list|)
expr_stmt|;
name|qla_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q8_SEM5_UNLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: "
literal|"cmd[0x%08x] = 0x%08x\n"
literal|"\tsig[0x%08x] = 0x%08x\n"
literal|"\targ1[0x%08x] = 0x%08x\n"
literal|"\targ2[0x%08x] = 0x%08x\n"
literal|"\targ3[0x%08x] = 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|Q8_NX_CDRP_CMD_RSP
argument_list|,
name|cdrp
operator|->
name|cmd
argument_list|,
name|Q8_NX_CDRP_SIGNATURE
argument_list|,
name|signature
argument_list|,
name|Q8_NX_CDRP_ARG1
argument_list|,
name|cdrp
operator|->
name|cmd_arg1
argument_list|,
name|Q8_NX_CDRP_ARG2
argument_list|,
name|cdrp
operator|->
name|cmd_arg2
argument_list|,
name|Q8_NX_CDRP_ARG3
argument_list|,
name|cdrp
operator|->
name|cmd_arg3
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: exit (ret = 0x%x)\n"
literal|"\t\t rsp = 0x%08x\n"
literal|"\t\t arg1 = 0x%08x\n"
literal|"\t\t arg2 = 0x%08x\n"
literal|"\t\t arg3 = 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|,
name|cdrp
operator|->
name|rsp
argument_list|,
name|cdrp
operator|->
name|rsp_arg1
argument_list|,
name|cdrp
operator|->
name|rsp_arg2
argument_list|,
name|cdrp
operator|->
name|rsp_arg3
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|QLA_TX_MIN_FREE
value|2
end_define

begin_comment
comment|/*  * Name: qla_fw_cmd  * Function: Issues firmware control commands on the Tx Ring.  */
end_comment

begin_function
specifier|static
name|int
name|qla_fw_cmd
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|void
modifier|*
name|fw_cmd
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|q80_tx_cmd_t
modifier|*
name|tx_cmd
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|int
name|count
init|=
literal|100
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|QLA_TX_LOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|txr_free
operator|<=
name|QLA_TX_MIN_FREE
condition|)
block|{
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|qla_hw_tx_done_locked
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|txr_free
operator|>
name|QLA_TX_MIN_FREE
condition|)
break|break;
name|QLA_TX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_mdelay
argument_list|(
name|__func__
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|QLA_TX_LOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hw
operator|->
name|txr_free
operator|<=
name|QLA_TX_MIN_FREE
condition|)
block|{
name|QLA_TX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: xmit queue full\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|tx_cmd
operator|=
operator|&
name|hw
operator|->
name|tx_ring_base
index|[
name|hw
operator|->
name|txr_next
index|]
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|fw_cmd
argument_list|,
name|tx_cmd
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|hw
operator|->
name|txr_next
operator|=
operator|(
name|hw
operator|->
name|txr_next
operator|+
literal|1
operator|)
operator|&
operator|(
name|NUM_TX_DESCRIPTORS
operator|-
literal|1
operator|)
expr_stmt|;
name|hw
operator|->
name|txr_free
operator|--
expr_stmt|;
name|QL_UPDATE_TX_PRODUCER_INDEX
argument_list|(
name|ha
argument_list|,
name|hw
operator|->
name|txr_next
argument_list|)
expr_stmt|;
name|QLA_TX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_config_rss  * Function: Configure RSS for the context/interface.  */
end_comment

begin_decl_stmt
specifier|const
name|uint64_t
name|rss_key
index|[]
init|=
block|{
literal|0xbeac01fa6a42b73bULL
block|,
literal|0x8030f20c77cb2da3ULL
block|,
literal|0xae7b30b4d0ca2bcbULL
block|,
literal|0x43a38fb04167253dULL
block|,
literal|0x255b0ec26d5a56daULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|qla_config_rss
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|)
block|{
name|qla_fw_cds_config_rss_t
name|rss_config
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|rss_config
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_fw_cds_config_rss_t
argument_list|)
argument_list|)
expr_stmt|;
name|rss_config
operator|.
name|hdr
operator|.
name|cmd
operator|=
name|Q8_FWCD_CNTRL_REQ
expr_stmt|;
name|rss_config
operator|.
name|hdr
operator|.
name|opcode
operator|=
name|Q8_FWCD_OPCODE_CONFIG_RSS
expr_stmt|;
name|rss_config
operator|.
name|hdr
operator|.
name|cntxt_id
operator|=
name|cntxt_id
expr_stmt|;
name|rss_config
operator|.
name|hash_type
operator|=
operator|(
name|Q8_FWCD_RSS_HASH_TYPE_IPV4_TCP_IP
operator||
name|Q8_FWCD_RSS_HASH_TYPE_IPV6_TCP_IP
operator|)
expr_stmt|;
name|rss_config
operator|.
name|flags
operator|=
name|Q8_FWCD_RSS_FLAGS_ENABLE_RSS
expr_stmt|;
name|rss_config
operator|.
name|ind_tbl_mask
operator|=
literal|0x7
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|rss_config
operator|.
name|rss_key
index|[
name|i
index|]
operator|=
name|rss_key
index|[
name|i
index|]
expr_stmt|;
name|ret
operator|=
name|qla_fw_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|rss_config
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_fw_cds_config_rss_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_config_intr_coalesce  * Function: Configure Interrupt Coalescing.  */
end_comment

begin_function
specifier|static
name|int
name|qla_config_intr_coalesce
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|,
name|int
name|tenable
parameter_list|)
block|{
name|qla_fw_cds_config_intr_coalesc_t
name|intr_coalesce
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|intr_coalesce
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_fw_cds_config_intr_coalesc_t
argument_list|)
argument_list|)
expr_stmt|;
name|intr_coalesce
operator|.
name|hdr
operator|.
name|cmd
operator|=
name|Q8_FWCD_CNTRL_REQ
expr_stmt|;
name|intr_coalesce
operator|.
name|hdr
operator|.
name|opcode
operator|=
name|Q8_FWCD_OPCODE_CONFIG_INTR_COALESCING
expr_stmt|;
name|intr_coalesce
operator|.
name|hdr
operator|.
name|cntxt_id
operator|=
name|cntxt_id
expr_stmt|;
name|intr_coalesce
operator|.
name|flags
operator|=
literal|0x04
expr_stmt|;
name|intr_coalesce
operator|.
name|max_rcv_pkts
operator|=
literal|256
expr_stmt|;
name|intr_coalesce
operator|.
name|max_rcv_usecs
operator|=
literal|3
expr_stmt|;
name|intr_coalesce
operator|.
name|max_snd_pkts
operator|=
literal|64
expr_stmt|;
name|intr_coalesce
operator|.
name|max_snd_usecs
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|tenable
condition|)
block|{
name|intr_coalesce
operator|.
name|usecs_to
operator|=
literal|1000
expr_stmt|;
comment|/* 1 millisecond */
name|intr_coalesce
operator|.
name|timer_type
operator|=
name|Q8_FWCMD_INTR_COALESC_TIMER_PERIODIC
expr_stmt|;
name|intr_coalesce
operator|.
name|sds_ring_bitmask
operator|=
name|Q8_FWCMD_INTR_COALESC_SDS_RING_0
expr_stmt|;
block|}
name|ret
operator|=
name|qla_fw_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|intr_coalesce
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_fw_cds_config_intr_coalesc_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_config_mac_addr  * Function: binds a MAC address to the context/interface.  *	Can be unicast, multicast or broadcast.  */
end_comment

begin_function
specifier|static
name|int
name|qla_config_mac_addr
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mac_addr
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|,
name|uint32_t
name|add_multi
parameter_list|)
block|{
name|qla_fw_cds_config_mac_addr_t
name|mac_config
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|//	device_printf(ha->pci_dev,
comment|//		"%s: mac_addr %02x:%02x:%02x:%02x:%02x:%02x\n", __func__,
comment|//		mac_addr[0], mac_addr[1], mac_addr[2],
comment|//		mac_addr[3], mac_addr[4], mac_addr[5]);
name|bzero
argument_list|(
operator|&
name|mac_config
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_fw_cds_config_mac_addr_t
argument_list|)
argument_list|)
expr_stmt|;
name|mac_config
operator|.
name|hdr
operator|.
name|cmd
operator|=
name|Q8_FWCD_CNTRL_REQ
expr_stmt|;
name|mac_config
operator|.
name|hdr
operator|.
name|opcode
operator|=
name|Q8_FWCD_OPCODE_CONFIG_MAC_ADDR
expr_stmt|;
name|mac_config
operator|.
name|hdr
operator|.
name|cntxt_id
operator|=
name|cntxt_id
expr_stmt|;
if|if
condition|(
name|add_multi
condition|)
name|mac_config
operator|.
name|cmd
operator|=
name|Q8_FWCD_ADD_MAC_ADDR
expr_stmt|;
else|else
name|mac_config
operator|.
name|cmd
operator|=
name|Q8_FWCD_DEL_MAC_ADDR
expr_stmt|;
name|bcopy
argument_list|(
name|mac_addr
argument_list|,
name|mac_config
operator|.
name|mac_addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qla_fw_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|mac_config
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_fw_cds_config_mac_addr_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_set_mac_rcv_mode  * Function: Enable/Disable AllMulticast and Promiscous Modes.  */
end_comment

begin_function
specifier|static
name|int
name|qla_set_mac_rcv_mode
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|,
name|uint32_t
name|mode
parameter_list|)
block|{
name|qla_set_mac_rcv_mode_t
name|rcv_mode
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|rcv_mode
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_set_mac_rcv_mode_t
argument_list|)
argument_list|)
expr_stmt|;
name|rcv_mode
operator|.
name|hdr
operator|.
name|cmd
operator|=
name|Q8_FWCD_CNTRL_REQ
expr_stmt|;
name|rcv_mode
operator|.
name|hdr
operator|.
name|opcode
operator|=
name|Q8_FWCD_OPCODE_CONFIG_MAC_RCV_MODE
expr_stmt|;
name|rcv_mode
operator|.
name|hdr
operator|.
name|cntxt_id
operator|=
name|cntxt_id
expr_stmt|;
name|rcv_mode
operator|.
name|mode
operator|=
name|mode
expr_stmt|;
name|ret
operator|=
name|qla_fw_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|rcv_mode
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_set_mac_rcv_mode_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|qla_set_promisc
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
operator|(
name|void
operator|)
name|qla_set_mac_rcv_mode
argument_list|(
name|ha
argument_list|,
operator|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
operator|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
argument_list|,
name|Q8_MAC_RCV_ENABLE_PROMISCUOUS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|qla_set_allmulti
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
operator|(
name|void
operator|)
name|qla_set_mac_rcv_mode
argument_list|(
name|ha
argument_list|,
operator|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
operator|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
argument_list|,
name|Q8_MAC_RCV_ENABLE_ALLMULTI
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|qla_reset_promisc_allmulti
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
operator|(
name|void
operator|)
name|qla_set_mac_rcv_mode
argument_list|(
name|ha
argument_list|,
operator|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
operator|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
argument_list|,
name|Q8_MAC_RCV_RESET_PROMISC_ALLMULTI
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_config_ipv4_addr  * Function: Configures the Destination IP Addr for LRO.  */
end_comment

begin_function
name|void
name|qla_config_ipv4_addr
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|ipv4_addr
parameter_list|)
block|{
name|qla_config_ipv4_t
name|ip_conf
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|ip_conf
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_config_ipv4_t
argument_list|)
argument_list|)
expr_stmt|;
name|ip_conf
operator|.
name|hdr
operator|.
name|cmd
operator|=
name|Q8_FWCD_CNTRL_REQ
expr_stmt|;
name|ip_conf
operator|.
name|hdr
operator|.
name|opcode
operator|=
name|Q8_FWCD_OPCODE_CONFIG_IPADDR
expr_stmt|;
name|ip_conf
operator|.
name|hdr
operator|.
name|cntxt_id
operator|=
operator|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
operator|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
expr_stmt|;
name|ip_conf
operator|.
name|cmd
operator|=
operator|(
name|uint64_t
operator|)
name|Q8_CONFIG_CMD_IP_ENABLE
expr_stmt|;
name|ip_conf
operator|.
name|ipv4_addr
operator|=
operator|(
name|uint64_t
operator|)
name|ipv4_addr
expr_stmt|;
operator|(
name|void
operator|)
name|qla_fw_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|ip_conf
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_config_ipv4_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Name: qla_tx_tso  * Function: Checks if the packet to be transmitted is a candidate for  *	Large TCP Segment Offload. If yes, the appropriate fields in the Tx  *	Ring Structure are plugged in.  */
end_comment

begin_function
specifier|static
name|int
name|qla_tx_tso
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|,
name|q80_tx_cmd_t
modifier|*
name|tx_cmd
parameter_list|,
name|uint8_t
modifier|*
name|hdr
parameter_list|)
block|{
name|struct
name|ether_vlan_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
init|=
name|NULL
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|th
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|ehdrlen
decl_stmt|,
name|hdrlen
init|=
literal|0
decl_stmt|,
name|ip_hlen
decl_stmt|,
name|tcp_hlen
decl_stmt|,
name|tcp_opt_off
decl_stmt|;
name|uint16_t
name|etype
decl_stmt|,
name|opcode
decl_stmt|,
name|offload
init|=
literal|1
decl_stmt|;
name|uint8_t
modifier|*
name|tcp_opt
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|mp
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_encap_proto
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|etype
condition|)
block|{
case|case
name|ETHERTYPE_IP
case|:
name|tcp_opt_off
operator|=
name|ehdrlen
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
name|tcp_opt_off
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
literal|0
argument_list|,
name|tcp_opt_off
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|hdr
expr_stmt|;
block|}
else|else
block|{
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
block|}
name|ip_hlen
operator|=
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
expr_stmt|;
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_TCP_LSO
expr_stmt|;
if|if
condition|(
operator|(
name|ip
operator|->
name|ip_p
operator|!=
name|IPPROTO_TCP
operator|)
operator|||
operator|(
name|ip_hlen
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|)
condition|)
block|{
name|offload
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ip
operator|+
name|ip_hlen
operator|)
expr_stmt|;
block|}
break|break;
default|default:
name|QL_DPRINT8
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: type!=ip\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|offload
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|offload
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|tcp_hlen
operator|=
name|th
operator|->
name|th_off
operator|<<
literal|2
expr_stmt|;
name|hdrlen
operator|=
name|ehdrlen
operator|+
name|ip_hlen
operator|+
name|tcp_hlen
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
name|hdrlen
condition|)
block|{
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
name|tcp_opt_off
condition|)
block|{
if|if
condition|(
name|tcp_hlen
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
name|tcp_opt_off
argument_list|,
operator|(
name|tcp_hlen
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
operator|)
argument_list|,
operator|&
name|hdr
index|[
name|tcp_opt_off
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
literal|0
argument_list|,
name|hdrlen
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* If TCP options are preset only time stamp option is supported */
if|if
condition|(
operator|(
name|tcp_hlen
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
operator|)
operator|!=
literal|10
condition|)
return|return
operator|-
literal|1
return|;
else|else
block|{
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
name|hdrlen
condition|)
block|{
name|tcp_opt
operator|=
operator|&
name|hdr
index|[
name|tcp_opt_off
index|]
expr_stmt|;
block|}
else|else
block|{
name|tcp_opt
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|tcp_opt_off
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|tcp_opt
operator|!=
literal|0x01
operator|)
operator|||
operator|(
operator|*
operator|(
name|tcp_opt
operator|+
literal|1
operator|)
operator|!=
literal|0x01
operator|)
operator|||
operator|(
operator|*
operator|(
name|tcp_opt
operator|+
literal|2
operator|)
operator|!=
literal|0x08
operator|)
operator|||
operator|(
operator|*
operator|(
name|tcp_opt
operator|+
literal|2
operator|)
operator|!=
literal|10
operator|)
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
name|tx_cmd
operator|->
name|mss
operator|=
name|ha
operator|->
name|max_frame_size
operator|-
name|ETHER_CRC_LEN
operator|-
name|hdrlen
expr_stmt|;
block|}
else|else
block|{
name|tx_cmd
operator|->
name|mss
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
expr_stmt|;
block|}
name|tx_cmd
operator|->
name|flags_opcode
operator|=
name|opcode
expr_stmt|;
name|tx_cmd
operator|->
name|tcp_hdr_off
operator|=
name|ip_hlen
operator|+
name|ehdrlen
expr_stmt|;
name|tx_cmd
operator|->
name|ip_hdr_off
operator|=
name|ehdrlen
expr_stmt|;
name|tx_cmd
operator|->
name|mss
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
expr_stmt|;
name|tx_cmd
operator|->
name|total_hdr_len
operator|=
name|hdrlen
expr_stmt|;
comment|/* Check for Multicast least significant bit of MSB == 1 */
if|if
condition|(
name|eh
operator|->
name|evl_dhost
index|[
literal|0
index|]
operator|&
literal|0x01
condition|)
block|{
name|tx_cmd
operator|->
name|flags_opcode
operator|=
name|Q8_TX_CMD_FLAGS_MULTICAST
expr_stmt|;
block|}
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
name|hdrlen
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_tx_chksum  * Function: Checks if the packet to be transmitted is a candidate for  *	TCP/UDP Checksum offload. If yes, the appropriate fields in the Tx  *	Ring Structure are plugged in.  */
end_comment

begin_function
specifier|static
name|int
name|qla_tx_chksum
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|,
name|q80_tx_cmd_t
modifier|*
name|tx_cmd
parameter_list|)
block|{
name|struct
name|ether_vlan_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
name|uint32_t
name|ehdrlen
decl_stmt|,
name|ip_hlen
decl_stmt|;
name|uint16_t
name|etype
decl_stmt|,
name|opcode
decl_stmt|,
name|offload
init|=
literal|1
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
if|if
condition|(
operator|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|eh
operator|=
name|mtod
argument_list|(
name|mp
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_encap_proto
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|etype
condition|)
block|{
case|case
name|ETHERTYPE_IP
case|:
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|ip_hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
operator|(
name|ehdrlen
operator|+
name|ip_hlen
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: ipv4 mlen\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|offload
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_TCP
condition|)
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_TCP_CHKSUM
expr_stmt|;
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
condition|)
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_UDP_CHKSUM
expr_stmt|;
else|else
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: ipv4\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|offload
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|ETHERTYPE_IPV6
case|:
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|ip_hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
operator|(
name|ehdrlen
operator|+
name|ip_hlen
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: ipv6 mlen\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|offload
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ip6
operator|->
name|ip6_nxt
operator|==
name|IPPROTO_TCP
condition|)
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_TCP_CHKSUM_IPV6
expr_stmt|;
elseif|else
if|if
condition|(
name|ip6
operator|->
name|ip6_nxt
operator|==
name|IPPROTO_UDP
condition|)
name|opcode
operator|=
name|Q8_TX_CMD_OP_XMT_UDP_CHKSUM_IPV6
expr_stmt|;
else|else
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: ipv6\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|offload
operator|=
literal|0
expr_stmt|;
block|}
break|break;
default|default:
name|offload
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|offload
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|tx_cmd
operator|->
name|flags_opcode
operator|=
name|opcode
expr_stmt|;
name|tx_cmd
operator|->
name|tcp_hdr_off
operator|=
name|ip_hlen
operator|+
name|ehdrlen
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_hw_send  * Function: Transmits a packet. It first checks if the packet is a  *	candidate for Large TCP Segment Offload and then for UDP/TCP checksum  *	offload. If either of these creteria are not met, it is transmitted  *	as a regular ethernet frame.  */
end_comment

begin_function
name|int
name|qla_hw_send
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|uint32_t
modifier|*
name|tx_idx
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|)
block|{
name|struct
name|ether_vlan_header
modifier|*
name|eh
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|q80_tx_cmd_t
modifier|*
name|tx_cmd
decl_stmt|,
name|tso_cmd
decl_stmt|;
name|bus_dma_segment_t
modifier|*
name|c_seg
decl_stmt|;
name|uint32_t
name|num_tx_cmds
decl_stmt|,
name|hdr_len
init|=
literal|0
decl_stmt|;
name|uint32_t
name|total_length
init|=
literal|0
decl_stmt|,
name|bytes
decl_stmt|,
name|tx_cmd_count
init|=
literal|0
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|uint8_t
modifier|*
name|src
init|=
name|NULL
decl_stmt|,
modifier|*
name|dst
init|=
name|NULL
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
comment|/* 	 * Always make sure there is atleast one empty slot in the tx_ring 	 * tx_ring is considered full when there only one entry available 	 */
name|num_tx_cmds
operator|=
operator|(
name|nsegs
operator|+
operator|(
name|Q8_TX_CMD_MAX_SEGMENTS
operator|-
literal|1
operator|)
operator|)
operator|>>
literal|2
expr_stmt|;
name|total_length
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|total_length
operator|>
name|QLA_MAX_TSO_FRAME_SIZE
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: total length exceeds maxlen(%d)\n"
argument_list|,
name|__func__
argument_list|,
name|total_length
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|eh
operator|=
name|mtod
argument_list|(
name|mp
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|ha
operator|->
name|max_frame_size
operator|)
operator|||
operator|(
name|nsegs
operator|>
name|Q8_TX_MAX_SEGMENTS
operator|)
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|tso_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
name|src
operator|=
name|ha
operator|->
name|hw
operator|.
name|frame_hdr
expr_stmt|;
name|ret
operator|=
name|qla_tx_tso
argument_list|(
name|ha
argument_list|,
name|mp
argument_list|,
operator|&
name|tso_cmd
argument_list|,
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ret
operator|&
operator|~
literal|1
operator|)
condition|)
block|{
comment|/* find the additional tx_cmd descriptors required */
name|hdr_len
operator|=
name|tso_cmd
operator|.
name|total_hdr_len
expr_stmt|;
name|bytes
operator|=
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
operator|-
name|Q8_TX_CMD_TSO_ALIGN
expr_stmt|;
name|bytes
operator|=
name|QL_MIN
argument_list|(
name|bytes
argument_list|,
name|hdr_len
argument_list|)
expr_stmt|;
name|num_tx_cmds
operator|++
expr_stmt|;
name|hdr_len
operator|-=
name|bytes
expr_stmt|;
while|while
condition|(
name|hdr_len
condition|)
block|{
name|bytes
operator|=
name|QL_MIN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
operator|)
argument_list|,
name|hdr_len
argument_list|)
expr_stmt|;
name|hdr_len
operator|-=
name|bytes
expr_stmt|;
name|num_tx_cmds
operator|++
expr_stmt|;
block|}
name|hdr_len
operator|=
name|tso_cmd
operator|.
name|total_hdr_len
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|src
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|eh
expr_stmt|;
block|}
block|}
if|if
condition|(
name|hw
operator|->
name|txr_free
operator|<=
operator|(
name|num_tx_cmds
operator|+
name|QLA_TX_MIN_FREE
operator|)
condition|)
block|{
name|qla_hw_tx_done_locked
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|txr_free
operator|<=
operator|(
name|num_tx_cmds
operator|+
name|QLA_TX_MIN_FREE
operator|)
condition|)
block|{
name|QL_DPRINT8
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: (hw->txr_free<= "
literal|"(num_tx_cmds + QLA_TX_MIN_FREE))\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
operator|*
name|tx_idx
operator|=
name|hw
operator|->
name|txr_next
expr_stmt|;
name|tx_cmd
operator|=
operator|&
name|hw
operator|->
name|tx_ring_base
index|[
name|hw
operator|->
name|txr_next
index|]
expr_stmt|;
if|if
condition|(
name|hdr_len
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|nsegs
operator|>
name|Q8_TX_MAX_SEGMENTS
operator|)
operator|||
operator|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|ha
operator|->
name|max_frame_size
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: (nsegs[%d, %d, 0x%b]> Q8_TX_MAX_SEGMENTS)\n"
argument_list|,
name|__func__
argument_list|,
name|nsegs
argument_list|,
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
operator|(
name|int
operator|)
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
argument_list|,
name|CSUM_BITS
argument_list|)
expr_stmt|;
name|qla_dump_buf8
argument_list|(
name|ha
argument_list|,
literal|"qla_hw_send: wrong pkt"
argument_list|,
name|mtod
argument_list|(
name|mp
argument_list|,
name|char
operator|*
argument_list|)
argument_list|,
name|mp
operator|->
name|m_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qla_tx_chksum
argument_list|(
name|ha
argument_list|,
name|mp
argument_list|,
name|tx_cmd
argument_list|)
operator|!=
literal|0
condition|)
name|tx_cmd
operator|->
name|flags_opcode
operator|=
name|Q8_TX_CMD_OP_XMT_ETHER
expr_stmt|;
block|}
else|else
block|{
name|bcopy
argument_list|(
operator|&
name|tso_cmd
argument_list|,
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
name|tx_cmd
operator|->
name|flags_opcode
operator||=
name|Q8_TX_CMD_FLAGS_VLAN_TAGGED
expr_stmt|;
elseif|else
if|if
condition|(
name|mp
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
block|{
name|tx_cmd
operator|->
name|flags_opcode
operator||=
operator|(
name|Q8_TX_CMD_FLAGS_VLAN_TAGGED
operator||
name|Q8_TX_CMD_FLAGS_HW_VLAN_ID
operator|)
expr_stmt|;
name|tx_cmd
operator|->
name|vlan_tci
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
expr_stmt|;
block|}
name|tx_cmd
operator|->
name|n_bufs
operator|=
operator|(
name|uint8_t
operator|)
name|nsegs
expr_stmt|;
name|tx_cmd
operator|->
name|data_len_lo
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|total_length
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|tx_cmd
operator|->
name|data_len_hi
operator|=
name|qla_host_to_le16
argument_list|(
operator|(
call|(
name|uint16_t
call|)
argument_list|(
name|total_length
operator|>>
literal|8
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|tx_cmd
operator|->
name|port_cntxtid
operator|=
name|Q8_TX_CMD_PORT_CNXTID
argument_list|(
name|ha
operator|->
name|pci_func
argument_list|)
expr_stmt|;
name|c_seg
operator|=
name|segs
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
operator|(
name|i
operator|<
name|Q8_TX_CMD_MAX_SEGMENTS
operator|)
operator|&&
name|nsegs
operator|)
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|0
case|:
name|tx_cmd
operator|->
name|buf1_addr
operator|=
name|c_seg
operator|->
name|ds_addr
expr_stmt|;
name|tx_cmd
operator|->
name|buf1_len
operator|=
name|c_seg
operator|->
name|ds_len
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|tx_cmd
operator|->
name|buf2_addr
operator|=
name|c_seg
operator|->
name|ds_addr
expr_stmt|;
name|tx_cmd
operator|->
name|buf2_len
operator|=
name|c_seg
operator|->
name|ds_len
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tx_cmd
operator|->
name|buf3_addr
operator|=
name|c_seg
operator|->
name|ds_addr
expr_stmt|;
name|tx_cmd
operator|->
name|buf3_len
operator|=
name|c_seg
operator|->
name|ds_len
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tx_cmd
operator|->
name|buf4_addr
operator|=
name|c_seg
operator|->
name|ds_addr
expr_stmt|;
name|tx_cmd
operator|->
name|buf4_len
operator|=
name|c_seg
operator|->
name|ds_len
expr_stmt|;
break|break;
block|}
name|c_seg
operator|++
expr_stmt|;
name|nsegs
operator|--
expr_stmt|;
block|}
name|hw
operator|->
name|txr_next
operator|=
operator|(
name|hw
operator|->
name|txr_next
operator|+
literal|1
operator|)
operator|&
operator|(
name|NUM_TX_DESCRIPTORS
operator|-
literal|1
operator|)
expr_stmt|;
name|tx_cmd_count
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|nsegs
condition|)
break|break;
name|tx_cmd
operator|=
operator|&
name|hw
operator|->
name|tx_ring_base
index|[
name|hw
operator|->
name|txr_next
index|]
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hdr_len
condition|)
block|{
comment|/* TSO : Copy the header in the following tx cmd descriptors */
name|tx_cmd
operator|=
operator|&
name|hw
operator|->
name|tx_ring_base
index|[
name|hw
operator|->
name|txr_next
index|]
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
name|bytes
operator|=
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
operator|-
name|Q8_TX_CMD_TSO_ALIGN
expr_stmt|;
name|bytes
operator|=
name|QL_MIN
argument_list|(
name|bytes
argument_list|,
name|hdr_len
argument_list|)
expr_stmt|;
name|dst
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|tx_cmd
operator|+
name|Q8_TX_CMD_TSO_ALIGN
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
block|{
comment|/* first copy the src/dst MAC addresses */
name|bcopy
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
operator|(
name|ETHER_ADDR_LEN
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|dst
operator|+=
operator|(
name|ETHER_ADDR_LEN
operator|*
literal|2
operator|)
expr_stmt|;
name|src
operator|+=
operator|(
name|ETHER_ADDR_LEN
operator|*
literal|2
operator|)
expr_stmt|;
name|hdr_len
operator|-=
operator|(
name|ETHER_ADDR_LEN
operator|*
literal|2
operator|)
expr_stmt|;
operator|*
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|dst
operator|)
operator|=
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
expr_stmt|;
name|dst
operator|+=
literal|2
expr_stmt|;
operator|*
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|dst
operator|)
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
expr_stmt|;
name|dst
operator|+=
literal|2
expr_stmt|;
name|bytes
operator|-=
operator|(
operator|(
name|ETHER_ADDR_LEN
operator|*
literal|2
operator|)
operator|+
literal|4
operator|)
expr_stmt|;
name|bcopy
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|src
operator|+=
name|bytes
expr_stmt|;
name|hdr_len
operator|-=
name|bytes
expr_stmt|;
block|}
else|else
block|{
name|bcopy
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|src
operator|+=
name|bytes
expr_stmt|;
name|hdr_len
operator|-=
name|bytes
expr_stmt|;
block|}
name|hw
operator|->
name|txr_next
operator|=
operator|(
name|hw
operator|->
name|txr_next
operator|+
literal|1
operator|)
operator|&
operator|(
name|NUM_TX_DESCRIPTORS
operator|-
literal|1
operator|)
expr_stmt|;
name|tx_cmd_count
operator|++
expr_stmt|;
while|while
condition|(
name|hdr_len
condition|)
block|{
name|tx_cmd
operator|=
operator|&
name|hw
operator|->
name|tx_ring_base
index|[
name|hw
operator|->
name|txr_next
index|]
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
name|tx_cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
name|bytes
operator|=
name|QL_MIN
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|q80_tx_cmd_t
argument_list|)
operator|)
argument_list|,
name|hdr_len
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|src
argument_list|,
name|tx_cmd
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|src
operator|+=
name|bytes
expr_stmt|;
name|hdr_len
operator|-=
name|bytes
expr_stmt|;
name|hw
operator|->
name|txr_next
operator|=
operator|(
name|hw
operator|->
name|txr_next
operator|+
literal|1
operator|)
operator|&
operator|(
name|NUM_TX_DESCRIPTORS
operator|-
literal|1
operator|)
expr_stmt|;
name|tx_cmd_count
operator|++
expr_stmt|;
block|}
block|}
name|hw
operator|->
name|txr_free
operator|=
name|hw
operator|->
name|txr_free
operator|-
name|tx_cmd_count
expr_stmt|;
name|QL_UPDATE_TX_PRODUCER_INDEX
argument_list|(
name|ha
argument_list|,
name|hw
operator|->
name|txr_next
argument_list|)
expr_stmt|;
name|QL_DPRINT8
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: return\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_del_hw_if  * Function: Destroys the hardware specific entities corresponding to an  *	Ethernet Interface  */
end_comment

begin_function
name|void
name|qla_del_hw_if
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
name|QL_DISABLE_INTERRUPTS
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|qla_del_rcv_cntxt
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_del_xmt_cntxt
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|lro
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_init_hw_if  * Function: Creates the hardware specific entities corresponding to an  *	Ethernet Interface - Transmit and Receive Contexts. Sets the MAC Address  *	corresponding to the interface. Enables LRO if allowed.  */
end_comment

begin_function
name|int
name|qla_init_hw_if
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint8_t
name|bcast_mac
index|[
literal|6
index|]
decl_stmt|;
name|qla_get_hw_caps
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|bzero
argument_list|(
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|dma_b
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|dma_buf
operator|.
name|sds_ring
index|[
name|i
index|]
operator|.
name|size
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Create Receive Context 	 */
if|if
condition|(
name|qla_init_rcv_cntxt
argument_list|(
name|ha
argument_list|)
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ha
operator|->
name|hw
operator|.
name|rx_next
operator|=
name|NUM_RX_DESCRIPTORS
operator|-
literal|2
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|rxj_next
operator|=
name|NUM_RX_JUMBO_DESCRIPTORS
operator|-
literal|2
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|rx_in
operator|=
name|ha
operator|->
name|hw
operator|.
name|rxj_in
operator|=
literal|0
expr_stmt|;
comment|/* Update the RDS Producer Indices */
name|QL_UPDATE_RDS_PRODUCER_INDEX
argument_list|(
name|ha
argument_list|,
literal|0
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|rx_next
argument_list|)
expr_stmt|;
name|QL_UPDATE_RDS_PRODUCER_INDEX
argument_list|(
name|ha
argument_list|,
literal|1
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|rxj_next
argument_list|)
expr_stmt|;
comment|/* 	 * Create Transmit Context 	 */
if|if
condition|(
name|qla_init_xmt_cntxt
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|qla_del_rcv_cntxt
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|hw
operator|.
name|mac_addr
argument_list|,
operator|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
operator|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bcast_mac
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|1
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|2
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|3
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|4
index|]
operator|=
literal|0xFF
expr_stmt|;
name|bcast_mac
index|[
literal|5
index|]
operator|=
literal|0xFF
expr_stmt|;
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|bcast_mac
argument_list|,
operator|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
operator|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|qla_config_rss
argument_list|(
name|ha
argument_list|,
operator|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
operator|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
argument_list|)
expr_stmt|;
name|qla_config_intr_coalesce
argument_list|(
name|ha
argument_list|,
operator|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
operator|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
name|QL_ENABLE_INTERRUPTS
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_init_rcv_cntxt  * Function: Creates the Receive Context.  */
end_comment

begin_function
specifier|static
name|int
name|qla_init_rcv_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|q80_rcv_cntxt_rsp_t
modifier|*
name|rsp
decl_stmt|;
name|q80_stat_desc_t
modifier|*
name|sdesc
decl_stmt|;
name|bus_addr_t
name|phys_addr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
comment|/* 	 * Create Receive Context 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|sdesc
operator|=
operator|(
name|q80_stat_desc_t
operator|*
operator|)
operator|&
name|hw
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|sds_ring_base
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NUM_STATUS_DESCRIPTORS
condition|;
name|j
operator|++
control|)
block|{
name|sdesc
operator|->
name|data
index|[
literal|0
index|]
operator|=
name|Q8_STAT_DESC_SET_OWNER
argument_list|(
name|Q8_STAT_DESC_OWNER_FW
argument_list|)
expr_stmt|;
block|}
block|}
name|phys_addr
operator|=
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_req_paddr
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_CREATE_RX_CNTXT
expr_stmt|;
name|cdrp
operator|.
name|cmd_arg1
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|phys_addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd_arg2
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|phys_addr
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd_arg3
operator|=
call|(
name|uint32_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|q80_rcv_cntxt_req_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_CREATE_RX_CNTXT failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|rsp
operator|=
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: rcv cntxt successful"
literal|" rds_ring_offset = 0x%08x"
literal|" sds_ring_offset = 0x%08x"
literal|" cntxt_state = 0x%08x"
literal|" funcs_per_port = 0x%08x"
literal|" num_rds_rings = 0x%04x"
literal|" num_sds_rings = 0x%04x"
literal|" cntxt_id = 0x%04x"
literal|" phys_port = 0x%02x"
literal|" virt_port = 0x%02x\n"
operator|,
name|__func__
operator|,
name|rsp
operator|->
name|rx_rsp
operator|.
name|rds_ring_offset
operator|,
name|rsp
operator|->
name|rx_rsp
operator|.
name|sds_ring_offset
operator|,
name|rsp
operator|->
name|rx_rsp
operator|.
name|cntxt_state
operator|,
name|rsp
operator|->
name|rx_rsp
operator|.
name|funcs_per_port
operator|,
name|rsp
operator|->
name|rx_rsp
operator|.
name|num_rds_rings
operator|,
name|rsp
operator|->
name|rx_rsp
operator|.
name|num_sds_rings
operator|,
name|rsp
operator|->
name|rx_rsp
operator|.
name|cntxt_id
operator|,
name|rsp
operator|->
name|rx_rsp
operator|.
name|phys_port
operator|,
name|rsp
operator|->
name|rx_rsp
operator|.
name|virt_port
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_rds_rings
condition|;
name|i
operator|++
control|)
block|{
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: rcv cntxt rds[%i].producer_reg = 0x%08x\n"
operator|,
name|__func__
operator|,
name|i
operator|,
name|rsp
operator|->
name|rds_rsp
index|[
name|i
index|]
operator|.
name|producer_reg
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: rcv cntxt sds[%i].consumer_reg = 0x%08x"
literal|" sds[%i].intr_mask_reg = 0x%08x\n"
operator|,
name|__func__
operator|,
name|i
operator|,
name|rsp
operator|->
name|sds_rsp
index|[
name|i
index|]
operator|.
name|consumer_reg
operator|,
name|i
operator|,
name|rsp
operator|->
name|sds_rsp
index|[
name|i
index|]
operator|.
name|intr_mask_reg
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_rx_cnxt
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_del_rcv_cntxt  * Function: Destroys the Receive Context.  */
end_comment

begin_function
name|void
name|qla_del_rcv_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
if|if
condition|(
operator|!
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_rx_cnxt
condition|)
return|return;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_DESTROY_RX_CNTXT
expr_stmt|;
name|cdrp
operator|.
name|cmd_arg1
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
argument_list|)
operator|->
name|rx_rsp
operator|.
name|cntxt_id
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_DESTROY_RX_CNTXT failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_rx_cnxt
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_init_xmt_cntxt  * Function: Creates the Transmit Context.  */
end_comment

begin_function
specifier|static
name|int
name|qla_init_xmt_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|bus_addr_t
name|phys_addr
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|q80_tx_cntxt_rsp_t
modifier|*
name|tx_rsp
decl_stmt|;
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
comment|/* 	 * Create Transmit Context 	 */
name|phys_addr
operator|=
name|ha
operator|->
name|hw
operator|.
name|tx_cntxt_req_paddr
expr_stmt|;
name|tx_rsp
operator|=
name|ha
operator|->
name|hw
operator|.
name|tx_cntxt_rsp
expr_stmt|;
name|hw
operator|->
name|txr_comp
operator|=
name|hw
operator|->
name|txr_next
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
name|hw
operator|->
name|tx_cons
operator|)
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_CREATE_TX_CNTXT
expr_stmt|;
name|cdrp
operator|.
name|cmd_arg1
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|phys_addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd_arg2
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|phys_addr
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd_arg3
operator|=
call|(
name|uint32_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|q80_tx_cntxt_req_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_CREATE_TX_CNTXT failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|ha
operator|->
name|hw
operator|.
name|tx_prod_reg
operator|=
name|tx_rsp
operator|->
name|producer_reg
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: tx cntxt successful"
literal|" cntxt_state = 0x%08x "
literal|" cntxt_id = 0x%04x "
literal|" phys_port_id = 0x%02x "
literal|" virt_port_id = 0x%02x "
literal|" producer_reg = 0x%08x "
literal|" intr_mask_reg = 0x%08x\n"
operator|,
name|__func__
operator|,
name|tx_rsp
operator|->
name|cntxt_state
operator|,
name|tx_rsp
operator|->
name|cntxt_id
operator|,
name|tx_rsp
operator|->
name|phys_port_id
operator|,
name|tx_rsp
operator|->
name|virt_port_id
operator|,
name|tx_rsp
operator|->
name|producer_reg
operator|,
name|tx_rsp
operator|->
name|intr_mask_reg
operator|)
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|txr_free
operator|=
name|NUM_TX_DESCRIPTORS
expr_stmt|;
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_tx_cnxt
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_del_xmt_cntxt  * Function: Destroys the Transmit Context.  */
end_comment

begin_function
specifier|static
name|void
name|qla_del_xmt_cntxt
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
if|if
condition|(
operator|!
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_tx_cnxt
condition|)
return|return;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_DESTROY_TX_CNTXT
expr_stmt|;
name|cdrp
operator|.
name|cmd_arg1
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|ha
operator|->
name|hw
operator|.
name|tx_cntxt_rsp
argument_list|)
operator|->
name|cntxt_id
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_DESTROY_TX_CNTXT failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|init_tx_cnxt
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_get_max_rds  * Function: Returns the maximum number of Receive Descriptor Rings per context.  */
end_comment

begin_function
specifier|static
name|int
name|qla_get_max_rds
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_RD_MAX_RDS_PER_CNTXT
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_RD_MAX_RDS_PER_CNTXT failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|ha
operator|->
name|hw
operator|.
name|max_rds_per_cntxt
operator|=
name|cdrp
operator|.
name|rsp_arg1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: max_rds_per_context 0x%08x\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|hw
operator|.
name|max_rds_per_cntxt
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_get_max_sds  * Function: Returns the maximum number of Status Descriptor Rings per context.  */
end_comment

begin_function
specifier|static
name|int
name|qla_get_max_sds
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_RD_MAX_SDS_PER_CNTXT
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_RD_MAX_RDS_PER_CNTXT failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|ha
operator|->
name|hw
operator|.
name|max_sds_per_cntxt
operator|=
name|cdrp
operator|.
name|rsp_arg1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: max_sds_per_context 0x%08x\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|hw
operator|.
name|max_sds_per_cntxt
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_get_max_rules  * Function: Returns the maximum number of Rules per context.  */
end_comment

begin_function
specifier|static
name|int
name|qla_get_max_rules
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_RD_MAX_RULES_PER_CNTXT
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_RD_MAX_RULES_PER_CNTXT failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|ha
operator|->
name|hw
operator|.
name|max_rules_per_cntxt
operator|=
name|cdrp
operator|.
name|rsp_arg1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: max_rules_per_cntxt 0x%08x\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|hw
operator|.
name|max_rules_per_cntxt
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_get_max_rcv_cntxts  * Function: Returns the maximum number of Receive Contexts supported.  */
end_comment

begin_function
specifier|static
name|int
name|qla_get_max_rcv_cntxts
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_RD_MAX_RX_CNTXT
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_RD_MAX_RX_CNTXT failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|ha
operator|->
name|hw
operator|.
name|max_rcv_cntxts
operator|=
name|cdrp
operator|.
name|rsp_arg1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: max_rcv_cntxts 0x%08x\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|hw
operator|.
name|max_rcv_cntxts
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_get_max_tx_cntxts  * Function: Returns the maximum number of Transmit Contexts supported.  */
end_comment

begin_function
specifier|static
name|int
name|qla_get_max_tx_cntxts
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_RD_MAX_TX_CNTXT
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_RD_MAX_TX_CNTXT failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|ha
operator|->
name|hw
operator|.
name|max_xmt_cntxts
operator|=
name|cdrp
operator|.
name|rsp_arg1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: max_xmt_cntxts 0x%08x\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|hw
operator|.
name|max_xmt_cntxts
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_get_max_mtu  * Function: Returns the MTU supported for a context.  */
end_comment

begin_function
specifier|static
name|int
name|qla_get_max_mtu
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_RD_MAX_MTU
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_RD_MAX_MTU failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|ha
operator|->
name|hw
operator|.
name|max_mtu
operator|=
name|cdrp
operator|.
name|rsp_arg1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: max_mtu 0x%08x\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|hw
operator|.
name|max_mtu
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_set_max_mtu  * Function:  *	Sets the maximum transfer unit size for the specified rcv context.  */
end_comment

begin_function
name|int
name|qla_set_max_mtu
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|mtu
parameter_list|,
name|uint16_t
name|cntxt_id
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_SET_MTU
expr_stmt|;
name|cdrp
operator|.
name|cmd_arg1
operator|=
operator|(
name|uint32_t
operator|)
name|cntxt_id
expr_stmt|;
name|cdrp
operator|.
name|cmd_arg2
operator|=
name|mtu
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_RD_MAX_MTU failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|ha
operator|->
name|hw
operator|.
name|max_mtu
operator|=
name|cdrp
operator|.
name|rsp_arg1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_get_max_lro  * Function: Returns the maximum number of TCP Connection which can be supported  *	with LRO.  */
end_comment

begin_function
specifier|static
name|int
name|qla_get_max_lro
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_RD_MAX_LRO
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_RD_MAX_LRO failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|ha
operator|->
name|hw
operator|.
name|max_lro
operator|=
name|cdrp
operator|.
name|rsp_arg1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: max_lro 0x%08x\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|hw
operator|.
name|max_lro
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_get_flow_control  * Function: Returns the Receive/Transmit Flow Control (PAUSE) settings for  *	PCI function.  */
end_comment

begin_function
specifier|static
name|int
name|qla_get_flow_control
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_cdrp_t
name|cdrp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|cdrp
argument_list|,
sizeof|sizeof
argument_list|(
name|qla_cdrp_t
argument_list|)
argument_list|)
expr_stmt|;
name|cdrp
operator|.
name|cmd
operator|=
name|Q8_CMD_GET_FLOW_CNTRL
expr_stmt|;
if|if
condition|(
name|qla_issue_cmd
argument_list|(
name|ha
argument_list|,
operator|&
name|cdrp
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Q8_CMD_GET_FLOW_CNTRL failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: flow control 0x%08x\n"
operator|,
name|__func__
operator|,
name|cdrp
operator|.
name|rsp_arg1
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qla_get_flow_control  * Function: Retrieves hardware capabilities  */
end_comment

begin_function
name|void
name|qla_get_hw_caps
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
comment|//qla_read_mac_addr(ha);
name|qla_get_max_rds
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_get_max_sds
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_get_max_rules
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_get_max_rcv_cntxts
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_get_max_tx_cntxts
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_get_max_mtu
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_get_max_lro
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qla_get_flow_control
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Name: qla_hw_set_multi  * Function: Sets the Multicast Addresses provided the host O.S into the  *	hardware (for the given interface)  */
end_comment

begin_function
name|void
name|qla_hw_set_multi
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|,
name|uint32_t
name|mcnt
parameter_list|,
name|uint32_t
name|add_multi
parameter_list|)
block|{
name|q80_rcv_cntxt_rsp_t
modifier|*
name|rsp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rsp
operator|=
name|ha
operator|->
name|hw
operator|.
name|rx_cntxt_rsp
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mcnt
condition|;
name|i
operator|++
control|)
block|{
name|qla_config_mac_addr
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|,
name|rsp
operator|->
name|rx_rsp
operator|.
name|cntxt_id
argument_list|,
name|add_multi
argument_list|)
expr_stmt|;
name|mta
operator|+=
name|Q8_MAC_ADDR_LEN
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  * Name: qla_hw_tx_done_locked  * Function: Handle Transmit Completions  */
end_comment

begin_function
specifier|static
name|void
name|qla_hw_tx_done_locked
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qla_tx_buf_t
modifier|*
name|txb
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|uint32_t
name|comp_idx
decl_stmt|,
name|comp_count
init|=
literal|0
decl_stmt|;
comment|/* retrieve index of last entry in tx ring completed */
name|comp_idx
operator|=
name|qla_le32_to_host
argument_list|(
operator|*
operator|(
name|hw
operator|->
name|tx_cons
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|comp_idx
operator|!=
name|hw
operator|->
name|txr_comp
condition|)
block|{
name|txb
operator|=
operator|&
name|ha
operator|->
name|tx_buf
index|[
name|hw
operator|->
name|txr_comp
index|]
expr_stmt|;
name|hw
operator|->
name|txr_comp
operator|++
expr_stmt|;
if|if
condition|(
name|hw
operator|->
name|txr_comp
operator|==
name|NUM_TX_DESCRIPTORS
condition|)
name|hw
operator|->
name|txr_comp
operator|=
literal|0
expr_stmt|;
name|comp_count
operator|++
expr_stmt|;
if|if
condition|(
name|txb
operator|->
name|m_head
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|txb
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|txb
operator|->
name|map
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|txb
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|txb
operator|->
name|m_head
argument_list|)
expr_stmt|;
name|txb
operator|->
name|map
operator|=
operator|(
name|bus_dmamap_t
operator|)
literal|0
expr_stmt|;
name|txb
operator|->
name|m_head
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|hw
operator|->
name|txr_free
operator|+=
name|comp_count
expr_stmt|;
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: return [c,f, p, pn][%d, %d, %d, %d]\n"
operator|,
name|__func__
operator|,
name|hw
operator|->
name|txr_comp
operator|,
name|hw
operator|->
name|txr_free
operator|,
name|hw
operator|->
name|txr_next
operator|,
name|READ_REG32
argument_list|(
name|ha
argument_list|,
operator|(
name|ha
operator|->
name|hw
operator|.
name|tx_prod_reg
operator|+
literal|0x1b2000
operator|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Name: qla_hw_tx_done  * Function: Handle Transmit Completions  */
end_comment

begin_function
name|void
name|qla_hw_tx_done
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
if|if
condition|(
operator|!
name|mtx_trylock
argument_list|(
operator|&
name|ha
operator|->
name|tx_lock
argument_list|)
condition|)
block|{
name|QL_DPRINT8
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: !mtx_trylock(&ha->tx_lock)\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|qla_hw_tx_done_locked
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|txr_free
operator|>
name|free_pkt_thres
condition|)
name|ha
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|ha
operator|->
name|tx_lock
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|qla_update_link_state
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|link_state
decl_stmt|;
name|uint32_t
name|prev_link_state
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ha
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|link_up
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|link_state
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q8_LINK_STATE
argument_list|)
expr_stmt|;
name|prev_link_state
operator|=
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|link_up
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|pci_func
operator|==
literal|0
condition|)
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|link_up
operator|=
operator|(
operator|(
operator|(
name|link_state
operator|&
literal|0xF
operator|)
operator|==
literal|1
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
else|else
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|link_up
operator|=
operator|(
operator|(
operator|(
operator|(
name|link_state
operator|>>
literal|4
operator|)
operator|&
literal|0xF
operator|)
operator|==
literal|1
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|prev_link_state
operator|!=
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|link_up
condition|)
block|{
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|flags
operator|.
name|link_up
condition|)
block|{
name|if_link_state_change
argument_list|(
name|ha
operator|->
name|ifp
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|if_link_state_change
argument_list|(
name|ha
operator|->
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|qla_config_lro
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|struct
name|lro_ctrl
modifier|*
name|lro
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|lro
operator|=
operator|&
name|hw
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|lro
expr_stmt|;
if|if
condition|(
name|tcp_lro_init
argument_list|(
name|lro
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: tcp_lro_init failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|lro
operator|->
name|ifp
operator|=
name|ha
operator|->
name|ifp
expr_stmt|;
block|}
name|ha
operator|->
name|flags
operator|.
name|lro_init
operator|=
literal|1
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: LRO initialized\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|qla_free_lro
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|qla_hw_t
modifier|*
name|hw
init|=
operator|&
name|ha
operator|->
name|hw
decl_stmt|;
name|struct
name|lro_ctrl
modifier|*
name|lro
decl_stmt|;
if|if
condition|(
operator|!
name|ha
operator|->
name|flags
operator|.
name|lro_init
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw
operator|->
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
name|lro
operator|=
operator|&
name|hw
operator|->
name|sds
index|[
name|i
index|]
operator|.
name|lro
expr_stmt|;
name|tcp_lro_free
argument_list|(
name|lro
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|flags
operator|.
name|lro_init
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|qla_hw_stop_rcv
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|done
decl_stmt|,
name|count
init|=
literal|100
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|done
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|hw
operator|.
name|num_sds_rings
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ha
operator|->
name|hw
operator|.
name|sds
index|[
name|i
index|]
operator|.
name|rcv_active
condition|)
name|done
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|done
condition|)
break|break;
else|else
name|qla_mdelay
argument_list|(
name|__func__
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2007-2010 Damien Bergamini<damien.bergamini@free.fr>  * Copyright (c) 2012 Bernhard Schmidt<bschmidt@FreeBSD.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $OpenBSD: rt2860.c,v 1.65 2010/10/23 14:24:54 damien Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*-  * Ralink Technology RT2860/RT3090/RT3390/RT3562 chipset driver  * http://www.ralinktech.com/  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_regdomain.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ratectl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<dev/ral/rt2860reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ral/rt2860var.h>
end_include

begin_define
define|#
directive|define
name|RAL_DEBUG
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|RAL_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
value|do { if (sc->sc_debug> 0) printf x; } while (0)
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
value|do { if (sc->sc_debug>= (n)) printf x; } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|rt2860_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
specifier|const
name|char
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
parameter_list|,
name|enum
name|ieee80211_opmode
parameter_list|,
name|int
parameter_list|,
specifier|const
name|uint8_t
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_dma_map_addr
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_alloc_tx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|struct
name|rt2860_tx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_reset_tx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|struct
name|rt2860_tx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_free_tx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|struct
name|rt2860_tx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_alloc_tx_pool
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_free_tx_pool
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_alloc_rx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|struct
name|rt2860_rx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_reset_rx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|struct
name|rt2860_rx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_free_rx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|struct
name|rt2860_rx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_updatestats
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_newassoc
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_node_free
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|IEEE80211_HT
end_ifdef

begin_function_decl
specifier|static
name|int
name|rt2860_ampdu_rx_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_ampdu_rx_stop
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|rt2860_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|enum
name|ieee80211_state
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|rt3090_efuse_read_2
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|rt2860_eeprom_read_2
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_intr_coherent
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_drain_stats_fifo
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_tx_intr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_rx_intr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_tbtt_intr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_gp_intr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_tx
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_tx_raw
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_watchdog
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_mcu_bbp_write
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|rt2860_mcu_bbp_read
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_rf_write
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|rt3090_rf_read
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt3090_rf_write
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_mcu_cmd
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint16_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_enable_mrr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_set_txpreamble
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_set_basicrates
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_rateset
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_select_chan_group
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_set_chan
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt3090_set_chan
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt3090_rf_init
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt3090_rf_wakeup
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt3090_filter_calib
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt3090_rf_setup
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_set_leds
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_set_gp_timer
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_set_bssid
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_set_macaddr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_update_promisc
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_updateslot
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_updateprot
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_updateedca
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|HW_CRYPTO
end_ifdef

begin_function_decl
specifier|static
name|int
name|rt2860_set_key
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_delete_key
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int8_t
name|rt2860_rssi2dbm
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|rt2860_get_rf
parameter_list|(
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_read_eeprom
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|uint8_t
name|macaddr
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_bbp_init
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_txrx_enable
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_init_locked
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_stop
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_stop_locked
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_load_microcode
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|NOT_YET
end_ifdef

begin_function_decl
specifier|static
name|void
name|rt2860_calib
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|rt3090_set_rx_antenna
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_switch_chan
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rt2860_setup_beacon
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rt2860_enable_tsf_sync
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint32_t
name|reg
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
block|}
name|rt2860_def_mac
index|[]
init|=
block|{
name|RT2860_DEF_MAC
block|}
struct|;
end_struct

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint8_t
name|reg
decl_stmt|;
name|uint8_t
name|val
decl_stmt|;
block|}
name|rt2860_def_bbp
index|[]
init|=
block|{
name|RT2860_DEF_BBP
block|}
struct|;
end_struct

begin_struct
specifier|static
specifier|const
struct|struct
name|rfprog
block|{
name|uint8_t
name|chan
decl_stmt|;
name|uint32_t
name|r1
decl_stmt|,
name|r2
decl_stmt|,
name|r3
decl_stmt|,
name|r4
decl_stmt|;
block|}
name|rt2860_rf2850
index|[]
init|=
block|{
name|RT2860_RF2850
block|}
struct|;
end_struct

begin_struct
struct|struct
block|{
name|uint8_t
name|n
decl_stmt|,
name|r
decl_stmt|,
name|k
decl_stmt|;
block|}
name|rt3090_freqs
index|[]
init|=
block|{
name|RT3070_RF3052
block|}
struct|;
end_struct

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint8_t
name|reg
decl_stmt|;
name|uint8_t
name|val
decl_stmt|;
block|}
name|rt3090_def_rf
index|[]
init|=
block|{
name|RT3070_DEF_RF
block|}
struct|;
end_struct

begin_function
name|int
name|rt2860_attach
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ntries
decl_stmt|,
name|qid
decl_stmt|;
name|uint8_t
name|bands
decl_stmt|;
name|uint8_t
name|macaddr
index|[
name|IEEE80211_ADDR_LEN
index|]
decl_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|sc_debug
operator|=
literal|0
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|sc_ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_IEEE80211
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can not if_alloc()\n"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ic
operator|=
name|ifp
operator|->
name|if_l2com
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
operator||
name|MTX_RECURSE
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|watchdog_ch
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* wait for NIC to initialize */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_ASIC_VER_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|!=
literal|0
operator|&&
name|tmp
operator|!=
literal|0xffffffff
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for NIC to initialize\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|sc
operator|->
name|mac_ver
operator|=
name|tmp
operator|>>
literal|16
expr_stmt|;
name|sc
operator|->
name|mac_rev
operator|=
name|tmp
operator|&
literal|0xffff
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|!=
literal|0x2860
operator|&&
operator|(
name|id
operator|==
literal|0x0681
operator|||
name|id
operator|==
literal|0x0781
operator|||
name|id
operator|==
literal|0x1059
operator|)
condition|)
name|sc
operator|->
name|sc_flags
operator||=
name|RT2860_ADVANCED_PS
expr_stmt|;
comment|/* retrieve RF rev. no and various other things from EEPROM */
name|rt2860_read_eeprom
argument_list|(
name|sc
argument_list|,
name|macaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MAC/BBP RT%X (rev 0x%04X), "
literal|"RF %s (MIMO %dT%dR), address %6D\n"
argument_list|,
name|sc
operator|->
name|mac_ver
argument_list|,
name|sc
operator|->
name|mac_rev
argument_list|,
name|rt2860_get_rf
argument_list|(
name|sc
operator|->
name|rf_rev
argument_list|)
argument_list|,
name|sc
operator|->
name|ntxchains
argument_list|,
name|sc
operator|->
name|nrxchains
argument_list|,
name|macaddr
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Allocate Tx (4 EDCAs + HCCA + Mgt) and Rx rings. 	 */
for|for
control|(
name|qid
operator|=
literal|0
init|;
name|qid
operator|<
literal|6
condition|;
name|qid
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|rt2860_alloc_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
index|[
name|qid
index|]
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate Tx ring %d\n"
argument_list|,
name|qid
argument_list|)
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|rt2860_alloc_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rxq
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate Rx ring\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|rt2860_alloc_tx_pool
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate Tx pool\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
comment|/* mgmt ring is broken on RT2860C, use EDCA AC VO ring instead */
name|sc
operator|->
name|mgtqid
operator|=
operator|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x2860
operator|&&
name|sc
operator|->
name|mac_rev
operator|==
literal|0x0100
operator|)
condition|?
name|WME_AC_VO
else|:
literal|5
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|rt2860_init
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|rt2860_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|rt2860_start
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|ifqmaxlen
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|ifqmaxlen
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_ifp
operator|=
name|ifp
expr_stmt|;
name|ic
operator|->
name|ic_opmode
operator|=
name|IEEE80211_M_STA
expr_stmt|;
name|ic
operator|->
name|ic_phytype
operator|=
name|IEEE80211_T_OFDM
expr_stmt|;
comment|/* not only, but not used */
comment|/* set device capabilities */
name|ic
operator|->
name|ic_caps
operator|=
name|IEEE80211_C_STA
comment|/* station mode */
operator||
name|IEEE80211_C_IBSS
comment|/* ibss, nee adhoc, mode */
operator||
name|IEEE80211_C_HOSTAP
comment|/* hostap mode */
operator||
name|IEEE80211_C_MONITOR
comment|/* monitor mode */
operator||
name|IEEE80211_C_AHDEMO
comment|/* adhoc demo mode */
operator||
name|IEEE80211_C_WDS
comment|/* 4-address traffic works */
operator||
name|IEEE80211_C_MBSS
comment|/* mesh point link mode */
operator||
name|IEEE80211_C_SHPREAMBLE
comment|/* short preamble supported */
operator||
name|IEEE80211_C_SHSLOT
comment|/* short slot time supported */
operator||
name|IEEE80211_C_WPA
comment|/* capable of WPA1+WPA2 */
if|#
directive|if
literal|0
expr|| IEEE80211_C_BGSCAN
comment|/* capable of bg scanning */
endif|#
directive|endif
operator||
name|IEEE80211_C_WME
comment|/* 802.11e */
expr_stmt|;
name|bands
operator|=
literal|0
expr_stmt|;
name|setbit
argument_list|(
operator|&
name|bands
argument_list|,
name|IEEE80211_MODE_11B
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
operator|&
name|bands
argument_list|,
name|IEEE80211_MODE_11G
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rf_rev
operator|==
name|RT2860_RF_2750
operator|||
name|sc
operator|->
name|rf_rev
operator|==
name|RT2860_RF_2850
condition|)
name|setbit
argument_list|(
operator|&
name|bands
argument_list|,
name|IEEE80211_MODE_11A
argument_list|)
expr_stmt|;
name|ieee80211_init_channels
argument_list|(
name|ic
argument_list|,
name|NULL
argument_list|,
operator|&
name|bands
argument_list|)
expr_stmt|;
name|ieee80211_ifattach
argument_list|(
name|ic
argument_list|,
name|macaddr
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_wme
operator|.
name|wme_update
operator|=
name|rt2860_updateedca
expr_stmt|;
name|ic
operator|->
name|ic_scan_start
operator|=
name|rt2860_scan_start
expr_stmt|;
name|ic
operator|->
name|ic_scan_end
operator|=
name|rt2860_scan_end
expr_stmt|;
name|ic
operator|->
name|ic_set_channel
operator|=
name|rt2860_set_channel
expr_stmt|;
name|ic
operator|->
name|ic_updateslot
operator|=
name|rt2860_updateslot
expr_stmt|;
name|ic
operator|->
name|ic_update_promisc
operator|=
name|rt2860_update_promisc
expr_stmt|;
name|ic
operator|->
name|ic_raw_xmit
operator|=
name|rt2860_raw_xmit
expr_stmt|;
name|sc
operator|->
name|sc_node_free
operator|=
name|ic
operator|->
name|ic_node_free
expr_stmt|;
name|ic
operator|->
name|ic_node_free
operator|=
name|rt2860_node_free
expr_stmt|;
name|ic
operator|->
name|ic_newassoc
operator|=
name|rt2860_newassoc
expr_stmt|;
name|ic
operator|->
name|ic_vap_create
operator|=
name|rt2860_vap_create
expr_stmt|;
name|ic
operator|->
name|ic_vap_delete
operator|=
name|rt2860_vap_delete
expr_stmt|;
name|ieee80211_radiotap_attach
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|sc_txtap
operator|.
name|wt_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_txtap
argument_list|)
argument_list|,
name|RT2860_TX_RADIOTAP_PRESENT
argument_list|,
operator|&
name|sc
operator|->
name|sc_rxtap
operator|.
name|wr_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_rxtap
argument_list|)
argument_list|,
name|RT2860_RX_RADIOTAP_PRESENT
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RAL_DEBUG
name|SYSCTL_ADD_INT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"debug"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|sc
operator|->
name|sc_debug
argument_list|,
literal|0
argument_list|,
literal|"debug msgs"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bootverbose
condition|)
name|ieee80211_announce
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail3
label|:
name|rt2860_free_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rxq
argument_list|)
expr_stmt|;
name|fail2
label|:
while|while
condition|(
operator|--
name|qid
operator|>=
literal|0
condition|)
name|rt2860_free_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
index|[
name|qid
index|]
argument_list|)
expr_stmt|;
name|fail1
label|:
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|rt2860_detach
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|int
name|qid
decl_stmt|;
name|RAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ieee80211_ifdetach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
for|for
control|(
name|qid
operator|=
literal|0
init|;
name|qid
operator|<
literal|6
condition|;
name|qid
operator|++
control|)
name|rt2860_free_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
index|[
name|qid
index|]
argument_list|)
expr_stmt|;
name|rt2860_free_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rxq
argument_list|)
expr_stmt|;
name|rt2860_free_tx_pool
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|rt2860_shutdown
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|rt2860_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rt2860_suspend
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|rt2860_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rt2860_resume
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
name|rt2860_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|rt2860_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
specifier|const
name|char
name|name
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
name|unit
parameter_list|,
name|enum
name|ieee80211_opmode
name|opmode
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|uint8_t
name|bssid
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ic
operator|->
name|ic_ifp
decl_stmt|;
name|struct
name|rt2860_vap
modifier|*
name|rvp
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
switch|switch
condition|(
name|opmode
condition|)
block|{
case|case
name|IEEE80211_M_STA
case|:
case|case
name|IEEE80211_M_IBSS
case|:
case|case
name|IEEE80211_M_AHDEMO
case|:
case|case
name|IEEE80211_M_MONITOR
case|:
case|case
name|IEEE80211_M_HOSTAP
case|:
case|case
name|IEEE80211_M_MBSS
case|:
comment|/* XXXRP: TBD */
if|if
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"only 1 vap supported\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|opmode
operator|==
name|IEEE80211_M_STA
condition|)
name|flags
operator||=
name|IEEE80211_CLONE_NOBEACONS
expr_stmt|;
break|break;
case|case
name|IEEE80211_M_WDS
case|:
if|if
condition|(
name|TAILQ_EMPTY
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
operator|||
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_HOSTAP
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"wds only supported in ap mode\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 		 * Silently remove any request for a unique 		 * bssid; WDS vap's always share the local 		 * mac address. 		 */
name|flags
operator|&=
operator|~
name|IEEE80211_CLONE_BSSID
expr_stmt|;
break|break;
default|default:
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"unknown opmode %d\n"
argument_list|,
name|opmode
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|rvp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_vap
argument_list|)
argument_list|,
name|M_80211_VAP
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rvp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|vap
operator|=
operator|&
name|rvp
operator|->
name|ral_vap
expr_stmt|;
name|ieee80211_vap_setup
argument_list|(
name|ic
argument_list|,
name|vap
argument_list|,
name|name
argument_list|,
name|unit
argument_list|,
name|opmode
argument_list|,
name|flags
argument_list|,
name|bssid
argument_list|,
name|mac
argument_list|)
expr_stmt|;
comment|/* override state transition machine */
name|rvp
operator|->
name|ral_newstate
operator|=
name|vap
operator|->
name|iv_newstate
expr_stmt|;
name|vap
operator|->
name|iv_newstate
operator|=
name|rt2860_newstate
expr_stmt|;
if|#
directive|if
literal|0
block|vap->iv_update_beacon = rt2860_beacon_update;
endif|#
directive|endif
comment|/* HW supports up to 255 STAs (0-254) in HostAP and IBSS modes */
name|vap
operator|->
name|iv_max_aid
operator|=
name|min
argument_list|(
name|IEEE80211_AID_MAX
argument_list|,
name|RT2860_WCID_MAX
argument_list|)
expr_stmt|;
name|ieee80211_ratectl_init
argument_list|(
name|vap
argument_list|)
expr_stmt|;
comment|/* complete setup */
name|ieee80211_vap_attach
argument_list|(
name|vap
argument_list|,
name|ieee80211_media_change
argument_list|,
name|ieee80211_media_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
operator|==
name|vap
condition|)
name|ic
operator|->
name|ic_opmode
operator|=
name|opmode
expr_stmt|;
return|return
name|vap
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|rt2860_vap
modifier|*
name|rvp
init|=
name|RT2860_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|ieee80211_ratectl_deinit
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|ieee80211_vap_detach
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_dma_map_addr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return;
name|KASSERT
argument_list|(
name|nseg
operator|==
literal|1
argument_list|,
operator|(
literal|"too many DMA segments, %d should be 1"
operator|,
name|nseg
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt2860_alloc_tx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt2860_tx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|int
name|size
decl_stmt|,
name|error
decl_stmt|;
name|size
operator|=
name|RT2860_TX_RING_COUNT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_txd
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|size
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ring
operator|->
name|desc_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create desc DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ring
operator|->
name|txd
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate DMA memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|,
name|ring
operator|->
name|txd
argument_list|,
name|size
argument_list|,
name|rt2860_dma_map_addr
argument_list|,
operator|&
name|ring
operator|->
name|paddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load desc DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
name|rt2860_free_tx_ring
argument_list|(
name|sc
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|void
name|rt2860_reset_tx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt2860_tx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|rt2860_tx_data
modifier|*
name|data
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT2860_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|data
operator|=
name|ring
operator|->
name|data
index|[
name|i
index|]
operator|)
operator|==
name|NULL
condition|)
continue|continue;
comment|/* nothing mapped in this slot */
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|ni
operator|!=
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|data
operator|->
name|ni
argument_list|)
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|ring
operator|->
name|data
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|ring
operator|->
name|queued
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
name|ring
operator|->
name|next
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rt2860_free_tx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt2860_tx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|rt2860_tx_data
modifier|*
name|data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ring
operator|->
name|txd
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|txd
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ring
operator|->
name|desc_dmat
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT2860_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|data
operator|=
name|ring
operator|->
name|data
index|[
name|i
index|]
operator|)
operator|==
name|NULL
condition|)
continue|continue;
comment|/* nothing mapped in this slot */
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|ni
operator|!=
name|NULL
condition|)
name|ieee80211_free_node
argument_list|(
name|data
operator|->
name|ni
argument_list|)
expr_stmt|;
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Allocate a pool of TX Wireless Information blocks.  */
end_comment

begin_function
name|int
name|rt2860_alloc_tx_pool
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|caddr_t
name|vaddr
decl_stmt|;
name|bus_addr_t
name|paddr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|size
decl_stmt|,
name|error
decl_stmt|;
name|size
operator|=
name|RT2860_TX_POOL_COUNT
operator|*
name|RT2860_TXWI_DMASZ
expr_stmt|;
comment|/* init data_pool early in case of failure.. */
name|SLIST_INIT
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|size
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|txwi_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create txwi DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|txwi_vaddr
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|sc
operator|->
name|txwi_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate DMA memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|sc
operator|->
name|txwi_map
argument_list|,
name|sc
operator|->
name|txwi_vaddr
argument_list|,
name|size
argument_list|,
name|rt2860_dma_map_addr
argument_list|,
operator|&
name|paddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load txwi DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|sc
operator|->
name|txwi_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|vaddr
operator|=
name|sc
operator|->
name|txwi_vaddr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT2860_TX_POOL_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|rt2860_tx_data
modifier|*
name|data
init|=
operator|&
name|sc
operator|->
name|data
index|[
name|i
index|]
decl_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
literal|0
argument_list|,
operator|&
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|data
operator|->
name|txwi
operator|=
operator|(
expr|struct
name|rt2860_txwi
operator|*
operator|)
name|vaddr
expr_stmt|;
name|data
operator|->
name|paddr
operator|=
name|paddr
expr_stmt|;
name|vaddr
operator|+=
name|RT2860_TXWI_DMASZ
expr_stmt|;
name|paddr
operator|+=
name|RT2860_TXWI_DMASZ
expr_stmt|;
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
name|fail
label|:
name|rt2860_free_tx_pool
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|void
name|rt2860_free_tx_pool
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|txwi_vaddr
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|sc
operator|->
name|txwi_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|sc
operator|->
name|txwi_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|sc
operator|->
name|txwi_vaddr
argument_list|,
name|sc
operator|->
name|txwi_map
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|txwi_dmat
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|SLIST_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|)
condition|)
block|{
name|struct
name|rt2860_tx_data
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|SLIST_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|rt2860_alloc_rx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt2860_rx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|bus_addr_t
name|physaddr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|size
decl_stmt|,
name|error
decl_stmt|;
name|size
operator|=
name|RT2860_RX_RING_COUNT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_rxd
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|size
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ring
operator|->
name|desc_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create desc DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ring
operator|->
name|rxd
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate DMA memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|,
name|ring
operator|->
name|rxd
argument_list|,
name|size
argument_list|,
name|rt2860_dma_map_addr
argument_list|,
operator|&
name|ring
operator|->
name|paddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load desc DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|MCLBYTES
argument_list|,
literal|1
argument_list|,
name|MCLBYTES
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ring
operator|->
name|data_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create data DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT2860_RX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|rt2860_rx_data
modifier|*
name|data
init|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
decl_stmt|;
name|struct
name|rt2860_rxd
modifier|*
name|rxd
init|=
operator|&
name|ring
operator|->
name|rxd
index|[
name|i
index|]
decl_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|ring
operator|->
name|data_dmat
argument_list|,
literal|0
argument_list|,
operator|&
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|data
operator|->
name|m
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate rx mbuf\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|ring
operator|->
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|mtod
argument_list|(
name|data
operator|->
name|m
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|MCLBYTES
argument_list|,
name|rt2860_dma_map_addr
argument_list|,
operator|&
name|physaddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load rx buf DMA map"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|rxd
operator|->
name|sdp0
operator|=
name|htole32
argument_list|(
name|physaddr
argument_list|)
expr_stmt|;
name|rxd
operator|->
name|sdl0
operator|=
name|htole16
argument_list|(
name|MCLBYTES
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
name|rt2860_free_rx_ring
argument_list|(
name|sc
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|void
name|rt2860_reset_rx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt2860_rx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT2860_RX_RING_COUNT
condition|;
name|i
operator|++
control|)
name|ring
operator|->
name|rxd
index|[
name|i
index|]
operator|.
name|sdl0
operator|&=
operator|~
name|htole16
argument_list|(
name|RT2860_RX_DDONE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rt2860_free_rx_ring
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rt2860_rx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ring
operator|->
name|rxd
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|rxd
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ring
operator|->
name|desc_dmat
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RT2860_RX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|rt2860_rx_data
modifier|*
name|data
init|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|map
operator|!=
name|NULL
condition|)
name|bus_dmamap_destroy
argument_list|(
name|ring
operator|->
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ring
operator|->
name|data_dmat
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|data_dmat
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_updatestats
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
comment|/* 	 * In IBSS or HostAP modes (when the hardware sends beacons), the 	 * MAC can run into a livelock and start sending CTS-to-self frames 	 * like crazy if protection is enabled.  Fortunately, we can detect 	 * when such a situation occurs and reset the MAC. 	 */
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|!=
name|IEEE80211_M_STA
condition|)
block|{
comment|/* check if we're in a livelock situation.. */
name|uint32_t
name|tmp
init|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_DEBUG
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
operator|(
literal|1
operator|<<
literal|29
operator|)
operator|)
operator|&&
operator|(
name|tmp
operator|&
operator|(
literal|1
operator|<<
literal|7
operator||
literal|1
operator|<<
literal|5
operator|)
operator|)
condition|)
block|{
comment|/* ..and reset MAC/BBP for a while.. */
name|DPRINTF
argument_list|(
operator|(
literal|"CTS-to-self livelock detected\n"
operator|)
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_MAC_SRST
argument_list|)
expr_stmt|;
name|RAL_BARRIER_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_MAC_RX_EN
operator||
name|RT2860_MAC_TX_EN
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_newassoc
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|int
name|isnew
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|uint8_t
name|wcid
decl_stmt|;
name|wcid
operator|=
name|IEEE80211_AID
argument_list|(
name|ni
operator|->
name|ni_associd
argument_list|)
expr_stmt|;
if|if
condition|(
name|isnew
operator|&&
name|ni
operator|->
name|ni_associd
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|wcid2ni
index|[
name|wcid
index|]
operator|=
name|ni
expr_stmt|;
comment|/* init WCID table entry */
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ENTRY
argument_list|(
name|wcid
argument_list|)
argument_list|,
name|ni
operator|->
name|ni_macaddr
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"new assoc isnew=%d addr=%s WCID=%d\n"
operator|,
name|isnew
operator|,
name|ether_sprintf
argument_list|(
name|ni
operator|->
name|ni_macaddr
argument_list|)
operator|,
name|wcid
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_node_free
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|uint8_t
name|wcid
decl_stmt|;
if|if
condition|(
name|ni
operator|->
name|ni_associd
operator|!=
literal|0
condition|)
block|{
name|wcid
operator|=
name|IEEE80211_AID
argument_list|(
name|ni
operator|->
name|ni_associd
argument_list|)
expr_stmt|;
comment|/* clear Rx WCID search table entry */
name|RAL_SET_REGION_4
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ENTRY
argument_list|(
name|wcid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_node_free
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|IEEE80211_HT
end_ifdef

begin_function
specifier|static
name|int
name|rt2860_ampdu_rx_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|uint8_t
name|tid
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|uint8_t
name|wcid
init|=
operator|(
operator|(
expr|struct
name|rt2860_node
operator|*
operator|)
name|ni
operator|)
operator|->
name|wcid
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
comment|/* update BA session mask */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ENTRY
argument_list|(
name|wcid
argument_list|)
operator|+
literal|4
argument_list|)
expr_stmt|;
name|tmp
operator||=
operator|(
literal|1
operator|<<
name|tid
operator|)
operator|<<
literal|16
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ENTRY
argument_list|(
name|wcid
argument_list|)
operator|+
literal|4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_ampdu_rx_stop
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|uint8_t
name|tid
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|uint8_t
name|wcid
init|=
operator|(
operator|(
expr|struct
name|rt2860_node
operator|*
operator|)
name|ni
operator|)
operator|->
name|wcid
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
comment|/* update BA session mask */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ENTRY
argument_list|(
name|wcid
argument_list|)
operator|+
literal|4
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
name|tid
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ENTRY
argument_list|(
name|wcid
argument_list|)
operator|+
literal|4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|rt2860_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|enum
name|ieee80211_state
name|nstate
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|struct
name|rt2860_vap
modifier|*
name|rvp
init|=
name|RT2860_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
comment|/* turn link LED off */
name|rt2860_set_leds
argument_list|(
name|sc
argument_list|,
name|RT2860_LED_RADIO
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nstate
operator|==
name|IEEE80211_S_INIT
operator|&&
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
comment|/* abort TSF synchronization */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
name|tmp
operator|&
operator|~
operator|(
name|RT2860_BCN_TX_EN
operator||
name|RT2860_TSF_TIMER_EN
operator||
name|RT2860_TBTT_TIMER_EN
operator|)
argument_list|)
expr_stmt|;
block|}
name|rt2860_set_gp_timer
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|rvp
operator|->
name|ral_newstate
argument_list|(
name|vap
argument_list|,
name|nstate
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|nstate
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
name|struct
name|ieee80211_node
modifier|*
name|ni
init|=
name|vap
operator|->
name|iv_bss
decl_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_MONITOR
condition|)
block|{
name|rt2860_enable_mrr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_set_txpreamble
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_set_basicrates
argument_list|(
name|sc
argument_list|,
operator|&
name|ni
operator|->
name|ni_rates
argument_list|)
expr_stmt|;
name|rt2860_set_bssid
argument_list|(
name|sc
argument_list|,
name|ni
operator|->
name|ni_bssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_HOSTAP
operator|||
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_IBSS
operator|||
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_MBSS
condition|)
block|{
name|error
operator|=
name|rt2860_setup_beacon
argument_list|(
name|sc
argument_list|,
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
name|error
return|;
block|}
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_MONITOR
condition|)
block|{
name|rt2860_enable_tsf_sync
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_set_gp_timer
argument_list|(
name|sc
argument_list|,
literal|500
argument_list|)
expr_stmt|;
block|}
comment|/* turn link LED on */
name|rt2860_set_leds
argument_list|(
name|sc
argument_list|,
name|RT2860_LED_RADIO
operator||
operator|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|ni
operator|->
name|ni_chan
argument_list|)
condition|?
name|RT2860_LED_LINK_2GHZ
else|:
name|RT2860_LED_LINK_5GHZ
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/* Read 16-bit from eFUSE ROM (>=RT3071 only.) */
end_comment

begin_function
specifier|static
name|uint16_t
name|rt3090_efuse_read_2
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|uint16_t
name|reg
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|addr
operator|*=
literal|2
expr_stmt|;
comment|/*- 	 * Read one 16-byte block into registers EFUSE_DATA[0-3]: 	 * DATA0: F E D C 	 * DATA1: B A 9 8 	 * DATA2: 7 6 5 4 	 * DATA3: 3 2 1 0 	 */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT3070_EFUSE_CTRL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RT3070_EFSROM_MODE_MASK
operator||
name|RT3070_EFSROM_AIN_MASK
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|addr
operator|&
operator|~
literal|0xf
operator|)
operator|<<
name|RT3070_EFSROM_AIN_SHIFT
operator||
name|RT3070_EFSROM_KICK
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT3070_EFUSE_CTRL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|500
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT3070_EFUSE_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT3070_EFSROM_KICK
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|500
condition|)
return|return
literal|0xffff
return|;
if|if
condition|(
operator|(
name|tmp
operator|&
name|RT3070_EFUSE_AOUT_MASK
operator|)
operator|==
name|RT3070_EFUSE_AOUT_MASK
condition|)
return|return
literal|0xffff
return|;
comment|/* address not found */
comment|/* determine to which 32-bit register our 16-bit word belongs */
name|reg
operator|=
name|RT3070_EFUSE_DATA3
operator|-
operator|(
name|addr
operator|&
literal|0xc
operator|)
expr_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|(
name|addr
operator|&
literal|2
operator|)
condition|?
name|tmp
operator|>>
literal|16
else|:
name|tmp
operator|&
literal|0xffff
return|;
block|}
end_function

begin_comment
comment|/*  * Read 16 bits at address 'addr' from the serial EEPROM (either 93C46,  * 93C66 or 93C86).  */
end_comment

begin_function
specifier|static
name|uint16_t
name|rt2860_eeprom_read_2
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|int
name|n
decl_stmt|;
comment|/* clock C once before the first command */
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
argument_list|)
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
operator||
name|RT2860_C
argument_list|)
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
argument_list|)
expr_stmt|;
comment|/* write start bit (1) */
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
operator||
name|RT2860_D
argument_list|)
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
operator||
name|RT2860_D
operator||
name|RT2860_C
argument_list|)
expr_stmt|;
comment|/* write READ opcode (10) */
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
operator||
name|RT2860_D
argument_list|)
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
operator||
name|RT2860_D
operator||
name|RT2860_C
argument_list|)
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
argument_list|)
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
operator||
name|RT2860_C
argument_list|)
expr_stmt|;
comment|/* write address (A5-A0 or A7-A0) */
name|n
operator|=
operator|(
operator|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_PCI_EECTRL
argument_list|)
operator|&
literal|0x30
operator|)
operator|==
literal|0
operator|)
condition|?
literal|5
else|:
literal|7
expr_stmt|;
for|for
control|(
init|;
name|n
operator|>=
literal|0
condition|;
name|n
operator|--
control|)
block|{
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
operator||
operator|(
operator|(
operator|(
name|addr
operator|>>
name|n
operator|)
operator|&
literal|1
operator|)
operator|<<
name|RT2860_SHIFT_D
operator|)
argument_list|)
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
operator||
operator|(
operator|(
operator|(
name|addr
operator|>>
name|n
operator|)
operator|&
literal|1
operator|)
operator|<<
name|RT2860_SHIFT_D
operator|)
operator||
name|RT2860_C
argument_list|)
expr_stmt|;
block|}
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
argument_list|)
expr_stmt|;
comment|/* read data Q15-Q0 */
name|val
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|15
init|;
name|n
operator|>=
literal|0
condition|;
name|n
operator|--
control|)
block|{
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
operator||
name|RT2860_C
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_PCI_EECTRL
argument_list|)
expr_stmt|;
name|val
operator||=
operator|(
operator|(
name|tmp
operator|&
name|RT2860_Q
operator|)
operator|>>
name|RT2860_SHIFT_Q
operator|)
operator|<<
name|n
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
argument_list|)
expr_stmt|;
block|}
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* clear Chip Select and clock C */
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_S
argument_list|)
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RT2860_EEPROM_CTL
argument_list|(
name|sc
argument_list|,
name|RT2860_C
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|uint16_t
name|rt2860_srom_read
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|addr
parameter_list|)
block|{
comment|/* either eFUSE ROM or EEPROM */
return|return
name|sc
operator|->
name|sc_srom_read
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_intr_coherent
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
comment|/* DMA finds data coherent event when checking the DDONE bit */
name|DPRINTF
argument_list|(
operator|(
literal|"Tx/Rx Coherent interrupt\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* restart DMA engine */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RT2860_TX_WB_DDONE
operator||
name|RT2860_RX_DMA_EN
operator||
name|RT2860_TX_DMA_EN
operator|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|rt2860_txrx_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_drain_stats_fifo
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|uint32_t
name|stat
decl_stmt|;
name|int
name|retrycnt
decl_stmt|;
name|uint8_t
name|wcid
decl_stmt|,
name|mcs
decl_stmt|,
name|pid
decl_stmt|;
comment|/* drain Tx status FIFO (maxsize = 16) */
while|while
condition|(
operator|(
name|stat
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_STAT_FIFO
argument_list|)
operator|)
operator|&
name|RT2860_TXQ_VLD
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"tx stat 0x%08x\n"
operator|,
name|stat
operator|)
argument_list|)
expr_stmt|;
name|wcid
operator|=
operator|(
name|stat
operator|>>
name|RT2860_TXQ_WCID_SHIFT
operator|)
operator|&
literal|0xff
expr_stmt|;
name|ni
operator|=
name|sc
operator|->
name|wcid2ni
index|[
name|wcid
index|]
expr_stmt|;
comment|/* if no ACK was requested, no feedback is available */
if|if
condition|(
operator|!
operator|(
name|stat
operator|&
name|RT2860_TXQ_ACKREQ
operator|)
operator|||
name|wcid
operator|==
literal|0xff
operator|||
name|ni
operator|==
name|NULL
condition|)
continue|continue;
comment|/* update per-STA AMRR stats */
if|if
condition|(
name|stat
operator|&
name|RT2860_TXQ_OK
condition|)
block|{
comment|/* 			 * Check if there were retries, ie if the Tx success 			 * rate is different from the requested rate.  Note 			 * that it works only because we do not allow rate 			 * fallback from OFDM to CCK. 			 */
name|mcs
operator|=
operator|(
name|stat
operator|>>
name|RT2860_TXQ_MCS_SHIFT
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|pid
operator|=
operator|(
name|stat
operator|>>
name|RT2860_TXQ_PID_SHIFT
operator|)
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
name|mcs
operator|+
literal|1
operator|!=
name|pid
condition|)
name|retrycnt
operator|=
literal|1
expr_stmt|;
else|else
name|retrycnt
operator|=
literal|0
expr_stmt|;
name|ieee80211_ratectl_tx_complete
argument_list|(
name|ni
operator|->
name|ni_vap
argument_list|,
name|ni
argument_list|,
name|IEEE80211_RATECTL_TX_SUCCESS
argument_list|,
operator|&
name|retrycnt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ieee80211_ratectl_tx_complete
argument_list|(
name|ni
operator|->
name|ni_vap
argument_list|,
name|ni
argument_list|,
name|IEEE80211_RATECTL_TX_FAILURE
argument_list|,
operator|&
name|retrycnt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_tx_intr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|rt2860_tx_ring
modifier|*
name|ring
init|=
operator|&
name|sc
operator|->
name|txq
index|[
name|qid
index|]
decl_stmt|;
name|uint32_t
name|hw
decl_stmt|;
name|rt2860_drain_stats_fifo
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|hw
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_DTX_IDX
argument_list|(
name|qid
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|ring
operator|->
name|next
operator|!=
name|hw
condition|)
block|{
name|struct
name|rt2860_tx_data
modifier|*
name|data
init|=
name|ring
operator|->
name|data
index|[
name|ring
operator|->
name|next
index|]
decl_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|->
name|m_flags
operator|&
name|M_TXCB
condition|)
block|{
name|ieee80211_process_callback
argument_list|(
name|data
operator|->
name|ni
argument_list|,
name|data
operator|->
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|data
operator|->
name|ni
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|,
name|data
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|ring
operator|->
name|data
index|[
name|ring
operator|->
name|next
index|]
operator|=
name|NULL
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|ring
operator|->
name|queued
operator|--
expr_stmt|;
name|ring
operator|->
name|next
operator|=
operator|(
name|ring
operator|->
name|next
operator|+
literal|1
operator|)
operator|%
name|RT2860_TX_RING_COUNT
expr_stmt|;
block|}
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|queued
operator|<
name|RT2860_TX_RING_COUNT
condition|)
name|sc
operator|->
name|qfullmsk
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|qid
operator|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|rt2860_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Return the Rx chain with the highest RSSI for a given frame.  */
end_comment

begin_function
specifier|static
name|__inline
name|uint8_t
name|rt2860_maxrssi_chain
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|rt2860_rxwi
modifier|*
name|rxwi
parameter_list|)
block|{
name|uint8_t
name|rxchain
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|rxwi
operator|->
name|rssi
index|[
literal|1
index|]
operator|>
name|rxwi
operator|->
name|rssi
index|[
name|rxchain
index|]
condition|)
name|rxchain
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|>
literal|2
condition|)
if|if
condition|(
name|rxwi
operator|->
name|rssi
index|[
literal|2
index|]
operator|>
name|rxwi
operator|->
name|rssi
index|[
name|rxchain
index|]
condition|)
name|rxchain
operator|=
literal|2
expr_stmt|;
block|}
return|return
name|rxchain
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_rx_intr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|rt2860_rx_radiotap_header
modifier|*
name|tap
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m1
decl_stmt|;
name|bus_addr_t
name|physaddr
decl_stmt|;
name|uint32_t
name|hw
decl_stmt|;
name|uint16_t
name|phy
decl_stmt|;
name|uint8_t
name|ant
decl_stmt|;
name|int8_t
name|rssi
decl_stmt|,
name|nf
decl_stmt|;
name|int
name|error
decl_stmt|;
name|hw
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_FS_DRX_IDX
argument_list|)
operator|&
literal|0xfff
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|rxq
operator|.
name|cur
operator|!=
name|hw
condition|)
block|{
name|struct
name|rt2860_rx_data
modifier|*
name|data
init|=
operator|&
name|sc
operator|->
name|rxq
operator|.
name|data
index|[
name|sc
operator|->
name|rxq
operator|.
name|cur
index|]
decl_stmt|;
name|struct
name|rt2860_rxd
modifier|*
name|rxd
init|=
operator|&
name|sc
operator|->
name|rxq
operator|.
name|rxd
index|[
name|sc
operator|->
name|rxq
operator|.
name|cur
index|]
decl_stmt|;
name|struct
name|rt2860_rxwi
modifier|*
name|rxwi
decl_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|desc_dmat
argument_list|,
name|sc
operator|->
name|rxq
operator|.
name|desc_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
operator|!
operator|(
name|rxd
operator|->
name|sdl0
operator|&
name|htole16
argument_list|(
name|RT2860_RX_DDONE
argument_list|)
operator|)
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"RXD DDONE bit not set!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
comment|/* should not happen */
block|}
if|if
condition|(
name|__predict_false
argument_list|(
name|rxd
operator|->
name|flags
operator|&
name|htole32
argument_list|(
name|RT2860_RX_CRCERR
operator||
name|RT2860_RX_ICVERR
argument_list|)
argument_list|)
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
ifdef|#
directive|ifdef
name|HW_CRYPTO
if|if
condition|(
name|__predict_false
argument_list|(
name|rxd
operator|->
name|flags
operator|&
name|htole32
argument_list|(
name|RT2860_RX_MICERR
argument_list|)
argument_list|)
condition|)
block|{
comment|/* report MIC failures to net80211 for TKIP */
name|ic
operator|->
name|ic_stats
operator|.
name|is_rx_locmicfail
operator|++
expr_stmt|;
name|ieee80211_michael_mic_failure
argument_list|(
name|ic
argument_list|,
literal|0
comment|/* XXX */
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
endif|#
directive|endif
name|m1
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|m1
operator|==
name|NULL
argument_list|)
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|mtod
argument_list|(
name|m1
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|MCLBYTES
argument_list|,
name|rt2860_dma_map_addr
argument_list|,
operator|&
name|physaddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|error
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|m_freem
argument_list|(
name|m1
argument_list|)
expr_stmt|;
comment|/* try to reload the old mbuf */
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|mtod
argument_list|(
name|data
operator|->
name|m
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|MCLBYTES
argument_list|,
name|rt2860_dma_map_addr
argument_list|,
operator|&
name|physaddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|error
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|panic
argument_list|(
literal|"%s: could not load old rx mbuf"
argument_list|,
name|device_get_name
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* physical address may have changed */
name|rxd
operator|->
name|sdp0
operator|=
name|htole32
argument_list|(
name|physaddr
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
comment|/* 		 * New mbuf successfully loaded, update Rx ring and continue 		 * processing. 		 */
name|m
operator|=
name|data
operator|->
name|m
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|m1
expr_stmt|;
name|rxd
operator|->
name|sdp0
operator|=
name|htole32
argument_list|(
name|physaddr
argument_list|)
expr_stmt|;
name|rxwi
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|rt2860_rxwi
operator|*
argument_list|)
expr_stmt|;
comment|/* finalize mbuf */
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|m
operator|->
name|m_data
operator|=
call|(
name|caddr_t
call|)
argument_list|(
name|rxwi
operator|+
literal|1
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|le16toh
argument_list|(
name|rxwi
operator|->
name|len
argument_list|)
operator|&
literal|0xfff
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HW_CRYPTO
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
block|{
comment|/* frame is decrypted by hardware */
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&=
operator|~
name|IEEE80211_FC1_PROTECTED
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* HW may insert 2 padding bytes after 802.11 header */
if|if
condition|(
name|rxd
operator|->
name|flags
operator|&
name|htole32
argument_list|(
name|RT2860_RX_L2PAD
argument_list|)
condition|)
block|{
name|u_int
name|hdrlen
init|=
name|ieee80211_hdrsize
argument_list|(
name|wh
argument_list|)
decl_stmt|;
name|ovbcopy
argument_list|(
name|wh
argument_list|,
operator|(
name|caddr_t
operator|)
name|wh
operator|+
literal|2
argument_list|,
name|hdrlen
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_data
operator|+=
literal|2
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
block|}
name|ant
operator|=
name|rt2860_maxrssi_chain
argument_list|(
name|sc
argument_list|,
name|rxwi
argument_list|)
expr_stmt|;
name|rssi
operator|=
name|rt2860_rssi2dbm
argument_list|(
name|sc
argument_list|,
name|rxwi
operator|->
name|rssi
index|[
name|ant
index|]
argument_list|,
name|ant
argument_list|)
expr_stmt|;
name|nf
operator|=
name|RT2860_NOISE_FLOOR
expr_stmt|;
if|if
condition|(
name|ieee80211_radiotap_active
argument_list|(
name|ic
argument_list|)
condition|)
block|{
name|tap
operator|=
operator|&
name|sc
operator|->
name|sc_rxtap
expr_stmt|;
name|tap
operator|->
name|wr_flags
operator|=
literal|0
expr_stmt|;
name|tap
operator|->
name|wr_antenna
operator|=
name|ant
expr_stmt|;
name|tap
operator|->
name|wr_antsignal
operator|=
name|nf
operator|+
name|rssi
expr_stmt|;
name|tap
operator|->
name|wr_antnoise
operator|=
name|nf
expr_stmt|;
comment|/* in case it can't be found below */
name|tap
operator|->
name|wr_rate
operator|=
literal|2
expr_stmt|;
name|phy
operator|=
name|le16toh
argument_list|(
name|rxwi
operator|->
name|phy
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|phy
operator|&
name|RT2860_PHY_MODE
condition|)
block|{
case|case
name|RT2860_PHY_CCK
case|:
switch|switch
condition|(
operator|(
name|phy
operator|&
name|RT2860_PHY_MCS
operator|)
operator|&
operator|~
name|RT2860_PHY_SHPRE
condition|)
block|{
case|case
literal|0
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|11
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|22
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|phy
operator|&
name|RT2860_PHY_SHPRE
condition|)
name|tap
operator|->
name|wr_flags
operator||=
name|IEEE80211_RADIOTAP_F_SHORTPRE
expr_stmt|;
break|break;
case|case
name|RT2860_PHY_OFDM
case|:
switch|switch
condition|(
name|phy
operator|&
name|RT2860_PHY_MCS
condition|)
block|{
case|case
literal|0
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|12
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|18
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|24
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|36
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|48
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|72
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|96
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|108
expr_stmt|;
break|break;
block|}
break|break;
block|}
block|}
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
comment|/* send the frame to the 802.11 layer */
name|ni
operator|=
name|ieee80211_find_rxnode
argument_list|(
name|ic
argument_list|,
operator|(
expr|struct
name|ieee80211_frame_min
operator|*
operator|)
name|wh
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|ieee80211_input
argument_list|(
name|ni
argument_list|,
name|m
argument_list|,
name|rssi
operator|-
name|nf
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|ieee80211_input_all
argument_list|(
name|ic
argument_list|,
name|m
argument_list|,
name|rssi
operator|-
name|nf
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|RAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|skip
label|:
name|rxd
operator|->
name|sdl0
operator|&=
operator|~
name|htole16
argument_list|(
name|RT2860_RX_DDONE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|desc_dmat
argument_list|,
name|sc
operator|->
name|rxq
operator|.
name|desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rxq
operator|.
name|cur
operator|=
operator|(
name|sc
operator|->
name|rxq
operator|.
name|cur
operator|+
literal|1
operator|)
operator|%
name|RT2860_RX_RING_COUNT
expr_stmt|;
block|}
comment|/* tell HW what we have processed */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_RX_CALC_IDX
argument_list|,
operator|(
name|sc
operator|->
name|rxq
operator|.
name|cur
operator|-
literal|1
operator|)
operator|%
name|RT2860_RX_RING_COUNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_tbtt_intr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct ieee80211com *ic =&sc->sc_ic;
ifndef|#
directive|ifndef
name|IEEE80211_STA_ONLY
block|if (ic->ic_opmode == IEEE80211_M_HOSTAP) {
comment|/* one less beacon until next DTIM */
block|if (ic->ic_dtim_count == 0) 			ic->ic_dtim_count = ic->ic_dtim_period - 1; 		else 			ic->ic_dtim_count--;
comment|/* update dynamic parts of beacon */
block|rt2860_setup_beacon(sc);
comment|/* flush buffered multicast frames */
block|if (ic->ic_dtim_count == 0) 			ieee80211_notify_dtim(ic); 	}
endif|#
directive|endif
comment|/* check if protection mode has changed */
block|if ((sc->sc_ic_flags ^ ic->ic_flags)& IEEE80211_F_USEPROT) { 		rt2860_updateprot(ic); 		sc->sc_ic_flags = ic->ic_flags; 	}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_gp_intr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|sc
operator|->
name|sc_ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"GP timeout state=%d\n"
operator|,
name|vap
operator|->
name|iv_state
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_RUN
condition|)
name|rt2860_updatestats
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rt2860_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|uint32_t
name|r
decl_stmt|;
name|RAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|r
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|r
operator|==
literal|0xffffffff
argument_list|)
condition|)
block|{
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
comment|/* device likely went away */
block|}
if|if
condition|(
name|r
operator|==
literal|0
condition|)
block|{
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
comment|/* not for us */
block|}
comment|/* acknowledge interrupts */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_STATUS
argument_list|,
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_TX_RX_COHERENT
condition|)
name|rt2860_intr_coherent
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_MAC_INT_2
condition|)
comment|/* TX status */
name|rt2860_drain_stats_fifo
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_TX_DONE_INT5
condition|)
name|rt2860_tx_intr
argument_list|(
name|sc
argument_list|,
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_RX_DONE_INT
condition|)
name|rt2860_rx_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_TX_DONE_INT4
condition|)
name|rt2860_tx_intr
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_TX_DONE_INT3
condition|)
name|rt2860_tx_intr
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_TX_DONE_INT2
condition|)
name|rt2860_tx_intr
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_TX_DONE_INT1
condition|)
name|rt2860_tx_intr
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_TX_DONE_INT0
condition|)
name|rt2860_tx_intr
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_MAC_INT_0
condition|)
comment|/* TBTT */
name|rt2860_tbtt_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_MAC_INT_3
condition|)
comment|/* Auto wakeup */
comment|/* TBD wakeup */
empty_stmt|;
if|if
condition|(
name|r
operator|&
name|RT2860_MAC_INT_4
condition|)
comment|/* GP timer */
name|rt2860_gp_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt2860_tx
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|rt2860_tx_ring
modifier|*
name|ring
decl_stmt|;
name|struct
name|rt2860_tx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|rt2860_txd
modifier|*
name|txd
decl_stmt|;
name|struct
name|rt2860_txwi
modifier|*
name|txwi
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
specifier|const
name|struct
name|ieee80211_txparam
modifier|*
name|tp
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m1
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
name|RT2860_MAX_SCATTER
index|]
decl_stmt|;
name|bus_dma_segment_t
modifier|*
name|seg
decl_stmt|;
name|u_int
name|hdrlen
decl_stmt|;
name|uint16_t
name|qos
decl_stmt|,
name|dur
decl_stmt|;
name|uint8_t
name|type
decl_stmt|,
name|qsel
decl_stmt|,
name|mcs
decl_stmt|,
name|pid
decl_stmt|,
name|tid
decl_stmt|,
name|qid
decl_stmt|;
name|int
name|i
decl_stmt|,
name|nsegs
decl_stmt|,
name|ntxds
decl_stmt|,
name|pad
decl_stmt|,
name|rate
decl_stmt|,
name|ridx
decl_stmt|,
name|error
decl_stmt|;
comment|/* the data pool contains at least one element, pick the first */
name|data
operator|=
name|SLIST_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
block|{
name|k
operator|=
name|ieee80211_crypto_encap
argument_list|(
name|ni
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|ENOBUFS
return|;
block|}
comment|/* packet header may have moved, reset our local pointer */
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
block|}
name|hdrlen
operator|=
name|ieee80211_anyhdrsize
argument_list|(
name|wh
argument_list|)
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
name|tp
operator|=
operator|&
name|vap
operator|->
name|iv_txparms
index|[
name|ieee80211_chan2mode
argument_list|(
name|ni
operator|->
name|ni_chan
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
condition|)
block|{
name|rate
operator|=
name|tp
operator|->
name|mcastrate
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_EAPOL
condition|)
block|{
name|rate
operator|=
name|tp
operator|->
name|mgmtrate
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tp
operator|->
name|ucastrate
operator|!=
name|IEEE80211_FIXED_RATE_NONE
condition|)
block|{
name|rate
operator|=
name|tp
operator|->
name|ucastrate
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|ieee80211_ratectl_rate
argument_list|(
name|ni
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rate
operator|=
name|ni
operator|->
name|ni_txrate
expr_stmt|;
block|}
name|rate
operator|&=
name|IEEE80211_RATE_VAL
expr_stmt|;
name|qid
operator|=
name|M_WME_GETAC
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_QOS_HAS_SEQ
argument_list|(
name|wh
argument_list|)
condition|)
block|{
name|qos
operator|=
operator|(
operator|(
specifier|const
expr|struct
name|ieee80211_qosframe
operator|*
operator|)
name|wh
operator|)
operator|->
name|i_qos
index|[
literal|0
index|]
expr_stmt|;
name|tid
operator|=
name|qos
operator|&
name|IEEE80211_QOS_TID
expr_stmt|;
block|}
else|else
block|{
name|qos
operator|=
literal|0
expr_stmt|;
name|tid
operator|=
literal|0
expr_stmt|;
block|}
name|ring
operator|=
operator|&
name|sc
operator|->
name|txq
index|[
name|qid
index|]
expr_stmt|;
name|ridx
operator|=
name|ieee80211_legacy_rate_lookup
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|rate
argument_list|)
expr_stmt|;
comment|/* get MCS code from rate index */
name|mcs
operator|=
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|mcs
expr_stmt|;
comment|/* setup TX Wireless Information */
name|txwi
operator|=
name|data
operator|->
name|txwi
expr_stmt|;
name|txwi
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
comment|/* let HW generate seq numbers for non-QoS frames */
name|txwi
operator|->
name|xflags
operator|=
name|qos
condition|?
literal|0
else|:
name|RT2860_TX_NSEQ
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_DATA
condition|)
name|txwi
operator|->
name|wcid
operator|=
name|IEEE80211_AID
argument_list|(
name|ni
operator|->
name|ni_associd
argument_list|)
expr_stmt|;
else|else
name|txwi
operator|->
name|wcid
operator|=
literal|0xff
expr_stmt|;
name|txwi
operator|->
name|len
operator|=
name|htole16
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|phy
operator|==
name|IEEE80211_T_DS
condition|)
block|{
name|txwi
operator|->
name|phy
operator|=
name|htole16
argument_list|(
name|RT2860_PHY_CCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|ridx
operator|!=
name|RT2860_RIDX_CCK1
operator|&&
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
operator|)
condition|)
name|mcs
operator||=
name|RT2860_PHY_SHPRE
expr_stmt|;
block|}
else|else
name|txwi
operator|->
name|phy
operator|=
name|htole16
argument_list|(
name|RT2860_PHY_OFDM
argument_list|)
expr_stmt|;
name|txwi
operator|->
name|phy
operator||=
name|htole16
argument_list|(
name|mcs
argument_list|)
expr_stmt|;
comment|/* 	 * We store the MCS code into the driver-private PacketID field. 	 * The PacketID is latched into TX_STAT_FIFO when Tx completes so 	 * that we know at which initial rate the frame was transmitted. 	 * We add 1 to the MCS code because setting the PacketID field to 	 * 0 means that we don't want feedback in TX_STAT_FIFO. 	 */
name|pid
operator|=
operator|(
name|mcs
operator|+
literal|1
operator|)
operator|&
literal|0xf
expr_stmt|;
name|txwi
operator|->
name|len
operator||=
name|htole16
argument_list|(
name|pid
operator|<<
name|RT2860_TX_PID_SHIFT
argument_list|)
expr_stmt|;
comment|/* check if RTS/CTS or CTS-to-self protection is required */
if|if
condition|(
operator|!
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
operator|&&
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
name|IEEE80211_CRC_LEN
operator|>
name|vap
operator|->
name|iv_rtsthreshold
operator|||
operator|(
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_USEPROT
operator|)
operator|&&
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|phy
operator|==
name|IEEE80211_T_OFDM
operator|)
operator|)
condition|)
name|txwi
operator|->
name|txop
operator|=
name|RT2860_TX_TXOP_HT
expr_stmt|;
else|else
name|txwi
operator|->
name|txop
operator|=
name|RT2860_TX_TXOP_BACKOFF
expr_stmt|;
if|if
condition|(
operator|!
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
operator|&&
operator|(
operator|!
name|qos
operator|||
operator|(
name|qos
operator|&
name|IEEE80211_QOS_ACKPOLICY
operator|)
operator|!=
name|IEEE80211_QOS_ACKPOLICY_NOACK
operator|)
condition|)
block|{
name|txwi
operator|->
name|xflags
operator||=
name|RT2860_TX_ACK
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
condition|)
name|dur
operator|=
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|sp_ack_dur
expr_stmt|;
else|else
name|dur
operator|=
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|lp_ack_dur
expr_stmt|;
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|wh
operator|->
name|i_dur
operator|=
name|htole16
argument_list|(
name|dur
argument_list|)
expr_stmt|;
block|}
comment|/* ask MAC to insert timestamp into probe responses */
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
operator|(
name|IEEE80211_FC0_TYPE_MASK
operator||
name|IEEE80211_FC0_SUBTYPE_MASK
operator|)
operator|)
operator|==
operator|(
name|IEEE80211_FC0_TYPE_MGT
operator||
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
operator|)
condition|)
comment|/* NOTE: beacons do not pass through tx_data() */
name|txwi
operator|->
name|flags
operator||=
name|RT2860_TX_TS
expr_stmt|;
if|if
condition|(
name|ieee80211_radiotap_active_vap
argument_list|(
name|vap
argument_list|)
condition|)
block|{
name|struct
name|rt2860_tx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_txtap
decl_stmt|;
name|tap
operator|->
name|wt_flags
operator|=
literal|0
expr_stmt|;
name|tap
operator|->
name|wt_rate
operator|=
name|rate
expr_stmt|;
if|if
condition|(
name|mcs
operator|&
name|RT2860_PHY_SHPRE
condition|)
name|tap
operator|->
name|wt_flags
operator||=
name|IEEE80211_RADIOTAP_F_SHORTPRE
expr_stmt|;
name|ieee80211_radiotap_tx
argument_list|(
name|vap
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
name|pad
operator|=
operator|(
name|hdrlen
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
comment|/* copy and trim 802.11 header */
name|memcpy
argument_list|(
name|txwi
operator|+
literal|1
argument_list|,
name|wh
argument_list|,
name|hdrlen
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
name|hdrlen
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|error
operator|!=
literal|0
operator|&&
name|error
operator|!=
name|EFBIG
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't map mbuf (error %d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|__predict_true
argument_list|(
name|error
operator|==
literal|0
argument_list|)
condition|)
block|{
comment|/* determine how many TXDs are required */
name|ntxds
operator|=
literal|1
operator|+
operator|(
name|nsegs
operator|/
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|queued
operator|+
name|ntxds
operator|>=
name|RT2860_TX_RING_COUNT
condition|)
block|{
comment|/* not enough free TXDs, force mbuf defrag */
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|error
operator|=
name|EFBIG
expr_stmt|;
block|}
block|}
if|if
condition|(
name|__predict_false
argument_list|(
name|error
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|m1
operator|=
name|m_defrag
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m1
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not defragment mbuf\n"
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|ENOBUFS
return|;
block|}
name|m
operator|=
name|m1
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|error
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't map mbuf (error %d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* determine how many TXDs are now required */
name|ntxds
operator|=
literal|1
operator|+
operator|(
name|nsegs
operator|/
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|queued
operator|+
name|ntxds
operator|>=
name|RT2860_TX_RING_COUNT
condition|)
block|{
comment|/* this is a hopeless case, drop the mbuf! */
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|ENOBUFS
return|;
block|}
block|}
name|qsel
operator|=
operator|(
name|qid
operator|<
name|WME_NUM_AC
operator|)
condition|?
name|RT2860_TX_QSEL_EDCA
else|:
name|RT2860_TX_QSEL_MGMT
expr_stmt|;
comment|/* first segment is TXWI + 802.11 header */
name|txd
operator|=
operator|&
name|ring
operator|->
name|txd
index|[
name|ring
operator|->
name|cur
index|]
expr_stmt|;
name|txd
operator|->
name|sdp0
operator|=
name|htole32
argument_list|(
name|data
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|txd
operator|->
name|sdl0
operator|=
name|htole16
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_txwi
argument_list|)
operator|+
name|pad
argument_list|)
expr_stmt|;
name|txd
operator|->
name|flags
operator|=
name|qsel
expr_stmt|;
comment|/* setup payload segments */
name|seg
operator|=
operator|&
name|segs
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|nsegs
init|;
name|i
operator|>=
literal|2
condition|;
name|i
operator|-=
literal|2
control|)
block|{
name|txd
operator|->
name|sdp1
operator|=
name|htole32
argument_list|(
name|seg
operator|->
name|ds_addr
argument_list|)
expr_stmt|;
name|txd
operator|->
name|sdl1
operator|=
name|htole16
argument_list|(
name|seg
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|seg
operator|++
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
operator|(
name|ring
operator|->
name|cur
operator|+
literal|1
operator|)
operator|%
name|RT2860_TX_RING_COUNT
expr_stmt|;
comment|/* grab a new Tx descriptor */
name|txd
operator|=
operator|&
name|ring
operator|->
name|txd
index|[
name|ring
operator|->
name|cur
index|]
expr_stmt|;
name|txd
operator|->
name|sdp0
operator|=
name|htole32
argument_list|(
name|seg
operator|->
name|ds_addr
argument_list|)
expr_stmt|;
name|txd
operator|->
name|sdl0
operator|=
name|htole16
argument_list|(
name|seg
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|txd
operator|->
name|flags
operator|=
name|qsel
expr_stmt|;
name|seg
operator|++
expr_stmt|;
block|}
comment|/* finalize last segment */
if|if
condition|(
name|i
operator|>
literal|0
condition|)
block|{
name|txd
operator|->
name|sdp1
operator|=
name|htole32
argument_list|(
name|seg
operator|->
name|ds_addr
argument_list|)
expr_stmt|;
name|txd
operator|->
name|sdl1
operator|=
name|htole16
argument_list|(
name|seg
operator|->
name|ds_len
operator||
name|RT2860_TX_LS1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|txd
operator|->
name|sdl0
operator||=
name|htole16
argument_list|(
name|RT2860_TX_LS0
argument_list|)
expr_stmt|;
name|txd
operator|->
name|sdl1
operator|=
literal|0
expr_stmt|;
block|}
comment|/* remove from the free pool and link it into the SW Tx slot */
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|m
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
name|ring
operator|->
name|data
index|[
name|ring
operator|->
name|cur
index|]
operator|=
name|data
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|sc
operator|->
name|txwi_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"sending frame qid=%d wcid=%d nsegs=%d ridx=%d\n"
operator|,
name|qid
operator|,
name|txwi
operator|->
name|wcid
operator|,
name|nsegs
operator|,
name|ridx
operator|)
argument_list|)
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
operator|(
name|ring
operator|->
name|cur
operator|+
literal|1
operator|)
operator|%
name|RT2860_TX_RING_COUNT
expr_stmt|;
name|ring
operator|->
name|queued
operator|+=
name|ntxds
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|queued
operator|>=
name|RT2860_TX_RING_COUNT
condition|)
name|sc
operator|->
name|qfullmsk
operator||=
literal|1
operator|<<
name|qid
expr_stmt|;
comment|/* kick Tx */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_CTX_IDX
argument_list|(
name|qid
argument_list|)
argument_list|,
name|ring
operator|->
name|cur
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt2860_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ic
operator|->
name|ic_ifp
decl_stmt|;
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|RAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* prevent management frames from being sent if we're not ready */
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
return|return
name|ENETDOWN
return|;
block|}
if|if
condition|(
name|params
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * Legacy path; interpret frame contents to decide 		 * precisely how to send the frame. 		 */
name|error
operator|=
name|rt2860_tx
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|ni
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Caller supplied explicit parameters to use in 		 * sending the frame. 		 */
name|error
operator|=
name|rt2860_tx_raw
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|ni
argument_list|,
name|params
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
comment|/* NB: m is reclaimed on tx failure */
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|5
expr_stmt|;
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt2860_tx_raw
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|rt2860_tx_ring
modifier|*
name|ring
decl_stmt|;
name|struct
name|rt2860_tx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|rt2860_txd
modifier|*
name|txd
decl_stmt|;
name|struct
name|rt2860_txwi
modifier|*
name|txwi
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m1
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
name|RT2860_MAX_SCATTER
index|]
decl_stmt|;
name|bus_dma_segment_t
modifier|*
name|seg
decl_stmt|;
name|u_int
name|hdrlen
decl_stmt|;
name|uint16_t
name|dur
decl_stmt|;
name|uint8_t
name|type
decl_stmt|,
name|qsel
decl_stmt|,
name|mcs
decl_stmt|,
name|pid
decl_stmt|,
name|tid
decl_stmt|,
name|qid
decl_stmt|;
name|int
name|i
decl_stmt|,
name|nsegs
decl_stmt|,
name|ntxds
decl_stmt|,
name|pad
decl_stmt|,
name|rate
decl_stmt|,
name|ridx
decl_stmt|,
name|error
decl_stmt|;
comment|/* the data pool contains at least one element, pick the first */
name|data
operator|=
name|SLIST_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|hdrlen
operator|=
name|ieee80211_hdrsize
argument_list|(
name|wh
argument_list|)
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
comment|/* Choose a TX rate index. */
name|rate
operator|=
name|params
operator|->
name|ibp_rate0
expr_stmt|;
name|ridx
operator|=
name|ieee80211_legacy_rate_lookup
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|rate
operator|&
name|IEEE80211_RATE_VAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ridx
operator|==
operator|(
name|uint8_t
operator|)
operator|-
literal|1
condition|)
block|{
comment|/* XXX fall back to mcast/mgmt rate? */
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|qid
operator|=
name|params
operator|->
name|ibp_pri
operator|&
literal|3
expr_stmt|;
name|tid
operator|=
literal|0
expr_stmt|;
name|ring
operator|=
operator|&
name|sc
operator|->
name|txq
index|[
name|qid
index|]
expr_stmt|;
comment|/* get MCS code from rate index */
name|mcs
operator|=
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|mcs
expr_stmt|;
comment|/* setup TX Wireless Information */
name|txwi
operator|=
name|data
operator|->
name|txwi
expr_stmt|;
name|txwi
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
comment|/* let HW generate seq numbers for non-QoS frames */
name|txwi
operator|->
name|xflags
operator|=
name|params
operator|->
name|ibp_pri
operator|&
literal|3
condition|?
literal|0
else|:
name|RT2860_TX_NSEQ
expr_stmt|;
name|txwi
operator|->
name|wcid
operator|=
literal|0xff
expr_stmt|;
name|txwi
operator|->
name|len
operator|=
name|htole16
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|phy
operator|==
name|IEEE80211_T_DS
condition|)
block|{
name|txwi
operator|->
name|phy
operator|=
name|htole16
argument_list|(
name|RT2860_PHY_CCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|ridx
operator|!=
name|RT2860_RIDX_CCK1
operator|&&
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
operator|)
condition|)
name|mcs
operator||=
name|RT2860_PHY_SHPRE
expr_stmt|;
block|}
else|else
name|txwi
operator|->
name|phy
operator|=
name|htole16
argument_list|(
name|RT2860_PHY_OFDM
argument_list|)
expr_stmt|;
name|txwi
operator|->
name|phy
operator||=
name|htole16
argument_list|(
name|mcs
argument_list|)
expr_stmt|;
comment|/* 	 * We store the MCS code into the driver-private PacketID field. 	 * The PacketID is latched into TX_STAT_FIFO when Tx completes so 	 * that we know at which initial rate the frame was transmitted. 	 * We add 1 to the MCS code because setting the PacketID field to 	 * 0 means that we don't want feedback in TX_STAT_FIFO. 	 */
name|pid
operator|=
operator|(
name|mcs
operator|+
literal|1
operator|)
operator|&
literal|0xf
expr_stmt|;
name|txwi
operator|->
name|len
operator||=
name|htole16
argument_list|(
name|pid
operator|<<
name|RT2860_TX_PID_SHIFT
argument_list|)
expr_stmt|;
comment|/* check if RTS/CTS or CTS-to-self protection is required */
if|if
condition|(
name|params
operator|->
name|ibp_flags
operator|&
name|IEEE80211_BPF_RTS
operator|||
name|params
operator|->
name|ibp_flags
operator|&
name|IEEE80211_BPF_CTS
condition|)
name|txwi
operator|->
name|txop
operator|=
name|RT2860_TX_TXOP_HT
expr_stmt|;
else|else
name|txwi
operator|->
name|txop
operator|=
name|RT2860_TX_TXOP_BACKOFF
expr_stmt|;
if|if
condition|(
operator|(
name|params
operator|->
name|ibp_flags
operator|&
name|IEEE80211_BPF_NOACK
operator|)
operator|==
literal|0
condition|)
block|{
name|txwi
operator|->
name|xflags
operator||=
name|RT2860_TX_ACK
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
condition|)
name|dur
operator|=
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|sp_ack_dur
expr_stmt|;
else|else
name|dur
operator|=
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|lp_ack_dur
expr_stmt|;
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|wh
operator|->
name|i_dur
operator|=
name|htole16
argument_list|(
name|dur
argument_list|)
expr_stmt|;
block|}
comment|/* ask MAC to insert timestamp into probe responses */
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
operator|(
name|IEEE80211_FC0_TYPE_MASK
operator||
name|IEEE80211_FC0_SUBTYPE_MASK
operator|)
operator|)
operator|==
operator|(
name|IEEE80211_FC0_TYPE_MGT
operator||
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
operator|)
condition|)
comment|/* NOTE: beacons do not pass through tx_data() */
name|txwi
operator|->
name|flags
operator||=
name|RT2860_TX_TS
expr_stmt|;
if|if
condition|(
name|ieee80211_radiotap_active_vap
argument_list|(
name|vap
argument_list|)
condition|)
block|{
name|struct
name|rt2860_tx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_txtap
decl_stmt|;
name|tap
operator|->
name|wt_flags
operator|=
literal|0
expr_stmt|;
name|tap
operator|->
name|wt_rate
operator|=
name|rate
expr_stmt|;
if|if
condition|(
name|mcs
operator|&
name|RT2860_PHY_SHPRE
condition|)
name|tap
operator|->
name|wt_flags
operator||=
name|IEEE80211_RADIOTAP_F_SHORTPRE
expr_stmt|;
name|ieee80211_radiotap_tx
argument_list|(
name|vap
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
name|pad
operator|=
operator|(
name|hdrlen
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
comment|/* copy and trim 802.11 header */
name|memcpy
argument_list|(
name|txwi
operator|+
literal|1
argument_list|,
name|wh
argument_list|,
name|hdrlen
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
name|hdrlen
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|error
operator|!=
literal|0
operator|&&
name|error
operator|!=
name|EFBIG
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't map mbuf (error %d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|__predict_true
argument_list|(
name|error
operator|==
literal|0
argument_list|)
condition|)
block|{
comment|/* determine how many TXDs are required */
name|ntxds
operator|=
literal|1
operator|+
operator|(
name|nsegs
operator|/
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|queued
operator|+
name|ntxds
operator|>=
name|RT2860_TX_RING_COUNT
condition|)
block|{
comment|/* not enough free TXDs, force mbuf defrag */
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|error
operator|=
name|EFBIG
expr_stmt|;
block|}
block|}
if|if
condition|(
name|__predict_false
argument_list|(
name|error
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|m1
operator|=
name|m_defrag
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m1
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not defragment mbuf\n"
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|ENOBUFS
return|;
block|}
name|m
operator|=
name|m1
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|error
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't map mbuf (error %d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* determine how many TXDs are now required */
name|ntxds
operator|=
literal|1
operator|+
operator|(
name|nsegs
operator|/
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|queued
operator|+
name|ntxds
operator|>=
name|RT2860_TX_RING_COUNT
condition|)
block|{
comment|/* this is a hopeless case, drop the mbuf! */
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|ENOBUFS
return|;
block|}
block|}
name|qsel
operator|=
operator|(
name|qid
operator|<
name|WME_NUM_AC
operator|)
condition|?
name|RT2860_TX_QSEL_EDCA
else|:
name|RT2860_TX_QSEL_MGMT
expr_stmt|;
comment|/* first segment is TXWI + 802.11 header */
name|txd
operator|=
operator|&
name|ring
operator|->
name|txd
index|[
name|ring
operator|->
name|cur
index|]
expr_stmt|;
name|txd
operator|->
name|sdp0
operator|=
name|htole32
argument_list|(
name|data
operator|->
name|paddr
argument_list|)
expr_stmt|;
name|txd
operator|->
name|sdl0
operator|=
name|htole16
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_txwi
argument_list|)
operator|+
name|pad
argument_list|)
expr_stmt|;
name|txd
operator|->
name|flags
operator|=
name|qsel
expr_stmt|;
comment|/* setup payload segments */
name|seg
operator|=
operator|&
name|segs
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|nsegs
init|;
name|i
operator|>=
literal|2
condition|;
name|i
operator|-=
literal|2
control|)
block|{
name|txd
operator|->
name|sdp1
operator|=
name|htole32
argument_list|(
name|seg
operator|->
name|ds_addr
argument_list|)
expr_stmt|;
name|txd
operator|->
name|sdl1
operator|=
name|htole16
argument_list|(
name|seg
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|seg
operator|++
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
operator|(
name|ring
operator|->
name|cur
operator|+
literal|1
operator|)
operator|%
name|RT2860_TX_RING_COUNT
expr_stmt|;
comment|/* grab a new Tx descriptor */
name|txd
operator|=
operator|&
name|ring
operator|->
name|txd
index|[
name|ring
operator|->
name|cur
index|]
expr_stmt|;
name|txd
operator|->
name|sdp0
operator|=
name|htole32
argument_list|(
name|seg
operator|->
name|ds_addr
argument_list|)
expr_stmt|;
name|txd
operator|->
name|sdl0
operator|=
name|htole16
argument_list|(
name|seg
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|txd
operator|->
name|flags
operator|=
name|qsel
expr_stmt|;
name|seg
operator|++
expr_stmt|;
block|}
comment|/* finalize last segment */
if|if
condition|(
name|i
operator|>
literal|0
condition|)
block|{
name|txd
operator|->
name|sdp1
operator|=
name|htole32
argument_list|(
name|seg
operator|->
name|ds_addr
argument_list|)
expr_stmt|;
name|txd
operator|->
name|sdl1
operator|=
name|htole16
argument_list|(
name|seg
operator|->
name|ds_len
operator||
name|RT2860_TX_LS1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|txd
operator|->
name|sdl0
operator||=
name|htole16
argument_list|(
name|RT2860_TX_LS0
argument_list|)
expr_stmt|;
name|txd
operator|->
name|sdl1
operator|=
literal|0
expr_stmt|;
block|}
comment|/* remove from the free pool and link it into the SW Tx slot */
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|m
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
name|ring
operator|->
name|data
index|[
name|ring
operator|->
name|cur
index|]
operator|=
name|data
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|sc
operator|->
name|txwi_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txwi_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|desc_dmat
argument_list|,
name|ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"sending frame qid=%d wcid=%d nsegs=%d ridx=%d\n"
operator|,
name|qid
operator|,
name|txwi
operator|->
name|wcid
operator|,
name|nsegs
operator|,
name|ridx
operator|)
argument_list|)
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
operator|(
name|ring
operator|->
name|cur
operator|+
literal|1
operator|)
operator|%
name|RT2860_TX_RING_COUNT
expr_stmt|;
name|ring
operator|->
name|queued
operator|+=
name|ntxds
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|queued
operator|>=
name|RT2860_TX_RING_COUNT
condition|)
name|sc
operator|->
name|qfullmsk
operator||=
literal|1
operator|<<
name|qid
expr_stmt|;
comment|/* kick Tx */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_CTX_IDX
argument_list|(
name|qid
argument_list|)
argument_list|,
name|ring
operator|->
name|cur
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|RAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|RAL_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
operator|||
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
operator|)
condition|)
return|return;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|SLIST_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|data_pool
argument_list|)
operator|||
name|sc
operator|->
name|qfullmsk
operator|!=
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
break|break;
block|}
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
name|ni
operator|=
operator|(
expr|struct
name|ieee80211_node
operator|*
operator|)
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
expr_stmt|;
if|if
condition|(
name|rt2860_tx
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|ni
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|5
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_watchdog
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|RAL_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
argument_list|,
operator|(
literal|"not running"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_invalid
condition|)
comment|/* card ejected */
return|return;
if|if
condition|(
name|sc
operator|->
name|sc_tx_timer
operator|>
literal|0
operator|&&
operator|--
name|sc
operator|->
name|sc_tx_timer
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"device timeout\n"
argument_list|)
expr_stmt|;
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|watchdog_ch
argument_list|,
name|hz
argument_list|,
name|rt2860_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt2860_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|startall
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
name|RAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|rt2860_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|startall
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|rt2860_update_promisc
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|startall
condition|)
name|ieee80211_start_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|ic
operator|->
name|ic_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFADDR
case|:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Reading and writing from/to the BBP is different from RT2560 and RT2661.  * We access the BBP through the 8051 microcontroller unit which means that  * the microcode must be loaded first.  */
end_comment

begin_function
name|void
name|rt2860_mcu_bbp_write
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
name|int
name|ntries
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_BBPAGENT
argument_list|)
operator|&
name|RT2860_BBP_CSR_KICK
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not write to BBP through MCU\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_BBPAGENT
argument_list|,
name|RT2860_BBP_RW_PARALLEL
operator||
name|RT2860_BBP_CSR_KICK
operator||
name|reg
operator|<<
literal|8
operator||
name|val
argument_list|)
expr_stmt|;
name|RAL_BARRIER_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_BBP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint8_t
name|rt2860_mcu_bbp_read
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|ntries
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_BBPAGENT
argument_list|)
operator|&
name|RT2860_BBP_CSR_KICK
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not read from BBP through MCU\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_BBPAGENT
argument_list|,
name|RT2860_BBP_RW_PARALLEL
operator||
name|RT2860_BBP_CSR_KICK
operator||
name|RT2860_BBP_CSR_READ
operator||
name|reg
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|RAL_BARRIER_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_BBP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|val
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_BBPAGENT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|val
operator|&
name|RT2860_BBP_CSR_KICK
operator|)
condition|)
return|return
name|val
operator|&
literal|0xff
return|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not read from BBP through MCU\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Write to one of the 4 programmable 24-bit RF registers.  */
end_comment

begin_function
specifier|static
name|void
name|rt2860_rf_write
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|ntries
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_RF_CSR_CFG0
argument_list|)
operator|&
name|RT2860_RF_REG_CTRL
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not write to RF\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* RF registers are 24-bit on the RT2860 */
name|tmp
operator|=
name|RT2860_RF_REG_CTRL
operator||
literal|24
operator|<<
name|RT2860_RF_REG_WIDTH_SHIFT
operator||
operator|(
name|val
operator|&
literal|0x3fffff
operator|)
operator|<<
literal|2
operator||
operator|(
name|reg
operator|&
literal|3
operator|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_RF_CSR_CFG0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|rt3090_rf_read
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|ntries
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT3070_RF_CSR_CFG
argument_list|)
operator|&
name|RT3070_RF_KICK
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not read RF register\n"
argument_list|)
expr_stmt|;
return|return
literal|0xff
return|;
block|}
name|tmp
operator|=
name|RT3070_RF_KICK
operator||
name|reg
operator|<<
literal|8
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT3070_RF_CSR_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT3070_RF_CSR_CFG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|RT3070_RF_KICK
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not read RF register\n"
argument_list|)
expr_stmt|;
return|return
literal|0xff
return|;
block|}
return|return
name|tmp
operator|&
literal|0xff
return|;
block|}
end_function

begin_function
name|void
name|rt3090_rf_write
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|ntries
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|10
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT3070_RF_CSR_CFG
argument_list|)
operator|&
name|RT3070_RF_KICK
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|10
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not write to RF\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|tmp
operator|=
name|RT3070_RF_WRITE
operator||
name|RT3070_RF_KICK
operator||
name|reg
operator|<<
literal|8
operator||
name|val
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT3070_RF_CSR_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Send a command to the 8051 microcontroller unit.  */
end_comment

begin_function
name|int
name|rt2860_mcu_cmd
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|cmd
parameter_list|,
name|uint16_t
name|arg
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
name|int
name|slot
decl_stmt|,
name|ntries
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|cid
decl_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX
argument_list|)
operator|&
name|RT2860_H2M_BUSY
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
return|return
name|EIO
return|;
name|cid
operator|=
name|wait
condition|?
name|cmd
else|:
name|RT2860_TOKEN_NO_INTR
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX
argument_list|,
name|RT2860_H2M_BUSY
operator||
name|cid
operator|<<
literal|16
operator||
name|arg
argument_list|)
expr_stmt|;
name|RAL_BARRIER_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_HOST_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wait
condition|)
return|return
literal|0
return|;
comment|/* wait for the command to complete */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|200
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX_CID
argument_list|)
expr_stmt|;
comment|/* find the command slot */
for|for
control|(
name|slot
operator|=
literal|0
init|;
name|slot
operator|<
literal|4
condition|;
name|slot
operator|++
operator|,
name|tmp
operator|>>=
literal|8
control|)
if|if
condition|(
operator|(
name|tmp
operator|&
literal|0xff
operator|)
operator|==
name|cid
condition|)
break|break;
if|if
condition|(
name|slot
operator|<
literal|4
condition|)
break|break;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|200
condition|)
block|{
comment|/* clear command and status */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX_STATUS
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX_CID
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
comment|/* get command status (1 means success) */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX_STATUS
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|>>
operator|(
name|slot
operator|*
literal|8
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"MCU command=0x%02x slot=%d status=0x%02x\n"
operator|,
name|cmd
operator|,
name|slot
operator|,
name|tmp
operator|)
argument_list|)
expr_stmt|;
comment|/* clear command and status */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX_STATUS
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX_CID
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
return|return
operator|(
name|tmp
operator|==
literal|1
operator|)
condition|?
literal|0
else|:
name|EIO
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_enable_mrr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
define|#
directive|define
name|CCK
parameter_list|(
name|mcs
parameter_list|)
value|(mcs)
define|#
directive|define
name|OFDM
parameter_list|(
name|mcs
parameter_list|)
value|(1<< 3 | (mcs))
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_LG_FBK_CFG0
argument_list|,
name|OFDM
argument_list|(
literal|6
argument_list|)
operator|<<
literal|28
operator||
comment|/* 54->48 */
name|OFDM
argument_list|(
literal|5
argument_list|)
operator|<<
literal|24
operator||
comment|/* 48->36 */
name|OFDM
argument_list|(
literal|4
argument_list|)
operator|<<
literal|20
operator||
comment|/* 36->24 */
name|OFDM
argument_list|(
literal|3
argument_list|)
operator|<<
literal|16
operator||
comment|/* 24->18 */
name|OFDM
argument_list|(
literal|2
argument_list|)
operator|<<
literal|12
operator||
comment|/* 18->12 */
name|OFDM
argument_list|(
literal|1
argument_list|)
operator|<<
literal|8
operator||
comment|/* 12-> 9 */
name|OFDM
argument_list|(
literal|0
argument_list|)
operator|<<
literal|4
operator||
comment|/*  9-> 6 */
name|OFDM
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  6-> 6 */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_LG_FBK_CFG1
argument_list|,
name|CCK
argument_list|(
literal|2
argument_list|)
operator|<<
literal|12
operator||
comment|/* 11->5.5 */
name|CCK
argument_list|(
literal|1
argument_list|)
operator|<<
literal|8
operator||
comment|/* 5.5-> 2 */
name|CCK
argument_list|(
literal|0
argument_list|)
operator|<<
literal|4
operator||
comment|/*   2-> 1 */
name|CCK
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/*   1-> 1 */
undef|#
directive|undef
name|OFDM
undef|#
directive|undef
name|CCK
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_set_txpreamble
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_AUTO_RSP_CFG
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|RT2860_CCK_SHORT_EN
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHPREAMBLE
condition|)
name|tmp
operator||=
name|RT2860_CCK_SHORT_EN
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_AUTO_RSP_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rt2860_set_basicrates
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|ieee80211_rateset
modifier|*
name|rs
parameter_list|)
block|{
define|#
directive|define
name|RV
parameter_list|(
name|r
parameter_list|)
value|((r)& IEEE80211_RATE_VAL)
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|mask
init|=
literal|0
decl_stmt|;
name|uint8_t
name|rate
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|rs_nrates
condition|;
name|i
operator|++
control|)
block|{
name|rate
operator|=
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rate
operator|&
name|IEEE80211_RATE_BASIC
operator|)
condition|)
continue|continue;
name|mask
operator||=
literal|1
operator|<<
name|ieee80211_legacy_rate_lookup
argument_list|(
name|ic
operator|->
name|ic_rt
argument_list|,
name|RV
argument_list|(
name|rate
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_LEGACY_BASIC_RATE
argument_list|,
name|mask
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|RV
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ic
operator|->
name|ic_ifp
decl_stmt|;
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
name|tmp
operator|&
operator|~
operator|(
name|RT2860_BCN_TX_EN
operator||
name|RT2860_TSF_TIMER_EN
operator||
name|RT2860_TBTT_TIMER_EN
operator|)
argument_list|)
expr_stmt|;
name|rt2860_set_gp_timer
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ic
operator|->
name|ic_ifp
decl_stmt|;
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
name|rt2860_enable_tsf_sync
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_set_gp_timer
argument_list|(
name|sc
argument_list|,
literal|500
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ic
operator|->
name|ic_ifp
decl_stmt|;
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|RAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_switch_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|)
expr_stmt|;
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_select_chan_group
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|int
name|group
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|agc
decl_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|62
argument_list|,
literal|0x37
operator|-
name|sc
operator|->
name|lna
index|[
name|group
index|]
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|63
argument_list|,
literal|0x37
operator|-
name|sc
operator|->
name|lna
index|[
name|group
index|]
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|64
argument_list|,
literal|0x37
operator|-
name|sc
operator|->
name|lna
index|[
name|group
index|]
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|86
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|ext_2ghz_lna
condition|)
block|{
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|82
argument_list|,
literal|0x62
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|75
argument_list|,
literal|0x46
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|82
argument_list|,
literal|0x84
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|75
argument_list|,
literal|0x50
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|ext_5ghz_lna
condition|)
block|{
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|82
argument_list|,
literal|0xf2
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|75
argument_list|,
literal|0x46
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|82
argument_list|,
literal|0xf2
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|75
argument_list|,
literal|0x50
argument_list|)
expr_stmt|;
block|}
block|}
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_BAND_CFG
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RT2860_5G_BAND_SEL_N
operator||
name|RT2860_5G_BAND_SEL_P
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|group
operator|==
literal|0
operator|)
condition|?
name|RT2860_5G_BAND_SEL_N
else|:
name|RT2860_5G_BAND_SEL_P
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_BAND_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* enable appropriate Power Amplifiers and Low Noise Amplifiers */
name|tmp
operator|=
name|RT2860_RFTR_EN
operator||
name|RT2860_TRSW_EN
operator||
name|RT2860_LNA_PE0_EN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|>
literal|1
condition|)
name|tmp
operator||=
name|RT2860_LNA_PE1_EN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3593
operator|&&
name|sc
operator|->
name|nrxchains
operator|>
literal|2
condition|)
name|tmp
operator||=
name|RT3593_LNA_PE2_EN
expr_stmt|;
if|if
condition|(
name|group
operator|==
literal|0
condition|)
block|{
comment|/* 2GHz */
name|tmp
operator||=
name|RT2860_PA_PE_G0_EN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
name|tmp
operator||=
name|RT2860_PA_PE_G1_EN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3593
operator|&&
name|sc
operator|->
name|ntxchains
operator|>
literal|2
condition|)
name|tmp
operator||=
name|RT3593_PA_PE_G2_EN
expr_stmt|;
block|}
else|else
block|{
comment|/* 5GHz */
name|tmp
operator||=
name|RT2860_PA_PE_A0_EN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
name|tmp
operator||=
name|RT2860_PA_PE_A1_EN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3593
operator|&&
name|sc
operator|->
name|ntxchains
operator|>
literal|2
condition|)
name|tmp
operator||=
name|RT3593_PA_PE_A2_EN
expr_stmt|;
block|}
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_PIN_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3593
condition|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|RT2860_PCIE
condition|)
block|{
name|tmp
operator|&=
operator|~
literal|0x01010000
expr_stmt|;
if|if
condition|(
name|group
operator|==
literal|0
condition|)
name|tmp
operator||=
literal|0x00010000
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|&=
operator|~
literal|0x00008080
expr_stmt|;
if|if
condition|(
name|group
operator|==
literal|0
condition|)
name|tmp
operator||=
literal|0x00000080
expr_stmt|;
block|}
name|tmp
operator|=
operator|(
name|tmp
operator|&
operator|~
literal|0x00001000
operator|)
operator||
literal|0x00000010
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
comment|/* set initial AGC value */
if|if
condition|(
name|group
operator|==
literal|0
condition|)
block|{
comment|/* 2GHz band */
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
name|agc
operator|=
literal|0x1c
operator|+
name|sc
operator|->
name|lna
index|[
literal|0
index|]
operator|*
literal|2
expr_stmt|;
else|else
name|agc
operator|=
literal|0x2e
operator|+
name|sc
operator|->
name|lna
index|[
literal|0
index|]
expr_stmt|;
block|}
else|else
block|{
comment|/* 5GHz band */
name|agc
operator|=
literal|0x32
operator|+
operator|(
name|sc
operator|->
name|lna
index|[
name|group
index|]
operator|*
literal|5
operator|)
operator|/
literal|3
expr_stmt|;
block|}
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|66
argument_list|,
name|agc
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_set_chan
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|u_int
name|chan
parameter_list|)
block|{
specifier|const
name|struct
name|rfprog
modifier|*
name|rfprog
init|=
name|rt2860_rf2850
decl_stmt|;
name|uint32_t
name|r2
decl_stmt|,
name|r3
decl_stmt|,
name|r4
decl_stmt|;
name|int8_t
name|txpow1
decl_stmt|,
name|txpow2
decl_stmt|;
name|u_int
name|i
decl_stmt|;
comment|/* find the settings for this channel (we know it exists) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|rfprog
index|[
name|i
index|]
operator|.
name|chan
operator|!=
name|chan
condition|;
name|i
operator|++
control|)
empty_stmt|;
name|r2
operator|=
name|rfprog
index|[
name|i
index|]
operator|.
name|r2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|r2
operator||=
literal|1
operator|<<
literal|12
expr_stmt|;
comment|/* 1T: disable Tx chain 2 */
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|1
condition|)
name|r2
operator||=
literal|1
operator|<<
literal|15
operator||
literal|1
operator|<<
literal|4
expr_stmt|;
comment|/* 1R: disable Rx chains 2& 3 */
elseif|else
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|2
condition|)
name|r2
operator||=
literal|1
operator|<<
literal|4
expr_stmt|;
comment|/* 2R: disable Rx chain 3 */
comment|/* use Tx power values from EEPROM */
name|txpow1
operator|=
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
expr_stmt|;
name|txpow2
operator|=
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|chan
operator|>
literal|14
condition|)
block|{
if|if
condition|(
name|txpow1
operator|>=
literal|0
condition|)
name|txpow1
operator|=
name|txpow1
operator|<<
literal|1
operator||
literal|1
expr_stmt|;
else|else
name|txpow1
operator|=
operator|(
literal|7
operator|+
name|txpow1
operator|)
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|txpow2
operator|>=
literal|0
condition|)
name|txpow2
operator|=
name|txpow2
operator|<<
literal|1
operator||
literal|1
expr_stmt|;
else|else
name|txpow2
operator|=
operator|(
literal|7
operator|+
name|txpow2
operator|)
operator|<<
literal|1
expr_stmt|;
block|}
name|r3
operator|=
name|rfprog
index|[
name|i
index|]
operator|.
name|r3
operator||
name|txpow1
operator|<<
literal|7
expr_stmt|;
name|r4
operator|=
name|rfprog
index|[
name|i
index|]
operator|.
name|r4
operator||
name|sc
operator|->
name|freq
operator|<<
literal|13
operator||
name|txpow2
operator|<<
literal|4
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF1
argument_list|,
name|rfprog
index|[
name|i
index|]
operator|.
name|r1
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF2
argument_list|,
name|r2
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF3
argument_list|,
name|r3
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF4
argument_list|,
name|r4
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF1
argument_list|,
name|rfprog
index|[
name|i
index|]
operator|.
name|r1
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF2
argument_list|,
name|r2
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF3
argument_list|,
name|r3
operator||
literal|1
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF4
argument_list|,
name|r4
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF1
argument_list|,
name|rfprog
index|[
name|i
index|]
operator|.
name|r1
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF2
argument_list|,
name|r2
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF3
argument_list|,
name|r3
argument_list|)
expr_stmt|;
name|rt2860_rf_write
argument_list|(
name|sc
argument_list|,
name|RT2860_RF4
argument_list|,
name|r4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt3090_set_chan
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|u_int
name|chan
parameter_list|)
block|{
name|int8_t
name|txpow1
decl_stmt|,
name|txpow2
decl_stmt|;
name|uint8_t
name|rf
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* RT3090 is 2GHz only */
name|KASSERT
argument_list|(
name|chan
operator|>=
literal|1
operator|&&
name|chan
operator|<=
literal|14
argument_list|,
operator|(
literal|"chan %d not support"
operator|,
name|chan
operator|)
argument_list|)
expr_stmt|;
comment|/* find the settings for this channel (we know it exists) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|rt2860_rf2850
index|[
name|i
index|]
operator|.
name|chan
operator|!=
name|chan
condition|;
name|i
operator|++
control|)
empty_stmt|;
comment|/* use Tx power values from EEPROM */
name|txpow1
operator|=
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
expr_stmt|;
name|txpow2
operator|=
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|,
name|rt3090_freqs
index|[
name|i
index|]
operator|.
name|n
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x0f
operator|)
operator||
name|rt3090_freqs
index|[
name|i
index|]
operator|.
name|k
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|,
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x03
operator|)
operator||
name|rt3090_freqs
index|[
name|i
index|]
operator|.
name|r
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set Tx0 power */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x1f
operator|)
operator||
name|txpow1
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|12
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set Tx1 power */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|13
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x1f
operator|)
operator||
name|txpow2
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|13
argument_list|,
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
literal|0xfc
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|rf
operator||=
name|RT3070_TX1_PD
operator||
name|RT3070_TX2_PD
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|2
condition|)
name|rf
operator||=
name|RT3070_TX2_PD
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|1
condition|)
name|rf
operator||=
name|RT3070_RX1_PD
operator||
name|RT3070_RX2_PD
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|2
condition|)
name|rf
operator||=
name|RT3070_RX2_PD
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* set RF offset */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|23
argument_list|)
expr_stmt|;
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x7f
operator|)
operator||
name|sc
operator|->
name|freq
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|23
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* program RF filter */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|)
expr_stmt|;
comment|/* Tx */
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x3f
operator|)
operator||
name|sc
operator|->
name|rf24_20mhz
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|)
expr_stmt|;
comment|/* Rx */
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x3f
operator|)
operator||
name|sc
operator|->
name|rf24_20mhz
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* enable RF tuning */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|,
name|rf
operator||
name|RT3070_TUNE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt3090_rf_init
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof (a) / sizeof ((a)[0]))
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|rf
decl_stmt|,
name|bbp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|30
argument_list|)
expr_stmt|;
comment|/* toggle RF R30 bit 7 */
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|30
argument_list|,
name|rf
operator||
literal|0x80
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|30
argument_list|,
name|rf
operator|&
operator|~
literal|0x80
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
literal|0x1f000000
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|patch_dac
operator|&&
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
condition|)
name|tmp
operator||=
literal|0x0d000000
expr_stmt|;
comment|/* 1.35V */
else|else
name|tmp
operator||=
literal|0x01000000
expr_stmt|;
comment|/* 1.2V */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* patch LNA_PE_G1 */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT3070_GPIO_SWITCH
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT3070_GPIO_SWITCH
argument_list|,
name|tmp
operator|&
operator|~
literal|0x20
argument_list|)
expr_stmt|;
comment|/* initialize RF registers to default value */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|rt3090_def_rf
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
name|rt3090_def_rf
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rt3090_def_rf
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* select 20MHz bandwidth */
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
name|rf
operator||
literal|0x40
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|!=
literal|0x3593
condition|)
block|{
comment|/* calibrate filter for 20MHz bandwidth */
name|sc
operator|->
name|rf24_20mhz
operator|=
literal|0x1f
expr_stmt|;
comment|/* default value */
name|rt3090_filter_calib
argument_list|(
name|sc
argument_list|,
literal|0x07
argument_list|,
literal|0x16
argument_list|,
operator|&
name|sc
operator|->
name|rf24_20mhz
argument_list|)
expr_stmt|;
comment|/* select 40MHz bandwidth */
name|bbp
operator|=
name|rt2860_mcu_bbp_read
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|,
operator|(
name|bbp
operator|&
operator|~
literal|0x08
operator|)
operator||
literal|0x10
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
name|rf
operator||
literal|0x20
argument_list|)
expr_stmt|;
comment|/* calibrate filter for 40MHz bandwidth */
name|sc
operator|->
name|rf24_40mhz
operator|=
literal|0x2f
expr_stmt|;
comment|/* default value */
name|rt3090_filter_calib
argument_list|(
name|sc
argument_list|,
literal|0x27
argument_list|,
literal|0x19
argument_list|,
operator|&
name|sc
operator|->
name|rf24_40mhz
argument_list|)
expr_stmt|;
comment|/* go back to 20MHz bandwidth */
name|bbp
operator|=
name|rt2860_mcu_bbp_read
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|,
name|bbp
operator|&
operator|~
literal|0x18
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
condition|)
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|27
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT3070_OPT_14
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT3070_OPT_14
argument_list|,
name|tmp
operator||
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rf_rev
operator|==
name|RT3070_RF_3020
condition|)
name|rt3090_set_rx_antenna
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bbp
operator|=
name|rt2860_mcu_bbp_read
argument_list|(
name|sc
argument_list|,
literal|138
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3593
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|bbp
operator||=
literal|0x60
expr_stmt|;
comment|/* turn off DAC1 and DAC2 */
elseif|else
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|2
condition|)
name|bbp
operator||=
literal|0x40
expr_stmt|;
comment|/* turn off DAC2 */
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|1
condition|)
name|bbp
operator|&=
operator|~
literal|0x06
expr_stmt|;
comment|/* turn off ADC1 and ADC2 */
elseif|else
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|2
condition|)
name|bbp
operator|&=
operator|~
literal|0x04
expr_stmt|;
comment|/* turn off ADC2 */
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|bbp
operator||=
literal|0x20
expr_stmt|;
comment|/* turn off DAC1 */
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|1
condition|)
name|bbp
operator|&=
operator|~
literal|0x02
expr_stmt|;
comment|/* turn off ADC1 */
block|}
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|138
argument_list|,
name|bbp
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
operator|(
name|RT3070_RX0_PD
operator||
name|RT3070_TX0_PD
operator|)
expr_stmt|;
name|rf
operator||=
name|RT3070_RF_BLOCK
operator||
name|RT3070_RX1_PD
operator||
name|RT3070_TX1_PD
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|15
argument_list|,
name|rf
operator|&
operator|~
name|RT3070_TX_LO2
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|17
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
name|RT3070_TX_LO1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|>=
literal|0x0211
operator|&&
operator|!
name|sc
operator|->
name|ext_2ghz_lna
condition|)
name|rf
operator||=
literal|0x20
expr_stmt|;
comment|/* fix for long range Rx issue */
if|if
condition|(
name|sc
operator|->
name|txmixgain_2ghz
operator|>=
literal|2
condition|)
name|rf
operator|=
operator|(
name|rf
operator|&
operator|~
literal|0x7
operator|)
operator||
name|sc
operator|->
name|txmixgain_2ghz
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|17
argument_list|,
name|rf
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|20
argument_list|,
name|rf
operator|&
operator|~
name|RT3070_RX_LO1
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|21
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|21
argument_list|,
name|rf
operator|&
operator|~
name|RT3070_RX_LO2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_function
name|void
name|rt3090_rf_wakeup
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|rf
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3593
condition|)
block|{
comment|/* enable VCO */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
name|rf
operator||
name|RT3593_VCO
argument_list|)
expr_stmt|;
comment|/* initiate VCO calibration */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|,
name|rf
operator||
name|RT3593_VCOCAL
argument_list|)
expr_stmt|;
comment|/* enable VCO bias current control */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|6
argument_list|,
name|rf
operator||
name|RT3593_VCO_IC
argument_list|)
expr_stmt|;
comment|/* initiate res calibration */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|,
name|rf
operator||
name|RT3593_RESCAL
argument_list|)
expr_stmt|;
comment|/* set reference current control to 0.33 mA */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|22
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
name|RT3593_CP_IC_MASK
expr_stmt|;
name|rf
operator||=
literal|1
operator|<<
name|RT3593_CP_IC_SHIFT
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|22
argument_list|,
name|rf
argument_list|)
expr_stmt|;
comment|/* enable RX CTB */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|46
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|46
argument_list|,
name|rf
operator||
name|RT3593_RX_CTB
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
operator|(
name|RT3593_LDO_RF_VC_MASK
operator||
name|RT3593_LDO_PLL_VC_MASK
operator|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|20
argument_list|,
name|rf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* enable RF block */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
name|rf
operator||
name|RT3070_RF_BLOCK
argument_list|)
expr_stmt|;
comment|/* enable VCO bias current control */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|,
name|rf
operator||
literal|0x30
argument_list|)
expr_stmt|;
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|9
argument_list|,
name|rf
operator||
literal|0x0e
argument_list|)
expr_stmt|;
comment|/* enable RX CTB */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|21
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|21
argument_list|,
name|rf
operator||
name|RT3070_RX_CTB
argument_list|)
expr_stmt|;
comment|/* fix Tx to Rx IQ glitch by raising RF voltage */
name|rf
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|27
argument_list|)
expr_stmt|;
name|rf
operator|&=
operator|~
literal|0x77
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
condition|)
name|rf
operator||=
literal|0x03
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|27
argument_list|,
name|rf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|patch_dac
operator|&&
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
condition|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|&
operator|~
literal|0x1f000000
operator|)
operator||
literal|0x0d000000
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT3070_LDO_CFG0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|rt3090_filter_calib
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|init
parameter_list|,
name|uint8_t
name|target
parameter_list|,
name|uint8_t
modifier|*
name|val
parameter_list|)
block|{
name|uint8_t
name|rf22
decl_stmt|,
name|rf24
decl_stmt|;
name|uint8_t
name|bbp55_pb
decl_stmt|,
name|bbp55_sb
decl_stmt|,
name|delta
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* program filter */
name|rf24
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|rf24
operator|=
operator|(
name|rf24
operator|&
literal|0xc0
operator|)
operator||
name|init
expr_stmt|;
comment|/* initial filter value */
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
name|rf24
argument_list|)
expr_stmt|;
comment|/* enable baseband loopback mode */
name|rf22
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|22
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|22
argument_list|,
name|rf22
operator||
name|RT3070_BB_LOOPBACK
argument_list|)
expr_stmt|;
comment|/* set power and frequency of passband test tone */
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
comment|/* transmit test tone */
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|25
argument_list|,
literal|0x90
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* read received power */
name|bbp55_pb
operator|=
name|rt2860_mcu_bbp_read
argument_list|(
name|sc
argument_list|,
literal|55
argument_list|)
expr_stmt|;
if|if
condition|(
name|bbp55_pb
operator|!=
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
return|return
name|ETIMEDOUT
return|;
comment|/* set power and frequency of stopband test tone */
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
literal|0x06
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
comment|/* transmit test tone */
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|25
argument_list|,
literal|0x90
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* read received power */
name|bbp55_sb
operator|=
name|rt2860_mcu_bbp_read
argument_list|(
name|sc
argument_list|,
literal|55
argument_list|)
expr_stmt|;
name|delta
operator|=
name|bbp55_pb
operator|-
name|bbp55_sb
expr_stmt|;
if|if
condition|(
name|delta
operator|>
name|target
condition|)
break|break;
comment|/* reprogram filter */
name|rf24
operator|++
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
name|rf24
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|<
literal|100
condition|)
block|{
if|if
condition|(
name|rf24
operator|!=
name|init
condition|)
name|rf24
operator|--
expr_stmt|;
comment|/* backtrack */
operator|*
name|val
operator|=
name|rf24
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
name|rf24
argument_list|)
expr_stmt|;
block|}
comment|/* restore initial state */
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|24
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* disable baseband loopback mode */
name|rf22
operator|=
name|rt3090_rf_read
argument_list|(
name|sc
argument_list|,
literal|22
argument_list|)
expr_stmt|;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
literal|22
argument_list|,
name|rf22
operator|&
operator|~
name|RT3070_BB_LOOPBACK
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt3090_rf_setup
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|bbp
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|>=
literal|0x0211
condition|)
block|{
comment|/* enable DC filter */
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|103
argument_list|,
literal|0xc0
argument_list|)
expr_stmt|;
comment|/* improve power consumption */
name|bbp
operator|=
name|rt2860_mcu_bbp_read
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|31
argument_list|,
name|bbp
operator|&
operator|~
literal|0x03
argument_list|)
expr_stmt|;
block|}
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_rev
operator|<
literal|0x0211
condition|)
block|{
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG2
argument_list|,
name|sc
operator|->
name|patch_dac
condition|?
literal|0x2c
else|:
literal|0x0f
argument_list|)
expr_stmt|;
block|}
else|else
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* initialize RF registers from ROM */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|reg
operator|==
literal|0
operator|||
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|reg
operator|==
literal|0xff
condition|)
continue|continue;
name|rt3090_rf_write
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_set_leds
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|which
parameter_list|)
block|{
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_LEDS
argument_list|,
name|which
operator||
operator|(
name|sc
operator|->
name|leds
operator|&
literal|0x7f
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Hardware has a general-purpose programmable timer interrupt that can  * periodically raise MAC_INT_4.  */
end_comment

begin_function
specifier|static
name|void
name|rt2860_set_gp_timer
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|int
name|ms
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
comment|/* disable GP timer before reprogramming it */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_TIMER_EN
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_TIMER_EN
argument_list|,
name|tmp
operator|&
operator|~
name|RT2860_GP_TIMER_EN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ms
operator|==
literal|0
condition|)
return|return;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_TIMER_CFG
argument_list|)
expr_stmt|;
name|ms
operator|*=
literal|16
expr_stmt|;
comment|/* Unit: 64us */
name|tmp
operator|=
operator|(
name|tmp
operator|&
literal|0xffff
operator|)
operator||
name|ms
operator|<<
name|RT2860_GP_TIMER_SHIFT
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_TIMER_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* enable GP timer */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_TIMER_EN
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_TIMER_EN
argument_list|,
name|tmp
operator||
name|RT2860_GP_TIMER_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_set_bssid
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|bssid
parameter_list|)
block|{
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_BSSID_DW0
argument_list|,
name|bssid
index|[
literal|0
index|]
operator||
name|bssid
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|bssid
index|[
literal|2
index|]
operator|<<
literal|16
operator||
name|bssid
index|[
literal|3
index|]
operator|<<
literal|24
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_BSSID_DW1
argument_list|,
name|bssid
index|[
literal|4
index|]
operator||
name|bssid
index|[
literal|5
index|]
operator|<<
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_set_macaddr
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_ADDR_DW0
argument_list|,
name|addr
index|[
literal|0
index|]
operator||
name|addr
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|addr
index|[
literal|2
index|]
operator|<<
literal|16
operator||
name|addr
index|[
literal|3
index|]
operator|<<
literal|24
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_ADDR_DW1
argument_list|,
name|addr
index|[
literal|4
index|]
operator||
name|addr
index|[
literal|5
index|]
operator|<<
literal|8
operator||
literal|0xff
operator|<<
literal|16
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_updateslot
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_BKOFF_SLOT_CFG
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
literal|0xff
expr_stmt|;
name|tmp
operator||=
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHSLOT
operator|)
condition|?
literal|9
else|:
literal|20
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_BKOFF_SLOT_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_updateprot
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RT2860_RTSTH_EN
operator||
name|RT2860_PROT_NAV_SHORT
operator||
name|RT2860_TXOP_ALLOW_ALL
expr_stmt|;
comment|/* setup protection frame rate (MCS code) */
name|tmp
operator||=
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|ic
operator|->
name|ic_curchan
argument_list|)
condition|?
name|rt2860_rates
index|[
name|RT2860_RIDX_OFDM6
index|]
operator|.
name|mcs
else|:
name|rt2860_rates
index|[
name|RT2860_RIDX_CCK11
index|]
operator|.
name|mcs
expr_stmt|;
comment|/* CCK frames don't require protection */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_CCK_PROT_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_USEPROT
condition|)
block|{
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_RTSCTS
condition|)
name|tmp
operator||=
name|RT2860_PROT_CTRL_RTS_CTS
expr_stmt|;
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_CTSONLY
condition|)
name|tmp
operator||=
name|RT2860_PROT_CTRL_CTS
expr_stmt|;
block|}
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_OFDM_PROT_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_update_promisc
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_RX_FILTR_CFG
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|RT2860_DROP_NOT_MYBSS
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
condition|)
name|tmp
operator||=
name|RT2860_DROP_NOT_MYBSS
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_RX_FILTR_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt2860_updateedca
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_ifp
operator|->
name|if_softc
decl_stmt|;
specifier|const
name|struct
name|wmeParams
modifier|*
name|wmep
decl_stmt|;
name|int
name|aci
decl_stmt|;
name|wmep
operator|=
name|ic
operator|->
name|ic_wme
operator|.
name|wme_chanParams
operator|.
name|cap_wmeParams
expr_stmt|;
comment|/* update MAC TX configuration registers */
for|for
control|(
name|aci
operator|=
literal|0
init|;
name|aci
operator|<
name|WME_NUM_AC
condition|;
name|aci
operator|++
control|)
block|{
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_EDCA_AC_CFG
argument_list|(
name|aci
argument_list|)
argument_list|,
name|wmep
index|[
name|aci
index|]
operator|.
name|wmep_logcwmax
operator|<<
literal|16
operator||
name|wmep
index|[
name|aci
index|]
operator|.
name|wmep_logcwmin
operator|<<
literal|12
operator||
name|wmep
index|[
name|aci
index|]
operator|.
name|wmep_aifsn
operator|<<
literal|8
operator||
name|wmep
index|[
name|aci
index|]
operator|.
name|wmep_txopLimit
argument_list|)
expr_stmt|;
block|}
comment|/* update SCH/DMA registers too */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_AIFSN_CFG
argument_list|,
name|wmep
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_aifsn
operator|<<
literal|12
operator||
name|wmep
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_aifsn
operator|<<
literal|8
operator||
name|wmep
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_aifsn
operator|<<
literal|4
operator||
name|wmep
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_aifsn
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_CWMIN_CFG
argument_list|,
name|wmep
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_logcwmin
operator|<<
literal|12
operator||
name|wmep
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_logcwmin
operator|<<
literal|8
operator||
name|wmep
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_logcwmin
operator|<<
literal|4
operator||
name|wmep
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_logcwmin
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_CWMAX_CFG
argument_list|,
name|wmep
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_logcwmax
operator|<<
literal|12
operator||
name|wmep
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_logcwmax
operator|<<
literal|8
operator||
name|wmep
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_logcwmax
operator|<<
literal|4
operator||
name|wmep
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_logcwmax
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_TXOP0_CFG
argument_list|,
name|wmep
index|[
name|WME_AC_BK
index|]
operator|.
name|wmep_txopLimit
operator|<<
literal|16
operator||
name|wmep
index|[
name|WME_AC_BE
index|]
operator|.
name|wmep_txopLimit
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WMM_TXOP1_CFG
argument_list|,
name|wmep
index|[
name|WME_AC_VO
index|]
operator|.
name|wmep_txopLimit
operator|<<
literal|16
operator||
name|wmep
index|[
name|WME_AC_VI
index|]
operator|.
name|wmep_txopLimit
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HW_CRYPTO
end_ifdef

begin_function
specifier|static
name|int
name|rt2860_set_key
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
name|k
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|bus_size_t
name|base
decl_stmt|;
name|uint32_t
name|attr
decl_stmt|;
name|uint8_t
name|mode
decl_stmt|,
name|wcid
decl_stmt|,
name|iv
index|[
literal|8
index|]
decl_stmt|;
comment|/* defer setting of WEP keys until interface is brought up */
if|if
condition|(
operator|(
name|ic
operator|->
name|ic_if
operator|.
name|if_flags
operator|&
operator|(
name|IFF_UP
operator||
name|IFF_RUNNING
operator|)
operator|)
operator|!=
operator|(
name|IFF_UP
operator||
name|IFF_RUNNING
operator|)
condition|)
return|return
literal|0
return|;
comment|/* map net80211 cipher to RT2860 security mode */
switch|switch
condition|(
name|k
operator|->
name|k_cipher
condition|)
block|{
case|case
name|IEEE80211_CIPHER_WEP40
case|:
name|mode
operator|=
name|RT2860_MODE_WEP40
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_WEP104
case|:
name|mode
operator|=
name|RT2860_MODE_WEP104
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_TKIP
case|:
name|mode
operator|=
name|RT2860_MODE_TKIP
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_CCMP
case|:
name|mode
operator|=
name|RT2860_MODE_AES_CCMP
expr_stmt|;
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|k
operator|->
name|k_flags
operator|&
name|IEEE80211_KEY_GROUP
condition|)
block|{
name|wcid
operator|=
literal|0
expr_stmt|;
comment|/* NB: update WCID0 for group keys */
name|base
operator|=
name|RT2860_SKEY
argument_list|(
literal|0
argument_list|,
name|k
operator|->
name|k_id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wcid
operator|=
operator|(
operator|(
expr|struct
name|rt2860_node
operator|*
operator|)
name|ni
operator|)
operator|->
name|wcid
expr_stmt|;
name|base
operator|=
name|RT2860_PKEY
argument_list|(
name|wcid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|k
operator|->
name|k_cipher
operator|==
name|IEEE80211_CIPHER_TKIP
condition|)
block|{
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|base
argument_list|,
name|k
operator|->
name|k_key
argument_list|,
literal|16
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|IEEE80211_STA_ONLY
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_HOSTAP
condition|)
block|{
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|base
operator|+
literal|16
argument_list|,
operator|&
name|k
operator|->
name|k_key
index|[
literal|16
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|base
operator|+
literal|24
argument_list|,
operator|&
name|k
operator|->
name|k_key
index|[
literal|24
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|base
operator|+
literal|16
argument_list|,
operator|&
name|k
operator|->
name|k_key
index|[
literal|24
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|base
operator|+
literal|24
argument_list|,
operator|&
name|k
operator|->
name|k_key
index|[
literal|16
index|]
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|base
argument_list|,
name|k
operator|->
name|k_key
argument_list|,
name|k
operator|->
name|k_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|k
operator|->
name|k_flags
operator|&
name|IEEE80211_KEY_GROUP
operator|)
operator|||
operator|(
name|k
operator|->
name|k_flags
operator|&
name|IEEE80211_KEY_TX
operator|)
condition|)
block|{
comment|/* set initial packet number in IV+EIV */
if|if
condition|(
name|k
operator|->
name|k_cipher
operator|==
name|IEEE80211_CIPHER_WEP40
operator|||
name|k
operator|->
name|k_cipher
operator|==
name|IEEE80211_CIPHER_WEP104
condition|)
block|{
name|uint32_t
name|val
init|=
name|arc4random
argument_list|()
decl_stmt|;
comment|/* skip weak IVs from Fluhrer/Mantin/Shamir */
if|if
condition|(
name|val
operator|>=
literal|0x03ff00
operator|&&
operator|(
name|val
operator|&
literal|0xf8ff00
operator|)
operator|==
literal|0x00ff00
condition|)
name|val
operator|+=
literal|0x000100
expr_stmt|;
name|iv
index|[
literal|0
index|]
operator|=
name|val
expr_stmt|;
name|iv
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|iv
index|[
literal|2
index|]
operator|=
name|val
operator|>>
literal|16
expr_stmt|;
name|iv
index|[
literal|3
index|]
operator|=
name|k
operator|->
name|k_id
operator|<<
literal|6
expr_stmt|;
name|iv
index|[
literal|4
index|]
operator|=
name|iv
index|[
literal|5
index|]
operator|=
name|iv
index|[
literal|6
index|]
operator|=
name|iv
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|k
operator|->
name|k_cipher
operator|==
name|IEEE80211_CIPHER_TKIP
condition|)
block|{
name|iv
index|[
literal|0
index|]
operator|=
name|k
operator|->
name|k_tsc
operator|>>
literal|8
expr_stmt|;
name|iv
index|[
literal|1
index|]
operator|=
operator|(
name|iv
index|[
literal|0
index|]
operator||
literal|0x20
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|iv
index|[
literal|2
index|]
operator|=
name|k
operator|->
name|k_tsc
expr_stmt|;
block|}
else|else
comment|/* CCMP */
block|{
name|iv
index|[
literal|0
index|]
operator|=
name|k
operator|->
name|k_tsc
expr_stmt|;
name|iv
index|[
literal|1
index|]
operator|=
name|k
operator|->
name|k_tsc
operator|>>
literal|8
expr_stmt|;
name|iv
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|iv
index|[
literal|3
index|]
operator|=
name|k
operator|->
name|k_id
operator|<<
literal|6
operator||
name|IEEE80211_WEP_EXTIV
expr_stmt|;
name|iv
index|[
literal|4
index|]
operator|=
name|k
operator|->
name|k_tsc
operator|>>
literal|16
expr_stmt|;
name|iv
index|[
literal|5
index|]
operator|=
name|k
operator|->
name|k_tsc
operator|>>
literal|24
expr_stmt|;
name|iv
index|[
literal|6
index|]
operator|=
name|k
operator|->
name|k_tsc
operator|>>
literal|32
expr_stmt|;
name|iv
index|[
literal|7
index|]
operator|=
name|k
operator|->
name|k_tsc
operator|>>
literal|40
expr_stmt|;
block|}
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|RT2860_IVEIV
argument_list|(
name|wcid
argument_list|)
argument_list|,
name|iv
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|k
operator|->
name|k_flags
operator|&
name|IEEE80211_KEY_GROUP
condition|)
block|{
comment|/* install group key */
name|attr
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY_MODE_0_7
argument_list|)
expr_stmt|;
name|attr
operator|&=
operator|~
operator|(
literal|0xf
operator|<<
operator|(
name|k
operator|->
name|k_id
operator|*
literal|4
operator|)
operator|)
expr_stmt|;
name|attr
operator||=
name|mode
operator|<<
operator|(
name|k
operator|->
name|k_id
operator|*
literal|4
operator|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY_MODE_0_7
argument_list|,
name|attr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* install pairwise key */
name|attr
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ATTR
argument_list|(
name|wcid
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|=
operator|(
name|attr
operator|&
operator|~
literal|0xf
operator|)
operator||
operator|(
name|mode
operator|<<
literal|1
operator|)
operator||
name|RT2860_RX_PKEY_EN
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ATTR
argument_list|(
name|wcid
argument_list|)
argument_list|,
name|attr
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_delete_key
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|ieee80211_key
modifier|*
name|k
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|uint32_t
name|attr
decl_stmt|;
name|uint8_t
name|wcid
decl_stmt|;
if|if
condition|(
name|k
operator|->
name|k_flags
operator|&
name|IEEE80211_KEY_GROUP
condition|)
block|{
comment|/* remove group key */
name|attr
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY_MODE_0_7
argument_list|)
expr_stmt|;
name|attr
operator|&=
operator|~
operator|(
literal|0xf
operator|<<
operator|(
name|k
operator|->
name|k_id
operator|*
literal|4
operator|)
operator|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY_MODE_0_7
argument_list|,
name|attr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* remove pairwise key */
name|wcid
operator|=
operator|(
operator|(
expr|struct
name|rt2860_node
operator|*
operator|)
name|ni
operator|)
operator|->
name|wcid
expr_stmt|;
name|attr
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ATTR
argument_list|(
name|wcid
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|&=
operator|~
literal|0xf
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ATTR
argument_list|(
name|wcid
argument_list|)
argument_list|,
name|attr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int8_t
name|rt2860_rssi2dbm
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|rssi
parameter_list|,
name|uint8_t
name|rxchain
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211_channel
modifier|*
name|c
init|=
name|ic
operator|->
name|ic_curchan
decl_stmt|;
name|int
name|delta
decl_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|u_int
name|chan
init|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
decl_stmt|;
name|delta
operator|=
name|sc
operator|->
name|rssi_5ghz
index|[
name|rxchain
index|]
expr_stmt|;
comment|/* determine channel group */
if|if
condition|(
name|chan
operator|<=
literal|64
condition|)
name|delta
operator|-=
name|sc
operator|->
name|lna
index|[
literal|1
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|128
condition|)
name|delta
operator|-=
name|sc
operator|->
name|lna
index|[
literal|2
index|]
expr_stmt|;
else|else
name|delta
operator|-=
name|sc
operator|->
name|lna
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
name|delta
operator|=
name|sc
operator|->
name|rssi_2ghz
index|[
name|rxchain
index|]
operator|-
name|sc
operator|->
name|lna
index|[
literal|0
index|]
expr_stmt|;
return|return
operator|-
literal|12
operator|-
name|delta
operator|-
name|rssi
return|;
block|}
end_function

begin_comment
comment|/*  * Add `delta' (signed) to each 4-bit sub-word of a 32-bit word.  * Used to adjust per-rate Tx power registers.  */
end_comment

begin_function
specifier|static
name|__inline
name|uint32_t
name|b4inc
parameter_list|(
name|uint32_t
name|b32
parameter_list|,
name|int8_t
name|delta
parameter_list|)
block|{
name|int8_t
name|i
decl_stmt|,
name|b4
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|b4
operator|=
name|b32
operator|&
literal|0xf
expr_stmt|;
name|b4
operator|+=
name|delta
expr_stmt|;
if|if
condition|(
name|b4
operator|<
literal|0
condition|)
name|b4
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|b4
operator|>
literal|0xf
condition|)
name|b4
operator|=
literal|0xf
expr_stmt|;
name|b32
operator|=
name|b32
operator|>>
literal|4
operator||
name|b4
operator|<<
literal|28
expr_stmt|;
block|}
return|return
name|b32
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|rt2860_get_rf
parameter_list|(
name|uint8_t
name|rev
parameter_list|)
block|{
switch|switch
condition|(
name|rev
condition|)
block|{
case|case
name|RT2860_RF_2820
case|:
return|return
literal|"RT2820"
return|;
case|case
name|RT2860_RF_2850
case|:
return|return
literal|"RT2850"
return|;
case|case
name|RT2860_RF_2720
case|:
return|return
literal|"RT2720"
return|;
case|case
name|RT2860_RF_2750
case|:
return|return
literal|"RT2750"
return|;
case|case
name|RT3070_RF_3020
case|:
return|return
literal|"RT3020"
return|;
case|case
name|RT3070_RF_2020
case|:
return|return
literal|"RT2020"
return|;
case|case
name|RT3070_RF_3021
case|:
return|return
literal|"RT3021"
return|;
case|case
name|RT3070_RF_3022
case|:
return|return
literal|"RT3022"
return|;
case|case
name|RT3070_RF_3052
case|:
return|return
literal|"RT3052"
return|;
case|case
name|RT3070_RF_3320
case|:
return|return
literal|"RT3320"
return|;
case|case
name|RT3070_RF_3053
case|:
return|return
literal|"RT3053"
return|;
default|default:
return|return
literal|"unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rt2860_read_eeprom
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|macaddr
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|int8_t
name|delta_2ghz
decl_stmt|,
name|delta_5ghz
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|int
name|ridx
decl_stmt|,
name|ant
decl_stmt|,
name|i
decl_stmt|;
comment|/* check whether the ROM is eFUSE ROM or EEPROM */
name|sc
operator|->
name|sc_srom_read
operator|=
name|rt2860_eeprom_read_2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT3070_EFUSE_CTRL
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"EFUSE_CTRL=0x%08x\n"
operator|,
name|tmp
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RT3070_SEL_EFUSE
condition|)
name|sc
operator|->
name|sc_srom_read
operator|=
name|rt3090_efuse_read_2
expr_stmt|;
block|}
comment|/* read EEPROM version */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_VERSION
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"EEPROM rev=%d, FAE=%d\n"
operator|,
name|val
operator|&
literal|0xff
operator|,
name|val
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
comment|/* read MAC address */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_MAC01
argument_list|)
expr_stmt|;
name|macaddr
index|[
literal|0
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|macaddr
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_MAC23
argument_list|)
expr_stmt|;
name|macaddr
index|[
literal|2
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|macaddr
index|[
literal|3
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_MAC45
argument_list|)
expr_stmt|;
name|macaddr
index|[
literal|4
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|macaddr
index|[
literal|5
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* read country code */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_COUNTRY
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"EEPROM region code=0x%04x\n"
operator|,
name|val
operator|)
argument_list|)
expr_stmt|;
comment|/* read vendor BBP settings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_BBP_BASE
operator|+
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|val
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|reg
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"BBP%d=0x%02x\n"
operator|,
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|reg
operator|,
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|val
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
block|{
comment|/* read vendor RF settings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT3071_EEPROM_RF_BASE
operator|+
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|val
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|reg
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"RF%d=0x%02x\n"
operator|,
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|reg
operator|,
name|sc
operator|->
name|rf
index|[
name|i
index|]
operator|.
name|val
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* read RF frequency offset from EEPROM */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_FREQ_LEDS
argument_list|)
expr_stmt|;
name|sc
operator|->
name|freq
operator|=
operator|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
operator|)
condition|?
name|val
operator|&
literal|0xff
else|:
literal|0
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"EEPROM freq offset %d\n"
operator|,
name|sc
operator|->
name|freq
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|>>
literal|8
operator|)
operator|!=
literal|0xff
condition|)
block|{
comment|/* read LEDs operating mode */
name|sc
operator|->
name|leds
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|sc
operator|->
name|led
index|[
literal|0
index|]
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_LED1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|led
index|[
literal|1
index|]
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_LED2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|led
index|[
literal|2
index|]
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_LED3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* broken EEPROM, use default settings */
name|sc
operator|->
name|leds
operator|=
literal|0x01
expr_stmt|;
name|sc
operator|->
name|led
index|[
literal|0
index|]
operator|=
literal|0x5555
expr_stmt|;
name|sc
operator|->
name|led
index|[
literal|1
index|]
operator|=
literal|0x2221
expr_stmt|;
name|sc
operator|->
name|led
index|[
literal|2
index|]
operator|=
literal|0xa9f8
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"EEPROM LED mode=0x%02x, LEDs=0x%04x/0x%04x/0x%04x\n"
operator|,
name|sc
operator|->
name|leds
operator|,
name|sc
operator|->
name|led
index|[
literal|0
index|]
operator|,
name|sc
operator|->
name|led
index|[
literal|1
index|]
operator|,
name|sc
operator|->
name|led
index|[
literal|2
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* read RF information */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_ANTENNA
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0xffff
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"invalid EEPROM antenna info, using default\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3593
condition|)
block|{
comment|/* default to RF3053 3T3R */
name|sc
operator|->
name|rf_rev
operator|=
name|RT3070_RF_3053
expr_stmt|;
name|sc
operator|->
name|ntxchains
operator|=
literal|3
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
block|{
comment|/* default to RF3020 1T1R */
name|sc
operator|->
name|rf_rev
operator|=
name|RT3070_RF_3020
expr_stmt|;
name|sc
operator|->
name|ntxchains
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* default to RF2820 1T2R */
name|sc
operator|->
name|rf_rev
operator|=
name|RT2860_RF_2820
expr_stmt|;
name|sc
operator|->
name|ntxchains
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
name|sc
operator|->
name|rf_rev
operator|=
operator|(
name|val
operator|>>
literal|8
operator|)
operator|&
literal|0xf
expr_stmt|;
name|sc
operator|->
name|ntxchains
operator|=
operator|(
name|val
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
name|val
operator|&
literal|0xf
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"EEPROM RF rev=0x%02x chains=%dT%dR\n"
operator|,
name|sc
operator|->
name|rf_rev
operator|,
name|sc
operator|->
name|ntxchains
operator|,
name|sc
operator|->
name|nrxchains
operator|)
argument_list|)
expr_stmt|;
comment|/* check if RF supports automatic Tx access gain control */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_CONFIG
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"EEPROM CFG 0x%04x\n"
operator|,
name|val
operator|)
argument_list|)
expr_stmt|;
comment|/* check if driver should patch the DAC issue */
if|if
condition|(
operator|(
name|val
operator|>>
literal|8
operator|)
operator|!=
literal|0xff
condition|)
name|sc
operator|->
name|patch_dac
operator|=
operator|(
name|val
operator|>>
literal|15
operator|)
operator|&
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
condition|)
block|{
name|sc
operator|->
name|ext_5ghz_lna
operator|=
operator|(
name|val
operator|>>
literal|3
operator|)
operator|&
literal|1
expr_stmt|;
name|sc
operator|->
name|ext_2ghz_lna
operator|=
operator|(
name|val
operator|>>
literal|2
operator|)
operator|&
literal|1
expr_stmt|;
comment|/* check if RF supports automatic Tx access gain control */
name|sc
operator|->
name|calib_2ghz
operator|=
name|sc
operator|->
name|calib_5ghz
operator|=
literal|0
expr_stmt|;
comment|/* XXX (val>> 1)& 1 */
empty_stmt|;
comment|/* check if we have a hardware radio switch */
name|sc
operator|->
name|rfswitch
operator|=
name|val
operator|&
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|RT2860_ADVANCED_PS
condition|)
block|{
comment|/* read PCIe power save level */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_PCIE_PSLEVEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
condition|)
block|{
name|sc
operator|->
name|pslevel
operator|=
name|val
operator|&
literal|0x3
expr_stmt|;
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_REV
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff80
operator|)
operator|!=
literal|0x9280
condition|)
name|sc
operator|->
name|pslevel
operator|=
name|MIN
argument_list|(
name|sc
operator|->
name|pslevel
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"EEPROM PCIe PS Level=%d\n"
operator|,
name|sc
operator|->
name|pslevel
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* read power settings for 2GHz channels */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|14
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_PWR2GHZ_BASE1
operator|+
name|i
operator|/
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow1
index|[
name|i
operator|+
literal|0
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow1
index|[
name|i
operator|+
literal|1
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_PWR2GHZ_BASE2
operator|+
name|i
operator|/
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow2
index|[
name|i
operator|+
literal|0
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow2
index|[
name|i
operator|+
literal|1
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
comment|/* fix broken Tx power entries */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|14
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
operator|<
literal|0
operator|||
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
operator|>
literal|31
condition|)
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
operator|=
literal|5
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
operator|<
literal|0
operator|||
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
operator|>
literal|31
condition|)
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
operator|=
literal|5
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"chan %d: power1=%d, power2=%d\n"
operator|,
name|rt2860_rf2850
index|[
name|i
index|]
operator|.
name|chan
operator|,
name|sc
operator|->
name|txpow1
index|[
name|i
index|]
operator|,
name|sc
operator|->
name|txpow2
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* read power settings for 5GHz channels */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|40
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_PWR5GHZ_BASE1
operator|+
name|i
operator|/
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow1
index|[
name|i
operator|+
literal|14
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow1
index|[
name|i
operator|+
literal|15
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_PWR5GHZ_BASE2
operator|+
name|i
operator|/
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow2
index|[
name|i
operator|+
literal|14
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow2
index|[
name|i
operator|+
literal|15
index|]
operator|=
call|(
name|int8_t
call|)
argument_list|(
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
block|}
comment|/* fix broken Tx power entries */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|40
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|txpow1
index|[
literal|14
operator|+
name|i
index|]
operator|<
operator|-
literal|7
operator|||
name|sc
operator|->
name|txpow1
index|[
literal|14
operator|+
name|i
index|]
operator|>
literal|15
condition|)
name|sc
operator|->
name|txpow1
index|[
literal|14
operator|+
name|i
index|]
operator|=
literal|5
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|txpow2
index|[
literal|14
operator|+
name|i
index|]
operator|<
operator|-
literal|7
operator|||
name|sc
operator|->
name|txpow2
index|[
literal|14
operator|+
name|i
index|]
operator|>
literal|15
condition|)
name|sc
operator|->
name|txpow2
index|[
literal|14
operator|+
name|i
index|]
operator|=
literal|5
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"chan %d: power1=%d, power2=%d\n"
operator|,
name|rt2860_rf2850
index|[
literal|14
operator|+
name|i
index|]
operator|.
name|chan
operator|,
name|sc
operator|->
name|txpow1
index|[
literal|14
operator|+
name|i
index|]
operator|,
name|sc
operator|->
name|txpow2
index|[
literal|14
operator|+
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* read Tx power compensation for each Tx rate */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_DELTAPWR
argument_list|)
expr_stmt|;
name|delta_2ghz
operator|=
name|delta_5ghz
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
operator|&&
operator|(
name|val
operator|&
literal|0x80
operator|)
condition|)
block|{
name|delta_2ghz
operator|=
name|val
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|val
operator|&
literal|0x40
operator|)
condition|)
comment|/* negative number */
name|delta_2ghz
operator|=
operator|-
name|delta_2ghz
expr_stmt|;
block|}
name|val
operator|>>=
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
operator|&&
operator|(
name|val
operator|&
literal|0x80
operator|)
condition|)
block|{
name|delta_5ghz
operator|=
name|val
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|val
operator|&
literal|0x40
operator|)
condition|)
comment|/* negative number */
name|delta_5ghz
operator|=
operator|-
name|delta_5ghz
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"power compensation=%d (2GHz), %d (5GHz)\n"
operator|,
name|delta_2ghz
operator|,
name|delta_5ghz
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
literal|5
condition|;
name|ridx
operator|++
control|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RPWR
operator|+
name|ridx
operator|*
literal|2
argument_list|)
expr_stmt|;
name|reg
operator|=
name|val
expr_stmt|;
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RPWR
operator|+
name|ridx
operator|*
literal|2
operator|+
literal|1
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
name|uint32_t
operator|)
name|val
operator|<<
literal|16
expr_stmt|;
name|sc
operator|->
name|txpow20mhz
index|[
name|ridx
index|]
operator|=
name|reg
expr_stmt|;
name|sc
operator|->
name|txpow40mhz_2ghz
index|[
name|ridx
index|]
operator|=
name|b4inc
argument_list|(
name|reg
argument_list|,
name|delta_2ghz
argument_list|)
expr_stmt|;
name|sc
operator|->
name|txpow40mhz_5ghz
index|[
name|ridx
index|]
operator|=
name|b4inc
argument_list|(
name|reg
argument_list|,
name|delta_5ghz
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"ridx %d: power 20MHz=0x%08x, 40MHz/2GHz=0x%08x, "
literal|"40MHz/5GHz=0x%08x\n"
operator|,
name|ridx
operator|,
name|sc
operator|->
name|txpow20mhz
index|[
name|ridx
index|]
operator|,
name|sc
operator|->
name|txpow40mhz_2ghz
index|[
name|ridx
index|]
operator|,
name|sc
operator|->
name|txpow40mhz_5ghz
index|[
name|ridx
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* read factory-calibrated samples for temperature compensation */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_TSSI1_2GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tssi_2ghz
index|[
literal|0
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* [-4] */
name|sc
operator|->
name|tssi_2ghz
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* [-3] */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_TSSI2_2GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tssi_2ghz
index|[
literal|2
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* [-2] */
name|sc
operator|->
name|tssi_2ghz
index|[
literal|3
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* [-1] */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_TSSI3_2GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tssi_2ghz
index|[
literal|4
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* [+0] */
name|sc
operator|->
name|tssi_2ghz
index|[
literal|5
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* [+1] */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_TSSI4_2GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tssi_2ghz
index|[
literal|6
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* [+2] */
name|sc
operator|->
name|tssi_2ghz
index|[
literal|7
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* [+3] */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_TSSI5_2GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tssi_2ghz
index|[
literal|8
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* [+4] */
name|sc
operator|->
name|step_2ghz
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"TSSI 2GHz: 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x "
literal|"0x%02x 0x%02x step=%d\n"
operator|,
name|sc
operator|->
name|tssi_2ghz
index|[
literal|0
index|]
operator|,
name|sc
operator|->
name|tssi_2ghz
index|[
literal|1
index|]
operator|,
name|sc
operator|->
name|tssi_2ghz
index|[
literal|2
index|]
operator|,
name|sc
operator|->
name|tssi_2ghz
index|[
literal|3
index|]
operator|,
name|sc
operator|->
name|tssi_2ghz
index|[
literal|4
index|]
operator|,
name|sc
operator|->
name|tssi_2ghz
index|[
literal|5
index|]
operator|,
name|sc
operator|->
name|tssi_2ghz
index|[
literal|6
index|]
operator|,
name|sc
operator|->
name|tssi_2ghz
index|[
literal|7
index|]
operator|,
name|sc
operator|->
name|tssi_2ghz
index|[
literal|8
index|]
operator|,
name|sc
operator|->
name|step_2ghz
operator|)
argument_list|)
expr_stmt|;
comment|/* check that ref value is correct, otherwise disable calibration */
if|if
condition|(
name|sc
operator|->
name|tssi_2ghz
index|[
literal|4
index|]
operator|==
literal|0xff
condition|)
name|sc
operator|->
name|calib_2ghz
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_TSSI1_5GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tssi_5ghz
index|[
literal|0
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* [-4] */
name|sc
operator|->
name|tssi_5ghz
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* [-3] */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_TSSI2_5GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tssi_5ghz
index|[
literal|2
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* [-2] */
name|sc
operator|->
name|tssi_5ghz
index|[
literal|3
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* [-1] */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_TSSI3_5GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tssi_5ghz
index|[
literal|4
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* [+0] */
name|sc
operator|->
name|tssi_5ghz
index|[
literal|5
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* [+1] */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_TSSI4_5GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tssi_5ghz
index|[
literal|6
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* [+2] */
name|sc
operator|->
name|tssi_5ghz
index|[
literal|7
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* [+3] */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_TSSI5_5GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tssi_5ghz
index|[
literal|8
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* [+4] */
name|sc
operator|->
name|step_5ghz
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"TSSI 5GHz: 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x "
literal|"0x%02x 0x%02x step=%d\n"
operator|,
name|sc
operator|->
name|tssi_5ghz
index|[
literal|0
index|]
operator|,
name|sc
operator|->
name|tssi_5ghz
index|[
literal|1
index|]
operator|,
name|sc
operator|->
name|tssi_5ghz
index|[
literal|2
index|]
operator|,
name|sc
operator|->
name|tssi_5ghz
index|[
literal|3
index|]
operator|,
name|sc
operator|->
name|tssi_5ghz
index|[
literal|4
index|]
operator|,
name|sc
operator|->
name|tssi_5ghz
index|[
literal|5
index|]
operator|,
name|sc
operator|->
name|tssi_5ghz
index|[
literal|6
index|]
operator|,
name|sc
operator|->
name|tssi_5ghz
index|[
literal|7
index|]
operator|,
name|sc
operator|->
name|tssi_5ghz
index|[
literal|8
index|]
operator|,
name|sc
operator|->
name|step_5ghz
operator|)
argument_list|)
expr_stmt|;
comment|/* check that ref value is correct, otherwise disable calibration */
if|if
condition|(
name|sc
operator|->
name|tssi_5ghz
index|[
literal|4
index|]
operator|==
literal|0xff
condition|)
name|sc
operator|->
name|calib_5ghz
operator|=
literal|0
expr_stmt|;
comment|/* read RSSI offsets and LNA gains from EEPROM */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RSSI1_2GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rssi_2ghz
index|[
literal|0
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* Ant A */
name|sc
operator|->
name|rssi_2ghz
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* Ant B */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RSSI2_2GHZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
block|{
comment|/* 		 * On RT3090 chips (limited to 2 Rx chains), this ROM 		 * field contains the Tx mixer gain for the 2GHz band. 		 */
if|if
condition|(
operator|(
name|val
operator|&
literal|0xff
operator|)
operator|!=
literal|0xff
condition|)
name|sc
operator|->
name|txmixgain_2ghz
operator|=
name|val
operator|&
literal|0x7
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"tx mixer gain=%u (2GHz)\n"
operator|,
name|sc
operator|->
name|txmixgain_2ghz
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
name|sc
operator|->
name|rssi_2ghz
index|[
literal|2
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* Ant C */
name|sc
operator|->
name|lna
index|[
literal|2
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* channel group 2 */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RSSI1_5GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rssi_5ghz
index|[
literal|0
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* Ant A */
name|sc
operator|->
name|rssi_5ghz
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* Ant B */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_RSSI2_5GHZ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rssi_5ghz
index|[
literal|2
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
comment|/* Ant C */
name|sc
operator|->
name|lna
index|[
literal|3
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* channel group 3 */
name|val
operator|=
name|rt2860_srom_read
argument_list|(
name|sc
argument_list|,
name|RT2860_EEPROM_LNA
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
name|sc
operator|->
name|lna
index|[
literal|0
index|]
operator|=
name|RT3090_DEF_LNA
expr_stmt|;
else|else
comment|/* channel group 0 */
name|sc
operator|->
name|lna
index|[
literal|0
index|]
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|lna
index|[
literal|1
index|]
operator|=
name|val
operator|>>
literal|8
expr_stmt|;
comment|/* channel group 1 */
comment|/* fix broken 5GHz LNA entries */
if|if
condition|(
name|sc
operator|->
name|lna
index|[
literal|2
index|]
operator|==
literal|0
operator|||
name|sc
operator|->
name|lna
index|[
literal|2
index|]
operator|==
literal|0xff
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"invalid LNA for channel group %d\n"
operator|,
literal|2
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lna
index|[
literal|2
index|]
operator|=
name|sc
operator|->
name|lna
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|lna
index|[
literal|3
index|]
operator|==
literal|0
operator|||
name|sc
operator|->
name|lna
index|[
literal|3
index|]
operator|==
literal|0xff
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"invalid LNA for channel group %d\n"
operator|,
literal|3
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lna
index|[
literal|3
index|]
operator|=
name|sc
operator|->
name|lna
index|[
literal|1
index|]
expr_stmt|;
block|}
comment|/* fix broken RSSI offset entries */
for|for
control|(
name|ant
operator|=
literal|0
init|;
name|ant
operator|<
literal|3
condition|;
name|ant
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|rssi_2ghz
index|[
name|ant
index|]
operator|<
operator|-
literal|10
operator|||
name|sc
operator|->
name|rssi_2ghz
index|[
name|ant
index|]
operator|>
literal|10
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"invalid RSSI%d offset: %d (2GHz)\n"
operator|,
name|ant
operator|+
literal|1
operator|,
name|sc
operator|->
name|rssi_2ghz
index|[
name|ant
index|]
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rssi_2ghz
index|[
name|ant
index|]
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|rssi_5ghz
index|[
name|ant
index|]
operator|<
operator|-
literal|10
operator|||
name|sc
operator|->
name|rssi_5ghz
index|[
name|ant
index|]
operator|>
literal|10
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"invalid RSSI%d offset: %d (5GHz)\n"
operator|,
name|ant
operator|+
literal|1
operator|,
name|sc
operator|->
name|rssi_5ghz
index|[
name|ant
index|]
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rssi_5ghz
index|[
name|ant
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rt2860_bbp_init
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof (a) / sizeof ((a)[0]))
name|int
name|i
decl_stmt|,
name|ntries
decl_stmt|;
comment|/* wait for BBP to wake up */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|20
condition|;
name|ntries
operator|++
control|)
block|{
name|uint8_t
name|bbp0
init|=
name|rt2860_mcu_bbp_read
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|bbp0
operator|!=
literal|0
operator|&&
name|bbp0
operator|!=
literal|0xff
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|20
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for BBP to wake up\n"
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
comment|/* initialize BBP registers to default values */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|rt2860_def_bbp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
name|rt2860_def_bbp
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rt2860_def_bbp
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* fix BBP84 for RT2860E */
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x2860
operator|&&
name|sc
operator|->
name|mac_rev
operator|!=
literal|0x0101
condition|)
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|84
argument_list|,
literal|0x19
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
block|{
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|79
argument_list|,
literal|0x13
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|80
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|81
argument_list|,
literal|0x33
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x2860
operator|&&
name|sc
operator|->
name|mac_rev
operator|==
literal|0x0100
condition|)
block|{
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|69
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|73
argument_list|,
literal|0x12
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_function
specifier|static
name|int
name|rt2860_txrx_enable
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* enable Tx/Rx DMA engine */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_MAC_TX_EN
argument_list|)
expr_stmt|;
name|RAL_BARRIER_READ_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|200
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
operator|(
name|RT2860_TX_DMA_BUSY
operator||
name|RT2860_RX_DMA_BUSY
operator|)
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|200
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for DMA engine\n"
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|RT2860_RX_DMA_EN
operator||
name|RT2860_TX_DMA_EN
operator||
name|RT2860_WPDMA_BT_SIZE64
operator|<<
name|RT2860_WPDMA_BT_SIZE_SHIFT
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* set Rx filter */
name|tmp
operator|=
name|RT2860_DROP_CRC_ERR
operator||
name|RT2860_DROP_PHY_ERR
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|!=
name|IEEE80211_M_MONITOR
condition|)
block|{
name|tmp
operator||=
name|RT2860_DROP_UC_NOME
operator||
name|RT2860_DROP_DUPL
operator||
name|RT2860_DROP_CTS
operator||
name|RT2860_DROP_BA
operator||
name|RT2860_DROP_ACK
operator||
name|RT2860_DROP_VER_ERR
operator||
name|RT2860_DROP_CTRL_RSV
operator||
name|RT2860_DROP_CFACK
operator||
name|RT2860_DROP_CFEND
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_STA
condition|)
name|tmp
operator||=
name|RT2860_DROP_RTS
operator||
name|RT2860_DROP_PSPOLL
expr_stmt|;
block|}
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_RX_FILTR_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_MAC_RX_EN
operator||
name|RT2860_MAC_TX_EN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|RAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|ieee80211_start_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_init_locked
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof (a) / sizeof ((a)[0]))
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|bbp1
decl_stmt|,
name|bbp3
decl_stmt|;
name|int
name|i
decl_stmt|,
name|qid
decl_stmt|,
name|ridx
decl_stmt|,
name|ntries
decl_stmt|,
name|error
decl_stmt|;
name|RAL_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rfswitch
condition|)
block|{
comment|/* hardware has a radio switch on GPIO pin 2 */
if|if
condition|(
operator|!
operator|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|)
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"radio is disabled by hardware switch\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|notyet
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
endif|#
directive|endif
block|}
block|}
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_PWR_PIN_CFG
argument_list|,
name|RT2860_IO_RA_PE
argument_list|)
expr_stmt|;
comment|/* disable DMA */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|)
expr_stmt|;
name|tmp
operator|&=
literal|0xff0
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* PBF hardware reset */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|,
literal|0xe1f
argument_list|)
expr_stmt|;
name|RAL_BARRIER_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|,
literal|0xe00
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|rt2860_load_microcode
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load 8051 microcode\n"
argument_list|)
expr_stmt|;
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|rt2860_set_macaddr
argument_list|(
name|sc
argument_list|,
name|IF_LLADDR
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* init Tx power for all Tx rates (from EEPROM) */
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
literal|5
condition|;
name|ridx
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|txpow20mhz
index|[
name|ridx
index|]
operator|==
literal|0xffffffff
condition|)
continue|continue;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_PWR_CFG
argument_list|(
name|ridx
argument_list|)
argument_list|,
name|sc
operator|->
name|txpow20mhz
index|[
name|ridx
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
operator|(
name|RT2860_TX_DMA_BUSY
operator||
name|RT2860_RX_DMA_BUSY
operator|)
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for DMA engine\n"
argument_list|)
expr_stmt|;
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|tmp
operator|&=
literal|0xff0
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* reset Rx ring and all 6 Tx rings */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_RST_IDX
argument_list|,
literal|0x1003f
argument_list|)
expr_stmt|;
comment|/* PBF hardware reset */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|,
literal|0xe1f
argument_list|)
expr_stmt|;
name|RAL_BARRIER_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|,
literal|0xe00
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_PWR_PIN_CFG
argument_list|,
name|RT2860_IO_RA_PE
operator||
name|RT2860_IO_RF_PE
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_BBP_HRST
operator||
name|RT2860_MAC_SRST
argument_list|)
expr_stmt|;
name|RAL_BARRIER_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|rt2860_def_mac
argument_list|)
condition|;
name|i
operator|++
control|)
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|rt2860_def_mac
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rt2860_def_mac
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
block|{
comment|/* set delay of PA_PE assertion to 1us (unit of 0.25us) */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_SW_CFG0
argument_list|,
literal|4
operator|<<
name|RT2860_DLY_PAPE_EN_SHIFT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_PCI_CFG
argument_list|)
operator|&
name|RT2860_PCI_CFG_PCI
operator|)
condition|)
block|{
name|sc
operator|->
name|sc_flags
operator||=
name|RT2860_PCIE
expr_stmt|;
comment|/* PCIe has different clock cycle count than PCI */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_US_CYC_CNT
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|tmp
operator|&
operator|~
literal|0xff
operator|)
operator||
literal|0x7d
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_US_CYC_CNT
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
comment|/* wait while MAC is busy */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_STATUS_REG
argument_list|)
operator|&
operator|(
name|RT2860_RX_STATUS_BUSY
operator||
name|RT2860_TX_STATUS_BUSY
operator|)
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for MAC\n"
argument_list|)
expr_stmt|;
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* clear Host to MCU mailbox */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_BBPAGENT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_RFRESET
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|rt2860_bbp_init
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* clear RX WCID search table */
name|RAL_SET_REGION_4
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ENTRY
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|512
argument_list|)
expr_stmt|;
comment|/* clear pairwise key table */
name|RAL_SET_REGION_4
argument_list|(
name|sc
argument_list|,
name|RT2860_PKEY
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
comment|/* clear IV/EIV table */
name|RAL_SET_REGION_4
argument_list|(
name|sc
argument_list|,
name|RT2860_IVEIV
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|512
argument_list|)
expr_stmt|;
comment|/* clear WCID attribute table */
name|RAL_SET_REGION_4
argument_list|(
name|sc
argument_list|,
name|RT2860_WCID_ATTR
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|256
argument_list|)
expr_stmt|;
comment|/* clear shared key table */
name|RAL_SET_REGION_4
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|8
operator|*
literal|32
argument_list|)
expr_stmt|;
comment|/* clear shared key mode */
name|RAL_SET_REGION_4
argument_list|(
name|sc
argument_list|,
name|RT2860_SKEY_MODE_0_7
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* init Tx rings (4 EDCAs + HCCA + Mgt) */
for|for
control|(
name|qid
operator|=
literal|0
init|;
name|qid
operator|<
literal|6
condition|;
name|qid
operator|++
control|)
block|{
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_BASE_PTR
argument_list|(
name|qid
argument_list|)
argument_list|,
name|sc
operator|->
name|txq
index|[
name|qid
index|]
operator|.
name|paddr
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_MAX_CNT
argument_list|(
name|qid
argument_list|)
argument_list|,
name|RT2860_TX_RING_COUNT
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_CTX_IDX
argument_list|(
name|qid
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* init Rx ring */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_RX_BASE_PTR
argument_list|,
name|sc
operator|->
name|rxq
operator|.
name|paddr
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_RX_MAX_CNT
argument_list|,
name|RT2860_RX_RING_COUNT
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_RX_CALC_IDX
argument_list|,
name|RT2860_RX_RING_COUNT
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* setup maximum buffer sizes */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAX_LEN_CFG
argument_list|,
literal|1
operator|<<
literal|12
operator||
operator|(
name|MCLBYTES
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|rt2860_rxwi
argument_list|)
operator|-
literal|2
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tmp
operator|&
operator|(
name|RT2860_TX_DMA_BUSY
operator||
name|RT2860_RX_DMA_BUSY
operator|)
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for DMA engine\n"
argument_list|)
expr_stmt|;
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|tmp
operator|&=
literal|0xff0
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_WPDMA_GLO_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* disable interrupts mitigation */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_DELAY_INT_CFG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* write vendor-specific BBP values (from EEPROM) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|reg
operator|==
literal|0
operator|||
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|reg
operator|==
literal|0xff
condition|)
continue|continue;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|sc
operator|->
name|bbp
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* select Main antenna for 1T1R devices */
if|if
condition|(
name|sc
operator|->
name|rf_rev
operator|==
name|RT3070_RF_2020
operator|||
name|sc
operator|->
name|rf_rev
operator|==
name|RT3070_RF_3020
operator|||
name|sc
operator|->
name|rf_rev
operator|==
name|RT3070_RF_3320
condition|)
name|rt3090_set_rx_antenna
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* send LEDs operating mode to microcontroller */
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_LED1
argument_list|,
name|sc
operator|->
name|led
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_LED2
argument_list|,
name|sc
operator|->
name|led
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_LED3
argument_list|,
name|sc
operator|->
name|led
index|[
literal|2
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
name|rt3090_rf_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_SLEEP
argument_list|,
literal|0x02ff
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_WAKEUP
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
name|rt3090_rf_wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* disable non-existing Rx chains */
name|bbp3
operator|=
name|rt2860_mcu_bbp_read
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|bbp3
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|3
operator||
literal|1
operator|<<
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|2
condition|)
name|bbp3
operator||=
literal|1
operator|<<
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|3
condition|)
name|bbp3
operator||=
literal|1
operator|<<
literal|4
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|,
name|bbp3
argument_list|)
expr_stmt|;
comment|/* disable non-existing Tx chains */
name|bbp1
operator|=
name|rt2860_mcu_bbp_read
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
name|bbp1
operator|=
operator|(
name|bbp1
operator|&
operator|~
operator|(
literal|1
operator|<<
literal|3
operator||
literal|1
operator|<<
literal|4
operator|)
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3593
operator|&&
name|sc
operator|->
name|ntxchains
operator|==
literal|2
condition|)
name|bbp1
operator|=
operator|(
name|bbp1
operator|&
operator|~
operator|(
literal|1
operator|<<
literal|4
operator|)
operator|)
operator||
literal|1
operator|<<
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|==
literal|0x3593
operator|&&
name|sc
operator|->
name|ntxchains
operator|==
literal|3
condition|)
name|bbp1
operator|=
operator|(
name|bbp1
operator|&
operator|~
operator|(
literal|1
operator|<<
literal|3
operator|)
operator|)
operator||
literal|1
operator|<<
literal|4
expr_stmt|;
name|rt2860_mcu_bbp_write
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
name|bbp1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
name|rt3090_rf_setup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* select default channel */
name|rt2860_switch_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|)
expr_stmt|;
comment|/* reset RF from MCU */
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_RFRESET
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set RTS threshold */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_RTS_CFG
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
literal|0xffff00
expr_stmt|;
name|tmp
operator||=
name|IEEE80211_RTS_DEFAULT
operator|<<
literal|8
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_RTS_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* setup initial protection mode */
name|rt2860_updateprot
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
comment|/* turn radio LED on */
name|rt2860_set_leds
argument_list|(
name|sc
argument_list|,
name|RT2860_LED_RADIO
argument_list|)
expr_stmt|;
comment|/* enable Tx/Rx DMA engine */
if|if
condition|(
operator|(
name|error
operator|=
name|rt2860_txrx_enable
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* clear pending interrupts */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_STATUS
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* enable interrupts */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_MASK
argument_list|,
literal|0x3fffc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|RT2860_ADVANCED_PS
condition|)
name|rt2860_mcu_cmd
argument_list|(
name|sc
argument_list|,
name|RT2860_MCU_CMD_PSLEVEL
argument_list|,
name|sc
operator|->
name|pslevel
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|watchdog_ch
argument_list|,
name|hz
argument_list|,
name|rt2860_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|N
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_stop
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rt2860_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|RAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rt2860_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_stop_locked
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|int
name|qid
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|rt2860_set_leds
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* turn all LEDs off */
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|watchdog_ch
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
comment|/* disable interrupts */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_INT_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* disable GP timer */
name|rt2860_set_gp_timer
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* disable Rx */
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|RT2860_MAC_RX_EN
operator||
name|RT2860_MAC_TX_EN
operator|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* reset adapter */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
name|RT2860_BBP_HRST
operator||
name|RT2860_MAC_SRST
argument_list|)
expr_stmt|;
name|RAL_BARRIER_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_MAC_SYS_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* reset Tx and Rx rings (and reclaim TXWIs) */
name|sc
operator|->
name|qfullmsk
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|qid
operator|=
literal|0
init|;
name|qid
operator|<
literal|6
condition|;
name|qid
operator|++
control|)
name|rt2860_reset_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
index|[
name|qid
index|]
argument_list|)
expr_stmt|;
name|rt2860_reset_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rxq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rt2860_load_microcode
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|struct
name|firmware
modifier|*
name|fp
decl_stmt|;
name|int
name|ntries
decl_stmt|,
name|error
decl_stmt|;
name|RAL_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|fp
operator|=
name|firmware_get
argument_list|(
literal|"rt2860fw"
argument_list|)
expr_stmt|;
name|RAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unable to receive rt2860fw firmware image\n"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
comment|/* set "host program ram write selection" bit */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|,
name|RT2860_HST_PM_SEL
argument_list|)
expr_stmt|;
comment|/* write microcode image */
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|RT2860_FW_BASE
argument_list|,
name|fp
operator|->
name|data
argument_list|,
name|fp
operator|->
name|datasize
argument_list|)
expr_stmt|;
comment|/* kick microcontroller unit */
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RAL_BARRIER_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|,
name|RT2860_MCU_RESET
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_BBPAGENT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_H2M_MAILBOX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* wait until microcontroller is ready */
name|RAL_BARRIER_READ_WRITE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_SYS_CTRL
argument_list|)
operator|&
name|RT2860_MCU_READY
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for MCU to initialize\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ETIMEDOUT
expr_stmt|;
block|}
else|else
name|error
operator|=
literal|0
expr_stmt|;
name|firmware_put
argument_list|(
name|fp
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * This function is called periodically to adjust Tx power based on  * temperature variation.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|NOT_YET
end_ifdef

begin_function
specifier|static
name|void
name|rt2860_calib
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|tssi
decl_stmt|;
name|uint8_t
name|step
decl_stmt|,
name|bbp49
decl_stmt|;
name|int8_t
name|ridx
decl_stmt|,
name|d
decl_stmt|;
comment|/* read current temperature */
name|bbp49
operator|=
name|rt2860_mcu_bbp_read
argument_list|(
name|sc
argument_list|,
literal|49
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|ic
operator|->
name|ic_bss
operator|->
name|ni_chan
argument_list|)
condition|)
block|{
name|tssi
operator|=
operator|&
name|sc
operator|->
name|tssi_2ghz
index|[
literal|4
index|]
expr_stmt|;
name|step
operator|=
name|sc
operator|->
name|step_2ghz
expr_stmt|;
block|}
else|else
block|{
name|tssi
operator|=
operator|&
name|sc
operator|->
name|tssi_5ghz
index|[
literal|4
index|]
expr_stmt|;
name|step
operator|=
name|sc
operator|->
name|step_5ghz
expr_stmt|;
block|}
if|if
condition|(
name|bbp49
operator|<
name|tssi
index|[
literal|0
index|]
condition|)
block|{
comment|/* lower than reference */
comment|/* use higher Tx power than default */
for|for
control|(
name|d
operator|=
literal|0
init|;
name|d
operator|>
operator|-
literal|4
operator|&&
name|bbp49
operator|<=
name|tssi
index|[
name|d
operator|-
literal|1
index|]
condition|;
name|d
operator|--
control|)
empty_stmt|;
block|}
elseif|else
if|if
condition|(
name|bbp49
operator|>
name|tssi
index|[
literal|0
index|]
condition|)
block|{
comment|/* greater than reference */
comment|/* use lower Tx power than default */
for|for
control|(
name|d
operator|=
literal|0
init|;
name|d
operator|<
operator|+
literal|4
operator|&&
name|bbp49
operator|>=
name|tssi
index|[
name|d
operator|+
literal|1
index|]
condition|;
name|d
operator|++
control|)
empty_stmt|;
block|}
else|else
block|{
comment|/* use default Tx power */
name|d
operator|=
literal|0
expr_stmt|;
block|}
name|d
operator|*=
name|step
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"BBP49=0x%02x, adjusting Tx power by %d\n"
operator|,
name|bbp49
operator|,
name|d
operator|)
argument_list|)
expr_stmt|;
comment|/* write adjusted Tx power values for each Tx rate */
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
literal|5
condition|;
name|ridx
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|txpow20mhz
index|[
name|ridx
index|]
operator|==
literal|0xffffffff
condition|)
continue|continue;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_TX_PWR_CFG
argument_list|(
name|ridx
argument_list|)
argument_list|,
name|b4inc
argument_list|(
name|sc
operator|->
name|txpow20mhz
index|[
name|ridx
index|]
argument_list|,
name|d
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|rt3090_set_rx_antenna
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|int
name|aux
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|aux
condition|)
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_PCI_EECTRL
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_PCI_EECTRL
argument_list|,
name|tmp
operator|&
operator|~
name|RT2860_C
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|,
operator|(
name|tmp
operator|&
operator|~
literal|0x0808
operator|)
operator||
literal|0x08
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_PCI_EECTRL
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_PCI_EECTRL
argument_list|,
name|tmp
operator||
name|RT2860_C
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|)
expr_stmt|;
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_GPIO_CTRL
argument_list|,
name|tmp
operator|&
operator|~
literal|0x0808
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_switch_chan
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|u_int
name|chan
decl_stmt|,
name|group
decl_stmt|;
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|==
literal|0
operator|||
name|chan
operator|==
name|IEEE80211_CHAN_ANY
condition|)
return|return;
if|if
condition|(
name|sc
operator|->
name|mac_ver
operator|>=
literal|0x3071
condition|)
name|rt3090_set_chan
argument_list|(
name|sc
argument_list|,
name|chan
argument_list|)
expr_stmt|;
else|else
name|rt2860_set_chan
argument_list|(
name|sc
argument_list|,
name|chan
argument_list|)
expr_stmt|;
comment|/* determine channel group */
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
name|group
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|64
condition|)
name|group
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|128
condition|)
name|group
operator|=
literal|2
expr_stmt|;
else|else
name|group
operator|=
literal|3
expr_stmt|;
comment|/* XXX necessary only when group has changed! */
name|rt2860_select_chan_group
argument_list|(
name|sc
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rt2860_setup_beacon
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|ieee80211_beacon_offsets
name|bo
decl_stmt|;
name|struct
name|rt2860_txwi
name|txwi
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|ridx
decl_stmt|;
if|if
condition|(
operator|(
name|m
operator|=
name|ieee80211_beacon_alloc
argument_list|(
name|vap
operator|->
name|iv_bss
argument_list|,
operator|&
name|bo
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|ENOBUFS
return|;
name|memset
argument_list|(
operator|&
name|txwi
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|txwi
argument_list|)
expr_stmt|;
name|txwi
operator|.
name|wcid
operator|=
literal|0xff
expr_stmt|;
name|txwi
operator|.
name|len
operator|=
name|htole16
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
comment|/* send beacons at the lowest available rate */
name|ridx
operator|=
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|ic
operator|->
name|ic_bsschan
argument_list|)
condition|?
name|RT2860_RIDX_OFDM6
else|:
name|RT2860_RIDX_CCK1
expr_stmt|;
name|txwi
operator|.
name|phy
operator|=
name|htole16
argument_list|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|mcs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rt2860_rates
index|[
name|ridx
index|]
operator|.
name|phy
operator|==
name|IEEE80211_T_OFDM
condition|)
name|txwi
operator|.
name|phy
operator||=
name|htole16
argument_list|(
name|RT2860_PHY_OFDM
argument_list|)
expr_stmt|;
name|txwi
operator|.
name|txop
operator|=
name|RT2860_TX_TXOP_HT
expr_stmt|;
name|txwi
operator|.
name|flags
operator|=
name|RT2860_TX_TS
expr_stmt|;
name|txwi
operator|.
name|xflags
operator|=
name|RT2860_TX_NSEQ
expr_stmt|;
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_BASE
argument_list|(
literal|0
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|txwi
argument_list|,
sizeof|sizeof
name|txwi
argument_list|)
expr_stmt|;
name|RAL_WRITE_REGION_1
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_BASE
argument_list|(
literal|0
argument_list|)
operator|+
sizeof|sizeof
name|txwi
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|uint8_t
operator|*
argument_list|)
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rt2860_enable_tsf_sync
parameter_list|(
name|struct
name|rt2860_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ifp
operator|->
name|if_l2com
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|RAL_READ
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
literal|0x1fffff
expr_stmt|;
name|tmp
operator||=
name|vap
operator|->
name|iv_bss
operator|->
name|ni_intval
operator|*
literal|16
expr_stmt|;
name|tmp
operator||=
name|RT2860_TSF_TIMER_EN
operator||
name|RT2860_TBTT_TIMER_EN
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_STA
condition|)
block|{
comment|/* 		 * Local TSF is always updated with remote TSF on beacon 		 * reception. 		 */
name|tmp
operator||=
literal|1
operator|<<
name|RT2860_TSF_SYNC_MODE_SHIFT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_IBSS
operator|||
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_MBSS
condition|)
block|{
name|tmp
operator||=
name|RT2860_BCN_TX_EN
expr_stmt|;
comment|/* 		 * Local TSF is updated with remote TSF on beacon reception 		 * only if the remote TSF is greater than local TSF. 		 */
name|tmp
operator||=
literal|2
operator|<<
name|RT2860_TSF_SYNC_MODE_SHIFT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vap
operator|->
name|iv_opmode
operator|==
name|IEEE80211_M_HOSTAP
condition|)
block|{
name|tmp
operator||=
name|RT2860_BCN_TX_EN
expr_stmt|;
comment|/* SYNC with nobody */
name|tmp
operator||=
literal|3
operator|<<
name|RT2860_TSF_SYNC_MODE_SHIFT
expr_stmt|;
block|}
name|RAL_WRITE
argument_list|(
name|sc
argument_list|,
name|RT2860_BCN_TIME_CFG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


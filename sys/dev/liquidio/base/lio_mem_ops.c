begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *   BSD LICENSE  *  *   Copyright(c) 2017 Cavium, Inc.. All rights reserved.  *   All rights reserved.  *  *   Redistribution and use in source and binary forms, with or without  *   modification, are permitted provided that the following conditions  *   are met:  *  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in  *       the documentation and/or other materials provided with the  *       distribution.  *     * Neither the name of Cavium, Inc. nor the names of its  *       contributors may be used to endorse or promote products derived  *       from this software without specific prior written permission.  *  *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  *   "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  *   OWNER(S) OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|"lio_bsd.h"
end_include

begin_include
include|#
directive|include
file|"lio_common.h"
end_include

begin_include
include|#
directive|include
file|"lio_droq.h"
end_include

begin_include
include|#
directive|include
file|"lio_iq.h"
end_include

begin_include
include|#
directive|include
file|"lio_response_manager.h"
end_include

begin_include
include|#
directive|include
file|"lio_device.h"
end_include

begin_include
include|#
directive|include
file|"lio_mem_ops.h"
end_include

begin_define
define|#
directive|define
name|MEMOPS_IDX
value|LIO_MAX_BAR1_MAP_INDEX
end_define

begin_if
if|#
directive|if
name|BYTE_ORDER
operator|==
name|BIG_ENDIAN
end_if

begin_function
specifier|static
specifier|inline
name|void
name|lio_toggle_bar1_swapmode
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint32_t
name|idx
parameter_list|)
block|{
name|uint32_t
name|mask
decl_stmt|;
name|mask
operator|=
name|oct
operator|->
name|fn_list
operator|.
name|bar1_idx_read
argument_list|(
name|oct
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|mask
operator|=
operator|(
name|mask
operator|&
literal|0x2
operator|)
condition|?
operator|(
name|mask
operator|&
operator|~
literal|2
operator|)
else|:
operator|(
name|mask
operator||
literal|2
operator|)
expr_stmt|;
name|oct
operator|->
name|fn_list
operator|.
name|bar1_idx_write
argument_list|(
name|oct
argument_list|,
name|idx
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* BYTE_ORDER != BIG_ENDIAN */
end_comment

begin_define
define|#
directive|define
name|lio_toggle_bar1_swapmode
parameter_list|(
name|oct
parameter_list|,
name|idx
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* BYTE_ORDER == BIG_ENDIAN */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|lio_write_bar1_mem8
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint64_t
name|val
parameter_list|)
block|{
name|bus_space_write_1
argument_list|(
name|oct
operator|->
name|mem_bus_space
index|[
literal|1
index|]
operator|.
name|tag
argument_list|,
name|oct
operator|->
name|mem_bus_space
index|[
literal|1
index|]
operator|.
name|handle
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|uint64_t
name|lio_read_bar1_mem64
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint32_t
name|reg
parameter_list|)
block|{
return|return
operator|(
name|bus_space_read_8
argument_list|(
name|oct
operator|->
name|mem_bus_space
index|[
literal|1
index|]
operator|.
name|tag
argument_list|,
name|oct
operator|->
name|mem_bus_space
index|[
literal|1
index|]
operator|.
name|handle
argument_list|,
name|reg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|lio_write_bar1_mem64
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint64_t
name|val
parameter_list|)
block|{
name|bus_space_write_8
argument_list|(
name|oct
operator|->
name|mem_bus_space
index|[
literal|1
index|]
operator|.
name|tag
argument_list|,
name|oct
operator|->
name|mem_bus_space
index|[
literal|1
index|]
operator|.
name|handle
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lio_pci_fastwrite
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint8_t
modifier|*
name|hostbuf
parameter_list|,
name|uint32_t
name|len
parameter_list|)
block|{
while|while
condition|(
operator|(
name|len
operator|)
operator|&&
operator|(
operator|(
name|unsigned
name|long
operator|)
name|offset
operator|)
operator|&
literal|7
condition|)
block|{
name|lio_write_bar1_mem8
argument_list|(
name|oct
argument_list|,
name|offset
operator|++
argument_list|,
operator|*
operator|(
name|hostbuf
operator|++
operator|)
argument_list|)
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
name|lio_toggle_bar1_swapmode
argument_list|(
name|oct
argument_list|,
name|MEMOPS_IDX
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|>=
literal|8
condition|)
block|{
name|lio_write_bar1_mem64
argument_list|(
name|oct
argument_list|,
name|offset
argument_list|,
operator|*
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|hostbuf
operator|)
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|8
expr_stmt|;
name|hostbuf
operator|+=
literal|8
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
block|}
name|lio_toggle_bar1_swapmode
argument_list|(
name|oct
argument_list|,
name|MEMOPS_IDX
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
name|lio_write_bar1_mem8
argument_list|(
name|oct
argument_list|,
name|offset
operator|++
argument_list|,
operator|*
operator|(
name|hostbuf
operator|++
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|uint64_t
name|lio_read_bar1_mem8
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint32_t
name|reg
parameter_list|)
block|{
return|return
operator|(
name|bus_space_read_1
argument_list|(
name|oct
operator|->
name|mem_bus_space
index|[
literal|1
index|]
operator|.
name|tag
argument_list|,
name|oct
operator|->
name|mem_bus_space
index|[
literal|1
index|]
operator|.
name|handle
argument_list|,
name|reg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lio_pci_fastread
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint8_t
modifier|*
name|hostbuf
parameter_list|,
name|uint32_t
name|len
parameter_list|)
block|{
while|while
condition|(
operator|(
name|len
operator|)
operator|&&
operator|(
operator|(
name|unsigned
name|long
operator|)
name|offset
operator|)
operator|&
literal|7
condition|)
block|{
operator|*
operator|(
name|hostbuf
operator|++
operator|)
operator|=
name|lio_read_bar1_mem8
argument_list|(
name|oct
argument_list|,
name|offset
operator|++
argument_list|)
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
name|lio_toggle_bar1_swapmode
argument_list|(
name|oct
argument_list|,
name|MEMOPS_IDX
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|>=
literal|8
condition|)
block|{
operator|*
operator|(
operator|(
name|uint64_t
operator|*
operator|)
name|hostbuf
operator|)
operator|=
name|lio_read_bar1_mem64
argument_list|(
name|oct
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|8
expr_stmt|;
name|hostbuf
operator|+=
literal|8
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
block|}
name|lio_toggle_bar1_swapmode
argument_list|(
name|oct
argument_list|,
name|MEMOPS_IDX
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
operator|*
operator|(
name|hostbuf
operator|++
operator|)
operator|=
name|lio_read_bar1_mem8
argument_list|(
name|oct
argument_list|,
name|offset
operator|++
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Core mem read/write with temporary bar1 settings. */
end_comment

begin_comment
comment|/* op = 1 to read, op = 0 to write. */
end_comment

begin_function
specifier|static
name|void
name|lio_pci_rw_core_mem
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|uint8_t
modifier|*
name|hostbuf
parameter_list|,
name|uint32_t
name|len
parameter_list|,
name|uint32_t
name|op
parameter_list|)
block|{
name|uint64_t
name|static_mapping_base
decl_stmt|;
name|uint32_t
name|copy_len
init|=
literal|0
decl_stmt|,
name|index_reg_val
init|=
literal|0
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|static_mapping_base
operator|=
name|oct
operator|->
name|console_nb_info
operator|.
name|dram_region_base
expr_stmt|;
if|if
condition|(
name|static_mapping_base
operator|&&
name|static_mapping_base
operator|==
operator|(
name|addr
operator|&
literal|0xFFFFFFFFFFC00000ULL
operator|)
condition|)
block|{
name|int
name|bar1_index
init|=
name|oct
operator|->
name|console_nb_info
operator|.
name|bar1_index
decl_stmt|;
name|offset
operator|=
operator|(
name|bar1_index
operator|<<
literal|22
operator|)
operator|+
operator|(
name|addr
operator|&
literal|0x3fffff
operator|)
expr_stmt|;
if|if
condition|(
name|op
condition|)
name|lio_pci_fastread
argument_list|(
name|oct
argument_list|,
name|offset
argument_list|,
name|hostbuf
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|else
name|lio_pci_fastwrite
argument_list|(
name|oct
argument_list|,
name|offset
argument_list|,
name|hostbuf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|mtx_lock
argument_list|(
operator|&
name|oct
operator|->
name|mem_access_lock
argument_list|)
expr_stmt|;
comment|/* Save the original index reg value. */
name|index_reg_val
operator|=
name|oct
operator|->
name|fn_list
operator|.
name|bar1_idx_read
argument_list|(
name|oct
argument_list|,
name|MEMOPS_IDX
argument_list|)
expr_stmt|;
do|do
block|{
name|oct
operator|->
name|fn_list
operator|.
name|bar1_idx_setup
argument_list|(
name|oct
argument_list|,
name|addr
argument_list|,
name|MEMOPS_IDX
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|offset
operator|=
operator|(
name|MEMOPS_IDX
operator|<<
literal|22
operator|)
operator|+
operator|(
name|addr
operator|&
literal|0x3fffff
operator|)
expr_stmt|;
comment|/* 		 * If operation crosses a 4MB boundary, split the transfer 		 * at the 4MB boundary. 		 */
if|if
condition|(
operator|(
operator|(
name|addr
operator|+
name|len
operator|-
literal|1
operator|)
operator|&
operator|~
operator|(
literal|0x3fffff
operator|)
operator|)
operator|!=
operator|(
name|addr
operator|&
operator|~
operator|(
literal|0x3fffff
operator|)
operator|)
condition|)
block|{
name|copy_len
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
operator|(
name|addr
operator|&
operator|~
operator|(
literal|0x3fffff
operator|)
operator|)
operator|+
operator|(
name|MEMOPS_IDX
operator|<<
literal|22
operator|)
operator|)
operator|-
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|copy_len
operator|=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|op
condition|)
block|{
comment|/* read from core */
name|lio_pci_fastread
argument_list|(
name|oct
argument_list|,
name|offset
argument_list|,
name|hostbuf
argument_list|,
name|copy_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lio_pci_fastwrite
argument_list|(
name|oct
argument_list|,
name|offset
argument_list|,
name|hostbuf
argument_list|,
name|copy_len
argument_list|)
expr_stmt|;
block|}
name|len
operator|-=
name|copy_len
expr_stmt|;
name|addr
operator|+=
name|copy_len
expr_stmt|;
name|hostbuf
operator|+=
name|copy_len
expr_stmt|;
block|}
do|while
condition|(
name|len
condition|)
do|;
name|oct
operator|->
name|fn_list
operator|.
name|bar1_idx_write
argument_list|(
name|oct
argument_list|,
name|MEMOPS_IDX
argument_list|,
name|index_reg_val
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|oct
operator|->
name|mem_access_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|lio_pci_read_core_mem
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint64_t
name|coreaddr
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|)
block|{
name|lio_pci_rw_core_mem
argument_list|(
name|oct
argument_list|,
name|coreaddr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|lio_pci_write_core_mem
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint64_t
name|coreaddr
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|len
parameter_list|)
block|{
name|lio_pci_rw_core_mem
argument_list|(
name|oct
argument_list|,
name|coreaddr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint64_t
name|lio_read_device_mem64
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint64_t
name|coreaddr
parameter_list|)
block|{
name|__be64
name|ret
decl_stmt|;
name|lio_pci_rw_core_mem
argument_list|(
name|oct
argument_list|,
name|coreaddr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ret
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|be64toh
argument_list|(
name|ret
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|lio_read_device_mem32
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint64_t
name|coreaddr
parameter_list|)
block|{
name|__be32
name|ret
decl_stmt|;
name|lio_pci_rw_core_mem
argument_list|(
name|oct
argument_list|,
name|coreaddr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ret
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|be32toh
argument_list|(
name|ret
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|lio_write_device_mem32
parameter_list|(
name|struct
name|octeon_device
modifier|*
name|oct
parameter_list|,
name|uint64_t
name|coreaddr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|__be32
name|t
init|=
name|htobe32
argument_list|(
name|val
argument_list|)
decl_stmt|;
name|lio_pci_rw_core_mem
argument_list|(
name|oct
argument_list|,
name|coreaddr
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|t
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


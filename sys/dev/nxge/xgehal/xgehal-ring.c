begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2007 Neterion, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-ring.h>
end_include

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-device.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
end_if

begin_function
specifier|static
name|ptrdiff_t
name|__hal_ring_item_dma_offset
parameter_list|(
name|xge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|item
parameter_list|)
block|{
name|int
name|memblock_idx
decl_stmt|;
name|void
modifier|*
name|memblock
decl_stmt|;
comment|/* get owner memblock index */
name|memblock_idx
operator|=
name|__hal_ring_block_memblock_idx
argument_list|(
name|item
argument_list|)
expr_stmt|;
comment|/* get owner memblock by memblock index */
name|memblock
operator|=
name|__hal_mempool_memblock
argument_list|(
name|mempoolh
argument_list|,
name|memblock_idx
argument_list|)
expr_stmt|;
return|return
operator|(
name|char
operator|*
operator|)
name|item
operator|-
operator|(
name|char
operator|*
operator|)
name|memblock
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|dma_addr_t
name|__hal_ring_item_dma_addr
parameter_list|(
name|xge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|pci_dma_h
modifier|*
name|dma_handle
parameter_list|)
block|{
name|int
name|memblock_idx
decl_stmt|;
name|void
modifier|*
name|memblock
decl_stmt|;
name|xge_hal_mempool_dma_t
modifier|*
name|memblock_dma_object
decl_stmt|;
name|ptrdiff_t
name|dma_item_offset
decl_stmt|;
comment|/* get owner memblock index */
name|memblock_idx
operator|=
name|__hal_ring_block_memblock_idx
argument_list|(
operator|(
name|xge_hal_ring_block_t
operator|*
operator|)
name|item
argument_list|)
expr_stmt|;
comment|/* get owner memblock by memblock index */
name|memblock
operator|=
name|__hal_mempool_memblock
argument_list|(
operator|(
name|xge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|memblock_idx
argument_list|)
expr_stmt|;
comment|/* get memblock DMA object by memblock index */
name|memblock_dma_object
operator|=
name|__hal_mempool_memblock_dma
argument_list|(
operator|(
name|xge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|memblock_idx
argument_list|)
expr_stmt|;
comment|/* calculate offset in the memblock of this item */
name|dma_item_offset
operator|=
operator|(
name|char
operator|*
operator|)
name|item
operator|-
operator|(
name|char
operator|*
operator|)
name|memblock
expr_stmt|;
operator|*
name|dma_handle
operator|=
name|memblock_dma_object
operator|->
name|handle
expr_stmt|;
return|return
name|memblock_dma_object
operator|->
name|addr
operator|+
name|dma_item_offset
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__hal_ring_rxdblock_link
parameter_list|(
name|xge_hal_mempool_h
name|mempoolh
parameter_list|,
name|xge_hal_ring_t
modifier|*
name|ring
parameter_list|,
name|int
name|from
parameter_list|,
name|int
name|to
parameter_list|)
block|{
name|xge_hal_ring_block_t
modifier|*
name|to_item
decl_stmt|,
modifier|*
name|from_item
decl_stmt|;
name|dma_addr_t
name|to_dma
decl_stmt|,
name|from_dma
decl_stmt|;
name|pci_dma_h
name|to_dma_handle
decl_stmt|,
name|from_dma_handle
decl_stmt|;
comment|/* get "from" RxD block */
name|from_item
operator|=
operator|(
name|xge_hal_ring_block_t
operator|*
operator|)
name|__hal_mempool_item
argument_list|(
operator|(
name|xge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|from
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|from_item
argument_list|)
expr_stmt|;
comment|/* get "to" RxD block */
name|to_item
operator|=
operator|(
name|xge_hal_ring_block_t
operator|*
operator|)
name|__hal_mempool_item
argument_list|(
operator|(
name|xge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|to
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|to_item
argument_list|)
expr_stmt|;
comment|/* return address of the beginning of previous RxD block */
name|to_dma
operator|=
name|__hal_ring_item_dma_addr
argument_list|(
name|mempoolh
argument_list|,
name|to_item
argument_list|,
operator|&
name|to_dma_handle
argument_list|)
expr_stmt|;
comment|/* set next pointer for this RxD block to point on 	 * previous item's DMA start address */
name|__hal_ring_block_next_pointer_set
argument_list|(
name|from_item
argument_list|,
name|to_dma
argument_list|)
expr_stmt|;
comment|/* return "from" RxD block's DMA start address */
name|from_dma
operator|=
name|__hal_ring_item_dma_addr
argument_list|(
name|mempoolh
argument_list|,
name|from_item
argument_list|,
operator|&
name|from_dma_handle
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
comment|/* we must sync "from" RxD block, so hardware will see it */
name|xge_os_dma_sync
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|from_dma_handle
argument_list|,
name|from_dma
operator|+
name|XGE_HAL_RING_NEXT_BLOCK_POINTER_OFFSET
argument_list|,
name|__hal_ring_item_dma_offset
argument_list|(
name|mempoolh
argument_list|,
name|from_item
argument_list|)
operator|+
name|XGE_HAL_RING_NEXT_BLOCK_POINTER_OFFSET
argument_list|,
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
name|XGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"block%d:0x"
name|XGE_OS_LLXFMT
literal|" => block%d:0x"
name|XGE_OS_LLXFMT
argument_list|,
name|from
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|from_dma
argument_list|,
name|to
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|to_dma
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|xge_hal_status_e
name|__hal_ring_mempool_item_alloc
parameter_list|(
name|xge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|memblock
parameter_list|,
name|int
name|memblock_index
parameter_list|,
name|xge_hal_mempool_dma_t
modifier|*
name|dma_object
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|int
name|index
parameter_list|,
name|int
name|is_last
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|xge_hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|xge_assert
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|ring
argument_list|)
expr_stmt|;
comment|/* format rxds array */
for|for
control|(
name|i
operator|=
name|ring
operator|->
name|rxds_per_block
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|void
modifier|*
name|rxdblock_priv
decl_stmt|;
name|xge_hal_ring_rxd_priv_t
modifier|*
name|rxd_priv
decl_stmt|;
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
decl_stmt|;
name|int
name|reserve_index
init|=
name|index
operator|*
name|ring
operator|->
name|rxds_per_block
operator|+
name|i
decl_stmt|;
name|int
name|memblock_item_idx
decl_stmt|;
name|ring
operator|->
name|reserved_rxds_arr
index|[
name|reserve_index
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|item
operator|+
operator|(
name|ring
operator|->
name|rxds_per_block
operator|-
literal|1
operator|-
name|i
operator|)
operator|*
name|ring
operator|->
name|rxd_size
expr_stmt|;
comment|/* Note: memblock_item_idx is index of the item within 	     *       the memblock. For instance, in case of three RxD-blocks 	     *       per memblock this value can be 0,1 or 2. */
name|rxdblock_priv
operator|=
name|__hal_mempool_item_priv
argument_list|(
operator|(
name|xge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|memblock_index
argument_list|,
name|item
argument_list|,
operator|&
name|memblock_item_idx
argument_list|)
expr_stmt|;
name|rxdp
operator|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|ring
operator|->
name|reserved_rxds_arr
index|[
name|reserve_index
index|]
expr_stmt|;
name|rxd_priv
operator|=
operator|(
name|xge_hal_ring_rxd_priv_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|rxdblock_priv
operator|+
name|ring
operator|->
name|rxd_priv_size
operator|*
name|i
operator|)
expr_stmt|;
comment|/* pre-format per-RxD Ring's private */
name|rxd_priv
operator|->
name|dma_offset
operator|=
operator|(
name|char
operator|*
operator|)
name|rxdp
operator|-
operator|(
name|char
operator|*
operator|)
name|memblock
expr_stmt|;
name|rxd_priv
operator|->
name|dma_addr
operator|=
name|dma_object
operator|->
name|addr
operator|+
name|rxd_priv
operator|->
name|dma_offset
expr_stmt|;
name|rxd_priv
operator|->
name|dma_handle
operator|=
name|dma_object
operator|->
name|handle
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
name|rxd_priv
operator|->
name|dma_object
operator|=
name|dma_object
expr_stmt|;
endif|#
directive|endif
comment|/* pre-format Host_Control */
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_USE_5B_MODE
argument_list|)
if|if
condition|(
name|ring
operator|->
name|buffer_mode
operator|==
name|XGE_HAL_RING_QUEUE_BUFFER_MODE_5
condition|)
block|{
name|xge_hal_ring_rxd_5_t
modifier|*
name|rxdp_5
init|=
operator|(
name|xge_hal_ring_rxd_5_t
operator|*
operator|)
name|rxdp
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_PLATFORM_64BIT
argument_list|)
name|xge_assert
argument_list|(
name|memblock_index
operator|<=
literal|0xFFFF
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|i
operator|<=
literal|0xFFFF
argument_list|)
expr_stmt|;
comment|/* store memblock's index */
name|rxdp_5
operator|->
name|host_control
operator|=
operator|(
name|u32
operator|)
name|memblock_index
operator|<<
literal|16
expr_stmt|;
comment|/* store index of memblock's private */
name|rxdp_5
operator|->
name|host_control
operator||=
call|(
name|u32
call|)
argument_list|(
name|memblock_item_idx
operator|*
name|ring
operator|->
name|rxds_per_block
operator|+
name|i
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* 32-bit case */
name|rxdp_5
operator|->
name|host_control
operator|=
operator|(
name|u32
operator|)
name|rxd_priv
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
comment|/* 1b and 3b modes */
name|rxdp
operator|->
name|host_control
operator|=
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|rxd_priv
expr_stmt|;
block|}
else|#
directive|else
comment|/* 1b and 3b modes */
name|rxdp
operator|->
name|host_control
operator|=
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|rxd_priv
expr_stmt|;
endif|#
directive|endif
block|}
name|__hal_ring_block_memblock_idx_set
argument_list|(
operator|(
name|xge_hal_ring_block_t
operator|*
operator|)
name|item
argument_list|,
name|memblock_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_last
condition|)
block|{
comment|/* link last one with first one */
name|__hal_ring_rxdblock_link
argument_list|(
name|mempoolh
argument_list|,
name|ring
argument_list|,
literal|0
argument_list|,
name|index
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|index
operator|>
literal|0
condition|)
block|{
comment|/* link this RxD block with previous one */
name|__hal_ring_rxdblock_link
argument_list|(
name|mempoolh
argument_list|,
name|ring
argument_list|,
name|index
argument_list|,
name|index
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_function
name|xge_hal_status_e
name|__hal_ring_initial_replenish
parameter_list|(
name|xge_hal_channel_t
modifier|*
name|channel
parameter_list|,
name|xge_hal_channel_reopen_e
name|reopen
parameter_list|)
block|{
name|xge_hal_dtr_h
name|dtr
init|=
name|NULL
decl_stmt|;
while|while
condition|(
name|xge_hal_channel_dtr_count
argument_list|(
name|channel
argument_list|)
operator|>
literal|0
condition|)
block|{
name|xge_hal_status_e
name|status
decl_stmt|;
name|status
operator|=
name|xge_hal_ring_dtr_reserve
argument_list|(
name|channel
argument_list|,
operator|&
name|dtr
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|status
operator|==
name|XGE_HAL_OK
argument_list|)
expr_stmt|;
if|if
condition|(
name|channel
operator|->
name|dtr_init
condition|)
block|{
name|status
operator|=
name|channel
operator|->
name|dtr_init
argument_list|(
name|channel
argument_list|,
name|dtr
argument_list|,
name|channel
operator|->
name|reserve_length
argument_list|,
name|channel
operator|->
name|userdata
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|XGE_HAL_OK
condition|)
block|{
name|xge_hal_ring_dtr_free
argument_list|(
name|channel
argument_list|,
name|dtr
argument_list|)
expr_stmt|;
name|xge_hal_channel_abort
argument_list|(
name|channel
argument_list|,
name|XGE_HAL_CHANNEL_OC_NORMAL
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
name|xge_hal_ring_dtr_post
argument_list|(
name|channel
argument_list|,
name|dtr
argument_list|)
expr_stmt|;
block|}
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_function
name|xge_hal_status_e
name|__hal_ring_open
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_channel_attr_t
modifier|*
name|attr
parameter_list|)
block|{
name|xge_hal_status_e
name|status
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|xge_hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_ring_queue_t
modifier|*
name|queue
decl_stmt|;
comment|/* Note: at this point we have channel.devh and channel.pdev 	 *       pre-set only! */
name|hldev
operator|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|ring
operator|->
name|config
operator|=
operator|&
name|hldev
operator|->
name|config
operator|.
name|ring
expr_stmt|;
name|queue
operator|=
operator|&
name|ring
operator|->
name|config
operator|->
name|queue
index|[
name|attr
operator|->
name|post_qid
index|]
expr_stmt|;
name|ring
operator|->
name|indicate_max_pkts
operator|=
name|queue
operator|->
name|indicate_max_pkts
expr_stmt|;
name|ring
operator|->
name|buffer_mode
operator|=
name|queue
operator|->
name|buffer_mode
expr_stmt|;
name|xge_assert
argument_list|(
name|queue
operator|->
name|configured
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE
argument_list|)
name|xge_os_spin_lock_init
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE_IRQ
argument_list|)
name|xge_os_spin_lock_init_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|,
name|hldev
operator|->
name|irqh
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST
argument_list|)
name|xge_os_spin_lock_init
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|xge_os_spin_lock_init_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|irqh
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ring
operator|->
name|rxd_size
operator|=
name|XGE_HAL_RING_RXD_SIZEOF
argument_list|(
name|queue
operator|->
name|buffer_mode
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rxd_priv_size
operator|=
sizeof|sizeof
argument_list|(
name|xge_hal_ring_rxd_priv_t
argument_list|)
operator|+
name|attr
operator|->
name|per_dtr_space
expr_stmt|;
comment|/* how many RxDs can fit into one block. Depends on configured 	 * buffer_mode. */
name|ring
operator|->
name|rxds_per_block
operator|=
name|XGE_HAL_RING_RXDS_PER_BLOCK
argument_list|(
name|queue
operator|->
name|buffer_mode
argument_list|)
expr_stmt|;
comment|/* calculate actual RxD block private size */
name|ring
operator|->
name|rxdblock_priv_size
operator|=
name|ring
operator|->
name|rxd_priv_size
operator|*
name|ring
operator|->
name|rxds_per_block
expr_stmt|;
name|ring
operator|->
name|reserved_rxds_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|queue
operator|->
name|max
operator|*
name|ring
operator|->
name|rxds_per_block
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|reserved_rxds_arr
operator|==
name|NULL
condition|)
block|{
name|__hal_ring_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|ring
operator|->
name|mempool
operator|=
name|__hal_mempool_create
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|ring
operator|->
name|config
operator|->
name|memblock_size
argument_list|,
name|XGE_HAL_RING_RXDBLOCK_SIZE
argument_list|,
name|ring
operator|->
name|rxdblock_priv_size
argument_list|,
name|queue
operator|->
name|initial
argument_list|,
name|queue
operator|->
name|max
argument_list|,
name|__hal_ring_mempool_item_alloc
argument_list|,
name|NULL
argument_list|,
comment|/* nothing to free */
name|ring
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|mempool
operator|==
name|NULL
condition|)
block|{
name|__hal_ring_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|status
operator|=
name|__hal_channel_initialize
argument_list|(
name|channelh
argument_list|,
name|attr
argument_list|,
name|ring
operator|->
name|reserved_rxds_arr
argument_list|,
name|queue
operator|->
name|initial
operator|*
name|ring
operator|->
name|rxds_per_block
argument_list|,
name|queue
operator|->
name|max
operator|*
name|ring
operator|->
name|rxds_per_block
argument_list|,
literal|0
comment|/* no threshold for ring! */
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|XGE_HAL_OK
condition|)
block|{
name|__hal_ring_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* sanity check that everything formatted ok */
name|xge_assert
argument_list|(
name|ring
operator|->
name|reserved_rxds_arr
index|[
literal|0
index|]
operator|==
operator|(
name|char
operator|*
operator|)
name|ring
operator|->
name|mempool
operator|->
name|items_arr
index|[
literal|0
index|]
operator|+
operator|(
name|ring
operator|->
name|rxds_per_block
operator|*
name|ring
operator|->
name|rxd_size
operator|-
name|ring
operator|->
name|rxd_size
operator|)
argument_list|)
expr_stmt|;
comment|/* Note: 	 * Specifying dtr_init callback means two things: 	 * 1) dtrs need to be initialized by ULD at channel-open time; 	 * 2) dtrs need to be posted at channel-open time 	 *    (that's what the initial_replenish() below does) 	 * Currently we don't have a case when the 1) is done without the 2). 	 */
if|if
condition|(
name|ring
operator|->
name|channel
operator|.
name|dtr_init
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|=
name|__hal_ring_initial_replenish
argument_list|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
argument_list|,
name|XGE_HAL_CHANNEL_OC_NORMAL
argument_list|)
operator|)
operator|!=
name|XGE_HAL_OK
condition|)
block|{
name|__hal_ring_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
comment|/* initial replenish will increment the counter in its post() routine, 	 * we have to reset it */
name|ring
operator|->
name|channel
operator|.
name|usage_cnt
operator|=
literal|0
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_function
name|void
name|__hal_ring_close
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|)
block|{
name|xge_hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_ring_queue_t
modifier|*
name|queue
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE
argument_list|)
operator|||
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE_IRQ
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST
argument_list|)
operator|||
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
decl_stmt|;
endif|#
directive|endif
name|xge_assert
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|)
expr_stmt|;
name|queue
operator|=
operator|&
name|ring
operator|->
name|config
operator|->
name|queue
index|[
name|ring
operator|->
name|channel
operator|.
name|post_qid
index|]
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|mempool
condition|)
block|{
name|__hal_mempool_destroy
argument_list|(
name|ring
operator|->
name|mempool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ring
operator|->
name|reserved_rxds_arr
condition|)
block|{
name|xge_os_free
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|ring
operator|->
name|reserved_rxds_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|queue
operator|->
name|max
operator|*
name|ring
operator|->
name|rxds_per_block
argument_list|)
expr_stmt|;
block|}
name|__hal_channel_terminate
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE
argument_list|)
name|xge_os_spin_lock_destroy
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE_IRQ
argument_list|)
name|xge_os_spin_lock_destroy_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST
argument_list|)
name|xge_os_spin_lock_destroy
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|xge_os_spin_lock_destroy_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|__hal_ring_prc_enable
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|)
block|{
name|xge_hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
decl_stmt|;
name|xge_hal_pci_bar0_t
modifier|*
name|bar0
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|void
modifier|*
name|first_block
decl_stmt|;
name|int
name|block_num
decl_stmt|;
name|xge_hal_ring_queue_t
modifier|*
name|queue
decl_stmt|;
name|pci_dma_h
name|dma_handle
decl_stmt|;
name|xge_assert
argument_list|(
name|ring
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|)
expr_stmt|;
name|bar0
operator|=
operator|(
name|xge_hal_pci_bar0_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
operator|)
operator|->
name|bar0
expr_stmt|;
name|queue
operator|=
operator|&
name|ring
operator|->
name|config
operator|->
name|queue
index|[
name|ring
operator|->
name|channel
operator|.
name|post_qid
index|]
expr_stmt|;
name|xge_assert
argument_list|(
name|queue
operator|->
name|buffer_mode
operator|==
literal|1
operator|||
name|queue
operator|->
name|buffer_mode
operator|==
literal|3
operator|||
name|queue
operator|->
name|buffer_mode
operator|==
literal|5
argument_list|)
expr_stmt|;
comment|/* last block in fact becomes first. This is just the way it 	 * is filled up and linked by item_alloc() */
name|block_num
operator|=
name|queue
operator|->
name|initial
expr_stmt|;
name|first_block
operator|=
name|__hal_mempool_item
argument_list|(
name|ring
operator|->
name|mempool
argument_list|,
name|block_num
operator|-
literal|1
argument_list|)
expr_stmt|;
name|val64
operator|=
name|__hal_ring_item_dma_addr
argument_list|(
name|ring
operator|->
name|mempool
argument_list|,
name|first_block
argument_list|,
operator|&
name|dma_handle
argument_list|)
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|prc_rxd0_n
index|[
name|ring
operator|->
name|channel
operator|.
name|post_qid
index|]
argument_list|)
expr_stmt|;
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"ring%d PRC DMA addr 0x"
name|XGE_OS_LLXFMT
literal|" initialized"
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|post_qid
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|val64
argument_list|)
expr_stmt|;
name|val64
operator|=
name|xge_os_pio_mem_read64
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|regh0
argument_list|,
operator|&
name|bar0
operator|->
name|prc_ctrl_n
index|[
name|ring
operator|->
name|channel
operator|.
name|post_qid
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|==
name|XGE_HAL_CARD_HERC
operator|&&
operator|!
name|queue
operator|->
name|rth_en
condition|)
block|{
name|val64
operator||=
name|XGE_HAL_PRC_CTRL_RTH_DISABLE
expr_stmt|;
block|}
name|val64
operator||=
name|XGE_HAL_PRC_CTRL_RC_ENABLED
expr_stmt|;
name|val64
operator||=
name|vBIT
argument_list|(
operator|(
name|queue
operator|->
name|buffer_mode
operator|>>
literal|1
operator|)
argument_list|,
literal|14
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* 1,3 or 5 => 0,1 or 2 */
name|val64
operator|&=
operator|~
name|XGE_HAL_PRC_CTRL_RXD_BACKOFF_INTERVAL
argument_list|(
literal|0xFFFFFF
argument_list|)
expr_stmt|;
name|val64
operator||=
name|XGE_HAL_PRC_CTRL_RXD_BACKOFF_INTERVAL
argument_list|(
operator|(
name|hldev
operator|->
name|config
operator|.
name|pci_freq_mherz
operator|*
name|queue
operator|->
name|backoff_interval_us
operator|)
argument_list|)
expr_stmt|;
comment|/* Beware: no snoop by the bridge if (no_snoop_bits) */
name|val64
operator||=
name|XGE_HAL_PRC_CTRL_NO_SNOOP
argument_list|(
name|queue
operator|->
name|no_snoop_bits
argument_list|)
expr_stmt|;
comment|/* Herc: always use group_reads */
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|==
name|XGE_HAL_CARD_HERC
condition|)
name|val64
operator||=
name|XGE_HAL_PRC_CTRL_GROUP_READS
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|config
operator|.
name|bimodal_interrupts
condition|)
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|==
name|XGE_HAL_CARD_HERC
condition|)
name|val64
operator||=
name|XGE_HAL_PRC_CTRL_BIMODAL_INTERRUPT
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|prc_ctrl_n
index|[
name|ring
operator|->
name|channel
operator|.
name|post_qid
index|]
argument_list|)
expr_stmt|;
comment|/* Configure Receive Protocol Assist */
name|val64
operator|=
name|xge_os_pio_mem_read64
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|regh0
argument_list|,
operator|&
name|bar0
operator|->
name|rx_pa_cfg
argument_list|)
expr_stmt|;
name|val64
operator||=
name|XGE_HAL_RX_PA_CFG_SCATTER_MODE
argument_list|(
name|ring
operator|->
name|config
operator|->
name|scatter_mode
argument_list|)
expr_stmt|;
name|val64
operator||=
operator|(
name|XGE_HAL_RX_PA_CFG_IGNORE_SNAP_OUI
operator||
name|XGE_HAL_RX_PA_CFG_IGNORE_LLC_CTRL
operator|)
expr_stmt|;
comment|/* Clean STRIP_VLAN_TAG bit and set as config from upper layer */
name|val64
operator|&=
operator|~
name|XGE_HAL_RX_PA_CFG_STRIP_VLAN_TAG_MODE
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|val64
operator||=
name|XGE_HAL_RX_PA_CFG_STRIP_VLAN_TAG_MODE
argument_list|(
name|ring
operator|->
name|config
operator|->
name|strip_vlan_tag
argument_list|)
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|rx_pa_cfg
argument_list|)
expr_stmt|;
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"ring%d enabled in buffer_mode %d"
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|post_qid
argument_list|,
name|queue
operator|->
name|buffer_mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|__hal_ring_prc_disable
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|)
block|{
name|xge_hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_pci_bar0_t
modifier|*
name|bar0
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|xge_assert
argument_list|(
name|ring
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|)
expr_stmt|;
name|bar0
operator|=
operator|(
name|xge_hal_pci_bar0_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
operator|)
operator|->
name|bar0
expr_stmt|;
name|val64
operator|=
name|xge_os_pio_mem_read64
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|regh0
argument_list|,
operator|&
name|bar0
operator|->
name|prc_ctrl_n
index|[
name|ring
operator|->
name|channel
operator|.
name|post_qid
index|]
argument_list|)
expr_stmt|;
name|val64
operator|&=
operator|~
operator|(
operator|(
name|u64
operator|)
name|XGE_HAL_PRC_CTRL_RC_ENABLED
operator|)
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|prc_ctrl_n
index|[
name|ring
operator|->
name|channel
operator|.
name|post_qid
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|__hal_ring_hw_initialize
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|xge_hal_pci_bar0_t
modifier|*
name|bar0
init|=
operator|(
name|xge_hal_pci_bar0_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|hldev
operator|->
name|bar0
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Rx DMA intialization. */
name|val64
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_MAX_RING_NUM
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|configured
condition|)
continue|continue;
name|val64
operator||=
name|vBIT
argument_list|(
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|priority
argument_list|,
operator|(
literal|5
operator|+
operator|(
name|i
operator|*
literal|8
operator|)
operator|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|rx_queue_priority
argument_list|)
expr_stmt|;
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"Rings priority configured to 0x"
name|XGE_OS_LLXFMT
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|val64
argument_list|)
expr_stmt|;
comment|/* Configuring ring queues according to per-ring configuration */
name|val64
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_MAX_RING_NUM
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|configured
condition|)
continue|continue;
name|val64
operator||=
name|vBIT
argument_list|(
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|dram_size_mb
argument_list|,
operator|(
name|i
operator|*
literal|8
operator|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|rx_queue_cfg
argument_list|)
expr_stmt|;
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"DRAM configured to 0x"
name|XGE_OS_LLXFMT
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|val64
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hldev
operator|->
name|config
operator|.
name|rts_qos_en
operator|&&
operator|!
name|hldev
operator|->
name|config
operator|.
name|rts_port_en
operator|&&
operator|!
name|hldev
operator|->
name|config
operator|.
name|rts_mac_en
condition|)
block|{
comment|/* 	     * Activate default (QoS-based) Rx steering 	     */
name|val64
operator|=
name|xge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
operator|&
name|bar0
operator|->
name|rts_qos_steering
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
comment|/* QoS max */
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_MAX_RING_NUM
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|configured
condition|)
continue|continue;
if|if
condition|(
operator|!
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|rth_en
condition|)
name|val64
operator||=
operator|(
name|BIT
argument_list|(
name|i
argument_list|)
operator|>>
operator|(
name|j
operator|*
literal|8
operator|)
operator|)
expr_stmt|;
block|}
block|}
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|rts_qos_steering
argument_list|)
expr_stmt|;
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"QoS steering configured to 0x"
name|XGE_OS_LLXFMT
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|val64
argument_list|)
expr_stmt|;
block|}
comment|/* Note: If a queue does not exist, it should be assigned a maximum 	 *   length of zero. Otherwise, packet loss could occur. 	 *   P. 4-4 User guide. 	 * 	 * All configured rings will be properly set at device open time 	 * by utilizing device_mtu_set() API call. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_MAX_RING_NUM
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|configured
condition|)
continue|continue;
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
literal|0ULL
argument_list|,
operator|&
name|bar0
operator|->
name|rts_frm_len_n
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|XGE_HAL_HERC_EMULATION
name|val64
operator|=
name|xge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
operator|(
operator|(
name|u8
operator|*
operator|)
name|bar0
operator|+
literal|0x2e60
operator|)
argument_list|)
expr_stmt|;
comment|/* mc_rldram_mrs_herc */
name|val64
operator||=
literal|0x0000000000010000
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
operator|(
operator|(
name|u8
operator|*
operator|)
name|bar0
operator|+
literal|0x2e60
operator|)
argument_list|)
expr_stmt|;
name|val64
operator||=
literal|0x003a000000000000
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
operator|(
operator|(
name|u8
operator|*
operator|)
name|bar0
operator|+
literal|0x2e40
operator|)
argument_list|)
expr_stmt|;
comment|/* mc_rldram_ref_herc */
name|xge_os_mdelay
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* now enabling MC-RLDRAM after setting MC_QUEUE sizes */
name|val64
operator|=
name|xge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
operator|&
name|bar0
operator|->
name|mc_rldram_mrs
argument_list|)
expr_stmt|;
name|val64
operator||=
name|XGE_HAL_MC_RLDRAM_QUEUE_SIZE_ENABLE
operator||
name|XGE_HAL_MC_RLDRAM_MRS_ENABLE
expr_stmt|;
name|__hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|val64
operator|>>
literal|32
argument_list|)
argument_list|,
operator|&
name|bar0
operator|->
name|mc_rldram_mrs
argument_list|)
expr_stmt|;
name|xge_os_wmb
argument_list|()
expr_stmt|;
name|__hal_pio_mem_write32_lower
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
operator|(
name|u32
operator|)
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|mc_rldram_mrs
argument_list|)
expr_stmt|;
comment|/* RLDRAM initialization procedure require 500us to complete */
name|xge_os_mdelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Temporary fixes for Herc RLDRAM */
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|==
name|XGE_HAL_CARD_HERC
condition|)
block|{
name|val64
operator|=
name|XGE_HAL_MC_RLDRAM_SET_REF_PERIOD
argument_list|(
literal|0x0279
argument_list|)
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|mc_rldram_ref_per_herc
argument_list|)
expr_stmt|;
name|val64
operator|=
name|xge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
operator|&
name|bar0
operator|->
name|mc_rldram_mrs_herc
argument_list|)
expr_stmt|;
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"default mc_rldram_mrs_herc 0x"
name|XGE_OS_LLXFMT
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|val64
argument_list|)
expr_stmt|;
name|val64
operator|=
literal|0x0003570003010300ULL
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|mc_rldram_mrs_herc
argument_list|)
expr_stmt|;
name|xge_os_mdelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Assign MSI-X vectors 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_MAX_RING_NUM
condition|;
name|i
operator|++
control|)
block|{
name|xge_list_t
modifier|*
name|item
decl_stmt|;
name|xge_hal_channel_t
modifier|*
name|channel
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|configured
operator|||
operator|!
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|intr_vector
operator|||
operator|!
name|hldev
operator|->
name|config
operator|.
name|intr_mode
operator|!=
name|XGE_HAL_INTR_MODE_MSIX
condition|)
continue|continue;
comment|/* find channel */
name|xge_list_for_each
argument_list|(
argument|item
argument_list|,
argument|&hldev->free_channels
argument_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|xge_container_of
argument_list|(
name|item
argument_list|,
name|xge_hal_channel_t
argument_list|,
name|item
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
operator|&&
name|tmp
operator|->
name|post_qid
operator|==
name|i
condition|)
block|{
name|channel
operator|=
name|tmp
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|channel
condition|)
block|{
name|xge_hal_channel_msix_set
argument_list|(
name|channel
argument_list|,
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|intr_vector
argument_list|)
expr_stmt|;
block|}
block|}
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"%s"
argument_list|,
literal|"ring channels initialized"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|__hal_ring_mtu_set
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|,
name|int
name|new_frmlen
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|xge_hal_pci_bar0_t
modifier|*
name|bar0
init|=
operator|(
name|xge_hal_pci_bar0_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|hldev
operator|->
name|bar0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_MAX_RING_NUM
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|configured
condition|)
continue|continue;
if|if
condition|(
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|max_frm_len
operator|!=
name|XGE_HAL_RING_USE_MTU
condition|)
block|{
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|XGE_HAL_MAC_RTS_FRM_LEN_SET
argument_list|(
name|hldev
operator|->
name|config
operator|.
name|ring
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|max_frm_len
argument_list|)
argument_list|,
operator|&
name|bar0
operator|->
name|rts_frm_len_n
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|XGE_HAL_MAC_RTS_FRM_LEN_SET
argument_list|(
name|new_frmlen
argument_list|)
argument_list|,
operator|&
name|bar0
operator|->
name|rts_frm_len_n
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|XGE_HAL_RMAC_MAX_PYLD_LEN
argument_list|(
name|new_frmlen
argument_list|)
argument_list|,
operator|&
name|bar0
operator|->
name|rmac_max_pyld_len
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


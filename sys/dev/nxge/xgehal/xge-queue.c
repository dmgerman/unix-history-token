begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2007 Neterion, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  *  FileName :    xge-queue.c  *  *  Description:  serialized event queue  *  *  Created:      7 June 2004  */
end_comment

begin_include
include|#
directive|include
file|<dev/nxge/include/xge-queue.h>
end_include

begin_comment
comment|/**  * xge_queue_item_data - Get item's data.  * @item: Queue item.  *  * Returns:  item data(variable size). Note that xge_queue_t  * contains items comprized of a fixed xge_queue_item_t "header"  * and a variable size data. This function returns the variable  * user-defined portion of the queue item.  */
end_comment

begin_function
name|void
modifier|*
name|xge_queue_item_data
parameter_list|(
name|xge_queue_item_t
modifier|*
name|item
parameter_list|)
block|{
return|return
operator|(
name|char
operator|*
operator|)
name|item
operator|+
sizeof|sizeof
argument_list|(
name|xge_queue_item_t
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * __queue_consume - (Lockless) dequeue an item from the specified queue.  *  * @queue: Event queue.  * See xge_queue_consume().  */
end_comment

begin_function
specifier|static
name|xge_queue_status_e
name|__queue_consume
parameter_list|(
name|xge_queue_t
modifier|*
name|queue
parameter_list|,
name|int
name|data_max_size
parameter_list|,
name|xge_queue_item_t
modifier|*
name|item
parameter_list|)
block|{
name|int
name|real_size
decl_stmt|;
name|xge_queue_item_t
modifier|*
name|elem
decl_stmt|;
if|if
condition|(
name|xge_list_is_empty
argument_list|(
operator|&
name|queue
operator|->
name|list_head
argument_list|)
condition|)
return|return
name|XGE_QUEUE_IS_EMPTY
return|;
name|elem
operator|=
operator|(
name|xge_queue_item_t
operator|*
operator|)
name|queue
operator|->
name|list_head
operator|.
name|next
expr_stmt|;
if|if
condition|(
name|elem
operator|->
name|data_size
operator|>
name|data_max_size
condition|)
return|return
name|XGE_QUEUE_NOT_ENOUGH_SPACE
return|;
name|xge_list_remove
argument_list|(
operator|&
name|elem
operator|->
name|item
argument_list|)
expr_stmt|;
name|real_size
operator|=
name|elem
operator|->
name|data_size
operator|+
sizeof|sizeof
argument_list|(
name|xge_queue_item_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|queue
operator|->
name|head_ptr
operator|==
name|elem
condition|)
block|{
name|queue
operator|->
name|head_ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|head_ptr
operator|+
name|real_size
expr_stmt|;
name|xge_debug_queue
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"event_type: %d removing from the head: "
literal|"0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|" elem 0x"
name|XGE_OS_LLXFMT
literal|" length %d"
argument_list|,
name|elem
operator|->
name|event_type
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|start_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|head_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|tail_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|end_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|elem
argument_list|,
name|real_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|tail_ptr
operator|-
name|real_size
operator|==
operator|(
name|char
operator|*
operator|)
name|elem
condition|)
block|{
name|queue
operator|->
name|tail_ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|tail_ptr
operator|-
name|real_size
expr_stmt|;
name|xge_debug_queue
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"event_type: %d removing from the tail: "
literal|"0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|" elem 0x"
name|XGE_OS_LLXFMT
literal|" length %d"
argument_list|,
name|elem
operator|->
name|event_type
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|start_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|head_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|tail_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|end_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|elem
argument_list|,
name|real_size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xge_debug_queue
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"event_type: %d removing from the list: "
literal|"0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|" elem 0x"
name|XGE_OS_LLXFMT
literal|" length %d"
argument_list|,
name|elem
operator|->
name|event_type
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|start_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|head_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|tail_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|end_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|elem
argument_list|,
name|real_size
argument_list|)
expr_stmt|;
block|}
name|xge_assert
argument_list|(
name|queue
operator|->
name|tail_ptr
operator|>=
name|queue
operator|->
name|head_ptr
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|queue
operator|->
name|tail_ptr
operator|>=
name|queue
operator|->
name|start_ptr
operator|&&
name|queue
operator|->
name|tail_ptr
operator|<=
name|queue
operator|->
name|end_ptr
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|queue
operator|->
name|head_ptr
operator|>=
name|queue
operator|->
name|start_ptr
operator|&&
name|queue
operator|->
name|head_ptr
operator|<
name|queue
operator|->
name|end_ptr
argument_list|)
expr_stmt|;
name|xge_os_memcpy
argument_list|(
name|item
argument_list|,
name|elem
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_queue_item_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_memcpy
argument_list|(
name|xge_queue_item_data
argument_list|(
name|item
argument_list|)
argument_list|,
name|xge_queue_item_data
argument_list|(
name|elem
argument_list|)
argument_list|,
name|elem
operator|->
name|data_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|xge_list_is_empty
argument_list|(
operator|&
name|queue
operator|->
name|list_head
argument_list|)
condition|)
block|{
comment|/* reset buffer pointers just to be clean */
name|queue
operator|->
name|head_ptr
operator|=
name|queue
operator|->
name|tail_ptr
operator|=
name|queue
operator|->
name|start_ptr
expr_stmt|;
block|}
return|return
name|XGE_QUEUE_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_queue_produce - Enqueue an item (see xge_queue_item_t{})  *                      into the specified queue.  * @queueh: Queue handle.  * @event_type: Event type. One of the enumerated event types  *              that both consumer and producer "understand".  *              For an example, please refer to xge_hal_event_e.  * @context: Opaque (void*) "context", for instance event producer object.  * @is_critical: For critical event, e.g. ECC.  * @data_size: Size of the @data.  * @data: User data of variable @data_size that is _copied_ into  *        the new queue item (see xge_queue_item_t{}). Upon return  *        from the call the @data memory can be re-used or released.  *  * Enqueue a new item.  *  * Returns: XGE_QUEUE_OK - success.  * XGE_QUEUE_IS_FULL - Queue is full.  * XGE_QUEUE_OUT_OF_MEMORY - Memory allocation failed.  *  * See also: xge_queue_item_t{}, xge_queue_consume().  */
end_comment

begin_function
name|xge_queue_status_e
name|xge_queue_produce
parameter_list|(
name|xge_queue_h
name|queueh
parameter_list|,
name|int
name|event_type
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|int
name|is_critical
parameter_list|,
specifier|const
name|int
name|data_size
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|xge_queue_t
modifier|*
name|queue
init|=
operator|(
name|xge_queue_t
operator|*
operator|)
name|queueh
decl_stmt|;
name|int
name|real_size
init|=
name|data_size
operator|+
sizeof|sizeof
argument_list|(
name|xge_queue_item_t
argument_list|)
decl_stmt|;
name|xge_queue_item_t
modifier|*
name|elem
decl_stmt|;
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
name|xge_assert
argument_list|(
name|real_size
operator|<=
name|XGE_QUEUE_BUF_SIZE
argument_list|)
expr_stmt|;
name|xge_os_spin_lock_irq
argument_list|(
operator|&
name|queue
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_critical
operator|&&
operator|!
name|queue
operator|->
name|has_critical_event
condition|)
block|{
name|unsigned
name|char
name|item_buf
index|[
sizeof|sizeof
argument_list|(
name|xge_queue_item_t
argument_list|)
operator|+
name|XGE_DEFAULT_EVENT_MAX_DATA_SIZE
index|]
decl_stmt|;
name|xge_queue_item_t
modifier|*
name|item
init|=
operator|(
name|xge_queue_item_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|item_buf
decl_stmt|;
name|xge_os_memzero
argument_list|(
name|item_buf
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|xge_queue_item_t
argument_list|)
operator|+
name|XGE_DEFAULT_EVENT_MAX_DATA_SIZE
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|__queue_consume
argument_list|(
name|queue
argument_list|,
name|XGE_DEFAULT_EVENT_MAX_DATA_SIZE
argument_list|,
name|item
argument_list|)
operator|!=
name|XGE_QUEUE_IS_EMPTY
condition|)
empty_stmt|;
comment|/* do nothing */
block|}
name|try_again
label|:
if|if
condition|(
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|tail_ptr
operator|+
name|real_size
operator|<=
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|end_ptr
condition|)
block|{
name|elem
operator|=
operator|(
name|xge_queue_item_t
operator|*
operator|)
name|queue
operator|->
name|tail_ptr
expr_stmt|;
name|queue
operator|->
name|tail_ptr
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|tail_ptr
operator|+
name|real_size
operator|)
expr_stmt|;
name|xge_debug_queue
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"event_type: %d adding to the tail: "
literal|"0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|" elem 0x"
name|XGE_OS_LLXFMT
literal|" length %d"
argument_list|,
name|event_type
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|start_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|head_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|tail_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|end_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|elem
argument_list|,
name|real_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|head_ptr
operator|-
name|real_size
operator|>=
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|start_ptr
condition|)
block|{
name|elem
operator|=
operator|(
name|xge_queue_item_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|head_ptr
operator|-
name|real_size
operator|)
expr_stmt|;
name|queue
operator|->
name|head_ptr
operator|=
name|elem
expr_stmt|;
name|xge_debug_queue
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"event_type: %d adding to the head: "
literal|"0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|":0x"
name|XGE_OS_LLXFMT
literal|" length %d"
argument_list|,
name|event_type
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|start_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|head_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|tail_ptr
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
operator|->
name|end_ptr
argument_list|,
name|real_size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xge_queue_status_e
name|status
decl_stmt|;
if|if
condition|(
name|queue
operator|->
name|pages_current
operator|>=
name|queue
operator|->
name|pages_max
condition|)
block|{
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
name|queue
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|XGE_QUEUE_IS_FULL
return|;
block|}
if|if
condition|(
name|queue
operator|->
name|has_critical_event
condition|)
block|{
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
name|queue
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|XGE_QUEUE_IS_FULL
return|;
block|}
comment|/* grow */
name|status
operator|=
name|__io_queue_grow
argument_list|(
name|queueh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|XGE_QUEUE_OK
condition|)
block|{
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
name|queue
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
goto|goto
name|try_again
goto|;
block|}
name|xge_assert
argument_list|(
name|queue
operator|->
name|tail_ptr
operator|>=
name|queue
operator|->
name|head_ptr
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|queue
operator|->
name|tail_ptr
operator|>=
name|queue
operator|->
name|start_ptr
operator|&&
name|queue
operator|->
name|tail_ptr
operator|<=
name|queue
operator|->
name|end_ptr
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|queue
operator|->
name|head_ptr
operator|>=
name|queue
operator|->
name|start_ptr
operator|&&
name|queue
operator|->
name|head_ptr
operator|<
name|queue
operator|->
name|end_ptr
argument_list|)
expr_stmt|;
name|elem
operator|->
name|data_size
operator|=
name|data_size
expr_stmt|;
name|elem
operator|->
name|event_type
operator|=
operator|(
name|xge_hal_event_e
operator|)
name|event_type
expr_stmt|;
name|elem
operator|->
name|is_critical
operator|=
name|is_critical
expr_stmt|;
if|if
condition|(
name|is_critical
condition|)
name|queue
operator|->
name|has_critical_event
operator|=
literal|1
expr_stmt|;
name|elem
operator|->
name|context
operator|=
name|context
expr_stmt|;
name|xge_os_memcpy
argument_list|(
name|xge_queue_item_data
argument_list|(
name|elem
argument_list|)
argument_list|,
name|data
argument_list|,
name|data_size
argument_list|)
expr_stmt|;
name|xge_list_insert_before
argument_list|(
operator|&
name|elem
operator|->
name|item
argument_list|,
operator|&
name|queue
operator|->
name|list_head
argument_list|)
expr_stmt|;
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
name|queue
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
comment|/* no lock taken! */
name|queue
operator|->
name|queued_func
argument_list|(
name|queue
operator|->
name|queued_data
argument_list|,
name|event_type
argument_list|)
expr_stmt|;
return|return
name|XGE_QUEUE_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_queue_create - Create protected first-in-first-out queue.  * @pdev: PCI device handle.  * @irqh: PCI device IRQ handle.  * @pages_initial: Number of pages to be initially allocated at the  * time of queue creation.  * @pages_max: Max number of pages that can be allocated in the queue.  * @queued: Optional callback function to be called each time a new item is  * added to the queue.  * @queued_data: Argument to the callback function.  *  * Create protected (fifo) queue.  *  * Returns: Pointer to xge_queue_t structure,  * NULL - on failure.  *  * See also: xge_queue_item_t{}, xge_queue_destroy().  */
end_comment

begin_function
name|xge_queue_h
name|xge_queue_create
parameter_list|(
name|pci_dev_h
name|pdev
parameter_list|,
name|pci_irq_h
name|irqh
parameter_list|,
name|int
name|pages_initial
parameter_list|,
name|int
name|pages_max
parameter_list|,
name|xge_queued_f
name|queued
parameter_list|,
name|void
modifier|*
name|queued_data
parameter_list|)
block|{
name|xge_queue_t
modifier|*
name|queue
decl_stmt|;
if|if
condition|(
operator|(
name|queue
operator|=
operator|(
name|xge_queue_t
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_queue_t
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|queue
operator|->
name|queued_func
operator|=
name|queued
expr_stmt|;
name|queue
operator|->
name|queued_data
operator|=
name|queued_data
expr_stmt|;
name|queue
operator|->
name|pdev
operator|=
name|pdev
expr_stmt|;
name|queue
operator|->
name|irqh
operator|=
name|irqh
expr_stmt|;
name|queue
operator|->
name|pages_current
operator|=
name|pages_initial
expr_stmt|;
name|queue
operator|->
name|start_ptr
operator|=
name|xge_os_malloc
argument_list|(
name|pdev
argument_list|,
name|queue
operator|->
name|pages_current
operator|*
name|XGE_QUEUE_BUF_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|queue
operator|->
name|start_ptr
operator|==
name|NULL
condition|)
block|{
name|xge_os_free
argument_list|(
name|pdev
argument_list|,
name|queue
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_queue_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|queue
operator|->
name|head_ptr
operator|=
name|queue
operator|->
name|tail_ptr
operator|=
name|queue
operator|->
name|start_ptr
expr_stmt|;
name|queue
operator|->
name|end_ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|start_ptr
operator|+
name|queue
operator|->
name|pages_current
operator|*
name|XGE_QUEUE_BUF_SIZE
expr_stmt|;
name|xge_os_spin_lock_init_irq
argument_list|(
operator|&
name|queue
operator|->
name|lock
argument_list|,
name|irqh
argument_list|)
expr_stmt|;
name|queue
operator|->
name|pages_initial
operator|=
name|pages_initial
expr_stmt|;
name|queue
operator|->
name|pages_max
operator|=
name|pages_max
expr_stmt|;
name|xge_list_init
argument_list|(
operator|&
name|queue
operator|->
name|list_head
argument_list|)
expr_stmt|;
return|return
name|queue
return|;
block|}
end_function

begin_comment
comment|/**  * xge_queue_destroy - Destroy xge_queue_t object.  * @queueh: Queue handle.  *  * Destroy the specified xge_queue_t object.  *  * See also: xge_queue_item_t{}, xge_queue_create().  */
end_comment

begin_function
name|void
name|xge_queue_destroy
parameter_list|(
name|xge_queue_h
name|queueh
parameter_list|)
block|{
name|xge_queue_t
modifier|*
name|queue
init|=
operator|(
name|xge_queue_t
operator|*
operator|)
name|queueh
decl_stmt|;
name|xge_os_spin_lock_destroy_irq
argument_list|(
operator|&
name|queue
operator|->
name|lock
argument_list|,
name|queue
operator|->
name|irqh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xge_list_is_empty
argument_list|(
operator|&
name|queue
operator|->
name|list_head
argument_list|)
condition|)
block|{
name|xge_debug_queue
argument_list|(
name|XGE_ERR
argument_list|,
literal|"destroying non-empty queue 0x"
name|XGE_OS_LLXFMT
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
argument_list|)
expr_stmt|;
block|}
name|xge_os_free
argument_list|(
name|queue
operator|->
name|pdev
argument_list|,
name|queue
operator|->
name|start_ptr
argument_list|,
name|queue
operator|->
name|pages_current
operator|*
name|XGE_QUEUE_BUF_SIZE
argument_list|)
expr_stmt|;
name|xge_os_free
argument_list|(
name|queue
operator|->
name|pdev
argument_list|,
name|queue
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_queue_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __io_queue_grow - Dynamically increases the size of the queue.  * @queueh: Queue handle.  *  * This function is called in the case of no slot avaialble in the queue  * to accomodate the newly received event.  * Note that queue cannot grow beyond the max size specified for the  * queue.  *  * Returns XGE_QUEUE_OK: On success.  * XGE_QUEUE_OUT_OF_MEMORY : No memory is available.  */
end_comment

begin_function
name|xge_queue_status_e
name|__io_queue_grow
parameter_list|(
name|xge_queue_h
name|queueh
parameter_list|)
block|{
name|xge_queue_t
modifier|*
name|queue
init|=
operator|(
name|xge_queue_t
operator|*
operator|)
name|queueh
decl_stmt|;
name|void
modifier|*
name|newbuf
decl_stmt|,
modifier|*
name|oldbuf
decl_stmt|;
name|xge_list_t
modifier|*
name|item
decl_stmt|;
name|xge_queue_item_t
modifier|*
name|elem
decl_stmt|;
name|xge_debug_queue
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"queue 0x"
name|XGE_OS_LLXFMT
literal|":%d is growing"
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|queue
argument_list|,
name|queue
operator|->
name|pages_current
argument_list|)
expr_stmt|;
name|newbuf
operator|=
name|xge_os_malloc
argument_list|(
name|queue
operator|->
name|pdev
argument_list|,
operator|(
name|queue
operator|->
name|pages_current
operator|+
literal|1
operator|)
operator|*
name|XGE_QUEUE_BUF_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|newbuf
operator|==
name|NULL
condition|)
return|return
name|XGE_QUEUE_OUT_OF_MEMORY
return|;
name|xge_os_memcpy
argument_list|(
name|newbuf
argument_list|,
name|queue
operator|->
name|start_ptr
argument_list|,
name|queue
operator|->
name|pages_current
operator|*
name|XGE_QUEUE_BUF_SIZE
argument_list|)
expr_stmt|;
name|oldbuf
operator|=
name|queue
operator|->
name|start_ptr
expr_stmt|;
comment|/* adjust queue sizes */
name|queue
operator|->
name|start_ptr
operator|=
name|newbuf
expr_stmt|;
name|queue
operator|->
name|end_ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|newbuf
operator|+
operator|(
name|queue
operator|->
name|pages_current
operator|+
literal|1
operator|)
operator|*
name|XGE_QUEUE_BUF_SIZE
expr_stmt|;
name|queue
operator|->
name|tail_ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|newbuf
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|tail_ptr
operator|-
operator|(
name|char
operator|*
operator|)
name|oldbuf
operator|)
expr_stmt|;
name|queue
operator|->
name|head_ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|newbuf
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|head_ptr
operator|-
operator|(
name|char
operator|*
operator|)
name|oldbuf
operator|)
expr_stmt|;
name|xge_assert
argument_list|(
operator|!
name|xge_list_is_empty
argument_list|(
operator|&
name|queue
operator|->
name|list_head
argument_list|)
argument_list|)
expr_stmt|;
name|queue
operator|->
name|list_head
operator|.
name|next
operator|=
operator|(
name|xge_list_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|newbuf
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|list_head
operator|.
name|next
operator|-
operator|(
name|char
operator|*
operator|)
name|oldbuf
operator|)
operator|)
expr_stmt|;
name|queue
operator|->
name|list_head
operator|.
name|prev
operator|=
operator|(
name|xge_list_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|newbuf
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|queue
operator|->
name|list_head
operator|.
name|prev
operator|-
operator|(
name|char
operator|*
operator|)
name|oldbuf
operator|)
operator|)
expr_stmt|;
comment|/* adjust queue list */
name|xge_list_for_each
argument_list|(
argument|item
argument_list|,
argument|&queue->list_head
argument_list|)
block|{
name|elem
operator|=
name|xge_container_of
argument_list|(
name|item
argument_list|,
name|xge_queue_item_t
argument_list|,
name|item
argument_list|)
expr_stmt|;
if|if
condition|(
name|elem
operator|->
name|item
operator|.
name|next
operator|!=
operator|&
name|queue
operator|->
name|list_head
condition|)
block|{
name|elem
operator|->
name|item
operator|.
name|next
operator|=
operator|(
name|xge_list_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|newbuf
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|elem
operator|->
name|item
operator|.
name|next
operator|-
operator|(
name|char
operator|*
operator|)
name|oldbuf
operator|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|elem
operator|->
name|item
operator|.
name|prev
operator|!=
operator|&
name|queue
operator|->
name|list_head
condition|)
block|{
name|elem
operator|->
name|item
operator|.
name|prev
operator|=
operator|(
name|xge_list_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|newbuf
operator|+
operator|(
operator|(
name|char
operator|*
operator|)
name|elem
operator|->
name|item
operator|.
name|prev
operator|-
operator|(
name|char
operator|*
operator|)
name|oldbuf
operator|)
operator|)
expr_stmt|;
block|}
block|}
name|xge_os_free
argument_list|(
name|queue
operator|->
name|pdev
argument_list|,
name|oldbuf
argument_list|,
name|queue
operator|->
name|pages_current
operator|*
name|XGE_QUEUE_BUF_SIZE
argument_list|)
expr_stmt|;
name|queue
operator|->
name|pages_current
operator|++
expr_stmt|;
return|return
name|XGE_QUEUE_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_queue_consume - Dequeue an item from the specified queue.  * @queueh: Queue handle.  * @data_max_size: Maximum expected size of the item.  * @item: Memory area into which the item is _copied_ upon return  *        from the function.  *  * Dequeue an item from the queue. The caller is required to provide  * enough space for the item.  *  * Returns: XGE_QUEUE_OK - success.  * XGE_QUEUE_IS_EMPTY - Queue is empty.  * XGE_QUEUE_NOT_ENOUGH_SPACE - Requested item size(@data_max_size)  * is too small to accomodate an item from the queue.  *  * See also: xge_queue_item_t{}, xge_queue_produce().  */
end_comment

begin_function
name|xge_queue_status_e
name|xge_queue_consume
parameter_list|(
name|xge_queue_h
name|queueh
parameter_list|,
name|int
name|data_max_size
parameter_list|,
name|xge_queue_item_t
modifier|*
name|item
parameter_list|)
block|{
name|xge_queue_t
modifier|*
name|queue
init|=
operator|(
name|xge_queue_t
operator|*
operator|)
name|queueh
decl_stmt|;
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
name|xge_queue_status_e
name|status
decl_stmt|;
name|xge_os_spin_lock_irq
argument_list|(
operator|&
name|queue
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|status
operator|=
name|__queue_consume
argument_list|(
name|queue
argument_list|,
name|data_max_size
argument_list|,
name|item
argument_list|)
expr_stmt|;
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
name|queue
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * xge_queue_flush - Flush, or empty, the queue.  * @queueh: Queue handle.  *  * Flush the queue, i.e. make it empty by consuming all events  * without invoking the event processing logic (callbacks, etc.)  */
end_comment

begin_function
name|void
name|xge_queue_flush
parameter_list|(
name|xge_queue_h
name|queueh
parameter_list|)
block|{
name|unsigned
name|char
name|item_buf
index|[
sizeof|sizeof
argument_list|(
name|xge_queue_item_t
argument_list|)
operator|+
name|XGE_DEFAULT_EVENT_MAX_DATA_SIZE
index|]
decl_stmt|;
name|xge_queue_item_t
modifier|*
name|item
init|=
operator|(
name|xge_queue_item_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|item_buf
decl_stmt|;
name|xge_os_memzero
argument_list|(
name|item_buf
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|xge_queue_item_t
argument_list|)
operator|+
name|XGE_DEFAULT_EVENT_MAX_DATA_SIZE
operator|)
argument_list|)
expr_stmt|;
comment|/* flush queue by consuming all enqueued items */
while|while
condition|(
name|xge_queue_consume
argument_list|(
name|queueh
argument_list|,
name|XGE_DEFAULT_EVENT_MAX_DATA_SIZE
argument_list|,
name|item
argument_list|)
operator|!=
name|XGE_QUEUE_IS_EMPTY
condition|)
block|{
comment|/* do nothing */
name|xge_debug_queue
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"item "
name|XGE_OS_LLXFMT
literal|"(%d) flushed"
argument_list|,
name|item
argument_list|,
name|item
operator|->
name|event_type
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|__queue_get_reset_critical
argument_list|(
name|queueh
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __queue_get_reset_critical - Check for critical events in the queue,  * @qh: Queue handle.  *  * Check for critical event(s) in the queue, and reset the  * "has-critical-event" flag upon return.  * Returns: 1 - if the queue contains atleast one critical event.  * 0 - If there are no critical events in the queue.  */
end_comment

begin_function
name|int
name|__queue_get_reset_critical
parameter_list|(
name|xge_queue_h
name|qh
parameter_list|)
block|{
name|xge_queue_t
modifier|*
name|queue
init|=
operator|(
name|xge_queue_t
operator|*
operator|)
name|qh
decl_stmt|;
name|int
name|c
init|=
name|queue
operator|->
name|has_critical_event
decl_stmt|;
name|queue
operator|->
name|has_critical_event
operator|=
literal|0
expr_stmt|;
return|return
name|c
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2007 Neterion, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<dev/nxge/include/xge-os-pal.h>
end_include

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-mm.h>
end_include

begin_include
include|#
directive|include
file|<dev/nxge/include/xge-debug.h>
end_include

begin_comment
comment|/*  * __hal_mempool_grow  *  * Will resize mempool up to %num_allocate value.  */
end_comment

begin_function
name|xge_hal_status_e
name|__hal_mempool_grow
parameter_list|(
name|xge_hal_mempool_t
modifier|*
name|mempool
parameter_list|,
name|int
name|num_allocate
parameter_list|,
name|int
modifier|*
name|num_allocated
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|first_time
init|=
name|mempool
operator|->
name|memblocks_allocated
operator|==
literal|0
condition|?
literal|1
else|:
literal|0
decl_stmt|;
name|int
name|n_items
init|=
name|mempool
operator|->
name|items_per_memblock
decl_stmt|;
operator|*
name|num_allocated
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|mempool
operator|->
name|memblocks_allocated
operator|+
name|num_allocate
operator|)
operator|>
name|mempool
operator|->
name|memblocks_max
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"%s"
argument_list|,
literal|"__hal_mempool_grow: can grow anymore"
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
for|for
control|(
name|i
operator|=
name|mempool
operator|->
name|memblocks_allocated
init|;
name|i
operator|<
name|mempool
operator|->
name|memblocks_allocated
operator|+
name|num_allocate
condition|;
name|i
operator|++
control|)
block|{
name|int
name|j
decl_stmt|;
name|int
name|is_last
init|=
operator|(
operator|(
name|mempool
operator|->
name|memblocks_allocated
operator|+
name|num_allocate
operator|-
literal|1
operator|)
operator|==
name|i
operator|)
decl_stmt|;
name|xge_hal_mempool_dma_t
modifier|*
name|dma_object
init|=
name|mempool
operator|->
name|memblocks_dma_arr
operator|+
name|i
decl_stmt|;
name|void
modifier|*
name|the_memblock
decl_stmt|;
name|int
name|dma_flags
decl_stmt|;
name|dma_flags
operator|=
name|XGE_OS_DMA_CACHELINE_ALIGNED
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_HAL_DMA_DTR_CONSISTENT
name|dma_flags
operator||=
name|XGE_OS_DMA_CONSISTENT
expr_stmt|;
else|#
directive|else
name|dma_flags
operator||=
name|XGE_OS_DMA_STREAMING
expr_stmt|;
endif|#
directive|endif
comment|/* allocate DMA-capable memblock */
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
operator|=
name|xge_os_dma_malloc
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|,
name|dma_flags
argument_list|,
operator|&
name|dma_object
operator|->
name|handle
argument_list|,
operator|&
name|dma_object
operator|->
name|acc_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"memblock[%d]: out of DMA memory"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|xge_os_memzero
argument_list|(
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|)
expr_stmt|;
name|the_memblock
operator|=
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
expr_stmt|;
comment|/* allocate memblock's private part. Each DMA memblock 	     * has a space allocated for item's private usage upon 	     * mempool's user request. Each time mempool grows, it will 	     * allocate new memblock and its private part at once. 	     * This helps to minimize memory usage a lot. */
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
operator|=
name|xge_os_malloc
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|n_items
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|xge_os_dma_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|the_memblock
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|,
operator|&
name|dma_object
operator|->
name|acc_handle
argument_list|,
operator|&
name|dma_object
operator|->
name|handle
argument_list|)
expr_stmt|;
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"memblock_priv[%d]: out of virtual memory, "
literal|"requested %d(%d:%d) bytes"
argument_list|,
name|i
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|n_items
argument_list|,
name|mempool
operator|->
name|items_priv_size
argument_list|,
name|n_items
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|xge_os_memzero
argument_list|(
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|n_items
argument_list|)
expr_stmt|;
comment|/* map memblock to physical memory */
name|dma_object
operator|->
name|addr
operator|=
name|xge_os_dma_map
argument_list|(
argument|mempool->pdev
argument_list|,
argument|dma_object->handle
argument_list|,
argument|the_memblock
argument_list|,
argument|mempool->memblock_size
argument_list|,
argument|XGE_OS_DMA_DIR_BIDIRECTIONAL
argument_list|,
ifdef|#
directive|ifdef
name|XGE_HAL_DMA_DTR_CONSISTENT
argument|XGE_OS_DMA_CONSISTENT
else|#
directive|else
argument|XGE_OS_DMA_STREAMING
endif|#
directive|endif
argument_list|)
expr_stmt|;
if|if
condition|(
name|dma_object
operator|->
name|addr
operator|==
name|XGE_OS_INVALID_DMA_ADDR
condition|)
block|{
name|xge_os_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|n_items
argument_list|)
expr_stmt|;
name|xge_os_dma_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|the_memblock
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|,
operator|&
name|dma_object
operator|->
name|acc_handle
argument_list|,
operator|&
name|dma_object
operator|->
name|handle
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MAPPING
return|;
block|}
comment|/* fill the items hash array */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|n_items
condition|;
name|j
operator|++
control|)
block|{
name|int
name|index
init|=
name|i
operator|*
name|n_items
operator|+
name|j
decl_stmt|;
if|if
condition|(
name|first_time
operator|&&
name|index
operator|>=
name|mempool
operator|->
name|items_initial
condition|)
block|{
break|break;
block|}
name|mempool
operator|->
name|items_arr
index|[
name|index
index|]
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
name|the_memblock
operator|+
name|j
operator|*
name|mempool
operator|->
name|item_size
operator|)
expr_stmt|;
comment|/* let caller to do more job on each item */
if|if
condition|(
name|mempool
operator|->
name|item_func_alloc
operator|!=
name|NULL
condition|)
block|{
name|xge_hal_status_e
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|mempool
operator|->
name|item_func_alloc
argument_list|(
name|mempool
argument_list|,
name|the_memblock
argument_list|,
name|i
argument_list|,
name|dma_object
argument_list|,
name|mempool
operator|->
name|items_arr
index|[
name|index
index|]
argument_list|,
name|index
argument_list|,
name|is_last
argument_list|,
name|mempool
operator|->
name|userdata
argument_list|)
operator|)
operator|!=
name|XGE_HAL_OK
condition|)
block|{
if|if
condition|(
name|mempool
operator|->
name|item_func_free
operator|!=
name|NULL
condition|)
block|{
name|int
name|k
decl_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|j
condition|;
name|k
operator|++
control|)
block|{
name|index
operator|=
name|i
operator|*
name|n_items
operator|+
name|k
expr_stmt|;
operator|(
name|void
operator|)
name|mempool
operator|->
name|item_func_free
argument_list|(
name|mempool
argument_list|,
name|the_memblock
argument_list|,
name|i
argument_list|,
name|dma_object
argument_list|,
name|mempool
operator|->
name|items_arr
index|[
name|index
index|]
argument_list|,
name|index
argument_list|,
name|is_last
argument_list|,
name|mempool
operator|->
name|userdata
argument_list|)
expr_stmt|;
block|}
block|}
name|xge_os_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|n_items
argument_list|)
expr_stmt|;
name|xge_os_dma_unmap
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|dma_object
operator|->
name|handle
argument_list|,
name|dma_object
operator|->
name|addr
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|,
name|XGE_OS_DMA_DIR_BIDIRECTIONAL
argument_list|)
expr_stmt|;
name|xge_os_dma_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|the_memblock
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|,
operator|&
name|dma_object
operator|->
name|acc_handle
argument_list|,
operator|&
name|dma_object
operator|->
name|handle
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
name|mempool
operator|->
name|items_current
operator|=
name|index
operator|+
literal|1
expr_stmt|;
block|}
name|xge_debug_mm
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"memblock%d: allocated %dk, vaddr 0x"
name|XGE_OS_LLXFMT
literal|", "
literal|"dma_addr 0x"
name|XGE_OS_LLXFMT
argument_list|,
name|i
argument_list|,
name|mempool
operator|->
name|memblock_size
operator|/
literal|1024
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|(
name|ulong_t
operator|)
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dma_object
operator|->
name|addr
argument_list|)
expr_stmt|;
operator|(
operator|*
name|num_allocated
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|first_time
operator|&&
name|mempool
operator|->
name|items_current
operator|==
name|mempool
operator|->
name|items_initial
condition|)
block|{
break|break;
block|}
block|}
comment|/* increment actual number of allocated memblocks */
name|mempool
operator|->
name|memblocks_allocated
operator|+=
operator|*
name|num_allocated
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/*  * xge_hal_mempool_create  * @memblock_size:  * @items_initial:  * @items_max:  * @item_size:  * @item_func:  *  * This function will create memory pool object. Pool may grow but will  * never shrink. Pool consists of number of dynamically allocated blocks  * with size enough to hold %items_initial number of items. Memory is  * DMA-able but client must map/unmap before interoperating with the device.  * See also: xge_os_dma_map(), xge_hal_dma_unmap(), xge_hal_status_e{}.  */
end_comment

begin_function
name|xge_hal_mempool_t
modifier|*
name|__hal_mempool_create
parameter_list|(
name|pci_dev_h
name|pdev
parameter_list|,
name|int
name|memblock_size
parameter_list|,
name|int
name|item_size
parameter_list|,
name|int
name|items_priv_size
parameter_list|,
name|int
name|items_initial
parameter_list|,
name|int
name|items_max
parameter_list|,
name|xge_hal_mempool_item_f
name|item_func_alloc
parameter_list|,
name|xge_hal_mempool_item_f
name|item_func_free
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|xge_hal_status_e
name|status
decl_stmt|;
name|int
name|memblocks_to_allocate
decl_stmt|;
name|xge_hal_mempool_t
modifier|*
name|mempool
decl_stmt|;
name|int
name|allocated
decl_stmt|;
if|if
condition|(
name|memblock_size
operator|<
name|item_size
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"memblock_size %d< item_size %d: misconfiguration"
argument_list|,
name|memblock_size
argument_list|,
name|item_size
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|mempool
operator|=
operator|(
name|xge_hal_mempool_t
operator|*
operator|)
expr|\
name|xge_os_malloc
argument_list|(
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_mempool_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|==
name|NULL
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"mempool allocation failure"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|xge_os_memzero
argument_list|(
name|mempool
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_mempool_t
argument_list|)
argument_list|)
expr_stmt|;
name|mempool
operator|->
name|pdev
operator|=
name|pdev
expr_stmt|;
name|mempool
operator|->
name|memblock_size
operator|=
name|memblock_size
expr_stmt|;
name|mempool
operator|->
name|items_max
operator|=
name|items_max
expr_stmt|;
name|mempool
operator|->
name|items_initial
operator|=
name|items_initial
expr_stmt|;
name|mempool
operator|->
name|item_size
operator|=
name|item_size
expr_stmt|;
name|mempool
operator|->
name|items_priv_size
operator|=
name|items_priv_size
expr_stmt|;
name|mempool
operator|->
name|item_func_alloc
operator|=
name|item_func_alloc
expr_stmt|;
name|mempool
operator|->
name|item_func_free
operator|=
name|item_func_free
expr_stmt|;
name|mempool
operator|->
name|userdata
operator|=
name|userdata
expr_stmt|;
name|mempool
operator|->
name|memblocks_allocated
operator|=
literal|0
expr_stmt|;
name|mempool
operator|->
name|items_per_memblock
operator|=
name|memblock_size
operator|/
name|item_size
expr_stmt|;
name|mempool
operator|->
name|memblocks_max
operator|=
operator|(
name|items_max
operator|+
name|mempool
operator|->
name|items_per_memblock
operator|-
literal|1
operator|)
operator|/
name|mempool
operator|->
name|items_per_memblock
expr_stmt|;
comment|/* allocate array of memblocks */
name|mempool
operator|->
name|memblocks_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|memblocks_arr
operator|==
name|NULL
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"memblocks_arr allocation failure"
argument_list|)
expr_stmt|;
name|__hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|xge_os_memzero
argument_list|(
name|mempool
operator|->
name|memblocks_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
comment|/* allocate array of private parts of items per memblocks */
name|mempool
operator|->
name|memblocks_priv_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|memblocks_priv_arr
operator|==
name|NULL
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"memblocks_priv_arr allocation failure"
argument_list|)
expr_stmt|;
name|__hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|xge_os_memzero
argument_list|(
name|mempool
operator|->
name|memblocks_priv_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
comment|/* allocate array of memblocks DMA objects */
name|mempool
operator|->
name|memblocks_dma_arr
operator|=
operator|(
name|xge_hal_mempool_dma_t
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_mempool_dma_t
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|memblocks_dma_arr
operator|==
name|NULL
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"memblocks_dma_arr allocation failure"
argument_list|)
expr_stmt|;
name|__hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|xge_os_memzero
argument_list|(
name|mempool
operator|->
name|memblocks_dma_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_mempool_dma_t
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
comment|/* allocate hash array of items */
name|mempool
operator|->
name|items_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|items_arr
operator|==
name|NULL
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"items_arr allocation failure"
argument_list|)
expr_stmt|;
name|__hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|xge_os_memzero
argument_list|(
name|mempool
operator|->
name|items_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
name|mempool
operator|->
name|shadow_items_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|shadow_items_arr
operator|==
name|NULL
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"shadow_items_arr allocation failure"
argument_list|)
expr_stmt|;
name|__hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|xge_os_memzero
argument_list|(
name|mempool
operator|->
name|shadow_items_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
comment|/* calculate initial number of memblocks */
name|memblocks_to_allocate
operator|=
operator|(
name|mempool
operator|->
name|items_initial
operator|+
name|mempool
operator|->
name|items_per_memblock
operator|-
literal|1
operator|)
operator|/
name|mempool
operator|->
name|items_per_memblock
expr_stmt|;
name|xge_debug_mm
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"allocating %d memblocks, "
literal|"%d items per memblock"
argument_list|,
name|memblocks_to_allocate
argument_list|,
name|mempool
operator|->
name|items_per_memblock
argument_list|)
expr_stmt|;
comment|/* pre-allocate the mempool */
name|status
operator|=
name|__hal_mempool_grow
argument_list|(
name|mempool
argument_list|,
name|memblocks_to_allocate
argument_list|,
operator|&
name|allocated
argument_list|)
expr_stmt|;
name|xge_os_memcpy
argument_list|(
name|mempool
operator|->
name|shadow_items_arr
argument_list|,
name|mempool
operator|->
name|items_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|XGE_HAL_OK
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"mempool_grow failure"
argument_list|)
expr_stmt|;
name|__hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|xge_debug_mm
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"total: allocated %dk of DMA-capable memory"
argument_list|,
name|mempool
operator|->
name|memblock_size
operator|*
name|allocated
operator|/
literal|1024
argument_list|)
expr_stmt|;
return|return
name|mempool
return|;
block|}
end_function

begin_comment
comment|/*  * xge_hal_mempool_destroy  */
end_comment

begin_function
name|void
name|__hal_mempool_destroy
parameter_list|(
name|xge_hal_mempool_t
modifier|*
name|mempool
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mempool
operator|->
name|memblocks_allocated
condition|;
name|i
operator|++
control|)
block|{
name|xge_hal_mempool_dma_t
modifier|*
name|dma_object
decl_stmt|;
name|xge_assert
argument_list|(
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|mempool
operator|->
name|memblocks_dma_arr
operator|+
name|i
argument_list|)
expr_stmt|;
name|dma_object
operator|=
name|mempool
operator|->
name|memblocks_dma_arr
operator|+
name|i
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|mempool
operator|->
name|items_per_memblock
condition|;
name|j
operator|++
control|)
block|{
name|int
name|index
init|=
name|i
operator|*
name|mempool
operator|->
name|items_per_memblock
operator|+
name|j
decl_stmt|;
comment|/* to skip last partially filled(if any) memblock */
if|if
condition|(
name|index
operator|>=
name|mempool
operator|->
name|items_current
condition|)
block|{
break|break;
block|}
comment|/* let caller to do more job on each item */
if|if
condition|(
name|mempool
operator|->
name|item_func_free
operator|!=
name|NULL
condition|)
block|{
name|mempool
operator|->
name|item_func_free
argument_list|(
name|mempool
argument_list|,
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
argument_list|,
name|i
argument_list|,
name|dma_object
argument_list|,
name|mempool
operator|->
name|shadow_items_arr
index|[
name|index
index|]
argument_list|,
name|index
argument_list|,
comment|/* unused */
operator|-
literal|1
argument_list|,
name|mempool
operator|->
name|userdata
argument_list|)
expr_stmt|;
block|}
block|}
name|xge_os_dma_unmap
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|dma_object
operator|->
name|handle
argument_list|,
name|dma_object
operator|->
name|addr
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|,
name|XGE_OS_DMA_DIR_BIDIRECTIONAL
argument_list|)
expr_stmt|;
name|xge_os_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|mempool
operator|->
name|items_per_memblock
argument_list|)
expr_stmt|;
name|xge_os_dma_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|,
operator|&
name|dma_object
operator|->
name|acc_handle
argument_list|,
operator|&
name|dma_object
operator|->
name|handle
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mempool
operator|->
name|items_arr
condition|)
block|{
name|xge_os_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|items_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mempool
operator|->
name|shadow_items_arr
condition|)
block|{
name|xge_os_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|shadow_items_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mempool
operator|->
name|memblocks_dma_arr
condition|)
block|{
name|xge_os_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_dma_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_mempool_dma_t
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mempool
operator|->
name|memblocks_priv_arr
condition|)
block|{
name|xge_os_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_priv_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mempool
operator|->
name|memblocks_arr
condition|)
block|{
name|xge_os_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
block|}
name|xge_os_free
argument_list|(
name|mempool
operator|->
name|pdev
argument_list|,
name|mempool
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_mempool_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


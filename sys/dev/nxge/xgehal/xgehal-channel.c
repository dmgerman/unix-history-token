begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2007 Neterion, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  *  FileName :    xgehal-channel.c  *  *  Description:  chipset channel abstraction  *  *  Created:      10 May 2004  */
end_comment

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-channel.h>
end_include

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-fifo.h>
end_include

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-ring.h>
end_include

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-device.h>
end_include

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-regs.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
end_ifdef

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-types.h>
end_include

begin_include
include|#
directive|include
file|"xgehal-iov.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * __hal_channel_dtr_next_reservelist  *  * Walking through the all available DTRs.  */
end_comment

begin_function
specifier|static
name|xge_hal_status_e
name|__hal_channel_dtr_next_reservelist
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
modifier|*
name|dtrh
parameter_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|channel
init|=
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
decl_stmt|;
if|if
condition|(
name|channel
operator|->
name|reserve_top
operator|>=
name|channel
operator|->
name|reserve_length
condition|)
block|{
return|return
name|XGE_HAL_INF_NO_MORE_FREED_DESCRIPTORS
return|;
block|}
operator|*
name|dtrh
operator|=
name|channel
operator|->
name|reserve_arr
index|[
name|channel
operator|->
name|reserve_top
operator|++
index|]
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_channel_dtr_next_freelist  *  * Walking through the "freed" DTRs.  */
end_comment

begin_function
specifier|static
name|xge_hal_status_e
name|__hal_channel_dtr_next_freelist
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
modifier|*
name|dtrh
parameter_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|channel
init|=
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
decl_stmt|;
if|if
condition|(
name|channel
operator|->
name|reserve_initial
operator|==
name|channel
operator|->
name|free_length
condition|)
block|{
return|return
name|XGE_HAL_INF_NO_MORE_FREED_DESCRIPTORS
return|;
block|}
operator|*
name|dtrh
operator|=
name|channel
operator|->
name|free_arr
index|[
name|channel
operator|->
name|free_length
operator|++
index|]
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_channel_dtr_next_not_completed - Get the _next_ posted but  *                                     not completed descriptor.  *  * Walking through the "not completed" DTRs.  */
end_comment

begin_function
specifier|static
name|xge_hal_status_e
name|__hal_channel_dtr_next_not_completed
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
modifier|*
name|dtrh
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|XGEHAL_RNIC
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
decl_stmt|;
comment|/* doesn't matter 1, 3 or 5... */
endif|#
directive|endif
name|__hal_channel_dtr_try_complete
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|dtrh
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
return|;
block|}
ifndef|#
directive|ifndef
name|XGEHAL_RNIC
name|rxdp
operator|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
operator|*
name|dtrh
expr_stmt|;
name|xge_assert
argument_list|(
name|rxdp
operator|->
name|host_control
operator|!=
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_complete
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_function
name|xge_hal_channel_t
modifier|*
name|__hal_channel_allocate
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|,
name|int
name|post_qid
parameter_list|,
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
name|u32
name|vp_id
parameter_list|,
endif|#
directive|endif
name|xge_hal_channel_type_e
name|type
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|xge_hal_channel_t
modifier|*
name|channel
decl_stmt|;
name|int
name|size
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|XGE_HAL_CHANNEL_TYPE_FIFO
case|:
name|xge_assert
argument_list|(
name|post_qid
operator|+
literal|1
operator|>=
name|XGE_HAL_MIN_FIFO_NUM
operator|&&
name|post_qid
operator|+
literal|1
operator|<=
name|XGE_HAL_MAX_FIFO_NUM
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|xge_hal_fifo_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_RING
case|:
name|xge_assert
argument_list|(
name|post_qid
operator|+
literal|1
operator|>=
name|XGE_HAL_MIN_RING_NUM
operator|&&
name|post_qid
operator|+
literal|1
operator|<=
name|XGE_HAL_MAX_RING_NUM
argument_list|)
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|xge_hal_ring_t
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
case|case
name|XGE_HAL_CHANNEL_TYPE_SEND_QUEUE
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_sq_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_RECEIVE_QUEUE
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_srq_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_COMPLETION_QUEUE
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_cqrq_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_UP_MESSAGE_QUEUE
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_umq_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_DOWN_MESSAGE_QUEUE
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_dmq_t
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default :
name|xge_assert
argument_list|(
name|size
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* allocate FIFO channel */
name|channel
operator|=
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|channel
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|xge_os_memzero
argument_list|(
name|channel
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|channel
operator|->
name|pdev
operator|=
name|hldev
operator|->
name|pdev
expr_stmt|;
name|channel
operator|->
name|regh0
operator|=
name|hldev
operator|->
name|regh0
expr_stmt|;
name|channel
operator|->
name|regh1
operator|=
name|hldev
operator|->
name|regh1
expr_stmt|;
name|channel
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|channel
operator|->
name|devh
operator|=
name|devh
expr_stmt|;
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
name|channel
operator|->
name|vp_id
operator|=
name|vp_id
expr_stmt|;
endif|#
directive|endif
name|channel
operator|->
name|post_qid
operator|=
name|post_qid
expr_stmt|;
name|channel
operator|->
name|compl_qid
operator|=
literal|0
expr_stmt|;
return|return
name|channel
return|;
block|}
end_function

begin_function
name|void
name|__hal_channel_free
parameter_list|(
name|xge_hal_channel_t
modifier|*
name|channel
parameter_list|)
block|{
name|int
name|size
init|=
literal|0
decl_stmt|;
name|xge_assert
argument_list|(
name|channel
operator|->
name|pdev
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|channel
operator|->
name|type
condition|)
block|{
case|case
name|XGE_HAL_CHANNEL_TYPE_FIFO
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|xge_hal_fifo_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_RING
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|xge_hal_ring_t
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
case|case
name|XGE_HAL_CHANNEL_TYPE_SEND_QUEUE
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_sq_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_RECEIVE_QUEUE
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_srq_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_COMPLETION_QUEUE
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_cqrq_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_UP_MESSAGE_QUEUE
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_umq_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_DOWN_MESSAGE_QUEUE
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_dmq_t
argument_list|)
expr_stmt|;
break|break;
else|#
directive|else
case|case
name|XGE_HAL_CHANNEL_TYPE_SEND_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_RECEIVE_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_COMPLETION_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_UP_MESSAGE_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_DOWN_MESSAGE_QUEUE
case|:
name|xge_assert
argument_list|(
name|size
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
name|xge_os_free
argument_list|(
name|channel
operator|->
name|pdev
argument_list|,
name|channel
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|xge_hal_status_e
name|__hal_channel_initialize
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_channel_attr_t
modifier|*
name|attr
parameter_list|,
name|void
modifier|*
modifier|*
name|reserve_arr
parameter_list|,
name|int
name|reserve_initial
parameter_list|,
name|int
name|reserve_max
parameter_list|,
name|int
name|reserve_threshold
parameter_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|channel
init|=
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|hldev
operator|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|channel
operator|->
name|devh
expr_stmt|;
name|channel
operator|->
name|dtr_term
operator|=
name|attr
operator|->
name|dtr_term
expr_stmt|;
name|channel
operator|->
name|dtr_init
operator|=
name|attr
operator|->
name|dtr_init
expr_stmt|;
name|channel
operator|->
name|callback
operator|=
name|attr
operator|->
name|callback
expr_stmt|;
name|channel
operator|->
name|userdata
operator|=
name|attr
operator|->
name|userdata
expr_stmt|;
name|channel
operator|->
name|flags
operator|=
name|attr
operator|->
name|flags
expr_stmt|;
name|channel
operator|->
name|per_dtr_space
operator|=
name|attr
operator|->
name|per_dtr_space
expr_stmt|;
name|channel
operator|->
name|reserve_arr
operator|=
name|reserve_arr
expr_stmt|;
name|channel
operator|->
name|reserve_initial
operator|=
name|reserve_initial
expr_stmt|;
name|channel
operator|->
name|reserve_max
operator|=
name|reserve_max
expr_stmt|;
name|channel
operator|->
name|reserve_length
operator|=
name|channel
operator|->
name|reserve_initial
expr_stmt|;
name|channel
operator|->
name|reserve_threshold
operator|=
name|reserve_threshold
expr_stmt|;
name|channel
operator|->
name|reserve_top
operator|=
literal|0
expr_stmt|;
name|channel
operator|->
name|saved_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|channel
operator|->
name|reserve_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|channel
operator|->
name|saved_arr
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|xge_os_memzero
argument_list|(
name|channel
operator|->
name|saved_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|channel
operator|->
name|reserve_max
argument_list|)
expr_stmt|;
name|channel
operator|->
name|free_arr
operator|=
name|channel
operator|->
name|saved_arr
expr_stmt|;
name|channel
operator|->
name|free_length
operator|=
name|channel
operator|->
name|reserve_initial
expr_stmt|;
name|channel
operator|->
name|work_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|channel
operator|->
name|reserve_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|channel
operator|->
name|work_arr
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|xge_os_memzero
argument_list|(
name|channel
operator|->
name|work_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|channel
operator|->
name|reserve_max
argument_list|)
expr_stmt|;
name|channel
operator|->
name|post_index
operator|=
literal|0
expr_stmt|;
name|channel
operator|->
name|compl_index
operator|=
literal|0
expr_stmt|;
name|channel
operator|->
name|length
operator|=
name|channel
operator|->
name|reserve_initial
expr_stmt|;
name|channel
operator|->
name|orig_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|channel
operator|->
name|reserve_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|channel
operator|->
name|orig_arr
operator|==
name|NULL
condition|)
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
name|xge_os_memzero
argument_list|(
name|channel
operator|->
name|orig_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|channel
operator|->
name|reserve_max
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_FREE_IRQ
argument_list|)
operator|||
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_FREE_IRQ
argument_list|)
name|xge_os_spin_lock_init_irq
argument_list|(
operator|&
name|channel
operator|->
name|free_lock
argument_list|,
name|hldev
operator|->
name|irqh
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_FREE
argument_list|)
operator|||
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_FREE
argument_list|)
name|xge_os_spin_lock_init
argument_list|(
operator|&
name|channel
operator|->
name|free_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_function
name|void
name|__hal_channel_terminate
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|channel
init|=
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|hldev
operator|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|channel
operator|->
name|devh
expr_stmt|;
name|xge_assert
argument_list|(
name|channel
operator|->
name|pdev
argument_list|)
expr_stmt|;
comment|/* undo changes made at channel_initialize() */
if|if
condition|(
name|channel
operator|->
name|work_arr
condition|)
block|{
name|xge_os_free
argument_list|(
name|channel
operator|->
name|pdev
argument_list|,
name|channel
operator|->
name|work_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|channel
operator|->
name|reserve_max
argument_list|)
expr_stmt|;
name|channel
operator|->
name|work_arr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|channel
operator|->
name|saved_arr
condition|)
block|{
name|xge_os_free
argument_list|(
name|channel
operator|->
name|pdev
argument_list|,
name|channel
operator|->
name|saved_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|channel
operator|->
name|reserve_max
argument_list|)
expr_stmt|;
name|channel
operator|->
name|saved_arr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|channel
operator|->
name|orig_arr
condition|)
block|{
name|xge_os_free
argument_list|(
name|channel
operator|->
name|pdev
argument_list|,
name|channel
operator|->
name|orig_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|channel
operator|->
name|reserve_max
argument_list|)
expr_stmt|;
name|channel
operator|->
name|orig_arr
operator|=
name|NULL
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_FREE_IRQ
argument_list|)
operator|||
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_FREE_IRQ
argument_list|)
name|xge_os_spin_lock_destroy_irq
argument_list|(
operator|&
name|channel
operator|->
name|free_lock
argument_list|,
name|hldev
operator|->
name|irqh
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_FREE
argument_list|)
operator|||
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_FREE
argument_list|)
name|xge_os_spin_lock_destroy
argument_list|(
operator|&
name|channel
operator|->
name|free_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**  * xge_hal_channel_open - Open communication channel.  * @devh: HAL device, pointer to xge_hal_device_t structure.  * @attr: Contains attributes required to open  *        the channel.  * @channelh:  The channel handle. On success (XGE_HAL_OK) HAL fills  * this "out" parameter with a valid channel handle.  * @reopen: See  xge_hal_channel_reopen_e{}.  *  * Open communication channel with the device.  *  * HAL uses (persistent) channel configuration to allocate both channel  * and Xframe Tx and Rx descriptors.  * Notes:  *     1) The channel config data is fed into HAL prior to  *        xge_hal_channel_open().  *  *     2) The corresponding hardware queues must be already configured and  *        enabled.  *  *     3) Either down or up queue may be omitted, in which case the channel  *        is treated as _unidirectional_.  *  *     4) Post and completion queue may be the same, in which case the channel  *        is said to have "in-band completions".  *  * Note that free_channels list is not protected. i.e. caller must provide  * safe context.  *  * Returns: XGE_HAL_OK  - success.  * XGE_HAL_ERR_CHANNEL_NOT_FOUND - Unable to locate the channel.  * XGE_HAL_ERR_OUT_OF_MEMORY - Memory allocation failed.  *  * See also: xge_hal_channel_attr_t{}.  * Usage: See ex_open{}.  */
end_comment

begin_function
name|xge_hal_status_e
name|xge_hal_channel_open
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|,
name|xge_hal_channel_attr_t
modifier|*
name|attr
parameter_list|,
name|xge_hal_channel_h
modifier|*
name|channelh
parameter_list|,
name|xge_hal_channel_reopen_e
name|reopen
parameter_list|)
block|{
name|xge_list_t
modifier|*
name|item
decl_stmt|;
name|int
name|i
decl_stmt|;
name|xge_hal_status_e
name|status
init|=
name|XGE_HAL_OK
decl_stmt|;
name|xge_hal_channel_t
modifier|*
name|channel
init|=
name|NULL
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|device
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|xge_assert
argument_list|(
name|device
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|attr
argument_list|)
expr_stmt|;
operator|*
name|channelh
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
if|if
condition|(
operator|(
name|attr
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
operator|)
operator|||
operator|(
name|attr
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
operator|)
condition|)
block|{
endif|#
directive|endif
comment|/* find channel */
name|xge_list_for_each
argument_list|(
argument|item
argument_list|,
argument|&device->free_channels
argument_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|xge_container_of
argument_list|(
name|item
argument_list|,
name|xge_hal_channel_t
argument_list|,
name|item
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|type
operator|==
name|attr
operator|->
name|type
operator|&&
name|tmp
operator|->
name|post_qid
operator|==
name|attr
operator|->
name|post_qid
operator|&&
name|tmp
operator|->
name|compl_qid
operator|==
name|attr
operator|->
name|compl_qid
condition|)
block|{
name|channel
operator|=
name|tmp
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|channel
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_ERR_CHANNEL_NOT_FOUND
return|;
block|}
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
block|}
else|else
block|{
name|channel
operator|=
name|__hal_channel_allocate
argument_list|(
name|devh
argument_list|,
name|attr
operator|->
name|post_qid
argument_list|,
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
name|attr
operator|->
name|vp_id
argument_list|,
endif|#
directive|endif
name|attr
operator|->
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|channel
operator|==
name|NULL
condition|)
block|{
name|xge_debug_device
argument_list|(
name|XGE_ERR
argument_list|,
literal|"__hal_channel_allocate failed"
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|XGEHAL_RNIC
name|xge_assert
argument_list|(
operator|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
operator|)
operator|||
operator|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
if|if
condition|(
operator|(
name|reopen
operator|==
name|XGE_HAL_CHANNEL_OC_NORMAL
operator|)
operator|||
operator|(
operator|(
name|channel
operator|->
name|type
operator|!=
name|XGE_HAL_CHANNEL_TYPE_FIFO
operator|)
operator|&&
operator|(
name|channel
operator|->
name|type
operator|!=
name|XGE_HAL_CHANNEL_TYPE_RING
operator|)
operator|)
condition|)
block|{
else|#
directive|else
if|if
condition|(
name|reopen
operator|==
name|XGE_HAL_CHANNEL_OC_NORMAL
condition|)
block|{
endif|#
directive|endif
comment|/* allocate memory, initialize pointers, etc */
switch|switch
condition|(
name|channel
operator|->
name|type
condition|)
block|{
case|case
name|XGE_HAL_CHANNEL_TYPE_FIFO
case|:
name|status
operator|=
name|__hal_fifo_open
argument_list|(
name|channel
argument_list|,
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_RING
case|:
name|status
operator|=
name|__hal_ring_open
argument_list|(
name|channel
argument_list|,
name|attr
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
case|case
name|XGE_HAL_CHANNEL_TYPE_SEND_QUEUE
case|:
name|status
operator|=
name|__hal_sq_open
argument_list|(
name|channel
argument_list|,
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_RECEIVE_QUEUE
case|:
name|status
operator|=
name|__hal_srq_open
argument_list|(
name|channel
argument_list|,
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_COMPLETION_QUEUE
case|:
name|status
operator|=
name|__hal_cqrq_open
argument_list|(
name|channel
argument_list|,
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_UP_MESSAGE_QUEUE
case|:
name|status
operator|=
name|__hal_umq_open
argument_list|(
name|channel
argument_list|,
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_DOWN_MESSAGE_QUEUE
case|:
name|status
operator|=
name|__hal_dmq_open
argument_list|(
name|channel
argument_list|,
name|attr
argument_list|)
expr_stmt|;
break|break;
else|#
directive|else
case|case
name|XGE_HAL_CHANNEL_TYPE_SEND_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_RECEIVE_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_COMPLETION_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_UP_MESSAGE_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_DOWN_MESSAGE_QUEUE
case|:
name|status
operator|=
name|XGE_HAL_FAIL
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
if|if
condition|(
name|status
operator|==
name|XGE_HAL_OK
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|channel
operator|->
name|reserve_initial
condition|;
name|i
operator|++
control|)
block|{
name|channel
operator|->
name|orig_arr
index|[
name|i
index|]
operator|=
name|channel
operator|->
name|reserve_arr
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
else|else
return|return
name|status
return|;
block|}
else|else
block|{
name|xge_assert
argument_list|(
name|reopen
operator|==
name|XGE_HAL_CHANNEL_RESET_ONLY
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|channel
operator|->
name|reserve_initial
condition|;
name|i
operator|++
control|)
block|{
name|channel
operator|->
name|reserve_arr
index|[
name|i
index|]
operator|=
name|channel
operator|->
name|orig_arr
index|[
name|i
index|]
expr_stmt|;
name|channel
operator|->
name|free_arr
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|channel
operator|->
name|free_length
operator|=
name|channel
operator|->
name|reserve_initial
expr_stmt|;
name|channel
operator|->
name|reserve_length
operator|=
name|channel
operator|->
name|reserve_initial
expr_stmt|;
name|channel
operator|->
name|reserve_top
operator|=
literal|0
expr_stmt|;
name|channel
operator|->
name|post_index
operator|=
literal|0
expr_stmt|;
name|channel
operator|->
name|compl_index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
condition|)
block|{
name|status
operator|=
name|__hal_ring_initial_replenish
argument_list|(
name|channel
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|XGE_HAL_OK
condition|)
return|return
name|status
return|;
block|}
block|}
comment|/* move channel to the open state list */
switch|switch
condition|(
name|channel
operator|->
name|type
condition|)
block|{
case|case
name|XGE_HAL_CHANNEL_TYPE_FIFO
case|:
name|xge_list_remove
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|)
expr_stmt|;
name|xge_list_insert
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|,
operator|&
name|device
operator|->
name|fifo_channels
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_RING
case|:
name|xge_list_remove
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|)
expr_stmt|;
name|xge_list_insert
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|,
operator|&
name|device
operator|->
name|ring_channels
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
case|case
name|XGE_HAL_CHANNEL_TYPE_SEND_QUEUE
case|:
name|xge_list_insert
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|,
operator|&
name|device
operator|->
name|virtual_paths
index|[
name|attr
operator|->
name|vp_id
index|]
operator|.
name|sq_channels
argument_list|)
expr_stmt|;
name|device
operator|->
name|virtual_paths
index|[
name|attr
operator|->
name|vp_id
index|]
operator|.
name|stats
operator|.
name|no_sqs
operator|++
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_RECEIVE_QUEUE
case|:
name|xge_list_insert
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|,
operator|&
name|device
operator|->
name|virtual_paths
index|[
name|attr
operator|->
name|vp_id
index|]
operator|.
name|srq_channels
argument_list|)
expr_stmt|;
name|device
operator|->
name|virtual_paths
index|[
name|attr
operator|->
name|vp_id
index|]
operator|.
name|stats
operator|.
name|no_srqs
operator|++
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_COMPLETION_QUEUE
case|:
name|xge_list_insert
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|,
operator|&
name|device
operator|->
name|virtual_paths
index|[
name|attr
operator|->
name|vp_id
index|]
operator|.
name|cqrq_channels
argument_list|)
expr_stmt|;
name|device
operator|->
name|virtual_paths
index|[
name|attr
operator|->
name|vp_id
index|]
operator|.
name|stats
operator|.
name|no_cqrqs
operator|++
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_UP_MESSAGE_QUEUE
case|:
name|xge_list_init
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|)
expr_stmt|;
name|device
operator|->
name|virtual_paths
index|[
name|attr
operator|->
name|vp_id
index|]
operator|.
name|umq_channelh
operator|=
name|channel
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_DOWN_MESSAGE_QUEUE
case|:
name|xge_list_init
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|)
expr_stmt|;
name|device
operator|->
name|virtual_paths
index|[
name|attr
operator|->
name|vp_id
index|]
operator|.
name|dmq_channelh
operator|=
name|channel
expr_stmt|;
break|break;
else|#
directive|else
case|case
name|XGE_HAL_CHANNEL_TYPE_SEND_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_RECEIVE_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_COMPLETION_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_UP_MESSAGE_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_DOWN_MESSAGE_QUEUE
case|:
name|xge_assert
argument_list|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
operator|||
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
name|channel
operator|->
name|is_open
operator|=
literal|1
expr_stmt|;
comment|/* 	 * The magic check the argument validity, has to be 	 * removed before 03/01/2005. 	 */
name|channel
operator|->
name|magic
operator|=
name|XGE_HAL_MAGIC
expr_stmt|;
operator|*
name|channelh
operator|=
name|channel
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
comment|/**  * xge_hal_channel_abort - Abort the channel.  * @channelh: Channel handle.  * @reopen: See  xge_hal_channel_reopen_e{}.  *  * Terminate (via xge_hal_channel_dtr_term_f{}) all channel descriptors.  * Currently used internally only by HAL, as part of its  * xge_hal_channel_close() and xge_hal_channel_open() in case  * of fatal error.  *  * See also: xge_hal_channel_dtr_term_f{}.  */
name|void
name|xge_hal_channel_abort
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_channel_reopen_e
name|reopen
parameter_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|channel
init|=
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_dtr_h
name|dtr
decl_stmt|;
ifdef|#
directive|ifdef
name|XGE_OS_MEMORY_CHECK
name|int
name|check_cnt
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|int
name|free_length_sav
decl_stmt|;
name|int
name|reserve_top_sav
decl_stmt|;
if|if
condition|(
name|channel
operator|->
name|dtr_term
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|free_length_sav
operator|=
name|channel
operator|->
name|free_length
expr_stmt|;
while|while
condition|(
name|__hal_channel_dtr_next_freelist
argument_list|(
name|channelh
argument_list|,
operator|&
name|dtr
argument_list|)
operator|==
name|XGE_HAL_OK
condition|)
block|{
ifdef|#
directive|ifdef
name|XGE_OS_MEMORY_CHECK
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
if|if
condition|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
condition|)
block|{
name|xge_assert
argument_list|(
operator|!
name|__hal_fifo_txdl_priv
argument_list|(
name|dtr
argument_list|)
operator|->
name|allocated
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
condition|)
block|{
name|xge_assert
argument_list|(
operator|!
name|__hal_ring_rxd_priv
argument_list|(
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
argument_list|,
name|dtr
argument_list|)
operator|->
name|allocated
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|check_cnt
operator|++
expr_stmt|;
endif|#
directive|endif
name|channel
operator|->
name|dtr_term
argument_list|(
name|channel
argument_list|,
name|dtr
argument_list|,
name|XGE_HAL_DTR_STATE_FREED
argument_list|,
name|channel
operator|->
name|userdata
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
block|}
name|channel
operator|->
name|free_length
operator|=
name|free_length_sav
expr_stmt|;
while|while
condition|(
name|__hal_channel_dtr_next_not_completed
argument_list|(
name|channelh
argument_list|,
operator|&
name|dtr
argument_list|)
operator|==
name|XGE_HAL_OK
condition|)
block|{
ifdef|#
directive|ifdef
name|XGE_OS_MEMORY_CHECK
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
if|if
condition|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
condition|)
block|{
name|xge_assert
argument_list|(
name|__hal_fifo_txdl_priv
argument_list|(
name|dtr
argument_list|)
operator|->
name|allocated
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
condition|)
block|{
name|xge_assert
argument_list|(
name|__hal_ring_rxd_priv
argument_list|(
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
argument_list|,
name|dtr
argument_list|)
operator|->
name|allocated
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|check_cnt
operator|++
expr_stmt|;
endif|#
directive|endif
name|channel
operator|->
name|dtr_term
argument_list|(
name|channel
argument_list|,
name|dtr
argument_list|,
name|XGE_HAL_DTR_STATE_POSTED
argument_list|,
name|channel
operator|->
name|userdata
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
block|}
name|reserve_top_sav
operator|=
name|channel
operator|->
name|reserve_top
expr_stmt|;
while|while
condition|(
name|__hal_channel_dtr_next_reservelist
argument_list|(
name|channelh
argument_list|,
operator|&
name|dtr
argument_list|)
operator|==
name|XGE_HAL_OK
condition|)
block|{
ifdef|#
directive|ifdef
name|XGE_OS_MEMORY_CHECK
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
if|if
condition|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
condition|)
block|{
name|xge_assert
argument_list|(
operator|!
name|__hal_fifo_txdl_priv
argument_list|(
name|dtr
argument_list|)
operator|->
name|allocated
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
condition|)
block|{
name|xge_assert
argument_list|(
operator|!
name|__hal_ring_rxd_priv
argument_list|(
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
argument_list|,
name|dtr
argument_list|)
operator|->
name|allocated
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|check_cnt
operator|++
expr_stmt|;
endif|#
directive|endif
name|channel
operator|->
name|dtr_term
argument_list|(
name|channel
argument_list|,
name|dtr
argument_list|,
name|XGE_HAL_DTR_STATE_AVAIL
argument_list|,
name|channel
operator|->
name|userdata
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
block|}
name|channel
operator|->
name|reserve_top
operator|=
name|reserve_top_sav
expr_stmt|;
name|xge_assert
argument_list|(
name|channel
operator|->
name|reserve_length
operator|==
operator|(
name|channel
operator|->
name|free_length
operator|+
name|channel
operator|->
name|reserve_top
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_OS_MEMORY_CHECK
name|xge_assert
argument_list|(
name|check_cnt
operator|==
name|channel
operator|->
name|reserve_initial
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/**  * xge_hal_channel_close - Close communication channel.  * @channelh: The channel handle.  * @reopen: See  xge_hal_channel_reopen_e{}.  *  * Will close previously opened channel and deallocate associated resources.  * Channel must be opened otherwise assert will be generated.  * Note that free_channels list is not protected. i.e. caller must provide  * safe context.  */
name|void
name|xge_hal_channel_close
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_channel_reopen_e
name|reopen
parameter_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|channel
init|=
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|xge_list_t
modifier|*
name|item
decl_stmt|;
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
name|u32
name|vp_id
decl_stmt|;
endif|#
directive|endif
name|xge_assert
argument_list|(
name|channel
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|channel
operator|->
name|type
operator|<
name|XGE_HAL_CHANNEL_TYPE_MAX
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|channel
operator|->
name|devh
expr_stmt|;
name|channel
operator|->
name|is_open
operator|=
literal|0
expr_stmt|;
name|channel
operator|->
name|magic
operator|=
name|XGE_HAL_DEAD
expr_stmt|;
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
name|vp_id
operator|=
name|channel
operator|->
name|vp_id
expr_stmt|;
if|if
condition|(
operator|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
operator|)
operator|||
operator|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
operator|)
condition|)
block|{
endif|#
directive|endif
comment|/* sanity check: make sure channel is not in free list */
name|xge_list_for_each
argument_list|(
argument|item
argument_list|,
argument|&hldev->free_channels
argument_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|xge_container_of
argument_list|(
name|item
argument_list|,
name|xge_hal_channel_t
argument_list|,
name|item
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
operator|!
name|tmp
operator|->
name|is_open
argument_list|)
expr_stmt|;
if|if
condition|(
name|channel
operator|==
name|tmp
condition|)
block|{
return|return;
block|}
block|}
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
block|}
endif|#
directive|endif
name|xge_hal_channel_abort
argument_list|(
name|channel
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|XGEHAL_RNIC
name|xge_assert
argument_list|(
operator|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
operator|)
operator|||
operator|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|reopen
operator|==
name|XGE_HAL_CHANNEL_OC_NORMAL
condition|)
block|{
comment|/* de-allocate */
switch|switch
condition|(
name|channel
operator|->
name|type
condition|)
block|{
case|case
name|XGE_HAL_CHANNEL_TYPE_FIFO
case|:
name|__hal_fifo_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_RING
case|:
name|__hal_ring_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
case|case
name|XGE_HAL_CHANNEL_TYPE_SEND_QUEUE
case|:
name|__hal_sq_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|virtual_paths
index|[
name|vp_id
index|]
operator|.
name|stats
operator|.
name|no_sqs
operator|--
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_RECEIVE_QUEUE
case|:
name|__hal_srq_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|virtual_paths
index|[
name|vp_id
index|]
operator|.
name|stats
operator|.
name|no_srqs
operator|--
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_COMPLETION_QUEUE
case|:
name|__hal_cqrq_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|virtual_paths
index|[
name|vp_id
index|]
operator|.
name|stats
operator|.
name|no_cqrqs
operator|--
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_UP_MESSAGE_QUEUE
case|:
name|__hal_umq_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
break|break;
case|case
name|XGE_HAL_CHANNEL_TYPE_DOWN_MESSAGE_QUEUE
case|:
name|__hal_dmq_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
break|break;
else|#
directive|else
case|case
name|XGE_HAL_CHANNEL_TYPE_SEND_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_RECEIVE_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_COMPLETION_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_UP_MESSAGE_QUEUE
case|:
case|case
name|XGE_HAL_CHANNEL_TYPE_DOWN_MESSAGE_QUEUE
case|:
name|xge_assert
argument_list|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
operator|||
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
block|}
else|else
name|xge_assert
argument_list|(
name|reopen
operator|==
name|XGE_HAL_CHANNEL_RESET_ONLY
argument_list|)
expr_stmt|;
comment|/* move channel back to free state list */
name|xge_list_remove
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
if|if
condition|(
operator|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
operator|)
operator|||
operator|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
operator|)
condition|)
block|{
endif|#
directive|endif
name|xge_list_insert
argument_list|(
operator|&
name|channel
operator|->
name|item
argument_list|,
operator|&
name|hldev
operator|->
name|free_channels
argument_list|)
expr_stmt|;
if|if
condition|(
name|xge_list_is_empty
argument_list|(
operator|&
name|hldev
operator|->
name|fifo_channels
argument_list|)
operator|&&
name|xge_list_is_empty
argument_list|(
operator|&
name|hldev
operator|->
name|ring_channels
argument_list|)
condition|)
block|{
comment|/* clear msix_idx in case of following HW reset */
name|hldev
operator|->
name|reset_needed_after_close
operator|=
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|XGEHAL_RNIC
block|}
else|else
block|{
name|__hal_channel_free
argument_list|(
name|channel
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

end_unit


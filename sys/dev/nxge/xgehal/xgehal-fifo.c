begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2007 Neterion, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  *  FileName :    xgehal-fifo.c  *  *  Description:  fifo object implementation  *  *  Created:      10 May 2004  */
end_comment

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-fifo.h>
end_include

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-device.h>
end_include

begin_function
specifier|static
name|xge_hal_status_e
name|__hal_fifo_mempool_item_alloc
parameter_list|(
name|xge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|memblock
parameter_list|,
name|int
name|memblock_index
parameter_list|,
name|xge_hal_mempool_dma_t
modifier|*
name|dma_object
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|int
name|index
parameter_list|,
name|int
name|is_last
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|int
name|memblock_item_idx
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|item
decl_stmt|;
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|xge_assert
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
operator|(
name|xge_hal_fifo_txdl_priv_t
operator|*
operator|)
expr|\
name|__hal_mempool_item_priv
argument_list|(
operator|(
name|xge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|memblock_index
argument_list|,
name|item
argument_list|,
operator|&
name|memblock_item_idx
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|txdl_priv
argument_list|)
expr_stmt|;
comment|/* pre-format HAL's TxDL's private */
name|txdl_priv
operator|->
name|dma_offset
operator|=
operator|(
name|char
operator|*
operator|)
name|item
operator|-
operator|(
name|char
operator|*
operator|)
name|memblock
expr_stmt|;
name|txdl_priv
operator|->
name|dma_addr
operator|=
name|dma_object
operator|->
name|addr
operator|+
name|txdl_priv
operator|->
name|dma_offset
expr_stmt|;
name|txdl_priv
operator|->
name|dma_handle
operator|=
name|dma_object
operator|->
name|handle
expr_stmt|;
name|txdl_priv
operator|->
name|memblock
operator|=
name|memblock
expr_stmt|;
name|txdl_priv
operator|->
name|first_txdp
operator|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|item
expr_stmt|;
name|txdl_priv
operator|->
name|next_txdl_priv
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|dang_txdl
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|dang_frags
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|alloc_frags
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
name|txdl_priv
operator|->
name|dma_object
operator|=
name|dma_object
expr_stmt|;
endif|#
directive|endif
name|txdp
operator|->
name|host_control
operator|=
operator|(
name|u64
operator|)
operator|(
name|ulong_t
operator|)
name|txdl_priv
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_HAL_ALIGN_XMIT
name|txdl_priv
operator|->
name|align_vaddr
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_addr
operator|=
operator|(
name|dma_addr_t
operator|)
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|XGE_HAL_ALIGN_XMIT_ALLOC_RT
block|{
name|xge_hal_status_e
name|status
decl_stmt|;
if|if
condition|(
name|fifo
operator|->
name|config
operator|->
name|alignment_size
condition|)
block|{
name|status
operator|=
name|__hal_fifo_dtr_align_alloc_map
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|XGE_HAL_OK
condition|)
block|{
name|xge_debug_mm
argument_list|(
name|XGE_ERR
argument_list|,
literal|"align buffer[%d] %d bytes, status %d"
argument_list|,
name|index
argument_list|,
name|fifo
operator|->
name|align_size
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
block|}
endif|#
directive|endif
endif|#
directive|endif
if|if
condition|(
name|fifo
operator|->
name|channel
operator|.
name|dtr_init
condition|)
block|{
name|fifo
operator|->
name|channel
operator|.
name|dtr_init
argument_list|(
name|fifo
argument_list|,
operator|(
name|xge_hal_dtr_h
operator|)
name|txdp
argument_list|,
name|index
argument_list|,
name|fifo
operator|->
name|channel
operator|.
name|userdata
argument_list|,
name|XGE_HAL_CHANNEL_OC_NORMAL
argument_list|)
expr_stmt|;
block|}
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_function
specifier|static
name|xge_hal_status_e
name|__hal_fifo_mempool_item_free
parameter_list|(
name|xge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|memblock
parameter_list|,
name|int
name|memblock_index
parameter_list|,
name|xge_hal_mempool_dma_t
modifier|*
name|dma_object
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|int
name|index
parameter_list|,
name|int
name|is_last
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|int
name|memblock_item_idx
decl_stmt|;
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
ifdef|#
directive|ifdef
name|XGE_HAL_ALIGN_XMIT
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|userdata
decl_stmt|;
endif|#
directive|endif
name|xge_assert
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
operator|(
name|xge_hal_fifo_txdl_priv_t
operator|*
operator|)
expr|\
name|__hal_mempool_item_priv
argument_list|(
operator|(
name|xge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|memblock_index
argument_list|,
name|item
argument_list|,
operator|&
name|memblock_item_idx
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|txdl_priv
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_HAL_ALIGN_XMIT
if|if
condition|(
name|fifo
operator|->
name|config
operator|->
name|alignment_size
condition|)
block|{
if|if
condition|(
name|txdl_priv
operator|->
name|align_dma_addr
operator|!=
literal|0
condition|)
block|{
name|xge_os_dma_unmap
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|,
name|txdl_priv
operator|->
name|align_dma_addr
argument_list|,
name|fifo
operator|->
name|align_size
argument_list|,
name|XGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_addr
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|txdl_priv
operator|->
name|align_vaddr
operator|!=
name|NULL
condition|)
block|{
name|xge_os_dma_free
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|align_vaddr
argument_list|,
name|fifo
operator|->
name|align_size
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_acch
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|align_vaddr
operator|=
name|NULL
expr_stmt|;
block|}
block|}
endif|#
directive|endif
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_function
name|xge_hal_status_e
name|__hal_fifo_open
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_channel_attr_t
modifier|*
name|attr
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|xge_hal_status_e
name|status
decl_stmt|;
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_fifo_queue_t
modifier|*
name|queue
decl_stmt|;
name|int
name|i
decl_stmt|,
name|txdl_size
decl_stmt|,
name|max_arr_index
decl_stmt|,
name|mid_point
decl_stmt|;
name|xge_hal_dtr_h
name|dtrh
decl_stmt|;
name|hldev
operator|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|fifo
operator|->
name|config
operator|=
operator|&
name|hldev
operator|->
name|config
operator|.
name|fifo
expr_stmt|;
name|queue
operator|=
operator|&
name|fifo
operator|->
name|config
operator|->
name|queue
index|[
name|attr
operator|->
name|post_qid
index|]
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE
argument_list|)
name|xge_os_spin_lock_init
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE_IRQ
argument_list|)
name|xge_os_spin_lock_init_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|,
name|hldev
operator|->
name|irqh
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST
argument_list|)
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|==
name|XGE_HAL_CARD_XENA
condition|)
block|{
name|fifo
operator|->
name|post_lock_ptr
operator|=
operator|&
name|hldev
operator|->
name|xena_post_lock
expr_stmt|;
block|}
else|else
block|{
name|xge_os_spin_lock_init
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
name|fifo
operator|->
name|post_lock_ptr
operator|=
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
expr_stmt|;
block|}
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|==
name|XGE_HAL_CARD_XENA
condition|)
block|{
name|fifo
operator|->
name|post_lock_ptr
operator|=
operator|&
name|hldev
operator|->
name|xena_post_lock
expr_stmt|;
block|}
else|else
block|{
name|xge_os_spin_lock_init_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|irqh
argument_list|)
expr_stmt|;
name|fifo
operator|->
name|post_lock_ptr
operator|=
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
expr_stmt|;
block|}
endif|#
directive|endif
name|fifo
operator|->
name|align_size
operator|=
name|fifo
operator|->
name|config
operator|->
name|alignment_size
operator|*
name|fifo
operator|->
name|config
operator|->
name|max_aligned_frags
expr_stmt|;
comment|/* Initializing the BAR1 address as the start of 	 * the FIFO queue pointer and as a location of FIFO control 	 * word. */
name|fifo
operator|->
name|hw_pair
operator|=
operator|(
name|xge_hal_fifo_hw_pair_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
name|hldev
operator|->
name|bar1
operator|+
operator|(
name|attr
operator|->
name|post_qid
operator|*
name|XGE_HAL_FIFO_HW_PAIR_OFFSET
operator|)
operator|)
expr_stmt|;
comment|/* apply "interrupts per txdl" attribute */
name|fifo
operator|->
name|interrupt_type
operator|=
name|XGE_HAL_TXD_INT_TYPE_UTILZ
expr_stmt|;
if|if
condition|(
name|queue
operator|->
name|intr
condition|)
block|{
name|fifo
operator|->
name|interrupt_type
operator|=
name|XGE_HAL_TXD_INT_TYPE_PER_LIST
expr_stmt|;
block|}
name|fifo
operator|->
name|no_snoop_bits
operator|=
call|(
name|int
call|)
argument_list|(
name|XGE_HAL_TX_FIFO_NO_SNOOP
argument_list|(
name|queue
operator|->
name|no_snoop_bits
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * FIFO memory management strategy: 	 * 	 * TxDL splitted into three independent parts: 	 *	- set of TxD's 	 *	- TxD HAL private part 	 *	- upper layer private part 	 * 	 * Adaptative memory allocation used. i.e. Memory allocated on 	 * demand with the size which will fit into one memory block. 	 * One memory block may contain more than one TxDL. In simple case 	 * memory block size can be equal to CPU page size. On more 	 * sophisticated OS's memory block can be contigious across 	 * several pages. 	 * 	 * During "reserve" operations more memory can be allocated on demand 	 * for example due to FIFO full condition. 	 * 	 * Pool of memory memblocks never shrinks except __hal_fifo_close 	 * routine which will essentially stop channel and free the resources. 	 */
comment|/* TxDL common private size == TxDL private + ULD private */
name|fifo
operator|->
name|priv_size
operator|=
sizeof|sizeof
argument_list|(
name|xge_hal_fifo_txdl_priv_t
argument_list|)
operator|+
name|attr
operator|->
name|per_dtr_space
expr_stmt|;
name|fifo
operator|->
name|priv_size
operator|=
operator|(
operator|(
name|fifo
operator|->
name|priv_size
operator|+
name|__xge_os_cacheline_size
operator|-
literal|1
operator|)
operator|/
name|__xge_os_cacheline_size
operator|)
operator|*
name|__xge_os_cacheline_size
expr_stmt|;
comment|/* recompute txdl size to be cacheline aligned */
name|fifo
operator|->
name|txdl_size
operator|=
name|fifo
operator|->
name|config
operator|->
name|max_frags
operator|*
sizeof|sizeof
argument_list|(
name|xge_hal_fifo_txd_t
argument_list|)
expr_stmt|;
name|txdl_size
operator|=
operator|(
operator|(
name|fifo
operator|->
name|txdl_size
operator|+
name|__xge_os_cacheline_size
operator|-
literal|1
operator|)
operator|/
name|__xge_os_cacheline_size
operator|)
operator|*
name|__xge_os_cacheline_size
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|txdl_size
operator|!=
name|txdl_size
condition|)
name|xge_debug_fifo
argument_list|(
name|XGE_ERR
argument_list|,
literal|"cacheline> 128 ( ?? ): %d, %d, %d, %d"
argument_list|,
name|fifo
operator|->
name|config
operator|->
name|max_frags
argument_list|,
name|fifo
operator|->
name|txdl_size
argument_list|,
name|txdl_size
argument_list|,
name|__xge_os_cacheline_size
argument_list|)
expr_stmt|;
name|fifo
operator|->
name|txdl_size
operator|=
name|txdl_size
expr_stmt|;
comment|/* since dtr_init() callback will be called from item_alloc(), 	 * the same way channels userdata might be used prior to 	 * channel_initialize() */
name|fifo
operator|->
name|channel
operator|.
name|dtr_init
operator|=
name|attr
operator|->
name|dtr_init
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|userdata
operator|=
name|attr
operator|->
name|userdata
expr_stmt|;
name|fifo
operator|->
name|txdl_per_memblock
operator|=
name|fifo
operator|->
name|config
operator|->
name|memblock_size
operator|/
name|fifo
operator|->
name|txdl_size
expr_stmt|;
name|fifo
operator|->
name|mempool
operator|=
name|__hal_mempool_create
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|fifo
operator|->
name|config
operator|->
name|memblock_size
argument_list|,
name|fifo
operator|->
name|txdl_size
argument_list|,
name|fifo
operator|->
name|priv_size
argument_list|,
name|queue
operator|->
name|initial
argument_list|,
name|queue
operator|->
name|max
argument_list|,
name|__hal_fifo_mempool_item_alloc
argument_list|,
name|__hal_fifo_mempool_item_free
argument_list|,
name|fifo
argument_list|)
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|mempool
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|status
operator|=
name|__hal_channel_initialize
argument_list|(
name|channelh
argument_list|,
name|attr
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
name|__hal_mempool_items_arr
argument_list|(
name|fifo
operator|->
name|mempool
argument_list|)
argument_list|,
name|queue
operator|->
name|initial
argument_list|,
name|queue
operator|->
name|max
argument_list|,
name|fifo
operator|->
name|config
operator|->
name|reserve_threshold
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|XGE_HAL_OK
condition|)
block|{
name|__hal_fifo_close
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"DTR  reserve_length:%d reserve_top:%d\n"
literal|"max_frags:%d reserve_threshold:%d\n"
literal|"memblock_size:%d alignment_size:%d max_aligned_frags:%d"
argument_list|,
name|fifo
operator|->
name|channel
operator|.
name|reserve_length
argument_list|,
name|fifo
operator|->
name|channel
operator|.
name|reserve_top
argument_list|,
name|fifo
operator|->
name|config
operator|->
name|max_frags
argument_list|,
name|fifo
operator|->
name|config
operator|->
name|reserve_threshold
argument_list|,
name|fifo
operator|->
name|config
operator|->
name|memblock_size
argument_list|,
name|fifo
operator|->
name|config
operator|->
name|alignment_size
argument_list|,
name|fifo
operator|->
name|config
operator|->
name|max_aligned_frags
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fifo
operator|->
name|channel
operator|.
name|reserve_length
condition|;
name|i
operator|++
control|)
block|{
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"DTR before reversing index:%d"
literal|" handle:%p"
argument_list|,
name|i
argument_list|,
name|fifo
operator|->
name|channel
operator|.
name|reserve_arr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|xge_assert
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|reserve_length
argument_list|)
expr_stmt|;
comment|/* reverse the FIFO dtr array */
name|max_arr_index
operator|=
name|fifo
operator|->
name|channel
operator|.
name|reserve_length
operator|-
literal|1
expr_stmt|;
name|max_arr_index
operator|-=
name|fifo
operator|->
name|channel
operator|.
name|reserve_top
expr_stmt|;
name|xge_assert
argument_list|(
name|max_arr_index
argument_list|)
expr_stmt|;
name|mid_point
operator|=
operator|(
name|fifo
operator|->
name|channel
operator|.
name|reserve_length
operator|-
name|fifo
operator|->
name|channel
operator|.
name|reserve_top
operator|)
operator|/
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mid_point
condition|;
name|i
operator|++
control|)
block|{
name|dtrh
operator|=
name|fifo
operator|->
name|channel
operator|.
name|reserve_arr
index|[
name|i
index|]
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|reserve_arr
index|[
name|i
index|]
operator|=
name|fifo
operator|->
name|channel
operator|.
name|reserve_arr
index|[
name|max_arr_index
operator|-
name|i
index|]
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|reserve_arr
index|[
name|max_arr_index
operator|-
name|i
index|]
operator|=
name|dtrh
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fifo
operator|->
name|channel
operator|.
name|reserve_length
condition|;
name|i
operator|++
control|)
block|{
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"DTR after reversing index:%d"
literal|" handle:%p"
argument_list|,
name|i
argument_list|,
name|fifo
operator|->
name|channel
operator|.
name|reserve_arr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_function
name|void
name|__hal_fifo_close
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|)
block|{
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
decl_stmt|;
if|if
condition|(
name|fifo
operator|->
name|mempool
condition|)
block|{
name|__hal_mempool_destroy
argument_list|(
name|fifo
operator|->
name|mempool
argument_list|)
expr_stmt|;
block|}
name|__hal_channel_terminate
argument_list|(
name|channelh
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE
argument_list|)
name|xge_os_spin_lock_destroy
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_RESERVE_IRQ
argument_list|)
name|xge_os_spin_lock_destroy_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|reserve_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|==
name|XGE_HAL_CARD_HERC
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST
argument_list|)
name|xge_os_spin_lock_destroy
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|xge_os_spin_lock_destroy_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_function

begin_function
name|void
name|__hal_fifo_hw_initialize
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|xge_hal_pci_bar0_t
modifier|*
name|bar0
init|=
operator|(
name|xge_hal_pci_bar0_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|hldev
operator|->
name|bar0
decl_stmt|;
name|u64
modifier|*
name|tx_fifo_partitions
index|[
literal|4
index|]
decl_stmt|;
name|u64
modifier|*
name|tx_fifo_wrr
index|[
literal|5
index|]
decl_stmt|;
name|u64
name|tx_fifo_wrr_value
index|[
literal|5
index|]
decl_stmt|;
name|u64
name|val64
decl_stmt|,
name|part0
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/*  Tx DMA Initialization */
name|tx_fifo_partitions
index|[
literal|0
index|]
operator|=
operator|&
name|bar0
operator|->
name|tx_fifo_partition_0
expr_stmt|;
name|tx_fifo_partitions
index|[
literal|1
index|]
operator|=
operator|&
name|bar0
operator|->
name|tx_fifo_partition_1
expr_stmt|;
name|tx_fifo_partitions
index|[
literal|2
index|]
operator|=
operator|&
name|bar0
operator|->
name|tx_fifo_partition_2
expr_stmt|;
name|tx_fifo_partitions
index|[
literal|3
index|]
operator|=
operator|&
name|bar0
operator|->
name|tx_fifo_partition_3
expr_stmt|;
name|tx_fifo_wrr
index|[
literal|0
index|]
operator|=
operator|&
name|bar0
operator|->
name|tx_w_round_robin_0
expr_stmt|;
name|tx_fifo_wrr
index|[
literal|1
index|]
operator|=
operator|&
name|bar0
operator|->
name|tx_w_round_robin_1
expr_stmt|;
name|tx_fifo_wrr
index|[
literal|2
index|]
operator|=
operator|&
name|bar0
operator|->
name|tx_w_round_robin_2
expr_stmt|;
name|tx_fifo_wrr
index|[
literal|3
index|]
operator|=
operator|&
name|bar0
operator|->
name|tx_w_round_robin_3
expr_stmt|;
name|tx_fifo_wrr
index|[
literal|4
index|]
operator|=
operator|&
name|bar0
operator|->
name|tx_w_round_robin_4
expr_stmt|;
name|tx_fifo_wrr_value
index|[
literal|0
index|]
operator|=
name|XGE_HAL_FIFO_WRR_0
expr_stmt|;
name|tx_fifo_wrr_value
index|[
literal|1
index|]
operator|=
name|XGE_HAL_FIFO_WRR_1
expr_stmt|;
name|tx_fifo_wrr_value
index|[
literal|2
index|]
operator|=
name|XGE_HAL_FIFO_WRR_2
expr_stmt|;
name|tx_fifo_wrr_value
index|[
literal|3
index|]
operator|=
name|XGE_HAL_FIFO_WRR_3
expr_stmt|;
name|tx_fifo_wrr_value
index|[
literal|4
index|]
operator|=
name|XGE_HAL_FIFO_WRR_4
expr_stmt|;
comment|/* Note: WRR calendar must be configured before the transmit 	 *       FIFOs are enabled! page 6-77 user guide */
if|if
condition|(
operator|!
name|hldev
operator|->
name|config
operator|.
name|rts_qos_en
condition|)
block|{
comment|/* all zeroes for Round-Robin */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_FIFO_MAX_WRR
condition|;
name|i
operator|++
control|)
block|{
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
literal|0
argument_list|,
name|tx_fifo_wrr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* reset all of them but '0' */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|XGE_HAL_FIFO_MAX_PARTITION
condition|;
name|i
operator|++
control|)
block|{
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
literal|0ULL
argument_list|,
name|tx_fifo_partitions
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Change the default settings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_FIFO_MAX_WRR
condition|;
name|i
operator|++
control|)
block|{
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|tx_fifo_wrr_value
index|[
name|i
index|]
argument_list|,
name|tx_fifo_wrr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* configure only configured FIFOs */
name|val64
operator|=
literal|0
expr_stmt|;
name|part0
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_MAX_FIFO_NUM
condition|;
name|i
operator|++
control|)
block|{
name|int
name|reg_half
init|=
name|i
operator|%
literal|2
decl_stmt|;
name|int
name|reg_num
init|=
name|i
operator|/
literal|2
decl_stmt|;
if|if
condition|(
name|hldev
operator|->
name|config
operator|.
name|fifo
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|configured
condition|)
block|{
name|int
name|priority
init|=
name|hldev
operator|->
name|config
operator|.
name|fifo
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|priority
decl_stmt|;
name|val64
operator||=
name|vBIT
argument_list|(
operator|(
name|hldev
operator|->
name|config
operator|.
name|fifo
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|max
operator|-
literal|1
operator|)
argument_list|,
operator|(
operator|(
operator|(
name|reg_half
operator|)
operator|*
literal|32
operator|)
operator|+
literal|19
operator|)
argument_list|,
literal|13
argument_list|)
operator||
name|vBIT
argument_list|(
name|priority
argument_list|,
operator|(
operator|(
operator|(
name|reg_half
operator|)
operator|*
literal|32
operator|)
operator|+
literal|5
operator|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
comment|/* NOTE: do write operation for each second u64 half 		 *       or force for first one if configured number 		 *	 is even */
if|if
condition|(
name|reg_half
condition|)
block|{
if|if
condition|(
name|reg_num
operator|==
literal|0
condition|)
block|{
comment|/* skip partition '0', must write it once at 				 * the end */
name|part0
operator|=
name|val64
expr_stmt|;
block|}
else|else
block|{
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
name|tx_fifo_partitions
index|[
name|reg_num
index|]
argument_list|)
expr_stmt|;
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"fifo partition_%d at: "
literal|"0x"
name|XGE_OS_LLXFMT
literal|" is: 0x"
name|XGE_OS_LLXFMT
argument_list|,
name|reg_num
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|(
name|ulong_t
operator|)
name|tx_fifo_partitions
index|[
name|reg_num
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|val64
argument_list|)
expr_stmt|;
block|}
name|val64
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|part0
operator||=
name|BIT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* to enable the FIFO partition. */
name|__hal_pio_mem_write32_lower
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
operator|(
name|u32
operator|)
name|part0
argument_list|,
name|tx_fifo_partitions
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|xge_os_wmb
argument_list|()
expr_stmt|;
name|__hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
call|(
name|u32
call|)
argument_list|(
name|part0
operator|>>
literal|32
argument_list|)
argument_list|,
name|tx_fifo_partitions
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"fifo partition_0 at: "
literal|"0x"
name|XGE_OS_LLXFMT
literal|" is: 0x"
name|XGE_OS_LLXFMT
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|(
name|ulong_t
operator|)
name|tx_fifo_partitions
index|[
literal|0
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|part0
argument_list|)
expr_stmt|;
comment|/* 	 * Initialization of Tx_PA_CONFIG register to ignore packet 	 * integrity checking. 	 */
name|val64
operator|=
name|xge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
operator|&
name|bar0
operator|->
name|tx_pa_cfg
argument_list|)
expr_stmt|;
name|val64
operator||=
name|XGE_HAL_TX_PA_CFG_IGNORE_FRM_ERR
operator||
name|XGE_HAL_TX_PA_CFG_IGNORE_SNAP_OUI
operator||
name|XGE_HAL_TX_PA_CFG_IGNORE_LLC_CTRL
operator||
name|XGE_HAL_TX_PA_CFG_IGNORE_L2_ERR
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|tx_pa_cfg
argument_list|)
expr_stmt|;
comment|/* 	 * Assign MSI-X vectors 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_MAX_FIFO_NUM
condition|;
name|i
operator|++
control|)
block|{
name|xge_list_t
modifier|*
name|item
decl_stmt|;
name|xge_hal_channel_t
modifier|*
name|channel
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|hldev
operator|->
name|config
operator|.
name|fifo
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|configured
operator|||
operator|!
name|hldev
operator|->
name|config
operator|.
name|fifo
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|intr_vector
operator|||
operator|!
name|hldev
operator|->
name|config
operator|.
name|intr_mode
operator|!=
name|XGE_HAL_INTR_MODE_MSIX
condition|)
continue|continue;
comment|/* find channel */
name|xge_list_for_each
argument_list|(
argument|item
argument_list|,
argument|&hldev->free_channels
argument_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|xge_container_of
argument_list|(
name|item
argument_list|,
name|xge_hal_channel_t
argument_list|,
name|item
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
operator|&&
name|tmp
operator|->
name|post_qid
operator|==
name|i
condition|)
block|{
name|channel
operator|=
name|tmp
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|channel
condition|)
block|{
name|xge_hal_channel_msix_set
argument_list|(
name|channel
argument_list|,
name|hldev
operator|->
name|config
operator|.
name|fifo
operator|.
name|queue
index|[
name|i
index|]
operator|.
name|intr_vector
argument_list|)
expr_stmt|;
block|}
block|}
name|xge_debug_fifo
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"%s"
argument_list|,
literal|"fifo channels initialized"
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|XGE_HAL_ALIGN_XMIT
end_ifdef

begin_function
name|void
name|__hal_fifo_dtr_align_free_unmap
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|txdp
argument_list|)
expr_stmt|;
if|if
condition|(
name|txdl_priv
operator|->
name|align_dma_addr
operator|!=
literal|0
condition|)
block|{
name|xge_os_dma_unmap
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|,
name|txdl_priv
operator|->
name|align_dma_addr
argument_list|,
name|fifo
operator|->
name|align_size
argument_list|,
name|XGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_addr
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|txdl_priv
operator|->
name|align_vaddr
operator|!=
name|NULL
condition|)
block|{
name|xge_os_dma_free
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|align_vaddr
argument_list|,
name|fifo
operator|->
name|align_size
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_acch
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|align_vaddr
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|xge_hal_status_e
name|__hal_fifo_dtr_align_alloc_map
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|xge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|xge_hal_fifo_txd_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|xge_hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|xge_hal_fifo_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_assert
argument_list|(
name|txdp
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|__hal_fifo_txdl_priv
argument_list|(
name|txdp
argument_list|)
expr_stmt|;
comment|/* allocate alignment DMA-buffer */
name|txdl_priv
operator|->
name|align_vaddr
operator|=
name|xge_os_dma_malloc
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|fifo
operator|->
name|align_size
argument_list|,
name|XGE_OS_DMA_CACHELINE_ALIGNED
operator||
name|XGE_OS_DMA_STREAMING
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_acch
argument_list|)
expr_stmt|;
if|if
condition|(
name|txdl_priv
operator|->
name|align_vaddr
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
comment|/* map it */
name|txdl_priv
operator|->
name|align_dma_addr
operator|=
name|xge_os_dma_map
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|,
name|txdl_priv
operator|->
name|align_vaddr
argument_list|,
name|fifo
operator|->
name|align_size
argument_list|,
name|XGE_OS_DMA_DIR_TODEVICE
argument_list|,
name|XGE_OS_DMA_STREAMING
argument_list|)
expr_stmt|;
if|if
condition|(
name|txdl_priv
operator|->
name|align_dma_addr
operator|==
name|XGE_OS_INVALID_DMA_ADDR
condition|)
block|{
name|__hal_fifo_dtr_align_free_unmap
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MAPPING
return|;
block|}
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


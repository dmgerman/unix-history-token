begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2007 Neterion, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|XGE_DEBUG_FP
end_ifdef

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-ring.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|xge_hal_ring_rxd_priv_t
modifier|*
name|__hal_ring_rxd_priv
parameter_list|(
name|xge_hal_ring_t
modifier|*
name|ring
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|xge_hal_ring_rxd_priv_t
modifier|*
name|rxd_priv
decl_stmt|;
name|xge_assert
argument_list|(
name|rxdp
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_USE_5B_MODE
argument_list|)
name|xge_assert
argument_list|(
name|ring
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|buffer_mode
operator|==
name|XGE_HAL_RING_QUEUE_BUFFER_MODE_5
condition|)
block|{
name|xge_hal_ring_rxd_5_t
modifier|*
name|rxdp_5
init|=
operator|(
name|xge_hal_ring_rxd_5_t
operator|*
operator|)
name|dtrh
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_PLATFORM_64BIT
argument_list|)
name|int
name|memblock_idx
init|=
name|rxdp_5
operator|->
name|host_control
operator|>>
literal|16
decl_stmt|;
name|int
name|i
init|=
name|rxdp_5
operator|->
name|host_control
operator|&
literal|0xFFFF
decl_stmt|;
name|rxd_priv
operator|=
operator|(
name|xge_hal_ring_rxd_priv_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ring
operator|->
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|memblock_idx
index|]
operator|+
name|ring
operator|->
name|rxd_priv_size
operator|*
name|i
operator|)
expr_stmt|;
else|#
directive|else
comment|/* 32-bit case */
name|rxd_priv
operator|=
operator|(
name|xge_hal_ring_rxd_priv_t
operator|*
operator|)
name|rxdp_5
operator|->
name|host_control
expr_stmt|;
endif|#
directive|endif
block|}
else|else
endif|#
directive|endif
block|{
name|rxd_priv
operator|=
operator|(
name|xge_hal_ring_rxd_priv_t
operator|*
operator|)
operator|(
name|ulong_t
operator|)
name|rxdp
operator|->
name|host_control
expr_stmt|;
block|}
name|xge_assert
argument_list|(
name|rxd_priv
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|rxd_priv
operator|->
name|dma_object
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|rxd_priv
operator|->
name|dma_object
operator|->
name|handle
operator|==
name|rxd_priv
operator|->
name|dma_handle
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|rxd_priv
operator|->
name|dma_object
operator|->
name|addr
operator|+
name|rxd_priv
operator|->
name|dma_offset
operator|==
name|rxd_priv
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
return|return
name|rxd_priv
return|;
block|}
end_function

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|int
name|__hal_ring_block_memblock_idx
parameter_list|(
name|xge_hal_ring_block_t
modifier|*
name|block
parameter_list|)
block|{
return|return
operator|(
name|int
operator|)
operator|*
operator|(
operator|(
name|u64
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XGE_HAL_RING_MEMBLOCK_IDX_OFFSET
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|__hal_ring_block_memblock_idx_set
parameter_list|(
name|xge_hal_ring_block_t
modifier|*
name|block
parameter_list|,
name|int
name|memblock_idx
parameter_list|)
block|{
operator|*
operator|(
operator|(
name|u64
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XGE_HAL_RING_MEMBLOCK_IDX_OFFSET
operator|)
operator|)
operator|=
name|memblock_idx
expr_stmt|;
block|}
end_function

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|dma_addr_t
name|__hal_ring_block_next_pointer
parameter_list|(
name|xge_hal_ring_block_t
modifier|*
name|block
parameter_list|)
block|{
return|return
operator|(
name|dma_addr_t
operator|)
operator|*
operator|(
operator|(
name|u64
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XGE_HAL_RING_NEXT_BLOCK_POINTER_OFFSET
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|__hal_ring_block_next_pointer_set
parameter_list|(
name|xge_hal_ring_block_t
modifier|*
name|block
parameter_list|,
name|dma_addr_t
name|dma_next
parameter_list|)
block|{
operator|*
operator|(
operator|(
name|u64
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block
operator|+
name|XGE_HAL_RING_NEXT_BLOCK_POINTER_OFFSET
operator|)
operator|)
operator|=
name|dma_next
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_private - Get ULD private per-descriptor data.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  *  * Returns: private ULD info associated with the descriptor.  * ULD requests per-descriptor space via xge_hal_channel_open().  *  * See also: xge_hal_fifo_dtr_private().  * Usage: See ex_rx_compl{}.  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
modifier|*
name|xge_hal_ring_dtr_private
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
return|return
operator|(
name|char
operator|*
operator|)
name|__hal_ring_rxd_priv
argument_list|(
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
argument_list|,
name|dtrh
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|xge_hal_ring_rxd_priv_t
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_reserve - Reserve ring descriptor.  * @channelh: Channel handle.  * @dtrh: Reserved descriptor. On success HAL fills this "out" parameter  *        with a valid handle.  *  * Reserve Rx descriptor for the subsequent filling-in (by upper layer  * driver (ULD)) and posting on the corresponding channel (@channelh)  * via xge_hal_ring_dtr_post().  *  * Returns: XGE_HAL_OK - success.  * XGE_HAL_INF_OUT_OF_DESCRIPTORS - Currently no descriptors available.  *  * See also: xge_hal_fifo_dtr_reserve(), xge_hal_ring_dtr_free(),  * xge_hal_fifo_dtr_reserve_sp(), xge_hal_status_e{}.  * Usage: See ex_post_all_rx{}.  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|xge_hal_status_e
name|xge_hal_ring_dtr_reserve
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
modifier|*
name|dtrh
parameter_list|)
block|{
name|xge_hal_status_e
name|status
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE_IRQ
argument_list|)
name|unsigned
name|long
name|flags
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE
argument_list|)
name|xge_os_spin_lock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|reserve_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE_IRQ
argument_list|)
name|xge_os_spin_lock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|reserve_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|status
operator|=
name|__hal_channel_dtr_alloc
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE
argument_list|)
name|xge_os_spin_unlock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|reserve_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_RESERVE_IRQ
argument_list|)
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|reserve_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|status
operator|==
name|XGE_HAL_OK
condition|)
block|{
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
operator|*
name|dtrh
decl_stmt|;
comment|/* instead of memset: reset this RxD */
name|rxdp
operator|->
name|control_1
operator|=
name|rxdp
operator|->
name|control_2
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_MEMORY_CHECK
argument_list|)
name|__hal_ring_rxd_priv
argument_list|(
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
argument_list|,
name|rxdp
argument_list|)
operator|->
name|allocated
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_info_get - Get extended information associated with  * a completed receive descriptor for 1b mode.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  * @ext_info: See xge_hal_dtr_info_t{}. Returned by HAL.  *  * Retrieve extended information associated with a completed receive descriptor.  *  * See also: xge_hal_dtr_info_t{}, xge_hal_ring_dtr_1b_get(),  * xge_hal_ring_dtr_5b_get().  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_info_get
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|xge_hal_dtr_info_t
modifier|*
name|ext_info
parameter_list|)
block|{
comment|/* cast to 1-buffer mode RxD: the code below relies on the fact 	 * that control_1 and control_2 are formatted the same way.. */
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|ext_info
operator|->
name|l3_cksum
operator|=
name|XGE_HAL_RXD_GET_L3_CKSUM
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|l4_cksum
operator|=
name|XGE_HAL_RXD_GET_L4_CKSUM
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|frame
operator|=
name|XGE_HAL_RXD_GET_FRAME_TYPE
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|proto
operator|=
name|XGE_HAL_RXD_GET_FRAME_PROTO
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|vlan
operator|=
name|XGE_HAL_RXD_GET_VLAN_TAG
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
comment|/* Herc only, a few extra cycles imposed on Xena and/or 	 * when RTH is not enabled. 	 * Alternatively, could check 	 * xge_hal_device_check_id(), hldev->config.rth_en, queue->rth_en */
name|ext_info
operator|->
name|rth_it_hit
operator|=
name|XGE_HAL_RXD_GET_RTH_IT_HIT
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|rth_spdm_hit
operator|=
name|XGE_HAL_RXD_GET_RTH_SPDM_HIT
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|rth_hash_type
operator|=
name|XGE_HAL_RXD_GET_RTH_HASH_TYPE
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|rth_value
operator|=
name|XGE_HAL_RXD_1_GET_RTH_VALUE
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_info_nb_get - Get extended information associated  * with a completed receive descriptor for 3b or 5b  * modes.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  * @ext_info: See xge_hal_dtr_info_t{}. Returned by HAL.  *  * Retrieve extended information associated with a completed receive descriptor.  *  * See also: xge_hal_dtr_info_t{}, xge_hal_ring_dtr_1b_get(),  *           xge_hal_ring_dtr_5b_get().  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_info_nb_get
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|xge_hal_dtr_info_t
modifier|*
name|ext_info
parameter_list|)
block|{
comment|/* cast to 1-buffer mode RxD: the code below relies on the fact 	 * that control_1 and control_2 are formatted the same way.. */
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|ext_info
operator|->
name|l3_cksum
operator|=
name|XGE_HAL_RXD_GET_L3_CKSUM
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|l4_cksum
operator|=
name|XGE_HAL_RXD_GET_L4_CKSUM
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|frame
operator|=
name|XGE_HAL_RXD_GET_FRAME_TYPE
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|proto
operator|=
name|XGE_HAL_RXD_GET_FRAME_PROTO
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|vlan
operator|=
name|XGE_HAL_RXD_GET_VLAN_TAG
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
comment|/* Herc only, a few extra cycles imposed on Xena and/or 	 * when RTH is not enabled. Same comment as above. */
name|ext_info
operator|->
name|rth_it_hit
operator|=
name|XGE_HAL_RXD_GET_RTH_IT_HIT
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|rth_spdm_hit
operator|=
name|XGE_HAL_RXD_GET_RTH_SPDM_HIT
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|rth_hash_type
operator|=
name|XGE_HAL_RXD_GET_RTH_HASH_TYPE
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
name|ext_info
operator|->
name|rth_value
operator|=
operator|(
name|u32
operator|)
name|rxdp
operator|->
name|buffer0_ptr
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_1b_set - Prepare 1-buffer-mode descriptor.  * @dtrh: Descriptor handle.  * @dma_pointer: DMA address of a single receive buffer this descriptor  *               should carry. Note that by the time  *               xge_hal_ring_dtr_1b_set  *               is called, the receive buffer should be already mapped  *               to the corresponding Xframe device.  * @size: Size of the receive @dma_pointer buffer.  *  * Prepare 1-buffer-mode Rx descriptor for posting  * (via xge_hal_ring_dtr_post()).  *  * This inline helper-function does not return any parameters and always  * succeeds.  *  * See also: xge_hal_ring_dtr_3b_set(), xge_hal_ring_dtr_5b_set().  * Usage: See ex_post_all_rx{}.  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_1b_set
parameter_list|(
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|dma_addr_t
name|dma_pointer
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|rxdp
operator|->
name|buffer0_ptr
operator|=
name|dma_pointer
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator|&=
operator|(
operator|~
name|XGE_HAL_RXD_1_MASK_BUFFER0_SIZE
operator|)
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator||=
name|XGE_HAL_RXD_1_SET_BUFFER0_SIZE
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"xge_hal_ring_dtr_1b_set: rxdp %p control_2 %p buffer0_ptr %p"
argument_list|,
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
argument_list|,
name|rxdp
operator|->
name|control_2
argument_list|,
name|rxdp
operator|->
name|buffer0_ptr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_1b_get - Get data from the completed 1-buf  * descriptor.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  * @dma_pointer: DMA address of a single receive buffer _this_ descriptor  *               carries. Returned by HAL.  * @pkt_length: Length (in bytes) of the data in the buffer pointed by  *              @dma_pointer. Returned by HAL.  *  * Retrieve protocol data from the completed 1-buffer-mode Rx descriptor.  * This inline helper-function uses completed descriptor to populate receive  * buffer pointer and other "out" parameters. The function always succeeds.  *  * See also: xge_hal_ring_dtr_3b_get(), xge_hal_ring_dtr_5b_get().  * Usage: See ex_rx_compl{}.  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_1b_get
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|dma_addr_t
modifier|*
name|dma_pointer
parameter_list|,
name|int
modifier|*
name|pkt_length
parameter_list|)
block|{
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
decl_stmt|;
operator|*
name|pkt_length
operator|=
name|XGE_HAL_RXD_1_GET_BUFFER0_SIZE
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
operator|*
name|dma_pointer
operator|=
name|rxdp
operator|->
name|buffer0_ptr
expr_stmt|;
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|poll_bytes
operator|+=
operator|*
name|pkt_length
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_3b_set - Prepare 3-buffer-mode descriptor.  * @dtrh: Descriptor handle.  * @dma_pointers: Array of DMA addresses. Contains exactly 3 receive buffers  *               _this_ descriptor should carry.  *               Note that by the time xge_hal_ring_dtr_3b_set  *               is called, the receive buffers should be mapped  *               to the corresponding Xframe device.  * @sizes: Array of receive buffer sizes. Contains 3 sizes: one size per  *         buffer from @dma_pointers.  *  * Prepare 3-buffer-mode Rx descriptor for posting (via  * xge_hal_ring_dtr_post()).  * This inline helper-function does not return any parameters and always  * succeeds.  *  * See also: xge_hal_ring_dtr_1b_set(), xge_hal_ring_dtr_5b_set().  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_3b_set
parameter_list|(
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|dma_addr_t
name|dma_pointers
index|[]
parameter_list|,
name|int
name|sizes
index|[]
parameter_list|)
block|{
name|xge_hal_ring_rxd_3_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_3_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|rxdp
operator|->
name|buffer0_ptr
operator|=
name|dma_pointers
index|[
literal|0
index|]
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator|&=
operator|(
operator|~
name|XGE_HAL_RXD_3_MASK_BUFFER0_SIZE
operator|)
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator||=
name|XGE_HAL_RXD_3_SET_BUFFER0_SIZE
argument_list|(
name|sizes
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|rxdp
operator|->
name|buffer1_ptr
operator|=
name|dma_pointers
index|[
literal|1
index|]
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator|&=
operator|(
operator|~
name|XGE_HAL_RXD_3_MASK_BUFFER1_SIZE
operator|)
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator||=
name|XGE_HAL_RXD_3_SET_BUFFER1_SIZE
argument_list|(
name|sizes
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|rxdp
operator|->
name|buffer2_ptr
operator|=
name|dma_pointers
index|[
literal|2
index|]
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator|&=
operator|(
operator|~
name|XGE_HAL_RXD_3_MASK_BUFFER2_SIZE
operator|)
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator||=
name|XGE_HAL_RXD_3_SET_BUFFER2_SIZE
argument_list|(
name|sizes
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_3b_get - Get data from the completed 3-buf  * descriptor.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  * @dma_pointers: DMA addresses of the 3 receive buffers _this_ descriptor  *                carries. The first two buffers contain ethernet and  *                (IP + transport) headers. The 3rd buffer contains packet  *                data.  *                Returned by HAL.  * @sizes: Array of receive buffer sizes. Contains 3 sizes: one size per  * buffer from @dma_pointers. Returned by HAL.  *  * Retrieve protocol data from the completed 3-buffer-mode Rx descriptor.  * This inline helper-function uses completed descriptor to populate receive  * buffer pointer and other "out" parameters. The function always succeeds.  *  * See also: xge_hal_ring_dtr_3b_get(), xge_hal_ring_dtr_5b_get().  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_3b_get
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|dma_addr_t
name|dma_pointers
index|[]
parameter_list|,
name|int
name|sizes
index|[]
parameter_list|)
block|{
name|xge_hal_ring_rxd_3_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_3_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|dma_pointers
index|[
literal|0
index|]
operator|=
name|rxdp
operator|->
name|buffer0_ptr
expr_stmt|;
name|sizes
index|[
literal|0
index|]
operator|=
name|XGE_HAL_RXD_3_GET_BUFFER0_SIZE
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
name|dma_pointers
index|[
literal|1
index|]
operator|=
name|rxdp
operator|->
name|buffer1_ptr
expr_stmt|;
name|sizes
index|[
literal|1
index|]
operator|=
name|XGE_HAL_RXD_3_GET_BUFFER1_SIZE
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
name|dma_pointers
index|[
literal|2
index|]
operator|=
name|rxdp
operator|->
name|buffer2_ptr
expr_stmt|;
name|sizes
index|[
literal|2
index|]
operator|=
name|XGE_HAL_RXD_3_GET_BUFFER2_SIZE
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|poll_bytes
operator|+=
name|sizes
index|[
literal|0
index|]
operator|+
name|sizes
index|[
literal|1
index|]
operator|+
name|sizes
index|[
literal|2
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_5b_set - Prepare 5-buffer-mode descriptor.  * @dtrh: Descriptor handle.  * @dma_pointers: Array of DMA addresses. Contains exactly 5 receive buffers  *               _this_ descriptor should carry.  *               Note that by the time xge_hal_ring_dtr_5b_set  *               is called, the receive buffers should be mapped  *               to the corresponding Xframe device.  * @sizes: Array of receive buffer sizes. Contains 5 sizes: one size per  *         buffer from @dma_pointers.  *  * Prepare 3-buffer-mode Rx descriptor for posting (via  * xge_hal_ring_dtr_post()).  * This inline helper-function does not return any parameters and always  * succeeds.  *  * See also: xge_hal_ring_dtr_1b_set(), xge_hal_ring_dtr_3b_set().  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_5b_set
parameter_list|(
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|dma_addr_t
name|dma_pointers
index|[]
parameter_list|,
name|int
name|sizes
index|[]
parameter_list|)
block|{
name|xge_hal_ring_rxd_5_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_5_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|rxdp
operator|->
name|buffer0_ptr
operator|=
name|dma_pointers
index|[
literal|0
index|]
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator|&=
operator|(
operator|~
name|XGE_HAL_RXD_5_MASK_BUFFER0_SIZE
operator|)
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator||=
name|XGE_HAL_RXD_5_SET_BUFFER0_SIZE
argument_list|(
name|sizes
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|rxdp
operator|->
name|buffer1_ptr
operator|=
name|dma_pointers
index|[
literal|1
index|]
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator|&=
operator|(
operator|~
name|XGE_HAL_RXD_5_MASK_BUFFER1_SIZE
operator|)
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator||=
name|XGE_HAL_RXD_5_SET_BUFFER1_SIZE
argument_list|(
name|sizes
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|rxdp
operator|->
name|buffer2_ptr
operator|=
name|dma_pointers
index|[
literal|2
index|]
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator|&=
operator|(
operator|~
name|XGE_HAL_RXD_5_MASK_BUFFER2_SIZE
operator|)
expr_stmt|;
name|rxdp
operator|->
name|control_2
operator||=
name|XGE_HAL_RXD_5_SET_BUFFER2_SIZE
argument_list|(
name|sizes
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|rxdp
operator|->
name|buffer3_ptr
operator|=
name|dma_pointers
index|[
literal|3
index|]
expr_stmt|;
name|rxdp
operator|->
name|control_3
operator|&=
operator|(
operator|~
name|XGE_HAL_RXD_5_MASK_BUFFER3_SIZE
operator|)
expr_stmt|;
name|rxdp
operator|->
name|control_3
operator||=
name|XGE_HAL_RXD_5_SET_BUFFER3_SIZE
argument_list|(
name|sizes
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|rxdp
operator|->
name|buffer4_ptr
operator|=
name|dma_pointers
index|[
literal|4
index|]
expr_stmt|;
name|rxdp
operator|->
name|control_3
operator|&=
operator|(
operator|~
name|XGE_HAL_RXD_5_MASK_BUFFER4_SIZE
operator|)
expr_stmt|;
name|rxdp
operator|->
name|control_3
operator||=
name|XGE_HAL_RXD_5_SET_BUFFER4_SIZE
argument_list|(
name|sizes
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_5b_get - Get data from the completed 5-buf  * descriptor.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  * @dma_pointers: DMA addresses of the 5 receive buffers _this_ descriptor  *                carries. The first 4 buffers contains L2 (ethernet) through  *                L5 headers. The 5th buffer contain received (applicaion)  *                data. Returned by HAL.  * @sizes: Array of receive buffer sizes. Contains 5 sizes: one size per  * buffer from @dma_pointers. Returned by HAL.  *  * Retrieve protocol data from the completed 5-buffer-mode Rx descriptor.  * This inline helper-function uses completed descriptor to populate receive  * buffer pointer and other "out" parameters. The function always succeeds.  *  * See also: xge_hal_ring_dtr_3b_get(), xge_hal_ring_dtr_5b_get().  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_5b_get
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|,
name|dma_addr_t
name|dma_pointers
index|[]
parameter_list|,
name|int
name|sizes
index|[]
parameter_list|)
block|{
name|xge_hal_ring_rxd_5_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_5_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|dma_pointers
index|[
literal|0
index|]
operator|=
name|rxdp
operator|->
name|buffer0_ptr
expr_stmt|;
name|sizes
index|[
literal|0
index|]
operator|=
name|XGE_HAL_RXD_5_GET_BUFFER0_SIZE
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
name|dma_pointers
index|[
literal|1
index|]
operator|=
name|rxdp
operator|->
name|buffer1_ptr
expr_stmt|;
name|sizes
index|[
literal|1
index|]
operator|=
name|XGE_HAL_RXD_5_GET_BUFFER1_SIZE
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
name|dma_pointers
index|[
literal|2
index|]
operator|=
name|rxdp
operator|->
name|buffer2_ptr
expr_stmt|;
name|sizes
index|[
literal|2
index|]
operator|=
name|XGE_HAL_RXD_5_GET_BUFFER2_SIZE
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
name|dma_pointers
index|[
literal|3
index|]
operator|=
name|rxdp
operator|->
name|buffer3_ptr
expr_stmt|;
name|sizes
index|[
literal|3
index|]
operator|=
name|XGE_HAL_RXD_5_GET_BUFFER3_SIZE
argument_list|(
name|rxdp
operator|->
name|control_3
argument_list|)
expr_stmt|;
name|dma_pointers
index|[
literal|4
index|]
operator|=
name|rxdp
operator|->
name|buffer4_ptr
expr_stmt|;
name|sizes
index|[
literal|4
index|]
operator|=
name|XGE_HAL_RXD_5_GET_BUFFER4_SIZE
argument_list|(
name|rxdp
operator|->
name|control_3
argument_list|)
expr_stmt|;
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|poll_bytes
operator|+=
name|sizes
index|[
literal|0
index|]
operator|+
name|sizes
index|[
literal|1
index|]
operator|+
name|sizes
index|[
literal|2
index|]
operator|+
name|sizes
index|[
literal|3
index|]
operator|+
name|sizes
index|[
literal|4
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_pre_post - FIXME.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  *  * TBD  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_pre_post
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
name|xge_hal_ring_rxd_priv_t
modifier|*
name|priv
decl_stmt|;
name|xge_hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
decl_stmt|;
endif|#
directive|endif
name|rxdp
operator|->
name|control_2
operator||=
name|XGE_HAL_RXD_NOT_COMPLETED
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
comment|/* make sure Xena overwrites the (illegal) t_code on completion */
name|XGE_HAL_RXD_SET_T_CODE
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|,
name|XGE_HAL_RXD_T_CODE_UNUSED_C
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"xge_hal_ring_dtr_pre_post: rxd 0x"
name|XGE_OS_LLXFMT
literal|" posted %d  post_qid %d"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|(
name|ulong_t
operator|)
name|dtrh
argument_list|,
operator|(
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|channel
operator|.
name|post_index
argument_list|,
operator|(
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|channel
operator|.
name|post_qid
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST
argument_list|)
name|xge_os_spin_lock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|xge_os_spin_lock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|XGE_DEBUG_ASSERT
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_RING_ENFORCE_ORDER
argument_list|)
block|{
name|xge_hal_channel_t
modifier|*
name|channel
init|=
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
decl_stmt|;
if|if
condition|(
name|channel
operator|->
name|post_index
operator|!=
literal|0
condition|)
block|{
name|xge_hal_dtr_h
name|prev_dtrh
decl_stmt|;
name|xge_hal_ring_rxd_priv_t
modifier|*
name|rxdp_priv
decl_stmt|;
name|rxdp_priv
operator|=
name|__hal_ring_rxd_priv
argument_list|(
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channel
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
name|prev_dtrh
operator|=
name|channel
operator|->
name|work_arr
index|[
name|channel
operator|->
name|post_index
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|prev_dtrh
operator|!=
name|NULL
operator|&&
operator|(
name|rxdp_priv
operator|->
name|dma_offset
operator|&
operator|(
operator|~
literal|0xFFF
operator|)
operator|)
operator|!=
name|rxdp_priv
operator|->
name|dma_offset
condition|)
block|{
name|xge_assert
argument_list|(
operator|(
name|char
operator|*
operator|)
name|prev_dtrh
operator|+
operator|(
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channel
operator|)
operator|->
name|rxd_size
operator|==
name|dtrh
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
name|__hal_channel_dtr_post
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST
argument_list|)
name|xge_os_spin_unlock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_post_post - FIXME.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  *   * TBD  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_post_post
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|xge_hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
name|xge_hal_ring_rxd_priv_t
modifier|*
name|priv
decl_stmt|;
endif|#
directive|endif
comment|/* do POST */
name|rxdp
operator|->
name|control_1
operator||=
name|XGE_HAL_RXD_POSTED_4_XFRAME
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
name|priv
operator|=
name|__hal_ring_rxd_priv
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
name|xge_os_dma_sync
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|priv
operator|->
name|dma_handle
argument_list|,
name|priv
operator|->
name|dma_addr
argument_list|,
name|priv
operator|->
name|dma_offset
argument_list|,
name|ring
operator|->
name|rxd_size
argument_list|,
name|XGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"xge_hal_ring_dtr_post_post: rxdp %p control_1 %p"
argument_list|,
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
argument_list|,
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|channel
operator|.
name|usage_cnt
operator|>
literal|0
condition|)
name|ring
operator|->
name|channel
operator|.
name|usage_cnt
operator|--
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_post_post_wmb.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  *   * Similar as xge_hal_ring_dtr_post_post, but in addition it does memory barrier.  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_post_post_wmb
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
decl_stmt|;
name|xge_hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
name|xge_hal_ring_rxd_priv_t
modifier|*
name|priv
decl_stmt|;
endif|#
directive|endif
comment|/* Do memory barrier before changing the ownership */
name|xge_os_wmb
argument_list|()
expr_stmt|;
comment|/* do POST */
name|rxdp
operator|->
name|control_1
operator||=
name|XGE_HAL_RXD_POSTED_4_XFRAME
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
name|priv
operator|=
name|__hal_ring_rxd_priv
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
name|xge_os_dma_sync
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|priv
operator|->
name|dma_handle
argument_list|,
name|priv
operator|->
name|dma_addr
argument_list|,
name|priv
operator|->
name|dma_offset
argument_list|,
name|ring
operator|->
name|rxd_size
argument_list|,
name|XGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ring
operator|->
name|channel
operator|.
name|usage_cnt
operator|>
literal|0
condition|)
name|ring
operator|->
name|channel
operator|.
name|usage_cnt
operator|--
expr_stmt|;
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"xge_hal_ring_dtr_post_post_wmb: rxdp %p control_1 %p rxds_with_host %d"
argument_list|,
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
argument_list|,
name|rxdp
operator|->
name|control_1
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|usage_cnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_post - Post descriptor on the ring channel.  * @channelh: Channel handle.  * @dtrh: Descriptor obtained via xge_hal_ring_dtr_reserve().  *  * Post descriptor on the 'ring' type channel.  * Prior to posting the descriptor should be filled in accordance with  * Host/Xframe interface specification for a given service (LL, etc.).  *  * See also: xge_hal_fifo_dtr_post_many(), xge_hal_fifo_dtr_post().  * Usage: See ex_post_all_rx{}.  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_post
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
name|xge_hal_ring_dtr_pre_post
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
name|xge_hal_ring_dtr_post_post
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_next_completed - Get the _next_ completed  * descriptor.  * @channelh: Channel handle.  * @dtrh: Descriptor handle. Returned by HAL.  * @t_code: Transfer code, as per Xframe User Guide,  *          Receive Descriptor Format. Returned by HAL.  *  * Retrieve the _next_ completed descriptor.  * HAL uses channel callback (*xge_hal_channel_callback_f) to notifiy  * upper-layer driver (ULD) of new completed descriptors. After that  * the ULD can use xge_hal_ring_dtr_next_completed to retrieve the rest  * completions (the very first completion is passed by HAL via  * xge_hal_channel_callback_f).  *  * Implementation-wise, the upper-layer driver is free to call  * xge_hal_ring_dtr_next_completed either immediately from inside the  * channel callback, or in a deferred fashion and separate (from HAL)  * context.  *  * Non-zero @t_code means failure to fill-in receive buffer(s)  * of the descriptor.  * For instance, parity error detected during the data transfer.  * In this case Xframe will complete the descriptor and indicate  * for the host that the received data is not to be used.  * For details please refer to Xframe User Guide.  *  * Returns: XGE_HAL_OK - success.  * XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS - No completed descriptors  * are currently available for processing.  *  * See also: xge_hal_channel_callback_f{},  * xge_hal_fifo_dtr_next_completed(), xge_hal_status_e{}.  * Usage: See ex_rx_compl{}.  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|xge_hal_status_e
name|xge_hal_ring_dtr_next_completed
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
modifier|*
name|dtrh
parameter_list|,
name|u8
modifier|*
name|t_code
parameter_list|)
block|{
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
decl_stmt|;
comment|/* doesn't matter 1, 3 or 5... */
name|xge_hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
name|xge_hal_ring_rxd_priv_t
modifier|*
name|priv
decl_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_try_complete
argument_list|(
name|ring
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
name|rxdp
operator|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
operator|*
name|dtrh
expr_stmt|;
if|if
condition|(
name|rxdp
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
return|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_DTR_STREAMING
argument_list|)
comment|/* Note: 24 bytes at most means: 	 *  - Control_3 in case of 5-buffer mode 	 *  - Control_1 and Control_2 	 * 	 * This is the only length needs to be invalidated 	 * type of channels.*/
name|priv
operator|=
name|__hal_ring_rxd_priv
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
name|xge_os_dma_sync
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|priv
operator|->
name|dma_handle
argument_list|,
name|priv
operator|->
name|dma_addr
argument_list|,
name|priv
operator|->
name|dma_offset
argument_list|,
literal|24
argument_list|,
name|XGE_OS_DMA_DIR_FROMDEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* check whether it is not the end */
if|if
condition|(
operator|!
operator|(
name|rxdp
operator|->
name|control_2
operator|&
name|XGE_HAL_RXD_NOT_COMPLETED
operator|)
operator|&&
operator|!
operator|(
name|rxdp
operator|->
name|control_1
operator|&
name|XGE_HAL_RXD_POSTED_4_XFRAME
operator|)
condition|)
block|{
ifndef|#
directive|ifndef
name|XGE_HAL_IRQ_POLLING
if|if
condition|(
operator|++
name|ring
operator|->
name|cmpl_cnt
operator|>
name|ring
operator|->
name|indicate_max_pkts
condition|)
block|{
comment|/* reset it. since we don't want to return 	         * garbage to the ULD */
operator|*
name|dtrh
operator|=
literal|0
expr_stmt|;
return|return
name|XGE_HAL_COMPLETIONS_REMAIN
return|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_USE_5B_MODE
argument_list|)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|XGE_OS_PLATFORM_64BIT
argument_list|)
if|if
condition|(
name|ring
operator|->
name|buffer_mode
operator|==
name|XGE_HAL_RING_QUEUE_BUFFER_MODE_5
condition|)
block|{
name|xge_assert
argument_list|(
operator|(
operator|(
name|xge_hal_ring_rxd_5_t
operator|*
operator|)
name|rxdp
operator|)
operator|->
name|host_control
operator|!=
literal|0
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|#
directive|else
name|xge_assert
argument_list|(
name|rxdp
operator|->
name|host_control
operator|!=
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|__hal_channel_dtr_complete
argument_list|(
name|ring
argument_list|)
expr_stmt|;
operator|*
name|t_code
operator|=
operator|(
name|u8
operator|)
name|XGE_HAL_RXD_GET_T_CODE
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
comment|/* see XGE_HAL_SET_RXD_T_CODE() above.. */
name|xge_assert
argument_list|(
operator|*
name|t_code
operator|!=
name|XGE_HAL_RXD_T_CODE_UNUSED_C
argument_list|)
expr_stmt|;
name|xge_debug_ring
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"compl_index %d post_qid %d t_code %d rxd 0x"
name|XGE_OS_LLXFMT
argument_list|,
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|ring
operator|)
operator|->
name|compl_index
argument_list|,
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|ring
operator|)
operator|->
name|post_qid
argument_list|,
operator|*
name|t_code
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|(
name|ulong_t
operator|)
name|rxdp
argument_list|)
expr_stmt|;
name|ring
operator|->
name|channel
operator|.
name|usage_cnt
operator|++
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|channel
operator|.
name|stats
operator|.
name|usage_max
operator|<
name|ring
operator|->
name|channel
operator|.
name|usage_cnt
condition|)
name|ring
operator|->
name|channel
operator|.
name|stats
operator|.
name|usage_max
operator|=
name|ring
operator|->
name|channel
operator|.
name|usage_cnt
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
comment|/* reset it. since we don't want to return 	 * garbage to the ULD */
operator|*
name|dtrh
operator|=
literal|0
expr_stmt|;
return|return
name|XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_dtr_free - Free descriptor.  * @channelh: Channel handle.  * @dtrh: Descriptor handle.  *  * Free the reserved descriptor. This operation is "symmetrical" to  * xge_hal_ring_dtr_reserve. The "free-ing" completes the descriptor's  * lifecycle.  *  * After free-ing (see xge_hal_ring_dtr_free()) the descriptor again can  * be:  *  * - reserved (xge_hal_ring_dtr_reserve);  *  * - posted (xge_hal_ring_dtr_post);  *  * - completed (xge_hal_ring_dtr_next_completed);  *  * - and recycled again (xge_hal_ring_dtr_free).  *  * For alternative state transitions and more details please refer to  * the design doc.  *  * See also: xge_hal_ring_dtr_reserve(), xge_hal_fifo_dtr_free().  * Usage: See ex_rx_compl{}.  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|void
name|xge_hal_ring_dtr_free
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_dtr_h
name|dtrh
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_FREE_IRQ
argument_list|)
name|unsigned
name|long
name|flags
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_FREE
argument_list|)
name|xge_os_spin_lock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|free_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_FREE_IRQ
argument_list|)
name|xge_os_spin_lock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|free_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_free
argument_list|(
name|channelh
argument_list|,
name|dtrh
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_MEMORY_CHECK
argument_list|)
name|__hal_ring_rxd_priv
argument_list|(
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
argument_list|,
name|dtrh
argument_list|)
operator|->
name|allocated
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_FREE
argument_list|)
name|xge_os_spin_unlock
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|free_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|XGE_HAL_RX_MULTI_FREE_IRQ
argument_list|)
name|xge_os_spin_unlock_irq
argument_list|(
operator|&
operator|(
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
operator|)
operator|->
name|free_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**  * xge_hal_ring_is_next_dtr_completed - Check if the next dtr is completed  * @channelh: Channel handle.  *  * Checks if the the _next_ completed descriptor is in host memory  *  * Returns: XGE_HAL_OK - success.  * XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS - No completed descriptors  * are currently available for processing.  */
end_comment

begin_function
name|__HAL_STATIC_RING
name|__HAL_INLINE_RING
name|xge_hal_status_e
name|xge_hal_ring_is_next_dtr_completed
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|)
block|{
name|xge_hal_ring_rxd_1_t
modifier|*
name|rxdp
decl_stmt|;
comment|/* doesn't matter 1, 3 or 5... */
name|xge_hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|xge_hal_ring_t
operator|*
operator|)
name|channelh
decl_stmt|;
name|xge_hal_dtr_h
name|dtrh
decl_stmt|;
name|__hal_channel_dtr_try_complete
argument_list|(
name|ring
argument_list|,
operator|&
name|dtrh
argument_list|)
expr_stmt|;
name|rxdp
operator|=
operator|(
name|xge_hal_ring_rxd_1_t
operator|*
operator|)
name|dtrh
expr_stmt|;
if|if
condition|(
name|rxdp
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
return|;
block|}
comment|/* check whether it is not the end */
if|if
condition|(
operator|!
operator|(
name|rxdp
operator|->
name|control_2
operator|&
name|XGE_HAL_RXD_NOT_COMPLETED
operator|)
operator|&&
operator|!
operator|(
name|rxdp
operator|->
name|control_1
operator|&
name|XGE_HAL_RXD_POSTED_4_XFRAME
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|XGE_DEBUG_ASSERT
if|#
directive|if
name|defined
argument_list|(
name|XGE_HAL_USE_5B_MODE
argument_list|)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|XGE_OS_PLATFORM_64BIT
argument_list|)
if|if
condition|(
name|ring
operator|->
name|buffer_mode
operator|==
name|XGE_HAL_RING_QUEUE_BUFFER_MODE_5
condition|)
block|{
name|xge_assert
argument_list|(
operator|(
operator|(
name|xge_hal_ring_rxd_5_t
operator|*
operator|)
name|rxdp
operator|)
operator|->
name|host_control
operator|!=
literal|0
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|#
directive|else
name|xge_assert
argument_list|(
name|rxdp
operator|->
name|host_control
operator|!=
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
return|return
name|XGE_HAL_OK
return|;
block|}
return|return
name|XGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2007 Neterion, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  *  FileName :    xgehal-driver.c  *  *  Description:  HAL driver object functionality  *  *  Created:      10 May 2004  */
end_comment

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-driver.h>
end_include

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-device.h>
end_include

begin_decl_stmt
specifier|static
name|xge_hal_driver_t
name|g_driver
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|xge_hal_driver_t
modifier|*
name|g_xge_hal_driver
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|g_xge_hal_log
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|XGE_OS_MEMORY_CHECK
end_ifdef

begin_decl_stmt
name|xge_os_malloc_t
name|g_malloc_arr
index|[
name|XGE_OS_MALLOC_CNT_MAX
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|g_malloc_cnt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Runtime tracing support  */
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|long
name|g_module_mask_default
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
modifier|*
name|g_module_mask
init|=
operator|&
name|g_module_mask_default
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|g_level_default
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|g_level
init|=
operator|&
name|g_level_default
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|XGE_TRACE_INTO_CIRCULAR_ARR
end_ifdef

begin_decl_stmt
specifier|static
name|xge_os_tracebuf_t
name|g_tracebuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|dmesg
decl_stmt|,
modifier|*
name|dmesg_start
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * xge_hal_driver_tracebuf_dump - Dump the trace buffer.  *  * Dump the trace buffer contents.  */
end_comment

begin_function
name|void
name|xge_hal_driver_tracebuf_dump
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|off
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|g_xge_os_tracebuf
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|xge_os_printf
argument_list|(
literal|"################ Trace dump Begin ###############"
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_xge_os_tracebuf
operator|->
name|wrapped_once
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|g_xge_os_tracebuf
operator|->
name|size
operator|-
name|g_xge_os_tracebuf
operator|->
name|offset
condition|;
name|i
operator|+=
name|off
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|dmesg_start
operator|+
name|i
operator|)
condition|)
name|xge_os_printf
argument_list|(
name|dmesg_start
operator|+
name|i
argument_list|)
expr_stmt|;
name|off
operator|=
name|xge_os_strlen
argument_list|(
name|dmesg_start
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|g_xge_os_tracebuf
operator|->
name|offset
condition|;
name|i
operator|+=
name|off
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|dmesg
operator|+
name|i
operator|)
condition|)
name|xge_os_printf
argument_list|(
name|dmesg
operator|+
name|i
argument_list|)
expr_stmt|;
name|off
operator|=
name|xge_os_strlen
argument_list|(
name|dmesg
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
name|xge_os_printf
argument_list|(
literal|"################ Trace dump End ###############"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|xge_hal_status_e
name|xge_hal_driver_tracebuf_read
parameter_list|(
name|int
name|bufsize
parameter_list|,
name|char
modifier|*
name|retbuf
parameter_list|,
name|int
modifier|*
name|retsize
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|off
init|=
literal|0
decl_stmt|,
name|retbuf_off
init|=
literal|0
decl_stmt|;
operator|*
name|retsize
operator|=
literal|0
expr_stmt|;
operator|*
name|retbuf
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|g_xge_os_tracebuf
operator|==
name|NULL
condition|)
block|{
return|return
name|XGE_HAL_FAIL
return|;
block|}
if|if
condition|(
name|g_xge_os_tracebuf
operator|->
name|wrapped_once
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|g_xge_os_tracebuf
operator|->
name|size
operator|-
name|g_xge_os_tracebuf
operator|->
name|offset
condition|;
name|i
operator|+=
name|off
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|dmesg_start
operator|+
name|i
operator|)
condition|)
block|{
name|xge_os_sprintf
argument_list|(
name|retbuf
operator|+
name|retbuf_off
argument_list|,
literal|"%s\n"
argument_list|,
name|dmesg_start
operator|+
name|i
argument_list|)
expr_stmt|;
name|retbuf_off
operator|+=
name|xge_os_strlen
argument_list|(
name|dmesg_start
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|retbuf_off
operator|>
name|bufsize
condition|)
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|off
operator|=
name|xge_os_strlen
argument_list|(
name|dmesg_start
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|g_xge_os_tracebuf
operator|->
name|offset
condition|;
name|i
operator|+=
name|off
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|dmesg
operator|+
name|i
operator|)
condition|)
block|{
name|xge_os_sprintf
argument_list|(
name|retbuf
operator|+
name|retbuf_off
argument_list|,
literal|"%s\n"
argument_list|,
name|dmesg
operator|+
name|i
argument_list|)
expr_stmt|;
name|retbuf_off
operator|+=
name|xge_os_strlen
argument_list|(
name|dmesg
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|retbuf_off
operator|>
name|bufsize
condition|)
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|off
operator|=
name|xge_os_strlen
argument_list|(
name|dmesg
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
operator|*
name|retsize
operator|=
name|retbuf_off
expr_stmt|;
operator|*
operator|(
name|retbuf
operator|+
name|retbuf_off
operator|+
literal|1
operator|)
operator|=
literal|0
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|xge_os_tracebuf_t
modifier|*
name|g_xge_os_tracebuf
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|XGE_HAL_DEBUG_BAR0_OFFSET
end_ifdef

begin_function
name|void
name|xge_hal_driver_bar0_offset_check
parameter_list|(
name|void
parameter_list|)
block|{
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|adapter_status
argument_list|)
operator|==
literal|0x108
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|tx_traffic_int
argument_list|)
operator|==
literal|0x08E0
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|dtx_control
argument_list|)
operator|==
literal|0x09E8
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|tx_fifo_partition_0
argument_list|)
operator|==
literal|0x1108
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|pcc_enable
argument_list|)
operator|==
literal|0x1170
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|prc_rxd0_n
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0x1930
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|rti_command_mem
argument_list|)
operator|==
literal|0x19B8
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|mac_cfg
argument_list|)
operator|==
literal|0x2100
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|rmac_addr_cmd_mem
argument_list|)
operator|==
literal|0x2128
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|mac_link_util
argument_list|)
operator|==
literal|0x2170
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|mc_pause_thresh_q0q3
argument_list|)
operator|==
literal|0x2918
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|pcc_err_reg
argument_list|)
operator|==
literal|0x1040
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|rxdma_int_status
argument_list|)
operator|==
literal|0x1800
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|mac_tmac_err_reg
argument_list|)
operator|==
literal|0x2010
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|mc_err_reg
argument_list|)
operator|==
literal|0x2810
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|xge_offsetof
argument_list|(
name|xge_hal_pci_bar0_t
argument_list|,
name|xgxs_int_status
argument_list|)
operator|==
literal|0x3000
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * xge_hal_driver_initialize - Initialize HAL.  * @config: HAL configuration, see xge_hal_driver_config_t{}.  * @uld_callbacks: Upper-layer driver callbacks, e.g. link-up.  *  * HAL initialization entry point. Not to confuse with device initialization  * (note that HAL "contains" zero or more Xframe devices).  *  * Returns: XGE_HAL_OK - success;  * XGE_HAL_ERR_BAD_DRIVER_CONFIG - Driver configuration params invalid.  *  * See also: xge_hal_device_initialize(), xge_hal_status_e{},  * xge_hal_uld_cbs_t{}.  */
end_comment

begin_function
name|xge_hal_status_e
name|xge_hal_driver_initialize
parameter_list|(
name|xge_hal_driver_config_t
modifier|*
name|config
parameter_list|,
name|xge_hal_uld_cbs_t
modifier|*
name|uld_callbacks
parameter_list|)
block|{
name|xge_hal_status_e
name|status
decl_stmt|;
name|g_xge_hal_driver
operator|=
operator|&
name|g_driver
expr_stmt|;
name|xge_hal_driver_debug_module_mask_set
argument_list|(
name|XGE_DEBUG_MODULE_MASK_DEF
argument_list|)
expr_stmt|;
name|xge_hal_driver_debug_level_set
argument_list|(
name|XGE_DEBUG_LEVEL_DEF
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_HAL_DEBUG_BAR0_OFFSET
name|xge_hal_driver_bar0_offset_check
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|XGE_TRACE_INTO_CIRCULAR_ARR
if|if
condition|(
name|config
operator|->
name|tracebuf_size
operator|==
literal|0
condition|)
comment|/* 		 * Trace buffer implementation is not lock protected. 		 * The only harm to expect is memcpy() to go beyond of 		 * allowed boundaries. To make it safe (driver-wise), 		 * we pre-allocate needed number of extra bytes. 		 */
name|config
operator|->
name|tracebuf_size
operator|=
name|XGE_HAL_DEF_CIRCULAR_ARR
operator|+
name|XGE_OS_TRACE_MSGBUF_MAX
expr_stmt|;
endif|#
directive|endif
name|status
operator|=
name|__hal_driver_config_check
argument_list|(
name|config
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|XGE_HAL_OK
condition|)
return|return
name|status
return|;
name|xge_os_memzero
argument_list|(
name|g_xge_hal_driver
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_driver_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* apply config */
name|xge_os_memcpy
argument_list|(
operator|&
name|g_xge_hal_driver
operator|->
name|config
argument_list|,
name|config
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_driver_config_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* apply ULD callbacks */
name|xge_os_memcpy
argument_list|(
operator|&
name|g_xge_hal_driver
operator|->
name|uld_callbacks
argument_list|,
name|uld_callbacks
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_uld_cbs_t
argument_list|)
argument_list|)
expr_stmt|;
name|g_xge_hal_driver
operator|->
name|is_initialized
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_TRACE_INTO_CIRCULAR_ARR
name|g_tracebuf
operator|.
name|size
operator|=
name|config
operator|->
name|tracebuf_size
expr_stmt|;
name|g_tracebuf
operator|.
name|data
operator|=
operator|(
name|char
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|NULL
argument_list|,
name|g_tracebuf
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_tracebuf
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|xge_os_printf
argument_list|(
literal|"cannot allocate trace buffer!"
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
comment|/* timestamps disabled by default */
name|g_tracebuf
operator|.
name|timestamp
operator|=
name|config
operator|->
name|tracebuf_timestamp_en
expr_stmt|;
if|if
condition|(
name|g_tracebuf
operator|.
name|timestamp
condition|)
block|{
name|xge_os_timestamp
argument_list|(
name|g_tracebuf
operator|.
name|msg
argument_list|)
expr_stmt|;
name|g_tracebuf
operator|.
name|msgbuf_max
operator|=
name|XGE_OS_TRACE_MSGBUF_MAX
operator|-
name|xge_os_strlen
argument_list|(
name|g_tracebuf
operator|.
name|msg
argument_list|)
expr_stmt|;
block|}
else|else
name|g_tracebuf
operator|.
name|msgbuf_max
operator|=
name|XGE_OS_TRACE_MSGBUF_MAX
expr_stmt|;
name|g_tracebuf
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
operator|*
name|g_tracebuf
operator|.
name|msg
operator|=
literal|0
expr_stmt|;
name|xge_os_memzero
argument_list|(
name|g_tracebuf
operator|.
name|data
argument_list|,
name|g_tracebuf
operator|.
name|size
argument_list|)
expr_stmt|;
name|g_xge_os_tracebuf
operator|=
operator|&
name|g_tracebuf
expr_stmt|;
name|dmesg
operator|=
name|g_tracebuf
operator|.
name|data
expr_stmt|;
operator|*
name|dmesg
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_driver_terminate - Terminate HAL.  *  * HAL termination entry point.  *  * See also: xge_hal_device_terminate().  */
end_comment

begin_function
name|void
name|xge_hal_driver_terminate
parameter_list|(
name|void
parameter_list|)
block|{
name|g_xge_hal_driver
operator|->
name|is_initialized
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_TRACE_INTO_CIRCULAR_ARR
if|if
condition|(
name|g_tracebuf
operator|.
name|size
condition|)
block|{
name|xge_os_free
argument_list|(
name|NULL
argument_list|,
name|g_tracebuf
operator|.
name|data
argument_list|,
name|g_tracebuf
operator|.
name|size
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|g_xge_hal_driver
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_OS_MEMORY_CHECK
block|{
name|int
name|i
decl_stmt|,
name|leaks
init|=
literal|0
decl_stmt|;
name|xge_os_printf
argument_list|(
literal|"OSPAL: max g_malloc_cnt %d"
argument_list|,
name|g_malloc_cnt
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|g_malloc_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|g_malloc_arr
index|[
name|i
index|]
operator|.
name|ptr
operator|!=
name|NULL
condition|)
block|{
name|xge_os_printf
argument_list|(
literal|"OSPAL: memory leak detected at "
literal|"%s:%d:"
name|XGE_OS_LLXFMT
literal|":%d"
argument_list|,
name|g_malloc_arr
index|[
name|i
index|]
operator|.
name|file
argument_list|,
name|g_malloc_arr
index|[
name|i
index|]
operator|.
name|line
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|(
name|ulong_t
operator|)
name|g_malloc_arr
index|[
name|i
index|]
operator|.
name|ptr
argument_list|,
name|g_malloc_arr
index|[
name|i
index|]
operator|.
name|size
argument_list|)
expr_stmt|;
name|leaks
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|leaks
condition|)
block|{
name|xge_os_printf
argument_list|(
literal|"OSPAL: %d memory leaks detected"
argument_list|,
name|leaks
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xge_os_printf
argument_list|(
literal|"OSPAL: no memory leaks detected"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
end_function

end_unit


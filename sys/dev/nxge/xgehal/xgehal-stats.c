begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2007 Neterion, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  *  FileName :    xgehal-stats.c  *  *  Description:  statistics object implementation  *  *  Created:      2 June 2004  */
end_comment

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-stats.h>
end_include

begin_include
include|#
directive|include
file|<dev/nxge/include/xgehal-device.h>
end_include

begin_comment
comment|/*  * __hal_stats_initialize  * @stats: xge_hal_stats_t structure that contains, in particular,  *         Xframe hw stat counters.  * @devh: HAL device handle.  *  * Initialize per-device statistics object.  * See also: xge_hal_stats_getinfo(), xge_hal_status_e{}.  */
end_comment

begin_function
name|xge_hal_status_e
name|__hal_stats_initialize
parameter_list|(
name|xge_hal_stats_t
modifier|*
name|stats
parameter_list|,
name|xge_hal_device_h
name|devh
parameter_list|)
block|{
name|int
name|dma_flags
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|xge_assert
argument_list|(
operator|!
name|stats
operator|->
name|is_initialized
argument_list|)
expr_stmt|;
name|dma_flags
operator|=
name|XGE_OS_DMA_CACHELINE_ALIGNED
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_HAL_DMA_STATS_CONSISTENT
name|dma_flags
operator||=
name|XGE_OS_DMA_CONSISTENT
expr_stmt|;
else|#
directive|else
name|dma_flags
operator||=
name|XGE_OS_DMA_STREAMING
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|!=
name|XGE_HAL_CARD_TITAN
condition|)
block|{
name|stats
operator|->
name|hw_info
operator|=
operator|(
name|xge_hal_stats_hw_info_t
operator|*
operator|)
name|xge_os_dma_malloc
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|,
name|dma_flags
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dmah
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dma_acch
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
operator|->
name|hw_info
operator|==
name|NULL
condition|)
block|{
name|xge_debug_stats
argument_list|(
name|XGE_ERR
argument_list|,
literal|"%s"
argument_list|,
literal|"can not DMA alloc"
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|xge_os_memzero
argument_list|(
name|stats
operator|->
name|hw_info
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_memzero
argument_list|(
operator|&
name|stats
operator|->
name|hw_info_saved
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_memzero
argument_list|(
operator|&
name|stats
operator|->
name|hw_info_latest
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|stats
operator|->
name|dma_addr
operator|=
name|xge_os_dma_map
argument_list|(
argument|hldev->pdev
argument_list|,
argument|stats->hw_info_dmah
argument_list|,
argument|stats->hw_info
argument_list|,
argument|sizeof(xge_hal_stats_hw_info_t)
argument_list|,
argument|XGE_OS_DMA_DIR_FROMDEVICE
argument_list|,
argument|XGE_OS_DMA_CACHELINE_ALIGNED |
ifdef|#
directive|ifdef
name|XGE_HAL_DMA_STATS_CONSISTENT
argument|XGE_OS_DMA_CONSISTENT
else|#
directive|else
argument|XGE_OS_DMA_STREAMING
endif|#
directive|endif
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
operator|->
name|dma_addr
operator|==
name|XGE_OS_INVALID_DMA_ADDR
condition|)
block|{
name|xge_debug_stats
argument_list|(
name|XGE_ERR
argument_list|,
literal|"can not map vaddr 0x"
name|XGE_OS_LLXFMT
literal|" to DMA"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|(
name|ulong_t
operator|)
name|stats
operator|->
name|hw_info
argument_list|)
expr_stmt|;
name|xge_os_dma_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|hw_info
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dma_acch
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dmah
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MAPPING
return|;
block|}
block|}
else|else
block|{
name|stats
operator|->
name|pcim_info_saved
operator|=
operator|(
name|xge_hal_stats_pcim_info_t
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
operator|->
name|pcim_info_saved
operator|==
name|NULL
condition|)
block|{
name|xge_debug_stats
argument_list|(
name|XGE_ERR
argument_list|,
literal|"%s"
argument_list|,
literal|"can not alloc"
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|stats
operator|->
name|pcim_info_latest
operator|=
operator|(
name|xge_hal_stats_pcim_info_t
operator|*
operator|)
name|xge_os_malloc
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
operator|->
name|pcim_info_latest
operator|==
name|NULL
condition|)
block|{
name|xge_os_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|pcim_info_saved
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_debug_stats
argument_list|(
name|XGE_ERR
argument_list|,
literal|"%s"
argument_list|,
literal|"can not alloc"
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|stats
operator|->
name|pcim_info
operator|=
operator|(
name|xge_hal_stats_pcim_info_t
operator|*
operator|)
name|xge_os_dma_malloc
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|,
name|dma_flags
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dmah
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dma_acch
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
operator|->
name|pcim_info
operator|==
name|NULL
condition|)
block|{
name|xge_os_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|pcim_info_saved
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|pcim_info_latest
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_debug_stats
argument_list|(
name|XGE_ERR
argument_list|,
literal|"%s"
argument_list|,
literal|"can not DMA alloc"
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MEMORY
return|;
block|}
name|xge_os_memzero
argument_list|(
name|stats
operator|->
name|pcim_info
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_memzero
argument_list|(
name|stats
operator|->
name|pcim_info_saved
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_memzero
argument_list|(
name|stats
operator|->
name|pcim_info_latest
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|stats
operator|->
name|dma_addr
operator|=
name|xge_os_dma_map
argument_list|(
argument|hldev->pdev
argument_list|,
argument|stats->hw_info_dmah
argument_list|,
argument|stats->pcim_info
argument_list|,
argument|sizeof(xge_hal_stats_pcim_info_t)
argument_list|,
argument|XGE_OS_DMA_DIR_FROMDEVICE
argument_list|,
argument|XGE_OS_DMA_CACHELINE_ALIGNED |
ifdef|#
directive|ifdef
name|XGE_HAL_DMA_STATS_CONSISTENT
argument|XGE_OS_DMA_CONSISTENT
else|#
directive|else
argument|XGE_OS_DMA_STREAMING
endif|#
directive|endif
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
operator|->
name|dma_addr
operator|==
name|XGE_OS_INVALID_DMA_ADDR
condition|)
block|{
name|xge_debug_stats
argument_list|(
name|XGE_ERR
argument_list|,
literal|"can not map vaddr 0x"
name|XGE_OS_LLXFMT
literal|" to DMA"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|(
name|ulong_t
operator|)
name|stats
operator|->
name|hw_info
argument_list|)
expr_stmt|;
name|xge_os_dma_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|pcim_info
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dma_acch
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dmah
argument_list|)
expr_stmt|;
name|xge_os_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|pcim_info_saved
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|pcim_info_latest
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_ERR_OUT_OF_MAPPING
return|;
block|}
block|}
name|stats
operator|->
name|devh
operator|=
name|devh
expr_stmt|;
name|xge_os_memzero
argument_list|(
operator|&
name|stats
operator|->
name|sw_dev_info_stats
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_device_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|stats
operator|->
name|is_initialized
operator|=
literal|1
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__hal_stats_save
parameter_list|(
name|xge_hal_stats_t
modifier|*
name|stats
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|stats
operator|->
name|devh
decl_stmt|;
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|!=
name|XGE_HAL_CARD_TITAN
condition|)
block|{
name|xge_hal_stats_hw_info_t
modifier|*
name|latest
decl_stmt|;
operator|(
name|void
operator|)
name|xge_hal_stats_hw
argument_list|(
name|stats
operator|->
name|devh
argument_list|,
operator|&
name|latest
argument_list|)
expr_stmt|;
name|xge_os_memcpy
argument_list|(
operator|&
name|stats
operator|->
name|hw_info_saved
argument_list|,
name|stats
operator|->
name|hw_info
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xge_hal_stats_pcim_info_t
modifier|*
name|latest
decl_stmt|;
operator|(
name|void
operator|)
name|xge_hal_stats_pcim
argument_list|(
name|stats
operator|->
name|devh
argument_list|,
operator|&
name|latest
argument_list|)
expr_stmt|;
name|xge_os_memcpy
argument_list|(
name|stats
operator|->
name|pcim_info_saved
argument_list|,
name|stats
operator|->
name|pcim_info
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * __hal_stats_disable  * @stats: xge_hal_stats_t structure that contains, in particular,  *         Xframe hw stat counters.  *  * Ask device to stop collecting stats.  * See also: xge_hal_stats_getinfo().  */
end_comment

begin_function
name|void
name|__hal_stats_disable
parameter_list|(
name|xge_hal_stats_t
modifier|*
name|stats
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|xge_hal_pci_bar0_t
modifier|*
name|bar0
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|xge_assert
argument_list|(
name|stats
operator|->
name|hw_info
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|stats
operator|->
name|devh
expr_stmt|;
name|xge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|bar0
operator|=
operator|(
name|xge_hal_pci_bar0_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|hldev
operator|->
name|bar0
expr_stmt|;
name|val64
operator|=
name|xge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
operator|&
name|bar0
operator|->
name|stat_cfg
argument_list|)
expr_stmt|;
name|val64
operator|&=
operator|~
name|XGE_HAL_STAT_CFG_STAT_EN
expr_stmt|;
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|stat_cfg
argument_list|)
expr_stmt|;
comment|/* flush the write */
operator|(
name|void
operator|)
name|xge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
operator|&
name|bar0
operator|->
name|stat_cfg
argument_list|)
expr_stmt|;
name|xge_debug_stats
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"stats disabled at 0x"
name|XGE_OS_LLXFMT
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|stats
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
name|stats
operator|->
name|is_enabled
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_stats_terminate  * @stats: xge_hal_stats_t structure that contains, in particular,  *         Xframe hw stat counters.  * Terminate per-device statistics object.  */
end_comment

begin_function
name|void
name|__hal_stats_terminate
parameter_list|(
name|xge_hal_stats_t
modifier|*
name|stats
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|xge_assert
argument_list|(
name|stats
operator|->
name|hw_info
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|stats
operator|->
name|devh
expr_stmt|;
name|xge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|xge_assert
argument_list|(
name|stats
operator|->
name|is_initialized
argument_list|)
expr_stmt|;
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|!=
name|XGE_HAL_CARD_TITAN
condition|)
block|{
name|xge_os_dma_unmap
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|hw_info_dmah
argument_list|,
name|stats
operator|->
name|dma_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|,
name|XGE_OS_DMA_DIR_FROMDEVICE
argument_list|)
expr_stmt|;
name|xge_os_dma_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|hw_info
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dma_acch
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dmah
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xge_os_dma_unmap
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|hw_info_dmah
argument_list|,
name|stats
operator|->
name|dma_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|,
name|XGE_OS_DMA_DIR_FROMDEVICE
argument_list|)
expr_stmt|;
name|xge_os_dma_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|pcim_info
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dma_acch
argument_list|,
operator|&
name|stats
operator|->
name|hw_info_dmah
argument_list|)
expr_stmt|;
name|xge_os_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|pcim_info_saved
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_free
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|stats
operator|->
name|pcim_info_latest
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|stats
operator|->
name|is_initialized
operator|=
literal|0
expr_stmt|;
name|stats
operator|->
name|is_enabled
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_stats_enable  * @stats: xge_hal_stats_t structure that contains, in particular,  *         Xframe hw stat counters.  *  * Ask device to start collecting stats.  * See also: xge_hal_stats_getinfo().  */
end_comment

begin_function
name|void
name|__hal_stats_enable
parameter_list|(
name|xge_hal_stats_t
modifier|*
name|stats
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|xge_hal_pci_bar0_t
modifier|*
name|bar0
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|unsigned
name|int
name|refresh_time_pci_clocks
decl_stmt|;
name|xge_assert
argument_list|(
name|stats
operator|->
name|hw_info
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|stats
operator|->
name|devh
expr_stmt|;
name|xge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|bar0
operator|=
operator|(
name|xge_hal_pci_bar0_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|hldev
operator|->
name|bar0
expr_stmt|;
comment|/* enable statistics 	 * For Titan stat_addr offset == 0x09d8, and stat_cfg offset == 0x09d0 	*/
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|stats
operator|->
name|dma_addr
argument_list|,
operator|&
name|bar0
operator|->
name|stat_addr
argument_list|)
expr_stmt|;
name|refresh_time_pci_clocks
operator|=
name|XGE_HAL_XENA_PER_SEC
operator|*
name|hldev
operator|->
name|config
operator|.
name|stats_refresh_time_sec
expr_stmt|;
name|refresh_time_pci_clocks
operator|=
name|__hal_fix_time_ival_herc
argument_list|(
name|hldev
argument_list|,
name|refresh_time_pci_clocks
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_HAL_HERC_EMULATION
comment|/* 	 *  The clocks in the emulator are running ~1000 times slower 	 *  than real world, so the stats transfer will occur ~1000 	 *  times less frequent. STAT_CFG.STAT_TRSF_PERIOD should be 	 *  set to 0x20C for Hercules emulation (stats transferred 	 *  every 0.5 sec). 	*/
name|val64
operator|=
operator|(
literal|0x20C
operator||
name|XGE_HAL_STAT_CFG_STAT_RO
operator||
name|XGE_HAL_STAT_CFG_STAT_EN
operator|)
expr_stmt|;
else|#
directive|else
name|val64
operator|=
name|XGE_HAL_SET_UPDT_PERIOD
argument_list|(
name|refresh_time_pci_clocks
argument_list|)
operator||
name|XGE_HAL_STAT_CFG_STAT_RO
operator||
name|XGE_HAL_STAT_CFG_STAT_EN
expr_stmt|;
endif|#
directive|endif
name|xge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|bar0
operator|->
name|stat_cfg
argument_list|)
expr_stmt|;
name|xge_debug_stats
argument_list|(
name|XGE_TRACE
argument_list|,
literal|"stats enabled at 0x"
name|XGE_OS_LLXFMT
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|stats
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
name|stats
operator|->
name|is_enabled
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_stats_pcim_update_latest - Update hw ER stats counters, based on the  * real hardware maintained counters and the stored "reset" values.  */
end_comment

begin_function
specifier|static
name|void
name|__hal_stats_pcim_update_latest
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|int
name|i
decl_stmt|;
define|#
directive|define
name|set_latest_stat_link_cnt
parameter_list|(
name|_link
parameter_list|,
name|_p
parameter_list|)
define|\
value|hldev->stats.pcim_info_latest->link_info[_link]._p =		      \ 	((hldev->stats.pcim_info->link_info[_link]._p>=	              \ 		hldev->stats.pcim_info_saved->link_info[_link]._p) ?	      \ 		hldev->stats.pcim_info->link_info[_link]._p -		      \ 			hldev->stats.pcim_info_saved->link_info[_link]._p :   \ 		((-1) - hldev->stats.pcim_info_saved->link_info[_link]._p) +  \ 			hldev->stats.pcim_info->link_info[_link]._p)
define|#
directive|define
name|set_latest_stat_aggr_cnt
parameter_list|(
name|_aggr
parameter_list|,
name|_p
parameter_list|)
define|\
value|hldev->stats.pcim_info_latest->aggr_info[_aggr]._p =		      \ 	((hldev->stats.pcim_info->aggr_info[_aggr]._p>=		      \ 		hldev->stats.pcim_info_saved->aggr_info[_aggr]._p) ?	      \ 		hldev->stats.pcim_info->aggr_info[_aggr]._p -		      \ 			hldev->stats.pcim_info_saved->aggr_info[_aggr]._p :   \ 		((-1) - hldev->stats.pcim_info_saved->aggr_info[_aggr]._p) +  \ 			hldev->stats.pcim_info->aggr_info[_aggr]._p)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_MAC_LINKS
condition|;
name|i
operator|++
control|)
block|{
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_ttl_eth_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_data_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_mcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_bcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_ucst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_tagged_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_vld_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_vld_ip_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_icmp
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_tcp
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_rst_tcp
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_udp
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_unknown_protocol
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_parse_error
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_pause_ctrl_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_lacpdu_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_marker_pdu_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_marker_resp_pdu_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_drop_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_xgmii_char1_match
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_xgmii_char2_match
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_xgmii_column1_match
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_xgmii_column2_match
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_drop_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|tx_any_err_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_vld_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_offld_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_eth_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_data_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_offld_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_vld_mcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_vld_bcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_accepted_ucst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_accepted_nucst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_tagged_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_long_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_usized_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_osized_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_frag_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_jabber_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_64_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_65_127_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_128_255_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_256_511_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_512_1023_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_1024_1518_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_1519_4095_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_40956_8191_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_8192_max_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ttl_gt_max_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ip_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_hdr_err_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_icmp
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_tcp
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_udp
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_err_tcp
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_pause_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_pause_ctrl_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_unsup_ctrl_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_in_rng_len_err_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_out_rng_len_err_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_drop_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_discarded_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_drop_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_err_drp_udp
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_lacpdu_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_marker_pdu_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_marker_resp_pdu_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_unknown_pdu_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_illegal_pdu_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_fcs_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_len_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_pf_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_trash_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_rts_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_wol_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_red_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_ingm_full_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_xgmii_data_err_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_xgmii_ctrl_err_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_xgmii_err_sym
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_xgmii_char1_match
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_xgmii_char2_match
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_xgmii_column1_match
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_xgmii_column2_match
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_local_fault
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_remote_fault
argument_list|)
expr_stmt|;
name|set_latest_stat_link_cnt
argument_list|(
name|i
argument_list|,
name|rx_queue_full
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|XGE_HAL_MAC_AGGREGATORS
condition|;
name|i
operator|++
control|)
block|{
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|tx_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|tx_mcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|tx_bcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|tx_discarded_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|tx_errored_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|rx_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|rx_data_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|rx_mcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|rx_bcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|rx_discarded_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|rx_errored_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_aggr_cnt
argument_list|(
name|i
argument_list|,
name|rx_unknown_protocol_frms
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  * __hal_stats_update_latest - Update hw stats counters, based on the real  * hardware maintained counters and the stored "reset" values.  */
end_comment

begin_function
specifier|static
name|void
name|__hal_stats_update_latest
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
define|#
directive|define
name|set_latest_stat_cnt
parameter_list|(
name|_dev
parameter_list|,
name|_p
parameter_list|)
define|\
value|hldev->stats.hw_info_latest._p =                                \ 	((hldev->stats.hw_info->_p>= hldev->stats.hw_info_saved._p) ?  \           hldev->stats.hw_info->_p - hldev->stats.hw_info_saved._p :    \ 	  ((-1) - hldev->stats.hw_info_saved._p) + hldev->stats.hw_info->_p)
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|==
name|XGE_HAL_CARD_TITAN
condition|)
block|{
name|__hal_stats_pcim_update_latest
argument_list|(
name|devh
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Tx MAC statistics counters. */
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_data_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_drop_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_mcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_bcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_pause_ctrl_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_ttl_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_ucst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_nucst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_any_err_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_ttl_less_fb_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_vld_ip_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_vld_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_drop_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_icmp
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_rst_tcp
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_tcp
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_udp
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|reserved_0
argument_list|)
expr_stmt|;
comment|/* Rx MAC Statistics counters. */
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_vld_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_data_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_fcs_err_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_drop_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_vld_mcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_vld_bcst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_in_rng_len_err_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_out_rng_len_err_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_long_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_pause_ctrl_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_unsup_ctrl_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_accepted_ucst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_accepted_nucst_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_discarded_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_drop_events
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|reserved_1
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_less_fb_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|reserved_2
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|reserved_3
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_usized_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_osized_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_frag_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_jabber_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|reserved_4
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_64_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_65_127_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|reserved_5
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_128_255_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_256_511_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|reserved_6
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_512_1023_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_1024_1518_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|reserved_7
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ip_octets
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_hdr_err_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_drop_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_icmp
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|reserved_8
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_tcp
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_udp
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_err_drp_udp
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_xgmii_err_sym
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_frms_q0
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_frms_q1
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_frms_q2
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_frms_q3
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_frms_q4
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_frms_q5
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_frms_q6
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_frms_q7
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_full_q0
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_full_q1
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_full_q2
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_full_q3
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_full_q4
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_full_q5
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_full_q6
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_full_q7
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_pause_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|reserved_9
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_xgmii_data_err_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_xgmii_ctrl_err_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_accepted_ip
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_err_tcp
argument_list|)
expr_stmt|;
comment|/* PCI/PCI-X Read transaction statistics. */
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rd_req_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|new_rd_req_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|new_rd_req_rtry_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rd_rtry_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|wr_rtry_rd_ack_cnt
argument_list|)
expr_stmt|;
comment|/* PCI/PCI-X write transaction statistics. */
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|wr_req_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|new_wr_req_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|new_wr_req_rtry_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|wr_rtry_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|wr_disc_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rd_rtry_wr_ack_cnt
argument_list|)
expr_stmt|;
comment|/* DMA Transaction statistics. */
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|txp_wr_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|txd_rd_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|txd_wr_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rxd_rd_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rxd_wr_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|txf_rd_cnt
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rxf_wr_cnt
argument_list|)
expr_stmt|;
comment|/* Enhanced Herc statistics */
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_data_octets_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_mcst_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_bcst_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_ttl_octets_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_ucst_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_nucst_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_any_err_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_vlan_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_vld_ip_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_drop_ip_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_icmp_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_rst_tcp_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tmac_udp_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tpa_unknown_protocol
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|tpa_parse_failure
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_vld_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_data_octets_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_vld_mcst_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_vld_bcst_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_octets_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_accepted_ucst_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_accepted_nucst_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_discarded_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_drop_events_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_usized_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_osized_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_frag_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_jabber_frms_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ip_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_drop_ip_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_icmp_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_udp_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_err_drp_udp_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_pause_cnt_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_1519_4095_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_4096_8191_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_8192_max_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ttl_gt_max_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_osized_alt_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_jabber_alt_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_gt_max_alt_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_vlan_frms
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_fcs_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_len_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_da_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_pf_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_rts_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_red_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_ingm_full_discard
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|rmac_accepted_ip_oflow
argument_list|)
expr_stmt|;
name|set_latest_stat_cnt
argument_list|(
name|hldev
argument_list|,
name|link_fault_cnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_stats_hw - Get HW device statistics.  * @devh: HAL device handle.  * @hw_info: Xframe statistic counters. See xge_hal_stats_hw_info_t.  *           Returned by HAL.  *  * Get device and HAL statistics. The latter is part of the in-host statistics  * that HAL maintains for _that_ device.  *  * Returns: XGE_HAL_OK - success.  * XGE_HAL_INF_STATS_IS_NOT_READY - Statistics information is not  * currently available.  *  * See also: xge_hal_status_e{}.  */
end_comment

begin_function
name|xge_hal_status_e
name|xge_hal_stats_hw
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|,
name|xge_hal_stats_hw_info_t
modifier|*
modifier|*
name|hw_info
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|xge_assert
argument_list|(
argument|xge_hal_device_check_id(hldev) != XGE_HAL_CARD_TITAN
argument_list|)
if|if
condition|(
operator|!
name|hldev
operator|->
name|stats
operator|.
name|is_initialized
operator|||
operator|!
name|hldev
operator|->
name|stats
operator|.
name|is_enabled
condition|)
block|{
operator|*
name|hw_info
operator|=
name|NULL
expr_stmt|;
return|return
name|XGE_HAL_INF_STATS_IS_NOT_READY
return|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_STATS_STREAMING
argument_list|)
name|xge_os_dma_sync
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|stats
operator|.
name|hw_info_dmah
argument_list|,
name|hldev
operator|->
name|stats
operator|.
name|dma_addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|,
name|XGE_OS_DMA_DIR_FROMDEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * update hw counters, taking into account 	 * the "reset" or "saved" 	 * values 	 */
name|__hal_stats_update_latest
argument_list|(
name|devh
argument_list|)
expr_stmt|;
comment|/* 	 * statistics HW bug fixups for Xena and Herc 	 */
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|==
name|XGE_HAL_CARD_XENA
operator|||
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|==
name|XGE_HAL_CARD_HERC
condition|)
block|{
name|u64
name|mcst
decl_stmt|,
name|bcst
decl_stmt|;
name|xge_hal_stats_hw_info_t
modifier|*
name|hwsta
init|=
operator|&
name|hldev
operator|->
name|stats
operator|.
name|hw_info_latest
decl_stmt|;
name|mcst
operator|=
operator|(
operator|(
name|u64
operator|)
name|hwsta
operator|->
name|rmac_vld_mcst_frms_oflow
operator|<<
literal|32
operator|)
operator||
name|hwsta
operator|->
name|rmac_vld_mcst_frms
expr_stmt|;
name|bcst
operator|=
operator|(
operator|(
name|u64
operator|)
name|hwsta
operator|->
name|rmac_vld_bcst_frms_oflow
operator|<<
literal|32
operator|)
operator||
name|hwsta
operator|->
name|rmac_vld_bcst_frms
expr_stmt|;
name|mcst
operator|-=
name|bcst
expr_stmt|;
name|hwsta
operator|->
name|rmac_vld_mcst_frms_oflow
operator|=
call|(
name|u32
call|)
argument_list|(
name|mcst
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|hwsta
operator|->
name|rmac_vld_mcst_frms
operator|=
operator|(
name|u32
operator|)
name|mcst
expr_stmt|;
block|}
operator|*
name|hw_info
operator|=
operator|&
name|hldev
operator|->
name|stats
operator|.
name|hw_info_latest
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_stats_pcim - Get HW device statistics.  * @devh: HAL device handle.  * @hw_info: Xframe statistic counters. See xge_hal_stats_pcim_info_t.  *  * Returns: XGE_HAL_OK - success.  * XGE_HAL_INF_STATS_IS_NOT_READY - Statistics information is not  * currently available.  *  * See also: xge_hal_status_e{}.  */
end_comment

begin_function
name|xge_hal_status_e
name|xge_hal_stats_pcim
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|,
name|xge_hal_stats_pcim_info_t
modifier|*
modifier|*
name|hw_info
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|xge_assert
argument_list|(
argument|xge_hal_device_check_id(hldev) == XGE_HAL_CARD_TITAN
argument_list|)
if|if
condition|(
operator|!
name|hldev
operator|->
name|stats
operator|.
name|is_initialized
operator|||
operator|!
name|hldev
operator|->
name|stats
operator|.
name|is_enabled
condition|)
block|{
operator|*
name|hw_info
operator|=
name|NULL
expr_stmt|;
return|return
name|XGE_HAL_INF_STATS_IS_NOT_READY
return|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|XGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|XGE_HAL_DMA_STATS_STREAMING
argument_list|)
name|xge_os_dma_sync
argument_list|(
name|hldev
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|stats
operator|.
name|hw_info_dmah
argument_list|,
name|hldev
operator|->
name|stats
operator|.
name|dma_addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|,
name|XGE_OS_DMA_DIR_FROMDEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * update hw counters, taking into account 	 * the "reset" or "saved" 	 * values 	 */
name|__hal_stats_pcim_update_latest
argument_list|(
name|devh
argument_list|)
expr_stmt|;
operator|*
name|hw_info
operator|=
name|hldev
operator|->
name|stats
operator|.
name|pcim_info_latest
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_stats_device - Get HAL statistics.  * @devh: HAL device handle.  * @hw_info: Xframe statistic counters. See xge_hal_stats_hw_info_t.  *           Returned by HAL.  * @device_info: HAL statistics. See xge_hal_stats_device_info_t.  *               Returned by HAL.  *  * Get device and HAL statistics. The latter is part of the in-host statistics  * that HAL maintains for _that_ device.  *  * Returns: XGE_HAL_OK - success.  * XGE_HAL_INF_STATS_IS_NOT_READY - Statistics information is not  * currently available.  *  * See also: xge_hal_status_e{}.  */
end_comment

begin_function
name|xge_hal_status_e
name|xge_hal_stats_device
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|,
name|xge_hal_stats_device_info_t
modifier|*
modifier|*
name|device_info
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
if|if
condition|(
operator|!
name|hldev
operator|->
name|stats
operator|.
name|is_initialized
operator|||
operator|!
name|hldev
operator|->
name|stats
operator|.
name|is_enabled
condition|)
block|{
operator|*
name|device_info
operator|=
name|NULL
expr_stmt|;
return|return
name|XGE_HAL_INF_STATS_IS_NOT_READY
return|;
block|}
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
operator|.
name|traffic_intr_cnt
operator|=
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
operator|.
name|total_intr_cnt
operator|-
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
operator|.
name|not_traffic_intr_cnt
expr_stmt|;
operator|*
name|device_info
operator|=
operator|&
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_stats_channel - Get channel statistics.  * @channelh: Channel handle.  * @channel_info: HAL channel statistic counters.  *                See xge_hal_stats_channel_info_t{}. Returned by HAL.  *  * Retrieve statistics of a particular HAL channel. This includes, for instance,  * number of completions per interrupt, number of traffic interrupts, etc.  *  * Returns: XGE_HAL_OK - success.  * XGE_HAL_INF_STATS_IS_NOT_READY - Statistics information is not  * currently available.  *  * See also: xge_hal_status_e{}.  */
end_comment

begin_function
name|xge_hal_status_e
name|xge_hal_stats_channel
parameter_list|(
name|xge_hal_channel_h
name|channelh
parameter_list|,
name|xge_hal_stats_channel_info_t
modifier|*
modifier|*
name|channel_info
parameter_list|)
block|{
name|xge_hal_stats_hw_info_t
modifier|*
name|latest
decl_stmt|;
name|xge_hal_channel_t
modifier|*
name|channel
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|channel
operator|=
operator|(
name|xge_hal_channel_t
operator|*
operator|)
name|channelh
expr_stmt|;
name|hldev
operator|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|channel
operator|->
name|devh
expr_stmt|;
if|if
condition|(
operator|(
name|hldev
operator|==
name|NULL
operator|)
operator|||
operator|(
name|hldev
operator|->
name|magic
operator|!=
name|XGE_HAL_MAGIC
operator|)
condition|)
block|{
return|return
name|XGE_HAL_ERR_INVALID_DEVICE
return|;
block|}
if|if
condition|(
operator|(
name|channel
operator|==
name|NULL
operator|)
operator|||
operator|(
name|channel
operator|->
name|magic
operator|!=
name|XGE_HAL_MAGIC
operator|)
condition|)
block|{
return|return
name|XGE_HAL_ERR_INVALID_DEVICE
return|;
block|}
if|if
condition|(
operator|!
name|hldev
operator|->
name|stats
operator|.
name|is_initialized
operator|||
operator|!
name|hldev
operator|->
name|stats
operator|.
name|is_enabled
operator|||
operator|!
name|channel
operator|->
name|is_open
condition|)
block|{
operator|*
name|channel_info
operator|=
name|NULL
expr_stmt|;
return|return
name|XGE_HAL_INF_STATS_IS_NOT_READY
return|;
block|}
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
operator|.
name|traffic_intr_cnt
operator|=
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
operator|.
name|total_intr_cnt
operator|-
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
operator|.
name|not_traffic_intr_cnt
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
operator|.
name|traffic_intr_cnt
condition|)
block|{
name|int
name|rxcnt
init|=
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
operator|.
name|rx_traffic_intr_cnt
decl_stmt|;
name|int
name|txcnt
init|=
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
operator|.
name|tx_traffic_intr_cnt
decl_stmt|;
if|if
condition|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
condition|)
block|{
if|if
condition|(
operator|!
name|txcnt
condition|)
name|txcnt
operator|=
literal|1
expr_stmt|;
name|channel
operator|->
name|stats
operator|.
name|avg_compl_per_intr_cnt
operator|=
name|channel
operator|->
name|stats
operator|.
name|total_compl_cnt
operator|/
name|txcnt
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_RING
operator|&&
operator|!
name|hldev
operator|->
name|config
operator|.
name|bimodal_interrupts
condition|)
block|{
if|if
condition|(
operator|!
name|rxcnt
condition|)
name|rxcnt
operator|=
literal|1
expr_stmt|;
name|channel
operator|->
name|stats
operator|.
name|avg_compl_per_intr_cnt
operator|=
name|channel
operator|->
name|stats
operator|.
name|total_compl_cnt
operator|/
name|rxcnt
expr_stmt|;
block|}
if|if
condition|(
name|channel
operator|->
name|stats
operator|.
name|avg_compl_per_intr_cnt
operator|==
literal|0
condition|)
block|{
comment|/* to not confuse user */
name|channel
operator|->
name|stats
operator|.
name|avg_compl_per_intr_cnt
operator|=
literal|1
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|xge_hal_stats_hw
argument_list|(
name|hldev
argument_list|,
operator|&
name|latest
argument_list|)
expr_stmt|;
if|if
condition|(
name|channel
operator|->
name|stats
operator|.
name|total_posts
condition|)
block|{
name|channel
operator|->
name|stats
operator|.
name|avg_buffers_per_post
operator|=
name|channel
operator|->
name|stats
operator|.
name|total_buffers
operator|/
name|channel
operator|->
name|stats
operator|.
name|total_posts
expr_stmt|;
ifdef|#
directive|ifdef
name|XGE_OS_PLATFORM_64BIT
if|if
condition|(
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
condition|)
block|{
name|channel
operator|->
name|stats
operator|.
name|avg_post_size
operator|=
call|(
name|u32
call|)
argument_list|(
name|latest
operator|->
name|tmac_ttl_less_fb_octets
operator|/
name|channel
operator|->
name|stats
operator|.
name|total_posts
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|XGE_OS_PLATFORM_64BIT
if|if
condition|(
name|channel
operator|->
name|stats
operator|.
name|total_buffers
operator|&&
name|channel
operator|->
name|type
operator|==
name|XGE_HAL_CHANNEL_TYPE_FIFO
condition|)
block|{
name|channel
operator|->
name|stats
operator|.
name|avg_buffer_size
operator|=
call|(
name|u32
call|)
argument_list|(
name|latest
operator|->
name|tmac_ttl_less_fb_octets
operator|/
name|channel
operator|->
name|stats
operator|.
name|total_buffers
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
operator|*
name|channel_info
operator|=
operator|&
name|channel
operator|->
name|stats
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/**  * xge_hal_stats_reset - Reset (zero-out) device statistics  * @devh: HAL device handle.  *  * Reset all device statistics.  * Returns: XGE_HAL_OK - success.  * XGE_HAL_INF_STATS_IS_NOT_READY - Statistics information is not  * currently available.  *  * See also: xge_hal_status_e{}, xge_hal_stats_channel_info_t{},  * xge_hal_stats_sw_err_t{}, xge_hal_stats_device_info_t{}.  */
end_comment

begin_function
name|xge_hal_status_e
name|xge_hal_stats_reset
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|)
block|{
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
if|if
condition|(
operator|!
name|hldev
operator|->
name|stats
operator|.
name|is_initialized
operator|||
operator|!
name|hldev
operator|->
name|stats
operator|.
name|is_enabled
condition|)
block|{
return|return
name|XGE_HAL_INF_STATS_IS_NOT_READY
return|;
block|}
comment|/* save hw stats to calculate the after-reset values */
name|__hal_stats_save
argument_list|(
operator|&
name|hldev
operator|->
name|stats
argument_list|)
expr_stmt|;
comment|/* zero-out driver-maintained stats, don't reset the saved */
name|__hal_stats_soft_reset
argument_list|(
name|hldev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|XGE_HAL_OK
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_stats_soft_reset - Reset software-maintained statistics.  */
end_comment

begin_function
name|void
name|__hal_stats_soft_reset
parameter_list|(
name|xge_hal_device_h
name|devh
parameter_list|,
name|int
name|reset_all
parameter_list|)
block|{
name|xge_list_t
modifier|*
name|item
decl_stmt|;
name|xge_hal_channel_t
modifier|*
name|channel
decl_stmt|;
name|xge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|xge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
if|if
condition|(
name|reset_all
condition|)
block|{
if|if
condition|(
name|xge_hal_device_check_id
argument_list|(
name|hldev
argument_list|)
operator|!=
name|XGE_HAL_CARD_TITAN
condition|)
block|{
name|xge_os_memzero
argument_list|(
operator|&
name|hldev
operator|->
name|stats
operator|.
name|hw_info_saved
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_memzero
argument_list|(
operator|&
name|hldev
operator|->
name|stats
operator|.
name|hw_info_latest
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_hw_info_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xge_os_memzero
argument_list|(
operator|&
name|hldev
operator|->
name|stats
operator|.
name|pcim_info_saved
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_memzero
argument_list|(
operator|&
name|hldev
operator|->
name|stats
operator|.
name|pcim_info_latest
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_pcim_info_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Reset the "soft" error and informational statistics */
name|xge_os_memzero
argument_list|(
operator|&
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_err_stats
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_sw_err_t
argument_list|)
argument_list|)
expr_stmt|;
name|xge_os_memzero
argument_list|(
operator|&
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_device_info_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* for each Rx channel */
name|xge_list_for_each
argument_list|(
argument|item
argument_list|,
argument|&hldev->ring_channels
argument_list|)
block|{
name|channel
operator|=
name|xge_container_of
argument_list|(
name|item
argument_list|,
name|xge_hal_channel_t
argument_list|,
name|item
argument_list|)
expr_stmt|;
name|xge_os_memzero
argument_list|(
operator|&
name|channel
operator|->
name|stats
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_channel_info_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* for each Tx channel */
name|xge_list_for_each
argument_list|(
argument|item
argument_list|,
argument|&hldev->fifo_channels
argument_list|)
block|{
name|channel
operator|=
name|xge_container_of
argument_list|(
name|item
argument_list|,
name|xge_hal_channel_t
argument_list|,
name|item
argument_list|)
expr_stmt|;
name|xge_os_memzero
argument_list|(
operator|&
name|channel
operator|->
name|stats
argument_list|,
sizeof|sizeof
argument_list|(
name|xge_hal_stats_channel_info_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


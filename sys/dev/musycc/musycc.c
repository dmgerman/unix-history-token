begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ----------------------------------------------------------------------------  * "THE BEER-WARE LICENSE" (Revision 42):  *<phk@FreeBSD.org> wrote this file.  As long as you retain this notice you  * can do whatever you want with this stuff. If we meet some day, and you think  * this stuff is worth it, you can buy me a beer in return.   Poul-Henning Kamp  * ----------------------------------------------------------------------------  *  * $FreeBSD$  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|"pci_if.h"
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_MUSYCC
argument_list|,
literal|"musycc"
argument_list|,
literal|"MUSYCC related"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|void
name|init_8370
parameter_list|(
name|u_int32_t
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Device driver initialization stuff  */
end_comment

begin_decl_stmt
specifier|static
name|devclass_t
name|musycc_devclass
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* XXX: Notice, these babies must be aligned to 2k boundaries [5-7] */
end_comment

begin_struct
struct|struct
name|groupr
block|{
name|u_int32_t
name|thp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Transmit Head Pointer [5-29]	     */
name|u_int32_t
name|tmp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Transmit Message Pointer [5-30]	     */
name|u_int32_t
name|rhp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Receive Head Pointer [5-29]	     */
name|u_int32_t
name|rmp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Receive Message Pointer [5-30]	     */
name|u_int8_t
name|ttsm
index|[
literal|128
index|]
decl_stmt|;
comment|/* Time Slot Map [5-22]		     */
name|u_int8_t
name|tscm
index|[
literal|256
index|]
decl_stmt|;
comment|/* Subchannel Map [5-24]		     */
name|u_int32_t
name|tcct
index|[
literal|32
index|]
decl_stmt|;
comment|/* Channel Configuration [5-26]	     */
name|u_int8_t
name|rtsm
index|[
literal|128
index|]
decl_stmt|;
comment|/* Time Slot Map [5-22] 		     */
name|u_int8_t
name|rscm
index|[
literal|256
index|]
decl_stmt|;
comment|/* Subchannel Map [5-24]		     */
name|u_int32_t
name|rcct
index|[
literal|32
index|]
decl_stmt|;
comment|/* Channel Configuration [5-26]           */
name|u_int32_t
name|__glcd
decl_stmt|;
comment|/* Global Configuration Descriptor [5-10] */
name|u_int32_t
name|__iqp
decl_stmt|;
comment|/* Interrupt Queue Pointer [5-36]	     */
name|u_int32_t
name|__iql
decl_stmt|;
comment|/* Interrupt Queue Length [5-36]	     */
name|u_int32_t
name|grcd
decl_stmt|;
comment|/* Group Configuration Descriptor [5-16]  */
name|u_int32_t
name|mpd
decl_stmt|;
comment|/* Memory Protection Descriptor [5-18]    */
name|u_int32_t
name|mld
decl_stmt|;
comment|/* Message Length Descriptor [5-20]       */
name|u_int32_t
name|pcd
decl_stmt|;
comment|/* Port Configuration Descriptor [5-19]   */
name|u_int32_t
name|__rbist
decl_stmt|;
comment|/* Receive BIST status [5-4]              */
name|u_int32_t
name|__tbist
decl_stmt|;
comment|/* Receive BIST status [5-4]              */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|globalr
block|{
name|u_int32_t
name|gbp
decl_stmt|;
comment|/* Group Base Pointer */
name|u_int32_t
name|dacbp
decl_stmt|;
comment|/* Dual Address Cycle Base Pointer */
name|u_int32_t
name|srd
decl_stmt|;
comment|/* Service Request Descriptor */
name|u_int32_t
name|isd
decl_stmt|;
comment|/* Interrupt Service Descriptor */
name|u_int32_t
name|__thp
index|[
literal|28
index|]
decl_stmt|;
comment|/* Transmit Head Pointer [5-29]	     */
name|u_int32_t
name|__tmp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Transmit Message Pointer [5-30]	     */
name|u_int32_t
name|__rhp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Receive Head Pointer [5-29]	     */
name|u_int32_t
name|__rmp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Receive Message Pointer [5-30]	     */
name|u_int8_t
name|ttsm
index|[
literal|128
index|]
decl_stmt|;
comment|/* Time Slot Map [5-22]		     */
name|u_int8_t
name|tscm
index|[
literal|256
index|]
decl_stmt|;
comment|/* Subchannel Map [5-24]		     */
name|u_int32_t
name|tcct
index|[
literal|32
index|]
decl_stmt|;
comment|/* Channel Configuration [5-26]	     */
name|u_int8_t
name|rtsm
index|[
literal|128
index|]
decl_stmt|;
comment|/* Time Slot Map [5-22] 		     */
name|u_int8_t
name|rscm
index|[
literal|256
index|]
decl_stmt|;
comment|/* Subchannel Map [5-24]		     */
name|u_int32_t
name|rcct
index|[
literal|32
index|]
decl_stmt|;
comment|/* Channel Configuration [5-26]           */
name|u_int32_t
name|glcd
decl_stmt|;
comment|/* Global Configuration Descriptor [5-10] */
name|u_int32_t
name|iqp
decl_stmt|;
comment|/* Interrupt Queue Pointer [5-36]	     */
name|u_int32_t
name|iql
decl_stmt|;
comment|/* Interrupt Queue Length [5-36]	     */
name|u_int32_t
name|grcd
decl_stmt|;
comment|/* Group Configuration Descriptor [5-16]  */
name|u_int32_t
name|mpd
decl_stmt|;
comment|/* Memory Protection Descriptor [5-18]    */
name|u_int32_t
name|mld
decl_stmt|;
comment|/* Message Length Descriptor [5-20]       */
name|u_int32_t
name|pcd
decl_stmt|;
comment|/* Port Configuration Descriptor [5-19]   */
name|u_int32_t
name|rbist
decl_stmt|;
comment|/* Receive BIST status [5-4]              */
name|u_int32_t
name|tbist
decl_stmt|;
comment|/* Receive BIST status [5-4]              */
block|}
struct|;
end_struct

begin_comment
comment|/*  * Because the chan_group must be 2k aligned we create this super   * structure so we can use the remaining 476 bytes for something useful  */
end_comment

begin_struct
struct|struct
name|mycg
block|{
name|struct
name|groupr
name|cg
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|mdesc
block|{
name|u_int32_t
name|status
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|u_int32_t
name|next
decl_stmt|;
comment|/* Software only */
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|NPORT
value|8
end_define

begin_define
define|#
directive|define
name|NHDLC
value|32
end_define

begin_define
define|#
directive|define
name|NMD
value|10
end_define

begin_define
define|#
directive|define
name|NIQD
value|32
end_define

begin_struct
struct|struct
name|softc
block|{
name|int
name|unit
decl_stmt|,
name|bus
decl_stmt|,
name|slot
decl_stmt|;
name|LIST_ENTRY
argument_list|(
argument|softc
argument_list|)
name|list
expr_stmt|;
name|device_t
name|f
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq
index|[
literal|2
index|]
decl_stmt|;
name|void
modifier|*
name|intrhand
index|[
literal|2
index|]
decl_stmt|;
name|vm_offset_t
name|physbase
index|[
literal|2
index|]
decl_stmt|;
name|u_char
modifier|*
name|virbase
index|[
literal|2
index|]
decl_stmt|;
name|int
name|nchan
decl_stmt|;
struct|struct
name|serial_if
block|{
enum|enum
block|{
name|WHOKNOWS
block|,
name|E1
block|,
name|T1
block|}
name|framing
enum|;
name|u_int32_t
name|last
decl_stmt|;
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|u_int32_t
modifier|*
name|ds8370
decl_stmt|;
name|void
modifier|*
name|ds847x
decl_stmt|;
name|struct
name|globalr
modifier|*
name|reg
decl_stmt|;
name|struct
name|groupr
modifier|*
name|ram
decl_stmt|;
name|struct
name|mycg
modifier|*
name|mycg
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|mdt
index|[
name|NHDLC
index|]
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|mdr
index|[
name|NHDLC
index|]
decl_stmt|;
name|node_p
name|node
decl_stmt|;
comment|/* NG node */
name|char
name|nodename
index|[
name|NG_NODELEN
operator|+
literal|1
index|]
decl_stmt|;
comment|/* NG nodename */
block|}
name|serial
index|[
name|NPORT
index|]
struct|;
name|struct
name|globalr
modifier|*
name|reg
decl_stmt|;
name|struct
name|globalr
modifier|*
name|ram
decl_stmt|;
name|u_int32_t
name|iqd
index|[
name|NIQD
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  *  */
end_comment

begin_define
define|#
directive|define
name|NG_NODETYPE
value|"lmc1504"
end_define

begin_decl_stmt
specifier|static
name|ng_constructor_t
name|ng_constructor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvmsg_t
name|ng_rcvmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_shutdown_t
name|ng_shutdown
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_newhook_t
name|ng_newhook
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_connect_t
name|ng_connect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|ng_rcvdata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_disconnect_t
name|ng_disconnect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ng_type
name|ngtypestruct
init|=
block|{
name|NG_VERSION
block|,
name|NG_NODETYPE
block|,
name|NULL
block|,
name|ng_constructor
block|,
name|ng_rcvmsg
block|,
name|ng_shutdown
block|,
name|ng_newhook
block|,
name|NULL
block|,
name|ng_connect
block|,
name|ng_rcvdata
block|,
name|ng_rcvdata
block|,
name|ng_disconnect
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *  */
end_comment

begin_expr_stmt
specifier|static
name|LIST_HEAD
argument_list|(
argument_list|,
argument|softc
argument_list|)
name|sc_list
operator|=
name|LIST_HEAD_INITIALIZER
argument_list|(
operator|&
name|sc_list
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|poke_847x
parameter_list|(
name|void
modifier|*
name|dummy
parameter_list|)
block|{
specifier|static
name|int
name|count
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|timeout
argument_list|(
name|poke_847x
argument_list|,
name|NULL
argument_list|,
literal|5
operator|*
name|hz
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|sc
argument_list|,
argument|&sc_list
argument_list|,
argument|list
argument_list|)
block|{
name|count
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nchan
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|serial
index|[
name|i
index|]
operator|.
name|last
operator|==
literal|0xffffffff
condition|)
block|{
name|sc
operator|->
name|serial
index|[
name|i
index|]
operator|.
name|reg
operator|->
name|srd
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|serial
index|[
name|i
index|]
operator|.
name|last
operator|=
literal|0
expr_stmt|;
return|return;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|init_847x
parameter_list|(
name|struct
name|softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|serial_if
modifier|*
name|sif
decl_stmt|;
name|printf
argument_list|(
literal|"init_847x(%p)\n"
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|sif
operator|=
operator|&
name|sc
operator|->
name|serial
index|[
literal|0
index|]
expr_stmt|;
name|sif
operator|->
name|reg
operator|->
name|gbp
operator|=
name|vtophys
argument_list|(
name|sc
operator|->
name|ram
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|glcd
operator|=
literal|0x3f30
expr_stmt|;
comment|/* XXX: designer magic */
name|sc
operator|->
name|ram
operator|->
name|iqp
operator|=
name|vtophys
argument_list|(
name|sc
operator|->
name|iqd
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|iql
operator|=
name|NIQD
operator|-
literal|1
expr_stmt|;
name|sif
operator|->
name|reg
operator|->
name|srd
operator|=
literal|0x400
expr_stmt|;
name|sif
operator|->
name|last
operator|=
literal|0x400
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|dacbp
operator|=
literal|0
expr_stmt|;
comment|/* 32bit only */
name|timeout
argument_list|(
name|poke_847x
argument_list|,
name|NULL
argument_list|,
literal|30
operator|*
name|hz
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|init_chan
parameter_list|(
name|struct
name|serial_if
modifier|*
name|sif
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|printf
argument_list|(
literal|"init_chan(%p) [%s] [%08x]\n"
argument_list|,
name|sif
argument_list|,
name|sif
operator|->
name|nodename
argument_list|,
name|sif
operator|->
name|sc
operator|->
name|reg
operator|->
name|glcd
argument_list|)
expr_stmt|;
name|init_8370
argument_list|(
name|sif
operator|->
name|ds8370
argument_list|)
expr_stmt|;
name|tsleep
argument_list|(
name|sif
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"ds8370"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|sif
operator|->
name|reg
operator|->
name|gbp
operator|=
name|vtophys
argument_list|(
name|sif
operator|->
name|ram
argument_list|)
expr_stmt|;
name|sif
operator|->
name|ram
operator|->
name|grcd
operator|=
literal|0x00000001
expr_stmt|;
comment|/* RXENBL */
name|sif
operator|->
name|ram
operator|->
name|grcd
operator||=
literal|0x00000004
expr_stmt|;
comment|/* SUBDSBL */
name|sif
operator|->
name|ram
operator|->
name|grcd
operator||=
literal|0x00000008
expr_stmt|;
comment|/* OOFABT */
if|#
directive|if
literal|0
block|sif->ram->grcd |= 0x00000010;
comment|/* MSKOOF */
block|sif->ram->grcd |= 0x00000020;
comment|/* MSKCOFA */
endif|#
directive|endif
name|sif
operator|->
name|ram
operator|->
name|grcd
operator||=
literal|0x00000c00
expr_stmt|;
comment|/* POLLTH=3 */
if|#
directive|if
literal|0
block|sif->ram->grcd |= 0x00008000;
comment|/* SFALIGN */
endif|#
directive|endif
name|sif
operator|->
name|ram
operator|->
name|mpd
operator|=
literal|0
expr_stmt|;
comment|/* Memory Protection NI [5-18] */
name|sif
operator|->
name|ram
operator|->
name|pcd
operator|=
literal|0x0000001
expr_stmt|;
comment|/* PORTMD=1 (E1/32ts) */
name|sif
operator|->
name|ram
operator|->
name|pcd
operator||=
literal|0x0000000
expr_stmt|;
comment|/* XXX */
comment|/* Message length descriptor */
comment|/* XXX: MTU */
name|sif
operator|->
name|ram
operator|->
name|mld
operator|=
literal|1600
expr_stmt|;
name|sif
operator|->
name|ram
operator|->
name|mld
operator||=
operator|(
literal|1600
operator|<<
literal|16
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NHDLC
condition|;
name|i
operator|++
control|)
block|{
name|sif
operator|->
name|ram
operator|->
name|ttsm
index|[
name|i
index|]
operator|=
name|i
operator|+
operator|(
literal|4
operator|<<
literal|5
operator|)
expr_stmt|;
name|sif
operator|->
name|ram
operator|->
name|rtsm
index|[
name|i
index|]
operator|=
name|i
operator|+
operator|(
literal|4
operator|<<
literal|5
operator|)
expr_stmt|;
name|sif
operator|->
name|ram
operator|->
name|tcct
index|[
name|i
index|]
operator|=
literal|0x2000
expr_stmt|;
comment|/* HDLC-FCS16 */
name|sif
operator|->
name|ram
operator|->
name|rcct
index|[
name|i
index|]
operator|=
literal|0x2000
expr_stmt|;
comment|/* HDLC-FCS16 */
name|sif
operator|->
name|ram
operator|->
name|tcct
index|[
name|i
index|]
operator||=
literal|0x00000
expr_stmt|;
comment|/* BUFFLEN */
name|sif
operator|->
name|ram
operator|->
name|rcct
index|[
name|i
index|]
operator||=
literal|0x00000
expr_stmt|;
comment|/* BUFFLEN */
name|sif
operator|->
name|ram
operator|->
name|tcct
index|[
name|i
index|]
operator||=
operator|(
operator|(
name|i
operator|+
name|i
operator|)
operator|<<
literal|24
operator|)
expr_stmt|;
comment|/* BUFFLOC */
name|sif
operator|->
name|ram
operator|->
name|rcct
index|[
name|i
index|]
operator||=
operator|(
operator|(
name|i
operator|+
name|i
operator|)
operator|<<
literal|24
operator|)
expr_stmt|;
comment|/* BUFFLOC */
name|MALLOC
argument_list|(
name|sif
operator|->
name|mdt
index|[
name|i
index|]
argument_list|,
expr|struct
name|mdesc
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mdesc
argument_list|)
operator|*
name|NMD
argument_list|,
name|M_MUSYCC
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|sif
operator|->
name|mdr
index|[
name|i
index|]
argument_list|,
expr|struct
name|mdesc
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mdesc
argument_list|)
operator|*
name|NMD
argument_list|,
name|M_MUSYCC
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NMD
condition|;
name|j
operator|++
control|)
block|{
name|sif
operator|->
name|mdt
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|next
operator|=
name|vtophys
argument_list|(
operator|&
name|sif
operator|->
name|mdt
index|[
name|i
index|]
index|[
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|sif
operator|->
name|mdt
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|status
operator|=
literal|0
expr_stmt|;
name|sif
operator|->
name|mdr
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|next
operator|=
name|vtophys
argument_list|(
operator|&
name|sif
operator|->
name|mdr
index|[
name|i
index|]
index|[
name|j
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_WAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|MCLGET
argument_list|(
name|m
argument_list|,
name|M_WAIT
argument_list|)
expr_stmt|;
name|sif
operator|->
name|mdr
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|m
operator|=
name|m
expr_stmt|;
name|sif
operator|->
name|mdr
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|data
operator|=
name|vtophys
argument_list|(
name|m
operator|->
name|m_data
argument_list|)
expr_stmt|;
name|sif
operator|->
name|mdr
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|status
operator|=
literal|1600
expr_stmt|;
block|}
comment|/* Close the loop */
name|sif
operator|->
name|mdt
index|[
name|i
index|]
index|[
name|NMD
operator|-
literal|1
index|]
operator|.
name|next
operator|=
name|vtophys
argument_list|(
operator|&
name|sif
operator|->
name|mdt
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sif
operator|->
name|mdr
index|[
name|i
index|]
index|[
name|NMD
operator|-
literal|1
index|]
operator|.
name|next
operator|=
name|vtophys
argument_list|(
operator|&
name|sif
operator|->
name|mdr
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sif
operator|->
name|ram
operator|->
name|thp
index|[
name|i
index|]
operator|=
name|vtophys
argument_list|(
operator|&
name|sif
operator|->
name|mdt
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sif
operator|->
name|ram
operator|->
name|tmp
index|[
name|i
index|]
operator|=
name|vtophys
argument_list|(
operator|&
name|sif
operator|->
name|mdt
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sif
operator|->
name|ram
operator|->
name|rhp
index|[
name|i
index|]
operator|=
name|vtophys
argument_list|(
operator|&
name|sif
operator|->
name|mdr
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sif
operator|->
name|ram
operator|->
name|rmp
index|[
name|i
index|]
operator|=
name|vtophys
argument_list|(
operator|&
name|sif
operator|->
name|mdr
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
name|sif
operator|->
name|last
operator|=
literal|0x500
expr_stmt|;
name|sif
operator|->
name|reg
operator|->
name|srd
operator|=
name|sif
operator|->
name|last
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|init_8370
parameter_list|(
name|u_int32_t
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|p
index|[
literal|0x001
index|]
operator|=
literal|0x80
expr_stmt|;
comment|/* CR0 - Reset */
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|p
index|[
literal|0x001
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* CR0 - E1, RFRAME: FAS only */
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|p
index|[
literal|0x002
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* JAT_CR - XXX */
name|p
index|[
literal|0x014
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LOOP - */
name|p
index|[
literal|0x015
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DL3_TS - */
name|p
index|[
literal|0x016
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DL3_BIT - */
name|p
index|[
literal|0x017
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DL3_BIT - */
name|p
index|[
literal|0x018
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* PIO - XXX */
name|p
index|[
literal|0x019
index|]
operator|=
literal|0x3c
expr_stmt|;
comment|/* POE - CLADO_OE|RCKO_OE */
name|p
index|[
literal|0x01A
index|]
operator|=
literal|0x15
expr_stmt|;
comment|/* CMUX - RSBCKI(RSBCKI), TSBCKI(RSBCKI), CLADO(RCKO), TCKI(RCKO) */
comment|/* I.431/G.775 */
name|p
index|[
literal|0x020
index|]
operator|=
literal|0x41
expr_stmt|;
comment|/* LIU_CR - SQUELCH */
name|p
index|[
literal|0x022
index|]
operator|=
literal|0xb1
expr_stmt|;
comment|/* RLIU_CR - */
name|p
index|[
literal|0x024
index|]
operator|=
literal|0x1d
expr_stmt|;
comment|/* VGA_MAX - */
name|p
index|[
literal|0x027
index|]
operator|=
literal|0xba
expr_stmt|;
comment|/* DSLICE - */
name|p
index|[
literal|0x028
index|]
operator|=
literal|0xda
expr_stmt|;
comment|/* EQ_OUT - */
name|p
index|[
literal|0x02a
index|]
operator|=
literal|0xa6
expr_stmt|;
comment|/* PRE_EQ - */
name|p
index|[
literal|0x040
index|]
operator|=
literal|0x09
expr_stmt|;
comment|/* RCRO - XXX */
name|p
index|[
literal|0x041
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RPATT - XXX */
name|p
index|[
literal|0x045
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RALM - XXX */
name|p
index|[
literal|0x046
index|]
operator|=
literal|0x05
expr_stmt|;
comment|/* LATCH - LATCH_CNT|LATCH_ALM */
name|p
index|[
literal|0x068
index|]
operator|=
literal|0x4c
expr_stmt|;
comment|/* TLIU_CR - TERM|Pulse=6 */
name|p
index|[
literal|0x070
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* TCR0 - TFRAME=4 */
name|p
index|[
literal|0x071
index|]
operator|=
literal|0x51
expr_stmt|;
comment|/* TCR1 - TZCS */
name|p
index|[
literal|0x072
index|]
operator|=
literal|0x1b
expr_stmt|;
comment|/* TCR1 - INS_YEL|INS_MF|INS_CRC|INS_FBIT */
name|p
index|[
literal|0x073
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TERROR */
name|p
index|[
literal|0x074
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TMAN */
name|p
index|[
literal|0x075
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* TALM - AUTO_YEL */
name|p
index|[
literal|0x076
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TPATT */
name|p
index|[
literal|0x077
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TLP */
name|p
index|[
literal|0x090
index|]
operator|=
literal|0x05
expr_stmt|;
comment|/* CLAD_CR - XXX */
name|p
index|[
literal|0x091
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* CSEL - 2048kHz */
name|p
index|[
literal|0x0d0
index|]
operator|=
literal|0x46
expr_stmt|;
comment|/* SBI_CR - SBI=6 */
name|p
index|[
literal|0x0d1
index|]
operator|=
literal|0x70
expr_stmt|;
comment|/* RSB_CR - XXX */
name|p
index|[
literal|0x0d2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RSYNC_BIT - 0 */
name|p
index|[
literal|0x0d3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RSYNC_TS - 0 */
name|p
index|[
literal|0x0d4
index|]
operator|=
literal|0x30
expr_stmt|;
comment|/* TSB_CR - XXX */
name|p
index|[
literal|0x0d5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TSYNC_BIT - 0 */
name|p
index|[
literal|0x0d6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TSYNC_TS - 0 */
name|p
index|[
literal|0x0d7
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* RSIG_CR - 0 */
name|p
index|[
literal|0x0d8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RSIG_FRM - 0 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|p
index|[
literal|0x0e0
operator|+
name|i
index|]
operator|=
literal|0x0d
expr_stmt|;
comment|/* SBC$i - RINDO|TINDO|ASSIGN */
name|p
index|[
literal|0x100
operator|+
name|i
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TPC$i - 0 */
name|p
index|[
literal|0x180
operator|+
name|i
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RPC$i - 0 */
block|}
block|}
end_function

begin_comment
comment|/*  * Interrupt  */
end_comment

begin_function
specifier|static
name|void
name|musycc_intr0
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|g
decl_stmt|,
name|k
decl_stmt|,
name|ch
decl_stmt|,
name|ev
decl_stmt|;
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|u_int32_t
name|u
decl_stmt|,
name|n
decl_stmt|,
name|c
decl_stmt|,
name|s
decl_stmt|;
name|struct
name|serial_if
modifier|*
name|sif
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|u
operator|=
name|sc
operator|->
name|serial
index|[
literal|0
index|]
operator|.
name|reg
operator|->
name|isd
expr_stmt|;
name|c
operator|=
name|u
operator|&
literal|0x7fff
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
condition|)
return|return;
name|n
operator|=
name|u
operator|>>
literal|16
expr_stmt|;
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
operator|<
name|n
operator|+
name|c
condition|;
name|i
operator|++
control|)
block|{
name|j
operator|=
name|i
operator|%
name|NIQD
expr_stmt|;
name|g
operator|=
operator|(
name|sc
operator|->
name|iqd
index|[
name|j
index|]
operator|>>
literal|29
operator|)
operator|&
literal|0x3
expr_stmt|;
name|g
operator||=
operator|(
name|sc
operator|->
name|iqd
index|[
name|j
index|]
operator|>>
operator|(
literal|14
operator|-
literal|2
operator|)
operator|)
operator|&
literal|0x4
expr_stmt|;
name|ch
operator|=
operator|(
name|sc
operator|->
name|iqd
index|[
name|j
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|ev
operator|=
operator|(
name|sc
operator|->
name|iqd
index|[
name|j
index|]
operator|>>
literal|20
operator|)
operator|&
literal|0xf
expr_stmt|;
name|sif
operator|=
operator|&
name|sc
operator|->
name|serial
index|[
name|g
index|]
expr_stmt|;
if|if
condition|(
name|ev
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|sif
operator|->
name|last
condition|)
block|{
name|printf
argument_list|(
literal|"%08x %d"
argument_list|,
name|sc
operator|->
name|iqd
index|[
name|j
index|]
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/%s"
argument_list|,
name|sc
operator|->
name|iqd
index|[
name|j
index|]
operator|&
literal|0x80000000
condition|?
literal|"T"
else|:
literal|"R"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" cmd %08x\n"
argument_list|,
name|sif
operator|->
name|last
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sif
operator|->
name|last
operator|==
literal|0x500
condition|)
block|{
name|sif
operator|->
name|last
operator|=
literal|0x520
expr_stmt|;
name|sif
operator|->
name|reg
operator|->
name|srd
operator|=
name|sif
operator|->
name|last
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sif
operator|->
name|last
operator|==
literal|0x520
condition|)
block|{
name|sif
operator|->
name|last
operator|=
literal|0x800
expr_stmt|;
name|sif
operator|->
name|reg
operator|->
name|srd
operator|=
name|sif
operator|->
name|last
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|sif
operator|->
name|last
operator|&
operator|~
literal|0x1f
operator|)
operator|==
literal|0x800
condition|)
block|{
name|sif
operator|->
name|last
operator|++
expr_stmt|;
if|if
condition|(
name|sif
operator|->
name|last
operator|==
literal|0x820
condition|)
name|sif
operator|->
name|last
operator|=
literal|0xffffffff
expr_stmt|;
name|sif
operator|->
name|reg
operator|->
name|srd
operator|=
name|sif
operator|->
name|last
expr_stmt|;
block|}
else|else
block|{
name|sif
operator|->
name|last
operator|=
literal|0xffffffff
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%08x %d"
argument_list|,
name|sc
operator|->
name|iqd
index|[
name|j
index|]
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/%s"
argument_list|,
name|sc
operator|->
name|iqd
index|[
name|j
index|]
operator|&
literal|0x80000000
condition|?
literal|"T"
else|:
literal|"R"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/%02d"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %02d"
argument_list|,
name|ev
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|":%02d"
argument_list|,
operator|(
name|sc
operator|->
name|iqd
index|[
name|j
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|sif
operator|->
name|mdr
index|[
name|ch
index|]
operator|!=
name|NULL
condition|)
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|NMD
condition|;
name|k
operator|++
control|)
block|{
name|s
operator|=
name|sif
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|k
index|]
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|s
operator|&
literal|0x80000000
condition|)
block|{
name|printf
argument_list|(
literal|">> %08x "
argument_list|,
name|sif
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|k
index|]
operator|.
name|status
argument_list|)
expr_stmt|;
name|sif
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|k
index|]
operator|.
name|m
operator|->
name|m_len
operator|=
name|sif
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|k
index|]
operator|.
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|s
operator|&
literal|0x001f
expr_stmt|;
name|m_print
argument_list|(
name|sif
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|k
index|]
operator|.
name|m
argument_list|)
expr_stmt|;
block|}
name|sif
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|k
index|]
operator|.
name|status
operator|=
literal|1600
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|iqd
index|[
name|i
index|]
operator|=
literal|0xffffffff
expr_stmt|;
block|}
name|n
operator|+=
name|c
expr_stmt|;
name|n
operator|%=
name|NIQD
expr_stmt|;
name|sc
operator|->
name|serial
index|[
literal|0
index|]
operator|.
name|reg
operator|->
name|isd
operator|=
name|n
operator|<<
literal|16
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|musycc_intr1
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|u_int32_t
modifier|*
name|u
decl_stmt|;
name|u_int8_t
name|irr
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nchan
condition|;
name|i
operator|++
control|)
block|{
name|u
operator|=
name|sc
operator|->
name|serial
index|[
name|i
index|]
operator|.
name|ds8370
expr_stmt|;
name|irr
operator|=
name|u
index|[
literal|3
index|]
expr_stmt|;
if|if
condition|(
name|irr
operator|==
literal|0
condition|)
continue|continue;
name|printf
argument_list|(
literal|"musycc_intr1:%d %02x"
argument_list|,
name|i
argument_list|,
name|irr
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|4
init|;
name|j
operator|<
literal|0x14
condition|;
name|j
operator|++
control|)
name|printf
argument_list|(
literal|" %02x"
argument_list|,
name|u
index|[
name|j
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * High-Level stuff  */
end_comment

begin_function
specifier|static
name|void
name|set_chan_e1
parameter_list|(
name|struct
name|serial_if
modifier|*
name|sif
parameter_list|,
name|char
modifier|*
name|ret
parameter_list|)
block|{
if|if
condition|(
name|sif
operator|->
name|framing
operator|==
name|E1
condition|)
return|return;
name|init_chan
argument_list|(
name|sif
argument_list|)
expr_stmt|;
name|sif
operator|->
name|framing
operator|=
name|E1
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|set_chan_t1
parameter_list|(
name|struct
name|serial_if
modifier|*
name|sif
parameter_list|,
name|char
modifier|*
name|ret
parameter_list|)
block|{
if|if
condition|(
name|sif
operator|->
name|framing
operator|==
name|T1
condition|)
return|return;
name|strcpy
argument_list|(
name|ret
argument_list|,
literal|"Error: T1 framing not implemented\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * NetGraph Stuff  */
end_comment

begin_function
specifier|static
name|int
name|ng_constructor
parameter_list|(
name|node_p
modifier|*
name|nodep
parameter_list|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ng_shutdown
parameter_list|(
name|node_p
name|nodep
parameter_list|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ng_config
parameter_list|(
name|node_p
name|node
parameter_list|,
name|char
modifier|*
name|set
parameter_list|,
name|char
modifier|*
name|ret
parameter_list|)
block|{
name|struct
name|serial_if
modifier|*
name|sif
decl_stmt|;
name|sif
operator|=
name|node
operator|->
name|private
expr_stmt|;
name|printf
argument_list|(
literal|"%s: CONFIG %p %p\n"
argument_list|,
name|sif
operator|->
name|nodename
argument_list|,
name|set
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|set
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s CONFIG SET [%s]\n"
argument_list|,
name|sif
operator|->
name|nodename
argument_list|,
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|set
argument_list|,
literal|"line e1"
argument_list|)
condition|)
name|set_chan_e1
argument_list|(
name|sif
argument_list|,
name|ret
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|set
argument_list|,
literal|"line t1"
argument_list|)
condition|)
name|set_chan_t1
argument_list|(
name|sif
argument_list|,
name|ret
argument_list|)
expr_stmt|;
else|else
goto|goto
name|barf
goto|;
return|return;
block|}
if|if
condition|(
name|sif
operator|->
name|framing
operator|==
name|E1
condition|)
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"line e1\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sif
operator|->
name|framing
operator|==
name|T1
condition|)
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"line t1\n"
argument_list|)
expr_stmt|;
return|return;
name|barf
label|:
name|strcpy
argument_list|(
name|ret
argument_list|,
literal|"Syntax Error\n"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"\tline [e1|t1]\n"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"\tcrc4\n"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"\tesf\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|ng_rcvmsg
parameter_list|(
name|node_p
name|node
parameter_list|,
name|struct
name|ng_mesg
modifier|*
name|msg
parameter_list|,
specifier|const
name|char
modifier|*
name|retaddr
parameter_list|,
name|struct
name|ng_mesg
modifier|*
modifier|*
name|resp
parameter_list|,
name|hook_p
name|lasthook
parameter_list|)
block|{
name|struct
name|serial_if
modifier|*
name|sif
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|r
decl_stmt|;
name|sif
operator|=
name|node
operator|->
name|private
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|typecookie
operator|!=
name|NGM_GENERIC_COOKIE
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
operator|==
name|NGM_TEXT_STATUS
condition|)
block|{
name|NG_MKRESPONSE
argument_list|(
operator|*
name|resp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ng_mesg
argument_list|)
operator|+
name|NG_TEXTRESPONSE
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
condition|)
block|{
name|FREE
argument_list|(
name|msg
argument_list|,
name|M_NETGRAPH
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|s
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
operator|*
name|resp
operator|)
operator|->
name|data
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"Status for %s\n"
argument_list|,
name|sif
operator|->
name|nodename
argument_list|)
expr_stmt|;
operator|(
operator|*
name|resp
operator|)
operator|->
name|header
operator|.
name|arglen
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|1
expr_stmt|;
name|FREE
argument_list|(
name|msg
argument_list|,
name|M_NETGRAPH
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
operator|==
name|NGM_TEXT_CONFIG
condition|)
block|{
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
condition|)
block|{
name|s
operator|=
operator|(
name|char
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
name|printf
argument_list|(
literal|"text_config %d \"%s\"\n"
argument_list|,
name|msg
operator|->
name|header
operator|.
name|arglen
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|s
operator|=
name|NULL
expr_stmt|;
block|}
name|NG_MKRESPONSE
argument_list|(
operator|*
name|resp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ng_mesg
argument_list|)
operator|+
name|NG_TEXTRESPONSE
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
condition|)
block|{
name|FREE
argument_list|(
name|msg
argument_list|,
name|M_NETGRAPH
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|r
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
operator|*
name|resp
operator|)
operator|->
name|data
expr_stmt|;
operator|*
name|r
operator|=
literal|'\0'
expr_stmt|;
name|ng_config
argument_list|(
name|node
argument_list|,
name|s
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
operator|*
name|resp
operator|)
operator|->
name|header
operator|.
name|arglen
operator|=
name|strlen
argument_list|(
name|r
argument_list|)
operator|+
literal|1
expr_stmt|;
name|FREE
argument_list|(
name|msg
argument_list|,
name|M_NETGRAPH
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|out
label|:
if|if
condition|(
name|resp
condition|)
operator|*
name|resp
operator|=
name|NULL
expr_stmt|;
name|FREE
argument_list|(
name|msg
argument_list|,
name|M_NETGRAPH
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ng_newhook
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ng_rcvdata
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|meta_p
name|meta
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|ret_m
parameter_list|,
name|meta_p
modifier|*
name|ret_meta
parameter_list|)
block|{
name|NG_FREE_DATA
argument_list|(
name|m
argument_list|,
name|meta
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ng_connect
parameter_list|(
name|hook_p
name|hook
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ng_disconnect
parameter_list|(
name|hook_p
name|hook
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * PCI initialization stuff  */
end_comment

begin_function
specifier|static
name|int
name|musycc_probe
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|char
name|desc
index|[
literal|40
index|]
decl_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|groupr
argument_list|)
operator|!=
literal|1572
condition|)
block|{
name|printf
argument_list|(
literal|"sizeof(struct groupr) = %d, should be 1572\n"
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|groupr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|globalr
argument_list|)
operator|!=
literal|1572
condition|)
block|{
name|printf
argument_list|(
literal|"sizeof(struct globalr) = %d, should be 1572\n"
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|globalr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|mycg
argument_list|)
operator|>
literal|2048
condition|)
block|{
name|printf
argument_list|(
literal|"sizeof(struct mycg) = %d, should be<= 2048\n"
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mycg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
switch|switch
condition|(
name|pci_get_devid
argument_list|(
name|self
argument_list|)
condition|)
block|{
case|case
literal|0x8471109e
case|:
name|strcpy
argument_list|(
name|desc
argument_list|,
literal|"CN8471 MUSYCC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8472109e
case|:
name|strcpy
argument_list|(
name|desc
argument_list|,
literal|"CN8472 MUSYCC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8474109e
case|:
name|strcpy
argument_list|(
name|desc
argument_list|,
literal|"CN8474 MUSYCC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8478109e
case|:
name|strcpy
argument_list|(
name|desc
argument_list|,
literal|"CN8478 MUSYCC"
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
switch|switch
condition|(
name|pci_get_function
argument_list|(
name|self
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|strcat
argument_list|(
name|desc
argument_list|,
literal|" Network controller"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|strcat
argument_list|(
name|desc
argument_list|,
literal|" Ebus bridge"
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|device_set_desc_copy
argument_list|(
name|self
argument_list|,
name|desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|musycc_attach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
decl_stmt|;
name|struct
name|serial_if
modifier|*
name|sif
decl_stmt|;
name|int
name|rid
decl_stmt|,
name|i
decl_stmt|,
name|error
decl_stmt|;
name|int
name|f
decl_stmt|;
name|u_int32_t
modifier|*
name|u32p
decl_stmt|;
specifier|static
name|int
name|once
decl_stmt|;
if|if
condition|(
operator|!
name|once
condition|)
block|{
name|once
operator|++
expr_stmt|;
name|error
operator|=
name|ng_newtype
argument_list|(
operator|&
name|ngtypestruct
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"ng_newtype() failed %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"We have %d pad bytes in mycg\n"
argument_list|,
literal|2048
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|mycg
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|=
name|pci_get_function
argument_list|(
name|self
argument_list|)
expr_stmt|;
comment|/* For function zero allocate a softc */
if|if
condition|(
name|f
operator|==
literal|0
condition|)
block|{
name|MALLOC
argument_list|(
name|sc
argument_list|,
expr|struct
name|softc
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sc
argument_list|)
argument_list|,
name|M_MUSYCC
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sc
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bus
operator|=
name|pci_get_bus
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|sc
operator|->
name|slot
operator|=
name|pci_get_slot
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|sc_list
argument_list|,
name|sc
argument_list|,
name|list
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LIST_FOREACH
argument_list|(
argument|sc
argument_list|,
argument|&sc_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|bus
operator|!=
name|pci_get_bus
argument_list|(
name|self
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|sc
operator|->
name|slot
operator|!=
name|pci_get_slot
argument_list|(
name|self
argument_list|)
condition|)
continue|continue;
break|break;
block|}
block|}
name|sc
operator|->
name|f
index|[
name|f
index|]
operator|=
name|self
expr_stmt|;
name|device_set_softc
argument_list|(
name|self
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|rid
operator|=
name|PCIR_MAPS
expr_stmt|;
name|res
operator|=
name|bus_alloc_resource
argument_list|(
name|self
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|self
argument_list|,
literal|"Could not map memory\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|sc
operator|->
name|virbase
index|[
name|f
index|]
operator|=
operator|(
name|u_char
operator|*
operator|)
name|rman_get_virtual
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|physbase
index|[
name|f
index|]
operator|=
name|rman_get_start
argument_list|(
name|res
argument_list|)
expr_stmt|;
comment|/* Allocate interrupt */
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq
index|[
name|f
index|]
operator|=
name|bus_alloc_resource
argument_list|(
name|self
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq
index|[
name|f
index|]
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"couldn't map interrupt\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|self
argument_list|,
name|sc
operator|->
name|irq
index|[
name|f
index|]
argument_list|,
name|INTR_TYPE_NET
argument_list|,
name|f
operator|==
literal|0
condition|?
name|musycc_intr0
else|:
name|musycc_intr1
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|intrhand
index|[
name|f
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"couldn't set up irq\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|f
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"f%d: device %p virtual %p physical %08x\n"
argument_list|,
name|i
argument_list|,
name|sc
operator|->
name|f
index|[
name|i
index|]
argument_list|,
name|sc
operator|->
name|virbase
index|[
name|i
index|]
argument_list|,
name|sc
operator|->
name|physbase
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|reg
operator|=
operator|(
expr|struct
name|globalr
operator|*
operator|)
name|sc
operator|->
name|virbase
index|[
literal|0
index|]
expr_stmt|;
name|sc
operator|->
name|reg
operator|->
name|glcd
operator|=
literal|0x3f30
expr_stmt|;
comment|/* XXX: designer magic */
name|u32p
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|sc
operator|->
name|virbase
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|u32p
index|[
literal|0x1200
index|]
operator|&
literal|0xffffff00
operator|)
operator|!=
literal|0x13760400
condition|)
block|{
name|printf
argument_list|(
literal|"Not a LMC1504 (ID is 0x%08x).  Bailing out.\n"
argument_list|,
name|u32p
index|[
literal|0x1200
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"Found<LanMedia LMC1504>\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nchan
operator|=
literal|4
expr_stmt|;
name|u32p
index|[
literal|0x1000
index|]
operator|=
literal|0xfe
expr_stmt|;
comment|/* XXX: control-register */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nchan
condition|;
name|i
operator|++
control|)
block|{
name|sif
operator|=
operator|&
name|sc
operator|->
name|serial
index|[
name|i
index|]
expr_stmt|;
name|sif
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|sif
operator|->
name|last
operator|=
literal|0xffffffff
expr_stmt|;
name|sif
operator|->
name|ds8370
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|sc
operator|->
name|virbase
index|[
literal|1
index|]
operator|+
name|i
operator|*
literal|0x800
operator|)
expr_stmt|;
name|sif
operator|->
name|ds847x
operator|=
name|sc
operator|->
name|virbase
index|[
literal|0
index|]
operator|+
name|i
operator|*
literal|0x800
expr_stmt|;
name|sif
operator|->
name|reg
operator|=
operator|(
expr|struct
name|globalr
operator|*
operator|)
operator|(
name|sc
operator|->
name|virbase
index|[
literal|0
index|]
operator|+
name|i
operator|*
literal|0x800
operator|)
expr_stmt|;
name|MALLOC
argument_list|(
name|sif
operator|->
name|mycg
argument_list|,
expr|struct
name|mycg
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mycg
argument_list|)
argument_list|,
name|M_MUSYCC
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|sif
operator|->
name|mycg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mycg
argument_list|)
argument_list|)
expr_stmt|;
name|sif
operator|->
name|ram
operator|=
operator|&
name|sif
operator|->
name|mycg
operator|->
name|cg
expr_stmt|;
name|error
operator|=
name|ng_make_node_common
argument_list|(
operator|&
name|ngtypestruct
argument_list|,
operator|&
name|sif
operator|->
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ng_make_node_common() failed %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|sif
operator|->
name|node
operator|->
name|private
operator|=
name|sif
expr_stmt|;
name|sprintf
argument_list|(
name|sif
operator|->
name|nodename
argument_list|,
literal|"pci%d-%d-%d-%d"
argument_list|,
name|device_get_unit
argument_list|(
name|device_get_parent
argument_list|(
name|self
argument_list|)
argument_list|)
argument_list|,
name|sc
operator|->
name|bus
argument_list|,
name|sc
operator|->
name|slot
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|error
operator|=
name|ng_name_node
argument_list|(
name|sif
operator|->
name|node
argument_list|,
name|sif
operator|->
name|nodename
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|init_chan(&sc->serial[i]);
endif|#
directive|endif
block|}
name|sc
operator|->
name|ram
operator|=
operator|(
expr|struct
name|globalr
operator|*
operator|)
operator|&
name|sc
operator|->
name|serial
index|[
literal|0
index|]
operator|.
name|mycg
operator|->
name|cg
expr_stmt|;
name|init_847x
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|musycc_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|musycc_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|musycc_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|bus_generic_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|bus_generic_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|bus_generic_shutdown
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|musycc_driver
init|=
block|{
literal|"musycc"
block|,
name|musycc_methods
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|musycc
argument_list|,
name|pci
argument_list|,
name|musycc_driver
argument_list|,
name|musycc_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


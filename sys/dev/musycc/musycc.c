begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ----------------------------------------------------------------------------  * "THE BEER-WARE LICENSE" (Revision 42):  *<phk@FreeBSD.org> wrote this file.  As long as you retain this notice you  * can do whatever you want with this stuff. If we meet some day, and you think  * this stuff is worth it, you can buy me a beer in return.   Poul-Henning Kamp  * ----------------------------------------------------------------------------  *  * $FreeBSD$  *  *  *  * Card state machine:  * -------------------  *  * This is the state engine which drives the card "as such" which in reality  * means the MUSYCC chip.  *  *  State	Description  *  *  IDLE	The card is in this state when no channels are configured.  *		This is the state we leave the card in after _attach()  *  *  INIT	The card is being initialized  *  *  RUNNING	The card is running  *  *  FAULT	The card is hosed and being reset  *  *      ------------------  *     /                  \  *    v                    |  *  IDLE ---> INIT ---> RUNNING  *                       ^   |  *                       |   |  *                       |   v  *                       FAULT  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|"pci_if.h"
end_include

begin_include
include|#
directive|include
file|<netgraph/ng_message.h>
end_include

begin_include
include|#
directive|include
file|<netgraph/netgraph.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_MUSYCC
argument_list|,
literal|"musycc"
argument_list|,
literal|"MUSYCC related"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|maxlatency
init|=
literal|250
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_debug
argument_list|,
name|OID_AUTO
argument_list|,
name|musycc_maxlatency
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|maxlatency
argument_list|,
literal|0
argument_list|,
literal|"The number of milliseconds a packet is allowed to spend in the output queue.  "
literal|"If the output queue is longer than this number of milliseconds when the packet "
literal|"arrives for output, the packet will be dropped."
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_debug
argument_list|,
name|OID_AUTO
argument_list|,
name|musycc_debug
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|debug
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct_decl
struct_decl|struct
name|softc
struct_decl|;
end_struct_decl

begin_function_decl
specifier|static
name|void
name|init_8370
parameter_list|(
name|struct
name|softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int32_t
name|parse_ts
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|int
modifier|*
name|nbit
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Device driver initialization stuff  */
end_comment

begin_decl_stmt
specifier|static
name|devclass_t
name|musycc_devclass
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* XXX: Notice, these babies must be aligned to 2k boundaries [5-7] */
end_comment

begin_struct
struct|struct
name|groupr
block|{
name|u_int32_t
name|thp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Transmit Head Pointer [5-29]	     */
name|u_int32_t
name|tmp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Transmit Message Pointer [5-30]	     */
name|u_int32_t
name|rhp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Receive Head Pointer [5-29]	     */
name|u_int32_t
name|rmp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Receive Message Pointer [5-30]	     */
name|u_int8_t
name|ttsm
index|[
literal|128
index|]
decl_stmt|;
comment|/* Time Slot Map [5-22]		     */
name|u_int8_t
name|tscm
index|[
literal|256
index|]
decl_stmt|;
comment|/* Subchannel Map [5-24]		     */
name|u_int32_t
name|tcct
index|[
literal|32
index|]
decl_stmt|;
comment|/* Channel Configuration [5-26]	     */
name|u_int8_t
name|rtsm
index|[
literal|128
index|]
decl_stmt|;
comment|/* Time Slot Map [5-22] 		     */
name|u_int8_t
name|rscm
index|[
literal|256
index|]
decl_stmt|;
comment|/* Subchannel Map [5-24]		     */
name|u_int32_t
name|rcct
index|[
literal|32
index|]
decl_stmt|;
comment|/* Channel Configuration [5-26]           */
name|u_int32_t
name|__glcd
decl_stmt|;
comment|/* Global Configuration Descriptor [5-10] */
name|u_int32_t
name|__iqp
decl_stmt|;
comment|/* Interrupt Queue Pointer [5-36]	     */
name|u_int32_t
name|__iql
decl_stmt|;
comment|/* Interrupt Queue Length [5-36]	     */
name|u_int32_t
name|grcd
decl_stmt|;
comment|/* Group Configuration Descriptor [5-16]  */
name|u_int32_t
name|mpd
decl_stmt|;
comment|/* Memory Protection Descriptor [5-18]    */
name|u_int32_t
name|mld
decl_stmt|;
comment|/* Message Length Descriptor [5-20]       */
name|u_int32_t
name|pcd
decl_stmt|;
comment|/* Port Configuration Descriptor [5-19]   */
name|u_int32_t
name|__rbist
decl_stmt|;
comment|/* Receive BIST status [5-4]              */
name|u_int32_t
name|__tbist
decl_stmt|;
comment|/* Receive BIST status [5-4]              */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|globalr
block|{
name|u_int32_t
name|gbp
decl_stmt|;
comment|/* Group Base Pointer */
name|u_int32_t
name|dacbp
decl_stmt|;
comment|/* Dual Address Cycle Base Pointer */
name|u_int32_t
name|srd
decl_stmt|;
comment|/* Service Request Descriptor */
name|u_int32_t
name|isd
decl_stmt|;
comment|/* Interrupt Service Descriptor */
name|u_int32_t
name|__thp
index|[
literal|28
index|]
decl_stmt|;
comment|/* Transmit Head Pointer [5-29]	     */
name|u_int32_t
name|__tmp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Transmit Message Pointer [5-30]	     */
name|u_int32_t
name|__rhp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Receive Head Pointer [5-29]	     */
name|u_int32_t
name|__rmp
index|[
literal|32
index|]
decl_stmt|;
comment|/* Receive Message Pointer [5-30]	     */
name|u_int8_t
name|ttsm
index|[
literal|128
index|]
decl_stmt|;
comment|/* Time Slot Map [5-22]		     */
name|u_int8_t
name|tscm
index|[
literal|256
index|]
decl_stmt|;
comment|/* Subchannel Map [5-24]		     */
name|u_int32_t
name|tcct
index|[
literal|32
index|]
decl_stmt|;
comment|/* Channel Configuration [5-26]	     */
name|u_int8_t
name|rtsm
index|[
literal|128
index|]
decl_stmt|;
comment|/* Time Slot Map [5-22] 		     */
name|u_int8_t
name|rscm
index|[
literal|256
index|]
decl_stmt|;
comment|/* Subchannel Map [5-24]		     */
name|u_int32_t
name|rcct
index|[
literal|32
index|]
decl_stmt|;
comment|/* Channel Configuration [5-26]           */
name|u_int32_t
name|glcd
decl_stmt|;
comment|/* Global Configuration Descriptor [5-10] */
name|u_int32_t
name|iqp
decl_stmt|;
comment|/* Interrupt Queue Pointer [5-36]	     */
name|u_int32_t
name|iql
decl_stmt|;
comment|/* Interrupt Queue Length [5-36]	     */
name|u_int32_t
name|grcd
decl_stmt|;
comment|/* Group Configuration Descriptor [5-16]  */
name|u_int32_t
name|mpd
decl_stmt|;
comment|/* Memory Protection Descriptor [5-18]    */
name|u_int32_t
name|mld
decl_stmt|;
comment|/* Message Length Descriptor [5-20]       */
name|u_int32_t
name|pcd
decl_stmt|;
comment|/* Port Configuration Descriptor [5-19]   */
name|u_int32_t
name|rbist
decl_stmt|;
comment|/* Receive BIST status [5-4]              */
name|u_int32_t
name|tbist
decl_stmt|;
comment|/* Receive BIST status [5-4]              */
block|}
struct|;
end_struct

begin_comment
comment|/*  * Because the chan_group must be 2k aligned we create this super   * structure so we can use the remaining 476 bytes for something useful  */
end_comment

begin_struct
struct|struct
name|mycg
block|{
name|struct
name|groupr
name|cg
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|mdesc
block|{
name|u_int32_t
name|status
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|u_int32_t
name|next
decl_stmt|;
comment|/* Software only */
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|snext
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|NPORT
value|8
end_define

begin_define
define|#
directive|define
name|NHDLC
value|32
end_define

begin_define
define|#
directive|define
name|NIQD
value|32
end_define

begin_struct_decl
struct_decl|struct
name|softc
struct_decl|;
end_struct_decl

begin_struct
struct|struct
name|schan
block|{
enum|enum
block|{
name|DOWN
block|,
name|UP
block|}
name|state
enum|;
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|int
name|chan
decl_stmt|;
name|u_int32_t
name|ts
decl_stmt|;
name|char
name|hookname
index|[
literal|8
index|]
decl_stmt|;
name|hook_p
name|hook
decl_stmt|;
name|u_long
name|rx_drop
decl_stmt|;
comment|/* mbuf allocation failures */
name|u_long
name|tx_limit
decl_stmt|;
name|u_long
name|tx_pending
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|tx_next_md
decl_stmt|;
comment|/* next MD */
name|struct
name|mdesc
modifier|*
name|tx_last_md
decl_stmt|;
comment|/* last MD */
name|int
name|rx_last_md
decl_stmt|;
comment|/* index to next MD */
name|int
name|nmd
decl_stmt|;
comment|/* count of MD's. */
name|time_t
name|last_recv
decl_stmt|;
name|time_t
name|last_rdrop
decl_stmt|;
name|time_t
name|last_rxerr
decl_stmt|;
name|u_long
name|crc_error
decl_stmt|;
name|u_long
name|dribble_error
decl_stmt|;
name|u_long
name|long_error
decl_stmt|;
name|u_long
name|abort_error
decl_stmt|;
name|u_long
name|short_error
decl_stmt|;
name|u_long
name|txn
decl_stmt|,
name|rxn
decl_stmt|;
name|time_t
name|last_xmit
decl_stmt|;
name|time_t
name|last_txerr
decl_stmt|;
name|time_t
name|last_txdrop
decl_stmt|;
name|u_long
name|tx_drop
decl_stmt|;
if|#
directive|if
literal|0
block|u_long		rx_error;  	u_long		overflow_error;  	int		last_error; 	int		prev_error;
endif|#
directive|endif
block|}
struct|;
end_struct

begin_enum
enum|enum
name|framing
block|{
name|WHOKNOWS
block|,
name|E1
block|,
name|E1U
block|,
name|T1
block|,
name|T1U
block|}
enum|;
end_enum

begin_enum
enum|enum
name|clocksource
block|{
name|EXT
block|,
name|INT
block|}
enum|;
end_enum

begin_struct
struct|struct
name|softc
block|{
name|enum
name|framing
name|framing
decl_stmt|;
name|enum
name|clocksource
name|clocksource
decl_stmt|;
name|int
name|nhooks
decl_stmt|;
name|u_int32_t
name|last
decl_stmt|;
name|struct
name|csoftc
modifier|*
name|csc
decl_stmt|;
name|u_int32_t
modifier|*
name|ds8370
decl_stmt|;
name|void
modifier|*
name|ds847x
decl_stmt|;
name|struct
name|globalr
modifier|*
name|reg
decl_stmt|;
name|struct
name|groupr
modifier|*
name|ram
decl_stmt|;
name|struct
name|mycg
modifier|*
name|mycg
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|mdt
index|[
name|NHDLC
index|]
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|mdr
index|[
name|NHDLC
index|]
decl_stmt|;
name|node_p
name|node
decl_stmt|;
comment|/* NG node */
name|char
name|nodename
index|[
name|NG_NODELEN
operator|+
literal|1
index|]
decl_stmt|;
comment|/* NG nodename */
name|struct
name|schan
modifier|*
name|chan
index|[
name|NHDLC
index|]
decl_stmt|;
name|u_long
name|cnt_ferr
decl_stmt|;
name|u_long
name|cnt_cerr
decl_stmt|;
name|u_long
name|cnt_lcv
decl_stmt|;
name|u_long
name|cnt_febe
decl_stmt|;
name|u_long
name|cnt_berr
decl_stmt|;
name|u_long
name|cnt_fred
decl_stmt|;
name|u_long
name|cnt_cofa
decl_stmt|;
name|u_long
name|cnt_sef
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * SoftC for the entire card.  */
end_comment

begin_struct
struct|struct
name|csoftc
block|{
enum|enum
block|{
name|C_IDLE
block|,
name|C_INIT
block|,
name|C_RUNNING
block|,
name|C_FAULT
block|}
name|state
enum|;
name|int
name|unit
decl_stmt|,
name|bus
decl_stmt|,
name|slot
decl_stmt|;
name|LIST_ENTRY
argument_list|(
argument|csoftc
argument_list|)
name|list
expr_stmt|;
name|device_t
name|f
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq
index|[
literal|2
index|]
decl_stmt|;
name|void
modifier|*
name|intrhand
index|[
literal|2
index|]
decl_stmt|;
name|vm_offset_t
name|physbase
index|[
literal|2
index|]
decl_stmt|;
name|u_char
modifier|*
name|virbase
index|[
literal|2
index|]
decl_stmt|;
name|u_int
name|creg
decl_stmt|,
modifier|*
name|cregp
decl_stmt|;
name|int
name|nchan
decl_stmt|;
name|struct
name|softc
name|serial
index|[
name|NPORT
index|]
decl_stmt|;
name|struct
name|globalr
modifier|*
name|reg
decl_stmt|;
name|struct
name|globalr
modifier|*
name|ram
decl_stmt|;
name|u_int32_t
name|iqd
index|[
name|NIQD
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  *  */
end_comment

begin_define
define|#
directive|define
name|NG_NODETYPE
value|"lmc1504"
end_define

begin_decl_stmt
specifier|static
name|ng_constructor_t
name|musycc_constructor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvmsg_t
name|musycc_rcvmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_shutdown_t
name|musycc_shutdown
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_newhook_t
name|musycc_newhook
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_connect_t
name|musycc_connect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_rcvdata_t
name|musycc_rcvdata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ng_disconnect_t
name|musycc_disconnect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ng_type
name|ngtypestruct
init|=
block|{
name|NG_VERSION
block|,
name|NG_NODETYPE
block|,
name|NULL
block|,
name|musycc_constructor
block|,
name|musycc_rcvmsg
block|,
name|musycc_shutdown
block|,
name|musycc_newhook
block|,
name|NULL
block|,
name|musycc_connect
block|,
name|musycc_rcvdata
block|,
name|musycc_rcvdata
block|,
name|musycc_disconnect
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|u_int32_t
name|parse_ts
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|int
modifier|*
name|nbit
parameter_list|)
block|{
name|unsigned
name|r
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
name|j
operator|=
operator|-
literal|1
expr_stmt|;
operator|*
name|nbit
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|s
condition|)
block|{
name|i
operator|=
name|strtol
argument_list|(
name|s
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
operator|||
name|i
operator|>
literal|31
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
name|j
operator|!=
operator|-
literal|1
operator|&&
name|j
operator|<
name|i
condition|)
block|{
name|r
operator||=
literal|1
operator|<<
name|j
operator|++
expr_stmt|;
operator|(
operator|*
name|nbit
operator|)
operator|++
expr_stmt|;
block|}
name|j
operator|=
operator|-
literal|1
expr_stmt|;
name|r
operator||=
literal|1
operator|<<
name|i
expr_stmt|;
operator|(
operator|*
name|nbit
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|','
condition|)
block|{
name|s
operator|=
name|p
operator|+
literal|1
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
operator|*
name|p
operator|==
literal|'-'
condition|)
block|{
name|j
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|s
operator|=
name|p
operator|+
literal|1
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
operator|!
operator|*
name|p
condition|)
block|{
break|break;
block|}
else|else
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_expr_stmt
specifier|static
name|LIST_HEAD
argument_list|(
argument_list|,
argument|csoftc
argument_list|)
name|sc_list
operator|=
name|LIST_HEAD_INITIALIZER
argument_list|(
operator|&
name|sc_list
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|poke_847x
parameter_list|(
name|void
modifier|*
name|dummy
parameter_list|)
block|{
specifier|static
name|int
name|count
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|csoftc
modifier|*
name|csc
decl_stmt|;
name|timeout
argument_list|(
name|poke_847x
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|csc
argument_list|,
argument|&sc_list
argument_list|,
argument|list
argument_list|)
block|{
name|count
operator|++
expr_stmt|;
name|i
operator|=
operator|(
name|csc
operator|->
name|creg
operator|>>
literal|24
operator|&
literal|0xf
operator|)
expr_stmt|;
name|csc
operator|->
name|creg
operator|&=
operator|~
literal|0xf000000
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|csc
operator|->
name|creg
operator||=
operator|(
name|i
operator|&
literal|0xf
operator|)
operator|<<
literal|24
expr_stmt|;
operator|*
name|csc
operator|->
name|cregp
operator|=
name|csc
operator|->
name|creg
expr_stmt|;
if|#
directive|if
literal|0
block|for (i = 0; i< sc->nchan; i++) { 			if (sc->serial[i].last == 0xffffffff) { 				sc->serial[i].reg->srd = 0; 				sc->serial[i].last = 0; 				return; 			} 		}
endif|#
directive|endif
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|init_card
parameter_list|(
name|struct
name|csoftc
modifier|*
name|csc
parameter_list|)
block|{
name|printf
argument_list|(
literal|"init_card(%p)\n"
argument_list|,
name|csc
argument_list|)
expr_stmt|;
name|csc
operator|->
name|state
operator|=
name|C_INIT
expr_stmt|;
name|csc
operator|->
name|reg
operator|->
name|srd
operator|=
literal|0x100
expr_stmt|;
name|tsleep
argument_list|(
name|csc
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"icard"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
name|csc
operator|->
name|reg
operator|->
name|gbp
operator|=
name|vtophys
argument_list|(
name|csc
operator|->
name|ram
argument_list|)
expr_stmt|;
name|csc
operator|->
name|ram
operator|->
name|glcd
operator|=
literal|0x3f30
expr_stmt|;
comment|/* XXX: designer magic */
name|csc
operator|->
name|ram
operator|->
name|iqp
operator|=
name|vtophys
argument_list|(
name|csc
operator|->
name|iqd
argument_list|)
expr_stmt|;
name|csc
operator|->
name|ram
operator|->
name|iql
operator|=
name|NIQD
operator|-
literal|1
expr_stmt|;
name|csc
operator|->
name|ram
operator|->
name|dacbp
operator|=
literal|0
expr_stmt|;
comment|/* 32bit only */
name|csc
operator|->
name|reg
operator|->
name|srd
operator|=
name|csc
operator|->
name|serial
index|[
literal|0
index|]
operator|.
name|last
operator|=
literal|0x400
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|csc
operator|->
name|serial
index|[
literal|0
index|]
operator|.
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con1"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|timeout
argument_list|(
name|poke_847x
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|csc
operator|->
name|state
operator|=
name|C_RUNNING
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|init_ctrl
parameter_list|(
name|struct
name|softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"init_ctrl(%p) [%s] [%08x]\n"
argument_list|,
name|sc
argument_list|,
name|sc
operator|->
name|nodename
argument_list|,
name|sc
operator|->
name|csc
operator|->
name|reg
operator|->
name|glcd
argument_list|)
expr_stmt|;
name|init_8370
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|tsleep
argument_list|(
name|sc
argument_list|,
name|PZERO
operator||
name|PCATCH
argument_list|,
literal|"ds8370"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: glcd: [%08x]\n"
argument_list|,
name|sc
operator|->
name|nodename
argument_list|,
name|sc
operator|->
name|csc
operator|->
name|reg
operator|->
name|glcd
argument_list|)
expr_stmt|;
name|sc
operator|->
name|reg
operator|->
name|gbp
operator|=
name|vtophys
argument_list|(
name|sc
operator|->
name|ram
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|grcd
operator|=
literal|0x00000001
expr_stmt|;
comment|/* RXENBL */
name|sc
operator|->
name|ram
operator|->
name|grcd
operator||=
literal|0x00000002
expr_stmt|;
comment|/* TXENBL */
name|sc
operator|->
name|ram
operator|->
name|grcd
operator||=
literal|0x00000004
expr_stmt|;
comment|/* SUBDSBL */
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1
operator|||
name|sc
operator|->
name|framing
operator|==
name|T1
condition|)
name|sc
operator|->
name|ram
operator|->
name|grcd
operator||=
literal|0x00000008
expr_stmt|;
comment|/* OOFABT */
else|else
name|sc
operator|->
name|ram
operator|->
name|grcd
operator||=
literal|0x00000000
expr_stmt|;
comment|/* !OOFABT */
name|sc
operator|->
name|ram
operator|->
name|grcd
operator||=
literal|0x00000020
expr_stmt|;
comment|/* MSKCOFA */
name|sc
operator|->
name|ram
operator|->
name|grcd
operator||=
literal|0x00000440
expr_stmt|;
comment|/* POLLTH=1 */
name|sc
operator|->
name|ram
operator|->
name|mpd
operator|=
literal|0
expr_stmt|;
comment|/* Memory Protection NI [5-18] */
name|sc
operator|->
name|ram
operator|->
name|pcd
operator|=
literal|0x0000001
expr_stmt|;
comment|/* PORTMD=1 (E1/32ts) */
name|sc
operator|->
name|ram
operator|->
name|pcd
operator||=
literal|1
operator|<<
literal|5
expr_stmt|;
comment|/* TSYNC_EDGE */
name|sc
operator|->
name|ram
operator|->
name|pcd
operator||=
literal|1
operator|<<
literal|9
expr_stmt|;
comment|/* TRITX */
comment|/* Message length descriptor */
comment|/* XXX: MTU */
name|sc
operator|->
name|ram
operator|->
name|mld
operator|=
literal|1600
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|mld
operator||=
operator|(
literal|1600
operator|<<
literal|16
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NHDLC
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|ram
operator|->
name|ttsm
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|rtsm
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x500
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con1"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x520
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con1"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|status_chans
parameter_list|(
name|struct
name|softc
modifier|*
name|sc
parameter_list|,
name|char
modifier|*
name|s
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|schan
modifier|*
name|scp
decl_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NHDLC
condition|;
name|i
operator|++
control|)
block|{
name|scp
operator|=
name|sc
operator|->
name|chan
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|NULL
condition|)
continue|continue;
name|sprintf
argument_list|(
name|s
operator|+
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|,
literal|"c%2d:"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
operator|+
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|,
literal|" ts %08x"
argument_list|,
name|scp
operator|->
name|ts
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
operator|+
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|,
literal|" RX %lus/%lus"
argument_list|,
name|time_second
operator|-
name|scp
operator|->
name|last_recv
argument_list|,
name|time_second
operator|-
name|scp
operator|->
name|last_rxerr
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
operator|+
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|,
literal|" TX %lus/%lus/%lus"
argument_list|,
name|time_second
operator|-
name|scp
operator|->
name|last_xmit
argument_list|,
name|time_second
operator|-
name|scp
operator|->
name|last_txerr
argument_list|,
name|time_second
operator|-
name|scp
operator|->
name|last_txdrop
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
operator|+
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|,
literal|" TXdrop %lu Pend %lu"
argument_list|,
name|scp
operator|->
name|tx_drop
argument_list|,
name|scp
operator|->
name|tx_pending
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
operator|+
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|,
literal|" CRC %lu Dribble %lu Long %lu Short %lu Abort %lu"
argument_list|,
name|scp
operator|->
name|crc_error
argument_list|,
name|scp
operator|->
name|dribble_error
argument_list|,
name|scp
operator|->
name|long_error
argument_list|,
name|scp
operator|->
name|short_error
argument_list|,
name|scp
operator|->
name|abort_error
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
operator|+
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|,
literal|"\n TX: %lu RX: %lu\n"
argument_list|,
name|scp
operator|->
name|txn
argument_list|,
name|scp
operator|->
name|rxn
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|status_8370
parameter_list|(
name|struct
name|softc
modifier|*
name|sc
parameter_list|,
name|char
modifier|*
name|s
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|p
init|=
name|sc
operator|->
name|ds8370
decl_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"Framer: "
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|framing
condition|)
block|{
case|case
name|WHOKNOWS
case|:
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"(unconfigured)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1
case|:
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"(e1)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1U
case|:
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"(e1u)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|T1
case|:
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"(t1)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|T1U
case|:
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"(t1u)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"(mode %d XXX?)\n"
argument_list|,
name|sc
operator|->
name|framing
argument_list|)
expr_stmt|;
break|break;
block|}
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"    Red alarms:"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0x47
index|]
operator|&
literal|0x08
condition|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" ALOS"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
index|[
literal|0x47
index|]
operator|&
literal|0x04
condition|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" LOS"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1
operator|||
name|sc
operator|->
name|framing
operator|==
name|T1
condition|)
block|{
if|if
condition|(
name|p
index|[
literal|0x47
index|]
operator|&
literal|0x02
condition|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" LOF"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
block|}
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"\n    Yellow alarms:"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0x47
index|]
operator|&
literal|0x80
condition|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" RMYEL"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
index|[
literal|0x47
index|]
operator|&
literal|0x40
condition|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" RYEL"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"\n    Blue alarms:"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0x47
index|]
operator|&
literal|0x10
condition|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" AIS"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"\n    Various alarms:"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0x48
index|]
operator|&
literal|0x10
condition|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" TSHORT"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"\n    Counters:"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1
condition|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" FERR=%lu"
argument_list|,
name|sc
operator|->
name|cnt_ferr
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" CERR=%lu"
argument_list|,
name|sc
operator|->
name|cnt_cerr
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" LCV=%lu"
argument_list|,
name|sc
operator|->
name|cnt_lcv
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" FEBE=%lu"
argument_list|,
name|sc
operator|->
name|cnt_febe
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" BERR=%lu"
argument_list|,
name|sc
operator|->
name|cnt_berr
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" FRED=%lu"
argument_list|,
name|sc
operator|->
name|cnt_fred
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" COFA=%lu"
argument_list|,
name|sc
operator|->
name|cnt_cofa
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" SEF=%lu"
argument_list|,
name|sc
operator|->
name|cnt_sef
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_8370
parameter_list|(
name|struct
name|softc
modifier|*
name|sc
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|int
name|offset
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_int32_t
modifier|*
name|p
init|=
name|sc
operator|->
name|ds8370
decl_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x100
condition|;
name|i
operator|+=
literal|16
control|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"%03x: "
argument_list|,
name|i
operator|+
name|offset
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|0x10
condition|;
name|j
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|" %02x"
argument_list|,
name|p
index|[
name|i
operator|+
name|j
operator|+
name|offset
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|init_8370
parameter_list|(
name|struct
name|softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int32_t
modifier|*
name|p
init|=
name|sc
operator|->
name|ds8370
decl_stmt|;
name|p
index|[
literal|0x001
index|]
operator|=
literal|0x80
expr_stmt|;
comment|/* CR0 - Reset */
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|p
index|[
literal|0x001
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* CR0 - E1, RFRAME: FAS only */
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clocksource
operator|==
name|INT
condition|)
name|p
index|[
literal|0x002
index|]
operator|=
literal|0x40
expr_stmt|;
comment|/* JAT_CR - XXX */
else|else
name|p
index|[
literal|0x002
index|]
operator|=
literal|0x20
expr_stmt|;
comment|/* JAT_CR - XXX */
name|p
index|[
literal|0x00D
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* IER6 - ONESEC */
name|p
index|[
literal|0x014
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LOOP - */
name|p
index|[
literal|0x015
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DL3_TS - */
name|p
index|[
literal|0x016
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DL3_BIT - */
name|p
index|[
literal|0x017
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DL3_BIT - */
name|p
index|[
literal|0x018
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* PIO - XXX */
name|p
index|[
literal|0x019
index|]
operator|=
literal|0x3c
expr_stmt|;
comment|/* POE - CLADO_OE|RCKO_OE */
if|if
condition|(
name|sc
operator|->
name|clocksource
operator|==
name|INT
condition|)
name|p
index|[
literal|0x01A
index|]
operator|=
literal|0x37
expr_stmt|;
comment|/* CMUX - RSBCKI(RSBCKI), TSBCKI(CLADO), CLADO(RCKO), TCKI(CLADO) */
else|else
name|p
index|[
literal|0x01A
index|]
operator|=
literal|0x37
expr_stmt|;
comment|/* CMUX - RSBCKI(RSBCKI), TSBCKI(RSBCKI), CLADO(RCKO), TCKI(RCKO) */
comment|/* I.431/G.775 */
name|p
index|[
literal|0x020
index|]
operator|=
literal|0x41
expr_stmt|;
comment|/* LIU_CR - SQUELCH */
name|p
index|[
literal|0x022
index|]
operator|=
literal|0xb1
expr_stmt|;
comment|/* RLIU_CR - */
name|p
index|[
literal|0x024
index|]
operator|=
literal|0x1d
expr_stmt|;
comment|/* VGA_MAX - */
name|p
index|[
literal|0x027
index|]
operator|=
literal|0xba
expr_stmt|;
comment|/* DSLICE - */
name|p
index|[
literal|0x028
index|]
operator|=
literal|0xda
expr_stmt|;
comment|/* EQ_OUT - */
name|p
index|[
literal|0x02a
index|]
operator|=
literal|0xa6
expr_stmt|;
comment|/* PRE_EQ - */
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1U
operator|||
name|sc
operator|->
name|framing
operator|==
name|T1U
condition|)
name|p
index|[
literal|0x040
index|]
operator|=
literal|0x49
expr_stmt|;
comment|/* RCRO - XXX */
else|else
name|p
index|[
literal|0x040
index|]
operator|=
literal|0x09
expr_stmt|;
comment|/* RCRO - XXX */
name|p
index|[
literal|0x041
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RPATT - XXX */
name|p
index|[
literal|0x045
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RALM - XXX */
name|p
index|[
literal|0x046
index|]
operator|=
literal|0x05
expr_stmt|;
comment|/* LATCH - LATCH_CNT|LATCH_ALM */
name|p
index|[
literal|0x068
index|]
operator|=
literal|0x4c
expr_stmt|;
comment|/* TLIU_CR - TERM|Pulse=6 */
name|p
index|[
literal|0x070
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* TCR0 - TFRAME=4 */
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1U
operator|||
name|sc
operator|->
name|framing
operator|==
name|T1U
condition|)
name|p
index|[
literal|0x071
index|]
operator|=
literal|0x41
expr_stmt|;
comment|/* TCR1 - TZCS */
else|else
name|p
index|[
literal|0x071
index|]
operator|=
literal|0x51
expr_stmt|;
comment|/* TCR1 - TZCS */
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1U
operator|||
name|sc
operator|->
name|framing
operator|==
name|T1U
condition|)
name|p
index|[
literal|0x072
index|]
operator|=
literal|0x00
expr_stmt|;
else|else
name|p
index|[
literal|0x072
index|]
operator|=
literal|0x1b
expr_stmt|;
comment|/* TCR1 - INS_YEL|INS_MF|INS_CRC|INS_FBIT */
name|p
index|[
literal|0x073
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TERROR */
name|p
index|[
literal|0x074
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TMAN */
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1U
operator|||
name|sc
operator|->
name|framing
operator|==
name|T1U
condition|)
name|p
index|[
literal|0x075
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* TALM */
else|else
name|p
index|[
literal|0x075
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* TALM - AUTO_YEL */
name|p
index|[
literal|0x076
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TPATT */
name|p
index|[
literal|0x077
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TLP */
name|p
index|[
literal|0x090
index|]
operator|=
literal|0x05
expr_stmt|;
comment|/* CLAD_CR - XXX */
name|p
index|[
literal|0x091
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* CSEL - 2048kHz */
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1U
operator|||
name|sc
operator|->
name|framing
operator|==
name|T1U
condition|)
block|{
name|p
index|[
literal|0x0a0
index|]
operator|=
literal|0x00
expr_stmt|;
name|p
index|[
literal|0x0a6
index|]
operator|=
literal|0x00
expr_stmt|;
name|p
index|[
literal|0x0b1
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
name|p
index|[
literal|0x0d0
index|]
operator|=
literal|0x46
expr_stmt|;
comment|/* SBI_CR - SBI=6 */
name|p
index|[
literal|0x0d1
index|]
operator|=
literal|0x70
expr_stmt|;
comment|/* RSB_CR - XXX */
name|p
index|[
literal|0x0d2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RSYNC_BIT - 0 */
name|p
index|[
literal|0x0d3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RSYNC_TS - 0 */
name|p
index|[
literal|0x0d4
index|]
operator|=
literal|0x30
expr_stmt|;
comment|/* TSB_CR - XXX */
name|p
index|[
literal|0x0d5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TSYNC_BIT - 0 */
name|p
index|[
literal|0x0d6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TSYNC_TS - 0 */
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1U
operator|||
name|sc
operator|->
name|framing
operator|==
name|T1U
condition|)
name|p
index|[
literal|0x0d7
index|]
operator|=
literal|0x05
expr_stmt|;
comment|/* RSIG_CR - 0  | FRZ_OFF*/
else|else
name|p
index|[
literal|0x0d7
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* RSIG_CR - 0 */
name|p
index|[
literal|0x0d8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RSIG_FRM - 0 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|p
index|[
literal|0x0e0
operator|+
name|i
index|]
operator|=
literal|0x0d
expr_stmt|;
comment|/* SBC$i - RINDO|TINDO|ASSIGN */
name|p
index|[
literal|0x100
operator|+
name|i
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* TPC$i - 0 */
name|p
index|[
literal|0x180
operator|+
name|i
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* RPC$i - 0 */
block|}
block|}
end_function

begin_comment
comment|/*  * Interrupts  */
end_comment

begin_function
specifier|static
name|void
name|musycc_intr0_tx_eom
parameter_list|(
name|struct
name|softc
modifier|*
name|sc
parameter_list|,
name|int
name|ch
parameter_list|)
block|{
name|struct
name|schan
modifier|*
name|sch
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|md
decl_stmt|;
name|sch
operator|=
name|sc
operator|->
name|chan
index|[
name|ch
index|]
expr_stmt|;
if|if
condition|(
name|sch
operator|==
name|NULL
operator|||
name|sch
operator|->
name|state
operator|!=
name|UP
condition|)
block|{
comment|/* XXX: this should not happen once the driver is done */
name|printf
argument_list|(
literal|"Xmit packet on uninitialized channel %d\n"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
operator|==
name|NULL
condition|)
return|return;
comment|/* XXX: can this happen ? */
for|for
control|(
init|;
condition|;
control|)
block|{
name|md
operator|=
name|sch
operator|->
name|tx_last_md
expr_stmt|;
if|if
condition|(
name|md
operator|->
name|status
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|md
operator|->
name|status
operator|&
literal|0x80000000
condition|)
break|break;
comment|/* Not our mdesc, done */
name|sch
operator|->
name|tx_last_md
operator|=
name|md
operator|->
name|snext
expr_stmt|;
name|md
operator|->
name|data
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|md
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|sch
operator|->
name|tx_pending
operator|-=
name|md
operator|->
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|m_freem
argument_list|(
name|md
operator|->
name|m
argument_list|)
expr_stmt|;
name|md
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
name|md
operator|->
name|status
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Receive interrupt on controller *sc, channel ch  *  * We perambulate the Rx descriptor ring until we hit  * a mdesc which isn't ours to take.  */
end_comment

begin_function
specifier|static
name|void
name|musycc_intr0_rx_eom
parameter_list|(
name|struct
name|softc
modifier|*
name|sc
parameter_list|,
name|int
name|ch
parameter_list|)
block|{
name|u_int32_t
name|status
decl_stmt|,
name|error
decl_stmt|;
name|struct
name|schan
modifier|*
name|sch
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m2
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|md
decl_stmt|;
name|sch
operator|=
name|sc
operator|->
name|chan
index|[
name|ch
index|]
expr_stmt|;
if|if
condition|(
name|sch
operator|==
name|NULL
operator|||
name|sch
operator|->
name|state
operator|!=
name|UP
condition|)
block|{
comment|/* XXX: this should not happen once the driver is done */
name|printf
argument_list|(
literal|"Received packet on uninitialized channel %d\n"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
operator|==
name|NULL
condition|)
return|return;
comment|/* XXX: can this happen ? */
for|for
control|(
init|;
condition|;
control|)
block|{
name|md
operator|=
operator|&
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|sch
operator|->
name|rx_last_md
index|]
expr_stmt|;
name|status
operator|=
name|md
operator|->
name|status
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|status
operator|&
literal|0x80000000
operator|)
condition|)
break|break;
comment|/* Not our mdesc, done */
name|m
operator|=
name|md
operator|->
name|m
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|status
operator|&
literal|0x3fff
expr_stmt|;
name|error
operator|=
operator|(
name|status
operator|>>
literal|16
operator|)
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|MGETHDR
argument_list|(
name|m2
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m2
operator|!=
name|NULL
condition|)
block|{
name|MCLGET
argument_list|(
name|m2
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|m2
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Substitute the mbuf+cluster. */
name|md
operator|->
name|m
operator|=
name|m2
expr_stmt|;
name|md
operator|->
name|data
operator|=
name|vtophys
argument_list|(
name|m2
operator|->
name|m_data
argument_list|)
expr_stmt|;
comment|/* Pass the received mbuf upwards. */
name|sch
operator|->
name|last_recv
operator|=
name|time_second
expr_stmt|;
name|ng_queue_data
argument_list|(
name|sch
operator|->
name|hook
argument_list|,
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 				         * We didn't get a mbuf cluster, 					 * drop received packet, free the 					 * mbuf we cannot use and recycle 				         * the mbuf+cluster we already had. 					 */
name|m_freem
argument_list|(
name|m2
argument_list|)
expr_stmt|;
name|sch
operator|->
name|last_rdrop
operator|=
name|time_second
expr_stmt|;
name|sch
operator|->
name|rx_drop
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 				 * We didn't get a mbuf, drop received packet 				 * and recycle the "old" mbuf+cluster. 				 */
name|sch
operator|->
name|last_rdrop
operator|=
name|time_second
expr_stmt|;
name|sch
operator|->
name|rx_drop
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|error
operator|==
literal|9
condition|)
block|{
name|sch
operator|->
name|last_rxerr
operator|=
name|time_second
expr_stmt|;
name|sch
operator|->
name|crc_error
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|==
literal|10
condition|)
block|{
name|sch
operator|->
name|last_rxerr
operator|=
name|time_second
expr_stmt|;
name|sch
operator|->
name|dribble_error
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|==
literal|11
condition|)
block|{
name|sch
operator|->
name|last_rxerr
operator|=
name|time_second
expr_stmt|;
name|sch
operator|->
name|abort_error
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|error
operator|==
literal|12
condition|)
block|{
name|sch
operator|->
name|last_rxerr
operator|=
name|time_second
expr_stmt|;
name|sch
operator|->
name|long_error
operator|++
expr_stmt|;
block|}
else|else
block|{
name|sch
operator|->
name|last_rxerr
operator|=
name|time_second
expr_stmt|;
comment|/* Receive error, print some useful info */
name|printf
argument_list|(
literal|"%s %s: RX 0x%08x "
argument_list|,
name|sch
operator|->
name|sc
operator|->
name|nodename
argument_list|,
name|sch
operator|->
name|hookname
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* Don't print a lot, just the begining will do */
if|if
condition|(
name|m
operator|->
name|m_len
operator|>
literal|16
condition|)
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
literal|16
expr_stmt|;
name|m_print
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|md
operator|->
name|status
operator|=
literal|1600
expr_stmt|;
comment|/* XXX: MTU */
comment|/* Check next mdesc in the ring */
if|if
condition|(
operator|++
name|sch
operator|->
name|rx_last_md
operator|>=
name|sch
operator|->
name|nmd
condition|)
name|sch
operator|->
name|rx_last_md
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|musycc_intr0
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|g
decl_stmt|,
name|ch
decl_stmt|,
name|ev
decl_stmt|,
name|er
decl_stmt|;
name|struct
name|csoftc
modifier|*
name|csc
decl_stmt|;
name|u_int32_t
name|u
decl_stmt|,
name|u1
decl_stmt|,
name|n
decl_stmt|,
name|c
decl_stmt|;
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|csc
operator|=
name|arg
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|u
operator|=
name|csc
operator|->
name|reg
operator|->
name|isd
expr_stmt|;
name|c
operator|=
name|u
operator|&
literal|0x7fff
expr_stmt|;
name|n
operator|=
name|u
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|debug
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|"%s: IRQ: %08x n = %d c = %d\n"
argument_list|,
name|csc
operator|->
name|serial
index|[
literal|0
index|]
operator|.
name|nodename
argument_list|,
name|u
argument_list|,
name|n
argument_list|,
name|c
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
condition|;
name|i
operator|++
control|)
block|{
name|j
operator|=
operator|(
name|n
operator|+
name|i
operator|)
operator|%
name|NIQD
expr_stmt|;
name|u1
operator|=
name|csc
operator|->
name|iqd
index|[
name|j
index|]
expr_stmt|;
name|g
operator|=
operator|(
name|u1
operator|>>
literal|29
operator|)
operator|&
literal|0x3
expr_stmt|;
name|g
operator||=
operator|(
name|u1
operator|>>
operator|(
literal|14
operator|-
literal|2
operator|)
operator|)
operator|&
literal|0x4
expr_stmt|;
name|ch
operator|=
operator|(
name|u1
operator|>>
literal|24
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|ev
operator|=
operator|(
name|u1
operator|>>
literal|20
operator|)
operator|&
literal|0xf
expr_stmt|;
name|er
operator|=
operator|(
name|u1
operator|>>
literal|16
operator|)
operator|&
literal|0xf
expr_stmt|;
name|sc
operator|=
operator|&
name|csc
operator|->
name|serial
index|[
name|g
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|debug
operator|&
literal|2
operator|)
operator|||
name|er
condition|)
block|{
name|printf
argument_list|(
literal|"%08x %d"
argument_list|,
name|u1
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/%s"
argument_list|,
name|u1
operator|&
literal|0x80000000
condition|?
literal|"T"
else|:
literal|"R"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/%02d"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %02d"
argument_list|,
name|ev
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|":%02d"
argument_list|,
name|er
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|ev
condition|)
block|{
case|case
literal|1
case|:
comment|/* SACK		Service Request Acknowledge	    */
if|#
directive|if
literal|0
block|printf("%s: SACK: %08x group=%d", sc->nodename, csc->iqd[j], g); 				printf("/%s", csc->iqd[j]& 0x80000000 ? "T" : "R"); 				printf(" cmd %08x (%08x) \n", sc->last, sc->reg->srd);
endif|#
directive|endif
name|sc
operator|->
name|last
operator|=
literal|0xffffffff
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* CHABT	Change To Abort Code (0x7e -> 0xff) */
case|case
literal|6
case|:
comment|/* CHIC		Change To Idle Code (0xff -> 0x7e)  */
break|break;
case|case
literal|3
case|:
comment|/* EOM		End Of Message			    */
if|if
condition|(
name|csc
operator|->
name|iqd
index|[
name|j
index|]
operator|&
literal|0x80000000
condition|)
name|musycc_intr0_tx_eom
argument_list|(
name|sc
argument_list|,
name|ch
argument_list|)
expr_stmt|;
else|else
name|musycc_intr0_rx_eom
argument_list|(
name|sc
argument_list|,
name|ch
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
if|if
condition|(
name|er
operator|==
literal|13
condition|)
block|{
comment|/* SHT */
name|sc
operator|->
name|chan
index|[
name|ch
index|]
operator|->
name|last_rxerr
operator|=
name|time_second
expr_stmt|;
name|sc
operator|->
name|chan
index|[
name|ch
index|]
operator|->
name|short_error
operator|++
expr_stmt|;
break|break;
block|}
default|default:
name|musycc_intr0_tx_eom
argument_list|(
name|sc
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|musycc_intr0_rx_eom
argument_list|(
name|sc
argument_list|,
name|ch
argument_list|)
expr_stmt|;
if|#
directive|if
literal|1
name|printf
argument_list|(
literal|"huh ? %08x %d"
argument_list|,
name|u1
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/%s"
argument_list|,
name|u1
operator|&
literal|0x80000000
condition|?
literal|"T"
else|:
literal|"R"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/%02d"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %02d"
argument_list|,
name|ev
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|":%02d"
argument_list|,
name|er
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|csc
operator|->
name|iqd
index|[
name|j
index|]
operator|=
literal|0xffffffff
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|j
operator|%=
name|NIQD
expr_stmt|;
name|csc
operator|->
name|reg
operator|->
name|isd
operator|=
name|j
operator|<<
literal|16
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|musycc_intr1
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|csoftc
modifier|*
name|csc
decl_stmt|;
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|u_int32_t
modifier|*
name|u
decl_stmt|;
name|u_int8_t
name|irr
decl_stmt|;
name|csc
operator|=
name|arg
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|csc
operator|->
name|nchan
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|=
operator|&
name|csc
operator|->
name|serial
index|[
name|i
index|]
expr_stmt|;
name|u
operator|=
name|sc
operator|->
name|ds8370
expr_stmt|;
name|irr
operator|=
name|u
index|[
literal|3
index|]
expr_stmt|;
if|if
condition|(
name|irr
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|u
index|[
literal|0x5
index|]
operator|&
literal|1
condition|)
block|{
comment|/* ONESEC */
name|sc
operator|->
name|cnt_ferr
operator|+=
name|u
index|[
literal|0x50
index|]
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|cnt_ferr
operator|+=
operator|(
name|u
index|[
literal|0x51
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|8
expr_stmt|;
name|sc
operator|->
name|cnt_cerr
operator|+=
name|u
index|[
literal|0x52
index|]
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|cnt_cerr
operator|+=
operator|(
name|u
index|[
literal|0x53
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|8
expr_stmt|;
name|sc
operator|->
name|cnt_lcv
operator|+=
name|u
index|[
literal|0x54
index|]
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|cnt_lcv
operator|+=
operator|(
name|u
index|[
literal|0x55
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|8
expr_stmt|;
name|sc
operator|->
name|cnt_febe
operator|+=
name|u
index|[
literal|0x56
index|]
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|cnt_febe
operator|+=
operator|(
name|u
index|[
literal|0x57
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|8
expr_stmt|;
name|sc
operator|->
name|cnt_berr
operator|+=
name|u
index|[
literal|0x58
index|]
operator|&
literal|0xff
expr_stmt|;
name|sc
operator|->
name|cnt_berr
operator|+=
operator|(
name|u
index|[
literal|0x59
index|]
operator|&
literal|0xff
operator|)
operator|<<
literal|8
expr_stmt|;
name|sc
operator|->
name|cnt_fred
operator|+=
operator|(
name|u
index|[
literal|0x5a
index|]
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
expr_stmt|;
name|sc
operator|->
name|cnt_cofa
operator|+=
operator|(
name|u
index|[
literal|0x5a
index|]
operator|&
literal|0x0c
operator|)
operator|>>
literal|2
expr_stmt|;
name|sc
operator|->
name|cnt_sef
operator|+=
name|u
index|[
literal|0x5a
index|]
operator|&
literal|0x03
expr_stmt|;
block|}
if|if
condition|(
name|debug
operator|&
literal|4
condition|)
block|{
name|int
name|j
decl_stmt|;
name|printf
argument_list|(
literal|"musycc_intr1:%d %02x"
argument_list|,
name|i
argument_list|,
name|irr
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|4
init|;
name|j
operator|<
literal|0x14
condition|;
name|j
operator|++
control|)
name|printf
argument_list|(
literal|" %02x"
argument_list|,
name|u
index|[
name|j
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * NetGraph Stuff  */
end_comment

begin_function
specifier|static
name|int
name|musycc_constructor
parameter_list|(
name|node_p
modifier|*
name|nodep
parameter_list|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|musycc_shutdown
parameter_list|(
name|node_p
name|nodep
parameter_list|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|musycc_config
parameter_list|(
name|node_p
name|node
parameter_list|,
name|char
modifier|*
name|set
parameter_list|,
name|char
modifier|*
name|ret
parameter_list|)
block|{
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|csoftc
modifier|*
name|csc
decl_stmt|;
name|enum
name|framing
name|wframing
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|node
operator|->
name|private
expr_stmt|;
name|csc
operator|=
name|sc
operator|->
name|csc
expr_stmt|;
if|if
condition|(
name|csc
operator|->
name|state
operator|==
name|C_IDLE
condition|)
name|init_card
argument_list|(
name|csc
argument_list|)
expr_stmt|;
while|while
condition|(
name|csc
operator|->
name|state
operator|!=
name|C_RUNNING
condition|)
name|tsleep
argument_list|(
operator|&
name|csc
operator|->
name|state
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"crun"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|set
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|set
argument_list|,
literal|"line "
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|wframing
operator|=
name|sc
operator|->
name|framing
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|set
argument_list|,
literal|"line e1"
argument_list|)
condition|)
block|{
name|wframing
operator|=
name|E1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|set
argument_list|,
literal|"line e1u"
argument_list|)
condition|)
block|{
name|wframing
operator|=
name|E1U
expr_stmt|;
block|}
else|else
block|{
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"ENOGROK\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wframing
operator|==
name|sc
operator|->
name|framing
condition|)
return|return;
if|if
condition|(
name|sc
operator|->
name|nhooks
operator|>
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|ret
argument_list|,
literal|"Cannot change line when %d hooks open\n"
argument_list|,
name|sc
operator|->
name|nhooks
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|framing
operator|=
name|wframing
expr_stmt|;
name|init_ctrl
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|set
argument_list|,
literal|"clock source internal"
argument_list|)
condition|)
block|{
name|sc
operator|->
name|clocksource
operator|=
name|INT
expr_stmt|;
name|init_ctrl
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|set
argument_list|,
literal|"clock source line"
argument_list|)
condition|)
block|{
name|sc
operator|->
name|clocksource
operator|=
name|EXT
expr_stmt|;
name|init_ctrl
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|set
argument_list|,
literal|"show 8370 0"
argument_list|)
condition|)
block|{
name|dump_8370
argument_list|(
name|sc
argument_list|,
name|ret
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|set
argument_list|,
literal|"show 8370 1"
argument_list|)
condition|)
block|{
name|dump_8370
argument_list|(
name|sc
argument_list|,
name|ret
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|set
argument_list|,
literal|"creg"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|i
operator|=
name|strtol
argument_list|(
name|set
operator|+
literal|5
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"set creg %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|csc
operator|->
name|creg
operator|=
literal|0xfe
operator||
operator|(
name|i
operator|<<
literal|24
operator|)
expr_stmt|;
operator|*
name|csc
operator|->
name|cregp
operator|=
name|csc
operator|->
name|creg
expr_stmt|;
comment|/* 		} else if (!strcmp(set, "reset")) { 			reset_group(sc, ret); 		} else if (!strcmp(set, "reset all")) { 			reset_card(sc, ret); */
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s CONFIG SET [%s]\n"
argument_list|,
name|sc
operator|->
name|nodename
argument_list|,
name|set
argument_list|)
expr_stmt|;
goto|goto
name|barf
goto|;
block|}
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1
condition|)
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"line e1\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1U
condition|)
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"line e1u\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clocksource
operator|==
name|INT
condition|)
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"clock source internal\n"
argument_list|)
expr_stmt|;
else|else
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"clock source line\n"
argument_list|)
expr_stmt|;
return|return;
name|barf
label|:
name|strcpy
argument_list|(
name|ret
argument_list|,
literal|"Syntax Error\n"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"\tline {e1|e1u}\n"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ret
argument_list|,
literal|"\tshow 8370 {0|1}\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Handle status and config enquiries.  * Respond with a synchronous response.  */
end_comment

begin_function
specifier|static
name|int
name|musycc_rcvmsg
parameter_list|(
name|node_p
name|node
parameter_list|,
name|struct
name|ng_mesg
modifier|*
name|msg
parameter_list|,
specifier|const
name|char
modifier|*
name|retaddr
parameter_list|,
name|struct
name|ng_mesg
modifier|*
modifier|*
name|resp
parameter_list|)
block|{
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|r
decl_stmt|;
name|sc
operator|=
name|node
operator|->
name|private
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|typecookie
operator|!=
name|NGM_GENERIC_COOKIE
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
operator|==
name|NGM_TEXT_STATUS
condition|)
block|{
name|NG_MKRESPONSE
argument_list|(
operator|*
name|resp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ng_mesg
argument_list|)
operator|+
name|NG_TEXTRESPONSE
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
condition|)
block|{
name|FREE
argument_list|(
name|msg
argument_list|,
name|M_NETGRAPH
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|s
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
operator|*
name|resp
operator|)
operator|->
name|data
expr_stmt|;
name|status_8370
argument_list|(
name|sc
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|status_chans
argument_list|(
name|sc
argument_list|,
name|s
argument_list|)
expr_stmt|;
operator|(
operator|*
name|resp
operator|)
operator|->
name|header
operator|.
name|arglen
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|1
expr_stmt|;
name|FREE
argument_list|(
name|msg
argument_list|,
name|M_NETGRAPH
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|cmd
operator|==
name|NGM_TEXT_CONFIG
condition|)
block|{
if|if
condition|(
name|msg
operator|->
name|header
operator|.
name|arglen
condition|)
block|{
name|s
operator|=
operator|(
name|char
operator|*
operator|)
name|msg
operator|->
name|data
expr_stmt|;
block|}
else|else
block|{
name|s
operator|=
name|NULL
expr_stmt|;
block|}
name|NG_MKRESPONSE
argument_list|(
operator|*
name|resp
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ng_mesg
argument_list|)
operator|+
name|NG_TEXTRESPONSE
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
condition|)
block|{
name|FREE
argument_list|(
name|msg
argument_list|,
name|M_NETGRAPH
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|r
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
operator|*
name|resp
operator|)
operator|->
name|data
expr_stmt|;
operator|*
name|r
operator|=
literal|'\0'
expr_stmt|;
name|musycc_config
argument_list|(
name|node
argument_list|,
name|s
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
operator|*
name|resp
operator|)
operator|->
name|header
operator|.
name|arglen
operator|=
name|strlen
argument_list|(
name|r
argument_list|)
operator|+
literal|1
expr_stmt|;
name|FREE
argument_list|(
name|msg
argument_list|,
name|M_NETGRAPH
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|out
label|:
if|if
condition|(
name|resp
condition|)
operator|*
name|resp
operator|=
name|NULL
expr_stmt|;
name|FREE
argument_list|(
name|msg
argument_list|,
name|M_NETGRAPH
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|musycc_newhook
parameter_list|(
name|node_p
name|node
parameter_list|,
name|hook_p
name|hook
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|csoftc
modifier|*
name|csc
decl_stmt|;
name|struct
name|schan
modifier|*
name|sch
decl_stmt|;
name|u_int32_t
name|ts
decl_stmt|,
name|chan
decl_stmt|;
name|int
name|nbit
decl_stmt|;
name|sc
operator|=
name|node
operator|->
name|private
expr_stmt|;
name|csc
operator|=
name|sc
operator|->
name|csc
expr_stmt|;
while|while
condition|(
name|csc
operator|->
name|state
operator|!=
name|C_RUNNING
condition|)
name|tsleep
argument_list|(
operator|&
name|csc
operator|->
name|state
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"crun"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|WHOKNOWS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|name
index|[
literal|0
index|]
operator|!=
literal|'t'
operator|||
name|name
index|[
literal|1
index|]
operator|!=
literal|'s'
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|ts
operator|=
name|parse_ts
argument_list|(
name|name
operator|+
literal|2
argument_list|,
operator|&
name|nbit
argument_list|)
expr_stmt|;
if|if
condition|(
name|ts
operator|==
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|chan
operator|=
name|ffs
argument_list|(
name|ts
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|E1U
operator|&&
name|nbit
operator|==
literal|32
condition|)
empty_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|framing
operator|==
name|T1U
operator|&&
name|nbit
operator|==
literal|24
condition|)
empty_stmt|;
elseif|else
if|if
condition|(
name|ts
operator|&
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|chan
index|[
name|chan
index|]
operator|==
name|NULL
condition|)
block|{
name|MALLOC
argument_list|(
name|sch
argument_list|,
expr|struct
name|schan
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sch
argument_list|)
argument_list|,
name|M_MUSYCC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|sch
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|sch
operator|->
name|state
operator|=
name|DOWN
expr_stmt|;
name|sch
operator|->
name|chan
operator|=
name|chan
expr_stmt|;
name|sprintf
argument_list|(
name|sch
operator|->
name|hookname
argument_list|,
name|name
argument_list|)
expr_stmt|;
comment|/* XXX overflow ? */
name|sc
operator|->
name|chan
index|[
name|chan
index|]
operator|=
name|sch
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|chan
index|[
name|chan
index|]
operator|->
name|state
operator|==
name|UP
condition|)
block|{
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
name|sc
operator|->
name|nhooks
operator|++
expr_stmt|;
name|sch
operator|=
name|sc
operator|->
name|chan
index|[
name|chan
index|]
expr_stmt|;
name|sch
operator|->
name|ts
operator|=
name|ts
expr_stmt|;
name|sch
operator|->
name|hook
operator|=
name|hook
expr_stmt|;
name|sch
operator|->
name|tx_limit
operator|=
name|nbit
operator|*
literal|8
expr_stmt|;
name|hook
operator|->
name|private
operator|=
name|sch
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|musycc_rcvdata
parameter_list|(
name|hook_p
name|hook
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|meta_p
name|meta
parameter_list|)
block|{
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|csoftc
modifier|*
name|csc
decl_stmt|;
name|struct
name|schan
modifier|*
name|sch
decl_stmt|;
name|struct
name|mdesc
modifier|*
name|md
decl_stmt|,
modifier|*
name|md0
decl_stmt|;
name|u_int32_t
name|ch
decl_stmt|,
name|u
decl_stmt|,
name|u0
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m2
decl_stmt|;
name|sch
operator|=
name|hook
operator|->
name|private
expr_stmt|;
name|sc
operator|=
name|sch
operator|->
name|sc
expr_stmt|;
name|csc
operator|=
name|sc
operator|->
name|csc
expr_stmt|;
name|ch
operator|=
name|sch
operator|->
name|chan
expr_stmt|;
if|if
condition|(
name|csc
operator|->
name|state
operator|!=
name|C_RUNNING
condition|)
block|{
name|printf
argument_list|(
literal|"csc->state = %d\n"
argument_list|,
name|csc
operator|->
name|state
argument_list|)
expr_stmt|;
name|NG_FREE_DATA
argument_list|(
name|m
argument_list|,
name|meta
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|NG_FREE_META
argument_list|(
name|meta
argument_list|)
expr_stmt|;
name|meta
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|sch
operator|->
name|state
operator|!=
name|UP
condition|)
block|{
name|printf
argument_list|(
literal|"sch->state = %d\n"
argument_list|,
name|sch
operator|->
name|state
argument_list|)
expr_stmt|;
name|NG_FREE_DATA
argument_list|(
name|m
argument_list|,
name|meta
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sch
operator|->
name|tx_pending
operator|+
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|sch
operator|->
name|tx_limit
operator|*
name|maxlatency
condition|)
block|{
name|sch
operator|->
name|tx_drop
operator|++
expr_stmt|;
name|sch
operator|->
name|last_txdrop
operator|=
name|time_second
expr_stmt|;
name|NG_FREE_DATA
argument_list|(
name|m
argument_list|,
name|meta
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* find out if we have enough txmd's */
name|m2
operator|=
name|m
expr_stmt|;
name|md
operator|=
name|sch
operator|->
name|tx_next_md
expr_stmt|;
for|for
control|(
name|len
operator|=
name|m2
operator|->
name|m_pkthdr
operator|.
name|len
init|;
name|len
condition|;
name|m2
operator|=
name|m2
operator|->
name|m_next
control|)
block|{
if|if
condition|(
name|m2
operator|->
name|m_len
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|md
operator|->
name|status
operator|!=
literal|0
condition|)
block|{
name|sch
operator|->
name|tx_drop
operator|++
expr_stmt|;
name|sch
operator|->
name|last_txdrop
operator|=
name|time_second
expr_stmt|;
name|NG_FREE_DATA
argument_list|(
name|m
argument_list|,
name|meta
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|len
operator|-=
name|m2
operator|->
name|m_len
expr_stmt|;
name|md
operator|=
name|md
operator|->
name|snext
expr_stmt|;
block|}
name|m2
operator|=
name|m
expr_stmt|;
name|md
operator|=
name|md0
operator|=
name|sch
operator|->
name|tx_next_md
expr_stmt|;
name|u0
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
init|;
name|len
operator|>
literal|0
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|md
operator|->
name|status
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Out of tx md(2)\n"
argument_list|)
expr_stmt|;
name|sch
operator|->
name|last_txerr
operator|=
name|time_second
expr_stmt|;
name|sch
operator|->
name|tx_drop
operator|++
expr_stmt|;
name|sch
operator|->
name|last_txdrop
operator|=
name|time_second
expr_stmt|;
name|NG_FREE_DATA
argument_list|(
name|m
argument_list|,
name|meta
argument_list|)
expr_stmt|;
break|break;
block|}
name|md
operator|->
name|data
operator|=
name|vtophys
argument_list|(
name|m
operator|->
name|m_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|md
operator|==
name|md0
condition|)
name|u
operator|=
literal|0x00000000
expr_stmt|;
comment|/* OWNER = CPU */
else|else
name|u
operator|=
literal|0x80000000
expr_stmt|;
comment|/* OWNER = MUSYCC */
name|u
operator||=
name|m
operator|->
name|m_len
expr_stmt|;
name|len
operator|-=
name|m
operator|->
name|m_len
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|md
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|md
operator|==
name|md0
condition|)
name|u0
operator|=
name|u
expr_stmt|;
else|else
name|md
operator|->
name|status
operator|=
name|u
expr_stmt|;
name|md
operator|=
name|md
operator|->
name|snext
expr_stmt|;
continue|continue;
block|}
name|u
operator||=
literal|0x20000000
expr_stmt|;
comment|/* EOM */
name|md
operator|->
name|m
operator|=
name|m2
expr_stmt|;
name|sch
operator|->
name|tx_pending
operator|+=
name|m2
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|md
operator|==
name|md0
condition|)
block|{
name|u
operator||=
literal|0x80000000
expr_stmt|;
comment|/* OWNER = MUSYCC */
name|md
operator|->
name|status
operator|=
name|u
expr_stmt|;
block|}
else|else
block|{
name|md
operator|->
name|status
operator|=
name|u
expr_stmt|;
name|md0
operator|->
name|status
operator|=
name|u0
operator||
literal|0x80000000
expr_stmt|;
comment|/* OWNER = MUSYCC */
block|}
name|sch
operator|->
name|last_xmit
operator|=
name|time_second
expr_stmt|;
name|sch
operator|->
name|tx_next_md
operator|=
name|md
operator|->
name|snext
expr_stmt|;
block|}
name|sch
operator|->
name|txn
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|musycc_connect
parameter_list|(
name|hook_p
name|hook
parameter_list|)
block|{
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|csoftc
modifier|*
name|csc
decl_stmt|;
name|struct
name|schan
modifier|*
name|sch
decl_stmt|;
name|int
name|nts
decl_stmt|,
name|nbuf
decl_stmt|,
name|i
decl_stmt|,
name|nmd
decl_stmt|,
name|ch
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|sch
operator|=
name|hook
operator|->
name|private
expr_stmt|;
name|sc
operator|=
name|sch
operator|->
name|sc
expr_stmt|;
name|csc
operator|=
name|sc
operator|->
name|csc
expr_stmt|;
name|ch
operator|=
name|sch
operator|->
name|chan
expr_stmt|;
while|while
condition|(
name|csc
operator|->
name|state
operator|!=
name|C_RUNNING
condition|)
name|tsleep
argument_list|(
operator|&
name|csc
operator|->
name|state
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"crun"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|sch
operator|->
name|state
operator|==
name|UP
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sch
operator|->
name|state
operator|=
name|UP
expr_stmt|;
comment|/* Setup the Time Slot Map */
name|nts
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ch
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sch
operator|->
name|ts
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|sc
operator|->
name|ram
operator|->
name|rtsm
index|[
name|i
index|]
operator|=
name|ch
operator||
operator|(
literal|4
operator|<<
literal|5
operator|)
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|ttsm
index|[
name|i
index|]
operator|=
name|ch
operator||
operator|(
literal|4
operator|<<
literal|5
operator|)
expr_stmt|;
name|nts
operator|++
expr_stmt|;
block|}
block|}
comment|/*  	 * Find the length of the first run of timeslots. 	 * XXX: find the longest instead. 	 */
name|nbuf
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ch
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sch
operator|->
name|ts
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|nbuf
operator|++
expr_stmt|;
else|else
break|break;
block|}
name|printf
argument_list|(
literal|"Connect ch= %d ts= %08x nts= %d nbuf = %d\n"
argument_list|,
name|ch
argument_list|,
name|sch
operator|->
name|ts
argument_list|,
name|nts
argument_list|,
name|nbuf
argument_list|)
expr_stmt|;
comment|/* Reread the Time Slot Map */
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x1800
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con1"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x1820
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con2"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
comment|/* Set the channel mode */
name|sc
operator|->
name|ram
operator|->
name|tcct
index|[
name|ch
index|]
operator|=
literal|0x2800
expr_stmt|;
comment|/* HDLC-FCS16 | MAXSEL[2] */
name|sc
operator|->
name|ram
operator|->
name|rcct
index|[
name|ch
index|]
operator|=
literal|0x2800
expr_stmt|;
comment|/* HDLC-FCS16 | MAXSEL[2] */
comment|/* 	 * Allocate the FIFO space 	 * We don't do subchanneling so we can use 128 dwords [4-13] 	 */
name|sc
operator|->
name|ram
operator|->
name|tcct
index|[
name|ch
index|]
operator||=
operator|(
literal|1
operator|+
literal|2
operator|*
operator|(
name|nbuf
operator|-
literal|1
operator|)
operator|)
operator|<<
literal|16
expr_stmt|;
comment|/* BUFFLEN */
name|sc
operator|->
name|ram
operator|->
name|rcct
index|[
name|ch
index|]
operator||=
operator|(
literal|1
operator|+
literal|2
operator|*
operator|(
name|nbuf
operator|-
literal|1
operator|)
operator|)
operator|<<
literal|16
expr_stmt|;
comment|/* BUFFLEN */
name|sc
operator|->
name|ram
operator|->
name|tcct
index|[
name|ch
index|]
operator||=
operator|(
operator|(
name|ch
operator|*
literal|2
operator|)
operator|<<
literal|24
operator|)
expr_stmt|;
comment|/* BUFFLOC */
name|sc
operator|->
name|ram
operator|->
name|rcct
index|[
name|ch
index|]
operator||=
operator|(
operator|(
name|ch
operator|*
literal|2
operator|)
operator|<<
literal|24
operator|)
expr_stmt|;
comment|/* BUFFLOC */
comment|/* Reread the Channel Configuration Descriptor for this channel */
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x0b00
operator|+
name|ch
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con3"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x0b20
operator|+
name|ch
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con4"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
comment|/* 	 * Figure out how many receive buffers we want:  10 + nts * 2 	 *  1 timeslot,  50 bytes packets -> 68msec 	 * 31 timeslots, 50 bytes packets -> 14msec 	 */
name|sch
operator|->
name|nmd
operator|=
name|nmd
operator|=
literal|200
operator|+
name|nts
operator|*
literal|4
expr_stmt|;
name|sch
operator|->
name|rx_last_md
operator|=
literal|0
expr_stmt|;
name|MALLOC
argument_list|(
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
argument_list|,
expr|struct
name|mdesc
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mdesc
argument_list|)
operator|*
name|nmd
argument_list|,
name|M_MUSYCC
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
argument_list|,
expr|struct
name|mdesc
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mdesc
argument_list|)
operator|*
name|nmd
argument_list|,
name|M_MUSYCC
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nmd
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
name|nmd
operator|-
literal|1
condition|)
block|{
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|snext
operator|=
operator|&
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
literal|0
index|]
expr_stmt|;
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|next
operator|=
name|vtophys
argument_list|(
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|snext
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|snext
operator|=
operator|&
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
literal|0
index|]
expr_stmt|;
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|next
operator|=
name|vtophys
argument_list|(
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|snext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|snext
operator|=
operator|&
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|next
operator|=
name|vtophys
argument_list|(
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|snext
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|snext
operator|=
operator|&
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|next
operator|=
name|vtophys
argument_list|(
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|snext
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|status
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|m
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|data
operator|=
literal|0
expr_stmt|;
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_WAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
goto|goto
name|errfree
goto|;
name|MCLGET
argument_list|(
name|m
argument_list|,
name|M_WAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* We've waited mbuf_wait and still got nothing. 			   We're calling with M_TRYWAIT anyway - a little 			   defensive programming costs us very little - if 			   anything at all in the case of error. */
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|errfree
goto|;
block|}
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|m
operator|=
name|m
expr_stmt|;
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|data
operator|=
name|vtophys
argument_list|(
name|m
operator|->
name|m_data
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|status
operator|=
literal|1600
expr_stmt|;
comment|/* MTU */
block|}
name|sch
operator|->
name|tx_last_md
operator|=
name|sch
operator|->
name|tx_next_md
operator|=
operator|&
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
literal|0
index|]
expr_stmt|;
comment|/* Configure it into the chip */
name|sc
operator|->
name|ram
operator|->
name|thp
index|[
name|ch
index|]
operator|=
name|vtophys
argument_list|(
operator|&
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|tmp
index|[
name|ch
index|]
operator|=
name|vtophys
argument_list|(
operator|&
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|rhp
index|[
name|ch
index|]
operator|=
name|vtophys
argument_list|(
operator|&
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|rmp
index|[
name|ch
index|]
operator|=
name|vtophys
argument_list|(
operator|&
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* Activate the Channel */
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x0800
operator|+
name|ch
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con4"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x0820
operator|+
name|ch
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con3"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|errfree
label|:
while|while
condition|(
name|i
operator|>
literal|0
condition|)
block|{
comment|/* Don't leak all the previously allocated mbufs in this loop */
name|i
operator|--
expr_stmt|;
name|m_free
argument_list|(
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|m
argument_list|)
expr_stmt|;
block|}
name|FREE
argument_list|(
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
argument_list|,
name|M_MUSYCC
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
argument_list|,
name|M_MUSYCC
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|musycc_disconnect
parameter_list|(
name|hook_p
name|hook
parameter_list|)
block|{
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|csoftc
modifier|*
name|csc
decl_stmt|;
name|struct
name|schan
modifier|*
name|sch
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ch
decl_stmt|;
name|sch
operator|=
name|hook
operator|->
name|private
expr_stmt|;
name|sc
operator|=
name|sch
operator|->
name|sc
expr_stmt|;
name|csc
operator|=
name|sc
operator|->
name|csc
expr_stmt|;
name|ch
operator|=
name|sch
operator|->
name|chan
expr_stmt|;
while|while
condition|(
name|csc
operator|->
name|state
operator|!=
name|C_RUNNING
condition|)
name|tsleep
argument_list|(
operator|&
name|csc
operator|->
name|state
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"crun"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
comment|/* Deactivate the channel */
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x0900
operator|+
name|sch
operator|->
name|chan
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con3"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x0920
operator|+
name|sch
operator|->
name|chan
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|sc
operator|->
name|last
argument_list|,
name|PZERO
operator|+
name|PCATCH
argument_list|,
literal|"con4"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|sch
operator|->
name|state
operator|==
name|DOWN
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sch
operator|->
name|state
operator|=
name|DOWN
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|thp
index|[
name|ch
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|tmp
index|[
name|ch
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|rhp
index|[
name|ch
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|rmp
index|[
name|ch
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sch
operator|->
name|nmd
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|m
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|m
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
index|[
name|i
index|]
operator|.
name|m
argument_list|)
expr_stmt|;
block|}
name|FREE
argument_list|(
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
argument_list|,
name|M_MUSYCC
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mdt
index|[
name|ch
index|]
operator|=
name|NULL
expr_stmt|;
name|FREE
argument_list|(
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
argument_list|,
name|M_MUSYCC
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mdr
index|[
name|ch
index|]
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sch
operator|->
name|ts
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|sc
operator|->
name|ram
operator|->
name|rtsm
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|ram
operator|->
name|ttsm
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|sc
operator|->
name|nhooks
operator|--
expr_stmt|;
name|sch
operator|->
name|tx_pending
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * PCI initialization stuff  */
end_comment

begin_function
specifier|static
name|int
name|musycc_probe
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|char
name|desc
index|[
literal|40
index|]
decl_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|groupr
argument_list|)
operator|!=
literal|1572
condition|)
block|{
name|printf
argument_list|(
literal|"sizeof(struct groupr) = %d, should be 1572\n"
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|groupr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|globalr
argument_list|)
operator|!=
literal|1572
condition|)
block|{
name|printf
argument_list|(
literal|"sizeof(struct globalr) = %d, should be 1572\n"
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|globalr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
expr|struct
name|mycg
argument_list|)
operator|>
literal|2048
condition|)
block|{
name|printf
argument_list|(
literal|"sizeof(struct mycg) = %d, should be<= 2048\n"
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mycg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
switch|switch
condition|(
name|pci_get_devid
argument_list|(
name|self
argument_list|)
condition|)
block|{
case|case
literal|0x8471109e
case|:
name|strcpy
argument_list|(
name|desc
argument_list|,
literal|"CN8471 MUSYCC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8472109e
case|:
name|strcpy
argument_list|(
name|desc
argument_list|,
literal|"CN8472 MUSYCC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8474109e
case|:
name|strcpy
argument_list|(
name|desc
argument_list|,
literal|"CN8474 MUSYCC"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8478109e
case|:
name|strcpy
argument_list|(
name|desc
argument_list|,
literal|"CN8478 MUSYCC"
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
switch|switch
condition|(
name|pci_get_function
argument_list|(
name|self
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|strcat
argument_list|(
name|desc
argument_list|,
literal|" Network controller"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|strcat
argument_list|(
name|desc
argument_list|,
literal|" Ebus bridge"
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|device_set_desc_copy
argument_list|(
name|self
argument_list|,
name|desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|musycc_attach
parameter_list|(
name|device_t
name|self
parameter_list|)
block|{
name|struct
name|csoftc
modifier|*
name|csc
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
decl_stmt|;
name|struct
name|softc
modifier|*
name|sc
decl_stmt|;
name|int
name|rid
decl_stmt|,
name|i
decl_stmt|,
name|error
decl_stmt|;
name|int
name|f
decl_stmt|;
name|u_int32_t
modifier|*
name|u32p
decl_stmt|,
name|u
decl_stmt|;
specifier|static
name|int
name|once
decl_stmt|;
if|if
condition|(
operator|!
name|once
condition|)
block|{
name|once
operator|++
expr_stmt|;
name|error
operator|=
name|ng_newtype
argument_list|(
operator|&
name|ngtypestruct
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"ng_newtype() failed %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"We have %d pad bytes in mycg\n"
argument_list|,
literal|2048
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|mycg
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|=
name|pci_get_function
argument_list|(
name|self
argument_list|)
expr_stmt|;
comment|/* For function zero allocate a csoftc */
if|if
condition|(
name|f
operator|==
literal|0
condition|)
block|{
name|MALLOC
argument_list|(
name|csc
argument_list|,
expr|struct
name|csoftc
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|csc
argument_list|)
argument_list|,
name|M_MUSYCC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|csc
operator|->
name|bus
operator|=
name|pci_get_bus
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|csc
operator|->
name|slot
operator|=
name|pci_get_slot
argument_list|(
name|self
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|sc_list
argument_list|,
name|csc
argument_list|,
name|list
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LIST_FOREACH
argument_list|(
argument|csc
argument_list|,
argument|&sc_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|csc
operator|->
name|bus
operator|!=
name|pci_get_bus
argument_list|(
name|self
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|csc
operator|->
name|slot
operator|!=
name|pci_get_slot
argument_list|(
name|self
argument_list|)
condition|)
continue|continue;
break|break;
block|}
block|}
name|csc
operator|->
name|f
index|[
name|f
index|]
operator|=
name|self
expr_stmt|;
name|device_set_softc
argument_list|(
name|self
argument_list|,
name|csc
argument_list|)
expr_stmt|;
name|rid
operator|=
name|PCIR_MAPS
expr_stmt|;
name|res
operator|=
name|bus_alloc_resource
argument_list|(
name|self
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|self
argument_list|,
literal|"Could not map memory\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|csc
operator|->
name|virbase
index|[
name|f
index|]
operator|=
operator|(
name|u_char
operator|*
operator|)
name|rman_get_virtual
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|csc
operator|->
name|physbase
index|[
name|f
index|]
operator|=
name|rman_get_start
argument_list|(
name|res
argument_list|)
expr_stmt|;
comment|/* Allocate interrupt */
name|rid
operator|=
literal|0
expr_stmt|;
name|csc
operator|->
name|irq
index|[
name|f
index|]
operator|=
name|bus_alloc_resource
argument_list|(
name|self
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|csc
operator|->
name|irq
index|[
name|f
index|]
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"couldn't map interrupt\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|self
argument_list|,
name|csc
operator|->
name|irq
index|[
name|f
index|]
argument_list|,
name|INTR_TYPE_NET
argument_list|,
name|f
operator|==
literal|0
condition|?
name|musycc_intr0
else|:
name|musycc_intr1
argument_list|,
name|csc
argument_list|,
operator|&
name|csc
operator|->
name|intrhand
index|[
name|f
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"couldn't set up irq\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|f
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"f%d: device %p virtual %p physical %08x\n"
argument_list|,
name|i
argument_list|,
name|csc
operator|->
name|f
index|[
name|i
index|]
argument_list|,
name|csc
operator|->
name|virbase
index|[
name|i
index|]
argument_list|,
name|csc
operator|->
name|physbase
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|csc
operator|->
name|reg
operator|=
operator|(
expr|struct
name|globalr
operator|*
operator|)
name|csc
operator|->
name|virbase
index|[
literal|0
index|]
expr_stmt|;
name|csc
operator|->
name|reg
operator|->
name|glcd
operator|=
literal|0x3f30
expr_stmt|;
comment|/* XXX: designer magic */
name|u32p
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|csc
operator|->
name|virbase
index|[
literal|1
index|]
expr_stmt|;
name|u
operator|=
name|u32p
index|[
literal|0x1200
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|u
operator|&
literal|0xffff0000
operator|)
operator|!=
literal|0x13760000
condition|)
block|{
name|printf
argument_list|(
literal|"Not a LMC1504 (ID is 0x%08x).  Bailing out.\n"
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|csc
operator|->
name|nchan
operator|=
operator|(
name|u
operator|>>
literal|8
operator|)
operator|&
literal|0xf
expr_stmt|;
name|printf
argument_list|(
literal|"Found<LanMedia LMC1504 Rev %d Chan %d>\n"
argument_list|,
operator|(
name|u
operator|>>
literal|12
operator|)
operator|&
literal|0xf
argument_list|,
name|csc
operator|->
name|nchan
argument_list|)
expr_stmt|;
name|csc
operator|->
name|creg
operator|=
literal|0xfe
expr_stmt|;
name|csc
operator|->
name|cregp
operator|=
operator|&
name|u32p
index|[
literal|0x1000
index|]
expr_stmt|;
operator|*
name|csc
operator|->
name|cregp
operator|=
name|csc
operator|->
name|creg
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|csc
operator|->
name|nchan
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|=
operator|&
name|csc
operator|->
name|serial
index|[
name|i
index|]
expr_stmt|;
name|sc
operator|->
name|csc
operator|=
name|csc
expr_stmt|;
name|sc
operator|->
name|last
operator|=
literal|0xffffffff
expr_stmt|;
name|sc
operator|->
name|ds8370
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|csc
operator|->
name|virbase
index|[
literal|1
index|]
operator|+
name|i
operator|*
literal|0x800
operator|)
expr_stmt|;
name|sc
operator|->
name|ds847x
operator|=
name|csc
operator|->
name|virbase
index|[
literal|0
index|]
operator|+
name|i
operator|*
literal|0x800
expr_stmt|;
name|sc
operator|->
name|reg
operator|=
operator|(
expr|struct
name|globalr
operator|*
operator|)
operator|(
name|csc
operator|->
name|virbase
index|[
literal|0
index|]
operator|+
name|i
operator|*
literal|0x800
operator|)
expr_stmt|;
name|MALLOC
argument_list|(
name|sc
operator|->
name|mycg
argument_list|,
expr|struct
name|mycg
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mycg
argument_list|)
argument_list|,
name|M_MUSYCC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ram
operator|=
operator|&
name|sc
operator|->
name|mycg
operator|->
name|cg
expr_stmt|;
name|error
operator|=
name|ng_make_node_common
argument_list|(
operator|&
name|ngtypestruct
argument_list|,
operator|&
name|sc
operator|->
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ng_make_node_common() failed %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|sc
operator|->
name|node
operator|->
name|private
operator|=
name|sc
expr_stmt|;
name|sprintf
argument_list|(
name|sc
operator|->
name|nodename
argument_list|,
literal|"sync-%d-%d-%d"
argument_list|,
name|csc
operator|->
name|bus
argument_list|,
name|csc
operator|->
name|slot
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|error
operator|=
name|ng_name_node
argument_list|(
name|sc
operator|->
name|node
argument_list|,
name|sc
operator|->
name|nodename
argument_list|)
expr_stmt|;
comment|/* XXX Apparently failure isn't a problem */
block|}
name|csc
operator|->
name|ram
operator|=
operator|(
expr|struct
name|globalr
operator|*
operator|)
operator|&
name|csc
operator|->
name|serial
index|[
literal|0
index|]
operator|.
name|mycg
operator|->
name|cg
expr_stmt|;
name|sc
operator|=
operator|&
name|csc
operator|->
name|serial
index|[
literal|0
index|]
expr_stmt|;
name|sc
operator|->
name|reg
operator|->
name|srd
operator|=
name|sc
operator|->
name|last
operator|=
literal|0x100
expr_stmt|;
name|csc
operator|->
name|state
operator|=
name|C_IDLE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|musycc_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|musycc_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|musycc_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|bus_generic_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|bus_generic_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|bus_generic_shutdown
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|musycc_driver
init|=
block|{
literal|"musycc"
block|,
name|musycc_methods
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|musycc
argument_list|,
name|pci
argument_list|,
name|musycc_driver
argument_list|,
name|musycc_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  *******************************************************************************/
end_comment

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_PMC_OSTI
argument_list|,
literal|"osti_cacheable"
argument_list|,
literal|"allocated from ostiAllocMemory as cacheable memory"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/****************************************************************************** ostiAllocMemory() Purpose:   TD layer calls to get dma memory Parameters:    tiRoot_t *ptiRoot (IN)            Pointer refers to the current root     void **osMemHandle (IN_OUT)       Pointer To OS Mem handle to fill in   void **agVirtAddr (IN_OUT)        Pointer to allocated memory address   U32  *agPhysUpper32 (IN_OUT)      Pointer to Up 32 bit mem phys addr.   U32  *agPhysLower32 (IN_OUT)      Pointer to low 32 bit mem phys addr.   U32  alignment (IN)               Alignment requirement   U32  allocLength (IN)             Required memory length   agBOOLEAN isChacheable (IN)       Required memory type Return:   tiSuccess - success   tiMemoryTooLarge - requested memory size too large   tiMemoryNotAvail - no dma memory available  Note:   for sata use.   where a cacheable allocation inherently may be swapped, the values    agPhysUpper32 and agPhysLower32 are understood to mean nothing when the    value isCacheable is set to true.  these phys values must not be used by    the caller. ******************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|U32
name|ostiAllocMemory
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|void
modifier|*
modifier|*
name|osMemHandle
parameter_list|,
name|void
modifier|*
modifier|*
name|agVirtAddr
parameter_list|,
name|U32
modifier|*
name|agPhysUpper32
parameter_list|,
name|U32
modifier|*
name|agPhysLower32
parameter_list|,
name|U32
name|alignment
parameter_list|,
name|U32
name|allocLength
parameter_list|,
name|agBOOLEAN
name|isCacheable
parameter_list|)
block|{
name|ag_card_info_t
modifier|*
name|pCardInfo
init|=
name|TIROOT_TO_CARDINFO
argument_list|(
name|ptiRoot
argument_list|)
decl_stmt|;
name|ag_dma_addr_t
modifier|*
name|pMem
decl_stmt|;
name|struct
name|agtiapi_softc
modifier|*
name|pCard
decl_stmt|;
name|pCard
operator|=
name|TIROOT_TO_CARD
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
name|AGTIAPI_PRINTK
argument_list|(
literal|"ostiAllocMemory: debug, cache? %d size %d alloc algn %d ### \n"
argument_list|,
name|isCacheable
argument_list|,
name|allocLength
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
if|if
condition|(
name|pCardInfo
operator|->
name|topOfFreeDynamicMem
operator|==
literal|0
condition|)
block|{
name|AGTIAPI_PRINTK
argument_list|(
literal|"ostiAllocMemory: No space left, increase "
literal|"AGTIAPI_DYNAMIC_MAX! ERROR\n"
argument_list|)
expr_stmt|;
return|return
name|tiMemoryNotAvail
return|;
block|}
name|pMem
operator|=
name|pCardInfo
operator|->
name|freeDynamicMem
index|[
name|pCardInfo
operator|->
name|topOfFreeDynamicMem
operator|-
literal|1
index|]
expr_stmt|;
comment|// where this memory has bee preallocated, be sure requirements do not
comment|//  exceed the limits of resources available
if|if
condition|(
name|allocLength
operator|>
literal|4096
condition|)
block|{
name|AGTIAPI_PRINTK
argument_list|(
literal|"ostiAllocMemory: no-cache size 0x%x alloc NOT AVAILABLE\n"
argument_list|,
name|allocLength
argument_list|)
expr_stmt|;
return|return
name|tiMemoryNotAvail
return|;
block|}
if|if
condition|(
name|alignment
operator|>
literal|32
condition|)
block|{
name|AGTIAPI_PRINTK
argument_list|(
literal|"ostiAllocMemory: no-cache alignment 0x%x NOT AVAILABLE\n"
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
return|return
name|tiMemoryNotAvail
return|;
block|}
name|pMem
operator|->
name|dmaPhysAddr
operator|=
name|pMem
operator|->
name|nocache_busaddr
expr_stmt|;
name|pMem
operator|->
name|dmaVirtAddr
operator|=
name|pMem
operator|->
name|nocache_mem
expr_stmt|;
name|pMem
operator|->
name|memSize
operator|=
name|allocLength
expr_stmt|;
operator|*
name|agVirtAddr
operator|=
name|pMem
operator|->
name|dmaVirtAddr
expr_stmt|;
operator|*
name|agPhysUpper32
operator|=
name|HIGH_32_BITS
argument_list|(
name|pMem
operator|->
name|dmaPhysAddr
argument_list|)
expr_stmt|;
operator|*
name|agPhysLower32
operator|=
name|LOW_32_BITS
argument_list|(
name|pMem
operator|->
name|dmaPhysAddr
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|pCard
operator|->
name|memLock
argument_list|)
expr_stmt|;
name|pCardInfo
operator|->
name|topOfFreeDynamicMem
operator|--
expr_stmt|;
operator|*
name|osMemHandle
operator|=
operator|(
name|void
operator|*
operator|)
name|pMem
expr_stmt|;
comment|// virtAddr;
name|mtx_unlock
argument_list|(
operator|&
name|pCard
operator|->
name|memLock
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiIOCTLWaitForSignal()   Purpose:   Function to wait semaphore during ioctl Parameters:    tiRoot_t *ptiRoot (IN)     Pointer to the current HBA     void **agParam1 (IN_OUT)   Pointer to context to be passed   void **agParam2 (IN_OUT)   Pointer to context to be passed   void **agParam (IN_OUT)    Pointer to context to be passed Return: Note:  ******************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiIOCTLWaitForSignal
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|struct
name|agtiapi_softc
modifier|*
name|pCard
decl_stmt|;
name|pCard
operator|=
name|TIROOT_TO_CARD
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
name|pCard
operator|->
name|down_count
operator|++
expr_stmt|;
name|sema_wait
argument_list|(
name|pCard
operator|->
name|pIoctlSem
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Below function has to be changed to use wait for completion */
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiIOCTLWaitForComplete
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|struct
name|agtiapi_softc
modifier|*
name|pCard
decl_stmt|;
name|pCard
operator|=
name|TIROOT_TO_CARD
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
name|pCard
operator|->
name|down_count
operator|++
expr_stmt|;
name|sema_wait
argument_list|(
name|pCard
operator|->
name|pIoctlSem
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiChipConfigReadBit32() Purpose:   Read 32-bit value from PCI configuration register Parameters:   tiRoot_t *ptiRoot (IN)     Pointer to tiRoot structure   U32 chipConfigOffset (IN)  Offset to PCI configuration register Return:   32 bit data ******************************************************************************/
end_comment

begin_function
name|U32
name|ostiChipConfigReadBit32
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|U32
name|chipConfigOffset
parameter_list|)
block|{
name|device_t
name|lDev
init|=
name|TIROOT_TO_PCIDEV
argument_list|(
name|ptiRoot
argument_list|)
decl_stmt|;
name|u_int32_t
name|lData
init|=
literal|0
decl_stmt|;
name|lData
operator|=
name|pci_read_config
argument_list|(
name|lDev
argument_list|,
name|chipConfigOffset
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
operator|(
name|U32
operator|)
name|lData
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiChipConfigWriteBit32() Purpose:   Write 32-bit value to PCI configuration register Parameters:   tiRoot_t *ptiRoot (IN)     Pointer to tiRoot structure   U32 chipConfigOffset (IN)  Offset to PCI configuration register       U32 chipConfigValue (IN)   Value to be written Return: none ******************************************************************************/
end_comment

begin_function
name|void
name|ostiChipConfigWriteBit32
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|U32
name|chipConfigOffset
parameter_list|,
name|U32
name|chipConfigValue
parameter_list|)
block|{
name|device_t
name|lDev
init|=
name|TIROOT_TO_PCIDEV
argument_list|(
name|ptiRoot
argument_list|)
decl_stmt|;
name|pci_write_config
argument_list|(
name|lDev
argument_list|,
name|chipConfigOffset
argument_list|,
name|chipConfigValue
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiChipReadBit32() Purpose:   Read 32-bit value from PCI address register Parameters:   tiRoot_t *ptiRoot (IN)  Pointer to tiRoot structure   U32 chipOffset (IN)     Offset to PCI configuration register     Return:   32 bit data ******************************************************************************/
end_comment

begin_function
name|U32
name|ostiChipReadBit32
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|U32
name|chipOffset
parameter_list|)
block|{
name|U32
name|data
decl_stmt|;
name|ag_card_info_t
modifier|*
name|pCardInfo
decl_stmt|;
name|pCardInfo
operator|=
name|TIROOT_TO_CARDINFO
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
name|data
operator|=
operator|*
operator|(
name|U32
operator|*
operator|)
operator|(
name|pCardInfo
operator|->
name|pciMemVirtAddr
operator|+
name|chipOffset
operator|)
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiChipWriteBit32() Purpose:   Write 32-bit value to PCI address register Parameters:   tiRoot_t *ptiRoot (IN)  Pointer to tiRoot structure   U32 chipOffset (IN)     Offset to PCI configuration register       U32 chipValue (IN)      Value to be written Return: none ******************************************************************************/
end_comment

begin_function
name|void
name|ostiChipWriteBit32
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|U32
name|chipOffset
parameter_list|,
name|U32
name|chipValue
parameter_list|)
block|{
name|ag_card_info_t
modifier|*
name|pCardInfo
decl_stmt|;
name|pCardInfo
operator|=
name|TIROOT_TO_CARDINFO
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
operator|*
operator|(
name|U32
operator|*
operator|)
operator|(
name|pCardInfo
operator|->
name|pciMemVirtAddr
operator|+
name|chipOffset
operator|)
operator|=
name|chipValue
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiChipReadBit32Ext() Purpose:   Read 32-bit value from PCI address register Parameters:   tiRoot_t *ptiRoot (IN)  Pointer to tiRoot structure   busBaseNumber            PCI BAR number   U32 chipOffset (IN)     Offset to PCI configuration register     Return:   32 bit data ******************************************************************************/
end_comment

begin_function
name|U32
name|ostiChipReadBit32Ext
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|U32
name|busBaseNumber
parameter_list|,
name|U32
name|chipOffset
parameter_list|)
block|{
name|U32
name|data
decl_stmt|;
name|ag_card_info_t
modifier|*
name|pCardInfo
decl_stmt|;
name|pCardInfo
operator|=
name|TIROOT_TO_CARDINFO
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
name|data
operator|=
operator|*
operator|(
name|U32
operator|*
operator|)
operator|(
operator|(
name|pCardInfo
operator|->
name|pciMemVirtAddrSpc
index|[
name|busBaseNumber
index|]
operator|)
operator|+
name|chipOffset
operator|)
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiChipWriteBit32Ext() Purpose:   Write 32-bit value to PCI address register Parameters:   tiRoot_t *ptiRoot (IN)  Pointer to tiRoot structure   busBaseNumber           PCI BAR number     U32 chipOffset (IN)     Offset to PCI configuration register       U32 chipValue (IN)      Value to be written Return: none ******************************************************************************/
end_comment

begin_function
name|void
name|ostiChipWriteBit32Ext
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|U32
name|busBaseNumber
parameter_list|,
name|U32
name|chipOffset
parameter_list|,
name|U32
name|aData
parameter_list|)
block|{
name|ag_card_info_t
modifier|*
name|pCardInfo
decl_stmt|;
name|pCardInfo
operator|=
name|TIROOT_TO_CARDINFO
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
operator|*
operator|(
name|U32
operator|*
operator|)
operator|(
operator|(
name|pCardInfo
operator|->
name|pciMemVirtAddrSpc
index|[
name|busBaseNumber
index|]
operator|)
operator|+
name|chipOffset
operator|)
operator|=
name|aData
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiChipReadBit8() Purpose:   Read 8-bit value from PCI address register Parameters:   tiRoot_t *ptiRoot (IN)  Pointer to tiRoot structure   U32 chipOffset (IN)     Offset to PCI configuration register     Return:   8 bit data ******************************************************************************/
end_comment

begin_function
name|U08
name|ostiChipReadBit8
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|U32
name|chipOffset
parameter_list|)
block|{
name|ag_card_info_t
modifier|*
name|pCardInfo
decl_stmt|;
name|pCardInfo
operator|=
name|TIROOT_TO_CARDINFO
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
return|return
operator|*
operator|(
name|U08
operator|*
operator|)
operator|(
name|pCardInfo
operator|->
name|pciMemVirtAddr
operator|+
name|chipOffset
operator|)
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiChipWriteBit8() Purpose:   Write 8-bit value to PCI address register Parameters:   tiRoot_t *ptiRoot (IN)  Pointer to tiRoot structure   U32 chipOffset (IN)     Offset to PCI configuration register       U8 chipValue (IN)       Value to be written Return: none ******************************************************************************/
end_comment

begin_function
name|void
name|ostiChipWriteBit8
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|U32
name|chipOffset
parameter_list|,
name|U08
name|chipValue
parameter_list|)
block|{
name|ag_card_info_t
modifier|*
name|pCardInfo
decl_stmt|;
name|pCardInfo
operator|=
name|TIROOT_TO_CARDINFO
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
operator|*
operator|(
name|U08
operator|*
operator|)
operator|(
name|pCardInfo
operator|->
name|pciMemVirtAddr
operator|+
name|chipOffset
operator|)
operator|=
name|chipValue
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ostiFlashReadBlock
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|U32
name|offset
parameter_list|,
name|void
modifier|*
name|bufPtr
parameter_list|,
name|U32
name|nbytes
parameter_list|)
block|{
name|AGTIAPI_PRINTK
argument_list|(
literal|"ostiFlashReadBlock: No support for iscsi device\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiFreeMemory() Purpose:   TD layer calls to free allocated dma memory Parameters:    tiRoot_t *ptiRoot (IN)  Pointer refers to the current root     void *osMemHandle (IN)  Pointer to OS mem handle to be released   u32  allocLength (IN)   Aloocated memory length in byte Return:   tiSuccess       - success   tiInvalidHandle - handle is invalid ******************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|U32
name|ostiFreeMemory
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|void
modifier|*
name|osMemHandle
parameter_list|,
name|U32
name|allocLength
parameter_list|)
block|{
name|ag_card_info_t
modifier|*
name|pCardInfo
init|=
name|TIROOT_TO_CARDINFO
argument_list|(
name|ptiRoot
argument_list|)
decl_stmt|;
name|ag_dma_addr_t
modifier|*
name|pMem
init|=
operator|(
name|ag_dma_addr_t
operator|*
operator|)
name|osMemHandle
decl_stmt|;
name|struct
name|agtiapi_softc
modifier|*
name|pCard
decl_stmt|;
name|pCard
operator|=
name|TIROOT_TO_CARD
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|osMemHandle
condition|)
block|{
name|AGTIAPI_PRINTK
argument_list|(
literal|"ostiFreeMemory: NULL handle ERROR\n"
argument_list|)
expr_stmt|;
return|return
name|tiInvalidHandle
return|;
block|}
name|AGTIAPI_PRINTK
argument_list|(
literal|"ostiFreeMemory: debug messsage %p ### \n"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pMem
operator|->
name|dmaPhysAddr
argument_list|)
expr_stmt|;
comment|// mark as unused
name|pMem
operator|->
name|memSize
operator|=
literal|0
expr_stmt|;
name|pMem
operator|->
name|dmaVirtAddr
operator|=
name|NULL
expr_stmt|;
name|pMem
operator|->
name|dmaPhysAddr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pCardInfo
operator|->
name|topOfFreeDynamicMem
operator|==
name|AGTIAPI_DYNAMIC_MAX
condition|)
block|{
name|AGTIAPI_PRINTK
argument_list|(
literal|"ostiFreeMemory: too many free slots ERROR\n"
argument_list|)
expr_stmt|;
return|return
name|tiInvalidHandle
return|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|pCard
operator|->
name|memLock
argument_list|)
expr_stmt|;
name|pCardInfo
operator|->
name|freeDynamicMem
index|[
name|pCardInfo
operator|->
name|topOfFreeDynamicMem
operator|++
index|]
operator|=
name|pMem
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|pCard
operator|->
name|memLock
argument_list|)
expr_stmt|;
return|return
name|tiSuccess
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiMakeParamString() Purpose:   Utility function to simplify flow in ostiGetTransportParam().  Produces   a string handle constructed from ostiGetTransportParam() values:   key, subkey1, subkey2, subkey3, subkey4, subkey5, and valueName. Parameters:   S08 *aKey (IN)             Pointer to 1st level parameter string   S08 *aSubkey1 (IN)         Pointer to 2nd level parameter string   S08 *aSubkey2 (IN)         Pointer to 3rd level parameter string   S08 *aSubkey3 (IN)         Pointer to 4th level parameter string   S08 *aSubkey4 (IN)         Pointer to 5th level parameter string   S08 *aSubkey5 (IN)         Pointer to 6th level parameter string   S08 *aValueName (IN)       Pointer to name string of the value under keys   S08 *aFullKey (OUT)        Pointer to returned key-value-handle buffer   U32 *apLenFullKey (OUT)    String length in the key-value-handle buffer Return:   tiSuccess - Success   tiError   - Failed Note:   If all input strings are NULL, tiError will return with zero in apLenFullKey *****************************************************************************/
end_comment

begin_function
specifier|inline
specifier|static
name|U32
name|ostiMakeParamString
parameter_list|(
name|S08
modifier|*
name|aKey
parameter_list|,
name|S08
modifier|*
name|aSubkey1
parameter_list|,
name|S08
modifier|*
name|aSubkey2
parameter_list|,
name|S08
modifier|*
name|aSubkey3
parameter_list|,
name|S08
modifier|*
name|aSubkey4
parameter_list|,
name|S08
modifier|*
name|aSubkey5
parameter_list|,
name|S08
modifier|*
name|aValueName
parameter_list|,
name|S08
modifier|*
name|aFullKey
parameter_list|,
name|U32
modifier|*
name|apLenFullKey
parameter_list|)
block|{
comment|// preliminary sanity checks
if|if
condition|(
name|agNULL
operator|==
name|aKey
condition|)
block|{
operator|*
name|apLenFullKey
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"ostiGetTransportParam called with no key.  how odd.\n"
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
if|if
condition|(
name|agNULL
operator|==
name|aValueName
condition|)
block|{
operator|*
name|apLenFullKey
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"ostiGetTransportParam called with no value-name.  how odd.\n"
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
block|}
name|strcpy
argument_list|(
name|aFullKey
argument_list|,
literal|"DPMC_"
argument_list|)
expr_stmt|;
comment|// start at the beginning of the string
name|strcat
argument_list|(
name|aFullKey
argument_list|,
name|aKey
argument_list|)
expr_stmt|;
name|int
name|lIdx
decl_stmt|;
name|S08
modifier|*
name|lStrIdx
init|=
name|agNULL
decl_stmt|;
for|for
control|(
name|lIdx
operator|=
literal|1
init|;
name|lIdx
operator|<=
literal|5
condition|;
name|lIdx
operator|++
control|)
block|{
if|if
condition|(
literal|1
operator|==
name|lIdx
condition|)
name|lStrIdx
operator|=
name|aSubkey1
expr_stmt|;
if|if
condition|(
literal|2
operator|==
name|lIdx
condition|)
name|lStrIdx
operator|=
name|aSubkey2
expr_stmt|;
if|if
condition|(
literal|3
operator|==
name|lIdx
condition|)
name|lStrIdx
operator|=
name|aSubkey3
expr_stmt|;
if|if
condition|(
literal|4
operator|==
name|lIdx
condition|)
name|lStrIdx
operator|=
name|aSubkey4
expr_stmt|;
if|if
condition|(
literal|5
operator|==
name|lIdx
condition|)
name|lStrIdx
operator|=
name|aSubkey5
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|lStrIdx
condition|)
break|break;
comment|// no more key information
comment|// append key information
name|strcat
argument_list|(
name|aFullKey
argument_list|,
literal|"_"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|aFullKey
argument_list|,
name|lStrIdx
argument_list|)
expr_stmt|;
block|}
comment|// only the value name is left to append
name|strcat
argument_list|(
name|aFullKey
argument_list|,
literal|"_"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|aFullKey
argument_list|,
name|aValueName
argument_list|)
expr_stmt|;
operator|*
name|apLenFullKey
operator|=
name|strlen
argument_list|(
name|aFullKey
argument_list|)
expr_stmt|;
comment|// 58 is max len seen; June 11, 2012
comment|// printf( "ostiMakeParamString: x%d out-str:%s\n", // debug print
comment|//        *apLenFullKey, aFullKey );
return|return
name|tiSuccess
return|;
comment|// ship it chief
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiGetTransportParam() Purpose:   Call back function from lower layer to get parameters. Parameters:   tiRoot_t *ptiRoot (IN)     Pointer to driver root data structure   S08 *key (IN)              Pointer to 1st level parameter   S08 *subkey1 (IN)          Pointer to 2nd level parameter   S08 *subkey2 (IN)          Pointer to 3rd level parameter   S08 *subkey3 (IN)          Pointer to 4th level parameter   S08 *subkey4 (IN)          Pointer to 5th level parameter   S08 *subkey5 (IN)          Pointer to 6th level parameter   S08 *valueName (IN)        Pointer to name of the value under keys   S08 *buffer (OUT)          Pointer to returned information buffer   U32 bufferLen (OUT)        Buffer length   U32 *lenReceived (OUT)     String length in the buffer Return:   tiSuccess - Success   Other     - Failed Note:   The scheme of searching adjustable parameter tree is the following:   key     - subkey1       - subkey2         - subkey3           - subkey4             - subkey5               - value   If no match in any case, tiError will return with zero length.    Where there is no indication of max key and subkey length,   an upper limit guess of 200 is used.   Perhaps a prudent revision would be to add some argument(s) to be   able to manage/check these "key" string lengths.   This function does no checking of buffer being a valid pointer. *****************************************************************************/
end_comment

begin_function
name|U32
name|ostiGetTransportParam
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|S08
modifier|*
name|key
parameter_list|,
name|S08
modifier|*
name|subkey1
parameter_list|,
name|S08
modifier|*
name|subkey2
parameter_list|,
name|S08
modifier|*
name|subkey3
parameter_list|,
name|S08
modifier|*
name|subkey4
parameter_list|,
name|S08
modifier|*
name|subkey5
parameter_list|,
name|S08
modifier|*
name|valueName
parameter_list|,
name|S08
modifier|*
name|buffer
parameter_list|,
name|U32
name|bufferLen
parameter_list|,
name|U32
modifier|*
name|lenReceived
parameter_list|)
block|{
name|S08
name|lFullKey
index|[
literal|200
index|]
decl_stmt|;
name|U32
name|lLenFullKey
init|=
literal|0
decl_stmt|;
operator|*
name|lenReceived
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bufferLen
operator|>
literal|1
condition|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
literal|""
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"ostiGetTransportParam: buffer too small at only %d"
argument_list|,
name|bufferLen
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
comment|// not a reasonable buffer to work with
block|}
name|ostiMakeParamString
argument_list|(
name|key
argument_list|,
name|subkey1
argument_list|,
name|subkey2
argument_list|,
name|subkey3
argument_list|,
name|subkey4
argument_list|,
name|subkey5
argument_list|,
name|valueName
argument_list|,
name|lFullKey
argument_list|,
operator|&
name|lLenFullKey
argument_list|)
expr_stmt|;
if|if
condition|(
name|lLenFullKey
condition|)
comment|// clean ParamString extraction
name|TUNABLE_STR_FETCH
argument_list|(
name|lFullKey
argument_list|,
name|buffer
argument_list|,
name|bufferLen
argument_list|)
expr_stmt|;
else|else
return|return
name|tiError
return|;
comment|// not working out, bail now
operator|*
name|lenReceived
operator|=
name|strlen
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
comment|//if( *lenReceived ) // handy debug print
comment|//  printf( "ostiGetTransportParam: sz%d val:%s hdl-str:%s\n",
comment|//          *lenReceived, buffer, lFullKey );
return|return
name|tiSuccess
return|;
comment|// ship it chief
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiIOCTLClearSignal()  Purpose:   Function to clear or reset semaphore during ioctl Parameters:    tiRoot_t *ptiRoot (IN)     Pointer to the current HBA     void **agParam1 (IN_OUT)   Pointer to context to be passed   void **agParam2 (IN_OUT)   Pointer to context to be passed   void **agParam (IN_OUT)    Pointer to context to be passed Return: Note:       TBD, need more work for card based semaphore.  Also needs to    consider the calling sequence. ******************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiIOCTLClearSignal
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|void
modifier|*
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
modifier|*
name|agParam3
parameter_list|)
block|{ }
end_function

begin_comment
comment|/****************************************************************************** ostiIOCTLSetSignal()  ### function currently stubbed out Purpose:   Function to set semaphore during ioctl Parameters:    tiRoot_t *ptiRoot (IN)     Pointer to the current HBA     void **agParam1 (IN_OUT)   Pointer to context to be passed   void **agParam2 (IN_OUT)   Pointer to context to be passed   void **agParam (IN_OUT)    Pointer to context to be passed Return: Note:     ******************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiIOCTLSetSignal
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|struct
name|agtiapi_softc
modifier|*
name|pCard
decl_stmt|;
name|pCard
operator|=
name|TIROOT_TO_CARD
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|pCard
operator|->
name|down_count
operator|!=
name|pCard
operator|->
name|up_count
condition|)
block|{
name|pCard
operator|->
name|up_count
operator|++
expr_stmt|;
name|sema_post
argument_list|(
name|pCard
operator|->
name|pIoctlSem
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ostiIOCTLComplete
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|void
modifier|*
name|agParam1
parameter_list|,
name|void
modifier|*
name|agParam2
parameter_list|,
name|void
modifier|*
name|agParam3
parameter_list|)
block|{
name|struct
name|agtiapi_softc
modifier|*
name|pCard
decl_stmt|;
name|pCard
operator|=
name|TIROOT_TO_CARD
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|pCard
operator|->
name|down_count
operator|!=
name|pCard
operator|->
name|up_count
condition|)
block|{
name|pCard
operator|->
name|up_count
operator|++
expr_stmt|;
name|sema_post
argument_list|(
name|pCard
operator|->
name|pIoctlSem
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiPortEvent() Purpose:   Call back function to inform OS the events of port state change. Parameters:   tiRoot_t *ptiRoot(IN)          Pointer to driver root data structure    tiPortEvent_t eventType (IN)   Type of port event:                                  tiPortPanic                                  tiPortResetComplete                                  tiPortNameServerDown                                  tiPortLinkDown                                  tiPortLinkUp                                  tiPortStarted                                  tiPortStopped                                  tiPortShutdown                                  tiPortInitComplete   void *pParm(IN)                Pointer to event specific structure Return:   None  ******************************************************************************/
end_comment

begin_function
name|void
name|ostiPortEvent
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|tiPortEvent_t
name|eventType
parameter_list|,
name|U32
name|status
parameter_list|,
name|void
modifier|*
name|pParm
parameter_list|)
block|{
name|struct
name|agtiapi_softc
modifier|*
name|pCard
decl_stmt|;
name|ag_portal_data_t
modifier|*
name|pPortalData
decl_stmt|;
name|AGTIAPI_PRINTK
argument_list|(
literal|"ostiPortEvent: start eventType 0x%x\n"
argument_list|,
name|eventType
argument_list|)
expr_stmt|;
name|pCard
operator|=
name|TIROOT_TO_CARD
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|eventType
condition|)
block|{
case|case
name|tiPortStarted
case|:
name|pCard
operator|->
name|flags
operator||=
name|AGTIAPI_CB_DONE
expr_stmt|;
name|pPortalData
operator|=
name|PORTAL_CONTEXT_TO_PORTALDATA
argument_list|(
name|pParm
argument_list|)
expr_stmt|;
name|PORTAL_STATUS
argument_list|(
name|pPortalData
argument_list|)
operator||=
name|AGTIAPI_PORT_START
expr_stmt|;
name|AGTIAPI_PRINTK
argument_list|(
literal|"PortStarted - portal %p, status %x\n"
argument_list|,
name|pPortalData
argument_list|,
name|PORTAL_STATUS
argument_list|(
name|pPortalData
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|tiPortLinkDown
case|:
name|pPortalData
operator|=
name|PORTAL_CONTEXT_TO_PORTALDATA
argument_list|(
name|pParm
argument_list|)
expr_stmt|;
name|PORTAL_STATUS
argument_list|(
name|pPortalData
argument_list|)
operator|&=
operator|~
name|AGTIAPI_PORT_LINK_UP
expr_stmt|;
name|AGTIAPI_PRINTK
argument_list|(
literal|"PortLinkDown - portal %p\n"
argument_list|,
name|pPortalData
argument_list|)
expr_stmt|;
break|break;
case|case
name|tiPortLinkUp
case|:
name|pPortalData
operator|=
name|PORTAL_CONTEXT_TO_PORTALDATA
argument_list|(
name|pParm
argument_list|)
expr_stmt|;
name|PORTAL_STATUS
argument_list|(
name|pPortalData
argument_list|)
operator||=
name|AGTIAPI_PORT_LINK_UP
expr_stmt|;
name|AGTIAPI_PRINTK
argument_list|(
literal|"PortLinkUp - portal %p\n"
argument_list|,
name|pPortalData
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
ifndef|#
directive|ifndef
name|HOTPLUG_SUPPORT
if|if
condition|(
operator|!
operator|(
name|pCard
operator|->
name|flags
operator|&
name|AGTIAPI_INIT_TIME
operator|)
condition|)
endif|#
directive|endif
comment|//         agtiapi_StartIO(pCard);
endif|#
directive|endif
break|break;
case|case
name|tiPortDiscoveryReady
case|:
name|pCard
operator|->
name|flags
operator||=
name|AGTIAPI_CB_DONE
expr_stmt|;
name|pPortalData
operator|=
name|PORTAL_CONTEXT_TO_PORTALDATA
argument_list|(
name|pParm
argument_list|)
expr_stmt|;
name|PORTAL_STATUS
argument_list|(
name|pPortalData
argument_list|)
operator||=
name|AGTIAPI_PORT_DISC_READY
expr_stmt|;
name|AGTIAPI_PRINTK
argument_list|(
literal|"PortDiscoveryReady - portal %p, status 0x%x\n"
argument_list|,
name|pPortalData
argument_list|,
name|PORTAL_STATUS
argument_list|(
name|pPortalData
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
ifndef|#
directive|ifndef
name|HOTPLUG_SUPPORT
if|if
condition|(
operator|!
operator|(
name|pCard
operator|->
name|flags
operator|&
name|AGTIAPI_INIT_TIME
operator|)
condition|)
endif|#
directive|endif
name|tiINIDiscoverTargets
argument_list|(
operator|&
name|pCard
operator|->
name|tiRoot
argument_list|,
operator|&
name|pPortalData
operator|->
name|portalInfo
operator|.
name|tiPortalContext
argument_list|,
name|FORCE_PERSISTENT_ASSIGN_MASK
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|tiPortNameServerDown
case|:
name|AGTIAPI_PRINTK
argument_list|(
literal|"PortNameSeverDown\n"
argument_list|)
expr_stmt|;
name|pPortalData
operator|=
name|PORTAL_CONTEXT_TO_PORTALDATA
argument_list|(
name|pParm
argument_list|)
expr_stmt|;
name|PORTAL_STATUS
argument_list|(
name|pPortalData
argument_list|)
operator|&=
operator|~
name|AGTIAPI_NAME_SERVER_UP
expr_stmt|;
break|break;
case|case
name|tiPortPanic
case|:
name|AGTIAPI_PRINTK
argument_list|(
literal|"PortPanic\n"
argument_list|)
expr_stmt|;
name|AGTIAPI_PRINTK
argument_list|(
literal|"## PortEvent\n"
argument_list|)
expr_stmt|;
name|pCard
operator|->
name|flags
operator||=
name|AGTIAPI_PORT_PANIC
expr_stmt|;
break|break;
case|case
name|tiPortResetComplete
case|:
name|AGTIAPI_PRINTK
argument_list|(
literal|"PortResetComplete\n"
argument_list|)
expr_stmt|;
name|pCard
operator|->
name|flags
operator||=
name|AGTIAPI_CB_DONE
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|tiSuccess
condition|)
name|pCard
operator|->
name|flags
operator||=
name|AGTIAPI_RESET_SUCCESS
expr_stmt|;
break|break;
case|case
name|tiPortShutdown
case|:
name|AGTIAPI_PRINTK
argument_list|(
literal|"PortShutdown\n"
argument_list|)
expr_stmt|;
name|pCard
operator|->
name|flags
operator||=
name|AGTIAPI_CB_DONE
expr_stmt|;
name|pCard
operator|->
name|flags
operator||=
name|AGTIAPI_PORT_SHUTDOWN
expr_stmt|;
break|break;
case|case
name|tiPortStopped
case|:
name|pCard
operator|->
name|flags
operator||=
name|AGTIAPI_CB_DONE
expr_stmt|;
name|pPortalData
operator|=
name|PORTAL_CONTEXT_TO_PORTALDATA
argument_list|(
name|pParm
argument_list|)
expr_stmt|;
name|PORTAL_STATUS
argument_list|(
name|pPortalData
argument_list|)
operator||=
name|AGTIAPI_PORT_STOPPED
expr_stmt|;
name|AGTIAPI_PRINTK
argument_list|(
literal|"PortStopped - portal %p\n"
argument_list|,
name|pPortalData
argument_list|)
expr_stmt|;
break|break;
case|case
name|tiEncryptOperation
case|:
break|break;
case|case
name|tiModePageOperation
case|:
break|break;
default|default:
name|AGTIAPI_PRINTK
argument_list|(
literal|"PortEvent - %d (Unknown)\n"
argument_list|,
name|eventType
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiStallThread() Purpose:   Stall the thread (busy wait) for a number of microseconds. Parameters:   tiRoot_t *ptiRoot (IN)  Pointer to the tiRoot data structure   U32 microseconds (IN)   Micro-seconds to be hold Returns: none ******************************************************************************/
end_comment

begin_function
name|void
name|ostiStallThread
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|U32
name|microseconds
parameter_list|)
block|{
name|DELAY
argument_list|(
name|microseconds
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiTimeStamp()   ### stubbed out for now Purpose:   Time stamp Parameters:   tiRoot_t *ptiRoot (IN)  Pointer to the tiRoot data structure Returns:   Time stamp in milisecond ******************************************************************************/
end_comment

begin_function
name|U32
name|ostiTimeStamp
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|// meant as stubbed out 64 bit version.
end_comment

begin_function
name|U64
name|ostiTimeStamp64
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|)
block|{
name|U64
name|retVal
decl_stmt|;
name|retVal
operator|=
name|ostiTimeStamp
argument_list|(
name|ptiRoot
argument_list|)
expr_stmt|;
return|return
name|retVal
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************** ostiCacheFlush()    ### stubbed out for now ostiCacheInvalidate() ostiCachePreFlush()  Purpose:   Cache-coherency APIs Parameters:    Returns:    Note:   These 3 functions are to support new cache coherency applications.   Currently the APIs are implemented in FC for PPC platform. The    define CACHED_DMA enable for dma_cache_sync function call. However   this define is restricted for certain version of linux, such as   Linux 2.6.x and above, and certain platform such as PPC.    DO NOT define the CACHED_DMA if the cache coherency is not required   or the environment does not match. ******************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|ostiCacheFlush
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|void
modifier|*
name|osMemHandle
parameter_list|,
name|void
modifier|*
name|virtPtr
parameter_list|,
name|bit32
name|length
parameter_list|)
block|{ }
end_function

begin_function
name|osGLOBAL
name|void
name|ostiCacheInvalidate
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|void
modifier|*
name|osMemHandle
parameter_list|,
name|void
modifier|*
name|virtPtr
parameter_list|,
name|bit32
name|length
parameter_list|)
block|{ }
end_function

begin_function
name|osGLOBAL
name|void
name|ostiCachePreFlush
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|void
modifier|*
name|osMemHandle
parameter_list|,
name|void
modifier|*
name|virtPtr
parameter_list|,
name|bit32
name|length
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*     added for SAS/SATA    this is called by ossaInterrruptEnable */
end_comment

begin_function
name|GLOBAL
name|void
name|ostiInterruptEnable
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|bit32
name|channelNum
parameter_list|)
block|{
comment|// yep, really nothing.
block|}
end_function

begin_comment
comment|/*     this is called by ossaInterrruptDisable */
end_comment

begin_function
name|GLOBAL
name|void
name|ostiInterruptDisable
parameter_list|(
name|tiRoot_t
modifier|*
name|ptiRoot
parameter_list|,
name|bit32
name|channelNum
parameter_list|)
block|{
comment|// yep, really nothing.
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/*! \file sahw.c  *  \brief The file implements the functions for reset and shutdown  */
end_comment

begin_comment
comment|/******************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/saglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SA_ENABLE_HDA_FUNCTIONS
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|SA_EXCLUDE_FW_IMG
end_ifndef

begin_comment
comment|/* #include "istrimg.h" #include "ilaimg.h" #include "aap1img.h" #include "iopimg.h" */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
end_if

begin_decl_stmt
specifier|extern
name|bit32
name|gLLSoftResetCounter
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|siTraceFileID
end_ifdef

begin_undef
undef|#
directive|undef
name|siTraceFileID
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|siTraceFileID
value|'E'
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|bit32
name|gWait_3
init|=
literal|3
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bit32
name|gWait_2
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bit32
name|gWaitmSec
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
name|LOCAL
name|bit32
name|si_V_SoftReset
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|signature
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|LOCAL
name|bit32
name|siSpcSoftResetRDYChk
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|SA_ENABLE_HDA_FUNCTIONS
end_ifdef

begin_function_decl
name|LOCAL
name|void
name|siPciMemCpy
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|dstoffset
parameter_list|,
name|void
modifier|*
name|src
parameter_list|,
name|bit32
name|DWcount
parameter_list|,
name|bit32
name|busBaseNumber
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|LOCAL
name|bit32
name|siBar4Cpy
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|offset
parameter_list|,
name|bit8
modifier|*
name|parray
parameter_list|,
name|bit32
name|array_size
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Function to reset the Hardware  *  *  The saHwReset() function is called to reset the SAS/SATA HW controller  *  All outstanding I/Os are explicitly aborted.  *  This API need to access before saInitialize() so checking saRoot is needed  *  *  \param agRoot       Handles for this instance of SAS/SATA hardware  *  \param resetType    The reset type  *  \param resetParm    The paramter passed for reset operation  *  *  \return -void-  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|saHwReset
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|resetType
parameter_list|,
name|bit32
name|resetParm
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|bit32
name|value
decl_stmt|;
name|bit32
name|sysIntsActive
init|=
name|agFALSE
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|bit32
name|value1
decl_stmt|;
name|agsaControllerStatus_t
name|controllerStatus
decl_stmt|;
name|agsaFatalErrorInfo_t
name|fatal_error
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SOFT_RESET_TEST
name|DbgPrint
argument_list|(
literal|"Reset Start\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"5a"
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
condition|)
block|{
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
name|agRoot
operator|->
name|sdkData
expr_stmt|;
name|sysIntsActive
operator|=
name|saRoot
operator|->
name|sysIntsActive
expr_stmt|;
if|if
condition|(
name|sysIntsActive
condition|)
block|{
name|saSystemInterruptsActive
argument_list|(
name|agRoot
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"5a"
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
block|{
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
comment|/* check fatal errors */
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_1
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
name|value1
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_2
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
comment|/* check AAP error */
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|value
operator|&=
name|SCRATCH_PAD_STATE_MASK
expr_stmt|;
name|value1
operator|&=
name|SCRATCH_PAD_STATE_MASK
expr_stmt|;
if|if
condition|(
operator|(
name|SCRATCH_PAD1_ERR
operator|==
name|value
operator|)
operator|||
operator|(
name|SCRATCH_PAD2_ERR
operator|==
name|value1
operator|)
condition|)
block|{
name|si_memset
argument_list|(
operator|&
name|fatal_error
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFatalErrorInfo_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* read detail fatal errors */
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|fatal_error
operator|.
name|errorInfo0
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: ScratchPad0 AAP error code 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_1
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
name|fatal_error
operator|.
name|errorInfo1
operator|=
name|value
expr_stmt|;
comment|/* AAP error state */
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: AAP error state and error code 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_2
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
name|fatal_error
operator|.
name|errorInfo2
operator|=
name|value
expr_stmt|;
comment|/* IOP error state */
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: IOP error state and error code 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_3
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: ScratchPad3 IOP error code 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|fatal_error
operator|.
name|errorInfo3
operator|=
name|value
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
name|fatal_error
operator|.
name|regDumpBusBaseNum0
operator|=
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|regDumpPCIBAR
expr_stmt|;
name|fatal_error
operator|.
name|regDumpBusBaseNum1
operator|=
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|regDumpPCIBAR
expr_stmt|;
name|fatal_error
operator|.
name|regDumpLen0
operator|=
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpLength0
expr_stmt|;
name|fatal_error
operator|.
name|regDumpLen1
operator|=
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpLength1
expr_stmt|;
name|fatal_error
operator|.
name|regDumpOffset0
operator|=
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpOffset0
expr_stmt|;
name|fatal_error
operator|.
name|regDumpOffset1
operator|=
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpOffset1
expr_stmt|;
block|}
comment|/* Call Back with error */
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: OSSA_HW_EVENT_MALFUNCTION SPC SP1 0x%x\n"
operator|,
name|value1
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_MALFUNCTION
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|fatal_error
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|(
name|value
operator|&
name|SCRATCH_PAD1_V_BOOTLDR_ERROR
operator|)
operator|==
name|SCRATCH_PAD1_V_BOOTLDR_ERROR
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: ScratchPad1 SCRATCH_PAD1_V_BOOTLDR_ERROR 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SCRATCH_PAD1_V_ERROR_STATE
argument_list|(
name|value
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: ScratchPad1 SCRATCH_PAD1_V_ERROR_STATE  0x%x\n"
operator|,
name|SCRATCH_PAD1_V_ERROR_STATE
argument_list|(
name|value
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|value
operator|&
name|SCRATCH_PAD1_V_READY
operator|)
operator|==
name|SCRATCH_PAD1_V_READY
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: ScratchPad1 SCRATCH_PAD1_V_READY  0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|saGetControllerStatus
argument_list|(
name|agRoot
argument_list|,
operator|&
name|controllerStatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
comment|/* display all pending Ios */
name|siDumpActiveIORequests
argument_list|(
name|agRoot
argument_list|,
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
comment|/* Check the resetType */
switch|switch
condition|(
name|resetType
condition|)
block|{
comment|/* Reset the whole chip */
case|case
name|AGSA_CHIP_RESET
case|:
block|{
comment|/* callback with RESET_START */
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_RESET_START
argument_list|,
name|OSSA_SUCCESS
operator|<<
name|SHIFT8
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
operator|&&
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
comment|/* Set chip status */
name|saRoot
operator|->
name|chipStatus
operator||=
name|CHIP_RESETTING
expr_stmt|;
comment|/* Disable all interrupt */
name|saSystemInterruptsActive
argument_list|(
name|agRoot
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
block|}
comment|/* do chip reset */
name|siChipReset
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
comment|/* clear up the internal resource */
name|siInitResources
argument_list|(
name|agRoot
argument_list|,
operator|&
name|saRoot
operator|->
name|memoryAllocated
argument_list|,
operator|&
name|saRoot
operator|->
name|hwConfig
argument_list|,
operator|&
name|saRoot
operator|->
name|swConfig
argument_list|,
name|saRoot
operator|->
name|usecsPerTick
argument_list|)
expr_stmt|;
block|}
comment|/* callback with CHIP_RESET_COMPLETE with OSSA_SUCCESS */
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_RESET_COMPLETE
argument_list|,
name|OSSA_SUCCESS
operator|<<
name|SHIFT8
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
comment|/* mask off reset FW status */
name|saRoot
operator|->
name|chipStatus
operator|&=
operator|~
name|CHIP_RESETTING
expr_stmt|;
block|}
break|break;
block|}
case|case
name|AGSA_SOFT_RESET
case|:
block|{
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: AGSA_SOFT_RESET chip type V %d\n"
operator|,
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_RESET_START
argument_list|,
name|OSSA_SUCCESS
operator|<<
name|SHIFT8
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
name|saRoot
operator|->
name|ResetStartTick
operator|=
name|saRoot
operator|->
name|timeTick
expr_stmt|;
name|saCountActiveIORequests
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
block|}
comment|//delray end
name|ret
operator|=
name|siChipResetV
argument_list|(
name|agRoot
argument_list|,
name|SPC_SOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
comment|/* clear up the internal resource */
name|siInitResources
argument_list|(
name|agRoot
argument_list|,
operator|&
name|saRoot
operator|->
name|memoryAllocated
argument_list|,
operator|&
name|saRoot
operator|->
name|hwConfig
argument_list|,
operator|&
name|saRoot
operator|->
name|swConfig
argument_list|,
name|saRoot
operator|->
name|usecsPerTick
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AGSA_RC_SUCCESS
operator|==
name|ret
condition|)
block|{
comment|/* callback with CHIP_RESET_COMPLETE with OSSA_SUCCESS */
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: siChipResetV AGSA_RC_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_RESET_COMPLETE
argument_list|,
name|OSSA_SUCCESS
operator|<<
name|SHIFT8
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* callback with CHIP_RESET_COMPLETE with OSSA_FAILURE */
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: siChipResetV not AGSA_RC_SUCCESS (0x%x)\n"
operator|,
name|ret
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_RESET_COMPLETE
argument_list|,
name|OSSA_FAILURE
operator|<<
name|SHIFT8
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
name|saRoot
operator|->
name|ResetFailed
operator|=
name|agTRUE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: siChipResetV saRoot->ResetFailed  ret (0x%x)\n"
operator|,
name|ret
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
block|}
else|else
block|{
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
comment|/* get register dump from GSM and save it to LL local memory */
name|siGetRegisterDumpGSM
argument_list|(
name|agRoot
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|saRoot
operator|->
name|registerDump0
index|[
literal|0
index|]
argument_list|,
name|REG_DUMP_NUM0
argument_list|,
literal|0
argument_list|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpLength0
argument_list|)
expr_stmt|;
name|siGetRegisterDumpGSM
argument_list|(
name|agRoot
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|saRoot
operator|->
name|registerDump1
index|[
literal|0
index|]
argument_list|,
name|REG_DUMP_NUM1
argument_list|,
literal|0
argument_list|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpLength1
argument_list|)
expr_stmt|;
block|}
comment|/* callback with RESET_START */
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_RESET_START
argument_list|,
name|OSSA_SUCCESS
operator|<<
name|SHIFT8
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
operator|&&
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
comment|/* Set chip status */
name|saRoot
operator|->
name|chipStatus
operator||=
name|CHIP_RESET_FW
expr_stmt|;
comment|/* Disable all interrupt */
name|saSystemInterruptsActive
argument_list|(
name|agRoot
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
name|saCountActiveIORequests
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
comment|//delray start
block|}
comment|/* check HDA mode */
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|&
name|HDA_STATUS_BITS
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|BOOTTLOADERHDA_IDLE
condition|)
block|{
comment|/* HDA mode */
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: HDA mode, value = 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_HDA_NO_FW_RUNNING
expr_stmt|;
block|}
else|else
block|{
comment|/* do Soft Reset */
name|ret
operator|=
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_SOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
comment|/* clear up the internal resource */
name|siInitResources
argument_list|(
name|agRoot
argument_list|,
operator|&
name|saRoot
operator|->
name|memoryAllocated
argument_list|,
operator|&
name|saRoot
operator|->
name|hwConfig
argument_list|,
operator|&
name|saRoot
operator|->
name|swConfig
argument_list|,
name|saRoot
operator|->
name|usecsPerTick
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AGSA_RC_SUCCESS
operator|==
name|ret
condition|)
block|{
comment|/* callback with CHIP_RESET_COMPLETE with OSSA_SUCCESS */
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_RESET_COMPLETE
argument_list|,
name|OSSA_SUCCESS
operator|<<
name|SHIFT8
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|AGSA_RC_HDA_NO_FW_RUNNING
operator|==
name|ret
condition|)
block|{
comment|/* callback with CHIP_RESET_COMPLETE with OSSA_CHIP_FAILED */
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_RESET_COMPLETE
argument_list|,
name|OSSA_SUCCESS
operator|<<
name|SHIFT8
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* callback with CHIP_RESET_COMPLETE with OSSA_FAILURE */
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_RESET_COMPLETE
argument_list|,
operator|(
name|OSSA_FAILURE
operator|<<
name|SHIFT8
operator|)
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
comment|/* mask off reset FW status */
name|saRoot
operator|->
name|chipStatus
operator|&=
operator|~
name|CHIP_RESET_FW
expr_stmt|;
block|}
break|break;
block|}
block|}
comment|/* Unsupported type */
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwReset: Unsupported reset type %X\n"
operator|,
name|resetType
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
if|if
condition|(
name|sysIntsActive
operator|&&
name|ret
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|saSystemInterruptsActive
argument_list|(
name|agRoot
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
block|}
name|saCountActiveIORequests
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"5a"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Function to shutdown the Hardware  *  *  The saHwShutdown() function is called to discontinue the use of the SAS/SATA  *  hardware. Upon return, the SASA/SAT hardware instance does not generate any  *  interrupts or any other bus accesses. All LL Layer hardware host resources  * (i.e. both cached and noncached memory) are no longer owned by the LL Layer.  *  *  \param agRoot handles for this instance of SAS/SATA hardware  *  *  \return -void-  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|saHwShutdown
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|bit32
name|spad0
init|=
literal|0
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"5b"
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: Shutting down .....\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|spad0
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0xFFFFFFFF
operator|==
name|spad0
condition|)
block|{
name|SA_ASSERT
argument_list|(
literal|0xFFFFFFFF
operator|==
name|spad0
argument_list|,
literal|"saHwShutdown Chip PCI dead"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: Chip PCI dead  SCRATCH_PAD0 0x%x\n"
operator|,
name|spad0
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"5b"
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_1
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_2
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_3
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
condition|)
block|{
name|mpiOCQueue_t
modifier|*
name|circularQ
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"saHwShutdown:\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|circularQ
operator|=
operator|&
name|saRoot
operator|->
name|outboundQueue
index|[
name|i
index|]
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|circularQ
operator|->
name|agRoot
argument_list|,
operator|&
name|circularQ
operator|->
name|producerIdx
argument_list|,
name|circularQ
operator|->
name|piPointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|circularQ
operator|->
name|producerIdx
operator|!=
name|circularQ
operator|->
name|consumerIdx
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: PI 0x%03x CI 0x%03x\n"
operator|,
name|circularQ
operator|->
name|producerIdx
operator|,
name|circularQ
operator|->
name|consumerIdx
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
comment|/* SALLSDK_DBG */
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|siScratchDump
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: SPC_V\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Set chip status */
name|saRoot
operator|->
name|chipStatus
operator||=
name|CHIP_SHUTDOWN
expr_stmt|;
comment|/* Un-Initialization Configuration Table */
name|mpiUnInitConfigTable
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|->
name|swConfig
operator|.
name|hostDirectAccessSupport
operator|&&
operator|!
name|saRoot
operator|->
name|swConfig
operator|.
name|hostDirectAccessMode
condition|)
block|{
comment|/* HDA mode -  do HDAsoftReset */
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/* HDA soft reset */
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|siChipResetV
argument_list|(
name|agRoot
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: HDA saRoot->ChipId == VEN_DEV_SPCV\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*  do Normal softReset */
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/* Soft Reset the SPC */
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_SOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: saRoot->ChipId == VEN_DEV_SPCV\n"
operator|)
argument_list|)
expr_stmt|;
name|siChipResetV
argument_list|(
name|agRoot
argument_list|,
name|SPC_SOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* clean the LL resources */
name|siInitResources
argument_list|(
name|agRoot
argument_list|,
operator|&
name|saRoot
operator|->
name|memoryAllocated
argument_list|,
operator|&
name|saRoot
operator|->
name|hwConfig
argument_list|,
operator|&
name|saRoot
operator|->
name|swConfig
argument_list|,
name|saRoot
operator|->
name|usecsPerTick
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: Shutting down Complete\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saHwShutdown: No saRoot\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|siChipResetV
argument_list|(
name|agRoot
argument_list|,
name|SPC_SOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_SOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* agroot/saroot null do not access -trace OK */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|"10"
argument_list|)
expr_stmt|;
comment|/* return */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"5b"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Generic Reset  *  *  The siChipReset() function is called to reset the SPC chip. Upon return,  *  the SPC chip got reset. The PCIe bus got reset.  *  *  \param agRoot handles for this instance of SAS/SATA hardware  *  *  \return -void-  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|siChipReset
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
decl_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2C"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipReset: saRoot->ChipId == VEN_DEV_SPCV\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/* Soft Reset the SPC */
name|siChipResetSpc
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* saRoot->ChipId == VEN_DEV_SPCV */
block|{
name|siChipResetV
argument_list|(
name|agRoot
argument_list|,
name|SPC_SOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2C"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Function to Reset the SPC V Hardware  *  *  The siChipResetV() function is called to reset the SPC chip. Upon return,  *  the SPC chip got reset. The PCIe bus got reset.  *  *  \param agRoot handles for this instance of SAS/SATA hardware  *  *  \return -void-  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|siChipResetV
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|signature
parameter_list|)
block|{
name|bit32
name|regVal
decl_stmt|;
name|bit32
name|returnVal
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3A"
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Lr"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_SoftResetRegister
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: signature %X V_SoftResetRegister %X\n"
operator|,
name|signature
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|signature
operator|==
name|SPC_SOFT_RESET_SIGNATURE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_SOFT_RESET_SIGNATURE 0x%X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|SPCv_Reset_Write_NormalReset
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|signature
operator|==
name|SPC_HDASOFT_RESET_SIGNATURE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPCv load HDA 0x%X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|SPCv_Reset_Write_SoftResetHDA
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: Invalid SIGNATURE 0x%X  regVal 0x%X  a\n"
operator|,
name|signature
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
literal|1
expr_stmt|;
block|}
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Ls"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_SoftResetRegister
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siChipResetV */
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Lt"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
operator|(
literal|500
operator|*
literal|1000
operator|)
argument_list|)
expr_stmt|;
comment|/* wait 500 milliseconds or PCIe will hang */
comment|/* Soft reset sequence (Normal mode) */
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Lv"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|signature
operator|==
name|SPC_HDASOFT_RESET_SIGNATURE
condition|)
block|{
name|bit32
name|hda_status
decl_stmt|;
name|hda_status
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: hda_status 0x%x\n"
operator|,
name|hda_status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hda_status
operator|&
name|SPC_V_HDAR_RSPCODE_MASK
operator|)
operator|!=
name|SPC_V_HDAR_IDLE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:SPC_HDASOFT_RESET_SIGNATURE SCRATCH_PAD1 = 0x%x \n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_HDASOFT_RESET_SIGNATURE %X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_SoftResetRegister
argument_list|)
expr_stmt|;
comment|/* siChipResetV */
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_HDASOFT_RESET_SIGNATURE  %X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regVal
operator|&
name|SPCv_Reset_Read_Mask
operator|)
operator|==
name|SPCv_Reset_Read_NoReset
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_HDASOFT_RESET_SIGNATURE AGSA_RC_FAILURE %X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|regVal
operator|&
name|SPCv_Reset_Read_Mask
operator|)
operator|==
name|SPCv_Reset_Read_NormalResetOccurred
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_HDASOFT_RESET_SIGNATURE AGSA_RC_FAILURE %X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|regVal
operator|&
name|SPCv_Reset_Read_Mask
operator|)
operator|==
name|SPCv_Reset_Read_SoftResetHDAOccurred
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_HDASOFT_RESET_SIGNATURE AGSA_RC_SUCCESS %X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|returnVal
operator|=
name|AGSA_RC_SUCCESS
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|regVal
operator|&
name|SPCv_Reset_Read_Mask
operator|)
operator|==
name|SPCv_Reset_Read_ChipResetOccurred
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_HDASOFT_RESET_SIGNATURE AGSA_RC_FAILURE %X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
if|if
condition|(
name|regVal
operator|==
literal|0xFFFFFFFF
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_HDASOFT_RESET_SIGNATURE AGSA_RC_FAILURE %X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:SCRATCH_PAD1 = 0x%x a\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3A"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
elseif|else
if|if
condition|(
name|signature
operator|==
name|SPC_SOFT_RESET_SIGNATURE
condition|)
block|{
name|bit32
name|SCRATCH_PAD1
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Lw"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_SoftResetRegister
argument_list|)
expr_stmt|;
comment|/* siChipResetV */
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_SOFT_RESET_SIGNATURE  0x%X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|regVal
operator|==
literal|0xFFFFFFFF
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_SOFT_RESET_SIGNATURE AGSA_RC_FAILURE %X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|regVal
operator|&
name|SPCv_Reset_Read_Mask
operator|)
operator|==
name|SPCv_Reset_Read_NoReset
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:SPC_SOFT_RESET_SIGNATURE  AGSA_RC_FAILURE %X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|regVal
operator|&
name|SPCv_Reset_Read_Mask
operator|)
operator|==
name|SPCv_Reset_Read_SoftResetHDAOccurred
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_SOFT_RESET_SIGNATURE AGSA_RC_FAILURE 0x%X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|regVal
operator|&
name|SPCv_Reset_Read_Mask
operator|)
operator|==
name|SPCv_Reset_Read_ChipResetOccurred
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_SOFT_RESET_SIGNATURE AGSA_RC_FAILURE 0x%X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|regVal
operator|&
name|SPCv_Reset_Read_Mask
operator|)
operator|==
name|SPCv_Reset_Read_NormalResetOccurred
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SPC_SOFT_RESET_SIGNATURE AGSA_RC_SUCCESS 0x%X\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|returnVal
operator|=
name|AGSA_RC_SUCCESS
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:SCRATCH_PAD1 = 0x%x b\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnVal
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|&
name|SCRATCH_PAD1_V_BOOTSTATE_MASK
expr_stmt|;
if|if
condition|(
name|SCRATCH_PAD1
operator|==
name|SCRATCH_PAD1_V_BOOTSTATE_HDA_SEEPROM
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: Reset done FW did not start BOOTSTATE_HDA_SEEPROM\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|returnVal
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|SCRATCH_PAD1
operator|==
name|SCRATCH_PAD1_V_BOOTSTATE_HDA_BOOTSTRAP
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: Reset done FW did not start BOOTSTATE_HDA_BOOTSTRAP\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|returnVal
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|SCRATCH_PAD1
operator|==
name|SCRATCH_PAD1_V_BOOTSTATE_HDA_SOFTRESET
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: Reset done FW did not start BOOTSTATE_HDA_SOFTRESET\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|returnVal
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|SCRATCH_PAD1
operator|==
name|SCRATCH_PAD1_V_BOOTSTATE_CRIT_ERROR
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: Reset done FW did not start BOOTSTATE_CRIT_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3A"
argument_list|)
expr_stmt|;
return|return
operator|(
name|returnVal
operator|)
return|;
block|}
block|}
comment|/* RESET */
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Lx"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|max_wait_time
operator|=
operator|(
literal|100
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 100 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|SCRATCH_PAD1
operator|==
literal|0xFFFFFFFF
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Ly"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:SCRATCH_PAD1 = 0x%x (0x%x) PCIe ready took %d\n"
operator|,
name|SCRATCH_PAD1
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* ILA */
name|max_wait_time
operator|=
operator|(
literal|1000
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 1000 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_ILA_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_ILA_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:SCRATCH_PAD1 = 0x%x SCRATCH_PAD1_V_ILA_MASK (0x%x)(0x%x) took %d\n"
operator|,
name|SCRATCH_PAD1
operator|,
name|SCRATCH_PAD1_V_ILA_MASK
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:Timeout SCRATCH_PAD1_V_ILA_MASK (0x%x)  not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_ILA_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* RAAE */
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Lz"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|max_wait_time
operator|=
operator|(
literal|1800
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 1800 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:SCRATCH_PAD1 = 0x%x SCRATCH_PAD1_V_RAAE_MASK (0x%x)(0x%x) took %d\n"
operator|,
name|SCRATCH_PAD1
operator|,
name|SCRATCH_PAD1_V_RAAE_MASK
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:Timeout SCRATCH_PAD1_V_RAAE_MASK (0x%x) not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_RAAE_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* IOP0 */
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"La"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|max_wait_time
operator|=
operator|(
literal|600
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 600 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_IOP0_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_IOP0_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:SCRATCH_PAD1 = 0x%x  SCRATCH_PAD1_V_IOP0_MASK(0x%x)(0x%x) took %d\n"
operator|,
name|SCRATCH_PAD1
operator|,
name|SCRATCH_PAD1_V_IOP0_MASK
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:Timeout SCRATCH_PAD1_V_IOP0_MASK (0x%x) not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_IOP0_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIS_SPCV_2_IOP
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/* IOP1 */
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Lb"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|max_wait_time
operator|=
operator|(
literal|200
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 200 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_IOP1_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_IOP1_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV:SCRATCH_PAD1 = 0x%x SCRATCH_PAD1_V_IOP1_MASK (0x%x) (0x%x)(0x%x)\n"
operator|,
name|SCRATCH_PAD1
operator|,
name|SCRATCH_PAD1_V_IOP1_MASK
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: SCRATCH_PAD1_V_IOP1_MASK (0x%x) not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_IOP1_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Lc"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_SoftResetRegister
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: Reset done 0x%X ERROR_STATE 0x%X\n"
operator|,
name|regVal
operator|,
name|SCRATCH_PAD1_V_ERROR_STATE
argument_list|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SCRATCH_PAD1_V_ERROR_STATE
argument_list|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
argument_list|)
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"3A"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
else|else
comment|/* signature = unknown */
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"3A"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTrace
argument_list|(
name|hpDBG_LOUD
argument_list|,
literal|"Ld"
argument_list|,
name|ossaTimeStamp64
argument_list|(
name|agRoot
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetV: out V_SoftResetRegister  %08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_SoftResetRegister
argument_list|)
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SOFT_RESET_TEST
name|DbgPrint
argument_list|(
literal|"SCRATCH_PAD1 = 0x%x \n"
argument_list|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"3A"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Function to Reset the SPC Hardware  *  *  The siChipResetSpc() function is called to reset the SPC chip. Upon return,  *  the SPC chip got reset. The PCIe bus got reset.  *  *  \param agRoot handles for this instance of SAS/SATA hardware  *  *  \return -void-  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|siChipResetSpc
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|bit32
name|regVal
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"5c"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetSpc: Chip Reset start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Reset the chip */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|)
expr_stmt|;
name|regVal
operator|&=
operator|~
operator|(
name|SPC_REG_RESET_DEVICE
operator|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siChipResetSpc */
comment|/* delay 10 usec */
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
comment|/* bring chip reset out of reset */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|)
expr_stmt|;
name|regVal
operator||=
name|SPC_REG_RESET_DEVICE
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siChipResetSpc */
comment|/* delay 10 usec */
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
comment|/* wait for 20 msec until the firmware gets reloaded */
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
operator|(
literal|20
operator|*
literal|1000
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"5c"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siChipResetSpc: Chip Reset Complete\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|siSoftReset
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|signature
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|ret
operator|=
name|si_V_SoftReset
argument_list|(
name|agRoot
argument_list|,
name|signature
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|signature
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|LOCAL
name|bit32
name|si_V_SoftReset
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|signature
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|ret
operator|=
name|siChipResetV
argument_list|(
name|agRoot
argument_list|,
name|signature
argument_list|)
expr_stmt|;
if|if
condition|(
name|signature
operator|==
name|SPC_SOFT_RESET_SIGNATURE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"si_V_SoftReset:SPC_SOFT_RESET_SIGNATURE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|signature
operator|==
name|SPC_HDASOFT_RESET_SIGNATURE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"si_V_SoftReset: SPC_HDASOFT_RESET_SIGNATURE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"si_V_SoftReset: Reset Complete status 0x%X\n"
operator|,
name|ret
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Function to soft/FW reset the SPC  *  *  The siSpcSoftReset() function is called to soft reset SPC. Upon return,  *  the SPC FW got reset. The PCIe bus is not touched.  *  *  \param agRoot    handles for this instance of SAS/SATA hardware  *  \param signature soft reset normal signature or HDA soft reset signature  *  *  \return -void-  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|siSpcSoftReset
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|signature
parameter_list|)
block|{
name|spc_configMainDescriptor_t
name|mainCfg
decl_stmt|;
name|bit32
name|regVal
decl_stmt|,
name|toggleVal
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
name|bit32
name|regVal1
decl_stmt|,
name|regVal2
decl_stmt|,
name|regVal3
decl_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|"agNULL != agRoot"
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: start\n"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
comment|/* count SoftReset */
name|gLLSoftResetCounter
operator|++
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: ResetCount = 0x%x\n"
operator|,
name|gLLSoftResetCounter
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* step1: Check FW is ready for soft reset */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Q1"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* TP:Q1 siSpcSoftReset */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siSpcSoftResetRDYChk
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSoftReset:siSoftResetRDYChk failed\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* step 2: clear NMI status register on AAP1 and IOP, write the same value to clear */
comment|/* map 0x60000 to BAR4(0x20), BAR2(win) */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Q2"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* TP:Q2 siSpcSoftReset */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|MBIC_AAP1_ADDR_BASE
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset:Shift Bar4 to 0x%x failed\n"
operator|,
name|MBIC_AAP1_ADDR_BASE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: Soft Reset AGSA_RC_FAILURE %d\n"
operator|,
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|MBIC_NMI_ENABLE_VPE0_IOP
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"MBIC(A) - NMI Enable VPE0 (IOP): = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|MBIC_NMI_ENABLE_VPE0_IOP
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
comment|/* map 0x70000 to BAR4(0x20), BAR2(win) */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|MBIC_IOP_ADDR_BASE
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset:Shift Bar4 to 0x%x failed\n"
operator|,
name|MBIC_IOP_ADDR_BASE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: Soft Reset AGSA_RC_FAILURE %d\n"
operator|,
literal|2
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|MBIC_NMI_ENABLE_VPE0_AAP1
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"MBIC(A) - NMI Enable VPE0 (AAP1): = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|MBIC_NMI_ENABLE_VPE0_AAP1
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|PCIE_EVENT_INTERRUPT_ENABLE
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"PCIE - Event Interrupt Enable Register: = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|PCIE_EVENT_INTERRUPT_ENABLE
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|PCIE_EVENT_INTERRUPT
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"PCIE - Event Interrupt Register: = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|PCIE_EVENT_INTERRUPT
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|PCIE_ERROR_INTERRUPT_ENABLE
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"PCIE - Error Interrupt Enable Register: = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|PCIE_ERROR_INTERRUPT_ENABLE
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|PCIE_ERROR_INTERRUPT
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"PCIE - Error Interrupt Register: = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|PCIE_ERROR_INTERRUPT
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
comment|/* read the scratch pad 1 register bit 2 */
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|&
name|SCRATCH_PAD1_RST
expr_stmt|;
name|toggleVal
operator|=
name|regVal
operator|^
name|SCRATCH_PAD1_RST
expr_stmt|;
comment|/* set signature in host scratch pad0 register to tell SPC that the host performs the soft reset */
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_0
argument_list|,
name|signature
argument_list|)
expr_stmt|;
comment|/* read required registers for confirmming */
comment|/* map 0x0700000 to BAR4(0x20), BAR2(win) */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|GSM_ADDR_BASE
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset:Shift Bar4 to 0x%x failed\n"
operator|,
name|GSM_ADDR_BASE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: Soft Reset AGSA_RC_FAILURE %d\n"
operator|,
literal|3
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x0 (0x00007b88) - GSM Configuration and Reset = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_CONFIG_RESET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Q3"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* TP:Q3 siSpcSoftReset */
comment|/* step 3: host read GSM Configuration and Reset register */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_CONFIG_RESET
argument_list|)
expr_stmt|;
comment|/* Put those bits to low */
comment|/* GSM XCBI offset = 0x70 0000       0x00 Bit 13 COM_SLV_SW_RSTB 1       0x00 Bit 12 QSSP_SW_RSTB 1       0x00 Bit 11 RAAE_SW_RSTB 1       0x00 Bit 9   RB_1_SW_RSTB 1       0x00 Bit 8   SM_SW_RSTB 1       */
name|regVal
operator|&=
operator|~
operator|(
literal|0x00003b00
operator|)
expr_stmt|;
comment|/* host write GSM Configuration and Reset register */
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_CONFIG_RESET
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x0 (0x00007b88 ==> 0x00004088) - GSM Configuration and Reset is set to = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_CONFIG_RESET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
comment|/* debugging messge */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700018 - RAM ECC Double Bit Error Indication = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|RAM_ECC_DB_ERR
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700058 - Read Address Parity Error Indication = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_READ_ADDR_PARITY_INDIC
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700060 - Write Address Parity Error Indication = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_ADDR_PARITY_INDIC
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700068 - Write Data Parity Error Indication = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_DATA_PARITY_INDIC
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* step 4: */
comment|/* disable GSM - Read Address Parity Check */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Q4"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* TP:Q4 siSpcSoftReset */
name|regVal1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_READ_ADDR_PARITY_CHECK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700038 - Read Address Parity Check Enable = 0x%x\n"
operator|,
name|regVal1
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_READ_ADDR_PARITY_CHECK
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700038 - Read Address Parity Check Enable is set to = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_READ_ADDR_PARITY_CHECK
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* disable GSM - Write Address Parity Check */
name|regVal2
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_ADDR_PARITY_CHECK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700040 - Write Address Parity Check Enable = 0x%x\n"
operator|,
name|regVal2
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_ADDR_PARITY_CHECK
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700040 - Write Address Parity Check Enable is set to = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_ADDR_PARITY_CHECK
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* disable GSM - Write Data Parity Check */
name|regVal3
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_DATA_PARITY_CHECK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x300048 - Write Data Parity Check Enable = 0x%x\n"
operator|,
name|regVal3
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_DATA_PARITY_CHECK
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700048 - Write Data Parity Check Enable is set to = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_DATA_PARITY_CHECK
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* step 5-a: delay 10 usec */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Q5"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* TP:Q5 siSpcSoftReset */
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* step 5-b: set GPIO-0 output control to tristate anyway */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|GPIO_ADDR_BASE
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset:Shift Bar4 to 0x%x failed\n"
operator|,
name|GPIO_ADDR_BASE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: Soft Reset AGSA_RC_FAILURE %d\n"
operator|,
literal|4
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GPIO_GPIO_0_0UTPUT_CTL_OFFSET
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"GPIO Output Control Register: = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
comment|/* set GPIO-0 output control to tri-state */
name|regVal
operator|&=
literal|0xFFFFFFFC
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GPIO_GPIO_0_0UTPUT_CTL_OFFSET
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
comment|/* Step 6: Reset the IOP and AAP1 */
comment|/* map 0x00000 to BAR4(0x20), BAR2(win) */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Q6"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|/* TP:Q6 siSpcSoftReset */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|SPC_TOP_LEVEL_ADDR_BASE
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset:Shift Bar4 to 0x%x failed\n"
operator|,
name|SPC_TOP_LEVEL_ADDR_BASE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: Soft Reset AGSA_RC_FAILURE %d\n"
operator|,
literal|5
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"Top Register before resetting IOP/AAP1: = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|&=
operator|~
operator|(
name|SPC_REG_RESET_PCS_IOP_SS
operator||
name|SPC_REG_RESET_PCS_AAP1_SS
operator|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
comment|/* step 7: Reset the BDMA/OSSP */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Q7"
argument_list|,
literal|7
argument_list|)
expr_stmt|;
comment|/* TP:Q7 siSpcSoftReset */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"Top Register before resetting BDMA/OSSP: = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|&=
operator|~
operator|(
name|SPC_REG_RESET_BDMA_CORE
operator||
name|SPC_REG_RESET_OSSP
operator|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
comment|/* step 8: delay 10 usec */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Q8"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* TP:Q8 siSpcSoftReset */
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
comment|/* step 9: bring the BDMA and OSSP out of reset */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Q9"
argument_list|,
literal|9
argument_list|)
expr_stmt|;
comment|/* TP:Q9 siSpcSoftReset */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"Top Register before bringing up BDMA/OSSP: = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator||=
operator|(
name|SPC_REG_RESET_BDMA_CORE
operator||
name|SPC_REG_RESET_OSSP
operator|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
comment|/* step 10: delay 10 usec */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QA"
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* TP:QA siSpcSoftReset */
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
comment|/* step 11: reads and sets the GSM Configuration and Reset Register */
comment|/* map 0x0700000 to BAR4(0x20), BAR2(win) */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QB"
argument_list|,
literal|11
argument_list|)
expr_stmt|;
comment|/* TP:QB siSpcSoftReset */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|GSM_ADDR_BASE
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset:Shift Bar4 to 0x%x failed\n"
operator|,
name|GSM_ADDR_BASE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'g'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: Soft Reset AGSA_RC_FAILURE %d\n"
operator|,
literal|5
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x0 (0x00007b88) - GSM Configuration and Reset = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_CONFIG_RESET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_CONFIG_RESET
argument_list|)
expr_stmt|;
comment|/* Put those bits to high */
comment|/* GSM XCBI offset = 0x70 0000       0x00 Bit 13 COM_SLV_SW_RSTB 1       0x00 Bit 12 QSSP_SW_RSTB 1       0x00 Bit 11 RAAE_SW_RSTB 1       0x00 Bit 9   RB_1_SW_RSTB 1       0x00 Bit 8   SM_SW_RSTB 1       */
name|regVal
operator||=
operator|(
name|GSM_CONFIG_RESET_VALUE
operator|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_CONFIG_RESET
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x0 (0x00004088 ==> 0x00007b88) - GSM Configuration and Reset is set to = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_CONFIG_RESET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
comment|/* debugging messge */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700018 - RAM ECC Double Bit Error Indication = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|RAM_ECC_DB_ERR
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700058 - Read Address Parity Error Indication = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_READ_ADDR_PARITY_INDIC
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700060 - Write Address Parity Error Indication = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_ADDR_PARITY_INDIC
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700068 - Write Data Parity Error Indication = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_DATA_PARITY_INDIC
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* step 12: Restore GSM - Read Address Parity Check */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QC"
argument_list|,
literal|12
argument_list|)
expr_stmt|;
comment|/* TP:QC siSpcSoftReset */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_READ_ADDR_PARITY_CHECK
argument_list|)
expr_stmt|;
comment|/* just for debugging */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700038 - Read Address Parity Check Enable = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_READ_ADDR_PARITY_CHECK
argument_list|,
name|regVal1
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700038 - Read Address Parity Check Enable is set to = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_READ_ADDR_PARITY_CHECK
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Restore GSM - Write Address Parity Check */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_ADDR_PARITY_CHECK
argument_list|)
expr_stmt|;
comment|/* just for debugging */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700040 - Write Address Parity Check Enable = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_ADDR_PARITY_CHECK
argument_list|,
name|regVal2
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700040 - Write Address Parity Check Enable is set to = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_ADDR_PARITY_CHECK
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Restore GSM - Write Data Parity Check */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_DATA_PARITY_CHECK
argument_list|)
expr_stmt|;
comment|/* just for debugging */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700048 - Write Data Parity Check Enable = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_DATA_PARITY_CHECK
argument_list|,
name|regVal3
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
name|SA_DBG1
argument_list|(
operator|(
literal|"GSM 0x700048 - Write Data Parity Check Enable is set to = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|GSM_WRITE_DATA_PARITY_CHECK
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* step 13: bring the IOP and AAP1 out of reset */
comment|/* map 0x00000 to BAR4(0x20), BAR2(win) */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QD"
argument_list|,
literal|13
argument_list|)
expr_stmt|;
comment|/* TP:QD siSpcSoftReset */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|SPC_TOP_LEVEL_ADDR_BASE
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset:Shift Bar4 to 0x%x failed\n"
operator|,
name|SPC_TOP_LEVEL_ADDR_BASE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'h'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: Soft Reset AGSA_RC_FAILURE %d\n"
operator|,
literal|7
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"Top Register before bringing up IOP/AAP1: = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator||=
operator|(
name|SPC_REG_RESET_PCS_IOP_SS
operator||
name|SPC_REG_RESET_PCS_AAP1_SS
operator|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_REG_RESET
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* siSpcSoftReset */
if|if
condition|(
name|signature
operator|==
name|SPC_SOFT_RESET_SIGNATURE
condition|)
block|{
comment|/* step 14: delay 20 milli - Normal Mode */
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|signature
operator|==
name|SPC_HDASOFT_RESET_SIGNATURE
condition|)
block|{
comment|/* step 14: delay 200 milli - HDA Mode */
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
literal|200
operator|*
literal|1000
argument_list|)
expr_stmt|;
block|}
comment|/* check Soft Reset Normal mode or Soft Reset HDA mode */
if|if
condition|(
name|signature
operator|==
name|SPC_SOFT_RESET_SIGNATURE
condition|)
block|{
comment|/* step 15 (Normal Mode): wait until scratch pad1 register bit 2 toggled */
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* 2 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|&
name|SCRATCH_PAD1_RST
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|regVal
operator|!=
name|toggleVal
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: TIMEOUT:ToggleVal 0x%x, MSGU_SCRATCH_PAD1 = 0x%x\n"
operator|,
name|toggleVal
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'i'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: Soft Reset AGSA_RC_FAILURE %d\n"
operator|,
literal|8
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* step 16 (Normal)step 15 (HDA) - Clear ODMR and ODCR */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QG"
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* TP:QG siSpcSoftReset */
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_ODCR
argument_list|,
name|ODCR_CLEAR_ALL
argument_list|)
expr_stmt|;
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_ODMR
argument_list|,
name|ODMR_CLEAR_ALL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|signature
operator|==
name|SPC_HDASOFT_RESET_SIGNATURE
condition|)
block|{
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: HDA Soft Reset Complete\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'j'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
comment|/* step 17 (Normal Mode): wait for the FW and IOP to get ready - 1 sec timeout */
comment|/* Wait for the SPC Configuration Table to be ready */
if|if
condition|(
name|mpiWaitForConfigTable
argument_list|(
name|agRoot
argument_list|,
operator|&
name|mainCfg
argument_list|)
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
comment|/* return error if MPI Configuration Table not ready */
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: SPC FW not ready SCRATCH_PAD1 = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
comment|/* return error if MPI Configuration Table not ready */
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: SPC FW not ready SCRATCH_PAD2 = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'k'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: Soft Reset AGSA_RC_FAILURE %d\n"
operator|,
literal|9
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QI"
argument_list|,
literal|18
argument_list|)
expr_stmt|;
comment|/* TP:QI siSpcSoftReset */
if|if
condition|(
name|agNULL
operator|!=
name|agRoot
operator|->
name|sdkData
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'l'
argument_list|,
literal|"5t"
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset: Soft Reset Complete\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Function to do BAR shifting  *  *  The siBarShift() function is called to shift BAR base address  *  *  \param agRoot handles for this instance of SAS/SATA hardware  *  \param shiftValue shifting value  *  *  \return success or fail  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|siBar4Shift
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|shiftValue
parameter_list|)
block|{
name|bit32
name|regVal
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"5e"
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"GA"
argument_list|,
name|shiftValue
argument_list|)
expr_stmt|;
comment|/* TP:GA shiftValue */
name|SA_DBG2
argument_list|(
operator|(
literal|"siBar4Shift: shiftValue 0x%x\n"
operator|,
name|shiftValue
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_MEMBASE_II_ShiftRegister
argument_list|,
name|shiftValue
argument_list|)
expr_stmt|;
comment|/* confirm the setting is written */
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* 1 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_MEMBASE_II_ShiftRegister
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|regVal
operator|!=
name|shiftValue
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siBar4Shift: TIMEOUT: SPC_IBW_AXI_TRANSLATION_LOW = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"5e"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/* program the inbound AXI translation Lower Address */
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|SPC_IBW_AXI_TRANSLATION_LOW
argument_list|,
name|shiftValue
argument_list|)
expr_stmt|;
comment|/* confirm the setting is written */
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* 1 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|SPC_IBW_AXI_TRANSLATION_LOW
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|regVal
operator|!=
name|shiftValue
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siBar4Shift: TIMEOUT: SPC_IBW_AXI_TRANSLATION_LOW = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"5e"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siBar4Shift: hba type is not support\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"5e"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SA_ENABLE_HDA_FUNCTIONS
end_ifdef

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Function to force HDA mode the SPC  *  *  The siHDAMode() function is called to force to HDA mode. Upon return,  *  the SPC FW loaded. The PCIe bus is not touched.  *  *  \param agRoot handles for this instance of SAS/SATA hardware  *  \param HDAMode 0 - HDA soft reset mode, 1 - HDA mode  *  \param fwImg points to structure containing fw images  *  *  \return -void-  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|siHDAMode
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|HDAMode
parameter_list|,
name|agsaFwImg_t
modifier|*
name|userFwImg
parameter_list|)
block|{
name|spc_configMainDescriptor_t
name|mainCfg
decl_stmt|;
name|bit32
name|regVal
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
name|agsaFwImg_t
name|flashImg
decl_stmt|;
name|bit32
name|startTime
decl_stmt|,
name|endTime
decl_stmt|;
comment|// TestBase
name|bit32
name|stepTime
index|[
literal|12
index|]
decl_stmt|;
comment|// TestBase
name|bit32
name|HDA_Been_Reset
init|=
name|agFALSE
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: start\n"
operator|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|flashImg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|flashImg
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|SA_EXCLUDE_FW_IMG
comment|/* Set up built-in (default) FW image pointers */
comment|/*     flashImg.aap1Img = (bit8*)(&aap1array);     flashImg.aap1Len = sizeof(aap1array);     flashImg.ilaImg  = (bit8*)(&ilaarray);     flashImg.ilaLen  = sizeof(ilaarray);     flashImg.iopImg  = (bit8*)(&ioparray);     flashImg.iopLen  = sizeof(ioparray); */
endif|#
directive|endif
name|TryAfterReset
label|:
comment|/* Set up user FW image pointers (if passed in) */
if|if
condition|(
name|userFwImg
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: User fw structure @ %p\n"
operator|,
name|userFwImg
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|userFwImg
operator|->
name|aap1Img
operator|&&
name|userFwImg
operator|->
name|aap1Len
condition|)
block|{
name|flashImg
operator|.
name|aap1Img
operator|=
name|userFwImg
operator|->
name|aap1Img
expr_stmt|;
name|flashImg
operator|.
name|aap1Len
operator|=
name|userFwImg
operator|->
name|aap1Len
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: User fw aap1 @ %p (%d)\n"
operator|,
name|flashImg
operator|.
name|aap1Img
operator|,
name|flashImg
operator|.
name|aap1Len
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|userFwImg
operator|->
name|ilaImg
operator|&&
name|userFwImg
operator|->
name|ilaLen
condition|)
block|{
name|flashImg
operator|.
name|ilaImg
operator|=
name|userFwImg
operator|->
name|ilaImg
expr_stmt|;
name|flashImg
operator|.
name|ilaLen
operator|=
name|userFwImg
operator|->
name|ilaLen
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: User fw ila @ %p (%d)\n"
operator|,
name|flashImg
operator|.
name|ilaImg
operator|,
name|flashImg
operator|.
name|ilaLen
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|userFwImg
operator|->
name|iopImg
operator|&&
name|userFwImg
operator|->
name|iopLen
condition|)
block|{
name|flashImg
operator|.
name|iopImg
operator|=
name|userFwImg
operator|->
name|iopImg
expr_stmt|;
name|flashImg
operator|.
name|iopLen
operator|=
name|userFwImg
operator|->
name|iopLen
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: User fw iop @ %p (%d)\n"
operator|,
name|flashImg
operator|.
name|iopImg
operator|,
name|flashImg
operator|.
name|iopLen
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|userFwImg
operator|->
name|istrImg
operator|&&
name|userFwImg
operator|->
name|istrLen
condition|)
block|{
name|flashImg
operator|.
name|istrImg
operator|=
name|userFwImg
operator|->
name|istrImg
expr_stmt|;
name|flashImg
operator|.
name|istrLen
operator|=
name|userFwImg
operator|->
name|istrLen
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: User fw istr @ %p (%d)\n"
operator|,
name|flashImg
operator|.
name|istrImg
operator|,
name|flashImg
operator|.
name|istrLen
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: user supplied FW is not found\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
ifdef|#
directive|ifdef
name|SA_EXCLUDE_FW_IMG
comment|/* Check that fw images are setup properly */
if|if
condition|(
operator|!
operator|(
name|flashImg
operator|.
name|aap1Img
operator|&&
name|flashImg
operator|.
name|aap1Len
operator|&&
name|flashImg
operator|.
name|ilaImg
operator|&&
name|flashImg
operator|.
name|ilaLen
operator|&&
name|flashImg
operator|.
name|iopImg
operator|&&
name|flashImg
operator|.
name|iopLen
operator|&&
name|flashImg
operator|.
name|istrImg
operator|&&
name|flashImg
operator|.
name|istrLen
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Built-in FW img excluded and not user defined.\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
endif|#
directive|endif
comment|/* Check HDA mode with Soft Reset */
if|if
condition|(
operator|!
name|HDAMode
condition|)
block|{
comment|/* Try soft reset until it goes into HDA mode */
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
comment|/* read response state */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|&
name|HDA_STATUS_BITS
expr_stmt|;
if|if
condition|(
name|regVal
operator|!=
name|BOOTTLOADERHDA_IDLE
condition|)
block|{
comment|/* Can not go into HDA mode with 200 ms wait - HDA Soft Reset failed */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: HDA_RSP_OFFSET1MB+HDA_CMD_CODE_OFFSET = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* HDA Mode - Clear ODMR and ODCR */
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_ODCR
argument_list|,
name|ODCR_CLEAR_ALL
argument_list|)
expr_stmt|;
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_ODMR
argument_list|,
name|ODMR_CLEAR_ALL
argument_list|)
expr_stmt|;
block|}
comment|/* Step 1: Poll BOOTTLOADERHDA_IDLE - HDA mode */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step1:Poll for HDAR_IDLE\n"
operator|)
argument_list|)
expr_stmt|;
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_2
argument_list|)
expr_stmt|;
comment|/* 2 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|&
name|HDA_STATUS_BITS
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|regVal
operator|!=
name|BOOTTLOADERHDA_IDLE
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
if|if
condition|(
operator|!
name|HDA_Been_Reset
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Reset: Step1:regVal =0x%x expect 0x%x\n"
operator|,
name|regVal
operator|,
name|ILAHDA_AAP1_IMG_GET
operator|)
argument_list|)
expr_stmt|;
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
name|HDA_Been_Reset
operator|=
name|agTRUE
expr_stmt|;
goto|goto
name|TryAfterReset
goto|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step1:TIMEOUT: HDA_RSP_OFFSET1MB+HDA_CMD_CODE_OFFSET = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* Step 2: Push the init string to 0x0047E000& data compare */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step2:Push the init string to 0x0047E000!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Cpy
argument_list|(
name|agRoot
argument_list|,
name|ILA_ISTR_ADDROFFSETHDA
argument_list|,
name|flashImg
operator|.
name|istrImg
argument_list|,
name|flashImg
operator|.
name|istrLen
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step2:Copy ISTR array to 0x%x failed\n"
operator|,
name|ILA_ISTR_ADDROFFSETHDA
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* Tell FW ISTR is ready */
name|regVal
operator|=
operator|(
name|HDA_ISTR_DONE
operator||
operator|(
name|bit32
operator|)
name|flashImg
operator|.
name|istrLen
operator|)
expr_stmt|;
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_3
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step2:Host Scratchpad 3 (AAP1-ISTR): 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|stepTime
index|[
literal|2
index|]
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
comment|// TestBase
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: End Step2: (step_time[2] = %d)\n"
operator|,
name|stepTime
index|[
literal|2
index|]
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
comment|/* Step 3: Write the HDA mode SoftReset signature */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step3:Set Signature!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* set signature in host scratch pad0 register to tell SPC that the host performs the HDA mode */
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_0
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
name|stepTime
index|[
literal|3
index|]
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
comment|// TestBase
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: End Step3: (step_time[3] =  %d)\n"
operator|,
name|stepTime
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
comment|// Priya (Apps) requested that the FW load time measurement be started here
name|startTime
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step4: Ready to push ILA to 0x00400000! (start_time =  %d)\n"
operator|,
name|startTime
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
comment|/* Step 4: Push the ILA image to 0x00400000 */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step4:Push the ILA to 0x00400000!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Cpy
argument_list|(
name|agRoot
argument_list|,
literal|0x0
argument_list|,
name|flashImg
operator|.
name|ilaImg
argument_list|,
name|flashImg
operator|.
name|ilaLen
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode:Step4:Copy ILA array to 0x%x failed\n"
operator|,
literal|0x0
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|stepTime
index|[
literal|4
index|]
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: End Step4: (step_time[4] = %d, %d ms)\n"
operator|,
name|stepTime
index|[
literal|4
index|]
operator|,
operator|(
name|stepTime
index|[
literal|4
index|]
operator|-
name|startTime
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
comment|/* Step 5: Tell boot ROM to authenticate ILA and execute it */
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_CMD_OFFSET1MB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_CMD_OFFSET1MB
operator|+
name|HDA_PAR_LEN_OFFSET
argument_list|,
name|flashImg
operator|.
name|ilaLen
argument_list|)
expr_stmt|;
name|regVal
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|&
name|HDA_SEQ_ID_BITS
operator|)
operator|>>
name|SHIFT16
expr_stmt|;
name|regVal
operator|++
expr_stmt|;
name|regVal
operator|=
operator|(
name|HDA_C_PA
operator|<<
name|SHIFT24
operator|)
operator||
operator|(
name|regVal
operator|<<
name|SHIFT16
operator|)
operator||
name|HDAC_EXEC_CMD
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step5:Execute ILA CMD: 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_CMD_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
comment|/* Execute Command */
name|stepTime
index|[
literal|5
index|]
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: End Step5: (step_time[5] = %d, %d ms)\n"
operator|,
name|stepTime
index|[
literal|5
index|]
operator|,
operator|(
name|stepTime
index|[
literal|5
index|]
operator|-
name|startTime
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
comment|/* Step 6: Checking response status from boot ROM, HDAR_EXEC (good), HDAR_BAD_CMD and HDAR_BAD_IMG */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step6:Checking boot ROM reponse status!\n"
operator|)
argument_list|)
expr_stmt|;
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_2
argument_list|)
expr_stmt|;
comment|/* 2 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|&
name|HDA_STATUS_BITS
expr_stmt|;
if|if
condition|(
operator|(
name|HDAR_EXEC
operator|==
name|regVal
operator|)
operator|||
operator|(
name|HDAR_BAD_IMG
operator|==
name|regVal
operator|)
operator|||
operator|(
name|HDAR_BAD_CMD
operator|==
name|regVal
operator|)
condition|)
break|break;
block|}
do|while
condition|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
condition|)
do|;
if|if
condition|(
name|HDAR_BAD_IMG
operator|==
name|regVal
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step6:BAD IMG: HDA_RSP_OFFSET1MB+HDA_CMD_CODE_OFFSET = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'g'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|HDAR_BAD_CMD
operator|==
name|regVal
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step6:BAD IMG: HDA_RSP_OFFSET1MB+HDA_CMD_CODE_OFFSET = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'h'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step6:TIMEOUT: HDA_RSP_OFFSET1MB+HDA_CMD_CODE_OFFSET = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'i'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|stepTime
index|[
literal|6
index|]
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: End Step6: (step_time[6] = %d, %d ms)\n"
operator|,
name|stepTime
index|[
literal|6
index|]
operator|,
operator|(
name|stepTime
index|[
literal|6
index|]
operator|-
name|startTime
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
comment|/* Step 7: Poll ILAHDA_AAP1IMGGET/Offset in MSGU Scratchpad 0 */
comment|/* Check MSGU Scratchpad 1 [1,0] == 00 */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step7:Poll ILAHDA_AAP1_IMG_GET!\n"
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|&
name|SCRATCH_PAD1_RST
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step7:MSG Scratchpad 1: 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_3
argument_list|)
expr_stmt|;
comment|/* 3 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|>>
name|SHIFT24
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|regVal
operator|!=
name|ILAHDA_AAP1_IMG_GET
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
if|if
condition|(
operator|!
name|HDA_Been_Reset
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Reset: Step7:regVal =0x%x expect 0x%x\n"
operator|,
name|regVal
operator|,
name|ILAHDA_AAP1_IMG_GET
operator|)
argument_list|)
expr_stmt|;
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
name|HDA_Been_Reset
operator|=
name|agTRUE
expr_stmt|;
goto|goto
name|TryAfterReset
goto|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: TIMEOUT: Step7:regVal =0x%x expect 0x%x\n"
operator|,
name|regVal
operator|,
name|ILAHDA_AAP1_IMG_GET
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'j'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step7:MSG Scratchpad 0: 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|&
literal|0x00FFFFFF
expr_stmt|;
name|stepTime
index|[
literal|7
index|]
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: End Step7: (step_time[7] = %d, %d ms)\n"
operator|,
name|stepTime
index|[
literal|7
index|]
operator|,
operator|(
name|stepTime
index|[
literal|7
index|]
operator|-
name|startTime
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
comment|/* Step 8: Copy AAP1 image, update the Host Scratchpad 3 */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step8:Push the AAP1 to 0x00400000 plus 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Cpy
argument_list|(
name|agRoot
argument_list|,
name|regVal
argument_list|,
name|flashImg
operator|.
name|aap1Img
argument_list|,
name|flashImg
operator|.
name|aap1Len
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step8:Copy AAP1 array to 0x%x failed\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'k'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|regVal
operator|=
operator|(
name|HDA_AAP1_DONE
operator||
operator|(
name|bit32
operator|)
name|flashImg
operator|.
name|aap1Len
operator|)
expr_stmt|;
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_3
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step8:Host Scratchpad 3 (AAP1): 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|stepTime
index|[
literal|8
index|]
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: End Step8: (step_time[8] = %d, %d ms)\n"
operator|,
name|stepTime
index|[
literal|8
index|]
operator|,
operator|(
name|stepTime
index|[
literal|8
index|]
operator|-
name|startTime
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
comment|/* Step 9: Poll ILAHDA_IOPIMGGET/Offset in MSGU Scratchpad 0 */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step9:Poll ILAHDA_IOP_IMG_GET!\n"
operator|)
argument_list|)
expr_stmt|;
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_2
argument_list|)
expr_stmt|;
comment|/* 2 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|>>
name|SHIFT24
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|regVal
operator|!=
name|ILAHDA_IOP_IMG_GET
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step9:TIMEOUT:MSGU_SCRATCH_PAD_0 = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'l'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step9:MSG Scratchpad 0: 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|&
name|HDA_GSM_OFFSET_BITS
expr_stmt|;
name|stepTime
index|[
literal|9
index|]
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: End Step9: (step_time[9] = %d, %d ms)\n"
operator|,
name|stepTime
index|[
literal|9
index|]
operator|,
operator|(
name|stepTime
index|[
literal|9
index|]
operator|-
name|startTime
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
comment|// saHdaLoadForceHalt(agRoot);  // TestBase
comment|/* Step 10: Copy IOP image, update the Host Scratchpad 3 */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step10:Push the IOP to 0x00400000 plus 0x%x!\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Cpy
argument_list|(
name|agRoot
argument_list|,
name|regVal
argument_list|,
name|flashImg
operator|.
name|iopImg
argument_list|,
name|flashImg
operator|.
name|iopLen
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step10:Copy IOP array to 0x%x failed\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'m'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|regVal
operator|=
operator|(
name|HDA_IOP_DONE
operator||
operator|(
name|bit32
operator|)
name|flashImg
operator|.
name|iopLen
operator|)
expr_stmt|;
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_3
argument_list|,
name|regVal
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step10:Host Scratchpad 3 (IOP): 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|stepTime
index|[
literal|10
index|]
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: End Step10: (step_time[10] = %d, %d ms)\n"
operator|,
name|stepTime
index|[
literal|10
index|]
operator|,
operator|(
name|stepTime
index|[
literal|10
index|]
operator|-
name|startTime
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
comment|/* Clear the signature */
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* step 11: wait for the FW and IOP to get ready - 1 sec timeout */
comment|/* Wait for the SPC Configuration Table to be ready */
name|stepTime
index|[
literal|11
index|]
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Start Step11: Wait for FW ready. (step_time[11.1] =  %d, %d ms)\n"
operator|,
name|stepTime
index|[
literal|11
index|]
operator|,
operator|(
name|stepTime
index|[
literal|11
index|]
operator|-
name|startTime
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
name|endTime
operator|=
name|ossaTimeStamp
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: End Step11: FW ready! (end_time= %d, fw_load_time = %d ms)\n"
operator|,
name|endTime
operator|,
name|endTime
operator|-
name|startTime
operator|)
argument_list|)
expr_stmt|;
comment|// TestBase
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step11:Poll for FW ready!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpiWaitForConfigTable
argument_list|(
name|agRoot
argument_list|,
operator|&
name|mainCfg
argument_list|)
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
comment|/* return error if MPI Configuration Table not ready */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step11:SPC FW not ready SCRATCH_PAD1 = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
comment|/* return error if MPI Configuration Table not ready */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step11:SPC FW not ready SCRATCH_PAD2 = 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
comment|/* read detail fatal errors */
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step11:ScratchPad0 AAP error code 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: Step11:ScratchPad3 IOP error code 0x%x\n"
operator|,
name|regVal
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'n'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'o'
argument_list|,
literal|"5d"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode: HDA Mode Complete\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief memcopy cross PCI from host memory to card memory  *  *  \param agRoot        handles for this instance of SAS/SATA hardware  *  \param dstoffset     distination offset  *  \param src           source pointer  *  \param DWcount       DWord count  *  \param busBaseNumber PCI Bus Base number  *  *  \return -void-  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|LOCAL
name|void
name|siPciMemCpy
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|dstoffset
parameter_list|,
name|void
modifier|*
name|src
parameter_list|,
name|bit32
name|DWcount
parameter_list|,
name|bit32
name|busBaseNumber
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|,
name|val
decl_stmt|;
name|bit32
modifier|*
name|src1
decl_stmt|;
name|src1
operator|=
operator|(
name|bit32
operator|*
operator|)
name|src
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DWcount
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|BIT32_TO_LEBIT32
argument_list|(
name|src1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|busBaseNumber
argument_list|,
operator|(
name|dstoffset
operator|+
name|i
operator|*
literal|4
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Function to copy FW array  *  *  The siBar4Cpy() function is called to copy FW array via BAR4  *  (PCIe spec: BAR4, MEMBASE-III in PM, PCIBAR2 in host driver)  *  in 64-KB MEMBASE MODE.  *  *  \param agRoot     handles for this instance of SAS/SATA hardware  *  \param offset     destination offset  *  \param parray     pointer of array  *  \param array_size size of array  *  *  \return AGSA_RC_SUCCESS or AGSA_RC_FAILURE  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|LOCAL
name|bit32
name|siBar4Cpy
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|offset
parameter_list|,
name|bit8
modifier|*
name|parray
parameter_list|,
name|bit32
name|array_size
parameter_list|)
block|{
name|bit32
name|dest_shift_addr
decl_stmt|,
name|dest_offset
decl_stmt|,
name|cpy_size
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"5f"
argument_list|)
expr_stmt|;
comment|/* first time to shift */
name|dest_shift_addr
operator|=
operator|(
name|GSMSM_AXI_LOWERADDR
operator|+
name|offset
operator|)
operator|&
name|SHIFT_MASK
expr_stmt|;
name|dest_offset
operator|=
name|offset
operator|&
name|OFFSET_MASK
expr_stmt|;
do|do
block|{
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|dest_shift_addr
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode:Shift Bar4 to 0x%x failed\n"
operator|,
name|dest_shift_addr
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"5f"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
operator|(
name|dest_offset
operator|+
name|array_size
operator|)
operator|>
name|SIZE_64KB
condition|)
block|{
name|cpy_size
operator|=
name|SIZE_64KB
operator|-
name|dest_offset
expr_stmt|;
block|}
else|else
name|cpy_size
operator|=
name|array_size
expr_stmt|;
name|siPciMemCpy
argument_list|(
name|agRoot
argument_list|,
name|dest_offset
argument_list|,
name|parray
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CEILING
argument_list|(
name|cpy_size
argument_list|,
literal|4
argument_list|)
argument_list|)
argument_list|,
name|PCIBAR2
argument_list|)
expr_stmt|;
name|array_size
operator|-=
name|cpy_size
expr_stmt|;
name|dest_shift_addr
operator|+=
name|SIZE_64KB
expr_stmt|;
name|dest_offset
operator|=
literal|0
expr_stmt|;
name|parray
operator|=
name|parray
operator|+
name|cpy_size
expr_stmt|;
block|}
do|while
condition|(
name|array_size
operator|!=
literal|0
condition|)
do|;
comment|/* Shift back to BAR4 original address */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
literal|0x0
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode:Shift Bar4 to 0x%x failed\n"
operator|,
literal|0x0
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"5f"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"5f"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|siHDAMode_V
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|HDAMode
parameter_list|,
name|agsaFwImg_t
modifier|*
name|userFwImg
parameter_list|)
block|{
name|bit32
name|returnVal
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|bit32
name|save
decl_stmt|,
name|i
decl_stmt|,
name|biggest
decl_stmt|;
name|bit32
name|hda_status
decl_stmt|;
name|bit32
name|hda_command_complete
init|=
literal|0
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
name|bit32
name|seq_id
init|=
literal|0
decl_stmt|;
name|bit32
name|base_Hi
init|=
literal|0
decl_stmt|;
name|bit32
name|base_Lo
init|=
literal|0
decl_stmt|;
name|bit8
modifier|*
name|pbase
decl_stmt|;
name|spcv_hda_cmd_t
name|hdacmd
decl_stmt|;
name|spcv_hda_rsp_t
name|hdarsp
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
decl_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|saRoot
operator|)
argument_list|,
literal|"saRoot is NULL"
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: HDAMode %X\n"
operator|,
name|HDAMode
operator|)
argument_list|)
expr_stmt|;
name|siScratchDump
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|userFwImg
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: No image agNULL == userFwImg\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
name|hda_status
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: hda_status 0x%08X\n"
operator|,
name|hda_status
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:                                                                   STEP 1\n"
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2X"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* TP:2X STEP 1 */
comment|/* Find largest Physical chunk memory */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|biggest
operator|=
literal|0
operator|,
name|save
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|memoryAllocated
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|saRoot
operator|->
name|memoryAllocated
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|totalLength
operator|>
name|biggest
condition|)
block|{
if|if
condition|(
name|biggest
operator|<
name|saRoot
operator|->
name|memoryAllocated
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|totalLength
condition|)
block|{
name|save
operator|=
name|i
expr_stmt|;
name|biggest
operator|=
name|saRoot
operator|->
name|memoryAllocated
operator|.
name|agMemory
index|[
name|i
index|]
operator|.
name|totalLength
expr_stmt|;
block|}
block|}
block|}
comment|/* Step 1 The host reads the HDA response field RSP_CODE at byte offset 28:29 of the response block for HDAR_IDLE (0x8002) via MEMBASE-I. A value other than HDAR_IDLE (0x8002) indicates that the SPCv controller is not in HDA mode. Follow the steps described in Section 4.21.1 to bring the SPCv controller into HDA mode. When the host reads the correct RSP_CODE, it indicates that the SPCv controller boot ROM is ready to proceed to the next step of HDA initialization */
name|base_Hi
operator|=
name|saRoot
operator|->
name|memoryAllocated
operator|.
name|agMemory
index|[
name|save
index|]
operator|.
name|phyAddrUpper
expr_stmt|;
name|base_Lo
operator|=
name|saRoot
operator|->
name|memoryAllocated
operator|.
name|agMemory
index|[
name|save
index|]
operator|.
name|phyAddrLower
expr_stmt|;
name|pbase
operator|=
name|saRoot
operator|->
name|memoryAllocated
operator|.
name|agMemory
index|[
name|save
index|]
operator|.
name|virtPtr
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:Use DMA memory at [%d] size 0x%x (%d) DMA Loc U 0x%08x L 0x%08x @%p\n"
operator|,
name|save
operator|,
name|biggest
operator|,
name|biggest
operator|,
name|base_Hi
operator|,
name|base_Lo
operator|,
name|pbase
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: HDA aap1Img %p len %8d 0x%x\n"
operator|,
name|userFwImg
operator|->
name|aap1Img
operator|,
name|userFwImg
operator|->
name|aap1Len
operator|,
name|userFwImg
operator|->
name|aap1Len
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: HDA ilaImg  %p len %8d 0x%x\n"
operator|,
name|userFwImg
operator|->
name|ilaImg
operator|,
name|userFwImg
operator|->
name|ilaLen
operator|,
name|userFwImg
operator|->
name|ilaLen
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: HDA iopImg  %p len %8d 0x%x\n"
operator|,
name|userFwImg
operator|->
name|iopImg
operator|,
name|userFwImg
operator|->
name|iopLen
operator|,
name|userFwImg
operator|->
name|iopLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|userFwImg
operator|->
name|aap1Len
operator|>
name|biggest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: HDA DMA area too small %d< %d aap1Len\n"
operator|,
name|biggest
operator|,
name|userFwImg
operator|->
name|aap1Len
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|"aap1Len> biggest"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
if|if
condition|(
name|userFwImg
operator|->
name|ilaLen
operator|>
name|biggest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: HDA DMA area too small %d< %d ilaLen\n"
operator|,
name|biggest
operator|,
name|userFwImg
operator|->
name|ilaLen
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|"ilaLen> biggest"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
if|if
condition|(
name|userFwImg
operator|->
name|iopLen
operator|>
name|biggest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: HDA DMA area too small %d< %d iopLen\n"
operator|,
name|biggest
operator|,
name|userFwImg
operator|->
name|iopLen
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|"iopLen> biggest"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
if|if
condition|(
name|HDA_STEP_2
condition|)
block|{
comment|/* ILA */
name|si_memset
argument_list|(
name|pbase
argument_list|,
literal|0
argument_list|,
name|biggest
argument_list|)
expr_stmt|;
if|if
condition|(
name|userFwImg
operator|->
name|ilaLen
operator|<
name|biggest
condition|)
block|{
name|si_memcpy
argument_list|(
name|pbase
argument_list|,
name|userFwImg
operator|->
name|ilaImg
argument_list|,
name|userFwImg
operator|->
name|ilaLen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:  userFwImg->ilaLen 0x%x< biggest 0x%x\n"
operator|,
name|userFwImg
operator|->
name|ilaLen
operator|,
name|biggest
operator|)
argument_list|)
expr_stmt|;
block|}
name|si_memset
argument_list|(
operator|&
name|hdacmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|spcv_hda_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|hdarsp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|spcv_hda_rsp_t
argument_list|)
argument_list|)
expr_stmt|;
name|hda_status
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hda_status
operator|&
name|SPC_V_HDAR_RSPCODE_MASK
operator|)
operator|==
name|SPC_V_HDAR_IDLE
condition|)
block|{
name|hdacmd
operator|.
name|cmdparm_0
operator|=
name|base_Lo
expr_stmt|;
comment|/* source DmaBase_l*/
name|hdacmd
operator|.
name|cmdparm_1
operator|=
name|base_Hi
expr_stmt|;
comment|/* source DmaBase_u*/
name|hdacmd
operator|.
name|cmdparm_2
operator|=
literal|0x1e200000
expr_stmt|;
comment|/* destin */
name|hdacmd
operator|.
name|cmdparm_3
operator|=
literal|0
expr_stmt|;
comment|/* destin */
name|hdacmd
operator|.
name|cmdparm_4
operator|=
name|userFwImg
operator|->
name|ilaLen
expr_stmt|;
comment|/* length */
name|hdacmd
operator|.
name|cmdparm_5
operator|=
literal|0
expr_stmt|;
comment|/* not used */
name|hdacmd
operator|.
name|cmdparm_6
operator|=
literal|0
expr_stmt|;
comment|/* not used */
name|seq_id
operator|++
expr_stmt|;
name|hdacmd
operator|.
name|C_PA_SEQ_ID_CMD_CODE
operator|=
operator|(
name|SPC_V_HDAC_PA
operator|<<
name|SHIFT24
operator|)
operator||
operator|(
name|seq_id
operator|<<
name|SHIFT16
operator|)
operator||
name|SPC_V_HDAC_DMA
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:          Write SPC_V_HDAC_DMA                                     STEP 2\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       Step 2       The host writes the HDAC_DMA (0x000 24) in the command field CMD_CODE via MEMBASE-I       for issuing the DMA command to ask the boot ROM to pull the ILA image via DMA into       GSM with the following parameters set up first:       Parameter 1:0: Host physical address for holding the HDA-ILA image.       Parameter 3:2: GSM physical address 0x1E20_0000.       Parameter 4: the length of the HDAILA  image.       */
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: Write ILA to offset %X\n"
operator|,
name|hdacmd
operator|.
name|cmdparm_2
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|0
argument_list|,
name|hdacmd
operator|.
name|cmdparm_0
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|4
argument_list|,
name|hdacmd
operator|.
name|cmdparm_1
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|8
argument_list|,
name|hdacmd
operator|.
name|cmdparm_2
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|12
argument_list|,
name|hdacmd
operator|.
name|cmdparm_3
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|16
argument_list|,
name|hdacmd
operator|.
name|cmdparm_4
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|20
argument_list|,
name|hdacmd
operator|.
name|cmdparm_5
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|24
argument_list|,
name|hdacmd
operator|.
name|cmdparm_6
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|28
argument_list|,
name|hdacmd
operator|.
name|C_PA_SEQ_ID_CMD_CODE
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V:  Command 0 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|0
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|4
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|8
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|12
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|16
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|20
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|24
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|28
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: command %X\n"
operator|,
name|hdacmd
operator|.
name|C_PA_SEQ_ID_CMD_CODE
operator|)
argument_list|)
expr_stmt|;
name|max_wait_time
operator|=
operator|(
literal|2000
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 2 seconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
name|hda_command_complete
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|hda_command_complete
operator|=
operator|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|&
name|SPC_V_HDAR_SEQID_MASK
operator|)
operator|>>
name|SHIFT16
operator|)
operator|==
name|seq_id
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|hda_command_complete
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD1 = 0x%x STEP 2 took %d\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2Y"
argument_list|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
argument_list|)
expr_stmt|;
comment|/* TP:2Y STEP 2 took */
if|if
condition|(
operator|!
name|hda_command_complete
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:2SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:hda_command_complete failed Step 2\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V:2SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: ILA DMA done\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* end ila   */
if|if
condition|(
name|HDA_STEP_3
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:                                                                   STEP 3\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       Step 3       The host polls the HDA response field RSP_CODE for HDAR_IDLE (0x8002) via MEMBASE-I. The polling timeout       should be no more than 1 second. The response status, HDAR_IDLE with its status equal to 0x10,       indicates a DMA success response from the boot ROM. Response states that indicate a failure are:       HDAR_BAD_CMD HDAR_BAD_IMG HDAR_IDLE with its status equal to 0x11      */
name|max_wait_time
operator|=
operator|(
literal|2000
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 2 seconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
name|hda_command_complete
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|hda_command_complete
operator|=
operator|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|&
name|SPC_V_HDAR_SEQID_MASK
operator|)
operator|>>
name|SHIFT16
operator|)
operator|==
name|seq_id
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|hda_command_complete
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD1 = 0x%x STEP 3 took %d\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2Z"
argument_list|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
argument_list|)
expr_stmt|;
comment|/* TP:2Z STEP 3 took */
if|if
condition|(
operator|!
name|hda_command_complete
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: Response 0 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|0
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|4
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|8
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|12
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|16
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|20
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|24
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:3SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:hda_command_complete failed Step 3\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
name|hda_command_complete
operator|=
operator|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|&
name|SPC_V_HDAR_SEQID_MASK
operator|)
operator|>>
name|SHIFT16
operator|)
operator|==
name|seq_id
expr_stmt|;
name|hda_status
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|&
name|SPC_V_HDAR_RSPCODE_MASK
operator|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V:ILA is ready hda_status %X hda_command_complete %d\n"
operator|,
name|hda_status
operator|,
name|hda_command_complete
operator|)
argument_list|)
expr_stmt|;
comment|/* Tell FW ILA is ready */
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: Response 0 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|0
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|4
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|8
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|12
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|16
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|20
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|24
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V:3SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: Step 3 MSGU_HOST_SCRATCH_PAD_3 write %X\n"
operator|,
name|HDA_ISTR_DONE
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_3
argument_list|,
name|HDA_ISTR_DONE
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V:3SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|HDA_STEP_4
condition|)
block|{
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: Exec ILA\n"
operator|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|hdacmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|spcv_hda_cmd_t
argument_list|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|hdarsp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|spcv_hda_rsp_t
argument_list|)
argument_list|)
expr_stmt|;
name|hdacmd
operator|.
name|cmdparm_0
operator|=
literal|0x200000
expr_stmt|;
comment|/* length  SPC_V_HDAC_EXEC*/
empty_stmt|;
name|hdacmd
operator|.
name|cmdparm_1
operator|=
name|userFwImg
operator|->
name|ilaLen
expr_stmt|;
comment|/* length  SPC_V_HDAC_EXEC*/
empty_stmt|;
name|seq_id
operator|++
expr_stmt|;
name|hdacmd
operator|.
name|C_PA_SEQ_ID_CMD_CODE
operator|=
operator|(
name|SPC_V_HDAC_PA
operator|<<
name|SHIFT24
operator|)
operator||
operator|(
name|seq_id
operator|<<
name|SHIFT16
operator|)
operator||
name|SPC_V_HDAC_EXEC
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:                                                                   STEP 4\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     Step 4     The host writes the HDAC_EXEC command (0x0002) via MEMBASE-I for the boot ROM to authenticate     and execute the HDA-ILA image. The host sets parameter 0 and parameter 1 for the HDA-ILA image     appropriately:     Parameter 0: Entry offset this value must be 0x20_0000.     Parameter 1: the HDA-ILA image length.     */
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|0
argument_list|,
name|hdacmd
operator|.
name|cmdparm_0
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|4
argument_list|,
name|hdacmd
operator|.
name|cmdparm_1
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|8
argument_list|,
name|hdacmd
operator|.
name|cmdparm_2
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|12
argument_list|,
name|hdacmd
operator|.
name|cmdparm_3
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|16
argument_list|,
name|hdacmd
operator|.
name|cmdparm_4
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|20
argument_list|,
name|hdacmd
operator|.
name|cmdparm_5
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|24
argument_list|,
name|hdacmd
operator|.
name|cmdparm_6
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|28
argument_list|,
name|hdacmd
operator|.
name|C_PA_SEQ_ID_CMD_CODE
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: Exec ILA\n"
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V:  Command 0 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|0
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|4
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|8
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|12
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|16
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|20
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|24
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_COMMAND_OFFSET
operator|+
literal|28
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: command %X\n"
operator|,
name|hdacmd
operator|.
name|C_PA_SEQ_ID_CMD_CODE
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V:4SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
comment|// End Step 4
if|if
condition|(
name|HDA_STEP_5
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:                                             start wait            STEP 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       Step 5       The host continues polling for the HDA-ILA status via MEMBASE-I. The polling timeout should       be no more than 1 second. The response status HDAR_EXEC indicates a good response from the       boot ROM. Response states that indicate a failure are:       HDAR_BAD_CMD       HDAR_BAD_IMG     */
name|max_wait_time
operator|=
operator|(
literal|2000
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 2 seconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
name|hda_command_complete
operator|=
literal|0
expr_stmt|;
name|hda_status
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|&
name|SPC_V_HDAR_RSPCODE_MASK
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD1 = 0x%x hda_status 0x%x Begin STEP 5\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
name|hda_status
operator|)
argument_list|)
expr_stmt|;
name|hda_status
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|hda_status
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|&
name|SPC_V_HDAR_RSPCODE_MASK
operator|)
expr_stmt|;
name|hda_command_complete
operator|=
operator|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|&
name|SPC_V_HDAR_SEQID_MASK
operator|)
operator|>>
name|SHIFT16
operator|)
operator|==
name|seq_id
expr_stmt|;
block|}
do|while
condition|(
name|hda_status
operator|!=
name|SPC_V_HDAR_EXEC
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD1 = 0x%x hda_status 0x%x hda_command_complete 0x%x STEP 5 wait for seq_id took %d\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
name|hda_status
operator|,
name|hda_command_complete
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2Z"
argument_list|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
argument_list|)
expr_stmt|;
comment|/* TP:2Z STEP 5 took */
if|if
condition|(
operator|!
name|hda_command_complete
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: Response 0 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|0
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|4
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|8
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|12
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|16
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|20
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|24
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:5SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:hda_command_complete failed Step 5\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'g'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
if|if
condition|(
name|hda_status
operator|!=
name|SPC_V_HDAR_EXEC
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:ILA_EXEC_ERROR hda_status %X hda_command_complete %d\n"
operator|,
name|hda_status
operator|,
name|hda_command_complete
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'h'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
goto|goto
name|bootrom_err
goto|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:           end    seq_id updated                                   STEP 5\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|// End Step 5
if|if
condition|(
name|HDA_STEP_6
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:  start                                                            STEP 6\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       Step 6       The host polls the upper 8 bits [31:24] 5 of the Scratchpad 0 Register       (page 609) for the ILAHDA_RAAE_IMG_GET (0x11) state. Polling timeout       should be no more than 2 seconds. If a polling timeout occurs, the host       should check for a fatal error as described in Section 12.2.       If successful, the Host Scratchpad 4 Register (page 620) and Host       Scratchpad 5 Register (page 621) are set as follows: Host Scratchpad 4       Register (page 620) holds the lower 32-bit host address of       the RAAE image. Host Scratchpad 5 Register (page 621)       holds the upper 32-bit host address of the RAAE image.       Then the host writes the command ILAHDAC_RAAE_IMG_DONE(0x81) to the upper       8 bits [31:24] of the Host Scratchpad 3 Register (page 619) and writes the       sizeof the RAAE image to the lower 24 bits [23:0].     */
name|max_wait_time
operator|=
operator|(
literal|2000
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 2 seconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
name|hda_command_complete
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|hda_command_complete
operator|=
operator|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|&
literal|0xff000000
operator|)
operator|>>
name|SHIFT24
operator|)
operator|==
name|ILAHDA_RAAE_IMG_GET
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|hda_command_complete
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD0 = 0x%x STEP 6 wait for ILAHDA_RAAE_IMG_GET took %d\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2b"
argument_list|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
argument_list|)
expr_stmt|;
comment|/* TP:2b STEP 6 took */
if|if
condition|(
operator|!
name|hda_command_complete
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:hda_command_complete failed Step 6\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'i'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
goto|goto
name|fw_err
goto|;
block|}
name|si_memset
argument_list|(
name|pbase
argument_list|,
literal|0
argument_list|,
name|biggest
argument_list|)
expr_stmt|;
if|if
condition|(
name|userFwImg
operator|->
name|aap1Len
operator|<
name|biggest
condition|)
block|{
name|si_memcpy
argument_list|(
name|pbase
argument_list|,
name|userFwImg
operator|->
name|aap1Img
argument_list|,
name|userFwImg
operator|->
name|aap1Len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:  userFwImg->aap1Len 0x%x< biggest 0x%x\n"
operator|,
name|userFwImg
operator|->
name|aap1Len
operator|,
name|biggest
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*     */
comment|/* upper */
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_5
argument_list|,
name|base_Hi
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"siHDAMode_V: MSGU_HOST_SCRATCH_PAD_5 0x%X\n"
operator|,
name|base_Hi
operator|)
argument_list|)
expr_stmt|;
comment|/* lower */
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_4
argument_list|,
name|base_Lo
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"siHDAMode_V: MSGU_HOST_SCRATCH_PAD_4 0x%X\n"
operator|,
name|base_Lo
operator|)
argument_list|)
expr_stmt|;
comment|/* len */
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_3
argument_list|,
operator|(
name|ILAHDAC_RAAE_IMG_DONE
operator|<<
name|SHIFT24
operator|)
operator||
name|userFwImg
operator|->
name|aap1Len
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: write ILAHDAC_RAAE_IMG_DONE to MSGU_HOST_SCRATCH_PAD_3 0x%X\n"
operator|,
operator|(
name|ILAHDAC_RAAE_IMG_DONE
operator|<<
name|SHIFT24
operator|)
operator||
name|userFwImg
operator|->
name|aap1Len
operator|)
argument_list|)
expr_stmt|;
comment|//    ossaHwRegWriteExt(agRoot, PCIBAR0,MSGU_HOST_SCRATCH_PAD_4 , userFwImg->DmaBase_l);
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|gWaitmSec
operator|*
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
literal|1
condition|)
comment|/* step in question */
block|{
name|max_wait_time
operator|=
operator|(
literal|2000
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 2 seconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
name|hda_command_complete
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|hda_command_complete
operator|=
operator|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|&
literal|0xff000000
operator|)
operator|>>
name|SHIFT24
operator|)
operator|==
name|ILAHDA_IOP_IMG_GET
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|hda_command_complete
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD1 = 0x%x STEP 7 wait for ILAHDA_IOP_IMG_GET took %d\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2c"
argument_list|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
argument_list|)
expr_stmt|;
comment|/* TP:2c STEP 6a ILAHDA_IOP_IMG_GET took */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2y"
argument_list|,
name|hda_command_complete
argument_list|)
expr_stmt|;
comment|/* TP:2y hda_command_complete */
if|if
condition|(
operator|!
name|hda_command_complete
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:hda_command_complete failed Step 7\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'j'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
goto|goto
name|fw_err
goto|;
block|}
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:  End                  V_Scratchpad_0_Register 0x%08X          STEP 6\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|HDA_STEP_7
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:                                                                   STEP 7\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       Step 7       The host polls (reads) the upper 8 bits 7 [31:24] of the Scratchpad 0 Register (page 609)       for ILAHDA_IOP_IMG_GET (0x10) state. The polling timeout should be no more than 2 seconds.       If a polling timeout occurs, the host should check for a fatal error as described in       Section 12.2. If successful, the Host Scratchpad 4 Register (page 620) and Host       Scratchpad 5 Register (page 621) are set as follows:       Host Scratchpad 4 Register (page 620) holds the lower host address of the IOP image.       Host Scratchpad 5 Register (page 621) holds the upper host address of the IOP image.       Then host writes the command ILAHDAC_IOP_IMG_DONE(0x80) to the upper 8 bits [31:24] of the       Host Scratchpad 3 Register  (page 614)and writes the sizeof the IOP image to the lower 24       bits [23:0].      */
name|si_memset
argument_list|(
name|pbase
argument_list|,
literal|0
argument_list|,
name|biggest
argument_list|)
expr_stmt|;
if|if
condition|(
name|userFwImg
operator|->
name|iopLen
operator|<
name|biggest
condition|)
block|{
name|si_memcpy
argument_list|(
name|pbase
argument_list|,
name|userFwImg
operator|->
name|iopImg
argument_list|,
name|userFwImg
operator|->
name|iopLen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:  userFwImg->iopImg 0x%x< biggest 0x%x\n"
operator|,
name|userFwImg
operator|->
name|iopLen
operator|,
name|biggest
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* upper */
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_5
argument_list|,
name|base_Hi
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"siHDAMode_V: MSGU_HOST_SCRATCH_PAD_5 0x%X\n"
operator|,
name|base_Hi
operator|)
argument_list|)
expr_stmt|;
comment|/* lower */
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_4
argument_list|,
name|base_Lo
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"siHDAMode_V: MSGU_HOST_SCRATCH_PAD_4 0x%X\n"
operator|,
name|base_Lo
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: MSGU_HOST_SCRATCH_PAD_4\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* len */
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_3
argument_list|,
operator|(
name|ILAHDAC_IOP_IMG_DONE
operator|<<
name|SHIFT24
operator|)
operator||
name|userFwImg
operator|->
name|iopLen
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: MSGU_HOST_SCRATCH_PAD_3 0x%X\n"
operator|,
operator|(
name|ILAHDAC_IOP_IMG_DONE
operator|<<
name|SHIFT24
operator|)
operator||
name|userFwImg
operator|->
name|iopLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|->
name|swConfig
operator|.
name|hostDirectAccessMode
operator|&
literal|2
condition|)
block|{
comment|/* Hda AES DIF offload */
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|V_Scratchpad_Rsvd_0_Register
argument_list|,
name|HDA_AES_DIF_FUNC
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: V_Scratchpad_Rsvd_0_Register, HDA_AES_DIF_FUNC 0x%X\n"
operator|,
name|HDA_AES_DIF_FUNC
operator|)
argument_list|)
expr_stmt|;
comment|/* Hda AES DIF offload */
block|}
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|max_wait_time
operator|=
operator|(
literal|2000
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 2 seconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
name|hda_command_complete
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|hda_command_complete
operator|=
operator|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|&
literal|0xff000000
operator|)
operator|>>
name|SHIFT24
operator|)
operator|==
name|ILAHDA_IOP_IMG_GET
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|hda_command_complete
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2d"
argument_list|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
argument_list|)
expr_stmt|;
comment|/* TP:2d STEP 7 ILAHDA_IOP_IMG_GET took */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2z"
argument_list|,
name|hda_command_complete
argument_list|)
expr_stmt|;
comment|/* TP:2z hda_command_complete */
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD0 = 0x%x STEP 7 wait for ILAHDA_IOP_IMG_GET took %d\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hda_command_complete
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:7SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:hda_command_complete failed Step 7\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'k'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V:7SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:  End                    STEP 7\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|HDA_STEP_8
condition|)
block|{
name|bit32
name|SCRATCH_PAD1
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:     Check fw ready                                                Step 8\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     Step 8     IOP0/1 start-up sequence. The host polls the Scratchpad 1 Register (page 610)     bits [1:0] for RAAE_STATE, bits [13:12] for IOP1_STATE, and     bits [11:10] for IOP0_STATE to go to 11b (Ready state).     The polling timeout should be no more than 1 second. If a polling timeout occurs,     the host should check for a fatal error in Section 12.2.     */
name|returnVal
operator|=
name|AGSA_RC_SUCCESS
expr_stmt|;
name|max_wait_time
operator|=
operator|(
literal|1000
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 1000 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|SCRATCH_PAD1
operator|==
literal|0xFFFFFFFF
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"HZ"
argument_list|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
argument_list|)
expr_stmt|;
comment|/* TP:2f Step 8 PCI took */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD1 = 0x%x (0x%x) Step 8 PCIe took %d\n"
operator|,
name|SCRATCH_PAD1
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* ILA */
name|max_wait_time
operator|=
operator|(
literal|1000
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 1000 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_ILA_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_ILA_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2g"
argument_list|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
argument_list|)
expr_stmt|;
comment|/* TP:2g Step 8 ILA took */
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD1 = 0x%x SCRATCH_PAD1_V_ILA_MASK (0x%x)(0x%x) took %d\n"
operator|,
name|SCRATCH_PAD1
operator|,
name|SCRATCH_PAD1_V_ILA_MASK
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
comment|// Ignore for now returnVal = AGSA_RC_FAILURE;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:Timeout SCRATCH_PAD1_V_ILA_MASK (0x%x)  not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_ILA_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD1 = 0x%x SCRATCH_PAD1_V_ILA_MASK (0x%x)(0x%x) took %d\n"
operator|,
name|SCRATCH_PAD1
operator|,
name|SCRATCH_PAD1_V_ILA_MASK
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* RAAE */
name|max_wait_time
operator|=
operator|(
literal|1800
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 1800 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD1 = 0x%x SCRATCH_PAD1_V_RAAE_MASK (0x%x)(0x%x) took %d\n"
operator|,
name|SCRATCH_PAD1
operator|,
name|SCRATCH_PAD1_V_RAAE_MASK
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2h"
argument_list|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
argument_list|)
expr_stmt|;
comment|/* TP:2h Step 8 RAAE took */
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:Timeout SCRATCH_PAD1_V_RAAE_MASK (0x%x) not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_RAAE_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* IOP0 */
name|max_wait_time
operator|=
operator|(
literal|600
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 600 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
operator|-
name|WAIT_INCREMENT
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_IOP0_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_IOP0_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:SCRATCH_PAD1 = 0x%x  SCRATCH_PAD1_V_IOP0_MASK(0x%x)(0x%x) took %d\n"
operator|,
name|SCRATCH_PAD1
operator|,
name|SCRATCH_PAD1_V_IOP0_MASK
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2i"
argument_list|,
operator|(
name|max_wait_time
operator|-
name|max_wait_count
operator|)
argument_list|)
expr_stmt|;
comment|/* TP:2i Step 8 IOP took */
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:Timeout SCRATCH_PAD1_V_IOP0_MASK (0x%x) not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_IOP0_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: Step 8 0x%X ERROR_STATE 0x%X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_SoftResetRegister
argument_list|)
operator|,
name|SCRATCH_PAD1_V_ERROR_STATE
argument_list|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SCRATCH_PAD1_V_ERROR_STATE
argument_list|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|smIS_ENCRYPT
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: Encryption and HDA mode not supported - failed Step 8\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: ERROR_STATE failed Step 8\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|returnVal
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'l'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
goto|goto
name|fw_err
goto|;
block|}
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V:                      returnVal  0x%X                               Step 8\n"
operator|,
name|returnVal
operator|)
argument_list|)
expr_stmt|;
comment|/* Step 10 The host continues with the normal SPCv Configuration Table initialization sequence as described in Section 6.2.8.1. */
if|if
condition|(
name|saRoot
operator|->
name|swConfig
operator|.
name|hostDirectAccessMode
operator|&
literal|2
condition|)
block|{
comment|/* Hda AES DIF offload */
name|SA_DBG1
argument_list|(
operator|(
literal|"siHDAMode_V: AES/DIF 0x%08X offload enabled %s\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|,
operator|(
operator|(
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|SHIFT15
operator|)
operator|)
condition|?
literal|"yes"
else|:
literal|"no"
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Hda AES DIF offload */
comment|/* ossaHwRegWrite(agRoot, V_Scratchpad_Rsvd_0_Register, 0); */
comment|/* Hda AES DIF offload */
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'m'
argument_list|,
literal|"2W"
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
name|bootrom_err
label|:
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: Response 0 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|0
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|4
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|8
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|12
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|16
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|20
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|24
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|fw_err
label|:
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siHDAMode_V: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|returnVal
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SA_ENABLE_HDA_FUNCTIONS */
end_comment

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Function to check FW is ready for soft reset  *  *  The siSpcSoftResetRDYChk() function is called to check status of FW  *  *  \param agRoot handles for this instance of SAS/SATA hardware  *  *  \return success or fail  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|LOCAL
name|bit32
name|siSpcSoftResetRDYChk
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|bit32
name|regVal
decl_stmt|;
name|bit32
name|Scratchpad1
decl_stmt|;
name|bit32
name|Scratchpad2
decl_stmt|;
name|bit32
name|spad2notready
init|=
literal|0
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|bit32
name|regVal1
decl_stmt|;
name|bit32
name|regVal2
decl_stmt|;
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
comment|/* read the scratch pad 2 register bit 2 */
name|regVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
operator|&
name|SCRATCH_PAD2_FWRDY_RST
expr_stmt|;
name|Scratchpad1
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
if|if
condition|(
name|regVal
operator|==
name|SCRATCH_PAD2_FWRDY_RST
condition|)
block|{
comment|/* FW assert happened, it is ready for soft reset */
comment|/* Do nothing */
block|}
else|else
block|{
comment|/* read bootloader response state */
name|regVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|&
name|HDA_STATUS_BITS
expr_stmt|;
if|if
condition|(
name|regVal
operator|==
name|BOOTTLOADERHDA_IDLE
condition|)
block|{
comment|/* For customers wants to do soft reset even the chip is already in HDA mode */
comment|/* Do not need to trigger RB6 twice */
empty_stmt|;
block|}
else|else
block|{
comment|/* Trigger NMI twice via RB6 */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|RB6_ACCESS_REG
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftReset:Shift Bar4 to 0x%x failed\n"
operator|,
name|RB6_ACCESS_REG
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|Scratchpad1
operator|!=
operator|(
name|SCRATCH_PAD1_FW_INIT_ERR
operator||
name|SCRATCH_PAD1_AAP_ERROR_STATE
operator|)
condition|)
block|{
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_RB6_OFFSET
argument_list|,
name|RB6_MAGIC_NUMBER_RST
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR2
argument_list|,
name|SPC_RB6_OFFSET
argument_list|,
name|RB6_MAGIC_NUMBER_RST
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siSoftReset: ILA load fail SKIP RB6 access 0x%x\n"
operator|,
name|Scratchpad1
operator|)
argument_list|)
expr_stmt|;
block|}
name|SPAD2_NOT_READY
label|:
comment|/* wait for 100 ms */
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|ONE_HUNDRED_MILLISECS
argument_list|)
expr_stmt|;
name|Scratchpad2
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
name|regVal
operator|=
name|Scratchpad2
operator|&
name|SCRATCH_PAD2_FWRDY_RST
expr_stmt|;
if|if
condition|(
name|regVal
operator|!=
name|SCRATCH_PAD2_FWRDY_RST
condition|)
block|{
if|if
condition|(
name|spad2notready
operator|>
name|WAIT_SECONDS
argument_list|(
literal|12
argument_list|)
operator|/
name|ONE_HUNDRED_MILLISECS
condition|)
comment|/**/
block|{
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|regVal1
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
name|regVal2
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftResetRDYChk: TIMEOUT:MSGU_SCRATCH_PAD1=0x%x, MSGU_SCRATCH_PAD2=0x%x\n"
operator|,
name|regVal1
operator|,
name|regVal2
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftResetRDYChk: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siSpcSoftResetRDYChk: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
return|return
name|AGSA_RC_SUCCESS
return|;
comment|/* Timeout Ok reset anyway */
block|}
name|spad2notready
operator|++
expr_stmt|;
goto|goto
name|SPAD2_NOT_READY
goto|;
block|}
block|}
block|}
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_decl_stmt
name|agsaBarOffset_t
name|SPCTable
index|[]
init|=
block|{
block|{
name|GEN_MSGU_IBDB_SET
block|,
name|PCIBAR0
block|,
name|MSGU_IBDB_SET
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x00  */
block|{
name|GEN_MSGU_ODR
block|,
name|PCIBAR0
block|,
name|MSGU_ODR
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x01  */
block|{
name|GEN_MSGU_ODCR
block|,
name|PCIBAR0
block|,
name|MSGU_ODCR
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x02  */
block|{
name|GEN_MSGU_SCRATCH_PAD_0
block|,
name|PCIBAR0
block|,
name|MSGU_SCRATCH_PAD_0
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x03  */
block|{
name|GEN_MSGU_SCRATCH_PAD_1
block|,
name|PCIBAR0
block|,
name|MSGU_SCRATCH_PAD_1
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x04  */
block|{
name|GEN_MSGU_SCRATCH_PAD_2
block|,
name|PCIBAR0
block|,
name|MSGU_SCRATCH_PAD_2
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x05  */
block|{
name|GEN_MSGU_SCRATCH_PAD_3
block|,
name|PCIBAR0
block|,
name|MSGU_SCRATCH_PAD_3
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x06  */
block|{
name|GEN_MSGU_HOST_SCRATCH_PAD_0
block|,
name|PCIBAR0
block|,
name|MSGU_HOST_SCRATCH_PAD_0
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x07  */
block|{
name|GEN_MSGU_HOST_SCRATCH_PAD_1
block|,
name|PCIBAR0
block|,
name|MSGU_HOST_SCRATCH_PAD_1
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x08  */
block|{
name|GEN_MSGU_HOST_SCRATCH_PAD_2
block|,
name|PCIBAR0
block|,
name|MSGU_HOST_SCRATCH_PAD_2
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x09  */
block|{
name|GEN_MSGU_HOST_SCRATCH_PAD_3
block|,
name|PCIBAR0
block|,
name|MSGU_HOST_SCRATCH_PAD_3
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x0a  */
block|{
name|GEN_MSGU_ODMR
block|,
name|PCIBAR0
block|,
name|MSGU_ODMR
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x0b  */
block|{
name|GEN_PCIE_TRIGGER
block|,
name|PCIBAR0
block|,
name|PCIE_TRIGGER_ON_REGISTER_READ
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x0c  */
block|{
name|GEN_SPC_REG_RESET
block|,
name|PCIBAR2
block|,
name|SPC_REG_RESET
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x0d  */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|agsaBarOffset_t
name|SPC_V_Table
index|[]
init|=
block|{
block|{
name|GEN_MSGU_IBDB_SET
block|,
name|PCIBAR0
block|,
name|V_Inbound_Doorbell_Set_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x00  */
block|{
name|GEN_MSGU_ODR
block|,
name|PCIBAR0
block|,
name|V_Outbound_Doorbell_Set_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x01  */
block|{
name|GEN_MSGU_ODCR
block|,
name|PCIBAR0
block|,
name|V_Outbound_Doorbell_Clear_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x02  */
block|{
name|GEN_MSGU_SCRATCH_PAD_0
block|,
name|PCIBAR0
block|,
name|V_Scratchpad_0_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x03  */
block|{
name|GEN_MSGU_SCRATCH_PAD_1
block|,
name|PCIBAR0
block|,
name|V_Scratchpad_1_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x04  */
block|{
name|GEN_MSGU_SCRATCH_PAD_2
block|,
name|PCIBAR0
block|,
name|V_Scratchpad_2_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x05  */
block|{
name|GEN_MSGU_SCRATCH_PAD_3
block|,
name|PCIBAR0
block|,
name|V_Scratchpad_3_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x06  */
block|{
name|GEN_MSGU_HOST_SCRATCH_PAD_0
block|,
name|PCIBAR0
block|,
name|V_Host_Scratchpad_0_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x07  */
block|{
name|GEN_MSGU_HOST_SCRATCH_PAD_1
block|,
name|PCIBAR0
block|,
name|V_Host_Scratchpad_1_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x08  */
block|{
name|GEN_MSGU_HOST_SCRATCH_PAD_2
block|,
name|PCIBAR0
block|,
name|V_Host_Scratchpad_2_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x09  */
block|{
name|GEN_MSGU_HOST_SCRATCH_PAD_3
block|,
name|PCIBAR0
block|,
name|V_Host_Scratchpad_3_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x0a  */
block|{
name|GEN_MSGU_ODMR
block|,
name|PCIBAR0
block|,
name|V_Outbound_Doorbell_Mask_Set_Register
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x0b  */
block|{
name|GEN_PCIE_TRIGGER
block|,
name|PCIBAR0
block|,
name|PCIE_TRIGGER_ON_REGISTER_READ
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x0c  */
block|{
name|GEN_SPC_REG_RESET
block|,
name|PCIBAR0
block|,
name|V_SoftResetRegister
block|,
name|SIZE_DW
block|}
block|,
comment|/* 0x0d  */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/**  *  *  \brief  *  \param agsaRoot         Pointer to a data structure containing both application  *                          and LL layer context handles  *  \param Spc_type         Device  Id of hardware  *  * Return:  *         None  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|siUpdateBarOffsetTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|Spc_Type
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|bit32
name|x
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"mf"
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"9A"
argument_list|,
name|Spc_Type
argument_list|)
expr_stmt|;
comment|/* TP:9A Spc_Type */
if|if
condition|(
name|Spc_Type
operator|==
name|VEN_DEV_SPC
condition|)
block|{
name|si_memcpy
argument_list|(
operator|&
name|saRoot
operator|->
name|SpcBarOffset
argument_list|,
name|SPCTable
argument_list|,
sizeof|sizeof
argument_list|(
name|SPCTable
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG5
argument_list|(
operator|(
literal|"siUpdateBarOffsetTable:sizeof(SPCTable) sizeof(agsaBarOffset_t)sizeof(SPCTable) / sizeof(agsaBarOffset_t) %X %X %X\n"
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|SPCTable
argument_list|)
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|agsaBarOffset_t
argument_list|)
operator|,
call|(
name|unsigned
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|SPCTable
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|agsaBarOffset_t
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* VEN_DEV_SPCV */
block|{
name|si_memcpy
argument_list|(
operator|&
name|saRoot
operator|->
name|SpcBarOffset
argument_list|,
name|SPC_V_Table
argument_list|,
sizeof|sizeof
argument_list|(
name|SPC_V_Table
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG5
argument_list|(
operator|(
literal|"siUpdateBarOffsetTable:sizeof(SPC_V_Table) sizeof(agsaBarOffset_t)sizeof(SPC_V_Table) / sizeof(agsaBarOffset_t) %X %X %X\n"
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|SPC_V_Table
argument_list|)
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|agsaBarOffset_t
argument_list|)
operator|,
call|(
name|unsigned
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|SPC_V_Table
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|agsaBarOffset_t
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
sizeof|sizeof
argument_list|(
name|SPCTable
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|agsaBarOffset_t
argument_list|)
condition|;
name|x
operator|++
control|)
block|{
name|SA_DBG4
argument_list|(
operator|(
literal|"%8X: %8X %8X %8X\n"
operator|,
name|saRoot
operator|->
name|SpcBarOffset
index|[
name|x
index|]
operator|.
name|Generic
operator|,
name|saRoot
operator|->
name|SpcBarOffset
index|[
name|x
index|]
operator|.
name|Bar
operator|,
name|saRoot
operator|->
name|SpcBarOffset
index|[
name|x
index|]
operator|.
name|Offset
operator|,
name|saRoot
operator|->
name|SpcBarOffset
index|[
name|x
index|]
operator|.
name|Length
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|->
name|SpcBarOffset
index|[
name|x
index|]
operator|.
name|Generic
operator|!=
name|x
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siUpdateBarOffsetTable:  saRoot->SpcBarOffset[%x].Generic %X != %X\n"
operator|,
name|x
operator|,
name|saRoot
operator|->
name|SpcBarOffset
index|[
name|x
index|]
operator|.
name|Generic
operator|,
name|x
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"mf"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|siHalRegReadExt
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|generic
parameter_list|,
name|bit32
name|regOffset
parameter_list|)
block|{
name|agsaBarOffset_t
modifier|*
name|Table
init|=
name|agNULL
decl_stmt|;
name|bit32
name|retVal
decl_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|"agRoot"
argument_list|)
expr_stmt|;
name|Table
operator|=
name|WHATTABLE
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|Table
operator|)
argument_list|,
literal|"Table"
argument_list|)
expr_stmt|;
comment|/*   if(Table[generic].Offset != regOffset)   {      SA_DBG1(("siHalRegReadExt: Table[%x].Offset %x != regOffset %x\n",generic,                                         Table[generic].Offset,                                         regOffset ));   } */
if|if
condition|(
name|Table
index|[
name|generic
index|]
operator|.
name|Bar
condition|)
block|{
name|retVal
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|Table
index|[
name|generic
index|]
operator|.
name|Bar
argument_list|,
name|Table
index|[
name|generic
index|]
operator|.
name|Offset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|retVal
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|Table
index|[
name|generic
index|]
operator|.
name|Offset
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|retVal
operator|)
return|;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|siHalRegWriteExt
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|generic
parameter_list|,
name|bit32
name|regOffset
parameter_list|,
name|bit32
name|regValue
parameter_list|)
block|{
name|agsaBarOffset_t
modifier|*
name|Table
init|=
name|agNULL
decl_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|"agRoot"
argument_list|)
expr_stmt|;
name|Table
operator|=
name|WHATTABLE
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|Table
operator|)
argument_list|,
literal|"Table"
argument_list|)
expr_stmt|;
comment|/*     if(Table[generic].Offset != regOffset)     {        SA_DBG1(("siHalRegWriteExt: Table[%x].Offset %x != regOffset %x\n",generic,                                           Table[generic].Offset,                                           regOffset ));     } */
name|SA_DBG6
argument_list|(
operator|(
literal|"siHalRegWriteExt: Bar %x Offset %8X Wrote %8X\n"
operator|,
name|Table
index|[
name|generic
index|]
operator|.
name|Bar
operator|,
name|Table
index|[
name|generic
index|]
operator|.
name|Offset
operator|,
name|regValue
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Table
index|[
name|generic
index|]
operator|.
name|Bar
condition|)
block|{
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|Table
index|[
name|generic
index|]
operator|.
name|Bar
argument_list|,
name|Table
index|[
name|generic
index|]
operator|.
name|Offset
argument_list|,
name|regValue
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ossaHwRegWrite
argument_list|(
name|agRoot
argument_list|,
name|Table
index|[
name|generic
index|]
operator|.
name|Offset
argument_list|,
name|regValue
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|GLOBAL
name|void
name|siPCITriger
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siPCITriger: Read PCIe Bar zero plus 0x%x\n"
operator|,
name|PCIE_TRIGGER_ON_REGISTER_READ
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|PCIE_TRIGGER_ON_REGISTER_READ
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|siGetPciBar
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|bit32
name|MSGUCfgTblBase
init|=
literal|0
decl_stmt|;
name|bit32
name|pcibar
init|=
literal|0
decl_stmt|;
name|MSGUCfgTblBase
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|pcibar
operator|=
operator|(
name|MSGUCfgTblBase
operator|&
name|SCRATCH_PAD0_BAR_MASK
operator|)
operator|>>
name|SHIFT26
expr_stmt|;
comment|/* get pci Bar index */
name|pcibar
operator|=
operator|(
name|bit8
operator|)
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|)
expr_stmt|;
return|return
operator|(
name|pcibar
operator|)
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|siGetTableOffset
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|TableOffsetInTable
parameter_list|)
block|{
name|bit32
name|TableOffset
decl_stmt|;
name|bit32
name|MSGUCfgTblBase
decl_stmt|;
comment|/* read scratch pad0 to get PCI BAR and offset of configuration table */
name|MSGUCfgTblBase
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|MSGUCfgTblBase
operator|&=
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
name|TableOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|siGetPciBar
argument_list|(
name|agRoot
argument_list|)
argument_list|,
name|MSGUCfgTblBase
operator|+
name|TableOffsetInTable
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"GetTableOffset:TableOffset with size 0x%x\n"
operator|,
name|TableOffset
operator|)
argument_list|)
expr_stmt|;
comment|/* Mask off size */
name|TableOffset
operator|&=
literal|0xFFFFFF
expr_stmt|;
name|TableOffset
operator|+=
name|MSGUCfgTblBase
expr_stmt|;
return|return
operator|(
name|TableOffset
operator|)
return|;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|siCheckQs
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|mpiOCQueue_t
modifier|*
name|circularOQ
decl_stmt|;
name|mpiICQueue_t
modifier|*
name|circularIQ
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|QueueConfig
operator|.
name|numInboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|circularIQ
operator|=
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|i
index|]
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|circularIQ
operator|->
name|agRoot
argument_list|,
operator|&
name|circularIQ
operator|->
name|consumerIdx
argument_list|,
name|circularIQ
operator|->
name|ciPointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|circularIQ
operator|->
name|producerIdx
operator|!=
name|circularIQ
operator|->
name|consumerIdx
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siCheckQs: In  Q %d  PI 0x%03x CI 0x%03x (%d) \n"
operator|,
name|i
operator|,
name|circularIQ
operator|->
name|producerIdx
operator|,
name|circularIQ
operator|->
name|consumerIdx
operator|,
operator|(
name|circularIQ
operator|->
name|producerIdx
operator|>
name|circularIQ
operator|->
name|consumerIdx
condition|?
operator|(
name|circularIQ
operator|->
name|producerIdx
operator|-
name|circularIQ
operator|->
name|consumerIdx
operator|)
else|:
operator|(
name|circularIQ
operator|->
name|numElements
operator|-
name|circularIQ
operator|->
name|consumerIdx
operator|)
operator|+
name|circularIQ
operator|->
name|producerIdx
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|circularOQ
operator|=
operator|&
name|saRoot
operator|->
name|outboundQueue
index|[
name|i
index|]
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|circularOQ
operator|->
name|agRoot
argument_list|,
operator|&
name|circularOQ
operator|->
name|producerIdx
argument_list|,
name|circularOQ
operator|->
name|piPointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|circularOQ
operator|->
name|producerIdx
operator|!=
name|circularOQ
operator|->
name|consumerIdx
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siCheckQs: Out Q %d  PI 0x%03x CI 0x%03x (%d) \n"
operator|,
name|i
operator|,
name|circularOQ
operator|->
name|producerIdx
operator|,
name|circularOQ
operator|->
name|consumerIdx
operator|,
operator|(
name|circularOQ
operator|->
name|producerIdx
operator|>
name|circularOQ
operator|->
name|consumerIdx
condition|?
operator|(
name|circularOQ
operator|->
name|producerIdx
operator|-
name|circularOQ
operator|->
name|consumerIdx
operator|)
else|:
operator|(
name|circularOQ
operator|->
name|numElements
operator|-
name|circularOQ
operator|->
name|consumerIdx
operator|)
operator|+
name|circularOQ
operator|->
name|producerIdx
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|GLOBAL
name|void
name|siPciCpyMem
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|soffset
parameter_list|,
specifier|const
name|void
modifier|*
name|dst
parameter_list|,
name|bit32
name|DWcount
parameter_list|,
name|bit32
name|busBaseNumber
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|,
name|val
decl_stmt|,
name|offset
decl_stmt|;
name|bit32
modifier|*
name|dst1
decl_stmt|;
name|dst1
operator|=
operator|(
name|bit32
operator|*
operator|)
name|dst
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siPciCpyMem:copy DWcount %d from offset 0x%x to %p\n"
operator|,
name|DWcount
operator|,
name|soffset
operator|,
name|dst
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DWcount
condition|;
name|i
operator|+=
literal|4
operator|,
name|dst1
operator|++
control|)
block|{
name|offset
operator|=
operator|(
name|soffset
operator|+
name|i
operator|/
literal|4
operator|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|offset
operator|<
operator|(
literal|64
operator|*
literal|1024
operator|)
operator|)
argument_list|,
literal|"siPciCpyMem offset too large"
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|<
operator|(
literal|64
operator|*
literal|1024
operator|)
condition|)
block|{
name|val
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|busBaseNumber
argument_list|,
name|offset
argument_list|)
expr_stmt|;
operator|*
name|dst1
operator|=
name|BIT32_TO_LEBIT32
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

end_unit


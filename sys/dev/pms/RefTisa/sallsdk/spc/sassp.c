begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* ** *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/*! \file sassp.c  *  \brief The file implements the functions for SSP request/response  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/saglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|siTraceFileID
end_ifdef

begin_undef
undef|#
directive|undef
name|siTraceFileID
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|siTraceFileID
value|'O'
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|LOOPBACK_MPI
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|loopback
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SALLSDK_DEBUG
end_ifdef

begin_function_decl
name|LOCAL
name|void
name|siDumpSSPStartIu
parameter_list|(
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|agRequestType
parameter_list|,
name|agsaSASRequestBody_t
modifier|*
name|agRequestBody
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FAST_IO_TEST
end_ifdef

begin_function
name|LOCAL
name|bit32
name|saGetIBQPI
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|queueNum
parameter_list|)
block|{
name|bit8
name|inq
decl_stmt|;
name|mpiICQueue_t
modifier|*
name|circularQ
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|inq
operator|=
name|INQ
argument_list|(
name|queueNum
argument_list|)
expr_stmt|;
name|circularQ
operator|=
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|inq
index|]
expr_stmt|;
return|return
name|circularQ
operator|->
name|producerIdx
return|;
block|}
end_function

begin_function
name|LOCAL
name|void
name|saSetIBQPI
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|queueNum
parameter_list|,
name|bit32
name|pi
parameter_list|)
block|{
name|bit8
name|inq
decl_stmt|;
name|mpiICQueue_t
modifier|*
name|circularQ
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|inq
operator|=
name|INQ
argument_list|(
name|queueNum
argument_list|)
expr_stmt|;
name|circularQ
operator|=
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|inq
index|]
expr_stmt|;
name|circularQ
operator|->
name|producerIdx
operator|=
name|pi
expr_stmt|;
block|}
end_function

begin_function
name|osLOCAL
name|void
modifier|*
name|siFastSSPReqAlloc
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|saFastRequest_t
modifier|*
name|fr
decl_stmt|;
if|if
condition|(
operator|!
name|saRoot
operator|->
name|freeFastIdx
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSuperSSPReqAlloc: no memory ERROR\n"
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_FAST_IO_LOCK
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|freeFastIdx
operator|--
expr_stmt|;
name|idx
operator|=
name|saRoot
operator|->
name|freeFastIdx
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_FAST_IO_LOCK
argument_list|)
expr_stmt|;
name|fr
operator|=
name|saRoot
operator|->
name|freeFastReq
index|[
name|idx
index|]
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|fr
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|fr
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
return|return
name|fr
return|;
block|}
end_function

begin_function
name|LOCAL
name|void
name|siFastSSPReqFree
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|void
modifier|*
name|freq
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|saFastRequest_t
modifier|*
name|fr
init|=
operator|(
name|saFastRequest_t
operator|*
operator|)
name|freq
decl_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siFastSSPReqFree: enter\n"
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|fr
operator|->
name|valid
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|->
name|freeFastIdx
operator|>=
sizeof|sizeof
argument_list|(
name|saRoot
operator|->
name|freeFastReq
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|saRoot
operator|->
name|freeFastReq
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siFastSSPReqFree: too many handles %d / %d ERROR\n"
operator|,
name|saRoot
operator|->
name|freeFastIdx
operator|,
call|(
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|saRoot
operator|->
name|freeFastReq
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|saRoot
operator|->
name|freeFastReq
index|[
literal|0
index|]
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
return|return;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_FAST_IO_LOCK
argument_list|)
expr_stmt|;
comment|/* not need if only one entry */
comment|/* saRoot->freeFastReq[saRoot->freeFastIdx] = freq;  */
name|saRoot
operator|->
name|freeFastIdx
operator|++
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_FAST_IO_LOCK
argument_list|)
expr_stmt|;
name|fr
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
name|SA_DBG6
argument_list|(
operator|(
literal|"siFastSSPReqFree: leave\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|LOCAL
name|bit32
name|siFastSSPResAlloc
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|queueNum
parameter_list|,
name|bit32
name|agRequestType
parameter_list|,
name|agsaDeviceDesc_t
modifier|*
name|pDevice
parameter_list|,
name|agsaIORequestDesc_t
modifier|*
modifier|*
name|pRequest
parameter_list|,
name|void
modifier|*
modifier|*
name|pPayload
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|mpiICQueue_t
modifier|*
name|circularQ
decl_stmt|;
name|bit8
name|inq
decl_stmt|;
name|bit16
name|size
init|=
name|IOMB_SIZE64
decl_stmt|;
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|,
name|retVal
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2D"
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"Entering function siFastSSPResAlloc:\n"
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
operator|*
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saLlistIOGetHead
argument_list|(
operator|&
name|saRoot
operator|->
name|freeIORequests
argument_list|)
expr_stmt|;
comment|/* If no LL IO request entry available */
if|if
condition|(
name|agNULL
operator|==
operator|*
name|pRequest
condition|)
block|{
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siFastSSPResAlloc: No request from free list\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2D"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_BUSY
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/* Get IO request from free IORequests */
comment|/* Assign inbound and outbound Buffer */
name|inq
operator|=
name|INQ
argument_list|(
name|queueNum
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|AGSA_MAX_INBOUND_Q
operator|>
name|inq
operator|)
argument_list|,
literal|"The IBQ Number is out of range."
argument_list|)
expr_stmt|;
comment|/* SSP_INI_IO_START_EXT IOMB need at least 80 bytes to support 32 CDB */
if|if
condition|(
name|agRequestType
operator|&
name|AGSA_SSP_EXT_BIT
condition|)
block|{
name|size
operator|=
name|IOMB_SIZE96
expr_stmt|;
block|}
comment|/* If LL IO request entry avaliable */
comment|/* Get a free inbound queue entry */
name|circularQ
operator|=
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|inq
index|]
expr_stmt|;
name|retVal
operator|=
name|mpiMsgFreeGet
argument_list|(
name|circularQ
argument_list|,
name|size
argument_list|,
name|pPayload
argument_list|)
expr_stmt|;
comment|/* if message size is too large return failure */
if|if
condition|(
name|AGSA_RC_SUCCESS
operator|!=
name|retVal
condition|)
block|{
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|retVal
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siFastSSPResAlloc: error when get free IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2D"
argument_list|)
expr_stmt|;
block|}
comment|/* return busy if inbound queue is full */
if|if
condition|(
name|AGSA_RC_BUSY
operator|==
name|retVal
condition|)
block|{
name|SA_DBG3
argument_list|(
operator|(
literal|"siFastSSPResAlloc: no more IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2D"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|retVal
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/* But add it to the pending queue during FastStart */
comment|/* If free IOMB avaliable */
comment|/* Remove the request from free list */
name|saLlistIORemove
argument_list|(
operator|&
name|saRoot
operator|->
name|freeIORequests
argument_list|,
operator|&
operator|(
operator|*
name|pRequest
operator|)
operator|->
name|linkNode
argument_list|)
expr_stmt|;
comment|/* Add the request to the pendingIORequests list of the device */
name|saLlistIOAdd
argument_list|(
operator|&
name|pDevice
operator|->
name|pendingIORequests
argument_list|,
operator|&
operator|(
operator|*
name|pRequest
operator|)
operator|->
name|linkNode
argument_list|)
expr_stmt|;
name|ext
label|:
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGSA_RC_SUCCESS
operator|==
name|ret
condition|)
block|{
comment|/* save tag and IOrequest pointer to IOMap */
name|saRoot
operator|->
name|IOMap
index|[
operator|(
operator|*
name|pRequest
operator|)
operator|->
name|HTag
index|]
operator|.
name|Tag
operator|=
operator|(
operator|*
name|pRequest
operator|)
operator|->
name|HTag
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
operator|(
operator|*
name|pRequest
operator|)
operator|->
name|HTag
index|]
operator|.
name|IORequest
operator|=
operator|(
name|void
operator|*
operator|)
operator|*
name|pRequest
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* siFastSSPResAlloc */
end_comment

begin_function
name|GLOBAL
name|bit32
name|saFastSSPCancel
parameter_list|(
name|void
modifier|*
name|ioHandle
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
decl_stmt|;
name|saFastRequest_t
modifier|*
name|fr
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|ior
decl_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|ioHandle
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|fr
operator|=
operator|(
name|saFastRequest_t
operator|*
operator|)
name|ioHandle
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|fr
operator|->
name|valid
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|agRoot
operator|=
operator|(
name|agsaRoot_t
operator|*
operator|)
name|fr
operator|->
name|agRoot
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|saRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2E"
argument_list|)
expr_stmt|;
comment|/* rollback the previously set IBQ PI */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fr
operator|->
name|inqMax
operator|-
literal|1
condition|;
name|i
operator|++
control|)
name|saSetIBQPI
argument_list|(
name|agRoot
argument_list|,
name|fr
operator|->
name|inqList
index|[
name|i
index|]
argument_list|,
name|fr
operator|->
name|beforePI
index|[
name|fr
operator|->
name|inqList
index|[
name|i
index|]
index|]
argument_list|)
expr_stmt|;
comment|/* free all the previous Fast IO Requests */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* at least one entry, no need to check for NULL saLlistIOGetHead() */
name|ior
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|saLlistIOGetHead
argument_list|(
operator|&
name|fr
operator|->
name|requests
argument_list|)
operator|-
name|OSSA_OFFSET_OF
argument_list|(
name|agsaIORequestDesc_t
argument_list|,
name|fastLink
argument_list|)
operator|)
expr_stmt|;
do|do
block|{
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|void
modifier|*
name|tmp
decl_stmt|;
name|pDevice
operator|=
name|ior
operator|->
name|pDevice
expr_stmt|;
name|saLlistIORemove
argument_list|(
operator|&
name|pDevice
operator|->
name|pendingIORequests
argument_list|,
operator|&
name|ior
operator|->
name|linkNode
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
name|saRoot
operator|->
name|freeIORequests
argument_list|,
operator|&
name|ior
operator|->
name|linkNode
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
name|void
operator|*
operator|)
name|saLlistGetNext
argument_list|(
operator|&
name|fr
operator|->
name|requests
argument_list|,
operator|&
name|ior
operator|->
name|fastLink
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
block|{
break|break;
comment|/* end of list */
block|}
name|ior
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|tmp
operator|-
name|OSSA_OFFSET_OF
argument_list|(
name|agsaIORequestDesc_t
argument_list|,
name|fastLink
argument_list|)
operator|)
expr_stmt|;
block|}
do|while
condition|(
literal|1
condition|)
do|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* free the IBQ PI tracking struct */
name|siFastSSPReqFree
argument_list|(
name|agRoot
argument_list|,
name|fr
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2E"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* saFastSSPCancel */
end_comment

begin_function
name|GLOBAL
name|void
modifier|*
name|saFastSSPPrepare
parameter_list|(
name|void
modifier|*
name|ioh
parameter_list|,
name|agsaFastCommand_t
modifier|*
name|fc
parameter_list|,
name|ossaSSPCompletedCB_t
name|cb
parameter_list|,
name|void
modifier|*
name|cbArg
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
decl_stmt|;
name|mpiICQueue_t
modifier|*
name|circularQ
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|agsaSgl_t
modifier|*
name|pSgl
decl_stmt|;
name|bit32
name|Dir
init|=
literal|0
decl_stmt|;
name|bit8
name|inq
decl_stmt|,
name|outq
decl_stmt|;
name|saFastRequest_t
modifier|*
name|fr
decl_stmt|;
name|void
modifier|*
name|pMessage
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|bit16
name|opCode
decl_stmt|;
name|bitptr
name|offsetTag
decl_stmt|;
name|bitptr
name|offsetDeviceId
decl_stmt|;
name|bitptr
name|offsetDataLen
decl_stmt|;
name|bitptr
name|offsetDir
decl_stmt|;
name|agRoot
operator|=
operator|(
name|agsaRoot_t
operator|*
operator|)
name|fc
operator|->
name|agRoot
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2G"
argument_list|)
expr_stmt|;
name|OSSA_INP_ENTER
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|saRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"Entering function saFastSSPPrepare:\n"
operator|)
argument_list|)
expr_stmt|;
name|fr
operator|=
operator|(
name|saFastRequest_t
operator|*
operator|)
name|ioh
expr_stmt|;
if|if
condition|(
operator|!
name|fr
condition|)
block|{
name|int
name|i
decl_stmt|;
name|fr
operator|=
name|siFastSSPReqAlloc
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fr
condition|)
block|{
name|SA_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
name|saLlistIOInitialize
argument_list|(
operator|&
name|fr
operator|->
name|requests
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AGSA_MAX_INBOUND_Q
condition|;
name|i
operator|++
control|)
name|fr
operator|->
name|beforePI
index|[
name|i
index|]
operator|=
operator|(
name|bit32
operator|)
operator|-
literal|1
expr_stmt|;
name|fr
operator|->
name|inqMax
operator|=
literal|0
expr_stmt|;
name|fr
operator|->
name|agRoot
operator|=
name|agRoot
expr_stmt|;
name|ioh
operator|=
name|fr
expr_stmt|;
block|}
comment|/* Find the outgoing port for the device */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
operator|(
operator|(
operator|(
name|agsaDevHandle_t
operator|*
operator|)
name|fc
operator|->
name|devHandle
operator|)
operator|->
name|sdkData
operator|)
expr_stmt|;
name|ret
operator|=
name|siFastSSPResAlloc
argument_list|(
name|agRoot
argument_list|,
name|fc
operator|->
name|queueNum
argument_list|,
name|fc
operator|->
name|agRequestType
argument_list|,
name|pDevice
argument_list|,
operator|&
name|pRequest
argument_list|,
operator|&
name|pMessage
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|SA_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2G"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/* Assign inbound and outbound Buffer */
name|inq
operator|=
name|INQ
argument_list|(
name|fc
operator|->
name|queueNum
argument_list|)
expr_stmt|;
name|outq
operator|=
name|OUQ
argument_list|(
name|fc
operator|->
name|queueNum
argument_list|)
expr_stmt|;
name|circularQ
operator|=
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|inq
index|]
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saFastSSPPrepare: deviceId %d\n"
operator|,
name|pDevice
operator|->
name|DeviceMapIndex
operator|)
argument_list|)
expr_stmt|;
comment|/* set up pRequest */
name|pRequest
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|pRequest
operator|->
name|pDevice
operator|=
name|pDevice
expr_stmt|;
name|pRequest
operator|->
name|requestType
operator|=
name|fc
operator|->
name|agRequestType
expr_stmt|;
name|pRequest
operator|->
name|completionCB
operator|=
name|cb
expr_stmt|;
name|pRequest
operator|->
name|pIORequestContext
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
name|cbArg
expr_stmt|;
name|pSgl
operator|=
name|fc
operator|->
name|agSgl
expr_stmt|;
switch|switch
condition|(
name|fc
operator|->
name|agRequestType
condition|)
block|{
comment|/* case AGSA_SSP_INIT_NONDATA: */
case|case
name|AGSA_SSP_INIT_READ
case|:
case|case
name|AGSA_SSP_INIT_WRITE
case|:
case|case
name|AGSA_SSP_INIT_READ_M
case|:
case|case
name|AGSA_SSP_INIT_WRITE_M
case|:
block|{
name|agsaSSPIniIOStartCmd_t
modifier|*
name|pPayload
init|=
operator|(
name|agsaSSPIniIOStartCmd_t
operator|*
operator|)
name|pMessage
decl_stmt|;
name|agsaSSPCmdInfoUnit_t
modifier|*
name|piu
decl_stmt|;
comment|/* SSPIU less equal 28 bytes */
name|offsetTag
operator|=
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniIOStartCmd_t
argument_list|,
name|tag
argument_list|)
expr_stmt|;
name|offsetDeviceId
operator|=
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniIOStartCmd_t
argument_list|,
name|deviceId
argument_list|)
expr_stmt|;
name|offsetDataLen
operator|=
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniIOStartCmd_t
argument_list|,
name|dataLen
argument_list|)
expr_stmt|;
name|offsetDir
operator|=
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniIOStartCmd_t
argument_list|,
name|dirMTlr
argument_list|)
expr_stmt|;
name|piu
operator|=
operator|&
name|pPayload
operator|->
name|SSPInfoUnit
expr_stmt|;
name|si_memcpy
argument_list|(
name|piu
operator|->
name|lun
argument_list|,
name|fc
operator|->
name|lun
argument_list|,
sizeof|sizeof
argument_list|(
name|piu
operator|->
name|lun
argument_list|)
argument_list|)
expr_stmt|;
name|si_memcpy
argument_list|(
name|piu
operator|->
name|cdb
argument_list|,
name|fc
operator|->
name|cdb
argument_list|,
sizeof|sizeof
argument_list|(
name|piu
operator|->
name|cdb
argument_list|)
argument_list|)
expr_stmt|;
name|piu
operator|->
name|efb_tp_taskAttribute
operator|=
name|fc
operator|->
name|taskAttribute
expr_stmt|;
name|piu
operator|->
name|additionalCdbLen
operator|=
name|fc
operator|->
name|additionalCdbLen
expr_stmt|;
comment|/* Mask DIR for Read/Write command */
name|Dir
operator|=
name|fc
operator|->
name|agRequestType
operator|&
name|AGSA_DIR_MASK
expr_stmt|;
comment|/* set TLR */
name|Dir
operator||=
name|fc
operator|->
name|flag
operator|&
name|TLR_MASK
expr_stmt|;
if|if
condition|(
name|fc
operator|->
name|agRequestType
operator|&
name|AGSA_MSG
condition|)
block|{
comment|/* set M bit */
name|Dir
operator||=
name|AGSA_MSG_BIT
expr_stmt|;
block|}
comment|/* Setup SGL */
if|if
condition|(
name|fc
operator|->
name|dataLength
condition|)
block|{
name|SA_DBG5
argument_list|(
operator|(
literal|"saFastSSPPrepare: agSgl %08x:%08x (%x/%x)\n"
operator|,
name|pSgl
operator|->
name|sgUpper
operator|,
name|pSgl
operator|->
name|sgLower
operator|,
name|pSgl
operator|->
name|len
operator|,
name|pSgl
operator|->
name|extReserved
operator|)
argument_list|)
expr_stmt|;
comment|/*         pPayload->AddrLow0 = pSgl->sgLower;         pPayload->AddrHi0 = pSgl->sgUpper;         pPayload->Len0 = pSgl->len;         pPayload->E0 = pSgl->extReserved;         */
name|si_memcpy
argument_list|(
operator|&
name|pPayload
operator|->
name|AddrLow0
argument_list|,
name|pSgl
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pSgl
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no data transfer */
name|si_memset
argument_list|(
operator|&
name|pPayload
operator|->
name|AddrLow0
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pSgl
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|opCode
operator|=
name|OPC_INB_SSPINIIOSTART
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SSP_INIT_READ_EXT
case|:
case|case
name|AGSA_SSP_INIT_WRITE_EXT
case|:
case|case
name|AGSA_SSP_INIT_READ_EXT_M
case|:
case|case
name|AGSA_SSP_INIT_WRITE_EXT_M
case|:
block|{
name|agsaSSPIniExtIOStartCmd_t
modifier|*
name|pPayload
init|=
operator|(
name|agsaSSPIniExtIOStartCmd_t
operator|*
operator|)
name|pMessage
decl_stmt|;
name|agsaSSPCmdInfoUnitExt_t
modifier|*
name|piu
decl_stmt|;
name|bit32
name|sspiul
decl_stmt|;
comment|/* CDB> 16 bytes */
name|offsetTag
operator|=
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniExtIOStartCmd_t
argument_list|,
name|tag
argument_list|)
expr_stmt|;
name|offsetDeviceId
operator|=
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniExtIOStartCmd_t
argument_list|,
name|deviceId
argument_list|)
expr_stmt|;
name|offsetDataLen
operator|=
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniExtIOStartCmd_t
argument_list|,
name|dataLen
argument_list|)
expr_stmt|;
name|offsetDir
operator|=
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniExtIOStartCmd_t
argument_list|,
name|SSPIuLendirMTlr
argument_list|)
expr_stmt|;
comment|/* dword (bit7-bit2) ==> bytes (bit7-bit0) */
comment|/* setup standard CDB bytes + additional CDB bytes in length field */
name|sspiul
operator|=
sizeof|sizeof
argument_list|(
name|agsaSSPCmdInfoUnit_t
argument_list|)
operator|+
operator|(
name|fc
operator|->
name|additionalCdbLen
operator|&
literal|0xFC
operator|)
expr_stmt|;
name|Dir
operator|=
name|sspiul
operator|<<
literal|16
expr_stmt|;
name|piu
operator|=
operator|(
name|agsaSSPCmdInfoUnitExt_t
operator|*
operator|)
name|pPayload
operator|->
name|SSPIu
expr_stmt|;
name|si_memcpy
argument_list|(
name|piu
operator|->
name|lun
argument_list|,
name|fc
operator|->
name|lun
argument_list|,
sizeof|sizeof
argument_list|(
name|piu
operator|->
name|lun
argument_list|)
argument_list|)
expr_stmt|;
name|si_memcpy
argument_list|(
name|piu
operator|->
name|cdb
argument_list|,
name|fc
operator|->
name|cdb
argument_list|,
name|MIN
argument_list|(
sizeof|sizeof
argument_list|(
name|piu
operator|->
name|cdb
argument_list|)
argument_list|,
literal|16
operator|+
name|fc
operator|->
name|additionalCdbLen
argument_list|)
argument_list|)
expr_stmt|;
name|piu
operator|->
name|efb_tp_taskAttribute
operator|=
name|fc
operator|->
name|taskAttribute
expr_stmt|;
name|piu
operator|->
name|additionalCdbLen
operator|=
name|fc
operator|->
name|additionalCdbLen
expr_stmt|;
comment|/* Mask DIR for Read/Write command */
name|Dir
operator||=
name|fc
operator|->
name|agRequestType
operator|&
name|AGSA_DIR_MASK
expr_stmt|;
comment|/* set TLR */
name|Dir
operator||=
name|fc
operator|->
name|flag
operator|&
name|TLR_MASK
expr_stmt|;
if|if
condition|(
name|fc
operator|->
name|agRequestType
operator|&
name|AGSA_MSG
condition|)
block|{
comment|/* set M bit */
name|Dir
operator||=
name|AGSA_MSG_BIT
expr_stmt|;
block|}
comment|/* Setup SGL */
if|if
condition|(
name|fc
operator|->
name|dataLength
condition|)
block|{
name|SA_DBG5
argument_list|(
operator|(
literal|"saSuperSSPSend: Ext mode, agSgl %08x:%08x (%x/%x)\n"
operator|,
name|pSgl
operator|->
name|sgUpper
operator|,
name|pSgl
operator|->
name|sgLower
operator|,
name|pSgl
operator|->
name|len
operator|,
name|pSgl
operator|->
name|extReserved
operator|)
argument_list|)
expr_stmt|;
name|si_memcpy
argument_list|(
operator|(
operator|&
operator|(
name|pPayload
operator|->
name|SSPIu
index|[
literal|0
index|]
operator|)
operator|+
name|sspiul
operator|)
argument_list|,
name|pSgl
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pSgl
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|//?
block|{
comment|/* no data transfer */
comment|//pPayload->dataLen = 0;
name|si_memset
argument_list|(
operator|(
operator|&
operator|(
name|pPayload
operator|->
name|SSPIu
index|[
literal|0
index|]
operator|)
operator|+
name|sspiul
operator|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pSgl
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SA_ASSERT
argument_list|(
operator|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|,
literal|"smIS_SPC"
argument_list|)
expr_stmt|;
name|opCode
operator|=
name|OPC_INB_SSPINIEXTIOSTART
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSuperSSPSend: Unsupported Request IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2G"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
block|}
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pMessage
argument_list|,
name|offsetTag
argument_list|,
name|pRequest
operator|->
name|HTag
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pMessage
argument_list|,
name|offsetDeviceId
argument_list|,
name|pDevice
operator|->
name|DeviceMapIndex
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pMessage
argument_list|,
name|offsetDataLen
argument_list|,
name|fc
operator|->
name|dataLength
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pMessage
argument_list|,
name|offsetDir
argument_list|,
name|Dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|fr
operator|->
name|beforePI
index|[
name|inq
index|]
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* save the new IBQ' PI */
name|fr
operator|->
name|beforePI
index|[
name|inq
index|]
operator|=
name|saGetIBQPI
argument_list|(
name|agRoot
argument_list|,
name|inq
argument_list|)
expr_stmt|;
name|fr
operator|->
name|inqList
index|[
name|fr
operator|->
name|inqMax
operator|++
index|]
operator|=
name|inq
expr_stmt|;
block|}
comment|/* post the IOMB to SPC */
name|ret
operator|=
name|mpiMsgPrepare
argument_list|(
name|circularQ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pMessage
argument_list|,
name|MPI_CATEGORY_SAS_SATA
argument_list|,
name|opCode
argument_list|,
name|outq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGSA_RC_SUCCESS
operator|!=
name|ret
condition|)
block|{
name|SA_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* Remove the request from pendingIORequests list */
name|saLlistIORemove
argument_list|(
operator|&
name|pDevice
operator|->
name|pendingIORequests
argument_list|,
operator|&
name|pRequest
operator|->
name|linkNode
argument_list|)
expr_stmt|;
comment|/* Add the request to the free list of the device */
name|saLlistIOAdd
argument_list|(
operator|&
name|saRoot
operator|->
name|freeIORequests
argument_list|,
operator|&
name|pRequest
operator|->
name|linkNode
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saFastSSPPrepare: error when post SSP IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2G"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/* Add the request to the pendingFastIORequests list of the device */
name|saLlistIOAdd
argument_list|(
operator|&
name|fr
operator|->
name|requests
argument_list|,
operator|&
name|pRequest
operator|->
name|fastLink
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"2G"
argument_list|)
expr_stmt|;
name|ext
label|:
if|if
condition|(
name|fr
operator|&&
name|ret
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|saFastSSPCancel
argument_list|(
name|fr
argument_list|)
expr_stmt|;
name|ioh
operator|=
literal|0
expr_stmt|;
block|}
name|OSSA_INP_LEAVE
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
return|return
name|ioh
return|;
block|}
end_function

begin_comment
comment|/* saFastSSPPrepare */
end_comment

begin_function
name|GLOBAL
name|bit32
name|saFastSSPSend
parameter_list|(
name|void
modifier|*
name|ioHandle
parameter_list|)
block|{
name|bit8
name|inq
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
decl_stmt|;
name|saFastRequest_t
modifier|*
name|fr
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|ioHandle
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|fr
operator|=
operator|(
name|saFastRequest_t
operator|*
operator|)
name|ioHandle
expr_stmt|;
name|agRoot
operator|=
operator|(
name|agsaRoot_t
operator|*
operator|)
name|fr
operator|->
name|agRoot
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
name|agRoot
operator|->
name|sdkData
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|saRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"Entering function saFastSSPSend:\n"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fr
operator|->
name|inqMax
condition|;
name|i
operator|++
control|)
block|{
name|inq
operator|=
name|INQ
argument_list|(
name|fr
operator|->
name|inqList
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* FW interrupt */
name|mpiIBQMsgSend
argument_list|(
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|inq
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* IORequests are freed in siIODone() */
name|siFastSSPReqFree
argument_list|(
name|agRoot
argument_list|,
name|fr
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* saFastSSPSend */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Start SSP request  *  *  Start SSP request  *  *  \param agRoot handles for this instance of SAS/SATA LLL  *  \param queueNum  *  \param agIORequest  *  \param agDevHandle  *  \param agRequestType  *  \param agRequestBody  *  \param agTMRequest valid for task management  *  \param agCB  *  *  \return If request is started successfully  *          - \e AGSA_RC_SUCCESS request is started successfully  *          - \e AGSA_RC_BUSY request is not started successfully  */
end_comment

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|saSSPStart
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|queueNum
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|agRequestType
parameter_list|,
name|agsaSASRequestBody_t
modifier|*
name|agRequestBody
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agTMRequest
parameter_list|,
name|ossaSSPCompletedCB_t
name|agCB
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
ifdef|#
directive|ifdef
name|LOOPBACK_MPI
name|mpiOCQueue_t
modifier|*
name|circularOQ
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|mpiICQueue_t
modifier|*
name|circularQ
init|=
name|agNULL
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
init|=
name|agNULL
decl_stmt|;
name|agsaPort_t
modifier|*
name|pPort
init|=
name|agNULL
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
init|=
name|agNULL
decl_stmt|;
name|agsaSgl_t
modifier|*
name|pSgl
init|=
name|agNULL
decl_stmt|;
name|void
modifier|*
name|pMessage
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|,
name|retVal
init|=
literal|0
decl_stmt|;
name|bit32
name|DirDW4
init|=
literal|0
decl_stmt|;
comment|/* no data and no AutoGR */
name|bit32
name|encryptFlags
init|=
literal|0
decl_stmt|;
name|bit16
name|size
init|=
literal|0
decl_stmt|;
name|bit16
name|opCode
init|=
literal|0
decl_stmt|;
name|bit8
name|inq
init|=
literal|0
decl_stmt|,
name|outq
init|=
literal|0
decl_stmt|;
name|OSSA_INP_ENTER
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Sa"
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agIORequest
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agDevHandle
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRequestBody
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|DBG_DUMP_SSPSTART_CMDIU
argument_list|(
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agRequestBody
argument_list|)
expr_stmt|;
comment|/* Find the outgoing port for the device */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
operator|(
name|agDevHandle
operator|->
name|sdkData
operator|)
expr_stmt|;
if|if
condition|(
name|pDevice
operator|==
name|agNULL
condition|)
block|{
name|SA_ASSERT
argument_list|(
operator|(
name|pDevice
operator|)
argument_list|,
literal|"pDevice"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Sa"
argument_list|)
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
name|pPort
operator|=
name|pDevice
operator|->
name|pPort
expr_stmt|;
comment|/* Assign inbound and outbound Buffer */
name|inq
operator|=
call|(
name|bit8
call|)
argument_list|(
name|queueNum
operator|&
name|MPI_IB_NUM_MASK
argument_list|)
expr_stmt|;
name|outq
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|queueNum
operator|&
name|MPI_OB_NUM_MASK
operator|)
operator|>>
name|MPI_OB_SHIFT
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|AGSA_MAX_INBOUND_Q
operator|>
name|inq
operator|)
argument_list|,
literal|"The IBQ Number is out of range."
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart: inq %d outq %d deviceId 0x%x\n"
operator|,
name|inq
operator|,
name|outq
operator|,
name|pDevice
operator|->
name|DeviceMapIndex
operator|)
argument_list|)
expr_stmt|;
comment|/* Get request from free IORequests */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saLlistIOGetHead
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|)
expr_stmt|;
comment|/* If no LL IO request entry available */
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart, No request from free list\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"Sa"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_BUSY
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/* If LL IO request entry avaliable */
else|else
block|{
comment|/* Remove the request from free list */
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
comment|/* Add the request to the pendingIORequests list of the device */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|pDevice
operator|->
name|pendingIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
operator|!
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"The pRequest is in use"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart, request %p\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
comment|/* Decode the flag settings in the standard I/O requests to  decide what size we need. */
comment|/* All other requests will be fine with only 64 byte messages. */
switch|switch
condition|(
name|agRequestType
condition|)
block|{
case|case
name|AGSA_SSP_INIT_READ
case|:
case|case
name|AGSA_SSP_INIT_WRITE
case|:
case|case
name|AGSA_SSP_INIT_NONDATA
case|:
case|case
name|AGSA_SSP_INIT_READ_M
case|:
case|case
name|AGSA_SSP_INIT_WRITE_M
case|:
block|{
name|agsaSSPInitiatorRequest_t
modifier|*
name|pIRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspInitiatorReq
operator|)
decl_stmt|;
if|if
condition|(
operator|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_ENCRYPTION
operator|)
operator|||
ifdef|#
directive|ifdef
name|SAFLAG_USE_DIF_ENC_IOMB
operator|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_USE_DIF_ENC_OPSTART
operator|)
operator|||
endif|#
directive|endif
comment|/* SAFLAG_USE_DIF_ENC_IOMB */
operator|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_DIF
operator|)
condition|)
block|{
name|opCode
operator|=
name|OPC_INB_SSP_DIF_ENC_OPSTART
expr_stmt|;
name|size
operator|=
name|IOMB_SIZE128
expr_stmt|;
block|}
else|else
block|{
name|opCode
operator|=
name|OPC_INB_SSPINIIOSTART
expr_stmt|;
name|size
operator|=
name|IOMB_SIZE64
expr_stmt|;
block|}
break|break;
block|}
case|case
name|AGSA_SSP_INIT_READ_EXT
case|:
case|case
name|AGSA_SSP_INIT_WRITE_EXT
case|:
case|case
name|AGSA_SSP_INIT_READ_EXT_M
case|:
case|case
name|AGSA_SSP_INIT_WRITE_EXT_M
case|:
block|{
name|agsaSSPInitiatorRequestExt_t
modifier|*
name|pIRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspInitiatorReqExt
operator|)
decl_stmt|;
if|if
condition|(
operator|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_ENCRYPTION
operator|)
operator|||
operator|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_DIF
operator|)
operator|||
ifdef|#
directive|ifdef
name|SAFLAG_USE_DIF_ENC_IOMB
operator|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_USE_DIF_ENC_OPSTART
operator|)
operator|||
endif|#
directive|endif
comment|/* SAFLAG_USE_DIF_ENC_IOMB */
operator|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_SKIP_MASK
operator|)
condition|)
block|{
name|opCode
operator|=
name|OPC_INB_SSP_DIF_ENC_OPSTART
expr_stmt|;
name|size
operator|=
name|IOMB_SIZE128
expr_stmt|;
block|}
else|else
block|{
name|SA_ASSERT
argument_list|(
operator|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|,
literal|"smIS_SPC"
argument_list|)
expr_stmt|;
name|opCode
operator|=
name|OPC_INB_SSPINIEXTIOSTART
expr_stmt|;
name|size
operator|=
name|IOMB_SIZE96
expr_stmt|;
block|}
break|break;
block|}
case|case
name|AGSA_SSP_INIT_READ_INDIRECT
case|:
case|case
name|AGSA_SSP_INIT_WRITE_INDIRECT
case|:
case|case
name|AGSA_SSP_INIT_READ_INDIRECT_M
case|:
case|case
name|AGSA_SSP_INIT_WRITE_INDIRECT_M
case|:
block|{
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart: agRequestType  0x%X INDIRECT\n"
operator|,
name|agRequestType
operator|)
argument_list|)
expr_stmt|;
name|opCode
operator|=
name|OPC_INB_SSP_DIF_ENC_OPSTART
expr_stmt|;
name|size
operator|=
name|IOMB_SIZE128
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|AGSA_SSP_REQTYPE
operator||
name|AGSA_SSP_TASK_MGNT
operator|)
case|:
case|case
name|AGSA_SSP_TASK_MGNT_REQ_M
case|:
case|case
name|AGSA_SSP_TGT_READ_DATA
case|:
case|case
name|AGSA_SSP_TGT_READ_GOOD_RESP
case|:
case|case
name|AGSA_SSP_TGT_WRITE_DATA
case|:
case|case
name|AGSA_SSP_TGT_WRITE_GOOD_RESP
case|:
case|case
name|AGSA_SSP_TGT_CMD_OR_TASK_RSP
case|:
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart: agRequestType  0x%X (was default)\n"
operator|,
name|agRequestType
operator|)
argument_list|)
expr_stmt|;
name|opCode
operator|=
name|OPC_INB_SSPINIIOSTART
expr_stmt|;
name|size
operator|=
name|IOMB_SIZE64
expr_stmt|;
break|break;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart: agRequestType UNKNOWN 0x%X\n"
operator|,
name|agRequestType
operator|)
argument_list|)
expr_stmt|;
comment|/* OpCode is not used in this case, but Linux complains if it is not initialized. */
name|opCode
operator|=
name|OPC_INB_SSPINIIOSTART
expr_stmt|;
name|size
operator|=
name|IOMB_SIZE64
expr_stmt|;
break|break;
block|}
comment|/* If free IOMB avaliable,  set up pRequest*/
name|pRequest
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|pRequest
operator|->
name|pIORequestContext
operator|=
name|agIORequest
expr_stmt|;
name|pRequest
operator|->
name|pDevice
operator|=
name|pDevice
expr_stmt|;
name|pRequest
operator|->
name|requestType
operator|=
name|agRequestType
expr_stmt|;
name|pRequest
operator|->
name|pPort
operator|=
name|pPort
expr_stmt|;
name|pRequest
operator|->
name|startTick
operator|=
name|saRoot
operator|->
name|timeTick
expr_stmt|;
name|pRequest
operator|->
name|completionCB
operator|=
name|agCB
expr_stmt|;
comment|/* Set request to the sdkData of agIORequest */
name|agIORequest
operator|->
name|sdkData
operator|=
name|pRequest
expr_stmt|;
comment|/* save tag and IOrequest pointer to IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|pRequest
operator|->
name|HTag
index|]
operator|.
name|Tag
operator|=
name|pRequest
operator|->
name|HTag
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|pRequest
operator|->
name|HTag
index|]
operator|.
name|IORequest
operator|=
operator|(
name|void
operator|*
operator|)
name|pRequest
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_LL_IBQ_PROTECT
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_IBQ0_LOCK
operator|+
name|inq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_LL_IBQ_PROTECT */
comment|/* Get a free inbound queue entry */
ifdef|#
directive|ifdef
name|LOOPBACK_MPI
if|if
condition|(
name|loopback
condition|)
block|{
name|SA_DBG2
argument_list|(
operator|(
literal|"saSSPStart: did %d ioq %d / %d tag %d\n"
operator|,
name|pDevice
operator|->
name|DeviceMapIndex
operator|,
name|inq
operator|,
name|outq
operator|,
name|pRequest
operator|->
name|HTag
operator|)
argument_list|)
expr_stmt|;
name|circularOQ
operator|=
operator|&
name|saRoot
operator|->
name|outboundQueue
index|[
name|outq
index|]
expr_stmt|;
name|retVal
operator|=
name|mpiMsgFreeGetOQ
argument_list|(
name|circularOQ
argument_list|,
name|size
argument_list|,
operator|&
name|pMessage
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
comment|/* LOOPBACK_MPI */
block|{
name|circularQ
operator|=
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|inq
index|]
expr_stmt|;
name|retVal
operator|=
name|mpiMsgFreeGet
argument_list|(
name|circularQ
argument_list|,
name|size
argument_list|,
operator|&
name|pMessage
argument_list|)
expr_stmt|;
block|}
comment|/* if message size is too large return failure */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|retVal
condition|)
block|{
ifdef|#
directive|ifdef
name|SA_LL_IBQ_PROTECT
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_IBQ0_LOCK
operator|+
name|inq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_LL_IBQ_PROTECT */
comment|/* if not sending return to free list rare */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|pDevice
operator|->
name|pendingIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart, error when get free IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"Sa"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
comment|/* return busy if inbound queue is full */
if|if
condition|(
name|AGSA_RC_BUSY
operator|==
name|retVal
condition|)
block|{
ifdef|#
directive|ifdef
name|SA_LL_IBQ_PROTECT
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_IBQ0_LOCK
operator|+
name|inq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_LL_IBQ_PROTECT */
comment|/* if not sending return to free list rare */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|pDevice
operator|->
name|pendingIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart, no more IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"Sa"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_BUSY
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart:agRequestType %X\n"
operator|,
name|agRequestType
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|agRequestType
condition|)
block|{
case|case
name|AGSA_SSP_INIT_READ
case|:
case|case
name|AGSA_SSP_INIT_WRITE
case|:
case|case
name|AGSA_SSP_INIT_NONDATA
case|:
case|case
name|AGSA_SSP_INIT_READ_EXT
case|:
case|case
name|AGSA_SSP_INIT_WRITE_EXT
case|:
case|case
name|AGSA_SSP_INIT_READ_M
case|:
case|case
name|AGSA_SSP_INIT_WRITE_M
case|:
case|case
name|AGSA_SSP_INIT_READ_EXT_M
case|:
case|case
name|AGSA_SSP_INIT_WRITE_EXT_M
case|:
case|case
name|AGSA_SSP_INIT_READ_INDIRECT
case|:
case|case
name|AGSA_SSP_INIT_WRITE_INDIRECT
case|:
case|case
name|AGSA_SSP_INIT_READ_INDIRECT_M
case|:
case|case
name|AGSA_SSP_INIT_WRITE_INDIRECT_M
case|:
block|{
if|if
condition|(
operator|!
operator|(
name|agRequestType
operator|&
name|AGSA_SSP_EXT_BIT
operator|)
condition|)
block|{
name|agsaSSPInitiatorRequest_t
modifier|*
name|pIRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspInitiatorReq
operator|)
decl_stmt|;
name|agsaSSPIniIOStartCmd_t
modifier|*
name|pPayload
init|=
operator|(
name|agsaSSPIniIOStartCmd_t
operator|*
operator|)
name|pMessage
decl_stmt|;
name|agsaSSPIniEncryptIOStartCmd_t
modifier|*
name|pEncryptPayload
init|=
operator|(
name|agsaSSPIniEncryptIOStartCmd_t
operator|*
operator|)
name|pMessage
decl_stmt|;
comment|/* Most fields for the SAS IOMB have the same offset regardless of the actual IOMB used. */
comment|/* Be careful with the scatter/gather lists, encryption and DIF options. */
comment|/*          if( pIRequest->sspCmdIU.cdb[ 0] ==  0x28 || pIRequest->sspCmdIU.cdb[0]== 0x2A)           {             pRequest->requestBlock = ((pIRequest->sspCmdIU.cdb[2]<< 24 ) |                              (pIRequest->sspCmdIU.cdb[3]<< 16 ) |                              (pIRequest->sspCmdIU.cdb[4]<<  8 ) |                               (pIRequest->sspCmdIU.cdb[5] ) );           } */
ifdef|#
directive|ifdef
name|LOOPBACK_MPI
if|if
condition|(
name|loopback
condition|)
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPCompletionRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|,
name|pRequest
operator|->
name|HTag
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPCompletionRsp_t
argument_list|,
name|status
argument_list|)
argument_list|,
name|OSSA_IO_SUCCESS
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPCompletionRsp_t
argument_list|,
name|param
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|//OSSA_WRITE_LE_32(agRoot, pPayload, OSSA_OFFSET_OF(agsaSSPCompletionRsp_t, SSPTag), 0);
block|}
else|else
endif|#
directive|endif
comment|/* LOOPBACK_MPI */
block|{
comment|/* SSPIU less equal 28 bytes */
comment|/* Configure DWORD 1 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniIOStartCmd_t
argument_list|,
name|tag
argument_list|)
argument_list|,
name|pRequest
operator|->
name|HTag
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 2 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniIOStartCmd_t
argument_list|,
name|deviceId
argument_list|)
argument_list|,
name|pDevice
operator|->
name|DeviceMapIndex
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 3 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniIOStartCmd_t
argument_list|,
name|dataLen
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|dataLength
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SA_TESTBASE_EXTRA
comment|/* TestBase - Set the host BST entry  */
name|DirDW4
operator||=
operator|(
operator|(
name|UINT32
operator|)
name|pIRequest
operator|->
name|bstIndex
operator|)
operator|<<
literal|16
expr_stmt|;
endif|#
directive|endif
comment|/*  SA_TESTBASE_EXTRA */
if|if
condition|(
operator|!
operator|(
name|agRequestType
operator|&
name|AGSA_SSP_INDIRECT_BIT
operator|)
condition|)
block|{
comment|/* Configure DWORD 5-12  */
name|si_memcpy
argument_list|(
operator|&
name|pPayload
operator|->
name|SSPInfoUnit
argument_list|,
operator|&
name|pIRequest
operator|->
name|sspCmdIU
argument_list|,
sizeof|sizeof
argument_list|(
name|pPayload
operator|->
name|SSPInfoUnit
argument_list|)
argument_list|)
expr_stmt|;
name|pPayload
operator|->
name|dirMTlr
operator|=
literal|0
expr_stmt|;
comment|/* Mask DIR for Read/Write command */
comment|/* Configure DWORD 4 bit 8-9 */
name|DirDW4
operator||=
name|agRequestType
operator|&
name|AGSA_DIR_MASK
expr_stmt|;
block|}
else|else
comment|/* AGSA_SSP_INDIRECT_BIT was set */
block|{
name|agsaSSPInitiatorRequestIndirect_t
modifier|*
name|pIndRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspInitiatorReqIndirect
operator|)
decl_stmt|;
comment|/* Configure DWORD 5 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|sspiu_0_3_indcdbalL
argument_list|)
argument_list|,
name|pIndRequest
operator|->
name|sspInitiatorReqAddrLower32
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 6 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|sspiu_4_7_indcdbalH
argument_list|)
argument_list|,
name|pIndRequest
operator|->
name|sspInitiatorReqAddrUpper32
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 7 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|sspiu_8_11
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 8 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|sspiu_12_15
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 9 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|sspiu_16_19
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 10 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|sspiu_19_23
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 11 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|sspiu_24_27
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Mask DIR for Read/Write command */
comment|/* Configure DWORD 4 bit 8-9 */
name|DirDW4
operator||=
name|agRequestType
operator|&
name|AGSA_DIR_MASK
expr_stmt|;
comment|/* Configure DWORD 4 bit 24-31 */
name|DirDW4
operator||=
operator|(
operator|(
name|pIndRequest
operator|->
name|sspInitiatorReqLen
operator|>>
literal|2
operator|)
operator|&
literal|0xFF
operator|)
operator|<<
name|SHIFT24
expr_stmt|;
comment|/* Configure DWORD 4 bit 4 */
name|DirDW4
operator||=
literal|1
operator|<<
name|SHIFT3
expr_stmt|;
block|}
comment|/* set TLR */
name|DirDW4
operator||=
name|pIRequest
operator|->
name|flag
operator|&
name|TLR_MASK
expr_stmt|;
if|if
condition|(
name|agRequestType
operator|&
name|AGSA_MSG
condition|)
block|{
comment|/* set M bit */
name|DirDW4
operator||=
name|AGSA_MSG_BIT
expr_stmt|;
block|}
comment|/* check for skipmask operation */
if|if
condition|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_SKIP_MASK
condition|)
block|{
name|DirDW4
operator||=
name|AGSA_SKIP_MASK_BIT
expr_stmt|;
comment|/* agsaSSPInitiatorRequestIndirect_t skip mask in flag is offset 5  */
name|DirDW4
operator||=
operator|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_SKIP_MASK_OFFSET
operator|)
operator|<<
name|SHIFT8
expr_stmt|;
block|}
comment|/* Configure DWORDS 12-14 */
if|if
condition|(
name|pIRequest
operator|->
name|encrypt
operator|.
name|enableEncryptionPerLA
operator|&&
name|pIRequest
operator|->
name|dif
operator|.
name|enableDIFPerLA
condition|)
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 12 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|epl_descL
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|EncryptionPerLAAddrLo
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 13 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|dpl_descL
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|dif
operator|.
name|DIFPerLAAddrLo
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|pIRequest
operator|->
name|encrypt
operator|.
name|EncryptionPerLAAddrHi
operator|==
name|pIRequest
operator|->
name|dif
operator|.
name|DIFPerLAAddrHi
argument_list|,
literal|"EPL DPL hi region must be equal"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pIRequest
operator|->
name|encrypt
operator|.
name|EncryptionPerLAAddrHi
operator|!=
name|pIRequest
operator|->
name|dif
operator|.
name|DIFPerLAAddrHi
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart: EPL DPL hi region must be equal AGSA_RC_FAILURE\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"Sa"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
goto|goto
name|ext
goto|;
block|}
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 14 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|edpl_descH
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|EncryptionPerLAAddrHi
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pIRequest
operator|->
name|encrypt
operator|.
name|enableEncryptionPerLA
condition|)
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 12 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|epl_descL
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|EncryptionPerLAAddrLo
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 13 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|dpl_descL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 14 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|edpl_descH
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|EncryptionPerLAAddrHi
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pIRequest
operator|->
name|dif
operator|.
name|enableDIFPerLA
condition|)
comment|/* configure DIF */
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 12 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|epl_descL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 13 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|dpl_descL
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|dif
operator|.
name|DIFPerLAAddrLo
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 14 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|edpl_descH
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|dif
operator|.
name|DIFPerLAAddrHi
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* Not EPL or DPL  */
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 12 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|epl_descL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 13 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|dpl_descL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
comment|/* DWORD 14 */
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|edpl_descH
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_DIF
condition|)
block|{
name|bit32
name|UDTR1_UDTR0_UDT1_UDT0
init|=
literal|0
decl_stmt|;
name|bit32
name|UDT5_UDT4_UDT3_UDT2
init|=
literal|0
decl_stmt|;
name|bit32
name|UDTR5_UDTR4_UDTR3_UDTR2
init|=
literal|0
decl_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,DIF enableRefBlockCount ref %d enableRefBlockCount  %d enableCrc  %d enableCrcInversion %d\n"
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_UDTR_REF_BLKCOUNT
condition|?
literal|1
else|:
literal|0
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_UDTR_REF_BLKCOUNT
condition|?
literal|1
else|:
literal|0
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CRC_VER
condition|?
literal|1
else|:
literal|0
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CRC_INV
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,DIF initialIOSeed %X lbSize %X difAction %X\n"
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CRC_SEED
condition|?
literal|1
else|:
literal|0
operator|,
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_BLOCKSIZE_MASK
operator|)
operator|>>
name|DIF_FLAG_BITS_BLOCKSIZE_SHIFT
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_ACTION
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,DIF udtArray %2X %2X %2X %2X %2X %2X\n"
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|0
index|]
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|1
index|]
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|2
index|]
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|3
index|]
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|4
index|]
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,DIF udrtArray %2X %2X %2X %2X %2X %2X\n"
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|0
index|]
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|1
index|]
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|2
index|]
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|3
index|]
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|4
index|]
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,DIF tagUpdateMask %X tagVerifyMask %X DIFPerLAAddrLo %X DIFPerLAAddrHi %X\n"
operator|,
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_UDTVMASK
operator|)
operator|>>
name|DIF_FLAG_BITS_UDTV_SHIFT
operator|,
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_UDTUPMASK
operator|)
operator|>>
name|DIF_FLAG_BITS_UDTUPSHIFT
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|DIFPerLAAddrLo
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|DIFPerLAAddrHi
operator|)
argument_list|)
expr_stmt|;
name|DirDW4
operator||=
name|AGSA_DIF_BIT
expr_stmt|;
comment|/* DWORD 15 */
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart, DW 15 DIF_flags 0x%08X\n"
operator|,
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|)
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|DIF_flags
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|dif
operator|.
name|flags
argument_list|)
expr_stmt|;
comment|/* Populate the UDT and UDTR bytes as necessary. */
if|if
condition|(
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_ACTION
operator|)
operator|!=
name|AGSA_DIF_INSERT
condition|)
block|{
name|UDTR1_UDTR0_UDT1_UDT0
operator|=
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|1
index|]
operator|<<
name|SHIFT8
operator||
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|UDT5_UDT4_UDT3_UDT2
operator|=
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|5
index|]
operator|<<
name|SHIFT24
operator||
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|4
index|]
operator|<<
name|SHIFT16
operator||
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|3
index|]
operator|<<
name|SHIFT8
operator||
name|pIRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|2
index|]
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_ACTION
operator|)
operator|==
name|AGSA_DIF_INSERT
operator|||
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_ACTION
operator|)
operator|==
name|AGSA_DIF_VERIFY_REPLACE
operator|||
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_ACTION
operator|)
operator|==
name|AGSA_DIF_REPLACE_UDT_REPLACE_CRC
condition|)
block|{
name|UDTR1_UDTR0_UDT1_UDT0
operator||=
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|1
index|]
operator|<<
name|SHIFT24
operator||
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|0
index|]
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|UDTR5_UDTR4_UDTR3_UDTR2
operator|=
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|5
index|]
operator|<<
name|SHIFT24
operator||
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|4
index|]
operator|<<
name|SHIFT16
operator||
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|3
index|]
operator|<<
name|SHIFT8
operator||
name|pIRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|2
index|]
operator|)
expr_stmt|;
block|}
comment|/* DWORD 16 is UDT3, UDT2, UDT1 and UDT0 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|udt
argument_list|)
argument_list|,
name|UDTR1_UDTR0_UDT1_UDT0
argument_list|)
expr_stmt|;
comment|/* DWORD 17 is UDT5, UDT4, UDT3 and UDT2 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|udtReplacementLo
argument_list|)
argument_list|,
name|UDT5_UDT4_UDT3_UDT2
argument_list|)
expr_stmt|;
comment|/* DWORD 18 is UDTR5, UDTR4, UDTR3 and UDTR2 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|udtReplacementHi
argument_list|)
argument_list|,
name|UDTR5_UDTR4_UDTR3_UDTR2
argument_list|)
expr_stmt|;
comment|/* DWORD 19 */
comment|/* Get IOS IOSeed enable bit */
if|if
condition|(
name|pIRequest
operator|->
name|dif
operator|.
name|enableDIFPerLA
operator|||
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CUST_APP_TAG
operator|)
condition|)
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|DIF_seed
argument_list|)
argument_list|,
operator|(
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|DIFPerLARegion0SecCount
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CRC_SEED
condition|?
name|pIRequest
operator|->
name|dif
operator|.
name|initialIOSeed
else|:
literal|0
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pIRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CRC_SEED
condition|)
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|DIF_seed
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|dif
operator|.
name|initialIOSeed
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|DIF_seed
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* configure encryption */
if|if
condition|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_ENCRYPTION
condition|)
block|{
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,ENC dekTable 0x%08X dekIndex 0x%08X\n"
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|dekInfo
operator|.
name|dekTable
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|dekInfo
operator|.
name|dekIndex
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,ENC kekIndex 0x%08X sectorSizeIndex 0x%08X cipherMode 0x%08X\n"
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|kekIndex
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|sectorSizeIndex
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|cipherMode
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,ENC keyTag_W0 0x%08X keyTag_W1 0x%08X\n"
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|keyTag_W0
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|keyTag_W1
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,ENC tweakVal_W0 0x%08X tweakVal_W1 0x%08X\n"
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|tweakVal_W0
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|tweakVal_W1
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,ENC tweakVal_W2 0x%08X tweakVal_W3 0x%08X\n"
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|tweakVal_W2
operator|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|tweakVal_W3
operator|)
argument_list|)
expr_stmt|;
name|DirDW4
operator||=
name|AGSA_ENCRYPT_BIT
expr_stmt|;
name|encryptFlags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pIRequest
operator|->
name|encrypt
operator|.
name|keyTagCheck
operator|==
name|agTRUE
condition|)
block|{
name|encryptFlags
operator||=
name|AGSA_ENCRYPT_KEY_TAG_BIT
expr_stmt|;
block|}
if|if
condition|(
name|pIRequest
operator|->
name|encrypt
operator|.
name|cipherMode
operator|==
name|agsaEncryptCipherModeXTS
condition|)
block|{
name|encryptFlags
operator||=
name|AGSA_ENCRYPT_XTS_Mode
operator|<<
name|SHIFT4
expr_stmt|;
block|}
name|encryptFlags
operator||=
name|pIRequest
operator|->
name|encrypt
operator|.
name|dekInfo
operator|.
name|dekTable
operator|<<
name|SHIFT2
expr_stmt|;
comment|/* Always use encryption for DIF fields, skip SKPD */
name|encryptFlags
operator||=
operator|(
name|pIRequest
operator|->
name|encrypt
operator|.
name|dekInfo
operator|.
name|dekIndex
operator|&
literal|0xFFFFFF
operator|)
operator|<<
name|SHIFT8
expr_stmt|;
comment|/* Configure DWORD 20 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|encryptFlagsLo
argument_list|)
argument_list|,
name|encryptFlags
argument_list|)
expr_stmt|;
name|encryptFlags
operator|=
name|pIRequest
operator|->
name|encrypt
operator|.
name|sectorSizeIndex
expr_stmt|;
name|encryptFlags
operator||=
operator|(
name|pIRequest
operator|->
name|encrypt
operator|.
name|kekIndex
operator|)
operator|<<
name|SHIFT5
expr_stmt|;
name|encryptFlags
operator||=
operator|(
name|pIRequest
operator|->
name|encrypt
operator|.
name|EncryptionPerLRegion0SecCount
operator|)
operator|<<
name|SHIFT16
expr_stmt|;
comment|/* Configure DWORD 21 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|encryptFlagsHi
argument_list|)
argument_list|,
name|encryptFlags
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 22 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|keyTag_W0
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|keyTag_W0
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 23 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|keyTag_W1
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|keyTag_W1
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 24 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|tweakVal_W0
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|tweakVal_W0
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 25 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|tweakVal_W1
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|tweakVal_W1
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 26 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|tweakVal_W2
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|tweakVal_W2
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 27 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniEncryptIOStartCmd_t
argument_list|,
name|tweakVal_W3
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|encrypt
operator|.
name|tweakVal_W3
argument_list|)
expr_stmt|;
block|}
comment|/* Setup SGL */
if|if
condition|(
name|pIRequest
operator|->
name|dataLength
condition|)
block|{
name|pSgl
operator|=
operator|&
operator|(
name|pIRequest
operator|->
name|agSgl
operator|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart:opCode %X agSgl %08x:%08x (%x/%x)\n"
operator|,
name|opCode
operator|,
name|pSgl
operator|->
name|sgUpper
operator|,
name|pSgl
operator|->
name|sgLower
operator|,
name|pSgl
operator|->
name|len
operator|,
name|pSgl
operator|->
name|extReserved
operator|)
argument_list|)
expr_stmt|;
comment|/* Get DIF PER LA flag */
name|DirDW4
operator||=
operator|(
name|pIRequest
operator|->
name|dif
operator|.
name|enableDIFPerLA
condition|?
operator|(
literal|1
operator|<<
name|SHIFT7
operator|)
else|:
literal|0
operator|)
expr_stmt|;
name|DirDW4
operator||=
operator|(
name|pIRequest
operator|->
name|encrypt
operator|.
name|enableEncryptionPerLA
condition|?
operator|(
literal|1
operator|<<
name|SHIFT12
operator|)
else|:
literal|0
operator|)
expr_stmt|;
comment|/* Configure DWORD 4 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniIOStartCmd_t
argument_list|,
name|dirMTlr
argument_list|)
argument_list|,
name|DirDW4
argument_list|)
expr_stmt|;
if|if
condition|(
name|opCode
operator|==
name|OPC_INB_SSP_DIF_ENC_OPSTART
condition|)
block|{
comment|/* Configure DWORD 28 */
name|pEncryptPayload
operator|->
name|AddrLow0
operator|=
name|pSgl
operator|->
name|sgLower
expr_stmt|;
comment|/* Configure DWORD 29 */
name|pEncryptPayload
operator|->
name|AddrHi0
operator|=
name|pSgl
operator|->
name|sgUpper
expr_stmt|;
comment|/* Configure DWORD 30 */
name|pEncryptPayload
operator|->
name|Len0
operator|=
name|pSgl
operator|->
name|len
expr_stmt|;
comment|/* Configure DWORD 31 */
name|pEncryptPayload
operator|->
name|E0
operator|=
name|pSgl
operator|->
name|extReserved
expr_stmt|;
block|}
else|else
block|{
name|pPayload
operator|->
name|AddrLow0
operator|=
name|pSgl
operator|->
name|sgLower
expr_stmt|;
name|pPayload
operator|->
name|AddrHi0
operator|=
name|pSgl
operator|->
name|sgUpper
expr_stmt|;
name|pPayload
operator|->
name|Len0
operator|=
name|pSgl
operator|->
name|len
expr_stmt|;
name|pPayload
operator|->
name|E0
operator|=
name|pSgl
operator|->
name|extReserved
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* no data transfer */
comment|/* Configure DWORD 4 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniIOStartCmd_t
argument_list|,
name|dirMTlr
argument_list|)
argument_list|,
name|DirDW4
argument_list|)
expr_stmt|;
if|if
condition|(
name|opCode
operator|==
name|OPC_INB_SSP_DIF_ENC_OPSTART
condition|)
block|{
name|pEncryptPayload
operator|=
operator|(
name|agsaSSPIniEncryptIOStartCmd_t
operator|*
operator|)
name|pPayload
expr_stmt|;
name|pEncryptPayload
operator|->
name|AddrLow0
operator|=
literal|0
expr_stmt|;
name|pEncryptPayload
operator|->
name|AddrHi0
operator|=
literal|0
expr_stmt|;
name|pEncryptPayload
operator|->
name|Len0
operator|=
literal|0
expr_stmt|;
name|pEncryptPayload
operator|->
name|E0
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|pPayload
operator|->
name|AddrLow0
operator|=
literal|0
expr_stmt|;
name|pPayload
operator|->
name|AddrHi0
operator|=
literal|0
expr_stmt|;
name|pPayload
operator|->
name|Len0
operator|=
literal|0
expr_stmt|;
name|pPayload
operator|->
name|E0
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* post the IOMB to SPC */
ifdef|#
directive|ifdef
name|LOOPBACK_MPI
if|if
condition|(
name|loopback
condition|)
name|ret
operator|=
name|mpiMsgProduceOQ
argument_list|(
name|circularOQ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pMessage
argument_list|,
name|MPI_CATEGORY_SAS_SATA
argument_list|,
name|OPC_OUB_SSP_COMP
argument_list|,
name|outq
argument_list|,
operator|(
name|bit8
operator|)
name|circularQ
operator|->
name|priority
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
comment|/* LOOPBACK_MPI */
name|ret
operator|=
name|mpiMsgProduce
argument_list|(
name|circularQ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pMessage
argument_list|,
name|MPI_CATEGORY_SAS_SATA
argument_list|,
name|opCode
argument_list|,
name|outq
argument_list|,
operator|(
name|bit8
operator|)
name|circularQ
operator|->
name|priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|ret
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart, error when post SSP IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* additionalCdbLen is not zero and type is Ext - use EXT mode */
name|agsaSSPInitiatorRequestExt_t
modifier|*
name|pIRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspInitiatorReqExt
operator|)
decl_stmt|;
name|agsaSSPIniExtIOStartCmd_t
modifier|*
name|pPayload
init|=
operator|(
name|agsaSSPIniExtIOStartCmd_t
operator|*
operator|)
name|pMessage
decl_stmt|;
name|bit32
name|sspiul
decl_stmt|;
comment|/*            * Most fields for the SAS IOMB have the same offset regardless of the actual IOMB used.            * Be careful with the scatter/gather lists, encryption and DIF options.            */
comment|/* CDB> 16 bytes */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniExtIOStartCmd_t
argument_list|,
name|tag
argument_list|)
argument_list|,
name|pRequest
operator|->
name|HTag
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniExtIOStartCmd_t
argument_list|,
name|deviceId
argument_list|)
argument_list|,
name|pDevice
operator|->
name|DeviceMapIndex
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniExtIOStartCmd_t
argument_list|,
name|dataLen
argument_list|)
argument_list|,
name|pIRequest
operator|->
name|dataLength
argument_list|)
expr_stmt|;
comment|/* dword (bit7-bit2) ==> bytes (bit7-bit0) */
comment|/* setup standard CDB bytes + additional CDB bytes in length field */
name|sspiul
operator|=
sizeof|sizeof
argument_list|(
name|agsaSSPCmdInfoUnit_t
argument_list|)
operator|+
operator|(
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|additionalCdbLen
operator|&
literal|0xFC
operator|)
expr_stmt|;
name|DirDW4
operator|=
name|sspiul
operator|<<
literal|16
expr_stmt|;
name|si_memcpy
argument_list|(
operator|&
name|pPayload
operator|->
name|SSPIu
index|[
literal|0
index|]
argument_list|,
operator|&
name|pIRequest
operator|->
name|sspCmdIUExt
argument_list|,
name|sspiul
argument_list|)
expr_stmt|;
name|pPayload
operator|->
name|SSPIuLendirMTlr
operator|=
literal|0
expr_stmt|;
comment|/* Mask DIR for Read/Write command */
name|DirDW4
operator||=
name|agRequestType
operator|&
name|AGSA_DIR_MASK
expr_stmt|;
comment|/* set TLR */
name|DirDW4
operator||=
name|pIRequest
operator|->
name|flag
operator|&
name|TLR_MASK
expr_stmt|;
if|if
condition|(
name|agRequestType
operator|&
name|AGSA_MSG
condition|)
block|{
comment|/* set M bit */
name|DirDW4
operator||=
name|AGSA_MSG_BIT
expr_stmt|;
block|}
comment|/* check for skipmask operation */
if|if
condition|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_SKIP_MASK
condition|)
block|{
name|SA_ASSERT
argument_list|(
literal|0
argument_list|,
literal|"Mode not supported"
argument_list|)
expr_stmt|;
block|}
comment|/* configure DIF */
if|if
condition|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_DIF
condition|)
block|{
name|SA_ASSERT
argument_list|(
literal|0
argument_list|,
literal|"Mode not supported"
argument_list|)
expr_stmt|;
block|}
comment|/* configure encryption */
if|if
condition|(
name|pIRequest
operator|->
name|flag
operator|&
name|AGSA_SAS_ENABLE_ENCRYPTION
condition|)
block|{
name|SA_ASSERT
argument_list|(
literal|0
argument_list|,
literal|"Mode not supported"
argument_list|)
expr_stmt|;
block|}
comment|/* Setup SGL */
if|if
condition|(
name|pIRequest
operator|->
name|dataLength
condition|)
block|{
name|pSgl
operator|=
operator|&
operator|(
name|pIRequest
operator|->
name|agSgl
operator|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart: Ext mode, agSgl %08x:%08x (%x/%x)\n"
operator|,
name|pSgl
operator|->
name|sgUpper
operator|,
name|pSgl
operator|->
name|sgLower
operator|,
name|pSgl
operator|->
name|len
operator|,
name|pSgl
operator|->
name|extReserved
operator|)
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniExtIOStartCmd_t
argument_list|,
name|SSPIuLendirMTlr
argument_list|)
argument_list|,
name|DirDW4
argument_list|)
expr_stmt|;
if|if
condition|(
name|opCode
operator|==
name|OPC_INB_SSP_DIF_ENC_OPSTART
condition|)
block|{
name|si_memcpy
argument_list|(
operator|(
operator|&
operator|(
operator|(
name|agsaSSPIniEncryptIOStartCmd_t
operator|*
operator|)
operator|(
name|pPayload
operator|)
operator|)
operator|->
name|AddrLow0
operator|)
argument_list|,
name|pSgl
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSgl_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|si_memcpy
argument_list|(
operator|(
operator|&
operator|(
name|pPayload
operator|->
name|SSPIu
index|[
literal|0
index|]
operator|)
operator|+
name|sspiul
operator|)
argument_list|,
name|pSgl
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSgl_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* no data transfer */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniExtIOStartCmd_t
argument_list|,
name|SSPIuLendirMTlr
argument_list|)
argument_list|,
name|DirDW4
argument_list|)
expr_stmt|;
name|pPayload
operator|->
name|dataLen
operator|=
literal|0
expr_stmt|;
block|}
comment|/* post the IOMB to SPC */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|mpiMsgProduce
argument_list|(
name|circularQ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pMessage
argument_list|,
name|MPI_CATEGORY_SAS_SATA
argument_list|,
name|opCode
argument_list|,
name|outq
argument_list|,
operator|(
name|bit8
operator|)
name|circularQ
operator|->
name|priority
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart, error when post SSP Ext IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
block|}
break|break;
block|}
case|case
name|AGSA_SSP_TASK_MGNT_REQ
case|:
case|case
name|AGSA_SSP_TASK_MGNT_REQ_M
case|:
block|{
name|agsaIORequestDesc_t
modifier|*
name|pTMRequestToAbort
init|=
name|agNULL
decl_stmt|;
name|agsaSSPIniTMStartCmd_t
modifier|*
name|pPayload
init|=
operator|(
name|agsaSSPIniTMStartCmd_t
operator|*
operator|)
name|pMessage
decl_stmt|;
if|if
condition|(
name|agRequestType
operator|&
name|AGSA_MSG
condition|)
block|{
comment|/* set M bit */
name|DirDW4
operator|=
name|AGSA_MSG_BIT
expr_stmt|;
block|}
comment|/* set DS and ADS bit */
name|DirDW4
operator||=
operator|(
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|tmOption
operator|&
literal|0x3
operator|)
operator|<<
literal|3
expr_stmt|;
comment|/* Prepare the SSP TASK Management payload */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniTMStartCmd_t
argument_list|,
name|tag
argument_list|)
argument_list|,
name|pRequest
operator|->
name|HTag
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniTMStartCmd_t
argument_list|,
name|deviceId
argument_list|)
argument_list|,
name|pDevice
operator|->
name|DeviceMapIndex
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniTMStartCmd_t
argument_list|,
name|relatedTag
argument_list|)
argument_list|,
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|tagOfTaskToBeManaged
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniTMStartCmd_t
argument_list|,
name|TMfunction
argument_list|)
argument_list|,
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|taskMgntFunction
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniTMStartCmd_t
argument_list|,
name|dsAdsMReport
argument_list|)
argument_list|,
name|DirDW4
argument_list|)
expr_stmt|;
name|pPayload
operator|->
name|lun
index|[
literal|0
index|]
operator|=
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|lun
index|[
literal|0
index|]
expr_stmt|;
name|pPayload
operator|->
name|lun
index|[
literal|1
index|]
operator|=
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|lun
index|[
literal|1
index|]
expr_stmt|;
name|pPayload
operator|->
name|lun
index|[
literal|2
index|]
operator|=
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|lun
index|[
literal|2
index|]
expr_stmt|;
name|pPayload
operator|->
name|lun
index|[
literal|3
index|]
operator|=
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|lun
index|[
literal|3
index|]
expr_stmt|;
name|pPayload
operator|->
name|lun
index|[
literal|4
index|]
operator|=
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|lun
index|[
literal|4
index|]
expr_stmt|;
name|pPayload
operator|->
name|lun
index|[
literal|5
index|]
operator|=
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|lun
index|[
literal|5
index|]
expr_stmt|;
name|pPayload
operator|->
name|lun
index|[
literal|6
index|]
operator|=
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|lun
index|[
literal|6
index|]
expr_stmt|;
name|pPayload
operator|->
name|lun
index|[
literal|7
index|]
operator|=
name|agRequestBody
operator|->
name|sspTaskMgntReq
operator|.
name|lun
index|[
literal|7
index|]
expr_stmt|;
if|if
condition|(
name|agTMRequest
condition|)
block|{
name|pTMRequestToAbort
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|agTMRequest
operator|->
name|sdkData
expr_stmt|;
if|if
condition|(
name|pTMRequestToAbort
condition|)
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPIniTMStartCmd_t
argument_list|,
name|relatedTag
argument_list|)
argument_list|,
name|pTMRequestToAbort
operator|->
name|HTag
argument_list|)
expr_stmt|;
block|}
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart, HTAG 0x%x TM function 0x%x Tag-to-be-aborted 0x%x deviceId 0x%x\n"
operator|,
name|pPayload
operator|->
name|tag
operator|,
name|pPayload
operator|->
name|TMfunction
operator|,
name|pPayload
operator|->
name|relatedTag
operator|,
name|pPayload
operator|->
name|deviceId
operator|)
argument_list|)
expr_stmt|;
name|siDumpActiveIORequests
argument_list|(
name|agRoot
argument_list|,
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
argument_list|)
expr_stmt|;
comment|/* post the IOMB to SPC */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|mpiMsgProduce
argument_list|(
name|circularQ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pMessage
argument_list|,
name|MPI_CATEGORY_SAS_SATA
argument_list|,
name|OPC_INB_SSPINITMSTART
argument_list|,
name|outq
argument_list|,
operator|(
name|bit8
operator|)
name|circularQ
operator|->
name|priority
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart, error when post TM IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
break|break;
block|}
case|case
name|AGSA_SSP_TGT_READ_DATA
case|:
case|case
name|AGSA_SSP_TGT_READ_GOOD_RESP
case|:
case|case
name|AGSA_SSP_TGT_WRITE_DATA
case|:
case|case
name|AGSA_SSP_TGT_WRITE_GOOD_RESP
case|:
block|{
name|agsaSSPTargetRequest_t
modifier|*
name|pTRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspTargetReq
operator|)
decl_stmt|;
name|agsaSSPTgtIOStartCmd_t
modifier|*
name|pPayload
init|=
operator|(
name|agsaSSPTgtIOStartCmd_t
operator|*
operator|)
name|pMessage
decl_stmt|;
name|bit32
name|DirDW5
init|=
literal|0
decl_stmt|;
comment|/* Prepare the SSP TGT IO Start payload */
comment|/* Configure DWORD 1 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|tag
argument_list|)
argument_list|,
name|pRequest
operator|->
name|HTag
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 2 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|deviceId
argument_list|)
argument_list|,
name|pDevice
operator|->
name|DeviceMapIndex
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 3 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|dataLen
argument_list|)
argument_list|,
name|pTRequest
operator|->
name|dataLength
argument_list|)
expr_stmt|;
comment|/* Configure DWORD 4 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|dataOffset
argument_list|)
argument_list|,
name|pTRequest
operator|->
name|offset
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart, sspOption %08X\n"
operator|,
name|pTRequest
operator|->
name|sspOption
operator|)
argument_list|)
expr_stmt|;
comment|/* Mask DIR and AutoGR bits for Read/Write command */
name|DirDW5
operator|=
operator|(
name|agRequestType
operator|&
operator|(
name|AGSA_DIR_MASK
operator||
name|AGSA_AUTO_MASK
operator|)
operator|)
operator||
operator|(
name|pTRequest
operator|->
name|agTag
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|pTRequest
operator|->
name|sspOption
operator|&
name|SSP_OPTION_DIF
condition|)
block|{
name|bit32
name|UDTR1_UDTR0_UDT1_UDT0
init|=
literal|0
decl_stmt|;
name|bit32
name|UDT5_UDT4_UDT3_UDT2
init|=
literal|0
decl_stmt|;
name|bit32
name|UDTR5_UDTR4_UDTR3_UDTR2
init|=
literal|0
decl_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,tgt DIF enableRefBlockCount ref %d enableRefBlockCount  %d enableCrc  %d enableCrcInversion %d\n"
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_UDTR_REF_BLKCOUNT
condition|?
literal|1
else|:
literal|0
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_UDTR_REF_BLKCOUNT
condition|?
literal|1
else|:
literal|0
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CRC_VER
condition|?
literal|1
else|:
literal|0
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CRC_INV
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,tgt DIF initialIOSeed %X lbSize %X difAction %X\n"
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CRC_SEED
condition|?
literal|1
else|:
literal|0
operator|,
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_BLOCKSIZE_MASK
operator|)
operator|>>
name|DIF_FLAG_BITS_BLOCKSIZE_SHIFT
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_ACTION
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,tgt DIF udtArray %2X %2X %2X %2X %2X %2X\n"
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|0
index|]
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|1
index|]
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|2
index|]
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|3
index|]
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|4
index|]
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,tgt DIF udrtArray %2X %2X %2X %2X %2X %2X\n"
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|0
index|]
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|1
index|]
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|2
index|]
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|3
index|]
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|4
index|]
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,tgt DIF tagUpdateMask %X tagVerifyMask %X DIFPerLAAddrLo %X DIFPerLAAddrHi %X\n"
operator|,
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_UDTVMASK
operator|)
operator|>>
name|DIF_FLAG_BITS_UDTV_SHIFT
operator|,
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_UDTUPMASK
operator|)
operator|>>
name|DIF_FLAG_BITS_UDTUPSHIFT
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|DIFPerLAAddrLo
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|DIFPerLAAddrHi
operator|)
argument_list|)
expr_stmt|;
name|DirDW5
operator||=
name|AGSA_SSP_TGT_BITS_DEE_DIF
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"saSSPStart,tgt  DW 15 DIF_flags 0x%08X\n"
operator|,
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|)
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|DIF_flags
argument_list|)
argument_list|,
name|pTRequest
operator|->
name|dif
operator|.
name|flags
argument_list|)
expr_stmt|;
comment|/* Populate the UDT and UDTR bytes as necessary. */
if|if
condition|(
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_ACTION
operator|)
operator|!=
name|AGSA_DIF_INSERT
condition|)
block|{
name|UDTR1_UDTR0_UDT1_UDT0
operator|=
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|1
index|]
operator|<<
name|SHIFT8
operator||
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|UDT5_UDT4_UDT3_UDT2
operator|=
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|5
index|]
operator|<<
name|SHIFT24
operator||
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|4
index|]
operator|<<
name|SHIFT16
operator||
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|3
index|]
operator|<<
name|SHIFT8
operator||
name|pTRequest
operator|->
name|dif
operator|.
name|udtArray
index|[
literal|2
index|]
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_ACTION
operator|)
operator|==
name|AGSA_DIF_INSERT
operator|||
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_ACTION
operator|)
operator|==
name|AGSA_DIF_VERIFY_REPLACE
operator|||
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_ACTION
operator|)
operator|==
name|AGSA_DIF_REPLACE_UDT_REPLACE_CRC
condition|)
block|{
name|UDTR1_UDTR0_UDT1_UDT0
operator||=
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|1
index|]
operator|<<
name|SHIFT24
operator||
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|0
index|]
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|UDTR5_UDTR4_UDTR3_UDTR2
operator|=
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|5
index|]
operator|<<
name|SHIFT24
operator||
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|4
index|]
operator|<<
name|SHIFT16
operator||
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|3
index|]
operator|<<
name|SHIFT8
operator||
name|pTRequest
operator|->
name|dif
operator|.
name|udrtArray
index|[
literal|2
index|]
operator|)
expr_stmt|;
block|}
comment|/* DWORD 8 is UDTR1, UDTR0, UDT1 and UDT0 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|udt
argument_list|)
argument_list|,
name|UDTR1_UDTR0_UDT1_UDT0
argument_list|)
expr_stmt|;
comment|/* DWORD 9 is UDT5, UDT4, UDT3 and UDT2 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|udtReplacementLo
argument_list|)
argument_list|,
name|UDT5_UDT4_UDT3_UDT2
argument_list|)
expr_stmt|;
comment|/* DWORD 10 is UDTR5, UDTR4, UDTR3 and UDTR2 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|udtReplacementHi
argument_list|)
argument_list|,
name|UDTR5_UDTR4_UDTR3_UDTR2
argument_list|)
expr_stmt|;
comment|/* DWORD 11 */
comment|/* Get IOS IOSeed enable bit */
if|if
condition|(
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CUST_APP_TAG
condition|)
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|DIF_seed
argument_list|)
argument_list|,
operator|(
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|DIFPerLARegion0SecCount
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CRC_SEED
condition|?
name|pTRequest
operator|->
name|dif
operator|.
name|initialIOSeed
else|:
literal|0
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Get IOS IOSeed enable bit */
if|if
condition|(
name|pTRequest
operator|->
name|dif
operator|.
name|flags
operator|&
name|DIF_FLAG_BITS_CRC_SEED
condition|)
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|DIF_seed
argument_list|)
argument_list|,
name|pTRequest
operator|->
name|dif
operator|.
name|initialIOSeed
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|DIF_seed
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Mask DIR and AutoGR bits for Read/Write command */
if|if
condition|(
name|pTRequest
operator|->
name|sspOption
operator|&
name|SSP_OPTION_AUTO_GOOD_RESPONSE
condition|)
block|{
name|DirDW5
operator||=
name|AGSA_SSP_TGT_BITS_AGR
expr_stmt|;
block|}
comment|/* AN, RTE, RDF bits */
name|DirDW5
operator||=
operator|(
name|pTRequest
operator|->
name|sspOption
operator|&
name|SSP_OPTION_BITS
operator|)
operator|<<
literal|2
expr_stmt|;
comment|/* ODS */
if|if
condition|(
name|pTRequest
operator|->
name|sspOption
operator|&
name|SSP_OPTION_ODS
condition|)
block|{
name|DirDW5
operator||=
name|AGSA_SSP_TGT_BITS_ODS
expr_stmt|;
block|}
comment|/* Setup SGL */
if|if
condition|(
name|pTRequest
operator|->
name|dataLength
condition|)
block|{
name|pSgl
operator|=
operator|&
operator|(
name|pTRequest
operator|->
name|agSgl
operator|)
expr_stmt|;
name|SA_DBG5
argument_list|(
operator|(
literal|"saSSPStart: agSgl %08x:%08x (%x/%x)\n"
operator|,
name|pSgl
operator|->
name|sgUpper
operator|,
name|pSgl
operator|->
name|sgLower
operator|,
name|pSgl
operator|->
name|len
operator|,
name|pSgl
operator|->
name|extReserved
operator|)
argument_list|)
expr_stmt|;
comment|/* set up dir on the payload */
comment|/* Configure DWORD 5 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|INITagAgrDir
argument_list|)
argument_list|,
name|DirDW5
argument_list|)
expr_stmt|;
name|pPayload
operator|->
name|AddrLow0
operator|=
name|pSgl
operator|->
name|sgLower
expr_stmt|;
name|pPayload
operator|->
name|AddrHi0
operator|=
name|pSgl
operator|->
name|sgUpper
expr_stmt|;
name|pPayload
operator|->
name|Len0
operator|=
name|pSgl
operator|->
name|len
expr_stmt|;
name|pPayload
operator|->
name|E0
operator|=
name|pSgl
operator|->
name|extReserved
expr_stmt|;
block|}
else|else
block|{
comment|/* no data transfer */
comment|/* Configure DWORD 5 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|INITagAgrDir
argument_list|)
argument_list|,
name|DirDW5
argument_list|)
expr_stmt|;
name|pPayload
operator|->
name|AddrLow0
operator|=
literal|0
expr_stmt|;
name|pPayload
operator|->
name|AddrHi0
operator|=
literal|0
expr_stmt|;
name|pPayload
operator|->
name|Len0
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Configure DWORD 6 */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtIOStartCmd_t
argument_list|,
name|reserved
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Build TGT IO START command and send it to SPC */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|mpiMsgProduce
argument_list|(
name|circularQ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pMessage
argument_list|,
name|MPI_CATEGORY_SAS_SATA
argument_list|,
name|OPC_INB_SSPTGTIOSTART
argument_list|,
name|outq
argument_list|,
operator|(
name|bit8
operator|)
name|circularQ
operator|->
name|priority
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart, error when post TGT IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
break|break;
block|}
case|case
name|AGSA_SSP_TGT_CMD_OR_TASK_RSP
case|:
block|{
name|agsaSSPTargetResponse_t
modifier|*
name|pTResponse
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspTargetResponse
operator|)
decl_stmt|;
name|agsaSSPTgtRspStartCmd_t
modifier|*
name|pPayload
init|=
operator|(
name|agsaSSPTgtRspStartCmd_t
operator|*
operator|)
name|pMessage
decl_stmt|;
name|bit32
name|ip
decl_stmt|,
name|an
decl_stmt|,
name|ods
decl_stmt|;
if|if
condition|(
name|pTResponse
operator|->
name|frameBuf
operator|&&
operator|(
name|pTResponse
operator|->
name|respBufLength
operator|<=
name|AGSA_MAX_SSPPAYLOAD_VIA_SFO
operator|)
condition|)
block|{
name|ip
operator|=
literal|1
expr_stmt|;
name|si_memcpy
argument_list|(
name|pPayload
operator|->
name|reserved
argument_list|,
name|pTResponse
operator|->
name|frameBuf
argument_list|,
name|pTResponse
operator|->
name|respBufLength
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ip
operator|=
literal|0
expr_stmt|;
comment|/* NOTE:            * 1. reserved field must be ZEROED out. FW depends on it            * 2. trusted interface. indirect response buffer must be valid.            */
name|si_memset
argument_list|(
name|pPayload
operator|->
name|reserved
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pPayload
operator|->
name|reserved
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtRspStartCmd_t
argument_list|,
name|AddrLow0
argument_list|)
argument_list|,
name|pTResponse
operator|->
name|respBufLower
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtRspStartCmd_t
argument_list|,
name|AddrHi0
argument_list|)
argument_list|,
name|pTResponse
operator|->
name|respBufUpper
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtRspStartCmd_t
argument_list|,
name|Len0
argument_list|)
argument_list|,
name|pTResponse
operator|->
name|respBufLength
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtRspStartCmd_t
argument_list|,
name|E0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* TLR setting */
name|an
operator|=
operator|(
name|pTResponse
operator|->
name|respOption
operator|&
name|RESP_OPTION_BITS
operator|)
expr_stmt|;
comment|/* ODS */
name|ods
operator|=
operator|(
name|pTResponse
operator|->
name|respOption
operator|&
name|RESP_OPTION_ODS
operator|)
expr_stmt|;
comment|/* Prepare the SSP TGT RESPONSE Start payload */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtRspStartCmd_t
argument_list|,
name|tag
argument_list|)
argument_list|,
name|pRequest
operator|->
name|HTag
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtRspStartCmd_t
argument_list|,
name|deviceId
argument_list|)
argument_list|,
name|pDevice
operator|->
name|DeviceMapIndex
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtRspStartCmd_t
argument_list|,
name|RspLen
argument_list|)
argument_list|,
name|pTResponse
operator|->
name|respBufLength
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|pPayload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPTgtRspStartCmd_t
argument_list|,
name|INITag_IP_AN
argument_list|)
argument_list|,
operator|(
name|pTResponse
operator|->
name|agTag
operator|<<
name|SHIFT16
operator|)
operator||
name|ods
operator||
operator|(
name|ip
operator|<<
name|SHIFT10
operator|)
operator||
operator|(
name|an
operator|<<
name|SHIFT2
operator|)
argument_list|)
expr_stmt|;
comment|/* Build TGT RESPONSE START command and send it to SPC */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|mpiMsgProduce
argument_list|(
name|circularQ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pMessage
argument_list|,
name|MPI_CATEGORY_SAS_SATA
argument_list|,
name|OPC_INB_SSPTGTRSPSTART
argument_list|,
name|outq
argument_list|,
operator|(
name|bit8
operator|)
name|circularQ
operator|->
name|priority
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart, error when post TGT RSP IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
break|break;
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPStart, Unsupported Request IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* LL IOrequest available */
ifdef|#
directive|ifdef
name|SA_LL_IBQ_PROTECT
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_IBQ0_LOCK
operator|+
name|inq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_LL_IBQ_PROTECT */
ifdef|#
directive|ifdef
name|SALL_API_TEST
if|if
condition|(
name|ret
operator|==
name|AGSA_RC_SUCCESS
condition|)
name|saRoot
operator|->
name|LLCounters
operator|.
name|IOCounter
operator|.
name|numSSPStarted
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/*SALL_API_TEST  */
ifdef|#
directive|ifdef
name|LOOPBACK_MPI
if|if
condition|(
name|loopback
condition|)
name|saRoot
operator|->
name|interruptVecIndexBitMap
index|[
literal|0
index|]
operator||=
operator|(
literal|1
operator|<<
name|outq
operator|)
expr_stmt|;
endif|#
directive|endif
comment|/* LOOPBACK_MPI */
comment|/* goto have leave and trace point info */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"Sa"
argument_list|)
expr_stmt|;
name|ext
label|:
name|OSSA_INP_LEAVE
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Abort SSP request  *  *  Abort SSP request  *  *  \param agRoot handles for this instance of SAS/SATA LLL  *  \param queueNum  *  \param agIORequest  *  \param agIOToBeAborted  *  *  \return If request is aborted successfully  *          - \e AGSA_RC_SUCCESS request is aborted successfully  *          - \e AGSA_RC_FAILURE request is not aborted successfully  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|saSSPAbort
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|queueNum
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|void
modifier|*
name|abortParam
parameter_list|,
name|ossaGenericAbortCB_t
name|agCB
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|,
name|retVal
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequestABT
init|=
name|NULL
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
init|=
name|NULL
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDeviceABT
init|=
name|NULL
decl_stmt|;
name|agsaPort_t
modifier|*
name|pPort
init|=
name|NULL
decl_stmt|;
name|mpiICQueue_t
modifier|*
name|circularQ
decl_stmt|;
name|void
modifier|*
name|pMessage
decl_stmt|;
name|agsaSSPAbortCmd_t
modifier|*
name|payload
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIOToBeAborted
decl_stmt|;
name|bit8
name|inq
decl_stmt|,
name|outq
decl_stmt|;
name|bit32
name|using_reserved
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|flag_copy
init|=
name|flag
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agIORequest
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"saSSPAbort: agIORequest %p agDevHandle %p abortParam %p flag 0x%x\n"
operator|,
name|agIORequest
operator|,
name|agDevHandle
operator|,
name|abortParam
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
comment|/* Assign inbound and outbound Buffer */
name|inq
operator|=
call|(
name|bit8
call|)
argument_list|(
name|queueNum
operator|&
name|MPI_IB_NUM_MASK
argument_list|)
expr_stmt|;
name|outq
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|queueNum
operator|&
name|MPI_OB_NUM_MASK
operator|)
operator|>>
name|MPI_OB_SHIFT
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|AGSA_MAX_INBOUND_Q
operator|>
name|inq
operator|)
argument_list|,
literal|"The IBQ Number is out of range."
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_PRINTOUT_IN_WINDBG
ifndef|#
directive|ifndef
name|DBG
name|DbgPrint
argument_list|(
literal|"saSSPAbort flag %d\n"
argument_list|,
name|flag
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DBG  */
endif|#
directive|endif
comment|/* SA_PRINTOUT_IN_WINDBG  */
if|if
condition|(
name|ABORT_SINGLE
operator|==
operator|(
name|flag
operator|&
name|ABORT_MASK
operator|)
condition|)
block|{
name|agIOToBeAborted
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
name|abortParam
expr_stmt|;
comment|/* Get LL IORequest entry for saSSPAbort() */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
operator|(
name|agIOToBeAborted
operator|->
name|sdkData
operator|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
comment|/* no pRequest found - can not Abort */
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: ABORT_ALL no pRequest\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* Find the device the request sent to */
name|pDevice
operator|=
name|pRequest
operator|->
name|pDevice
expr_stmt|;
comment|/* Get LL IORequest entry for IOToBeAborted */
name|pRequestABT
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
operator|(
name|agIOToBeAborted
operator|->
name|sdkData
operator|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequestABT
condition|)
block|{
comment|/* The IO to Be Abort is no longer exist */
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: ABORT_ALL no pRequestABT\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* Find the device the request Abort to */
name|pDeviceABT
operator|=
name|pRequestABT
operator|->
name|pDevice
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pDeviceABT
condition|)
block|{
comment|/* no deviceID - can not build IOMB */
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: ABORT_ALL no pRequestABT->deviceID\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agNULL
operator|!=
name|pDevice
condition|)
block|{
comment|/* Find the port the request was sent to */
name|pPort
operator|=
name|pDevice
operator|->
name|pPort
expr_stmt|;
block|}
else|else
block|{
comment|/* no deviceID - can not build IOMB */
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: ABORT_ALL no deviceID\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* Get request from free IORequests */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saLlistIOGetHead
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|)
expr_stmt|;
comment|/**/
block|}
else|else
block|{
if|if
condition|(
name|ABORT_ALL
operator|==
operator|(
name|flag
operator|&
name|ABORT_MASK
operator|)
condition|)
block|{
comment|/* abort All with Device or Port */
comment|/* Find the outgoing port for the device */
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
comment|/* no deviceID - can not build IOMB */
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: agDevHandle == agNULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
operator|(
name|agDevHandle
operator|->
name|sdkData
operator|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pDevice
condition|)
block|{
comment|/* no deviceID - can not build IOMB */
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: ABORT_ALL agNULL == pDevice\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|pPort
operator|=
name|pDevice
operator|->
name|pPort
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saLlistIOGetHead
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|)
expr_stmt|;
comment|/**/
block|}
else|else
block|{
comment|/* only support 00, 01 and 02 for flag */
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: ABORT_ALL type not supported 0x%X\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saLlistIOGetHead
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|pRequest
condition|)
block|{
name|using_reserved
operator|=
name|agTRUE
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"saSSPAbort: using saRoot->freeReservedRequests\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* If no LL IO request entry available */
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: No request from free list Not using saRoot->freeReservedRequests\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_BUSY
return|;
block|}
block|}
comment|/* If free IOMB avaliable */
comment|/* Remove the request from free list */
if|if
condition|(
name|using_reserved
condition|)
block|{
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Add the request to the pendingIORequests list of the device */
name|pRequest
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|pDevice
operator|->
name|pendingIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* set up pRequest */
name|pRequest
operator|->
name|pIORequestContext
operator|=
name|agIORequest
expr_stmt|;
name|pRequest
operator|->
name|requestType
operator|=
name|AGSA_SSP_REQTYPE
expr_stmt|;
name|pRequest
operator|->
name|pDevice
operator|=
name|pDevice
expr_stmt|;
name|pRequest
operator|->
name|pPort
operator|=
name|pPort
expr_stmt|;
name|pRequest
operator|->
name|completionCB
operator|=
operator|(
name|void
operator|*
operator|)
name|agCB
expr_stmt|;
comment|/*  pRequest->abortCompletionCB = agCB;*/
name|pRequest
operator|->
name|startTick
operator|=
name|saRoot
operator|->
name|timeTick
expr_stmt|;
comment|/* Set request to the sdkData of agIORequest */
name|agIORequest
operator|->
name|sdkData
operator|=
name|pRequest
expr_stmt|;
comment|/* save tag and IOrequest pointer to IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|pRequest
operator|->
name|HTag
index|]
operator|.
name|Tag
operator|=
name|pRequest
operator|->
name|HTag
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|pRequest
operator|->
name|HTag
index|]
operator|.
name|IORequest
operator|=
operator|(
name|void
operator|*
operator|)
name|pRequest
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_LL_IBQ_PROTECT
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_IBQ0_LOCK
operator|+
name|inq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_LL_IBQ_PROTECT */
comment|/* If LL IO request entry avaliable */
comment|/* Get a free inbound queue entry */
name|circularQ
operator|=
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|inq
index|]
expr_stmt|;
name|retVal
operator|=
name|mpiMsgFreeGet
argument_list|(
name|circularQ
argument_list|,
name|IOMB_SIZE64
argument_list|,
operator|&
name|pMessage
argument_list|)
expr_stmt|;
comment|/* if message size is too large return failure */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|retVal
condition|)
block|{
ifdef|#
directive|ifdef
name|SA_LL_IBQ_PROTECT
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_IBQ0_LOCK
operator|+
name|inq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_LL_IBQ_PROTECT */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|pDevice
operator|->
name|pendingIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: error when get free IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'g'
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* return busy if inbound queue is full */
if|if
condition|(
name|AGSA_RC_BUSY
operator|==
name|retVal
condition|)
block|{
ifdef|#
directive|ifdef
name|SA_LL_IBQ_PROTECT
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_IBQ0_LOCK
operator|+
name|inq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_LL_IBQ_PROTECT */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|pDevice
operator|->
name|pendingIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: no more IOMB\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'h'
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_BUSY
return|;
block|}
comment|/* setup payload */
name|payload
operator|=
operator|(
name|agsaSSPAbortCmd_t
operator|*
operator|)
name|pMessage
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|payload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPAbortCmd_t
argument_list|,
name|tag
argument_list|)
argument_list|,
name|pRequest
operator|->
name|HTag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ABORT_SINGLE
operator|==
operator|(
name|flag
operator|&
name|ABORT_MASK
operator|)
condition|)
block|{
if|if
condition|(
name|agNULL
operator|==
name|pDeviceABT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPSAbort: no device\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'i'
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|payload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPAbortCmd_t
argument_list|,
name|deviceId
argument_list|)
argument_list|,
name|pDeviceABT
operator|->
name|DeviceMapIndex
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|payload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPAbortCmd_t
argument_list|,
name|HTagAbort
argument_list|)
argument_list|,
name|pRequestABT
operator|->
name|HTag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* abort all */
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|payload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPAbortCmd_t
argument_list|,
name|deviceId
argument_list|)
argument_list|,
name|pDevice
operator|->
name|DeviceMapIndex
argument_list|)
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|payload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPAbortCmd_t
argument_list|,
name|HTagAbort
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flag
operator|&
name|ABORT_TSDK_QUARANTINE
condition|)
block|{
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|flag_copy
operator|&=
name|ABORT_SCOPE
expr_stmt|;
name|flag_copy
operator||=
name|ABORT_QUARANTINE_SPCV
expr_stmt|;
block|}
block|}
name|OSSA_WRITE_LE_32
argument_list|(
name|agRoot
argument_list|,
name|payload
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPAbortCmd_t
argument_list|,
name|abortAll
argument_list|)
argument_list|,
name|flag_copy
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saSSPAbort: HTag 0x%x HTagABT 0x%x deviceId 0x%x flag 0x%x\n"
operator|,
name|payload
operator|->
name|tag
operator|,
name|payload
operator|->
name|HTagAbort
operator|,
name|payload
operator|->
name|deviceId
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
name|siCountActiveIORequestsOnDevice
argument_list|(
name|agRoot
argument_list|,
name|payload
operator|->
name|deviceId
argument_list|)
expr_stmt|;
comment|/* post the IOMB to SPC */
name|ret
operator|=
name|mpiMsgProduce
argument_list|(
name|circularQ
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pMessage
argument_list|,
name|MPI_CATEGORY_SAS_SATA
argument_list|,
name|OPC_INB_SSP_ABORT
argument_list|,
name|outq
argument_list|,
operator|(
name|bit8
operator|)
name|circularQ
operator|->
name|priority
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_LL_IBQ_PROTECT
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_IBQ0_LOCK
operator|+
name|inq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_LL_IBQ_PROTECT */
ifdef|#
directive|ifdef
name|SALL_API_TEST
if|if
condition|(
name|AGSA_RC_SUCCESS
operator|==
name|ret
condition|)
block|{
name|saRoot
operator|->
name|LLCounters
operator|.
name|IOCounter
operator|.
name|numSSPAborted
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'j'
argument_list|,
literal|"Sb"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
end_if

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief  *  *  Dump StartSSP information  *  *  Debug helper routine  *  *  \return -none -  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|LOCAL
name|void
name|siDumpSSPStartIu
parameter_list|(
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|agRequestType
parameter_list|,
name|agsaSASRequestBody_t
modifier|*
name|agRequestBody
parameter_list|)
block|{
switch|switch
condition|(
name|agRequestType
condition|)
block|{
case|case
name|AGSA_SSP_INIT_READ
case|:
case|case
name|AGSA_SSP_INIT_WRITE
case|:
block|{
name|agsaSSPInitiatorRequest_t
modifier|*
name|pIRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspInitiatorReq
operator|)
decl_stmt|;
name|SA_DBG5
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s - len=%x - attr=%x - CDB:%02x %02x %02x %02x %02x %02x %02x %02x %02x %02x\n"
operator|,
name|agDevHandle
operator|,
operator|(
name|agRequestType
operator|==
name|AGSA_SSP_INIT_READ
operator|)
condition|?
literal|"AGSA_SSP_INIT_READ"
else|:
literal|"AGSA_SSP_INIT_WRITE"
operator|,
name|pIRequest
operator|->
name|dataLength
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|efb_tp_taskAttribute
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|0
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|1
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|2
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|3
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|4
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|5
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|6
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|7
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|8
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIU
operator|.
name|cdb
index|[
literal|9
index|]
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SSP_INIT_READ_EXT
case|:
case|case
name|AGSA_SSP_INIT_WRITE_EXT
case|:
block|{
name|agsaSSPInitiatorRequestExt_t
modifier|*
name|pIRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspInitiatorReqExt
operator|)
decl_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s - len=%x - attr=%x - CDB:%02x %02x %02x %02x %02x %02x %02x %02x %02x %02x\n"
operator|,
name|agDevHandle
operator|,
operator|(
name|agRequestType
operator|==
name|AGSA_SSP_INIT_READ_EXT
operator|)
condition|?
literal|"AGSA_SSP_INIT_READ_EXT"
else|:
literal|"AGSA_SSP_INIT_WRITE_EXT"
operator|,
name|pIRequest
operator|->
name|dataLength
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|efb_tp_taskAttribute
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|0
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|1
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|2
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|3
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|4
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|5
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|6
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|7
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|8
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|9
index|]
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SSP_INIT_READ_EXT_M
case|:
case|case
name|AGSA_SSP_INIT_WRITE_EXT_M
case|:
block|{
name|agsaSSPInitiatorRequestExt_t
modifier|*
name|pIRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspInitiatorReqExt
operator|)
decl_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s - len=%x - attr=%x - CDB:%02x %02x %02x %02x %02x %02x %02x %02x %02x %02x\n"
operator|,
name|agDevHandle
operator|,
operator|(
name|agRequestType
operator|==
name|AGSA_SSP_INIT_READ_EXT_M
operator|)
condition|?
literal|"AGSA_SSP_INIT_READ_EXT_M"
else|:
literal|"AGSA_SSP_INIT_WRITE_EXT_M"
operator|,
name|pIRequest
operator|->
name|dataLength
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|efb_tp_taskAttribute
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|0
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|1
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|2
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|3
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|4
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|5
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|6
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|7
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|8
index|]
operator|,
name|pIRequest
operator|->
name|sspCmdIUExt
operator|.
name|cdb
index|[
literal|9
index|]
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SSP_INIT_READ_INDIRECT
case|:
case|case
name|AGSA_SSP_INIT_WRITE_INDIRECT
case|:
case|case
name|AGSA_SSP_INIT_READ_INDIRECT_M
case|:
case|case
name|AGSA_SSP_INIT_WRITE_INDIRECT_M
case|:
block|{
name|agsaSSPInitiatorRequestIndirect_t
modifier|*
name|pIRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspInitiatorReqIndirect
operator|)
decl_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s - len=%x - cdblen=%d CDB:U %08x L %08x\n"
operator|,
name|agDevHandle
operator|,
operator|(
name|agRequestType
operator|==
name|AGSA_SSP_INIT_READ_INDIRECT
operator|||
name|agRequestType
operator|==
name|AGSA_SSP_INIT_READ_INDIRECT_M
operator|)
condition|?
literal|"AGSA_SSP_INIT_READ_INDIRECT"
else|:
literal|"AGSA_SSP_INIT_WRITE_INDIRECT"
operator|,
name|pIRequest
operator|->
name|dataLength
operator|,
name|pIRequest
operator|->
name|sspInitiatorReqLen
operator|,
name|pIRequest
operator|->
name|sspInitiatorReqAddrUpper32
operator|,
name|pIRequest
operator|->
name|sspInitiatorReqAddrLower32
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SSP_TASK_MGNT_REQ
case|:
block|{
name|agsaSSPScsiTaskMgntReq_t
modifier|*
name|pTaskCmd
init|=
operator|&
name|agRequestBody
operator|->
name|sspTaskMgntReq
decl_stmt|;
comment|/* copy payload */
name|SA_DBG5
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s - Task Function=%x - Tag to managed=%x"
operator|,
name|agDevHandle
operator|,
literal|"AGSA_SSP_TASK_MGNT_REQ"
operator|,
name|pTaskCmd
operator|->
name|taskMgntFunction
operator|,
name|pTaskCmd
operator|->
name|tagOfTaskToBeManaged
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SSP_TGT_READ_DATA
case|:
block|{
name|agsaSSPTargetRequest_t
modifier|*
name|pTRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspTargetReq
operator|)
decl_stmt|;
name|SA_DBG5
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s - dmaSize=%x dmaOffset=%x\n"
operator|,
name|agDevHandle
operator|,
literal|"AGSA_SSP_TGT_READ_DATA"
operator|,
name|pTRequest
operator|->
name|dataLength
operator|,
name|pTRequest
operator|->
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SSP_TGT_READ_GOOD_RESP
case|:
block|{
name|agsaSSPTargetRequest_t
modifier|*
name|pTRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspTargetReq
operator|)
decl_stmt|;
name|SA_DBG5
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s - dmaSize=%x dmaOffset=%x\n"
operator|,
name|agDevHandle
operator|,
literal|"AGSA_SSP_TGT_READ_GOOD_RESP"
operator|,
name|pTRequest
operator|->
name|dataLength
operator|,
name|pTRequest
operator|->
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SSP_TGT_WRITE_GOOD_RESP
case|:
block|{
name|agsaSSPTargetRequest_t
modifier|*
name|pTRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspTargetReq
operator|)
decl_stmt|;
name|SA_DBG5
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s - dmaSize=%x dmaOffset=%x\n"
operator|,
name|agDevHandle
operator|,
literal|"AGSA_SSP_TGT_WRITE_GOOD_RESP"
operator|,
name|pTRequest
operator|->
name|dataLength
operator|,
name|pTRequest
operator|->
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SSP_TGT_WRITE_DATA
case|:
block|{
name|agsaSSPTargetRequest_t
modifier|*
name|pTRequest
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspTargetReq
operator|)
decl_stmt|;
name|SA_DBG5
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s - dmaSize=%x dmaOffset=%x\n"
operator|,
name|agDevHandle
operator|,
literal|"AGSA_SSP_TGT_WRITE_DATA"
operator|,
name|pTRequest
operator|->
name|dataLength
operator|,
name|pTRequest
operator|->
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SSP_TGT_CMD_OR_TASK_RSP
case|:
block|{
name|agsaSSPTargetResponse_t
modifier|*
name|pTResponse
init|=
operator|&
operator|(
name|agRequestBody
operator|->
name|sspTargetResponse
operator|)
decl_stmt|;
name|SA_DBG5
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s - len=%x PAddr=%08x:%08x  Tag=%x\n"
operator|,
name|agDevHandle
operator|,
literal|"AGSA_SSP_TGT_CMD_OR_TASK_RSP"
operator|,
name|pTResponse
operator|->
name|respBufLength
operator|,
name|pTResponse
operator|->
name|respBufUpper
operator|,
name|pTResponse
operator|->
name|respBufLower
operator|,
name|pTResponse
operator|->
name|agTag
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siDumpSSPStartIu: dev=%p - %s %X\n"
operator|,
name|agDevHandle
operator|,
literal|"Unknown SSP cmd type"
operator|,
name|agRequestType
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SALLSDK_DEBUG */
end_comment

end_unit


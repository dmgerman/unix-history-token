begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/*! \file sainit.c  *  \brief The file implements the functions to initialize the LL layer  *  */
end_comment

begin_comment
comment|/******************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/saglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|siTraceFileID
end_ifdef

begin_undef
undef|#
directive|undef
name|siTraceFileID
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|siTraceFileID
value|'F'
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|bit32
name|gLLDebugLevel
init|=
literal|3
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
end_if

begin_decl_stmt
name|bit32
name|gLLDebugLevelSet
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|// block reinitialize from updating
end_comment

begin_decl_stmt
name|bit32
name|gLLLogFuncDebugLevel
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bit32
name|gLLSoftResetCounter
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|bit32
name|gPollForMissingInt
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FW_EVT_LOG_TST
end_ifdef

begin_decl_stmt
name|void
modifier|*
name|eventLogAddress
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|bit32
name|gWait_3
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|bit32
name|gWait_2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bit32
name|gFPGA_TEST
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|// If set unblock fpga functions
end_comment

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Get the memory and lock requirement from LL layer  *  *  Get the memory and lock requirement from LL layer  *  *  \param agRoot             Handles for this instance of SAS/SATA hardware  *  \param swConfig           Pointer to the software configuration  *  \param memoryRequirement  Point to the data structure that holds the different  *                                       chunks of memory that are required  *  \param usecsPerTick       micro-seconds per tick for the LL layer  *  \param maxNumLocks        maximum number of locks for the LL layer  *  *  \return -void-  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|saGetRequirements
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSwConfig_t
modifier|*
name|swConfig
parameter_list|,
name|agsaMemoryRequirement_t
modifier|*
name|memoryRequirement
parameter_list|,
name|bit32
modifier|*
name|usecsPerTick
parameter_list|,
name|bit32
modifier|*
name|maxNumLocks
parameter_list|)
block|{
name|bit32
name|memoryReqCount
init|=
literal|0
decl_stmt|;
name|bit32
name|i
decl_stmt|;
specifier|static
name|mpiConfig_t
name|mpiConfig
decl_stmt|;
specifier|static
name|mpiMemReq_t
name|mpiMemoryRequirement
decl_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|swConfig
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|memoryRequirement
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|usecsPerTick
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|maxNumLocks
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|mpiMemoryRequirement
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mpiMemReq_t
argument_list|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|mpiConfig
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mpiConfig_t
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements:agRoot %p swConfig %p memoryRequirement %p usecsPerTick %p maxNumLocks %p\n"
operator|,
name|agRoot
operator|,
name|swConfig
operator|,
name|memoryRequirement
operator|,
name|usecsPerTick
operator|,
name|maxNumLocks
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements: usecsPerTick 0x%x (%d)\n"
operator|,
operator|*
name|usecsPerTick
operator|,
operator|*
name|usecsPerTick
operator|)
argument_list|)
expr_stmt|;
comment|/* Get Resource Requirements for SPC MPI */
comment|/* Set the default/specified requirements swConfig from TD layer */
name|siConfiguration
argument_list|(
name|agRoot
argument_list|,
operator|&
name|mpiConfig
argument_list|,
name|agNULL
argument_list|,
name|swConfig
argument_list|)
expr_stmt|;
name|mpiRequirementsGet
argument_list|(
operator|&
name|mpiConfig
argument_list|,
operator|&
name|mpiMemoryRequirement
argument_list|)
expr_stmt|;
comment|/* memory requirement for saRoot, CACHE memory */
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|singleElementLength
operator|=
sizeof|sizeof
argument_list|(
name|agsaLLRoot_t
argument_list|)
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|numElements
operator|=
literal|1
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|totalLength
operator|=
sizeof|sizeof
argument_list|(
name|agsaLLRoot_t
argument_list|)
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|type
operator|=
name|AGSA_CACHED_MEM
expr_stmt|;
name|memoryReqCount
operator|++
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements: agMemory[LLROOT_MEM_INDEX] singleElementLength = 0x%x totalLength = 0x%x align = 0x%x type %x\n"
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|singleElementLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|totalLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|alignment
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
comment|/* memory requirement for Device Links, CACHE memory */
name|memoryRequirement
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
operator|.
name|singleElementLength
operator|=
sizeof|sizeof
argument_list|(
name|agsaDeviceDesc_t
argument_list|)
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
operator|.
name|numElements
operator|=
name|swConfig
operator|->
name|numDevHandles
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
operator|.
name|totalLength
operator|=
sizeof|sizeof
argument_list|(
name|agsaDeviceDesc_t
argument_list|)
operator|*
name|swConfig
operator|->
name|numDevHandles
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
operator|.
name|type
operator|=
name|AGSA_CACHED_MEM
expr_stmt|;
name|memoryReqCount
operator|++
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements: agMemory[DEVICELINK_MEM_INDEX] singleElementLength = 0x%x totalLength = 0x%x align = 0x%x type %x\n"
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
operator|.
name|singleElementLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
operator|.
name|totalLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
operator|.
name|alignment
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
comment|/* memory requirement for IORequest Links, CACHE memory */
name|memoryRequirement
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
operator|.
name|singleElementLength
operator|=
sizeof|sizeof
argument_list|(
name|agsaIORequestDesc_t
argument_list|)
expr_stmt|;
comment|/*   Add SA_RESERVED_REQUEST_COUNT to guarantee quality of service   */
name|memoryRequirement
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
operator|.
name|numElements
operator|=
name|swConfig
operator|->
name|maxActiveIOs
operator|+
name|SA_RESERVED_REQUEST_COUNT
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
operator|.
name|totalLength
operator|=
sizeof|sizeof
argument_list|(
name|agsaIORequestDesc_t
argument_list|)
operator|*
name|memoryRequirement
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
operator|.
name|numElements
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
operator|.
name|type
operator|=
name|AGSA_CACHED_MEM
expr_stmt|;
name|memoryReqCount
operator|++
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements: agMemory[IOREQLINK_MEM_INDEX] singleElementLength = 0x%x totalLength = 0x%x align = 0x%x type %x\n"
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
operator|.
name|singleElementLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
operator|.
name|totalLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
operator|.
name|alignment
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
comment|/* memory requirement for Timer Links, CACHE memory */
name|memoryRequirement
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
operator|.
name|singleElementLength
operator|=
sizeof|sizeof
argument_list|(
name|agsaTimerDesc_t
argument_list|)
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
operator|.
name|numElements
operator|=
name|NUM_TIMERS
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
operator|.
name|totalLength
operator|=
sizeof|sizeof
argument_list|(
name|agsaTimerDesc_t
argument_list|)
operator|*
name|NUM_TIMERS
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
operator|.
name|type
operator|=
name|AGSA_CACHED_MEM
expr_stmt|;
name|memoryReqCount
operator|++
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements: agMemory[TIMERLINK_MEM_INDEX] singleElementLength = 0x%x totalLength = 0x%x align = 0x%x type %x\n"
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
operator|.
name|singleElementLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
operator|.
name|totalLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
operator|.
name|alignment
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
comment|/* memory requirement for LL trace memory */
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|singleElementLength
operator|=
literal|1
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|numElements
operator|=
name|swConfig
operator|->
name|TraceBufferSize
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|totalLength
operator|=
name|swConfig
operator|->
name|TraceBufferSize
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|type
operator|=
name|AGSA_CACHED_MEM
expr_stmt|;
name|memoryReqCount
operator|++
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements: agMemory[LL_FUNCTION_TRACE] singleElementLength = 0x%x totalLength = 0x%x align = 0x%x type %x\n"
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|singleElementLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|totalLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|alignment
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* END SA_ENABLE_TRACE_FUNCTIONS */
ifdef|#
directive|ifdef
name|FAST_IO_TEST
block|{
name|agsaMem_t
modifier|*
name|agMemory
init|=
name|memoryRequirement
operator|->
name|agMemory
decl_stmt|;
comment|/* memory requirement for Super IO CACHE memory */
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|singleElementLength
operator|=
sizeof|sizeof
argument_list|(
name|saFastRequest_t
argument_list|)
expr_stmt|;
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|numElements
operator|=
name|LL_FAST_IO_SIZE
expr_stmt|;
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|totalLength
operator|=
name|LL_FAST_IO_SIZE
operator|*
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|singleElementLength
expr_stmt|;
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|alignment
operator|=
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|type
operator|=
name|AGSA_CACHED_MEM
expr_stmt|;
name|memoryReqCount
operator|++
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements: agMemory[LL_FAST_IO] singleElementLength = 0x%x totalLength = 0x%x align = 0x%x type %x\n"
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|singleElementLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|totalLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|alignment
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SA_ENABLE_HDA_FUNCTIONS
block|{
name|agsaMem_t
modifier|*
name|agMemory
init|=
name|memoryRequirement
operator|->
name|agMemory
decl_stmt|;
comment|/* memory requirement for HDA FW image */
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|singleElementLength
operator|=
operator|(
literal|1024
operator|*
literal|1024
operator|)
expr_stmt|;
comment|/* must be greater than size of aap1 fw image */
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|numElements
operator|=
literal|1
expr_stmt|;
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|totalLength
operator|=
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|numElements
operator|*
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|singleElementLength
expr_stmt|;
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|alignment
operator|=
literal|32
expr_stmt|;
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|type
operator|=
name|AGSA_DMA_MEM
expr_stmt|;
name|memoryReqCount
operator|++
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements: agMemory[HDA_DMA_BUFFER] singleElementLength = 0x%x totalLength = 0x%x align = 0x%x type %x\n"
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|singleElementLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|totalLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|alignment
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|HDA_DMA_BUFFER
index|]
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SA_ENABLE_HDA_FUNCTIONS */
comment|/* memory requirement for MPI MSGU layer, DMA memory */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mpiMemoryRequirement
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|memoryRequirement
operator|->
name|agMemory
index|[
name|memoryReqCount
index|]
operator|.
name|singleElementLength
operator|=
name|mpiMemoryRequirement
operator|.
name|region
index|[
name|i
index|]
operator|.
name|elementSize
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|memoryReqCount
index|]
operator|.
name|numElements
operator|=
name|mpiMemoryRequirement
operator|.
name|region
index|[
name|i
index|]
operator|.
name|numElements
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|memoryReqCount
index|]
operator|.
name|totalLength
operator|=
name|mpiMemoryRequirement
operator|.
name|region
index|[
name|i
index|]
operator|.
name|totalLength
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|memoryReqCount
index|]
operator|.
name|alignment
operator|=
name|mpiMemoryRequirement
operator|.
name|region
index|[
name|i
index|]
operator|.
name|alignment
expr_stmt|;
name|memoryRequirement
operator|->
name|agMemory
index|[
name|memoryReqCount
index|]
operator|.
name|type
operator|=
name|mpiMemoryRequirement
operator|.
name|region
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements:MPI agMemory[%d] singleElementLength = 0x%x  totalLength = 0x%x align = 0x%x type %x\n"
operator|,
name|memoryReqCount
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|memoryReqCount
index|]
operator|.
name|singleElementLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|memoryReqCount
index|]
operator|.
name|totalLength
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|memoryReqCount
index|]
operator|.
name|alignment
operator|,
name|memoryRequirement
operator|->
name|agMemory
index|[
name|memoryReqCount
index|]
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
name|memoryReqCount
operator|++
expr_stmt|;
block|}
comment|/* requirement for locks */
if|if
condition|(
name|swConfig
operator|->
name|param3
operator|==
name|agNULL
condition|)
block|{
operator|*
name|maxNumLocks
operator|=
operator|(
name|LL_IOREQ_IBQ_LOCK
operator|+
name|AGSA_MAX_INBOUND_Q
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements: param3 == agNULL maxNumLocks   %d\n"
operator|,
operator|*
name|maxNumLocks
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|agsaQueueConfig_t
modifier|*
name|queueConfig
decl_stmt|;
name|queueConfig
operator|=
operator|(
name|agsaQueueConfig_t
operator|*
operator|)
name|swConfig
operator|->
name|param3
expr_stmt|;
operator|*
name|maxNumLocks
operator|=
operator|(
name|LL_IOREQ_IBQ_LOCK_PARM
operator|+
name|queueConfig
operator|->
name|numInboundQueues
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements: maxNumLocks   %d\n"
operator|,
operator|*
name|maxNumLocks
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* setup the time tick */
operator|*
name|usecsPerTick
operator|=
name|SA_USECS_PER_TICK
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|memoryReqCount
operator|<
name|AGSA_NUM_MEM_CHUNKS
argument_list|,
literal|"saGetRequirements: Exceed max number of memory place holder"
argument_list|)
expr_stmt|;
comment|/* set up memory requirement count */
name|memoryRequirement
operator|->
name|count
operator|=
name|memoryReqCount
expr_stmt|;
name|swConfig
operator|->
name|legacyInt_X
operator|=
literal|1
expr_stmt|;
name|swConfig
operator|->
name|max_MSI_InterruptVectors
operator|=
literal|32
expr_stmt|;
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
operator|=
literal|64
expr_stmt|;
comment|//16;
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements:  swConfig->stallUsec  %d\n"
operator|,
name|swConfig
operator|->
name|stallUsec
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_CONFIG_MDFD_REGISTRY
name|SA_DBG1
argument_list|(
operator|(
literal|"saGetRequirements:  swConfig->disableMDF %d\n"
operator|,
name|swConfig
operator|->
name|disableMDF
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*SA_CONFIG_MDFD_REGISTRY*/
comment|/*SA_DBG1(("saGetRequirements:  swConfig->enableDIF  %d\n",swConfig->enableDIF  ));*/
comment|/*SA_DBG1(("saGetRequirements:  swConfig->enableEncryption  %d\n",swConfig->enableEncryption  ));*/
ifdef|#
directive|ifdef
name|SA_ENABLE_HDA_FUNCTIONS
name|swConfig
operator|->
name|hostDirectAccessSupport
operator|=
literal|1
expr_stmt|;
name|swConfig
operator|->
name|hostDirectAccessMode
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|swConfig
operator|->
name|hostDirectAccessSupport
operator|=
literal|0
expr_stmt|;
name|swConfig
operator|->
name|hostDirectAccessMode
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Initialize the Hardware  *  *  Initialize the Hardware  *  *  \param agRoot             Handles for this instance of SAS/SATA hardware  *  \param memoryAllocated    Point to the data structure that holds the different                                         chunks of memory that are required  *  \param hwConfig           Pointer to the hardware configuration  *  \param swConfig           Pointer to the software configuration  *  \param usecsPerTick       micro-seconds per tick for the LL layer  *  *  \return If initialization is successful  *          - \e AGSA_RC_SUCCESS initialization is successful  *          - \e AGSA_RC_FAILURE initialization is not successful  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|saInitialize
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaMemoryRequirement_t
modifier|*
name|memoryAllocated
parameter_list|,
name|agsaHwConfig_t
modifier|*
name|hwConfig
parameter_list|,
name|agsaSwConfig_t
modifier|*
name|swConfig
parameter_list|,
name|bit32
name|usecsPerTick
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDeviceDesc
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequestDesc
decl_stmt|;
name|agsaTimerDesc_t
modifier|*
name|pTimerDesc
decl_stmt|;
name|agsaPort_t
modifier|*
name|pPort
decl_stmt|;
name|agsaPortMap_t
modifier|*
name|pPortMap
decl_stmt|;
name|agsaDeviceMap_t
modifier|*
name|pDeviceMap
decl_stmt|;
name|agsaIOMap_t
modifier|*
name|pIOMap
decl_stmt|;
name|bit32
name|maxNumIODevices
decl_stmt|;
name|bit32
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|static
name|mpiMemReq_t
name|mpiMemoryAllocated
decl_stmt|;
name|bit32
name|Tried_NO_HDA
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|Double_Reset_HDA
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
ifdef|#
directive|ifdef
name|FAST_IO_TEST
name|void
modifier|*
name|fr
decl_stmt|;
comment|/* saFastRequest_t */
name|bit32
name|size
decl_stmt|;
name|bit32
name|alignment
decl_stmt|;
endif|#
directive|endif
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|memoryAllocated
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|hwConfig
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|swConfig
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|LLROOT_MEM_INDEX
operator|<
name|memoryAllocated
operator|->
name|count
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|DEVICELINK_MEM_INDEX
operator|<
name|memoryAllocated
operator|->
name|count
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|IOREQLINK_MEM_INDEX
operator|<
name|memoryAllocated
operator|->
name|count
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|TIMERLINK_MEM_INDEX
operator|<
name|memoryAllocated
operator|->
name|count
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|mpiMemoryAllocated
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mpiMemReq_t
argument_list|)
argument_list|)
expr_stmt|;
name|si_macro_check
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: WAIT_INCREMENT %d\n"
operator|,
name|WAIT_INCREMENT
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: usecsPerTick %d\n"
operator|,
name|usecsPerTick
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: ossaHwRegReadConfig32 ID  reads as %08X\n"
operator|,
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: expect %08X or %08X or\n"
operator|,
name|VEN_DEV_SPCV
operator|,
name|VEN_DEV_SPCVE
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: expect %08X or %08X or\n"
operator|,
name|VEN_DEV_SPCVP
operator|,
name|VEN_DEV_SPCVEP
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: expect %08X or %08X\n"
operator|,
name|VEN_DEV_ADAPVEP
operator|,
name|VEN_DEV_ADAPVP
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
operator|&&
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Macro error !smIS_SPC %d smIS_SPCv %d smIS_SFC %d\n"
operator|,
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
operator|,
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
operator|,
name|smIS_SFC
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* Check the memory allocated */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|memoryAllocated
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
comment|/* If memory allocation failed  */
if|if
condition|(
name|memoryAllocated
operator|->
name|agMemory
index|[
name|i
index|]
operator|.
name|singleElementLength
operator|&&
name|memoryAllocated
operator|->
name|agMemory
index|[
name|i
index|]
operator|.
name|numElements
condition|)
block|{
if|if
condition|(
operator|(
literal|0
operator|!=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|i
index|]
operator|.
name|numElements
operator|)
operator|&&
operator|(
literal|0
operator|==
name|memoryAllocated
operator|->
name|agMemory
index|[
name|i
index|]
operator|.
name|totalLength
operator|)
condition|)
block|{
comment|/* return failure */
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE Memory[%d]  singleElementLength = 0x%x  numElements = 0x%x NOT allocated\n"
operator|,
name|i
operator|,
name|memoryAllocated
operator|->
name|agMemory
index|[
name|i
index|]
operator|.
name|singleElementLength
operator|,
name|memoryAllocated
operator|->
name|agMemory
index|[
name|i
index|]
operator|.
name|numElements
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
return|return
name|ret
return|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Memory[%d] singleElementLength = 0x%x  numElements = 0x%x allocated %p\n"
operator|,
name|i
operator|,
name|memoryAllocated
operator|->
name|agMemory
index|[
name|i
index|]
operator|.
name|singleElementLength
operator|,
name|memoryAllocated
operator|->
name|agMemory
index|[
name|i
index|]
operator|.
name|numElements
operator|,
name|memoryAllocated
operator|->
name|agMemory
index|[
name|i
index|]
operator|.
name|virtPtr
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Get the saRoot memory address */
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|memoryAllocated
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|virtPtr
operator|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|saRoot
operator|)
argument_list|,
literal|"saRoot"
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|saRoot
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE saRoot\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agRoot
operator|->
name|sdkData
operator|=
operator|(
name|void
operator|*
operator|)
name|saRoot
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: saRoot %p\n"
operator|,
name|saRoot
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|memoryAllocated
operator|!=
operator|&
name|saRoot
operator|->
name|memoryAllocated
operator|)
operator|||
operator|(
name|hwConfig
operator|!=
operator|&
name|saRoot
operator|->
name|hwConfig
operator|)
operator|||
operator|(
name|swConfig
operator|!=
operator|&
name|saRoot
operator|->
name|swConfig
operator|)
condition|)
block|{
name|agsaMemoryRequirement_t
modifier|*
name|memA
init|=
operator|&
name|saRoot
operator|->
name|memoryAllocated
decl_stmt|;
name|agsaHwConfig_t
modifier|*
name|hwC
init|=
operator|&
name|saRoot
operator|->
name|hwConfig
decl_stmt|;
name|agsaSwConfig_t
modifier|*
name|swC
init|=
operator|&
name|saRoot
operator|->
name|swConfig
decl_stmt|;
comment|/* Copy data here */
operator|*
name|memA
operator|=
operator|*
name|memoryAllocated
expr_stmt|;
operator|*
name|hwC
operator|=
operator|*
name|hwConfig
expr_stmt|;
operator|*
name|swC
operator|=
operator|*
name|swConfig
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
if|if
condition|(
name|gLLDebugLevelSet
operator|==
literal|0
condition|)
block|{
name|gLLDebugLevelSet
operator|=
literal|1
expr_stmt|;
name|gLLDebugLevel
operator|=
name|swConfig
operator|->
name|sallDebugLevel
operator|&
literal|0xF
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  gLLDebugLevel  %x\n"
operator|,
name|gLLDebugLevel
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
name|saRoot
operator|->
name|TraceBufferLength
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|totalLength
expr_stmt|;
name|saRoot
operator|->
name|TraceBuffer
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|LL_FUNCTION_TRACE
index|]
operator|.
name|virtPtr
expr_stmt|;
name|siEnableTracing
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
comment|/* */
endif|#
directive|endif
comment|/* SA_ENABLE_TRACE_FUNCTIONS */
ifdef|#
directive|ifdef
name|FAST_IO_TEST
block|{
name|agsaMem_t
modifier|*
name|agMemory
init|=
name|memoryAllocated
operator|->
name|agMemory
decl_stmt|;
comment|/* memory requirement for Super IO CACHE memory */
name|size
operator|=
sizeof|sizeof
argument_list|(
name|saRoot
operator|->
name|freeFastReq
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|saRoot
operator|->
name|freeFastReq
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|size
operator|==
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|numElements
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|virtPtr
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|singleElementLength
operator|==
sizeof|sizeof
argument_list|(
name|saFastRequest_t
argument_list|)
operator|)
operator|&&
operator|(
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|numElements
operator|==
name|LL_FAST_IO_SIZE
operator|)
operator|&&
operator|(
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|totalLength
operator|==
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|numElements
operator|*
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|singleElementLength
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|alignment
operator|=
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|alignment
operator|,
name|fr
operator|=
name|agMemory
index|[
name|LL_FAST_IO
index|]
operator|.
name|virtPtr
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
operator|,
name|fr
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|bitptr
operator|)
name|fr
operator|+
call|(
name|bitptr
call|)
argument_list|(
operator|(
operator|(
name|bit32
operator|)
sizeof|sizeof
argument_list|(
name|saFastRequest_t
argument_list|)
operator|+
name|alignment
operator|-
literal|1
operator|)
operator|&
operator|~
operator|(
name|alignment
operator|-
literal|1
operator|)
argument_list|)
operator|)
control|)
block|{
name|saRoot
operator|->
name|freeFastReq
index|[
name|i
index|]
operator|=
name|fr
expr_stmt|;
block|}
name|saRoot
operator|->
name|freeFastIdx
operator|=
name|size
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FAST_IO_TEST*/
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->PortRecoveryResetTimer    %x\n"
operator|,
name|swConfig
operator|->
name|PortRecoveryResetTimer
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: hwDEVICE_ID_VENDID            0x%08x\n"
operator|,
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: CFGSTAT CFGCMD                0x%08x\n"
operator|,
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: CLSCODE REVID                 0x%08x\n"
operator|,
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|8
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: BIST DT HDRTYPE LATTIM CLSIZE 0x%08x\n"
operator|,
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|12
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: hwSVID                        0x%08x\n"
operator|,
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|44
argument_list|)
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_ENABLE_PCI_TRIGGER
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SA_ENABLE_PCI_TRIGGER  a       0x%08x %p\n"
operator|,
name|saRoot
operator|->
name|swConfig
operator|.
name|PCI_trigger
operator|,
operator|&
name|saRoot
operator|->
name|swConfig
operator|.
name|PCI_trigger
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|->
name|swConfig
operator|.
name|PCI_trigger
operator|&
name|PCI_TRIGGER_INIT_TEST
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SA_ENABLE_PCI_TRIGGER         0x%08x %p\n"
operator|,
name|saRoot
operator|->
name|swConfig
operator|.
name|PCI_trigger
operator|,
operator|&
name|saRoot
operator|->
name|swConfig
operator|.
name|PCI_trigger
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|swConfig
operator|.
name|PCI_trigger
operator|&=
operator|~
name|PCI_TRIGGER_INIT_TEST
expr_stmt|;
name|siPCITriger
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SA_ENABLE_PCI_TRIGGER */
name|saRoot
operator|->
name|ChipId
operator|=
operator|(
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|)
operator|&
literal|0xFFFF0000
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: saRoot->ChipId                0x%08x\n"
operator|,
name|saRoot
operator|->
name|ChipId
operator|)
argument_list|)
expr_stmt|;
name|siUpdateBarOffsetTable
argument_list|(
name|agRoot
argument_list|,
name|saRoot
operator|->
name|ChipId
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPC
condition|)
block|{
if|if
condition|(
operator|!
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPC macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC \n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_HIL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC HIL\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPC macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPCV
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC V\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPCVE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC VE\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPCVP
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC VP\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPCVEP
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC VEP\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_ADAPVP
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Adaptec 8088\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_ADAPVEP
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Adaptec 8089\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPC12V
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC 12V\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'g'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPC12VE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC 12VE\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'h'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPC12VP
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC 12VP\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'i'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPC12VEP
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC 12VEP\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'j'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPC12ADP
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC 12ADP\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'k'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPC12ADPE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC 12ADPE\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'l'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPC12ADPP
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC 12ADPP\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'m'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPC12ADPEP
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC 12ADPEP\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'n'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SPC12SATA
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC12SATA\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'o'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_9015
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC 12V FPGA\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'p'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_9060
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC 12V FPGA B\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: smIS_SPCV macro fail !!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'q'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|saRoot
operator|->
name|ChipId
operator|==
name|VEN_DEV_SFC
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SFC \n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize saRoot->ChipId %8X expect %8X or %8X\n"
operator|,
name|saRoot
operator|->
name|ChipId
operator|,
name|VEN_DEV_SPC
operator|,
name|VEN_DEV_SPCV
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
literal|0
argument_list|,
literal|"ChipId"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'r'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Rev is A %d B %d C %d\n"
operator|,
name|smIsCfgSpcREV_A
argument_list|(
name|agRoot
argument_list|)
operator|,
name|smIsCfgSpcREV_B
argument_list|(
name|agRoot
argument_list|)
operator|,
name|smIsCfgSpcREV_C
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Rev is A %d B %d C %d\n"
operator|,
name|smIsCfgVREV_A
argument_list|(
name|agRoot
argument_list|)
operator|,
name|smIsCfgVREV_B
argument_list|(
name|agRoot
argument_list|)
operator|,
name|smIsCfgVREV_C
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: LINK_CTRL 0x%08x Speed 0x%X Lanes 0x%X \n"
operator|,
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|128
argument_list|)
operator|,
operator|(
operator|(
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|128
argument_list|)
operator|&
literal|0x000F0000
operator|)
operator|>>
literal|16
operator|)
operator|,
operator|(
operator|(
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|128
argument_list|)
operator|&
literal|0x0FF00000
operator|)
operator|>>
literal|20
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: LINK_CTRL 0x%08x Speed 0x%X Lanes 0x%X \n"
operator|,
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|208
argument_list|)
operator|,
operator|(
operator|(
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|208
argument_list|)
operator|&
literal|0x000F0000
operator|)
operator|>>
literal|16
operator|)
operator|,
operator|(
operator|(
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|208
argument_list|)
operator|&
literal|0x0FF00000
operator|)
operator|>>
literal|20
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: V_SoftResetRegister  %08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_SoftResetRegister
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/*   SA_DBG1(("saInitialize:TOP_BOOT_STRAP STRAP_BIT %X\n",  ossaHwRegReadExt(agRoot, PCIBAR1, 0) ));    SA_DBG1(("SPC_REG_TOP_DEVICE_ID  %8X expect %08X\n",  ossaHwRegReadExt(agRoot, PCIBAR2, SPC_REG_TOP_DEVICE_ID), SPC_TOP_DEVICE_ID));   SA_DBG1(("SPC_REG_TOP_DEVICE_ID  %8X expect %08X\n",  siHalRegReadExt( agRoot, GEN_SPC_REG_TOP_DEVICE_ID,SPC_REG_TOP_DEVICE_ID ) , SPC_TOP_DEVICE_ID));    SA_DBG1(("SPC_REG_TOP_BOOT_STRAP %8X expect %08X\n",  ossaHwRegReadExt(agRoot, PCIBAR2, SPC_REG_TOP_BOOT_STRAP), SPC_TOP_BOOT_STRAP));    SA_DBG1(("swConfig->numSASDevHandles =%d\n", swConfig->numDevHandles)); */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"29"
argument_list|,
name|swConfig
operator|->
name|numDevHandles
argument_list|)
expr_stmt|;
comment|/* TP:29 swConfig->numDevHandles */
comment|/* Setup Device link */
comment|/* Save the information of allocated device Link memory */
name|saRoot
operator|->
name|deviceLinkMem
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|virtPtr
condition|)
block|{
name|SA_ASSERT
argument_list|(
literal|0
argument_list|,
literal|"deviceLinkMem"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'q'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|si_memset
argument_list|(
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"saInitialize: [%d] saRoot->deviceLinkMem VirtPtr=%p PhysicalLo=%x Count=%x Total=%x type %x\n"
operator|,
name|DEVICELINK_MEM_INDEX
operator|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|virtPtr
operator|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|phyAddrLower
operator|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|numElements
operator|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|totalLength
operator|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
name|maxNumIODevices
operator|=
name|swConfig
operator|->
name|numDevHandles
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"saInitialize:  maxNumIODevices=%d, swConfig->numDevHandles=%d \n"
operator|,
name|maxNumIODevices
operator|,
name|swConfig
operator|->
name|numDevHandles
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_ENABLE_PCI_TRIGGER
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  swConfig->PCI_trigger= 0x%x\n"
operator|,
name|swConfig
operator|->
name|PCI_trigger
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_ENABLE_PCI_TRIGGER */
comment|/* Setup free IO Devices link list */
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeDevicesList
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|bit32
operator|)
name|maxNumIODevices
condition|;
name|i
operator|++
control|)
block|{
comment|/* get the pointer to the device descriptor */
name|pDeviceDesc
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|AGSAMEM_ELEMENT_READ
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|deviceLinkMem
operator|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* Initialize device descriptor */
name|saLlinkInitialize
argument_list|(
operator|&
operator|(
name|pDeviceDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pDeviceDesc
operator|->
name|initiatorDevHandle
operator|.
name|osData
operator|=
name|agNULL
expr_stmt|;
name|pDeviceDesc
operator|->
name|initiatorDevHandle
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|pDeviceDesc
operator|->
name|targetDevHandle
operator|.
name|osData
operator|=
name|agNULL
expr_stmt|;
name|pDeviceDesc
operator|->
name|targetDevHandle
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|pDeviceDesc
operator|->
name|deviceType
operator|=
name|SAS_SATA_UNKNOWN_DEVICE
expr_stmt|;
name|pDeviceDesc
operator|->
name|pPort
operator|=
name|agNULL
expr_stmt|;
name|pDeviceDesc
operator|->
name|DeviceMapIndex
operator|=
literal|0
expr_stmt|;
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|pDeviceDesc
operator|->
name|pendingIORequests
operator|)
argument_list|)
expr_stmt|;
comment|/* Add the device descriptor to the free IO device link list */
name|saLlistAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeDevicesList
operator|)
argument_list|,
operator|&
operator|(
name|pDeviceDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Setup IO Request link */
comment|/* Save the information of allocated IO Request Link memory */
name|saRoot
operator|->
name|IORequestMem
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
expr_stmt|;
name|si_memset
argument_list|(
name|saRoot
operator|->
name|IORequestMem
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"saInitialize: [%d] saRoot->IORequestMem  VirtPtr=%p PhysicalLo=%x Count=%x Total=%x type %x\n"
operator|,
name|IOREQLINK_MEM_INDEX
operator|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|virtPtr
operator|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|phyAddrLower
operator|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|numElements
operator|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|totalLength
operator|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup free IO  Request link list */
name|saLlistIOInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|swConfig
operator|->
name|maxActiveIOs
condition|;
name|i
operator|++
control|)
block|{
comment|/* get the pointer to the request descriptor */
name|pRequestDesc
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|AGSAMEM_ELEMENT_READ
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|IORequestMem
operator|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* Initialize request descriptor */
name|saLlinkInitialize
argument_list|(
operator|&
operator|(
name|pRequestDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pRequestDesc
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|pRequestDesc
operator|->
name|requestType
operator|=
name|AGSA_REQ_TYPE_UNKNOWN
expr_stmt|;
name|pRequestDesc
operator|->
name|pIORequestContext
operator|=
name|agNULL
expr_stmt|;
name|pRequestDesc
operator|->
name|HTag
operator|=
name|i
expr_stmt|;
name|pRequestDesc
operator|->
name|pDevice
operator|=
name|agNULL
expr_stmt|;
name|pRequestDesc
operator|->
name|pPort
operator|=
name|agNULL
expr_stmt|;
comment|/* Add the request descriptor to the free Reserved Request link list */
comment|/* SMP request must get service so reserve one request when first SMP completes */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequestDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Add the request descriptor to the free IO Request link list */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequestDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Setup timer link */
comment|/* Save the information of allocated timer Link memory */
name|saRoot
operator|->
name|timerLinkMem
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
expr_stmt|;
name|si_memset
argument_list|(
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"saInitialize: [%d] saRoot->timerLinkMem  VirtPtr=%p PhysicalLo=%x Count=%x Total=%x type %x\n"
operator|,
name|TIMERLINK_MEM_INDEX
operator|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|virtPtr
operator|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|phyAddrLower
operator|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|numElements
operator|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|totalLength
operator|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup free timer link list */
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeTimers
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_TIMERS
condition|;
name|i
operator|++
control|)
block|{
comment|/* get the pointer to the timer descriptor */
name|pTimerDesc
operator|=
operator|(
name|agsaTimerDesc_t
operator|*
operator|)
name|AGSAMEM_ELEMENT_READ
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|timerLinkMem
operator|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* Initialize timer descriptor */
name|saLlinkInitialize
argument_list|(
operator|&
operator|(
name|pTimerDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pTimerDesc
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|pTimerDesc
operator|->
name|timeoutTick
operator|=
literal|0
expr_stmt|;
name|pTimerDesc
operator|->
name|pfnTimeout
operator|=
name|agNULL
expr_stmt|;
name|pTimerDesc
operator|->
name|Event
operator|=
literal|0
expr_stmt|;
name|pTimerDesc
operator|->
name|pParm
operator|=
name|agNULL
expr_stmt|;
comment|/* Add the timer descriptor to the free timer link list */
name|saLlistAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeTimers
operator|)
argument_list|,
operator|&
operator|(
name|pTimerDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Setup valid timer link list */
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|validTimers
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup Phys */
comment|/* Setup PhyCount */
name|saRoot
operator|->
name|phyCount
operator|=
operator|(
name|bit8
operator|)
name|hwConfig
operator|->
name|phyCount
expr_stmt|;
comment|/* Init Phy data structure */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|phyCount
condition|;
name|i
operator|++
control|)
block|{
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|.
name|pPort
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|.
name|phyId
operator|=
operator|(
name|bit8
operator|)
name|i
expr_stmt|;
comment|/* setup phy status is PHY_STOPPED */
name|PHY_STATUS_SET
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|)
argument_list|,
name|PHY_STOPPED
argument_list|)
expr_stmt|;
block|}
comment|/* Setup Ports */
comment|/* Setup PortCount */
name|saRoot
operator|->
name|portCount
operator|=
name|saRoot
operator|->
name|phyCount
expr_stmt|;
comment|/* Setup free port link list */
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freePorts
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|portCount
condition|;
name|i
operator|++
control|)
block|{
comment|/* get the pointer to the port */
name|pPort
operator|=
operator|&
operator|(
name|saRoot
operator|->
name|ports
index|[
name|i
index|]
operator|)
expr_stmt|;
comment|/* Initialize port */
name|saLlinkInitialize
argument_list|(
operator|&
operator|(
name|pPort
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pPort
operator|->
name|portContext
operator|.
name|osData
operator|=
name|agNULL
expr_stmt|;
name|pPort
operator|->
name|portContext
operator|.
name|sdkData
operator|=
name|pPort
expr_stmt|;
name|pPort
operator|->
name|portId
operator|=
literal|0
expr_stmt|;
name|pPort
operator|->
name|portIdx
operator|=
operator|(
name|bit8
operator|)
name|i
expr_stmt|;
name|pPort
operator|->
name|status
operator|=
name|PORT_NORMAL
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|saRoot
operator|->
name|phyCount
condition|;
name|j
operator|++
control|)
block|{
name|pPort
operator|->
name|phyMap
index|[
name|j
index|]
operator|=
name|agFALSE
expr_stmt|;
block|}
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|pPort
operator|->
name|listSASATADevices
operator|)
argument_list|)
expr_stmt|;
comment|/* Add the port to the free port link list */
name|saLlistAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freePorts
operator|)
argument_list|,
operator|&
operator|(
name|pPort
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Setup valid port link list */
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|validPorts
operator|)
argument_list|)
expr_stmt|;
comment|/* Init sysIntsActive - default is interrupt enable */
name|saRoot
operator|->
name|sysIntsActive
operator|=
name|agFALSE
expr_stmt|;
comment|/* setup timer tick granunarity */
name|saRoot
operator|->
name|usecsPerTick
operator|=
name|usecsPerTick
expr_stmt|;
comment|/* setup smallest timer increment for stall */
name|saRoot
operator|->
name|minStallusecs
operator|=
name|swConfig
operator|->
name|stallUsec
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: WAIT_INCREMENT %d\n"
operator|,
name|WAIT_INCREMENT
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|==
name|WAIT_INCREMENT
condition|)
block|{
name|saRoot
operator|->
name|minStallusecs
operator|=
name|WAIT_INCREMENT_DEFAULT
expr_stmt|;
block|}
comment|/* initialize LL timer tick */
name|saRoot
operator|->
name|timeTick
operator|=
literal|0
expr_stmt|;
comment|/* initialize device (de)registration callback fns */
name|saRoot
operator|->
name|DeviceRegistrationCB
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|DeviceDeregistrationCB
operator|=
name|agNULL
expr_stmt|;
comment|/* Initialize the PortMap for port context */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|portCount
condition|;
name|i
operator|++
control|)
block|{
name|pPortMap
operator|=
operator|&
operator|(
name|saRoot
operator|->
name|PortMap
index|[
name|i
index|]
operator|)
expr_stmt|;
name|pPortMap
operator|->
name|PortContext
operator|=
name|agNULL
expr_stmt|;
name|pPortMap
operator|->
name|PortID
operator|=
name|PORT_MARK_OFF
expr_stmt|;
name|pPortMap
operator|->
name|PortStatus
operator|=
name|PORT_NORMAL
expr_stmt|;
name|saRoot
operator|->
name|autoDeregDeviceflag
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Initialize the DeviceMap for device handle */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_IO_DEVICE_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|pDeviceMap
operator|=
operator|&
operator|(
name|saRoot
operator|->
name|DeviceMap
index|[
name|i
index|]
operator|)
expr_stmt|;
name|pDeviceMap
operator|->
name|DeviceHandle
operator|=
name|agNULL
expr_stmt|;
name|pDeviceMap
operator|->
name|DeviceIdFromFW
operator|=
name|i
expr_stmt|;
block|}
comment|/* Initialize the IOMap for IOrequest */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_ACTIVE_IO_REQUESTS
condition|;
name|i
operator|++
control|)
block|{
name|pIOMap
operator|=
operator|&
operator|(
name|saRoot
operator|->
name|IOMap
index|[
name|i
index|]
operator|)
expr_stmt|;
name|pIOMap
operator|->
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|pIOMap
operator|->
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
block|}
comment|/* setup mpi configuration */
if|if
condition|(
operator|!
name|swConfig
operator|->
name|param3
condition|)
block|{
comment|/* default configuration */
name|siConfiguration
argument_list|(
name|agRoot
argument_list|,
operator|&
name|saRoot
operator|->
name|mpiConfig
argument_list|,
name|hwConfig
argument_list|,
name|swConfig
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* get from TD layer and save it */
name|agsaQueueConfig_t
modifier|*
name|dCFG
init|=
operator|&
name|saRoot
operator|->
name|QueueConfig
decl_stmt|;
name|agsaQueueConfig_t
modifier|*
name|sCFG
init|=
operator|(
name|agsaQueueConfig_t
operator|*
operator|)
name|swConfig
operator|->
name|param3
decl_stmt|;
if|if
condition|(
name|dCFG
operator|!=
name|sCFG
condition|)
block|{
operator|*
name|dCFG
operator|=
operator|*
name|sCFG
expr_stmt|;
if|if
condition|(
operator|(
name|hwConfig
operator|->
name|hwInterruptCoalescingTimer
operator|)
operator|||
operator|(
name|hwConfig
operator|->
name|hwInterruptCoalescingControl
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sCFG
operator|->
name|numOutboundQueues
condition|;
name|i
operator|++
control|)
block|{
comment|/* disable FW assisted coalescing */
name|sCFG
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptDelay
operator|=
literal|0
expr_stmt|;
name|sCFG
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptCount
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|hwConfig
operator|->
name|hwInterruptCoalescingTimer
operator|==
literal|0
condition|)
block|{
name|hwConfig
operator|->
name|hwInterruptCoalescingTimer
operator|=
literal|1
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:InterruptCoalescingTimer should not be zero. Force to 1\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ret
operator|=
name|siConfiguration
argument_list|(
name|agRoot
argument_list|,
operator|&
name|saRoot
operator|->
name|mpiConfig
argument_list|,
name|hwConfig
argument_list|,
name|swConfig
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|ret
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize failure queue number=%d\n"
operator|,
name|saRoot
operator|->
name|QueueConfig
operator|.
name|numInboundQueues
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'r'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
block|}
name|saRoot
operator|->
name|swConfig
operator|.
name|param3
operator|=
operator|&
name|saRoot
operator|->
name|QueueConfig
expr_stmt|;
name|mpiMemoryAllocated
operator|.
name|count
operator|=
name|memoryAllocated
operator|->
name|count
operator|-
name|MPI_MEM_INDEX
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mpiMemoryAllocated
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|virtPtr
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|virtPtr
expr_stmt|;
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|appHandle
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|osHandle
expr_stmt|;
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|physAddrUpper
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|phyAddrUpper
expr_stmt|;
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|physAddrLower
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|phyAddrLower
expr_stmt|;
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|totalLength
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|totalLength
expr_stmt|;
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|numElements
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|numElements
expr_stmt|;
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|elementSize
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|singleElementLength
expr_stmt|;
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|alignment
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|alignment
expr_stmt|;
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|type
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|type
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"saInitialize: memoryAllocated->agMemory[%d] VirtPtr=%p PhysicalLo=%x Count=%x Total=%x type %x\n"
operator|,
operator|(
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
operator|)
operator|,
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|virtPtr
operator|,
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|phyAddrLower
operator|,
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|numElements
operator|,
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|totalLength
operator|,
name|memoryAllocated
operator|->
name|agMemory
index|[
name|MPI_IBQ_OBQ_INDEX
operator|+
name|i
index|]
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
comment|/* set to zeros */
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Zero memory region %d virt %p allocated %d\n"
operator|,
name|i
operator|,
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|virtPtr
operator|,
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|totalLength
operator|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|mpiMemoryAllocated
operator|.
name|region
index|[
name|i
index|]
operator|.
name|totalLength
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|!
name|swConfig
operator|->
name|max_MSI_InterruptVectors
operator|)
operator|&&
operator|(
operator|!
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
operator|)
operator|&&
operator|(
operator|!
name|swConfig
operator|->
name|legacyInt_X
operator|)
condition|)
block|{
comment|/* polling mode */
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: configured as polling mode\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->max_MSI_InterruptVectors %d\n"
operator|,
name|swConfig
operator|->
name|max_MSI_InterruptVectors
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->max_MSIX_InterruptVectors %d\n"
operator|,
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|swConfig
operator|->
name|legacyInt_X
operator|>
literal|1
operator|)
operator|||
operator|(
name|swConfig
operator|->
name|max_MSI_InterruptVectors
operator|>
literal|32
operator|)
operator|||
operator|(
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
operator|>
literal|64
operator|)
condition|)
block|{
comment|/* error */
name|agRoot
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE InterruptVectors A\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'s'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
operator|(
name|swConfig
operator|->
name|legacyInt_X
operator|)
operator|&&
operator|(
name|swConfig
operator|->
name|max_MSI_InterruptVectors
operator|)
condition|)
block|{
comment|/* error */
name|agRoot
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE InterruptVectors B\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'t'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|swConfig
operator|->
name|legacyInt_X
operator|)
operator|&&
operator|(
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
operator|)
condition|)
block|{
comment|/* error */
name|agRoot
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE InterruptVectors C\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'u'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|swConfig
operator|->
name|max_MSI_InterruptVectors
operator|)
operator|&&
operator|(
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
operator|)
condition|)
block|{
comment|/* error */
name|agRoot
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE InterruptVectors D\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'v'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
comment|/* This section sets common interrupt for Legacy(IRQ) and MSI and MSIX types */
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC  interrupts\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|swConfig
operator|->
name|legacyInt_X
condition|)
block|{
name|saRoot
operator|->
name|OurInterrupt
operator|=
name|siOurLegacyInterrupt
expr_stmt|;
comment|/* Called in ISR*/
name|saRoot
operator|->
name|DisableInterrupts
operator|=
name|siDisableLegacyInterrupts
expr_stmt|;
comment|/* Called in ISR*/
name|saRoot
operator|->
name|ReEnableInterrupts
operator|=
name|siReenableLegacyInterrupts
expr_stmt|;
comment|/* Called in Delayed Int handler*/
block|}
elseif|else
if|if
condition|(
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
condition|)
block|{
name|saRoot
operator|->
name|OurInterrupt
operator|=
name|siOurMSIXInterrupt
expr_stmt|;
name|saRoot
operator|->
name|DisableInterrupts
operator|=
name|siDisableMSIXInterrupts
expr_stmt|;
name|saRoot
operator|->
name|ReEnableInterrupts
operator|=
name|siReenableMSIXInterrupts
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|swConfig
operator|->
name|max_MSI_InterruptVectors
condition|)
block|{
name|saRoot
operator|->
name|OurInterrupt
operator|=
name|siOurMSIInterrupt
expr_stmt|;
name|saRoot
operator|->
name|DisableInterrupts
operator|=
name|siDisableMSIInterrupts
expr_stmt|;
name|saRoot
operator|->
name|ReEnableInterrupts
operator|=
name|siReenableMSIInterrupts
expr_stmt|;
block|}
else|else
block|{
comment|/* polling mode */
name|saRoot
operator|->
name|OurInterrupt
operator|=
name|siOurLegacyInterrupt
expr_stmt|;
comment|/* Called in ISR*/
name|saRoot
operator|->
name|DisableInterrupts
operator|=
name|siDisableLegacyInterrupts
expr_stmt|;
comment|/* Called in ISR*/
name|saRoot
operator|->
name|ReEnableInterrupts
operator|=
name|siReenableLegacyInterrupts
expr_stmt|;
comment|/* Called in Delayed Int handler*/
block|}
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC V interrupts\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|swConfig
operator|->
name|legacyInt_X
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC V legacyInt_X\n"
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|OurInterrupt
operator|=
name|siOurLegacy_V_Interrupt
expr_stmt|;
comment|/* Called in ISR*/
name|saRoot
operator|->
name|DisableInterrupts
operator|=
name|siDisableLegacy_V_Interrupts
expr_stmt|;
comment|/* Called in ISR*/
name|saRoot
operator|->
name|ReEnableInterrupts
operator|=
name|siReenableLegacy_V_Interrupts
expr_stmt|;
comment|/* Called in Delayed Int handler*/
block|}
elseif|else
if|if
condition|(
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC V max_MSIX_InterruptVectors %X\n"
operator|,
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|OurInterrupt
operator|=
name|siOurMSIX_V_Interrupt
expr_stmt|;
comment|/* */
name|saRoot
operator|->
name|DisableInterrupts
operator|=
name|siDisableMSIX_V_Interrupts
expr_stmt|;
name|saRoot
operator|->
name|ReEnableInterrupts
operator|=
name|siReenableMSIX_V_Interrupts
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|swConfig
operator|->
name|max_MSI_InterruptVectors
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC V max_MSI_InterruptVectors\n"
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|OurInterrupt
operator|=
name|siOurMSIX_V_Interrupt
expr_stmt|;
comment|/* */
name|saRoot
operator|->
name|DisableInterrupts
operator|=
name|siDisableMSIX_V_Interrupts
expr_stmt|;
name|saRoot
operator|->
name|ReEnableInterrupts
operator|=
name|siReenableMSIX_V_Interrupts
expr_stmt|;
block|}
else|else
block|{
comment|/* polling mode */
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC V polling mode\n"
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|OurInterrupt
operator|=
name|siOurLegacy_V_Interrupt
expr_stmt|;
comment|/* Called in ISR*/
name|saRoot
operator|->
name|DisableInterrupts
operator|=
name|siDisableLegacy_V_Interrupts
expr_stmt|;
comment|/* Called in ISR*/
name|saRoot
operator|->
name|ReEnableInterrupts
operator|=
name|siReenableLegacy_V_Interrupts
expr_stmt|;
comment|/* Called in Delayed Int handler*/
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  SPC V\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|saRoot
operator|->
name|Use64bit
operator|=
operator|(
name|saRoot
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
operator|>
literal|32
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|smIS64bInt
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Use 64 bits for interrupts %d %d\n"
operator|,
name|saRoot
operator|->
name|Use64bit
operator|,
name|saRoot
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Use 32 bits for interrupts %d %d\n"
operator|,
name|saRoot
operator|->
name|Use64bit
operator|,
name|saRoot
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SA_LL_IBQ_PROTECT
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Inbound locking defined since LL_IOREQ_IBQ0_LOCK %d\n"
operator|,
name|LL_IOREQ_IBQ0_LOCK
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_LL_IBQ_PROTECT */
comment|/* Disable interrupt */
name|saRoot
operator|->
name|DisableInterrupts
argument_list|(
name|agRoot
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: DisableInterrupts sysIntsActive %X\n"
operator|,
name|saRoot
operator|->
name|sysIntsActive
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_FW_TEST_BUNCH_STARTS
name|saRoot
operator|->
name|BunchStarts_Enable
operator|=
name|FALSE
expr_stmt|;
name|saRoot
operator|->
name|BunchStarts_Threshold
operator|=
literal|5
expr_stmt|;
name|saRoot
operator|->
name|BunchStarts_Pending
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|BunchStarts_TimeoutTicks
operator|=
literal|10
expr_stmt|;
comment|// N x 100 ms
endif|#
directive|endif
comment|/* SA_FW_TEST_BUNCH_STARTS */
comment|/* clear the interrupt vector bitmap */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_NUM_VECTOR
condition|;
name|i
operator|++
control|)
block|{
name|saRoot
operator|->
name|interruptVecIndexBitMap
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|interruptVecIndexBitMap1
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2Y"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TP:2Y SCRATCH_PAD */
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|bit32
name|ScratchPad1
init|=
literal|0
decl_stmt|;
name|bit32
name|ScratchPad3
init|=
literal|0
decl_stmt|;
name|ScratchPad1
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
expr_stmt|;
name|ScratchPad3
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ScratchPad1
operator|&
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|==
name|SCRATCH_PAD1_V_RAAE_MASK
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_ENC_MASK
operator|)
operator|==
name|SCRATCH_PAD3_V_ENC_DIS_ERR
operator|)
operator|||
operator|(
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_ENC_MASK
operator|)
operator|==
name|SCRATCH_PAD3_V_ENC_ENA_ERR
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:Warning Encryption Issue SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|SA_ENABLE_HDA_FUNCTIONS
name|TryWithHDA_ON
label|:
name|Double_Reset_HDA
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|swConfig
operator|->
name|hostDirectAccessSupport
condition|)
block|{
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siHDAMode
argument_list|(
name|agRoot
argument_list|,
name|swConfig
operator|->
name|hostDirectAccessMode
argument_list|,
operator|(
name|agsaFwImg_t
operator|*
operator|)
name|swConfig
operator|->
name|param4
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE siHDAMode\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'w'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:1 Going to HDA mode HDA 0x%X \n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Double_Reset_HDA
operator|==
name|agFALSE
condition|)
block|{
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Double_Reset_HDA HDA 0x%X \n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|Double_Reset_HDA
operator|=
name|TRUE
expr_stmt|;
goto|goto
name|TryWithHDA_ON
goto|;
block|}
block|}
block|}
else|else
block|{
comment|/* check FW is running */
if|if
condition|(
name|BOOTTLOADERHDA_IDLE
operator|==
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|&
name|HDA_STATUS_BITS
operator|)
condition|)
block|{
comment|/* HDA mode */
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: No HDA mode enable and FW is not running.\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Tried_NO_HDA
operator|!=
name|agTRUE
condition|)
block|{
name|Tried_NO_HDA
operator|=
name|TRUE
expr_stmt|;
name|swConfig
operator|->
name|hostDirectAccessSupport
operator|=
literal|1
expr_stmt|;
name|swConfig
operator|->
name|hostDirectAccessMode
operator|=
literal|1
expr_stmt|;
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: 2 Going to HDA mode HDA %X \n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|TryWithHDA_ON
goto|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: could not start HDA mode HDA %X \n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'x'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'y'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
else|#
directive|else
comment|/* SA_ENABLE_HDA_FUNCTIONS */
comment|/* check FW is running */
if|if
condition|(
name|BOOTTLOADERHDA_IDLE
operator|==
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|&
name|HDA_STATUS_BITS
operator|)
condition|)
block|{
comment|/* HDA mode */
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: No HDA mode enable and FW is not running.\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'z'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
endif|#
directive|endif
comment|/* SA_ENABLE_HDA_FUNCTIONS */
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SPCv swConfig->hostDirectAccessMode %d swConfig->hostDirectAccessSupport %d\n"
operator|,
name|swConfig
operator|->
name|hostDirectAccessMode
operator|,
name|swConfig
operator|->
name|hostDirectAccessSupport
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|swConfig
operator|->
name|hostDirectAccessSupport
condition|)
block|{
name|bit32
name|hda_status
decl_stmt|;
name|bit32
name|soft_reset_status
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SPCv load HDA\n"
operator|)
argument_list|)
expr_stmt|;
name|hda_status
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: hda_status 0x%x\n"
operator|,
name|hda_status
operator|)
argument_list|)
expr_stmt|;
name|siScratchDump
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|swConfig
operator|->
name|hostDirectAccessMode
operator|==
literal|0
condition|)
block|{
name|soft_reset_status
operator|=
name|siSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
if|if
condition|(
name|soft_reset_status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|agRoot
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE soft_reset_status\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'A'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
if|if
condition|(
operator|(
name|hda_status
operator|&
name|SPC_V_HDAR_RSPCODE_MASK
operator|)
operator|!=
name|SPC_V_HDAR_IDLE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: hda_status not SPC_V_HDAR_IDLE 0x%08x\n"
operator|,
name|hda_status
operator|)
argument_list|)
expr_stmt|;
name|soft_reset_status
operator|=
name|siSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
name|hda_status
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|hda_status
operator|&
name|SPC_V_HDAR_RSPCODE_MASK
operator|)
operator|!=
name|SPC_V_HDAR_IDLE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: 2 reset hda_status not SPC_V_HDAR_IDLE 0x%08x\n"
operator|,
name|hda_status
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|soft_reset_status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|agRoot
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE soft_reset_status A\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'B'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
ifdef|#
directive|ifdef
name|SA_ENABLE_HDA_FUNCTIONS
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siHDAMode_V
argument_list|(
name|agRoot
argument_list|,
name|swConfig
operator|->
name|hostDirectAccessMode
argument_list|,
operator|(
name|agsaFwImg_t
operator|*
operator|)
name|swConfig
operator|->
name|param4
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE siHDAMode_V\n"
operator|)
argument_list|)
expr_stmt|;
name|siChipResetV
argument_list|(
name|agRoot
argument_list|,
name|SPC_HDASOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
name|agRoot
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'C'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
endif|#
directive|endif
comment|/* SA_ENABLE_HDA_FUNCTIONS */
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SPCv normal\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* copy the table to the LL layer */
name|si_memcpy
argument_list|(
operator|&
name|saRoot
operator|->
name|mpiConfig
operator|.
name|phyAnalogConfig
argument_list|,
operator|&
name|hwConfig
operator|->
name|phyAnalogConfig
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaPhyAnalogSetupTable_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SALL_API_TEST
comment|/* Initialize the LL IO counter */
name|si_memset
argument_list|(
operator|&
name|saRoot
operator|->
name|LLCounters
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaIOCountInfo_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|si_memset
argument_list|(
operator|&
name|saRoot
operator|->
name|IoErrorCount
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaIOErrorEventStats_t
argument_list|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|saRoot
operator|->
name|IoEventCount
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaIOErrorEventStats_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|smIS_spc8081
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|MBIC_GSM_SM_BASE
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: siBar4Shift FAILED ******************************************\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|siSpcSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_SOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: saRoot->ChipId == VEN_DEV_SPCV\n"
operator|)
argument_list|)
expr_stmt|;
name|siChipResetV
argument_list|(
name|agRoot
argument_list|,
name|SPC_SOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
block|}
comment|/* MPI Initialization */
name|ret
operator|=
name|mpiInitialize
argument_list|(
name|agRoot
argument_list|,
operator|&
name|mpiMemoryAllocated
argument_list|,
operator|&
name|saRoot
operator|->
name|mpiConfig
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: MaxOutstandingIO 0x%x swConfig->maxActiveIOs 0x%x\n"
operator|,
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|maxPendingIO
operator|,
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_ENABLE_HDA_FUNCTIONS
if|if
condition|(
name|ret
operator|==
name|AGSA_RC_FAILURE
operator|&&
name|Tried_NO_HDA
operator|==
name|agFALSE
operator|&&
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/* FW not flashed  */
name|Tried_NO_HDA
operator|=
name|agTRUE
expr_stmt|;
name|swConfig
operator|->
name|hostDirectAccessSupport
operator|=
literal|1
expr_stmt|;
name|swConfig
operator|->
name|hostDirectAccessMode
operator|=
literal|1
expr_stmt|;
name|siSoftReset
argument_list|(
name|agRoot
argument_list|,
name|SPC_SOFT_RESET_SIGNATURE
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: 3 Going to HDA mode HDA %X \n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR3
argument_list|,
name|HDA_RSP_OFFSET1MB
operator|+
name|HDA_CMD_CODE_OFFSET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|TryWithHDA_ON
goto|;
block|}
endif|#
directive|endif
comment|/* SA_ENABLE_HDA_FUNCTIONS */
if|if
condition|(
name|ret
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  AGSA_RC_FAILURE mpiInitialize\n"
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|V_Scratchpad_0_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|V_Scratchpad_2_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|->
name|swConfig
operator|.
name|fatalErrorInterruptEnable
condition|)
block|{
name|ossaDisableInterrupts
argument_list|(
name|agRoot
argument_list|,
name|saRoot
operator|->
name|swConfig
operator|.
name|fatalErrorInterruptVector
argument_list|)
expr_stmt|;
block|}
name|agRoot
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'D'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/* setup hardware interrupt coalescing control and timer registers */
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SPC_V Not set hwInterruptCoalescingTimer\n"
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: SPC_V Not set hwInterruptCoalescingControl\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|SPC_ICTIMER
argument_list|,
name|hwConfig
operator|->
name|hwInterruptCoalescingTimer
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR1
argument_list|,
name|SPC_ICCONTROL
argument_list|,
name|hwConfig
operator|->
name|hwInterruptCoalescingControl
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->fatalErrorInterruptEnable  %X\n"
operator|,
name|swConfig
operator|->
name|fatalErrorInterruptEnable
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: saRoot->swConfig.fatalErrorInterruptVector  %X\n"
operator|,
name|saRoot
operator|->
name|swConfig
operator|.
name|fatalErrorInterruptVector
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->max_MSI_InterruptVectors   %X\n"
operator|,
name|swConfig
operator|->
name|max_MSI_InterruptVectors
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->max_MSIX_InterruptVectors  %X\n"
operator|,
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->legacyInt_X                %X\n"
operator|,
name|swConfig
operator|->
name|legacyInt_X
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->hostDirectAccessSupport    %X\n"
operator|,
name|swConfig
operator|->
name|hostDirectAccessSupport
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->hostDirectAccessMode       %X\n"
operator|,
name|swConfig
operator|->
name|hostDirectAccessMode
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_CONFIG_MDFD_REGISTRY
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->disableMDF                 %X\n"
operator|,
name|swConfig
operator|->
name|disableMDF
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*SA_CONFIG_MDFD_REGISTRY*/
comment|/*SA_DBG1(("saInitialize: swConfig->enableDIF                  %X\n",swConfig->enableDIF));*/
comment|/*SA_DBG1(("saInitialize: swConfig->enableEncryption           %X\n",swConfig->enableEncryption));*/
comment|/* log message if failure */
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|ret
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:AGSA_RC_FAILURE mpiInitialize\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Assign chip status */
name|saRoot
operator|->
name|chipStatus
operator|=
name|CHIP_FATAL_ERROR
expr_stmt|;
block|}
else|else
block|{
comment|/* Assign chip status */
name|saRoot
operator|->
name|chipStatus
operator|=
name|CHIP_NORMAL
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_FW_TIMER_READS_STATUS
name|siTimerAdd
argument_list|(
name|agRoot
argument_list|,
name|SA_FW_TIMER_READS_STATUS_INTERVAL
argument_list|,
name|siReadControllerStatus
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SA_FW_TIMER_READS_STATUS */
block|}
if|if
condition|(
name|ret
operator|==
name|AGSA_RC_SUCCESS
operator|||
name|ret
operator|==
name|AGSA_RC_VERSION_UNTESTED
condition|)
block|{
if|if
condition|(
name|gPollForMissingInt
condition|)
block|{
name|mpiOCQueue_t
modifier|*
name|circularQ
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize:  saRoot->sysIntsActive %X\n"
operator|,
name|saRoot
operator|->
name|sysIntsActive
operator|)
argument_list|)
expr_stmt|;
name|circularQ
operator|=
operator|&
name|saRoot
operator|->
name|outboundQueue
index|[
literal|0
index|]
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|circularQ
operator|->
name|agRoot
argument_list|,
operator|&
name|circularQ
operator|->
name|producerIdx
argument_list|,
name|circularQ
operator|->
name|piPointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: PI 0x%03x CI 0x%03x\n"
operator|,
name|circularQ
operator|->
name|producerIdx
operator|,
name|circularQ
operator|->
name|consumerIdx
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If fatal error interrupt enable we need checking it during the interrupt */
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig.fatalErrorInterruptEnable %d\n"
operator|,
name|saRoot
operator|->
name|swConfig
operator|.
name|fatalErrorInterruptEnable
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig.fatalErrorInterruptVector %d\n"
operator|,
name|saRoot
operator|->
name|swConfig
operator|.
name|fatalErrorInterruptVector
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: swConfig->max_MSIX_InterruptVectors  %X\n"
operator|,
name|swConfig
operator|->
name|max_MSIX_InterruptVectors
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|->
name|swConfig
operator|.
name|fatalErrorInterruptEnable
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Doorbell_Set  %08X U %08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Outbound_Doorbell_Set_Register
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Outbound_Doorbell_Set_RegisterU
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Doorbell_Mask %08X U %08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Outbound_Doorbell_Mask_Set_Register
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Outbound_Doorbell_Mask_Set_RegisterU
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ossaReenableInterrupts
argument_list|(
name|agRoot
argument_list|,
name|saRoot
operator|->
name|swConfig
operator|.
name|fatalErrorInterruptVector
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Doorbell_Set  %08X U %08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Outbound_Doorbell_Set_Register
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Outbound_Doorbell_Set_RegisterU
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: Doorbell_Mask %08X U %08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Outbound_Doorbell_Mask_Set_Register
argument_list|)
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Outbound_Doorbell_Mask_Set_RegisterU
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"saInitialize: siDumpActiveIORequests\n"
operator|)
argument_list|)
expr_stmt|;
name|siDumpActiveIORequests
argument_list|(
name|agRoot
argument_list|,
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'E'
argument_list|,
literal|"m1"
argument_list|)
expr_stmt|;
comment|/* return */
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SA_FW_TIMER_READS_STATUS
end_ifdef

begin_function
name|bit32
name|siReadControllerStatus
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|Event
parameter_list|,
name|void
modifier|*
name|pParm
parameter_list|)
block|{
name|bit32
name|to_ret
init|=
literal|0
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|mpiReadGSTable
argument_list|(
name|agRoot
argument_list|,
operator|&
name|saRoot
operator|->
name|mpiGSTable
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV_2_IOP
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|saRoot
operator|->
name|Iop1Tcnt_last
operator|==
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|Iop1Tcnt
condition|)
name|SA_DBG2
argument_list|(
operator|(
literal|"siReadControllerStatus: Iop1 %d STUCK\n"
operator|,
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|Iop1Tcnt
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|saRoot
operator|->
name|MsguTcnt_last
operator|==
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|MsguTcnt
operator|||
name|saRoot
operator|->
name|IopTcnt_last
operator|==
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|IopTcnt
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siReadControllerStatus: Msgu %d Iop %d\n"
operator|,
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|MsguTcnt
operator|,
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|IopTcnt
operator|)
argument_list|)
expr_stmt|;
name|saFatalInterruptHandler
argument_list|(
name|agRoot
argument_list|,
name|saRoot
operator|->
name|swConfig
operator|.
name|fatalErrorInterruptVector
argument_list|)
expr_stmt|;
block|}
name|SA_DBG2
argument_list|(
operator|(
literal|"siReadControllerStatus: Msgu %d Iop %d\n"
operator|,
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|MsguTcnt
operator|,
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|IopTcnt
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|MsguTcnt_last
operator|=
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|MsguTcnt
expr_stmt|;
name|saRoot
operator|->
name|IopTcnt_last
operator|=
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|IopTcnt
expr_stmt|;
name|saRoot
operator|->
name|Iop1Tcnt_last
operator|=
name|saRoot
operator|->
name|mpiGSTable
operator|.
name|Iop1Tcnt
expr_stmt|;
if|if
condition|(
name|gPollForMissingInt
condition|)
block|{
name|mpiOCQueue_t
modifier|*
name|circularQ
decl_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"siReadControllerStatus:  saRoot->sysIntsActive %X\n"
operator|,
name|saRoot
operator|->
name|sysIntsActive
operator|)
argument_list|)
expr_stmt|;
name|circularQ
operator|=
operator|&
name|saRoot
operator|->
name|outboundQueue
index|[
literal|0
index|]
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|circularQ
operator|->
name|agRoot
argument_list|,
operator|&
name|circularQ
operator|->
name|producerIdx
argument_list|,
name|circularQ
operator|->
name|piPointer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|circularQ
operator|->
name|producerIdx
operator|!=
name|circularQ
operator|->
name|consumerIdx
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siReadControllerStatus:  saRoot->sysIntsActive %X\n"
operator|,
name|saRoot
operator|->
name|sysIntsActive
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siReadControllerStatus: PI 0x%03x CI 0x%03x\n"
operator|,
name|circularQ
operator|->
name|producerIdx
operator|,
name|circularQ
operator|->
name|consumerIdx
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siReadControllerStatus:IN MSGU_READ_ODMR %08X\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_ODMR
argument_list|,
name|V_Outbound_Doorbell_Mask_Set_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siReadControllerStatus:MSGU_READ_ODR  %08X\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_ODR
argument_list|,
name|V_Outbound_Doorbell_Set_Register
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|V_Outbound_Doorbell_Clear_Register
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
block|}
block|}
name|siTimerAdd
argument_list|(
name|agRoot
argument_list|,
name|SA_FW_TIMER_READS_STATUS_INTERVAL
argument_list|,
name|siReadControllerStatus
argument_list|,
name|Event
argument_list|,
name|pParm
argument_list|)
expr_stmt|;
return|return
operator|(
name|to_ret
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SA_FW_TIMER_READS_STATUS */
end_comment

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Routine to do SPC configuration with default or specified values  *  *  Set up configuration table in LL Layer  *  *  \param agRoot    handles for this instance of SAS/SATA hardware  *  \param mpiConfig MPI Configuration  *  \param swConfig  Pointer to the software configuration  *  *  \return -void-  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|siConfiguration
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|mpiConfig_t
modifier|*
name|mpiConfig
parameter_list|,
name|agsaHwConfig_t
modifier|*
name|hwConfig
parameter_list|,
name|agsaSwConfig_t
modifier|*
name|swConfig
parameter_list|)
block|{
name|agsaQueueConfig_t
modifier|*
name|queueConfig
decl_stmt|;
name|bit32
name|intOption
decl_stmt|,
name|enable64
init|=
literal|0
decl_stmt|;
name|bit8
name|i
decl_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"m2"
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
name|mpiConfig
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mpiConfig_t
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration: si_memset mpiConfig\n"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|sidump_swConfig
argument_list|(
name|swConfig
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|custset
operator|=
name|swConfig
operator|->
name|FWConfig
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration:custset              %8X  %8X\n"
operator|,
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|custset
operator|,
name|swConfig
operator|->
name|FWConfig
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|swConfig
operator|->
name|param3
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration: swConfig->param3 == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* initialize the mpiConfig */
comment|/* We configure the Host main part of configuration table */
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|iQNPPD_HPPD_GEvent
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundHWEventPID0_3
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundHWEventPID4_7
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundNCQEventPID0_3
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundNCQEventPID4_7
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundTargetITNexusEventPID0_3
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundTargetITNexusEventPID4_7
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundTargetSSPEventPID0_3
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundTargetSSPEventPID4_7
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|ioAbortDelay
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|upperEventLogAddress
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|lowerEventLogAddress
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|eventLogSize
operator|=
name|MPI_LOGSIZE
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|eventLogOption
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|upperIOPeventLogAddress
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|lowerIOPeventLogAddress
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|IOPeventLogSize
operator|=
name|MPI_LOGSIZE
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|IOPeventLogOption
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|FatalErrorInterrupt
operator|=
literal|0
expr_stmt|;
comment|/* save the default value */
name|mpiConfig
operator|->
name|numInboundQueues
operator|=
name|AGSA_MAX_INBOUND_Q
expr_stmt|;
name|mpiConfig
operator|->
name|numOutboundQueues
operator|=
name|AGSA_MAX_OUTBOUND_Q
expr_stmt|;
name|mpiConfig
operator|->
name|maxNumInboundQueues
operator|=
name|AGSA_MAX_INBOUND_Q
expr_stmt|;
name|mpiConfig
operator|->
name|maxNumOutboundQueues
operator|=
name|AGSA_MAX_OUTBOUND_Q
expr_stmt|;
comment|/* configure inbound queues */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AGSA_MAX_INBOUND_Q
condition|;
name|i
operator|++
control|)
block|{
name|mpiConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|numElements
operator|=
name|INBOUND_DEPTH_SIZE
expr_stmt|;
name|mpiConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
operator|=
name|IOMB_SIZE64
expr_stmt|;
name|mpiConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|priority
operator|=
name|MPI_QUEUE_NORMAL
expr_stmt|;
block|}
comment|/* configure outbound queues */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AGSA_MAX_OUTBOUND_Q
condition|;
name|i
operator|++
control|)
block|{
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|numElements
operator|=
name|OUTBOUND_DEPTH_SIZE
expr_stmt|;
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
operator|=
name|IOMB_SIZE64
expr_stmt|;
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptVector
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptDelay
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptThreshold
operator|=
literal|0
expr_stmt|;
comment|/* always enable OQ interrupt */
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptEnable
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Parm3 is not null  */
name|queueConfig
operator|=
operator|(
name|agsaQueueConfig_t
operator|*
operator|)
name|swConfig
operator|->
name|param3
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|sidump_Q_config
argument_list|(
name|queueConfig
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration: swConfig->param3 == %p\n"
operator|,
name|queueConfig
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|queueConfig
operator|->
name|numInboundQueues
operator|>
name|AGSA_MAX_INBOUND_Q
operator|)
operator|||
operator|(
name|queueConfig
operator|->
name|numOutboundQueues
operator|>
name|AGSA_MAX_OUTBOUND_Q
operator|)
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"m2"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration:AGSA_RC_FAILURE MAX_Q\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
operator|(
name|queueConfig
operator|->
name|numInboundQueues
operator|==
literal|0
operator|||
name|queueConfig
operator|->
name|numOutboundQueues
operator|==
literal|0
operator|)
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"m2"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration:AGSA_RC_FAILURE NO_Q\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|eventLogSize
operator|=
name|swConfig
operator|->
name|sizefEventLog1
operator|*
name|KBYTES
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|eventLogOption
operator|=
name|swConfig
operator|->
name|eventLog1Option
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|IOPeventLogSize
operator|=
name|swConfig
operator|->
name|sizefEventLog2
operator|*
name|KBYTES
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|IOPeventLogOption
operator|=
name|swConfig
operator|->
name|eventLog2Option
expr_stmt|;
if|if
condition|(
operator|(
name|queueConfig
operator|->
name|numInboundQueues
operator|>
name|IQ_NUM_32
operator|)
operator|||
operator|(
name|queueConfig
operator|->
name|numOutboundQueues
operator|>
name|OQ_NUM_32
operator|)
condition|)
block|{
name|enable64
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|agNULL
operator|==
name|hwConfig
condition|)
block|{
name|intOption
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|sidump_hwConfig
argument_list|(
name|hwConfig
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|intOption
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|intOption
operator|=
name|hwConfig
operator|->
name|intReassertionOption
operator|&
name|INT_OPTION
expr_stmt|;
block|}
block|}
comment|/* Enable SGPIO */
name|swConfig
operator|->
name|sgpioSupportEnable
operator|=
literal|1
expr_stmt|;
comment|/* set bit for normal priority or high priority path */
comment|/* set fatal error interrupt enable and vector */
comment|/* set Interrupt Reassertion enable and 64 IQ/OQ enable */
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|FatalErrorInterrupt
operator|=
operator|(
name|swConfig
operator|->
name|fatalErrorInterruptEnable
operator|)
comment|/* bit 0*/
operator||
operator|(
name|hwConfig
operator|==
name|agNULL
condition|?
literal|0
else|:
operator|(
name|hwConfig
operator|->
name|hwOption
operator|&
name|HW_CFG_PICI_EFFECTIVE_ADDRESS
condition|?
operator|(
literal|0x1
operator|<<
name|SHIFT1
operator|)
else|:
literal|0
operator|)
operator|)
operator||
operator|(
name|swConfig
operator|->
name|sgpioSupportEnable
condition|?
operator|(
literal|0x1
operator|<<
name|SHIFT2
operator|)
else|:
literal|0
operator|)
operator||
comment|/* compile option SA_ENABLE_POISION_TLP */
operator|(
name|SA_PTNFE_POISION_TLP
operator|<<
name|SHIFT3
operator|)
operator||
ifdef|#
directive|ifdef
name|SA_CONFIG_MDFD_REGISTRY
operator|(
name|swConfig
operator|->
name|disableMDF
condition|?
operator|(
literal|0x1
operator|<<
name|SHIFT4
operator|)
else|:
literal|0
operator|)
operator||
else|#
directive|else
comment|/* compile option SA_DISABLE_MDFD       */
operator|(
name|SA_MDFD_MULTI_DATA_FETCH
operator|<<
name|SHIFT4
operator|)
operator||
endif|#
directive|endif
comment|/*SA_CONFIG_MDFD_REGISTRY*/
comment|/* compile option SA_DISABLE_OB_COAL    */
operator|(
name|SA_OUTBOUND_COALESCE
operator|<<
name|SHIFT5
operator|)
operator||
comment|/* compile option SA_ENABLE_ARBTE       */
operator|(
name|SA_ARBTE
operator|<<
name|SHIFT6
operator|)
operator||
operator|(
operator|(
name|swConfig
operator|->
name|fatalErrorInterruptVector
operator|&
name|FATAL_ERROR_INT_BITS
operator|)
operator|<<
name|SHIFT8
operator|)
operator||
operator|(
name|enable64
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|intOption
operator|<<
name|SHIFT17
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration: swConfig->fatalErrorInterruptEnable  %X\n"
operator|,
name|swConfig
operator|->
name|fatalErrorInterruptEnable
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration: swConfig->fatalErrorInterruptVector  %X\n"
operator|,
name|swConfig
operator|->
name|fatalErrorInterruptVector
operator|)
argument_list|)
expr_stmt|;
comment|/* initialize the mpiConfig */
comment|/* We configure the Host main part of configuration table */
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundTargetITNexusEventPID0_3
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundTargetITNexusEventPID4_7
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundTargetSSPEventPID0_3
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundTargetSSPEventPID4_7
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|ioAbortDelay
operator|=
literal|0
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|PortRecoveryTimerPortResetTimer
operator|=
name|swConfig
operator|->
name|PortRecoveryResetTimer
expr_stmt|;
comment|/* get parameter from queueConfig */
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|iQNPPD_HPPD_GEvent
operator|=
name|queueConfig
operator|->
name|iqNormalPriorityProcessingDepth
operator||
operator|(
name|queueConfig
operator|->
name|iqHighPriorityProcessingDepth
operator|<<
name|SHIFT8
operator|)
operator||
operator|(
name|queueConfig
operator|->
name|generalEventQueue
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|queueConfig
operator|->
name|tgtDeviceRemovedEventQueue
operator|<<
name|SHIFT24
operator|)
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundHWEventPID0_3
operator|=
name|queueConfig
operator|->
name|sasHwEventQueue
index|[
literal|0
index|]
operator||
operator|(
name|queueConfig
operator|->
name|sasHwEventQueue
index|[
literal|1
index|]
operator|<<
name|SHIFT8
operator|)
operator||
operator|(
name|queueConfig
operator|->
name|sasHwEventQueue
index|[
literal|2
index|]
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|queueConfig
operator|->
name|sasHwEventQueue
index|[
literal|3
index|]
operator|<<
name|SHIFT24
operator|)
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundHWEventPID4_7
operator|=
name|queueConfig
operator|->
name|sasHwEventQueue
index|[
literal|4
index|]
operator||
operator|(
name|queueConfig
operator|->
name|sasHwEventQueue
index|[
literal|5
index|]
operator|<<
name|SHIFT8
operator|)
operator||
operator|(
name|queueConfig
operator|->
name|sasHwEventQueue
index|[
literal|6
index|]
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|queueConfig
operator|->
name|sasHwEventQueue
index|[
literal|7
index|]
operator|<<
name|SHIFT24
operator|)
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundNCQEventPID0_3
operator|=
name|queueConfig
operator|->
name|sataNCQErrorEventQueue
index|[
literal|0
index|]
operator||
operator|(
name|queueConfig
operator|->
name|sataNCQErrorEventQueue
index|[
literal|1
index|]
operator|<<
name|SHIFT8
operator|)
operator||
operator|(
name|queueConfig
operator|->
name|sataNCQErrorEventQueue
index|[
literal|2
index|]
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|queueConfig
operator|->
name|sataNCQErrorEventQueue
index|[
literal|3
index|]
operator|<<
name|SHIFT24
operator|)
expr_stmt|;
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|outboundNCQEventPID4_7
operator|=
name|queueConfig
operator|->
name|sataNCQErrorEventQueue
index|[
literal|4
index|]
operator||
operator|(
name|queueConfig
operator|->
name|sataNCQErrorEventQueue
index|[
literal|5
index|]
operator|<<
name|SHIFT8
operator|)
operator||
operator|(
name|queueConfig
operator|->
name|sataNCQErrorEventQueue
index|[
literal|6
index|]
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|queueConfig
operator|->
name|sataNCQErrorEventQueue
index|[
literal|7
index|]
operator|<<
name|SHIFT24
operator|)
expr_stmt|;
comment|/* save it */
name|mpiConfig
operator|->
name|numInboundQueues
operator|=
name|queueConfig
operator|->
name|numInboundQueues
expr_stmt|;
name|mpiConfig
operator|->
name|numOutboundQueues
operator|=
name|queueConfig
operator|->
name|numOutboundQueues
expr_stmt|;
name|mpiConfig
operator|->
name|queueOption
operator|=
name|queueConfig
operator|->
name|queueOption
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siConfiguration: numInboundQueues=%d numOutboundQueues=%d\n"
operator|,
name|queueConfig
operator|->
name|numInboundQueues
operator|,
name|queueConfig
operator|->
name|numOutboundQueues
operator|)
argument_list|)
expr_stmt|;
comment|/* configure inbound queues */
comment|/* We configure the size of queue based on swConfig */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|queueConfig
operator|->
name|numInboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|mpiConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|numElements
operator|=
operator|(
name|bit16
operator|)
name|queueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|elementCount
expr_stmt|;
name|mpiConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
operator|=
operator|(
name|bit16
operator|)
name|queueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
expr_stmt|;
empty_stmt|;
name|mpiConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|priority
operator|=
name|queueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|priority
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siConfiguration: IBQ%d:elementCount=%d elementSize=%d priority=%d Total Size 0x%X\n"
operator|,
name|i
operator|,
name|queueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|elementCount
operator|,
name|queueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
operator|,
name|queueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|priority
operator|,
name|queueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|elementCount
operator|*
name|queueConfig
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* configura outbound queues */
comment|/* We configure the size of queue based on swConfig */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|queueConfig
operator|->
name|numOutboundQueues
condition|;
name|i
operator|++
control|)
block|{
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|numElements
operator|=
operator|(
name|bit16
operator|)
name|queueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|elementCount
expr_stmt|;
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
operator|=
operator|(
name|bit16
operator|)
name|queueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
expr_stmt|;
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptVector
operator|=
operator|(
name|bit8
operator|)
name|queueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptVectorIndex
expr_stmt|;
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptDelay
operator|=
operator|(
name|bit16
operator|)
name|queueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptDelay
expr_stmt|;
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptThreshold
operator|=
operator|(
name|bit8
operator|)
name|queueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptCount
expr_stmt|;
name|mpiConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptEnable
operator|=
operator|(
name|bit32
operator|)
name|queueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptEnable
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siConfiguration: OBQ%d:elementCount=%d elementSize=%d interruptCount=%d interruptEnable=%d\n"
operator|,
name|i
operator|,
name|queueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|elementCount
operator|,
name|queueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|elementSize
operator|,
name|queueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptCount
operator|,
name|queueConfig
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptEnable
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration:mpiConfig->mainConfig.FatalErrorInterrupt 0x%X\n"
operator|,
name|mpiConfig
operator|->
name|mainConfig
operator|.
name|FatalErrorInterrupt
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration:swConfig->fatalErrorInterruptVector       0x%X\n"
operator|,
name|swConfig
operator|->
name|fatalErrorInterruptVector
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration:enable64                                  0x%X\n"
operator|,
name|enable64
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siConfiguration:PortRecoveryResetTimer                    0x%X\n"
operator|,
name|swConfig
operator|->
name|PortRecoveryResetTimer
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"m2"
argument_list|)
expr_stmt|;
comment|/* return */
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|FW_EVT_LOG_TST
end_ifdef

begin_function
name|void
name|saLogDump
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|U32
modifier|*
name|eventLogSize
parameter_list|,
name|U32
modifier|*
modifier|*
name|eventLogAddress_
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
comment|//mpiConfig_t  *mpiConfig =&saRoot->mpiConfig;
name|mpiHostLLConfigDescriptor_t
modifier|*
name|mpiConfig
init|=
operator|&
name|saRoot
operator|->
name|mainConfigTable
decl_stmt|;
operator|*
name|eventLogAddress_
operator|=
operator|(
name|U32
operator|*
operator|)
name|eventLogAddress
expr_stmt|;
operator|*
name|eventLogSize
operator|=
operator|(
name|U32
operator|)
name|mpiConfig
operator|->
name|eventLogSize
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn mpiInitialize(agsaRoot *agRoot, mpiMemReq_t* memoryAllocated, mpiConfig_t* config)  *  \brief Initializes the MPI Message Unit  *  \param agRoot           Pointer to a data structure containing LL layer context handles  *  \param memoryAllocated  Data structure that holds the different chunks of memory that are allocated  *  \param config           MPI configuration  *  * This function is called to initialize SPC_HOST_MPI internal data structures and the SPC hardware.  * This function is competed synch->ronously (there is no callback)  *  * Return:  *         AGSA_RC_SUCCESS if initialization succeeded.  *         AGSA_RC_FAILURE if initialization failed.  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiInitialize
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|mpiMemReq_t
modifier|*
name|memoryAllocated
parameter_list|,
name|mpiConfig_t
modifier|*
name|config
parameter_list|)
block|{
specifier|static
name|spc_configMainDescriptor_t
name|mainCfg
decl_stmt|;
comment|/* main part of MPI configuration */
specifier|static
name|spc_inboundQueueDescriptor_t
name|inQueueCfg
decl_stmt|;
comment|/* Inbound queue HW configuration structure */
specifier|static
name|spc_outboundQueueDescriptor_t
name|outQueueCfg
decl_stmt|;
comment|/* Outbound queue HW configuration structure */
name|bit16
name|qIdx
decl_stmt|,
name|i
decl_stmt|,
name|indexoffset
decl_stmt|;
comment|/* Queue index */
name|bit16
name|mIdx
init|=
literal|0
decl_stmt|;
comment|/* Memory region index */
name|bit32
name|MSGUCfgTblDWIdx
decl_stmt|,
name|GSTLenMPIS
decl_stmt|;
name|bit32
name|MSGUCfgTblBase
decl_stmt|,
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|bit32
name|value
decl_stmt|,
name|togglevalue
decl_stmt|;
name|bit32
name|saveOffset
decl_stmt|;
name|bit32
name|inboundoffset
decl_stmt|,
name|outboundoffset
decl_stmt|;
name|bit8
name|pcibar
decl_stmt|;
name|bit16
name|maxinbound
init|=
name|AGSA_MAX_INBOUND_Q
decl_stmt|;
name|bit16
name|maxoutbound
init|=
name|AGSA_MAX_OUTBOUND_Q
decl_stmt|;
name|bit32
name|OB_CIPCIBar
decl_stmt|;
name|bit32
name|IB_PIPCIBar
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
name|bit32
name|memOffset
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
decl_stmt|;
name|mpiICQueue_t
modifier|*
name|circularIQ
init|=
name|agNULL
decl_stmt|;
name|mpiOCQueue_t
modifier|*
name|circularOQ
decl_stmt|;
name|bit32
name|mpiUnInitFailed
init|=
literal|0
decl_stmt|;
name|bit32
name|mpiStartToggleFailed
init|=
literal|0
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|bit8
name|phycount
init|=
name|AGSA_MAX_VALID_PHYS
decl_stmt|;
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: Entering\n"
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|NULL
operator|!=
name|agRoot
argument_list|,
literal|"agRoot argument cannot be null"
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|NULL
operator|!=
name|memoryAllocated
argument_list|,
literal|"memoryAllocated argument cannot be null"
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|NULL
operator|!=
name|config
argument_list|,
literal|"config argument cannot be null"
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
literal|0
operator|==
operator|(
sizeof|sizeof
argument_list|(
name|spc_inboundQueueDescriptor_t
argument_list|)
operator|%
literal|4
operator|)
argument_list|,
literal|"spc_inboundQueueDescriptor_t type size has to be divisible by 4"
argument_list|)
expr_stmt|;
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|mainCfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|spc_configMainDescriptor_t
argument_list|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|inQueueCfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|spc_inboundQueueDescriptor_t
argument_list|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|outQueueCfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|spc_outboundQueueDescriptor_t
argument_list|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|saRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: saRoot == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|AGSA_RC_FAILURE
operator|)
return|;
block|}
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
comment|/*Shift BAR 4 for SPC HAILEAH*/
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|smIS_HIL
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|siBar4Shift
argument_list|(
name|agRoot
argument_list|,
name|MBIC_GSM_SM_BASE
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: siBar4Shift FAILED ******************************************\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
block|}
comment|/* Wait for the SPC Configuration Table to be ready */
name|ret
operator|=
name|mpiWaitForConfigTable
argument_list|(
name|agRoot
argument_list|,
operator|&
name|mainCfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|AGSA_RC_FAILURE
operator|==
name|ret
condition|)
block|{
comment|/* return error if MPI Configuration Table not ready */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: mpiWaitForConfigTable FAILED ******************************************\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/* read scratch pad0 to get PCI BAR and offset of configuration table */
name|MSGUCfgTblBase
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
comment|/* get PCI BAR */
name|MSGUCfgTblBase
operator|=
operator|(
name|MSGUCfgTblBase
operator|&
name|SCRATCH_PAD0_BAR_MASK
operator|)
operator|>>
name|SHIFT26
expr_stmt|;
comment|/* get pci Bar index */
name|pcibar
operator|=
operator|(
name|bit8
operator|)
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|MSGUCfgTblBase
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: MSGUCfgTblBase = 0x%x\n"
operator|,
name|MSGUCfgTblBase
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
comment|/* get Phy count from configuration table */
name|phycount
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|mainCfg
operator|.
name|ContrlCapFlag
operator|&
name|PHY_COUNT_BITS
operator|)
operator|>>
name|SHIFT19
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: Number of PHYs = 0x%x\n"
operator|,
name|phycount
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"70"
argument_list|,
name|phycount
argument_list|)
expr_stmt|;
comment|/* TP:70 phycount */
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
comment|/* get High Priority IQ support flag */
if|if
condition|(
name|mainCfg
operator|.
name|ContrlCapFlag
operator|&
name|HP_SUPPORT_BIT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: High Priority IQ support from SPC\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* get Interrupt Coalescing Support flag */
if|if
condition|(
name|mainCfg
operator|.
name|ContrlCapFlag
operator|&
name|INT_COL_BIT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: Interrupt Coalescing support from SPC\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* get configured the number of inbound/outbound queues */
if|if
condition|(
name|memoryAllocated
operator|->
name|count
operator|==
name|TOTAL_MPI_MEM_CHUNKS
condition|)
block|{
name|config
operator|->
name|maxNumInboundQueues
operator|=
name|AGSA_MAX_INBOUND_Q
expr_stmt|;
name|config
operator|->
name|maxNumOutboundQueues
operator|=
name|AGSA_MAX_OUTBOUND_Q
expr_stmt|;
block|}
else|else
block|{
name|config
operator|->
name|maxNumInboundQueues
operator|=
name|config
operator|->
name|numInboundQueues
expr_stmt|;
name|config
operator|->
name|maxNumOutboundQueues
operator|=
name|config
operator|->
name|numOutboundQueues
expr_stmt|;
name|maxinbound
operator|=
name|config
operator|->
name|numInboundQueues
expr_stmt|;
name|maxoutbound
operator|=
name|config
operator|->
name|numOutboundQueues
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: Number of IQ %d\n"
operator|,
name|maxinbound
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: Number of OQ %d\n"
operator|,
name|maxoutbound
operator|)
argument_list|)
expr_stmt|;
comment|/* get inbound queue offset */
name|inboundoffset
operator|=
name|mainCfg
operator|.
name|inboundQueueOffset
expr_stmt|;
comment|/* get outbound queue offset */
name|outboundoffset
operator|=
name|mainCfg
operator|.
name|outboundQueueOffset
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiInitialize: Offset of IQ %d\n"
operator|,
operator|(
name|inboundoffset
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiInitialize: Offset of OQ %d\n"
operator|,
operator|(
name|outboundoffset
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
operator|)
argument_list|)
expr_stmt|;
name|inboundoffset
operator|&=
literal|0x00FFFFFF
expr_stmt|;
name|outboundoffset
operator|&=
literal|0x00FFFFFF
expr_stmt|;
block|}
comment|/* get offset of the configuration table */
name|MSGUCfgTblDWIdx
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|MSGUCfgTblDWIdx
operator|=
name|MSGUCfgTblDWIdx
operator|&
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
name|saveOffset
operator|=
name|MSGUCfgTblDWIdx
expr_stmt|;
comment|/* Checks if the configuration memory region size is the same as the mpiConfigMain */
if|if
condition|(
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|totalLength
operator|!=
sizeof|sizeof
argument_list|(
name|bit8
argument_list|)
operator|*
name|config
operator|->
name|mainConfig
operator|.
name|eventLogSize
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"ERROR: The memory region [%d] 0x%X != 0x%X does not have the size of the MSGU event log ******************************************\n"
operator|,
name|mIdx
operator|,
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|totalLength
operator|,
name|config
operator|->
name|mainConfig
operator|.
name|eventLogSize
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|mainCfg
operator|.
name|iQNPPD_HPPD_GEvent
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|iQNPPD_HPPD_GEvent
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|mainCfg
operator|.
name|outboundHWEventPID0_3
operator|=
literal|0
expr_stmt|;
name|mainCfg
operator|.
name|outboundHWEventPID4_7
operator|=
literal|0
expr_stmt|;
name|mainCfg
operator|.
name|outboundNCQEventPID0_3
operator|=
literal|0
expr_stmt|;
name|mainCfg
operator|.
name|outboundNCQEventPID4_7
operator|=
literal|0
expr_stmt|;
name|mainCfg
operator|.
name|outboundTargetITNexusEventPID0_3
operator|=
literal|0
expr_stmt|;
name|mainCfg
operator|.
name|outboundTargetITNexusEventPID4_7
operator|=
literal|0
expr_stmt|;
name|mainCfg
operator|.
name|outboundTargetSSPEventPID0_3
operator|=
literal|0
expr_stmt|;
name|mainCfg
operator|.
name|outboundTargetSSPEventPID4_7
operator|=
literal|0
expr_stmt|;
name|mainCfg
operator|.
name|ioAbortDelay
operator|=
literal|0
expr_stmt|;
comment|/* SPCV reserved */
name|mainCfg
operator|.
name|custset
operator|=
literal|0
expr_stmt|;
name|mainCfg
operator|.
name|portRecoveryResetTimer
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|PortRecoveryTimerPortResetTimer
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:custset V                %8X\n"
operator|,
name|mainCfg
operator|.
name|custset
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:portRecoveryResetTimer V %8X\n"
operator|,
name|mainCfg
operator|.
name|portRecoveryResetTimer
operator|)
argument_list|)
expr_stmt|;
name|mainCfg
operator|.
name|interruptReassertionDelay
operator|=
name|saRoot
operator|->
name|hwConfig
operator|.
name|intReassertionOption
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:interruptReassertionDelay V %8X\n"
operator|,
name|mainCfg
operator|.
name|interruptReassertionDelay
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mainCfg
operator|.
name|outboundHWEventPID0_3
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|outboundHWEventPID0_3
expr_stmt|;
name|mainCfg
operator|.
name|outboundHWEventPID4_7
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|outboundHWEventPID4_7
expr_stmt|;
name|mainCfg
operator|.
name|outboundNCQEventPID0_3
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|outboundNCQEventPID0_3
expr_stmt|;
name|mainCfg
operator|.
name|outboundNCQEventPID4_7
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|outboundNCQEventPID4_7
expr_stmt|;
name|mainCfg
operator|.
name|outboundTargetITNexusEventPID0_3
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|outboundTargetITNexusEventPID0_3
expr_stmt|;
name|mainCfg
operator|.
name|outboundTargetITNexusEventPID4_7
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|outboundTargetITNexusEventPID4_7
expr_stmt|;
name|mainCfg
operator|.
name|outboundTargetSSPEventPID0_3
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|outboundTargetSSPEventPID0_3
expr_stmt|;
name|mainCfg
operator|.
name|outboundTargetSSPEventPID4_7
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|outboundTargetSSPEventPID4_7
expr_stmt|;
name|mainCfg
operator|.
name|ioAbortDelay
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|ioAbortDelay
expr_stmt|;
name|mainCfg
operator|.
name|custset
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|custset
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:custset spc     %8X\n"
operator|,
name|mainCfg
operator|.
name|custset
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FW_EVT_LOG_TST
name|eventLogAddress
operator|=
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|virtPtr
expr_stmt|;
endif|#
directive|endif
name|mainCfg
operator|.
name|upperEventLogAddress
operator|=
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|mainCfg
operator|.
name|lowerEventLogAddress
operator|=
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|physAddrLower
expr_stmt|;
name|mainCfg
operator|.
name|eventLogSize
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|eventLogSize
expr_stmt|;
name|mainCfg
operator|.
name|eventLogOption
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|eventLogOption
expr_stmt|;
name|mIdx
operator|++
expr_stmt|;
comment|/* Checks if the configuration memory region size is the same as the mpiConfigMain */
if|if
condition|(
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|totalLength
operator|!=
sizeof|sizeof
argument_list|(
name|bit8
argument_list|)
operator|*
name|config
operator|->
name|mainConfig
operator|.
name|IOPeventLogSize
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"ERROR: The memory region does not have the size of the IOP event log\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|mainCfg
operator|.
name|upperIOPeventLogAddress
operator|=
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|mainCfg
operator|.
name|lowerIOPeventLogAddress
operator|=
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|physAddrLower
expr_stmt|;
name|mainCfg
operator|.
name|IOPeventLogSize
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|IOPeventLogSize
expr_stmt|;
name|mainCfg
operator|.
name|IOPeventLogOption
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|IOPeventLogOption
expr_stmt|;
name|mainCfg
operator|.
name|FatalErrorInterrupt
operator|=
name|config
operator|->
name|mainConfig
operator|.
name|FatalErrorInterrupt
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: iQNPPD_HPPD_GEvent 0x%x\n"
operator|,
name|mainCfg
operator|.
name|iQNPPD_HPPD_GEvent
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{   }
else|else
block|{
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: outboundHWEventPID0_3 0x%x\n"
operator|,
name|mainCfg
operator|.
name|outboundHWEventPID0_3
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: outboundHWEventPID4_7 0x%x\n"
operator|,
name|mainCfg
operator|.
name|outboundHWEventPID4_7
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: outboundNCQEventPID0_3 0x%x\n"
operator|,
name|mainCfg
operator|.
name|outboundNCQEventPID0_3
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: outboundNCQEventPID4_7 0x%x\n"
operator|,
name|mainCfg
operator|.
name|outboundNCQEventPID4_7
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: outboundTargetITNexusEventPID0_3 0x%x\n"
operator|,
name|mainCfg
operator|.
name|outboundTargetITNexusEventPID0_3
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: outboundTargetITNexusEventPID4_7 0x%x\n"
operator|,
name|mainCfg
operator|.
name|outboundTargetITNexusEventPID4_7
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: outboundTargetSSPEventPID0_3 0x%x\n"
operator|,
name|mainCfg
operator|.
name|outboundTargetSSPEventPID0_3
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: outboundTargetSSPEventPID4_7 0x%x\n"
operator|,
name|mainCfg
operator|.
name|outboundTargetSSPEventPID4_7
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: upperEventLogAddress 0x%x\n"
operator|,
name|mainCfg
operator|.
name|upperEventLogAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: lowerEventLogAddress 0x%x\n"
operator|,
name|mainCfg
operator|.
name|lowerEventLogAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: eventLogSize 0x%x\n"
operator|,
name|mainCfg
operator|.
name|eventLogSize
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: eventLogOption 0x%x\n"
operator|,
name|mainCfg
operator|.
name|eventLogOption
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FW_EVT_LOG_TST
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: eventLogAddress 0x%p\n"
operator|,
name|eventLogAddress
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: upperIOPLogAddress 0x%x\n"
operator|,
name|mainCfg
operator|.
name|upperIOPeventLogAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: lowerIOPLogAddress 0x%x\n"
operator|,
name|mainCfg
operator|.
name|lowerIOPeventLogAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: IOPeventLogSize 0x%x\n"
operator|,
name|mainCfg
operator|.
name|IOPeventLogSize
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: IOPeventLogOption 0x%x\n"
operator|,
name|mainCfg
operator|.
name|IOPeventLogOption
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: FatalErrorInterrupt 0x%x\n"
operator|,
name|mainCfg
operator|.
name|FatalErrorInterrupt
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: HDAModeFlags 0x%x\n"
operator|,
name|mainCfg
operator|.
name|HDAModeFlags
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: analogSetupTblOffset 0x%08x\n"
operator|,
name|mainCfg
operator|.
name|analogSetupTblOffset
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|iQNPPD_HPPD_GEvent
operator|=
name|mainCfg
operator|.
name|iQNPPD_HPPD_GEvent
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/* SPCV - reserved fields */
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundHWEventPID0_3
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundHWEventPID4_7
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundNCQEventPID0_3
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundNCQEventPID4_7
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundTargetITNexusEventPID0_3
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundTargetITNexusEventPID4_7
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundTargetSSPEventPID0_3
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundTargetSSPEventPID4_7
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|ioAbortDelay
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|custset
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundHWEventPID0_3
operator|=
name|mainCfg
operator|.
name|outboundHWEventPID0_3
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundHWEventPID4_7
operator|=
name|mainCfg
operator|.
name|outboundHWEventPID4_7
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundNCQEventPID0_3
operator|=
name|mainCfg
operator|.
name|outboundNCQEventPID0_3
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundNCQEventPID4_7
operator|=
name|mainCfg
operator|.
name|outboundNCQEventPID4_7
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundTargetITNexusEventPID0_3
operator|=
name|mainCfg
operator|.
name|outboundTargetITNexusEventPID0_3
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundTargetITNexusEventPID4_7
operator|=
name|mainCfg
operator|.
name|outboundTargetITNexusEventPID4_7
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundTargetSSPEventPID0_3
operator|=
name|mainCfg
operator|.
name|outboundTargetSSPEventPID0_3
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|outboundTargetSSPEventPID4_7
operator|=
name|mainCfg
operator|.
name|outboundTargetSSPEventPID4_7
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|ioAbortDelay
operator|=
name|mainCfg
operator|.
name|ioAbortDelay
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|custset
operator|=
name|mainCfg
operator|.
name|custset
expr_stmt|;
block|}
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|upperEventLogAddress
operator|=
name|mainCfg
operator|.
name|upperEventLogAddress
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|lowerEventLogAddress
operator|=
name|mainCfg
operator|.
name|lowerEventLogAddress
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|eventLogSize
operator|=
name|mainCfg
operator|.
name|eventLogSize
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|eventLogOption
operator|=
name|mainCfg
operator|.
name|eventLogOption
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|upperIOPeventLogAddress
operator|=
name|mainCfg
operator|.
name|upperIOPeventLogAddress
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|lowerIOPeventLogAddress
operator|=
name|mainCfg
operator|.
name|lowerIOPeventLogAddress
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|IOPeventLogSize
operator|=
name|mainCfg
operator|.
name|IOPeventLogSize
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|IOPeventLogOption
operator|=
name|mainCfg
operator|.
name|IOPeventLogOption
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorInterrupt
operator|=
name|mainCfg
operator|.
name|FatalErrorInterrupt
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
empty_stmt|;
comment|/* SPCV - reserved fields */
block|}
else|else
block|{
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|HDAModeFlags
operator|=
name|mainCfg
operator|.
name|HDAModeFlags
expr_stmt|;
block|}
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|analogSetupTblOffset
operator|=
name|mainCfg
operator|.
name|analogSetupTblOffset
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"71"
argument_list|,
name|mIdx
argument_list|)
expr_stmt|;
comment|/* TP:71 71 mIdx  */
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IQNPPD_HPPD_OFFSET
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|iQNPPD_HPPD_GEvent
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x mainCfg.iQNPPD_HPPD_GEvent 0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IQNPPD_HPPD_OFFSET
argument_list|)
operator|,
name|mainCfg
operator|.
name|iQNPPD_HPPD_GEvent
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPC6V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|smIsCfgVREV_B
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IO_ABORT_DELAY
argument_list|)
argument_list|,
name|MAIN_IO_ABORT_DELAY_END_TO_END_CRC_DISABLE
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:SPCV - MAIN_IO_ABORT_DELAY_END_TO_END_CRC_DISABLE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIsCfgVREV_C
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:SPCV - END_TO_END_CRC On\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize:SPCV - rest reserved field  \n"
operator|)
argument_list|)
expr_stmt|;
empty_stmt|;
comment|/* SPCV - reserved field */
block|}
elseif|else
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_OB_HW_EVENT_PID03_OFFSET
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|outboundHWEventPID0_3
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_OB_HW_EVENT_PID47_OFFSET
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|outboundHWEventPID4_7
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_OB_NCQ_EVENT_PID03_OFFSET
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|outboundNCQEventPID0_3
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_OB_NCQ_EVENT_PID47_OFFSET
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|outboundNCQEventPID4_7
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_TITNX_EVENT_PID03_OFFSET
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|outboundTargetITNexusEventPID0_3
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_TITNX_EVENT_PID47_OFFSET
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|outboundTargetITNexusEventPID4_7
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_OB_SSP_EVENT_PID03_OFFSET
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|outboundTargetSSPEventPID0_3
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_OB_SSP_EVENT_PID47_OFFSET
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|outboundTargetSSPEventPID4_7
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_CUSTOMER_SETTING
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|custset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|smIsCfgVREV_A
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IO_ABORT_DELAY
argument_list|)
argument_list|,
name|MAIN_IO_ABORT_DELAY_END_TO_END_CRC_DISABLE
argument_list|)
expr_stmt|;
comment|/* */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:SPCV12G - offset MAIN_IO_ABORT_DELAY 0x%x value MAIN_IO_ABORT_DELAY_END_TO_END_CRC_DISABLE 0x%x\n"
operator|,
name|MAIN_IO_ABORT_DELAY
operator|,
name|MAIN_IO_ABORT_DELAY_END_TO_END_CRC_DISABLE
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:SPCV12G - END_TO_END_CRC OFF for rev A %d\n"
operator|,
name|smIsCfgVREV_A
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|smIsCfgVREV_B
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:SPCV12G - END_TO_END_CRC ON rev B %d ****************************\n"
operator|,
name|smIsCfgVREV_B
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/*ossaHwRegWriteExt(agRoot, pcibar, (bit32)(MSGUCfgTblDWIdx + MAIN_IO_ABORT_DELAY),                      MAIN_IO_ABORT_DELAY_END_TO_END_CRC_DISABLE);         */
block|}
elseif|else
if|if
condition|(
name|smIsCfgVREV_C
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:SPCV12G - END_TO_END_CRC on rev C %d\n"
operator|,
name|smIsCfgVREV_C
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IO_ABORT_DELAY
argument_list|)
argument_list|,
name|MAIN_IO_ABORT_DELAY_END_TO_END_CRC_DISABLE
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:SPCV12G - END_TO_END_CRC Off unknown rev 0x%x\n"
operator|,
name|ossaHwRegReadConfig32
argument_list|(
operator|(
name|agRoot
operator|)
argument_list|,
literal|8
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_ADDR_HI
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|upperEventLogAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_ADDR_LO
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|lowerEventLogAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_BUFF_SIZE
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|eventLogSize
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_OPTION
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|eventLogOption
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_ADDR_HI
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|upperIOPeventLogAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_ADDR_LO
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|lowerIOPeventLogAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_BUFF_SIZE
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|IOPeventLogSize
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_OPTION
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|IOPeventLogOption
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_INTERRUPT
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|FatalErrorInterrupt
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_PRECTD_PRESETD
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|portRecoveryResetTimer
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x upperEventLogAddress    0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_ADDR_HI
argument_list|)
operator|,
name|mainCfg
operator|.
name|upperEventLogAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x lowerEventLogAddress    0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_ADDR_LO
argument_list|)
operator|,
name|mainCfg
operator|.
name|lowerEventLogAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x eventLogSize            0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_BUFF_SIZE
argument_list|)
operator|,
name|mainCfg
operator|.
name|eventLogSize
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x eventLogOption          0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_OPTION
argument_list|)
operator|,
name|mainCfg
operator|.
name|eventLogOption
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x upperIOPeventLogAddress 0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_ADDR_HI
argument_list|)
operator|,
name|mainCfg
operator|.
name|upperIOPeventLogAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x lowerIOPeventLogAddress 0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_ADDR_LO
argument_list|)
operator|,
name|mainCfg
operator|.
name|lowerIOPeventLogAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x IOPeventLogSize         0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_BUFF_SIZE
argument_list|)
operator|,
name|mainCfg
operator|.
name|IOPeventLogSize
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x IOPeventLogOption       0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_OPTION
argument_list|)
operator|,
name|mainCfg
operator|.
name|IOPeventLogOption
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x FatalErrorInterrupt     0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_INTERRUPT
argument_list|)
operator|,
name|mainCfg
operator|.
name|FatalErrorInterrupt
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x PortRecoveryResetTimer  0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_PRECTD_PRESETD
argument_list|)
operator|,
name|mainCfg
operator|.
name|portRecoveryResetTimer
operator|)
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IRAD_RESERVED
argument_list|)
argument_list|,
name|mainCfg
operator|.
name|interruptReassertionDelay
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiInitialize: Offset 0x%08x InterruptReassertionDelay 0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IRAD_RESERVED
argument_list|)
operator|,
name|mainCfg
operator|.
name|interruptReassertionDelay
operator|)
argument_list|)
expr_stmt|;
name|mIdx
operator|++
expr_stmt|;
comment|/* skip the ci and pi memory region */
name|mIdx
operator|++
expr_stmt|;
name|mIdx
operator|++
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"72"
argument_list|,
name|mIdx
argument_list|)
expr_stmt|;
comment|/* TP:72 mIdx  */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Bc"
argument_list|,
name|maxinbound
argument_list|)
expr_stmt|;
comment|/* TP:Bc  maxinbound  */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Bd"
argument_list|,
name|pcibar
argument_list|)
expr_stmt|;
comment|/* TP:Bd pcibar   */
comment|/* index offset */
name|indexoffset
operator|=
literal|0
expr_stmt|;
name|memOffset
operator|=
literal|0
expr_stmt|;
comment|/* Memory regions for the inbound queues */
for|for
control|(
name|qIdx
operator|=
literal|0
init|;
name|qIdx
operator|<
name|maxinbound
condition|;
name|qIdx
operator|++
control|)
block|{
comment|/* point back to the begin then plus offset to next queue */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Bd"
argument_list|,
name|pcibar
argument_list|)
expr_stmt|;
comment|/* TP:Bd pcibar   */
name|MSGUCfgTblDWIdx
operator|=
name|saveOffset
expr_stmt|;
name|MSGUCfgTblDWIdx
operator|+=
name|inboundoffset
expr_stmt|;
name|MSGUCfgTblDWIdx
operator|+=
operator|(
sizeof|sizeof
argument_list|(
name|spc_inboundQueueDescriptor_t
argument_list|)
operator|*
name|qIdx
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: A saveOffset 0x%x MSGUCfgTblDWIdx 0x%x\n"
operator|,
name|saveOffset
operator|,
name|MSGUCfgTblDWIdx
operator|)
argument_list|)
expr_stmt|;
comment|/* if the MPI configuration says that this queue is disabled ... */
if|if
condition|(
literal|0
operator|==
name|config
operator|->
name|inboundQueues
index|[
name|qIdx
index|]
operator|.
name|numElements
condition|)
block|{
comment|/* ... Clears the configuration table for this queue */
name|inQueueCfg
operator|.
name|elementPriSizeCount
operator|=
literal|0
expr_stmt|;
name|inQueueCfg
operator|.
name|upperBaseAddress
operator|=
literal|0
expr_stmt|;
name|inQueueCfg
operator|.
name|lowerBaseAddress
operator|=
literal|0
expr_stmt|;
name|inQueueCfg
operator|.
name|ciUpperBaseAddress
operator|=
literal|0
expr_stmt|;
name|inQueueCfg
operator|.
name|ciLowerBaseAddress
operator|=
literal|0
expr_stmt|;
comment|/* skip inQueueCfg.PIPCIBar (PM8000 write access) */
comment|/* skip inQueueCfg.PIOffset (PM8000 write access) */
comment|/* Update the inbound configuration table in SPC GSM */
name|mpiUpdateIBQueueCfgTable
argument_list|(
name|agRoot
argument_list|,
operator|&
name|inQueueCfg
argument_list|,
name|MSGUCfgTblDWIdx
argument_list|,
name|pcibar
argument_list|)
expr_stmt|;
block|}
comment|/* If the queue is enabled, then ... */
else|else
block|{
name|bit32
name|memSize
init|=
name|config
operator|->
name|inboundQueues
index|[
name|qIdx
index|]
operator|.
name|numElements
operator|*
name|config
operator|->
name|inboundQueues
index|[
name|qIdx
index|]
operator|.
name|elementSize
decl_stmt|;
name|bit32
name|remainder
init|=
name|memSize
operator|&
literal|127
decl_stmt|;
comment|/* Calculate the size of this queue padded to 128 bytes */
if|if
condition|(
name|remainder
operator|>
literal|0
condition|)
block|{
name|memSize
operator|+=
operator|(
literal|128
operator|-
name|remainder
operator|)
expr_stmt|;
block|}
comment|/* ... first checks that the memory region has the right size */
if|if
condition|(
operator|(
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|totalLength
operator|-
name|memOffset
operator|<
name|memSize
operator|)
operator|||
operator|(
name|NULL
operator|==
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|virtPtr
operator|)
operator|||
operator|(
literal|0
operator|==
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|totalLength
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: ERROR The memory region does not have the right size for this inbound queue"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
else|else
block|{
comment|/* Then, using the MPI configuration argument, initializes the corresponding element on the saRoot */
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|numElements
operator|=
name|config
operator|->
name|inboundQueues
index|[
name|qIdx
index|]
operator|.
name|numElements
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|elementSize
operator|=
name|config
operator|->
name|inboundQueues
index|[
name|qIdx
index|]
operator|.
name|elementSize
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|priority
operator|=
name|config
operator|->
name|inboundQueues
index|[
name|qIdx
index|]
operator|.
name|priority
expr_stmt|;
name|si_memcpy
argument_list|(
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
argument_list|,
operator|&
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|mpiMem_t
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|virtPtr
operator|=
operator|(
name|bit8
operator|*
operator|)
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|virtPtr
operator|+
name|memOffset
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|physAddrLower
operator|+=
name|memOffset
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|elementSize
operator|=
name|memSize
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|totalLength
operator|=
name|memSize
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|numElements
operator|=
literal|1
expr_stmt|;
comment|/* Initialize the local copy of PIs, CIs */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: queue %d PI CI zero\n"
operator|,
name|qIdx
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|producerIdx
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|consumerIdx
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|agRoot
operator|=
name|agRoot
expr_stmt|;
comment|/* MPI memory region for inbound CIs are 2 */
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|ciPointer
operator|=
operator|(
operator|(
operator|(
name|bit8
operator|*
operator|)
operator|(
name|memoryAllocated
operator|->
name|region
index|[
name|MPI_CI_INDEX
index|]
operator|.
name|virtPtr
operator|)
operator|)
operator|+
name|qIdx
operator|*
literal|4
operator|)
expr_stmt|;
comment|/* ... and in the local structure we will use to copy to the HW configuration table */
comment|/* CI base address */
name|inQueueCfg
operator|.
name|elementPriSizeCount
operator|=
name|config
operator|->
name|inboundQueues
index|[
name|qIdx
index|]
operator|.
name|numElements
operator||
operator|(
name|config
operator|->
name|inboundQueues
index|[
name|qIdx
index|]
operator|.
name|elementSize
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|config
operator|->
name|inboundQueues
index|[
name|qIdx
index|]
operator|.
name|priority
operator|<<
name|SHIFT30
operator|)
expr_stmt|;
name|inQueueCfg
operator|.
name|upperBaseAddress
operator|=
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|physAddrUpper
expr_stmt|;
name|inQueueCfg
operator|.
name|lowerBaseAddress
operator|=
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|physAddrLower
expr_stmt|;
name|inQueueCfg
operator|.
name|ciUpperBaseAddress
operator|=
name|memoryAllocated
operator|->
name|region
index|[
name|MPI_CI_INDEX
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|inQueueCfg
operator|.
name|ciLowerBaseAddress
operator|=
name|memoryAllocated
operator|->
name|region
index|[
name|MPI_CI_INDEX
index|]
operator|.
name|physAddrLower
operator|+
name|qIdx
operator|*
literal|4
expr_stmt|;
comment|/* write the configured data of inbound queue to SPC GSM */
name|mpiUpdateIBQueueCfgTable
argument_list|(
name|agRoot
argument_list|,
operator|&
name|inQueueCfg
argument_list|,
name|MSGUCfgTblDWIdx
argument_list|,
name|pcibar
argument_list|)
expr_stmt|;
comment|/* get inbound PI PCI Bar and Offset */
comment|/* get the PI PCI Bar offset and convert it to logical BAR */
name|IB_PIPCIBar
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|IB_PIPCI_BAR
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|PIPCIBar
operator|=
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|IB_PIPCIBar
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|PIPCIOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|IB_PIPCI_BAR_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|qNumber
operator|=
name|qIdx
expr_stmt|;
name|memOffset
operator|+=
name|memSize
expr_stmt|;
if|if
condition|(
operator|(
literal|0
operator|==
operator|(
operator|(
name|qIdx
operator|+
literal|1
operator|)
operator|%
name|MAX_QUEUE_EACH_MEM
operator|)
operator|)
operator|||
operator|(
name|qIdx
operator|==
operator|(
name|maxinbound
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|mIdx
operator|++
expr_stmt|;
name|indexoffset
operator|+=
name|MAX_QUEUE_EACH_MEM
expr_stmt|;
name|memOffset
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* else for memeory ok */
block|}
comment|/* queue enable */
block|}
comment|/* loop for inbound queue */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"73"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TP:73  outbound queues  */
comment|/* index offset */
name|indexoffset
operator|=
literal|0
expr_stmt|;
name|memOffset
operator|=
literal|0
expr_stmt|;
comment|/* Let's process the memory regions for the outbound queues */
for|for
control|(
name|qIdx
operator|=
literal|0
init|;
name|qIdx
operator|<
name|maxoutbound
condition|;
name|qIdx
operator|++
control|)
block|{
comment|/* point back to the begin then plus offset to next queue */
name|MSGUCfgTblDWIdx
operator|=
name|saveOffset
expr_stmt|;
name|MSGUCfgTblDWIdx
operator|+=
name|outboundoffset
expr_stmt|;
name|MSGUCfgTblDWIdx
operator|+=
operator|(
sizeof|sizeof
argument_list|(
name|spc_outboundQueueDescriptor_t
argument_list|)
operator|*
name|qIdx
operator|)
expr_stmt|;
comment|/* if the MPI configuration says that this queue is disabled ... */
if|if
condition|(
literal|0
operator|==
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|numElements
condition|)
block|{
comment|/* ... Clears the configuration table for this queue */
name|outQueueCfg
operator|.
name|upperBaseAddress
operator|=
literal|0
expr_stmt|;
name|outQueueCfg
operator|.
name|lowerBaseAddress
operator|=
literal|0
expr_stmt|;
name|outQueueCfg
operator|.
name|piUpperBaseAddress
operator|=
literal|0
expr_stmt|;
name|outQueueCfg
operator|.
name|piLowerBaseAddress
operator|=
literal|0
expr_stmt|;
comment|/* skip outQueueCfg.CIPCIBar = 0; read access only */
comment|/* skip outQueueCfg.CIOffset = 0; read access only */
name|outQueueCfg
operator|.
name|elementSizeCount
operator|=
literal|0
expr_stmt|;
name|outQueueCfg
operator|.
name|interruptVecCntDelay
operator|=
literal|0
expr_stmt|;
comment|/* Updated the configuration table in SPC GSM */
name|mpiUpdateOBQueueCfgTable
argument_list|(
name|agRoot
argument_list|,
operator|&
name|outQueueCfg
argument_list|,
name|MSGUCfgTblDWIdx
argument_list|,
name|pcibar
argument_list|)
expr_stmt|;
block|}
comment|/* If the outbound queue is enabled, then ... */
else|else
block|{
name|bit32
name|memSize
init|=
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|numElements
operator|*
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|elementSize
decl_stmt|;
name|bit32
name|remainder
init|=
name|memSize
operator|&
literal|127
decl_stmt|;
comment|/* Calculate the size of this queue padded to 128 bytes */
if|if
condition|(
name|remainder
operator|>
literal|0
condition|)
block|{
name|memSize
operator|+=
operator|(
literal|128
operator|-
name|remainder
operator|)
expr_stmt|;
block|}
comment|/* ... first checks that the memory region has the right size */
if|if
condition|(
operator|(
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|totalLength
operator|-
name|memOffset
operator|<
name|memSize
operator|)
operator|||
operator|(
name|NULL
operator|==
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|virtPtr
operator|)
operator|||
operator|(
literal|0
operator|==
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
operator|.
name|totalLength
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"ERROR: The memory region does not have the right size for this outbound queue"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
else|else
block|{
comment|/* Then, using the MPI configuration argument, initializes the corresponding element on the MPI context ... */
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|numElements
operator|=
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|numElements
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|elementSize
operator|=
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|elementSize
expr_stmt|;
name|si_memcpy
argument_list|(
operator|&
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
argument_list|,
operator|&
name|memoryAllocated
operator|->
name|region
index|[
name|mIdx
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|mpiMem_t
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|virtPtr
operator|=
operator|(
name|bit8
operator|*
operator|)
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|virtPtr
operator|+
name|memOffset
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|physAddrLower
operator|+=
name|memOffset
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|elementSize
operator|=
name|memSize
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|totalLength
operator|=
name|memSize
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|numElements
operator|=
literal|1
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|producerIdx
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|consumerIdx
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|agRoot
operator|=
name|agRoot
expr_stmt|;
comment|/* MPI memory region for outbound PIs are 3 */
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|piPointer
operator|=
operator|(
operator|(
operator|(
name|bit8
operator|*
operator|)
operator|(
name|memoryAllocated
operator|->
name|region
index|[
name|MPI_CI_INDEX
operator|+
literal|1
index|]
operator|.
name|virtPtr
operator|)
operator|)
operator|+
name|qIdx
operator|*
literal|4
operator|)
expr_stmt|;
comment|/* ... and in the local structure we will use to copy to the HW configuration table */
name|outQueueCfg
operator|.
name|upperBaseAddress
operator|=
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|physAddrUpper
expr_stmt|;
name|outQueueCfg
operator|.
name|lowerBaseAddress
operator|=
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|memoryRegion
operator|.
name|physAddrLower
expr_stmt|;
comment|/* PI base address */
name|outQueueCfg
operator|.
name|piUpperBaseAddress
operator|=
name|memoryAllocated
operator|->
name|region
index|[
name|MPI_CI_INDEX
operator|+
literal|1
index|]
operator|.
name|physAddrUpper
expr_stmt|;
name|outQueueCfg
operator|.
name|piLowerBaseAddress
operator|=
name|memoryAllocated
operator|->
name|region
index|[
name|MPI_CI_INDEX
operator|+
literal|1
index|]
operator|.
name|physAddrLower
operator|+
name|qIdx
operator|*
literal|4
expr_stmt|;
name|outQueueCfg
operator|.
name|elementSizeCount
operator|=
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|numElements
operator||
operator|(
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|elementSize
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
comment|/* enable/disable interrupt - use saSystemInterruptsActive() API */
comment|/* instead of ossaHwRegWrite(agRoot, MSGU_ODMR, 0); */
comment|/* Outbound Doorbell Auto disable */
comment|/* LL does not use ossaHwRegWriteExt(agRoot, PCIBAR1, SPC_ODAR, 0xffffffff); */
if|if
condition|(
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|interruptEnable
condition|)
block|{
comment|/* enable interrupt flag bit30 of outbound table */
name|outQueueCfg
operator|.
name|elementSizeCount
operator||=
name|OB_PROPERTY_INT_ENABLE
expr_stmt|;
block|}
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|outQueueCfg
operator|.
name|interruptVecCntDelay
operator|=
operator|(
operator|(
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|interruptVector
operator|&
name|INT_VEC_BITS
operator|)
operator|<<
name|SHIFT24
operator|)
expr_stmt|;
block|}
else|else
block|{
name|outQueueCfg
operator|.
name|interruptVecCntDelay
operator|=
operator|(
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|interruptDelay
operator|&
name|INT_DELAY_BITS
operator|)
operator||
operator|(
operator|(
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|interruptThreshold
operator|&
name|INT_THR_BITS
operator|)
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
operator|(
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|interruptVector
operator|&
name|INT_VEC_BITS
operator|)
operator|<<
name|SHIFT24
operator|)
expr_stmt|;
block|}
comment|/* create a VectorIndex Bit Map */
if|if
condition|(
name|qIdx
operator|<
name|OQ_NUM_32
condition|)
block|{
name|saRoot
operator|->
name|interruptVecIndexBitMap
index|[
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|interruptVector
index|]
operator||=
operator|(
literal|1
operator|<<
name|qIdx
operator|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiInitialize:below 32 saRoot->interruptVecIndexBitMap[config->outboundQueues[qIdx].interruptVector] 0x%08x\n"
operator|,
name|saRoot
operator|->
name|interruptVecIndexBitMap
index|[
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|interruptVector
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|saRoot
operator|->
name|interruptVecIndexBitMap1
index|[
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|interruptVector
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
name|qIdx
operator|-
name|OQ_NUM_32
operator|)
operator|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiInitialize:Above 32 saRoot->interruptVecIndexBitMap1[config->outboundQueues[qIdx].interruptVector] 0x%08x\n"
operator|,
name|saRoot
operator|->
name|interruptVecIndexBitMap1
index|[
name|config
operator|->
name|outboundQueues
index|[
name|qIdx
index|]
operator|.
name|interruptVector
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Update the outbound configuration table */
name|mpiUpdateOBQueueCfgTable
argument_list|(
name|agRoot
argument_list|,
operator|&
name|outQueueCfg
argument_list|,
name|MSGUCfgTblDWIdx
argument_list|,
name|pcibar
argument_list|)
expr_stmt|;
comment|/* read the CI PCIBar offset and convert it to logical bar */
name|OB_CIPCIBar
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|OB_CIPCI_BAR
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|CIPCIBar
operator|=
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|OB_CIPCIBar
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|CIPCIOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|OB_CIPCI_BAR_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|DIntTOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|OB_DYNAMIC_COALES_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|outboundQueue
index|[
name|qIdx
index|]
operator|.
name|qNumber
operator|=
name|qIdx
expr_stmt|;
name|memOffset
operator|+=
name|memSize
expr_stmt|;
if|if
condition|(
operator|(
literal|0
operator|==
operator|(
operator|(
name|qIdx
operator|+
literal|1
operator|)
operator|%
name|MAX_QUEUE_EACH_MEM
operator|)
operator|)
operator|||
operator|(
name|qIdx
operator|==
operator|(
name|maxoutbound
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|mIdx
operator|++
expr_stmt|;
name|indexoffset
operator|+=
name|MAX_QUEUE_EACH_MEM
expr_stmt|;
name|memOffset
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* calculate number of vectors */
name|saRoot
operator|->
name|numInterruptVectors
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|qIdx
operator|=
literal|0
init|;
name|qIdx
operator|<
name|MAX_NUM_VECTOR
condition|;
name|qIdx
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|saRoot
operator|->
name|interruptVecIndexBitMap
index|[
name|qIdx
index|]
operator|)
operator|||
operator|(
name|saRoot
operator|->
name|interruptVecIndexBitMap1
index|[
name|qIdx
index|]
operator|)
condition|)
block|{
operator|(
name|saRoot
operator|->
name|numInterruptVectors
operator|)
operator|++
expr_stmt|;
block|}
block|}
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiInitialize:(saRoot->numInterruptVectors) 0x%x\n"
operator|,
operator|(
name|saRoot
operator|->
name|numInterruptVectors
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/* setup interrupt vector table  */
name|mpiWrIntVecTable
argument_list|(
name|agRoot
argument_list|,
name|config
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|mpiWrAnalogSetupTable
argument_list|(
name|agRoot
argument_list|,
name|config
argument_list|)
expr_stmt|;
block|}
comment|/* setup phy analog registers */
name|mpiWriteCALAll
argument_list|(
name|agRoot
argument_list|,
operator|&
name|config
operator|->
name|phyAnalogConfig
argument_list|)
expr_stmt|;
block|{
name|bit32
name|pcibar
init|=
literal|0
decl_stmt|;
name|bit32
name|TableOffset
decl_stmt|;
name|pcibar
operator|=
name|siGetPciBar
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|TableOffset
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|TableOffset
operator|&=
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: mpiContextTable TableOffset 0x%08X contains 0x%08X\n"
operator|,
name|TableOffset
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
argument_list|)
operator|==
literal|0x53434D50
operator|)
argument_list|,
literal|"Config table signiture"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_MAIN_CONFIGURATION_TABLE           0x%08X\n"
operator|,
literal|0
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_GENERAL_STATUS_TABLE               0x%08X\n"
operator|,
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_GST_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_INBOUND_QUEUE_CONFIGURATION_TABLE  0x%08X\n"
operator|,
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_IBQ_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_OUTBOUND_QUEUE_CONFIGURATION_TABLE 0x%08X\n"
operator|,
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_OBQ_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_SAS_PHY_ANALOG_SETUP_TABLE         0x%08X\n"
operator|,
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_ANALOG_SETUP_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_INTERRUPT_VECTOR_TABLE             0x%08X\n"
operator|,
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_INT_VEC_TABLE_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_PER_SAS_PHY_ATTRIBUTE_TABLE        0x%08X\n"
operator|,
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_PHY_ATTRIBUTE_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_OUTBOUND_QUEUE_FAILOVER_TABLE      0x%08X\n"
operator|,
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_MOQFOT_MOQFOES
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
operator|->
name|swConfig
operator|.
name|mpiContextTable
condition|)
block|{
name|agsaMPIContext_t
modifier|*
name|context
init|=
operator|(
name|agsaMPIContext_t
operator|*
operator|)
name|saRoot
operator|->
name|swConfig
operator|.
name|mpiContextTable
decl_stmt|;
name|bit32
name|length
init|=
name|saRoot
operator|->
name|swConfig
operator|.
name|mpiContextTablelen
decl_stmt|;
name|bit32
name|pcibar
init|=
literal|0
decl_stmt|;
name|bit32
name|TableOffset
decl_stmt|;
name|pcibar
operator|=
name|siGetPciBar
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
name|TableOffset
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|TableOffset
operator|&=
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: mpiContextTable TableOffset 0x%08X contains 0x%08X\n"
operator|,
name|TableOffset
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
argument_list|)
operator|==
literal|0x53434D50
operator|)
argument_list|,
literal|"Config table signiture"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
argument_list|)
operator|!=
literal|0x53434D50
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: TableOffset 0x%x reads 0x%x expect 0x%x \n"
operator|,
name|TableOffset
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
argument_list|)
operator|,
literal|0x53434D50
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|context
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: MPITableType 0x%x context->offset 0x%x context->value 0x%x\n"
operator|,
name|context
operator|->
name|MPITableType
operator|,
name|context
operator|->
name|offset
operator|,
name|context
operator|->
name|value
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|length
operator|!=
literal|0
condition|)
block|{
switch|switch
condition|(
name|context
operator|->
name|MPITableType
condition|)
block|{
name|bit32
name|OffsetInMain
decl_stmt|;
case|case
name|AGSA_MPI_MAIN_CONFIGURATION_TABLE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:  AGSA_MPI_MAIN_CONFIGURATION_TABLE %d 0x%x + 0x%x = 0x%x\n"
operator|,
name|context
operator|->
name|MPITableType
operator|,
name|TableOffset
operator|,
name|context
operator|->
name|offset
operator|,
name|context
operator|->
name|value
operator|)
argument_list|)
expr_stmt|;
name|OffsetInMain
operator|=
name|TableOffset
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|OffsetInMain
operator|+
operator|(
name|context
operator|->
name|offset
operator|*
literal|4
operator|)
argument_list|,
name|context
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_MPI_GENERAL_STATUS_TABLE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_GENERAL_STATUS_TABLE %d offset 0x%x + 0x%x = 0x%x\n"
operator|,
name|context
operator|->
name|MPITableType
operator|,
name|TableOffset
operator|+
name|MAIN_GST_OFFSET
operator|,
name|context
operator|->
name|offset
operator|,
name|context
operator|->
name|value
operator|)
argument_list|)
expr_stmt|;
name|OffsetInMain
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_GST_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|+
name|TableOffset
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|OffsetInMain
operator|+
operator|(
name|context
operator|->
name|offset
operator|*
literal|4
operator|)
argument_list|,
name|context
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_MPI_INBOUND_QUEUE_CONFIGURATION_TABLE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_INBOUND_QUEUE_CONFIGURATION_TABLE %d offset 0x%x + 0x%x = 0x%x\n"
operator|,
name|context
operator|->
name|MPITableType
operator|,
name|TableOffset
operator|+
name|MAIN_IBQ_OFFSET
operator|,
name|context
operator|->
name|offset
operator|,
name|context
operator|->
name|value
operator|)
argument_list|)
expr_stmt|;
name|OffsetInMain
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_IBQ_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|+
name|TableOffset
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|OffsetInMain
operator|+
operator|(
name|context
operator|->
name|offset
operator|*
literal|4
operator|)
argument_list|,
name|context
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_MPI_OUTBOUND_QUEUE_CONFIGURATION_TABLE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_OUTBOUND_QUEUE_CONFIGURATION_TABLE %d offset 0x%x + 0x%x = 0x%x\n"
operator|,
name|context
operator|->
name|MPITableType
operator|,
name|TableOffset
operator|+
name|MAIN_OBQ_OFFSET
operator|,
name|context
operator|->
name|offset
operator|,
name|context
operator|->
name|value
operator|)
argument_list|)
expr_stmt|;
name|OffsetInMain
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_OBQ_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|+
name|TableOffset
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|OffsetInMain
operator|+
operator|(
name|context
operator|->
name|offset
operator|*
literal|4
operator|)
argument_list|,
name|context
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_MPI_SAS_PHY_ANALOG_SETUP_TABLE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_SAS_PHY_ANALOG_SETUP_TABLE %d offset 0x%x + 0x%x = 0x%x\n"
operator|,
name|context
operator|->
name|MPITableType
operator|,
name|TableOffset
operator|+
name|MAIN_ANALOG_SETUP_OFFSET
operator|,
name|context
operator|->
name|offset
operator|,
name|context
operator|->
name|value
operator|)
argument_list|)
expr_stmt|;
name|OffsetInMain
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_ANALOG_SETUP_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|+
name|TableOffset
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|OffsetInMain
operator|+
operator|(
name|context
operator|->
name|offset
operator|*
literal|4
operator|)
argument_list|,
name|context
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_MPI_INTERRUPT_VECTOR_TABLE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_INTERRUPT_VECTOR_TABLE %d offset 0x%x + 0x%x = 0x%x\n"
operator|,
name|context
operator|->
name|MPITableType
operator|,
name|TableOffset
operator|+
name|MAIN_INT_VEC_TABLE_OFFSET
operator|,
name|context
operator|->
name|offset
operator|,
name|context
operator|->
name|value
operator|)
argument_list|)
expr_stmt|;
name|OffsetInMain
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_INT_VEC_TABLE_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|+
name|TableOffset
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|OffsetInMain
operator|+
operator|(
name|context
operator|->
name|offset
operator|*
literal|4
operator|)
argument_list|,
name|context
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_MPI_PER_SAS_PHY_ATTRIBUTE_TABLE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_PER_SAS_PHY_ATTRIBUTE_TABLE %d offset 0x%x + 0x%x = 0x%x\n"
operator|,
name|context
operator|->
name|MPITableType
operator|,
name|TableOffset
operator|+
name|MAIN_PHY_ATTRIBUTE_OFFSET
operator|,
name|context
operator|->
name|offset
operator|,
name|context
operator|->
name|value
operator|)
argument_list|)
expr_stmt|;
name|OffsetInMain
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_PHY_ATTRIBUTE_OFFSET
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|+
name|TableOffset
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|OffsetInMain
operator|+
operator|(
name|context
operator|->
name|offset
operator|*
literal|4
operator|)
argument_list|,
name|context
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_MPI_OUTBOUND_QUEUE_FAILOVER_TABLE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: AGSA_MPI_OUTBOUND_QUEUE_FAILOVER_TABLE %d offset 0x%x + 0x%x = 0x%x\n"
operator|,
name|context
operator|->
name|MPITableType
operator|,
name|TableOffset
operator|+
name|MAIN_MOQFOT_MOQFOES
operator|,
name|context
operator|->
name|offset
operator|,
name|context
operator|->
name|value
operator|)
argument_list|)
expr_stmt|;
name|OffsetInMain
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_MOQFOT_MOQFOES
argument_list|)
operator|&
literal|0xFFFF
operator|)
operator|+
name|TableOffset
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|OffsetInMain
operator|+
operator|(
name|context
operator|->
name|offset
operator|*
literal|4
operator|)
argument_list|,
name|context
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: error MPITableType unknown %d offset 0x%x value 0x%x\n"
operator|,
name|context
operator|->
name|MPITableType
operator|,
name|context
operator|->
name|offset
operator|,
name|context
operator|->
name|value
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|smIS_SPC12V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|fwInterfaceRev
operator|>
literal|0x301
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: MAIN_AWT_MIDRANGE 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
operator|+
name|MAIN_AWT_MIDRANGE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|length
operator|>=
sizeof|sizeof
argument_list|(
name|agsaMPIContext_t
argument_list|)
condition|)
block|{
name|length
operator|-=
sizeof|sizeof
argument_list|(
name|agsaMPIContext_t
argument_list|)
expr_stmt|;
name|context
operator|++
expr_stmt|;
block|}
else|else
block|{
name|length
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:  context %p saRoot->swConfig.mpiContextTable %p %d\n"
operator|,
name|context
operator|,
name|saRoot
operator|->
name|swConfig
operator|.
name|mpiContextTable
operator|,
name|context
operator|==
name|saRoot
operator|->
name|swConfig
operator|.
name|mpiContextTable
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
argument_list|)
operator|!=
literal|0x53434D50
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:TableOffset 0x%x reads 0x%x expect 0x%x \n"
operator|,
name|TableOffset
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
argument_list|)
operator|,
literal|0x53434D50
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_ASSERT
argument_list|(
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|TableOffset
argument_list|)
operator|==
literal|0x53434D50
operator|)
argument_list|,
literal|"Config table signiture After"
argument_list|)
expr_stmt|;
block|}
comment|/* At this point the Message Unit configuration table is set up. Now we need to ring the doorbell */
name|togglevalue
operator|=
literal|0
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"74"
argument_list|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_IBDB_SET
argument_list|,
name|MSGU_IBDB_SET
argument_list|)
argument_list|)
expr_stmt|;
comment|/* TP:74 Doorbell */
comment|/* Write bit0=1 to Inbound DoorBell Register to tell the SPC FW the table is updated */
name|siHalRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_IBDB_SET
argument_list|,
name|MSGU_IBDB_SET
argument_list|,
name|SPC_MSGU_CFG_TABLE_UPDATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_IBDB_SET
argument_list|,
name|MSGU_IBDB_SET
argument_list|)
operator|&
name|SPC_MSGU_CFG_TABLE_UPDATE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: SPC_MSGU_CFG_TABLE_UPDATE (0x%X) \n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_IBDB_SET
argument_list|,
name|MSGU_IBDB_SET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: SPC_MSGU_CFG_TABLE_UPDATE not set (0x%X)\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_IBDB_SET
argument_list|,
name|MSGU_IBDB_SET
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
block|}
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"A5"
argument_list|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_IBDB_SET
argument_list|,
name|MSGU_IBDB_SET
argument_list|)
argument_list|)
expr_stmt|;
comment|/* TP:A5 Doorbell */
comment|/* //  ossaHwRegWrite(agRoot, MSGU_IBDB_SET, SPC_MSGU_CFG_TABLE_UPDATE);   MSGU_WRITE_IDR(SPC_MSGU_CFG_TABLE_UPDATE); */
comment|/* wait until Inbound DoorBell Clear Register toggled */
name|WaitLonger
label|:
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_2
argument_list|)
expr_stmt|;
comment|/* 2 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|value
operator|=
name|MSGU_READ_IDR
expr_stmt|;
name|value
operator|&=
name|SPC_MSGU_CFG_TABLE_UPDATE
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|value
operator|!=
name|togglevalue
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"80"
argument_list|,
name|max_wait_count
argument_list|)
expr_stmt|;
comment|/* TP:80 TP max_wait_count */
if|if
condition|(
operator|!
name|max_wait_count
operator|&&
name|mpiStartToggleFailed
operator|<
literal|5
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: mpiStartToggleFailed  count %d\n"
operator|,
name|mpiStartToggleFailed
operator|)
argument_list|)
expr_stmt|;
name|mpiStartToggleFailed
operator|++
expr_stmt|;
goto|goto
name|WaitLonger
goto|;
block|}
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: TIMEOUT:IBDB value/toggle = 0x%x 0x%x\n"
operator|,
name|value
operator|,
name|togglevalue
operator|)
argument_list|)
expr_stmt|;
name|MSGUCfgTblDWIdx
operator|=
name|saveOffset
expr_stmt|;
name|GSTLenMPIS
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|MSGUCfgTblDWIdx
operator|+
call|(
name|bit32
call|)
argument_list|(
name|mainCfg
operator|.
name|GSTOffset
operator|+
name|GST_GSTLEN_MPIS_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: MPI State = 0x%x\n"
operator|,
name|GSTLenMPIS
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"81"
argument_list|,
name|mpiStartToggleFailed
argument_list|)
expr_stmt|;
comment|/* TP:81 TP */
comment|/* check the MPI-State for initialization */
name|MSGUCfgTblDWIdx
operator|=
name|saveOffset
expr_stmt|;
name|GSTLenMPIS
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|MSGUCfgTblDWIdx
operator|+
call|(
name|bit32
call|)
argument_list|(
name|mainCfg
operator|.
name|GSTOffset
operator|+
name|GST_GSTLEN_MPIS_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|GST_MPI_STATE_UNINIT
operator|==
operator|(
name|GSTLenMPIS
operator|&
name|GST_MPI_STATE_MASK
operator|)
operator|)
operator|&&
operator|(
name|mpiUnInitFailed
operator|<
literal|5
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: MPI State = 0x%x mpiUnInitFailed count %d\n"
operator|,
name|GSTLenMPIS
operator|&
name|GST_MPI_STATE_MASK
operator|,
name|mpiUnInitFailed
operator|)
argument_list|)
expr_stmt|;
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
operator|(
literal|20
operator|*
literal|1000
operator|)
argument_list|)
expr_stmt|;
name|mpiUnInitFailed
operator|++
expr_stmt|;
goto|goto
name|WaitLonger
goto|;
block|}
if|if
condition|(
name|GST_MPI_STATE_INIT
operator|!=
operator|(
name|GSTLenMPIS
operator|&
name|GST_MPI_STATE_MASK
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: Error Not GST_MPI_STATE_INIT MPI State = 0x%x\n"
operator|,
name|GSTLenMPIS
operator|&
name|GST_MPI_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'g'
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"82"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TP:82 TP */
comment|/* check MPI Initialization error */
name|GSTLenMPIS
operator|=
name|GSTLenMPIS
operator|>>
name|SHIFT16
expr_stmt|;
if|if
condition|(
literal|0x0000
operator|!=
name|GSTLenMPIS
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: MPI Error = 0x%x\n"
operator|,
name|GSTLenMPIS
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'h'
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"83"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TP:83 TP */
comment|/* reread IQ PI offset from SPC if IQ/OQ> 32 */
if|if
condition|(
operator|(
name|maxinbound
operator|>
name|IQ_NUM_32
operator|)
operator|||
operator|(
name|maxoutbound
operator|>
name|OQ_NUM_32
operator|)
condition|)
block|{
for|for
control|(
name|qIdx
operator|=
literal|0
init|;
name|qIdx
operator|<
name|maxinbound
condition|;
name|qIdx
operator|++
control|)
block|{
comment|/* point back to the begin then plus offset to next queue */
name|MSGUCfgTblDWIdx
operator|=
name|saveOffset
expr_stmt|;
name|MSGUCfgTblDWIdx
operator|+=
name|inboundoffset
expr_stmt|;
name|MSGUCfgTblDWIdx
operator|+=
operator|(
sizeof|sizeof
argument_list|(
name|spc_inboundQueueDescriptor_t
argument_list|)
operator|*
name|qIdx
operator|)
expr_stmt|;
name|saRoot
operator|->
name|inboundQueue
index|[
name|qIdx
index|]
operator|.
name|PIPCIOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|IB_PIPCI_BAR_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"84"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TP:84 TP */
comment|/* at least one inbound queue and one outbound queue enabled */
if|if
condition|(
operator|(
literal|0
operator|==
name|config
operator|->
name|inboundQueues
index|[
literal|0
index|]
operator|.
name|numElements
operator|)
operator|||
operator|(
literal|0
operator|==
name|config
operator|->
name|outboundQueues
index|[
literal|0
index|]
operator|.
name|numElements
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: Error,IQ0 or OQ0 have to enable\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'i'
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"85"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TP:85 TP */
comment|/* clean the inbound queues */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|config
operator|->
name|numInboundQueues
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
literal|0
operator|!=
name|config
operator|->
name|inboundQueues
index|[
name|i
index|]
operator|.
name|numElements
condition|)
block|{
name|circularIQ
operator|=
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|i
index|]
expr_stmt|;
name|si_memset
argument_list|(
name|circularIQ
operator|->
name|memoryRegion
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|circularIQ
operator|->
name|memoryRegion
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
name|saRoot
operator|->
name|inboundQueue
index|[
name|i
index|]
operator|.
name|ciPointer
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|ossaHwRegWriteExt
argument_list|(
name|circularIQ
operator|->
name|agRoot
argument_list|,
name|circularIQ
operator|->
name|PIPCIBar
argument_list|,
name|circularIQ
operator|->
name|PIPCIOffset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize:  SPC V writes IQ %2d offset 0x%x\n"
operator|,
name|i
operator|,
name|circularIQ
operator|->
name|PIPCIOffset
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"86"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TP:86 TP */
comment|/* clean the outbound queues */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|config
operator|->
name|numOutboundQueues
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
literal|0
operator|!=
name|config
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|numElements
condition|)
block|{
name|circularOQ
operator|=
operator|&
name|saRoot
operator|->
name|outboundQueue
index|[
name|i
index|]
expr_stmt|;
name|si_memset
argument_list|(
name|circularOQ
operator|->
name|memoryRegion
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|circularOQ
operator|->
name|memoryRegion
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
name|saRoot
operator|->
name|outboundQueue
index|[
name|i
index|]
operator|.
name|piPointer
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|ossaHwRegWriteExt
argument_list|(
name|circularOQ
operator|->
name|agRoot
argument_list|,
name|circularOQ
operator|->
name|CIPCIBar
argument_list|,
name|circularOQ
operator|->
name|CIPCIOffset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiInitialize:  SPC V writes OQ %2d offset 0x%x\n"
operator|,
name|i
operator|,
name|circularOQ
operator|->
name|CIPCIOffset
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"75"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TP:75 AAP1 IOP */
comment|/* read back AAP1 and IOP event log address and size */
name|MSGUCfgTblDWIdx
operator|=
name|saveOffset
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_ADDR_HI
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|upperEventLogAddress
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: upperEventLogAddress 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_ADDR_LO
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|lowerEventLogAddress
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: lowerEventLogAddress 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_BUFF_SIZE
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|eventLogSize
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: eventLogSize 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_EVENT_LOG_OPTION
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|eventLogOption
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: eventLogOption 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: EventLog dd /p %08X`%08X L %x\n"
operator|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|upperEventLogAddress
operator|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|lowerEventLogAddress
operator|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|eventLogSize
operator|/
literal|4
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_ADDR_HI
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|upperIOPeventLogAddress
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: upperIOPLogAddress 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_ADDR_LO
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|lowerIOPeventLogAddress
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: lowerIOPLogAddress 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: IOPLog   dd /p %08X`%08X L %x\n"
operator|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|upperIOPeventLogAddress
operator|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|lowerIOPeventLogAddress
operator|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|IOPeventLogSize
operator|/
literal|4
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_BUFF_SIZE
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|IOPeventLogSize
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: IOPeventLogSize 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IOP_EVENT_LOG_OPTION
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|IOPeventLogOption
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: IOPeventLogOption 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_INTERRUPT
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_PRINTOUT_IN_WINDBG
ifndef|#
directive|ifndef
name|DBG
name|DbgPrint
argument_list|(
literal|"mpiInitialize: EventLog (%d) dd /p %08X`%08X L %x\n"
argument_list|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|eventLogOption
argument_list|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|upperEventLogAddress
argument_list|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|lowerEventLogAddress
argument_list|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|eventLogSize
operator|/
literal|4
argument_list|)
expr_stmt|;
name|DbgPrint
argument_list|(
literal|"mpiInitialize: IOPLog   (%d) dd /p %08X`%08X L %x\n"
argument_list|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|IOPeventLogOption
argument_list|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|upperIOPeventLogAddress
argument_list|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|lowerIOPeventLogAddress
argument_list|,
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|IOPeventLogSize
operator|/
literal|4
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DBG  */
endif|#
directive|endif
comment|/* SA_PRINTOUT_IN_WINDBG  */
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorInterrupt
operator|=
name|value
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"76"
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* TP:76 FatalErrorInterrupt */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: hwConfig->hwOption %X\n"
operator|,
name|saRoot
operator|->
name|hwConfig
operator|.
name|hwOption
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: FatalErrorInterrupt 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
comment|/* read back Register Dump offset and length */
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_RDUMP0_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpOffset0
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: FatalErrorDumpOffset0 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_RDUMP0_LENGTH
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpLength0
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: FatalErrorDumpLength0 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_RDUMP1_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpOffset1
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: FatalErrorDumpOffset1 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_RDUMP1_LENGTH
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpLength1
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: FatalErrorDumpLength1 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_PRECTD_PRESETD
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|PortRecoveryTimerPortResetTimer
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: PortRecoveryTimerPortResetTimer 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|MSGUCfgTblDWIdx
operator|+
name|MAIN_IRAD_RESERVED
argument_list|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|InterruptReassertionDelay
operator|=
name|value
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: InterruptReassertionDelay 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|bit32
name|sp1
decl_stmt|;
name|sp1
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
expr_stmt|;
if|if
condition|(
name|SCRATCH_PAD1_V_ERROR_STATE
argument_list|(
name|sp1
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiInitialize: SCRATCH_PAD1_V_ERROR_STAT 0x%x\n"
operator|,
name|sp1
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'j'
argument_list|,
literal|"m3"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn mpiWaitForConfigTable(agsaRoot_t *agRoot, spc_configMainDescriptor_t *config)  *  \brief Reading and Writing the Configuration Table  *  \param agsaRoot Pointer to a data structure containing LL layer context handles  *  \param config   Pointer to Configuration Table  *  * Return:  *         AGSA_RC_SUCCESS if read the configuration table from SPC sucessful  *         AGSA_RC_FAILURE if read the configuration table from SPC failed  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiWaitForConfigTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|spc_configMainDescriptor_t
modifier|*
name|config
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|bit32
name|MSGUCfgTblBase
decl_stmt|,
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|bit32
name|CfgTblDWIdx
decl_stmt|;
name|bit32
name|value
decl_stmt|,
name|value1
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
name|bit32
name|Signature
decl_stmt|,
name|ExpSignature
decl_stmt|;
name|bit8
name|pcibar
decl_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Entering\n"
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|NULL
operator|!=
name|agRoot
argument_list|,
literal|"agRoot argument cannot be null"
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
comment|/* check error state */
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_1
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
name|value1
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_2
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Waiting for SPC FW becoming ready.P1 0x%X P2 0x%X\n"
operator|,
name|value
operator|,
name|value1
operator|)
argument_list|)
expr_stmt|;
comment|/* check AAP error */
if|if
condition|(
name|SCRATCH_PAD1_ERR
operator|==
operator|(
name|value
operator|&
name|SCRATCH_PAD_STATE_MASK
operator|)
condition|)
block|{
comment|/* error state */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: AAP error state and code 0x%x, ScratchPad2=0x%x\n"
operator|,
name|value
operator|,
name|value1
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_3
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* check IOP error */
if|if
condition|(
name|SCRATCH_PAD2_ERR
operator|==
operator|(
name|value1
operator|&
name|SCRATCH_PAD_STATE_MASK
operator|)
condition|)
block|{
comment|/* error state */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: IOP error state and code 0x%x, ScratchPad1=0x%x\n"
operator|,
name|value1
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_3
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* bit 4-31 of scratch pad1 should be zeros if it is not in error state */
ifdef|#
directive|ifdef
name|DONT_DO
comment|/*                                                                        */
if|if
condition|(
name|value
operator|&
name|SCRATCH_PAD1_STATE_MASK
condition|)
block|{
comment|/* error case */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: wrong state failure, scratchPad1 0x%x\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: ScratchPad0 AAP error code 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_2
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_3
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* bit 4-31 of scratch pad2 should be zeros if it is not in error state */
if|if
condition|(
name|value1
operator|&
name|SCRATCH_PAD2_STATE_MASK
condition|)
block|{
comment|/* error case */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: wrong state failure, scratchPad2 0x%x\n"
operator|,
name|value1
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: ScratchPad3 IOP error code 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_3
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_1
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
endif|#
directive|endif
comment|/* DONT_DO */
comment|/* checking the fw and IOP in ready state */
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_2
argument_list|)
expr_stmt|;
comment|/* 2 sec timeout */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
comment|/* wait until scratch pad 1 and 2 registers in ready state  */
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_1
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|&
name|SCRATCH_PAD1_RDY
expr_stmt|;
name|value1
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_2
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
operator|&
name|SCRATCH_PAD2_RDY
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable:VEN_DEV_SPCV force  SCRATCH_PAD2 RDY 1 %08X 2 %08X\n"
operator|,
name|value
operator|,
name|value1
operator|)
argument_list|)
expr_stmt|;
name|value1
operator|=
literal|3
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
operator|==
literal|0
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Timeout!! SCRATCH_PAD1/2 value = 0x%x 0x%x\n"
operator|,
name|value
operator|,
name|value1
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
operator|(
name|value
operator|!=
name|SCRATCH_PAD1_RDY
operator|)
operator|||
operator|(
name|value1
operator|!=
name|SCRATCH_PAD2_RDY
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: timeout failure\n"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_3
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|(
name|value
operator|&
name|SCRATCH_PAD1_V_BOOTSTATE_HDA_SEEPROM
operator|)
operator|==
name|SCRATCH_PAD1_V_BOOTSTATE_HDA_SEEPROM
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: HDA mode set in SEEPROM SP1 0x%X\n"
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|value
operator|&
name|SCRATCH_PAD1_V_READY
operator|)
operator|!=
name|SCRATCH_PAD1_V_READY
operator|)
operator|||
operator|(
name|value
operator|==
literal|0xffffffff
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Waiting for _V_ FW becoming ready.P1 0x%X P2 0x%X\n"
operator|,
name|value
operator|,
name|value1
operator|)
argument_list|)
expr_stmt|;
comment|/* checking the fw and IOP in ready state */
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_2
argument_list|)
expr_stmt|;
comment|/* 2 sec timeout */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
comment|/* wait until scratch pad 1 and 2 registers in ready state  */
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_1
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
name|value1
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_2
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
operator|==
literal|0
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Timeout!! SCRATCH_PAD1/2 value = 0x%x 0x%x\n"
operator|,
name|value
operator|,
name|value1
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
do|while
condition|(
operator|(
operator|(
name|value
operator|&
name|SCRATCH_PAD1_V_READY
operator|)
operator|!=
name|SCRATCH_PAD1_V_READY
operator|)
operator|||
operator|(
name|value
operator|==
literal|0xffffffff
operator|)
condition|)
do|;
block|}
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: FW Ready, SCRATCH_PAD1/2 value = 0x%x 0x%x\n"
operator|,
name|value
operator|,
name|value1
operator|)
argument_list|)
expr_stmt|;
comment|/* read scratch pad0 to get PCI BAR and offset of configuration table */
name|MSGUCfgTblBase
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
comment|/* get offset */
name|CfgTblDWIdx
operator|=
name|MSGUCfgTblBase
operator|&
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
comment|/* get PCI BAR */
name|MSGUCfgTblBase
operator|=
operator|(
name|MSGUCfgTblBase
operator|&
name|SCRATCH_PAD0_BAR_MASK
operator|)
operator|>>
name|SHIFT26
expr_stmt|;
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|smIS_spc8081
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|BAR4
operator|!=
name|MSGUCfgTblBase
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: smIS_spc8081 PCI BAR is not BAR4, bar=0x%x - failure\n"
operator|,
name|MSGUCfgTblBase
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|BAR5
operator|!=
name|MSGUCfgTblBase
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: PCI BAR is not BAR5, bar=0x%x - failure\n"
operator|,
name|MSGUCfgTblBase
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'g'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
block|}
comment|/* convert the PCI BAR to logical bar number */
name|pcibar
operator|=
operator|(
name|bit8
operator|)
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|MSGUCfgTblBase
argument_list|)
expr_stmt|;
comment|/* read signature from the configuration table */
name|Signature
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
argument_list|)
expr_stmt|;
comment|/* Error return if the signature is not "PMCS" */
name|ExpSignature
operator|=
operator|(
literal|'P'
operator|)
operator||
operator|(
literal|'M'
operator|<<
name|SHIFT8
operator|)
operator||
operator|(
literal|'C'
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
literal|'S'
operator|<<
name|SHIFT24
operator|)
expr_stmt|;
if|if
condition|(
name|Signature
operator|!=
name|ExpSignature
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Signature value = 0x%x\n"
operator|,
name|Signature
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'h'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* save Signature */
name|si_memcpy
argument_list|(
operator|&
name|config
operator|->
name|Signature
argument_list|,
operator|&
name|Signature
argument_list|,
sizeof|sizeof
argument_list|(
name|Signature
argument_list|)
argument_list|)
expr_stmt|;
comment|/* read Interface Revsion from the configuration table */
name|config
operator|->
name|InterfaceRev
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_INTERFACE_REVISION
argument_list|)
expr_stmt|;
comment|/* read FW Revsion from the configuration table */
name|config
operator|->
name|FWRevision
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_FW_REVISION
argument_list|)
expr_stmt|;
comment|/* read Max Outstanding IO from the configuration table */
name|config
operator|->
name|MaxOutstandingIO
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_MAX_OUTSTANDING_IO_OFFSET
argument_list|)
expr_stmt|;
comment|/* read Max SGL and Max Devices from the configuration table */
name|config
operator|->
name|MDevMaxSGL
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_MAX_SGL_OFFSET
argument_list|)
expr_stmt|;
comment|/* read Controller Cap Flags from the configuration table */
name|config
operator|->
name|ContrlCapFlag
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_CNTRL_CAP_OFFSET
argument_list|)
expr_stmt|;
comment|/* read GST Table Offset from the configuration table */
name|config
operator|->
name|GSTOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_GST_OFFSET
argument_list|)
expr_stmt|;
comment|/* read Inbound Queue Offset from the configuration table */
name|config
operator|->
name|inboundQueueOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_IBQ_OFFSET
argument_list|)
expr_stmt|;
comment|/* read Outbound Queue Offset from the configuration table */
name|config
operator|->
name|outboundQueueOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_OBQ_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
empty_stmt|;
comment|/* SPCV - reserved field */
block|}
else|else
block|{
comment|/* read HDA Flags from the configuration table */
name|config
operator|->
name|HDAModeFlags
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_HDA_FLAGS_OFFSET
argument_list|)
expr_stmt|;
block|}
comment|/* read analog Setting offset from the configuration table */
name|config
operator|->
name|analogSetupTblOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_ANALOG_SETUP_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
empty_stmt|;
comment|/* SPCV - reserved field */
comment|/* read interrupt vector table offset */
name|config
operator|->
name|InterruptVecTblOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_INT_VEC_TABLE_OFFSET
argument_list|)
expr_stmt|;
comment|/* read phy attribute table offset */
name|config
operator|->
name|phyAttributeTblOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_PHY_ATTRIBUTE_OFFSET
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: INT Vector Tble Offset = 0x%x\n"
operator|,
name|config
operator|->
name|InterruptVecTblOffset
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Phy Attribute Tble Offset = 0x%x\n"
operator|,
name|config
operator|->
name|phyAttributeTblOffset
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
empty_stmt|;
comment|/* SPC - Not used */
block|}
comment|/* read Error Dump Offset and Length */
name|config
operator|->
name|FatalErrorDumpOffset0
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_RDUMP0_OFFSET
argument_list|)
expr_stmt|;
name|config
operator|->
name|FatalErrorDumpLength0
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_RDUMP0_LENGTH
argument_list|)
expr_stmt|;
name|config
operator|->
name|FatalErrorDumpOffset1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_RDUMP1_OFFSET
argument_list|)
expr_stmt|;
name|config
operator|->
name|FatalErrorDumpLength1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_FATAL_ERROR_RDUMP1_LENGTH
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Interface Revision value = 0x%08x\n"
operator|,
name|config
operator|->
name|InterfaceRev
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: FW Revision value = 0x%08x\n"
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%08x\n"
operator|,
name|STSDK_LL_SPC_VERSION
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIS_SPC6V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%08x\n"
operator|,
name|STSDK_LL_VERSION
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIS_SPC12V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%08x\n"
operator|,
name|STSDK_LL_12G_VERSION
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: MaxOutstandingIO value = 0x%08x\n"
operator|,
name|config
operator|->
name|MaxOutstandingIO
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: MDevMaxSGL value = 0x%08x\n"
operator|,
name|config
operator|->
name|MDevMaxSGL
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: ContrlCapFlag value = 0x%08x\n"
operator|,
name|config
operator|->
name|ContrlCapFlag
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: GSTOffset value = 0x%08x\n"
operator|,
name|config
operator|->
name|GSTOffset
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: inboundQueueOffset value = 0x%08x\n"
operator|,
name|config
operator|->
name|inboundQueueOffset
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: outboundQueueOffset value = 0x%08x\n"
operator|,
name|config
operator|->
name|outboundQueueOffset
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: FatalErrorDumpOffset0 value = 0x%08x\n"
operator|,
name|config
operator|->
name|FatalErrorDumpOffset0
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: FatalErrorDumpLength0 value = 0x%08x\n"
operator|,
name|config
operator|->
name|FatalErrorDumpLength0
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: FatalErrorDumpOffset1 value = 0x%08x\n"
operator|,
name|config
operator|->
name|FatalErrorDumpOffset1
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: FatalErrorDumpLength1 value = 0x%08x\n"
operator|,
name|config
operator|->
name|FatalErrorDumpLength1
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: HDAModeFlags value = 0x%08x\n"
operator|,
name|config
operator|->
name|HDAModeFlags
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: analogSetupTblOffset value = 0x%08x\n"
operator|,
name|config
operator|->
name|analogSetupTblOffset
operator|)
argument_list|)
expr_stmt|;
comment|/* check interface version */
if|if
condition|(
name|smIS_SPC6V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|config
operator|->
name|InterfaceRev
operator|!=
name|STSDK_LL_INTERFACE_VERSION
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: V sTSDK interface ver. 0x%x does not match InterfaceRev 0x%x warning!\n"
operator|,
name|STSDK_LL_INTERFACE_VERSION
operator|,
name|config
operator|->
name|InterfaceRev
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_UNTESTED
expr_stmt|;
if|if
condition|(
operator|(
name|config
operator|->
name|InterfaceRev
operator|&
name|STSDK_LL_INTERFACE_VERSION_IGNORE_MASK
operator|)
operator|!=
operator|(
name|STSDK_LL_INTERFACE_VERSION
operator|&
name|STSDK_LL_INTERFACE_VERSION_IGNORE_MASK
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: V sTSDK interface ver. 0x%x incompatible with InterfaceRev 0x%x warning!\n"
operator|,
name|STSDK_LL_INTERFACE_VERSION
operator|,
name|config
operator|->
name|InterfaceRev
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_INCOMPATIBLE
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'i'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|smIS_SPC12V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|config
operator|->
name|InterfaceRev
operator|!=
name|STSDK_LL_12G_INTERFACE_VERSION
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: 12g V sTSDK interface ver. 0x%x does not match InterfaceRev 0x%x warning!\n"
operator|,
name|STSDK_LL_12G_INTERFACE_VERSION
operator|,
name|config
operator|->
name|InterfaceRev
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_UNTESTED
expr_stmt|;
if|if
condition|(
operator|(
name|config
operator|->
name|InterfaceRev
operator|&
name|STSDK_LL_INTERFACE_VERSION_IGNORE_MASK
operator|)
operator|!=
operator|(
name|STSDK_LL_12G_INTERFACE_VERSION
operator|&
name|STSDK_LL_INTERFACE_VERSION_IGNORE_MASK
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: V sTSDK interface ver. 0x%x incompatible with InterfaceRev 0x%x warning!\n"
operator|,
name|STSDK_LL_12G_INTERFACE_VERSION
operator|,
name|config
operator|->
name|InterfaceRev
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_INCOMPATIBLE
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_UNTESTED
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'j'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|config
operator|->
name|InterfaceRev
operator|!=
name|STSDK_LL_OLD_INTERFACE_VERSION
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: SPC sTSDK interface ver. 0x%08x not compatible with InterfaceRev 0x%x warning!\n"
operator|,
name|STSDK_LL_INTERFACE_VERSION
operator|,
name|config
operator|->
name|InterfaceRev
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_INCOMPATIBLE
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'k'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
comment|/* Check FW versions */
if|if
condition|(
name|smIS_SPC6V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable:6 sTSDK ver. sa.h 0x%08x config 0x%08x\n"
operator|,
name|STSDK_LL_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
comment|/* check FW and LL sTSDK version */
if|if
condition|(
name|config
operator|->
name|FWRevision
operator|!=
name|MATCHING_V_FW_VERSION
condition|)
block|{
if|if
condition|(
name|config
operator|->
name|FWRevision
operator|>
name|MATCHING_V_FW_VERSION
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%x hadn't tested with FW ver. 0x%08x warning!\n"
operator|,
name|STSDK_LL_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_UNTESTED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config
operator|->
name|FWRevision
operator|<
name|MIN_FW_SPCVE_VERSION_SUPPORTED
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%x not compatible with FW ver. 0x%08x warning!\n"
operator|,
name|STSDK_LL_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_INCOMPATIBLE
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'l'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%x mismatch with FW ver. 0x%08x warning!\n"
operator|,
name|STSDK_LL_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_UNTESTED
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|smIS_SPC12V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable:12 sTSDK ver. sa.h 0x%08x config 0x%08x\n"
operator|,
name|STSDK_LL_12G_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
comment|/* check FW and LL sTSDK version */
if|if
condition|(
name|config
operator|->
name|FWRevision
operator|!=
name|MATCHING_12G_V_FW_VERSION
condition|)
block|{
if|if
condition|(
name|config
operator|->
name|FWRevision
operator|>
name|MATCHING_12G_V_FW_VERSION
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%x hadn't tested with FW ver. 0x%08x warning!\n"
operator|,
name|STSDK_LL_12G_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_UNTESTED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config
operator|->
name|FWRevision
operator|<
name|MIN_FW_12G_SPCVE_VERSION_SUPPORTED
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%x not compatible with FW ver. 0x%08x warning!\n"
operator|,
name|STSDK_LL_12G_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_INCOMPATIBLE
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'m'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%x mismatch with FW ver. 0x%08x warning!\n"
operator|,
name|STSDK_LL_12G_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_UNTESTED
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|config
operator|->
name|FWRevision
operator|!=
name|MATCHING_SPC_FW_VERSION
condition|)
block|{
if|if
condition|(
name|config
operator|->
name|FWRevision
operator|>
name|MATCHING_SPC_FW_VERSION
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%x hadn't tested with FW ver. 0x%08x warning!\n"
operator|,
name|STSDK_LL_SPC_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_UNTESTED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config
operator|->
name|FWRevision
operator|<
name|MIN_FW_SPC_VERSION_SUPPORTED
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%x not compatible with FW ver. 0x%08x warning!\n"
operator|,
name|STSDK_LL_SPC_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_INCOMPATIBLE
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'n'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sTSDK ver. 0x%x mismatch with FW ver. 0x%08x warning!\n"
operator|,
name|STSDK_LL_SPC_VERSION
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_VERSION_UNTESTED
expr_stmt|;
block|}
block|}
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: ILA version 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_ILAT_ILAV_ILASMRN_ILAMRN_ILAMJN
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPC12V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|config
operator|->
name|InterfaceRev
operator|>
literal|0x301
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: MAIN_INACTIVE_ILA_REVSION 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_INACTIVE_ILA_REVSION
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: MAIN_SEEPROM_REVSION 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_SEEPROM_REVSION
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|smIS_SPC12V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
name|config
operator|->
name|InterfaceRev
operator|>
literal|0x301
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: MAIN_AWT_MIDRANGE 0x%08X\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_AWT_MIDRANGE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|smIS_SFC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/* always success for SFC*/
name|ret
operator|=
name|AGSA_RC_SUCCESS
expr_stmt|;
block|}
if|if
condition|(
name|agNULL
operator|!=
name|saRoot
condition|)
block|{
comment|/* save the information */
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|signature
operator|=
name|Signature
expr_stmt|;
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|fwInterfaceRev
operator|=
name|config
operator|->
name|InterfaceRev
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|hwRevision
operator|=
operator|(
name|ossaHwRegReadConfig32
argument_list|(
name|agRoot
argument_list|,
literal|8
argument_list|)
operator|&
literal|0xFF
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: hwRevision 0x%x\n"
operator|,
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|hwRevision
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|hwRevision
operator|=
name|SPC_READ_DEV_REV
expr_stmt|;
block|}
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|fwRevision
operator|=
name|config
operator|->
name|FWRevision
expr_stmt|;
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|ilaRevision
operator|=
name|config
operator|->
name|ilaRevision
expr_stmt|;
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|maxPendingIO
operator|=
name|config
operator|->
name|MaxOutstandingIO
expr_stmt|;
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|maxSgElements
operator|=
name|config
operator|->
name|MDevMaxSGL
operator|&
literal|0xFFFF
expr_stmt|;
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|maxDevices
operator|=
operator|(
name|config
operator|->
name|MDevMaxSGL
operator|&
name|MAX_DEV_BITS
operator|)
operator|>>
name|SHIFT16
expr_stmt|;
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|queueSupport
operator|=
name|config
operator|->
name|ContrlCapFlag
operator|&
name|Q_SUPPORT_BITS
expr_stmt|;
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|phyCount
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|config
operator|->
name|ContrlCapFlag
operator|&
name|PHY_COUNT_BITS
operator|)
operator|>>
name|SHIFT19
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|sasSpecsSupport
operator|=
operator|(
name|config
operator|->
name|ContrlCapFlag
operator|&
name|SAS_SPEC_BITS
operator|)
operator|>>
name|SHIFT25
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: MaxOutstandingIO 0x%x swConfig->maxActiveIOs 0x%x\n"
operator|,
name|config
operator|->
name|MaxOutstandingIO
operator|,
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
empty_stmt|;
comment|/* SPCV - reserved field */
block|}
else|else
block|{
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|controllerSetting
operator|=
operator|(
name|bit8
operator|)
name|config
operator|->
name|HDAModeFlags
expr_stmt|;
block|}
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|sdkInterfaceRev
operator|=
name|STSDK_LL_INTERFACE_VERSION
expr_stmt|;
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|sdkRevision
operator|=
name|STSDK_LL_VERSION
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|regDumpPCIBAR
operator|=
name|pcibar
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpOffset0
operator|=
name|config
operator|->
name|FatalErrorDumpOffset0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpLength0
operator|=
name|config
operator|->
name|FatalErrorDumpLength0
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpOffset1
operator|=
name|config
operator|->
name|FatalErrorDumpOffset1
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|FatalErrorDumpLength1
operator|=
name|config
operator|->
name|FatalErrorDumpLength1
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
empty_stmt|;
comment|/* SPCV - reserved field */
block|}
else|else
block|{
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|HDAModeFlags
operator|=
name|config
operator|->
name|HDAModeFlags
expr_stmt|;
block|}
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|analogSetupTblOffset
operator|=
name|config
operator|->
name|analogSetupTblOffset
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|InterruptVecTblOffset
operator|=
name|config
operator|->
name|InterruptVecTblOffset
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|phyAttributeTblOffset
operator|=
name|config
operator|->
name|phyAttributeTblOffset
expr_stmt|;
name|saRoot
operator|->
name|mainConfigTable
operator|.
name|PortRecoveryTimerPortResetTimer
operator|=
name|config
operator|->
name|portRecoveryResetTimer
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Signature = 0x%x\n"
operator|,
name|Signature
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: hwRevision = 0x%x\n"
operator|,
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|hwRevision
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: FW Revision = 0x%x\n"
operator|,
name|config
operator|->
name|FWRevision
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Max Sgl = 0x%x\n"
operator|,
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|maxSgElements
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Max Device = 0x%x\n"
operator|,
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|maxDevices
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Queue Support = 0x%x\n"
operator|,
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|queueSupport
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: Phy Count = 0x%x\n"
operator|,
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|phyCount
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: sas Specs Support = 0x%x\n"
operator|,
name|saRoot
operator|->
name|ControllerInfo
operator|.
name|sasSpecsSupport
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWaitForConfigTable: return 0x%x not AGSA_RC_SUCCESS warning!\n"
operator|,
name|ret
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'o'
argument_list|,
literal|"m4"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn mpiUnInitConfigTable(agsaRoot_t *agRoot, spc_configMainDescriptor_t *config)  *  \brief UnInitialization Configuration Table  *  \param agsaRoot Pointer to a data structure containing LL layer context handles  *  * Return:  *         AGSA_RC_SUCCESS if Un-initialize the configuration table sucessful  *         AGSA_RC_FAILURE if Un-initialize the configuration table failed  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiUnInitConfigTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|bit32
name|MSGUCfgTblBase
decl_stmt|;
name|bit32
name|CfgTblDWIdx
decl_stmt|,
name|GSTOffset
decl_stmt|,
name|GSTLenMPIS
decl_stmt|;
name|bit32
name|value
decl_stmt|,
name|togglevalue
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
name|bit8
name|pcibar
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"m7"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiUnInitConfigTable: agRoot %p\n"
operator|,
name|agRoot
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|NULL
operator|!=
name|agRoot
argument_list|,
literal|"agRoot argument cannot be null"
argument_list|)
expr_stmt|;
name|togglevalue
operator|=
literal|0
expr_stmt|;
comment|/* read scratch pad0 to get PCI BAR and offset of configuration table */
name|MSGUCfgTblBase
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|MSGUCfgTblBase
operator|==
literal|0xFFFFFFFF
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiUnInitConfigTable: MSGUCfgTblBase = 0x%x AGSA_RC_FAILURE\n"
operator|,
name|MSGUCfgTblBase
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* get offset */
name|CfgTblDWIdx
operator|=
name|MSGUCfgTblBase
operator|&
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
comment|/* get PCI BAR */
name|MSGUCfgTblBase
operator|=
operator|(
name|MSGUCfgTblBase
operator|&
name|SCRATCH_PAD0_BAR_MASK
operator|)
operator|>>
name|SHIFT26
expr_stmt|;
comment|/* convert the PCI BAR to logical bar number */
name|pcibar
operator|=
operator|(
name|bit8
operator|)
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|MSGUCfgTblBase
argument_list|)
expr_stmt|;
comment|/* Write bit 1 to Inbound DoorBell Register */
name|siHalRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_IBDB_SET
argument_list|,
name|MSGU_IBDB_SET
argument_list|,
name|SPC_MSGU_CFG_TABLE_RESET
argument_list|)
expr_stmt|;
comment|/* wait until Inbound DoorBell Clear Register toggled */
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_2
argument_list|)
expr_stmt|;
comment|/* 2 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|value
operator|=
name|MSGU_READ_IDR
expr_stmt|;
name|value
operator|&=
name|SPC_MSGU_CFG_TABLE_RESET
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|value
operator|!=
name|togglevalue
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiUnInitConfigTable: TIMEOUT:IBDB value/toggle = 0x%x 0x%x\n"
operator|,
name|value
operator|,
name|togglevalue
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"m7"
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
comment|/* check the MPI-State for termination in progress */
comment|/* wait until Inbound DoorBell Clear Register toggled */
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_2
argument_list|)
expr_stmt|;
comment|/* 2 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|GSTOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
name|MAIN_GST_OFFSET
argument_list|)
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|GSTOffset
operator|==
literal|0xFFFFFFFF
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiUnInitConfigTable:AGSA_RC_FAILURE GSTOffset = 0x%x\n"
operator|,
name|GSTOffset
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|GSTLenMPIS
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CfgTblDWIdx
operator|+
call|(
name|bit32
call|)
argument_list|(
name|GSTOffset
operator|+
name|GST_GSTLEN_MPIS_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|GST_MPI_STATE_UNINIT
operator|==
operator|(
name|GSTLenMPIS
operator|&
name|GST_MPI_STATE_MASK
operator|)
condition|)
block|{
break|break;
block|}
block|}
do|while
condition|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiUnInitConfigTable: TIMEOUT, MPI State = 0x%x\n"
operator|,
name|GSTLenMPIS
operator|&
name|GST_MPI_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiUnInitConfigTable: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiUnInitConfigTable: SCRATCH_PAD1 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiUnInitConfigTable: SCRATCH_PAD2 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiUnInitConfigTable: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"m7"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"m7"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn void mpiUpdateIBQueueCfgTable(agsaRoot_t *agRoot, spc_inboundQueueDescriptor_t *outQueueCfg,  *                               bit32 QueueTableOffset,bit8 pcibar)  *  \brief Writing to the inbound queue of the Configuration Table  *  \param agsaRoot Pointer to a data structure containing both application and LL layer context handles  *  \param outQueueCfg      Pointer to inbuond configuration area  *  \param QueueTableOffset Queue configuration table offset  *  \param pcibar           PCI BAR  *  * Return:  *         None  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|mpiUpdateIBQueueCfgTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|spc_inboundQueueDescriptor_t
modifier|*
name|inQueueCfg
parameter_list|,
name|bit32
name|QueueTableOffset
parameter_list|,
name|bit8
name|pcibar
parameter_list|)
block|{
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"m5"
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Ba"
argument_list|,
name|QueueTableOffset
argument_list|)
expr_stmt|;
comment|/* TP:Ba QueueTableOffset */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"Bb"
argument_list|,
name|pcibar
argument_list|)
expr_stmt|;
comment|/* TP:Bb pcibar */
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|IB_PROPERITY_OFFSET
argument_list|)
argument_list|,
name|inQueueCfg
operator|->
name|elementPriSizeCount
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|IB_BASE_ADDR_HI_OFFSET
argument_list|)
argument_list|,
name|inQueueCfg
operator|->
name|upperBaseAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|IB_BASE_ADDR_LO_OFFSET
argument_list|)
argument_list|,
name|inQueueCfg
operator|->
name|lowerBaseAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|IB_CI_BASE_ADDR_HI_OFFSET
argument_list|)
argument_list|,
name|inQueueCfg
operator|->
name|ciUpperBaseAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|IB_CI_BASE_ADDR_LO_OFFSET
argument_list|)
argument_list|,
name|inQueueCfg
operator|->
name|ciLowerBaseAddress
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateIBQueueCfgTable: Offset 0x%08x elementPriSizeCount 0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|IB_PROPERITY_OFFSET
argument_list|)
operator|,
name|inQueueCfg
operator|->
name|elementPriSizeCount
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateIBQueueCfgTable: Offset 0x%08x upperBaseAddress    0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|IB_BASE_ADDR_HI_OFFSET
argument_list|)
operator|,
name|inQueueCfg
operator|->
name|upperBaseAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateIBQueueCfgTable: Offset 0x%08x lowerBaseAddress    0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|IB_BASE_ADDR_LO_OFFSET
argument_list|)
operator|,
name|inQueueCfg
operator|->
name|lowerBaseAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateIBQueueCfgTable: Offset 0x%08x ciUpperBaseAddress  0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|IB_CI_BASE_ADDR_HI_OFFSET
argument_list|)
operator|,
name|inQueueCfg
operator|->
name|ciUpperBaseAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateIBQueueCfgTable: Offset 0x%08x ciLowerBaseAddress  0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|IB_CI_BASE_ADDR_LO_OFFSET
argument_list|)
operator|,
name|inQueueCfg
operator|->
name|ciLowerBaseAddress
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"m5"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn void mpiUpdateOBQueueCfgTable(agsaRoot_t *agRoot, spc_outboundQueueDescriptor_t *outQueueCfg,  *                               bit32 QueueTableOffset,bit8 pcibar)  *  \brief Writing to the inbound queue of the Configuration Table  *  \param agsaRoot         Pointer to a data structure containing both application  *                          and LL layer context handles  *  \param outQueueCfg      Pointer to outbuond configuration area  *  \param QueueTableOffset Queue configuration table offset  *  \param pcibar           PCI BAR  *  * Return:  *         None  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|mpiUpdateOBQueueCfgTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|spc_outboundQueueDescriptor_t
modifier|*
name|outQueueCfg
parameter_list|,
name|bit32
name|QueueTableOffset
parameter_list|,
name|bit8
name|pcibar
parameter_list|)
block|{
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"m8"
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_PROPERITY_OFFSET
argument_list|)
argument_list|,
name|outQueueCfg
operator|->
name|elementSizeCount
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_BASE_ADDR_HI_OFFSET
argument_list|)
argument_list|,
name|outQueueCfg
operator|->
name|upperBaseAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_BASE_ADDR_LO_OFFSET
argument_list|)
argument_list|,
name|outQueueCfg
operator|->
name|lowerBaseAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_PI_BASE_ADDR_HI_OFFSET
argument_list|)
argument_list|,
name|outQueueCfg
operator|->
name|piUpperBaseAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_PI_BASE_ADDR_LO_OFFSET
argument_list|)
argument_list|,
name|outQueueCfg
operator|->
name|piLowerBaseAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_INTERRUPT_COALES_OFFSET
argument_list|)
argument_list|,
name|outQueueCfg
operator|->
name|interruptVecCntDelay
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateOBQueueCfgTable: Offset 0x%08x elementSizeCount     0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_PROPERITY_OFFSET
argument_list|)
operator|,
name|outQueueCfg
operator|->
name|elementSizeCount
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateOBQueueCfgTable: Offset 0x%08x upperBaseAddress     0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_BASE_ADDR_HI_OFFSET
argument_list|)
operator|,
name|outQueueCfg
operator|->
name|upperBaseAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateOBQueueCfgTable: Offset 0x%08x lowerBaseAddress     0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_BASE_ADDR_LO_OFFSET
argument_list|)
operator|,
name|outQueueCfg
operator|->
name|lowerBaseAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateOBQueueCfgTable: Offset 0x%08x piUpperBaseAddress   0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_PI_BASE_ADDR_HI_OFFSET
argument_list|)
operator|,
name|outQueueCfg
operator|->
name|piUpperBaseAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateOBQueueCfgTable: Offset 0x%08x piLowerBaseAddress   0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_PI_BASE_ADDR_LO_OFFSET
argument_list|)
operator|,
name|outQueueCfg
operator|->
name|piLowerBaseAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateOBQueueCfgTable: Offset 0x%08x interruptVecCntDelay 0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|QueueTableOffset
operator|+
name|OB_INTERRUPT_COALES_OFFSET
argument_list|)
operator|,
name|outQueueCfg
operator|->
name|interruptVecCntDelay
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"m8"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn void mpiUpdateOBQueueCfgTable(agsaRoot_t *agRoot, spc_outboundQueueDescriptor_t *outQueueCfg,  *                               bit32 QueueTableOffset,bit8 pcibar)  *  \brief Writing to the inbound queue of the Configuration Table  *  \param agsaRoot         Pointer to a data structure containing both application  *                          and LL layer context handles  *  \param outQueueCfg      Pointer to outbuond configuration area  *  \param QueueTableOffset Queue configuration table offset  *  \param pcibar           PCI BAR  *  * Return:  *         None  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|mpiUpdateFatalErrorTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|FerrTableOffset
parameter_list|,
name|bit32
name|lowerBaseAddress
parameter_list|,
name|bit32
name|upperBaseAddress
parameter_list|,
name|bit32
name|length
parameter_list|,
name|bit8
name|pcibar
parameter_list|)
block|{
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2U"
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|FerrTableOffset
operator|+
name|MPI_FATAL_EDUMP_TABLE_LO_OFFSET
argument_list|)
argument_list|,
name|lowerBaseAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|FerrTableOffset
operator|+
name|MPI_FATAL_EDUMP_TABLE_HI_OFFSET
argument_list|)
argument_list|,
name|upperBaseAddress
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|FerrTableOffset
operator|+
name|MPI_FATAL_EDUMP_TABLE_LENGTH
argument_list|)
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|FerrTableOffset
operator|+
name|MPI_FATAL_EDUMP_TABLE_HANDSHAKE
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|FerrTableOffset
operator|+
name|MPI_FATAL_EDUMP_TABLE_STATUS
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateFatalErrorTable: Offset 0x%08x  MPI_FATAL_EDUMP_TABLE_LO_OFFSET 0x%x\n"
operator|,
name|FerrTableOffset
operator|+
name|MPI_FATAL_EDUMP_TABLE_LO_OFFSET
operator|,
name|lowerBaseAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateFatalErrorTable: Offset 0x%08x  MPI_FATAL_EDUMP_TABLE_HI_OFFSET 0x%x\n"
operator|,
name|FerrTableOffset
operator|+
name|MPI_FATAL_EDUMP_TABLE_HI_OFFSET
operator|,
name|upperBaseAddress
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateFatalErrorTable: Offset 0x%08x  MPI_FATAL_EDUMP_TABLE_LENGTH    0x%x\n"
operator|,
name|FerrTableOffset
operator|+
name|MPI_FATAL_EDUMP_TABLE_LENGTH
operator|,
name|length
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateFatalErrorTable: Offset 0x%08x  MPI_FATAL_EDUMP_TABLE_HANDSHAKE 0x%x\n"
operator|,
name|FerrTableOffset
operator|+
name|MPI_FATAL_EDUMP_TABLE_HANDSHAKE
operator|,
literal|0
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiUpdateFatalErrorTable: Offset 0x%08x  MPI_FATAL_EDUMP_TABLE_STATUS    0x%x\n"
operator|,
name|FerrTableOffset
operator|+
name|MPI_FATAL_EDUMP_TABLE_STATUS
operator|,
literal|0
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2U"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn bit32 mpiGetPCIBarIndex(agsaRoot_t *agRoot, pciBar)  *  \brief Get PCI BAR Index from PCI BAR  *  \param agsaRoot Pointer to a data structure containing both application and LL layer context handles  *  \param pciBar - PCI BAR  *  * Return:  *         PCI BAR Index  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetPCIBarIndex
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|pciBar
parameter_list|)
block|{
switch|switch
condition|(
name|pciBar
condition|)
block|{
case|case
name|BAR0
case|:
case|case
name|BAR1
case|:
name|pciBar
operator|=
name|PCIBAR0
expr_stmt|;
break|break;
case|case
name|BAR2
case|:
case|case
name|BAR3
case|:
name|pciBar
operator|=
name|PCIBAR1
expr_stmt|;
break|break;
case|case
name|BAR4
case|:
name|pciBar
operator|=
name|PCIBAR2
expr_stmt|;
break|break;
case|case
name|BAR5
case|:
name|pciBar
operator|=
name|PCIBAR3
expr_stmt|;
break|break;
default|default:
name|pciBar
operator|=
name|PCIBAR0
expr_stmt|;
break|break;
block|}
return|return
name|pciBar
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn void mpiReadGSTTable(agsaRoot_t *agRoot, spc_GSTableDescriptor_t *mpiGSTable)  *  \brief Reading the General Status Table  *  *  \param agsaRoot         Handles for this instance of SAS/SATA LLL  *  \param mpiGSTable       Pointer of General Status Table  *  * Return:  *         None  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|mpiReadGSTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|spc_GSTableDescriptor_t
modifier|*
name|mpiGSTable
parameter_list|)
block|{
name|bit32
name|CFGTableOffset
decl_stmt|,
name|TableOffset
decl_stmt|;
name|bit32
name|GSTableOffset
decl_stmt|;
name|bit8
name|i
decl_stmt|,
name|pcibar
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"m9"
argument_list|)
expr_stmt|;
comment|/* get offset of the configuration table */
name|TableOffset
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0xFFFFFFFF
operator|==
name|TableOffset
condition|)
block|{
name|SA_ASSERT
argument_list|(
literal|0xFFFFFFFF
operator|==
name|TableOffset
argument_list|,
literal|"Chip PCI dead"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiReadGSTable: Chip PCI dead  TableOffset 0x%x\n"
operator|,
name|TableOffset
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|//  SA_DBG1(("mpiReadGSTable: TableOffset 0x%x\n", TableOffset));
name|CFGTableOffset
operator|=
name|TableOffset
operator|&
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
comment|/* get PCI BAR */
name|TableOffset
operator|=
operator|(
name|TableOffset
operator|&
name|SCRATCH_PAD0_BAR_MASK
operator|)
operator|>>
name|SHIFT26
expr_stmt|;
comment|/* convert the PCI BAR to logical bar number */
name|pcibar
operator|=
operator|(
name|bit8
operator|)
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|TableOffset
argument_list|)
expr_stmt|;
comment|/* read GST Table Offset from the configuration table */
name|GSTableOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CFGTableOffset
operator|+
name|MAIN_GST_OFFSET
argument_list|)
expr_stmt|;
comment|//  SA_DBG1(("mpiReadGSTable: GSTableOffset 0x%x\n",GSTableOffset ));
name|GSTableOffset
operator|=
name|CFGTableOffset
operator|+
name|GSTableOffset
expr_stmt|;
name|mpiGSTable
operator|->
name|GSTLenMPIS
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|GSTableOffset
operator|+
name|GST_GSTLEN_MPIS_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiGSTable
operator|->
name|IQFreezeState0
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|GSTableOffset
operator|+
name|GST_IQ_FREEZE_STATE0_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiGSTable
operator|->
name|IQFreezeState1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|GSTableOffset
operator|+
name|GST_IQ_FREEZE_STATE1_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiGSTable
operator|->
name|MsguTcnt
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|GSTableOffset
operator|+
name|GST_MSGUTCNT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiGSTable
operator|->
name|IopTcnt
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|GSTableOffset
operator|+
name|GST_IOPTCNT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiGSTable
operator|->
name|Iop1Tcnt
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|GSTableOffset
operator|+
name|GST_IOP1TCNT_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: GSTLenMPIS     0x%x\n"
operator|,
name|mpiGSTable
operator|->
name|GSTLenMPIS
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: GSTLen         0x%x\n"
operator|,
operator|(
name|mpiGSTable
operator|->
name|GSTLenMPIS
operator|&
literal|0xfff8
operator|)
operator|>>
name|SHIFT3
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: IQFreezeState0 0x%x\n"
operator|,
name|mpiGSTable
operator|->
name|IQFreezeState0
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: IQFreezeState1 0x%x\n"
operator|,
name|mpiGSTable
operator|->
name|IQFreezeState1
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: MsguTcnt       0x%x\n"
operator|,
name|mpiGSTable
operator|->
name|MsguTcnt
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: IopTcnt        0x%x\n"
operator|,
name|mpiGSTable
operator|->
name|IopTcnt
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: Iop1Tcnt       0x%x\n"
operator|,
name|mpiGSTable
operator|->
name|Iop1Tcnt
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
comment|/***** read Phy State from SAS Phy Attribute Table */
name|TableOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CFGTableOffset
operator|+
name|MAIN_PHY_ATTRIBUTE_OFFSET
argument_list|)
expr_stmt|;
name|TableOffset
operator|&=
literal|0x00FFFFFF
expr_stmt|;
name|TableOffset
operator|=
name|TableOffset
operator|+
name|CFGTableOffset
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|mpiGSTable
operator|->
name|PhyState
index|[
name|i
index|]
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|TableOffset
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
name|phyAttrb_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: PhyState[0x%x] 0x%x\n"
operator|,
name|i
operator|,
name|mpiGSTable
operator|->
name|PhyState
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|mpiGSTable
operator|->
name|PhyState
index|[
name|i
index|]
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|GSTableOffset
operator|+
name|GST_PHYSTATE_OFFSET
operator|+
name|i
operator|*
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: PhyState[0x%x] 0x%x\n"
operator|,
name|i
operator|,
name|mpiGSTable
operator|->
name|PhyState
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|mpiGSTable
operator|->
name|GPIOpins
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|GSTableOffset
operator|+
name|GST_GPIO_PINS_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: GPIOpins 0x%x\n"
operator|,
name|mpiGSTable
operator|->
name|GPIOpins
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|mpiGSTable
operator|->
name|recoverErrInfo
index|[
name|i
index|]
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|GSTableOffset
operator|+
name|GST_RERRINFO_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiReadGSTable: recoverErrInfo[0x%x] 0x%x\n"
operator|,
name|i
operator|,
name|mpiGSTable
operator|->
name|recoverErrInfo
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"m9"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn void siInitResources(agsaRoot_t *agRoot)  *  Initialization of LL resources  *  *  \param agsaRoot         Handles for this instance of SAS/SATA LLL  *  \param memoryAllocated  Point to the data structure that holds the different  *                          chunks of memory that are required  *  * Return:  *         None  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|siInitResources
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaMemoryRequirement_t
modifier|*
name|memoryAllocated
parameter_list|,
name|agsaHwConfig_t
modifier|*
name|hwConfig
parameter_list|,
name|agsaSwConfig_t
modifier|*
name|swConfig
parameter_list|,
name|bit32
name|usecsPerTick
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDeviceDesc
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequestDesc
decl_stmt|;
name|agsaTimerDesc_t
modifier|*
name|pTimerDesc
decl_stmt|;
name|agsaPort_t
modifier|*
name|pPort
decl_stmt|;
name|agsaPortMap_t
modifier|*
name|pPortMap
decl_stmt|;
name|agsaDeviceMap_t
modifier|*
name|pDeviceMap
decl_stmt|;
name|agsaIOMap_t
modifier|*
name|pIOMap
decl_stmt|;
name|bit32
name|maxNumIODevices
decl_stmt|;
name|bit32
name|i
decl_stmt|,
name|j
decl_stmt|;
name|mpiICQueue_t
modifier|*
name|circularIQ
decl_stmt|;
name|mpiOCQueue_t
modifier|*
name|circularOQ
decl_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|agRoot
condition|)
block|{
return|return;
block|}
comment|/* Get the saRoot memory address */
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|memoryAllocated
operator|->
name|agMemory
index|[
name|LLROOT_MEM_INDEX
index|]
operator|.
name|virtPtr
operator|)
expr_stmt|;
name|agRoot
operator|->
name|sdkData
operator|=
operator|(
name|void
operator|*
operator|)
name|saRoot
expr_stmt|;
comment|/* Setup Device link */
comment|/* Save the information of allocated device Link memory */
name|saRoot
operator|->
name|deviceLinkMem
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|DEVICELINK_MEM_INDEX
index|]
expr_stmt|;
name|si_memset
argument_list|(
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siInitResources: [%d] saRoot->deviceLinkMem VirtPtr=%p PhysicalLo=%x Count=%x Total=%x type %x\n"
operator|,
name|DEVICELINK_MEM_INDEX
operator|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|virtPtr
operator|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|phyAddrLower
operator|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|numElements
operator|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|totalLength
operator|,
name|saRoot
operator|->
name|deviceLinkMem
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
name|maxNumIODevices
operator|=
name|swConfig
operator|->
name|numDevHandles
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siInitResources:  maxNumIODevices=%d, swConfig->numDevHandles=%d \n"
operator|,
name|maxNumIODevices
operator|,
name|swConfig
operator|->
name|numDevHandles
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup free IO Devices link list */
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeDevicesList
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|bit32
operator|)
name|maxNumIODevices
condition|;
name|i
operator|++
control|)
block|{
comment|/* get the pointer to the device descriptor */
name|pDeviceDesc
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|AGSAMEM_ELEMENT_READ
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|deviceLinkMem
operator|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* Initialize device descriptor */
name|saLlinkInitialize
argument_list|(
operator|&
operator|(
name|pDeviceDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pDeviceDesc
operator|->
name|initiatorDevHandle
operator|.
name|osData
operator|=
name|agNULL
expr_stmt|;
name|pDeviceDesc
operator|->
name|initiatorDevHandle
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|pDeviceDesc
operator|->
name|targetDevHandle
operator|.
name|osData
operator|=
name|agNULL
expr_stmt|;
name|pDeviceDesc
operator|->
name|targetDevHandle
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|pDeviceDesc
operator|->
name|deviceType
operator|=
name|SAS_SATA_UNKNOWN_DEVICE
expr_stmt|;
name|pDeviceDesc
operator|->
name|pPort
operator|=
name|agNULL
expr_stmt|;
name|pDeviceDesc
operator|->
name|DeviceMapIndex
operator|=
literal|0
expr_stmt|;
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|pDeviceDesc
operator|->
name|pendingIORequests
operator|)
argument_list|)
expr_stmt|;
comment|/* Add the device descriptor to the free IO device link list */
name|saLlistAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeDevicesList
operator|)
argument_list|,
operator|&
operator|(
name|pDeviceDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Setup IO Request link */
comment|/* Save the information of allocated IO Request Link memory */
name|saRoot
operator|->
name|IORequestMem
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|IOREQLINK_MEM_INDEX
index|]
expr_stmt|;
name|si_memset
argument_list|(
name|saRoot
operator|->
name|IORequestMem
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siInitResources: [%d] saRoot->IORequestMem  VirtPtr=%p PhysicalLo=%x Count=%x Total=%x type %x\n"
operator|,
name|IOREQLINK_MEM_INDEX
operator|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|virtPtr
operator|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|phyAddrLower
operator|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|numElements
operator|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|totalLength
operator|,
name|saRoot
operator|->
name|IORequestMem
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup free IO  Request link list */
name|saLlistIOInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|swConfig
operator|->
name|maxActiveIOs
condition|;
name|i
operator|++
control|)
block|{
comment|/* get the pointer to the request descriptor */
name|pRequestDesc
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|AGSAMEM_ELEMENT_READ
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|IORequestMem
operator|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* Initialize request descriptor */
name|saLlinkIOInitialize
argument_list|(
operator|&
operator|(
name|pRequestDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pRequestDesc
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|pRequestDesc
operator|->
name|requestType
operator|=
name|AGSA_REQ_TYPE_UNKNOWN
expr_stmt|;
name|pRequestDesc
operator|->
name|pIORequestContext
operator|=
name|agNULL
expr_stmt|;
name|pRequestDesc
operator|->
name|HTag
operator|=
name|i
expr_stmt|;
name|pRequestDesc
operator|->
name|pDevice
operator|=
name|agNULL
expr_stmt|;
name|pRequestDesc
operator|->
name|pPort
operator|=
name|agNULL
expr_stmt|;
comment|/* Add the request descriptor to the free IO Request link list */
comment|/* Add the request descriptor to the free Reserved Request link list */
comment|/* SMP request must get service so reserve one request when first SMP completes */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequestDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequestDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Setup timer link */
comment|/* Save the information of allocated timer Link memory */
name|saRoot
operator|->
name|timerLinkMem
operator|=
name|memoryAllocated
operator|->
name|agMemory
index|[
name|TIMERLINK_MEM_INDEX
index|]
expr_stmt|;
name|si_memset
argument_list|(
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"siInitResources: [%d] saRoot->timerLinkMem  VirtPtr=%p PhysicalLo=%x Count=%x Total=%x type %x\n"
operator|,
name|TIMERLINK_MEM_INDEX
operator|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|virtPtr
operator|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|phyAddrLower
operator|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|numElements
operator|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|totalLength
operator|,
name|saRoot
operator|->
name|timerLinkMem
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup free timer link list */
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeTimers
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_TIMERS
condition|;
name|i
operator|++
control|)
block|{
comment|/* get the pointer to the timer descriptor */
name|pTimerDesc
operator|=
operator|(
name|agsaTimerDesc_t
operator|*
operator|)
name|AGSAMEM_ELEMENT_READ
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|timerLinkMem
operator|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* Initialize timer descriptor */
name|saLlinkInitialize
argument_list|(
operator|&
operator|(
name|pTimerDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pTimerDesc
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|pTimerDesc
operator|->
name|timeoutTick
operator|=
literal|0
expr_stmt|;
name|pTimerDesc
operator|->
name|pfnTimeout
operator|=
name|agNULL
expr_stmt|;
name|pTimerDesc
operator|->
name|Event
operator|=
literal|0
expr_stmt|;
name|pTimerDesc
operator|->
name|pParm
operator|=
name|agNULL
expr_stmt|;
comment|/* Add the timer descriptor to the free timer link list */
name|saLlistAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeTimers
operator|)
argument_list|,
operator|&
operator|(
name|pTimerDesc
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Setup valid timer link list */
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|validTimers
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup Phys */
comment|/* Setup PhyCount */
name|saRoot
operator|->
name|phyCount
operator|=
operator|(
name|bit8
operator|)
name|hwConfig
operator|->
name|phyCount
expr_stmt|;
comment|/* Init Phy data structure */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|phyCount
condition|;
name|i
operator|++
control|)
block|{
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|.
name|pPort
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|.
name|phyId
operator|=
operator|(
name|bit8
operator|)
name|i
expr_stmt|;
comment|/* setup phy status is PHY_STOPPED */
name|PHY_STATUS_SET
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|phys
index|[
name|i
index|]
operator|)
argument_list|,
name|PHY_STOPPED
argument_list|)
expr_stmt|;
block|}
comment|/* Setup Ports */
comment|/* Setup PortCount */
name|saRoot
operator|->
name|portCount
operator|=
name|saRoot
operator|->
name|phyCount
expr_stmt|;
comment|/* Setup free port link list */
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freePorts
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|portCount
condition|;
name|i
operator|++
control|)
block|{
comment|/* get the pointer to the port */
name|pPort
operator|=
operator|&
operator|(
name|saRoot
operator|->
name|ports
index|[
name|i
index|]
operator|)
expr_stmt|;
comment|/* Initialize port */
name|saLlinkInitialize
argument_list|(
operator|&
operator|(
name|pPort
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pPort
operator|->
name|portContext
operator|.
name|osData
operator|=
name|agNULL
expr_stmt|;
name|pPort
operator|->
name|portContext
operator|.
name|sdkData
operator|=
name|pPort
expr_stmt|;
name|pPort
operator|->
name|portId
operator|=
literal|0
expr_stmt|;
name|pPort
operator|->
name|portIdx
operator|=
operator|(
name|bit8
operator|)
name|i
expr_stmt|;
name|pPort
operator|->
name|status
operator|=
name|PORT_NORMAL
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|saRoot
operator|->
name|phyCount
condition|;
name|j
operator|++
control|)
block|{
name|pPort
operator|->
name|phyMap
index|[
name|j
index|]
operator|=
name|agFALSE
expr_stmt|;
block|}
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|pPort
operator|->
name|listSASATADevices
operator|)
argument_list|)
expr_stmt|;
comment|/* Add the port to the free port link list */
name|saLlistAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freePorts
operator|)
argument_list|,
operator|&
operator|(
name|pPort
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Setup valid port link list */
name|saLlistInitialize
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|validPorts
operator|)
argument_list|)
expr_stmt|;
comment|/* Init sysIntsActive */
name|saRoot
operator|->
name|sysIntsActive
operator|=
name|agFALSE
expr_stmt|;
comment|/* setup timer tick granunarity */
name|saRoot
operator|->
name|usecsPerTick
operator|=
name|usecsPerTick
expr_stmt|;
comment|/* initialize LL timer tick */
name|saRoot
operator|->
name|timeTick
operator|=
literal|0
expr_stmt|;
comment|/* initialize device (de)registration callback fns */
name|saRoot
operator|->
name|DeviceRegistrationCB
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|DeviceDeregistrationCB
operator|=
name|agNULL
expr_stmt|;
comment|/* Initialize the PortMap for port context */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|portCount
condition|;
name|i
operator|++
control|)
block|{
name|pPortMap
operator|=
operator|&
operator|(
name|saRoot
operator|->
name|PortMap
index|[
name|i
index|]
operator|)
expr_stmt|;
name|pPortMap
operator|->
name|PortContext
operator|=
name|agNULL
expr_stmt|;
name|pPortMap
operator|->
name|PortID
operator|=
name|PORT_MARK_OFF
expr_stmt|;
name|pPortMap
operator|->
name|PortStatus
operator|=
name|PORT_NORMAL
expr_stmt|;
name|saRoot
operator|->
name|autoDeregDeviceflag
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Initialize the DeviceMap for device handle */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_IO_DEVICE_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|pDeviceMap
operator|=
operator|&
operator|(
name|saRoot
operator|->
name|DeviceMap
index|[
name|i
index|]
operator|)
expr_stmt|;
name|pDeviceMap
operator|->
name|DeviceHandle
operator|=
name|agNULL
expr_stmt|;
name|pDeviceMap
operator|->
name|DeviceIdFromFW
operator|=
name|i
expr_stmt|;
block|}
comment|/* Initialize the IOMap for IOrequest */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_ACTIVE_IO_REQUESTS
condition|;
name|i
operator|++
control|)
block|{
name|pIOMap
operator|=
operator|&
operator|(
name|saRoot
operator|->
name|IOMap
index|[
name|i
index|]
operator|)
expr_stmt|;
name|pIOMap
operator|->
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|pIOMap
operator|->
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
block|}
comment|/* clean the inbound queues */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|QueueConfig
operator|.
name|numInboundQueues
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
literal|0
operator|!=
name|saRoot
operator|->
name|inboundQueue
index|[
name|i
index|]
operator|.
name|numElements
condition|)
block|{
name|circularIQ
operator|=
operator|&
name|saRoot
operator|->
name|inboundQueue
index|[
name|i
index|]
expr_stmt|;
name|si_memset
argument_list|(
name|circularIQ
operator|->
name|memoryRegion
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|circularIQ
operator|->
name|memoryRegion
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
name|saRoot
operator|->
name|inboundQueue
index|[
name|i
index|]
operator|.
name|ciPointer
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* clean the outbound queues */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|saRoot
operator|->
name|QueueConfig
operator|.
name|numOutboundQueues
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
literal|0
operator|!=
name|saRoot
operator|->
name|outboundQueue
index|[
name|i
index|]
operator|.
name|numElements
condition|)
block|{
name|circularOQ
operator|=
operator|&
name|saRoot
operator|->
name|outboundQueue
index|[
name|i
index|]
expr_stmt|;
name|si_memset
argument_list|(
name|circularOQ
operator|->
name|memoryRegion
operator|.
name|virtPtr
argument_list|,
literal|0
argument_list|,
name|circularOQ
operator|->
name|memoryRegion
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
name|saRoot
operator|->
name|outboundQueue
index|[
name|i
index|]
operator|.
name|piPointer
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bit32
argument_list|)
argument_list|)
expr_stmt|;
name|circularOQ
operator|->
name|producerIdx
operator|=
literal|0
expr_stmt|;
name|circularOQ
operator|->
name|consumerIdx
operator|=
literal|0
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"siInitResource: Q %d  Clean PI 0x%03x CI 0x%03x\n"
operator|,
name|i
operator|,
name|circularOQ
operator|->
name|producerIdx
operator|,
name|circularOQ
operator|->
name|consumerIdx
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn void mpiReadCALTable(agsaRoot_t *agRoot,  *                           spc_SPASTable_t *mpiCALTable, bit32 index)  *  \brief Reading the Phy Analog Setup Register Table  *  \param agsaRoot    Handles for this instance of SAS/SATA LLL  *  \param mpiCALTable Pointer of Phy Calibration Table  *  * Return:  *         None  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|mpiReadCALTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|spc_SPASTable_t
modifier|*
name|mpiCALTable
parameter_list|,
name|bit32
name|index
parameter_list|)
block|{
name|bit32
name|CFGTableOffset
decl_stmt|,
name|TableOffset
decl_stmt|;
name|bit32
name|CALTableOffset
decl_stmt|;
name|bit8
name|pcibar
decl_stmt|;
comment|/* get offset of the configuration table */
name|TableOffset
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|CFGTableOffset
operator|=
name|TableOffset
operator|&
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
comment|/* get PCI BAR */
name|TableOffset
operator|=
operator|(
name|TableOffset
operator|&
name|SCRATCH_PAD0_BAR_MASK
operator|)
operator|>>
name|SHIFT26
expr_stmt|;
comment|/* convert the PCI BAR to logical bar number */
name|pcibar
operator|=
operator|(
name|bit8
operator|)
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|TableOffset
argument_list|)
expr_stmt|;
comment|/* read Calibration Table Offset from the configuration table */
name|CALTableOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CFGTableOffset
operator|+
name|MAIN_ANALOG_SETUP_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|CALTableOffset
operator|&=
literal|0x00FFFFFF
expr_stmt|;
block|}
name|CALTableOffset
operator|=
name|CFGTableOffset
operator|+
name|CALTableOffset
operator|+
operator|(
name|index
operator|*
name|ANALOG_SETUP_ENTRY_SIZE
operator|*
literal|4
operator|)
expr_stmt|;
name|mpiCALTable
operator|->
name|spaReg0
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|TX_PORT_CFG1_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiCALTable
operator|->
name|spaReg1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|TX_PORT_CFG2_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiCALTable
operator|->
name|spaReg2
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|TX_PORT_CFG3_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiCALTable
operator|->
name|spaReg3
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|TX_CFG_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiCALTable
operator|->
name|spaReg4
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|RV_PORT_CFG1_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiCALTable
operator|->
name|spaReg5
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|RV_PORT_CFG2_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiCALTable
operator|->
name|spaReg6
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|RV_CFG1_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|mpiCALTable
operator|->
name|spaReg7
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|RV_CFG2_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiReadCALTable: spaReg0 0x%x\n"
operator|,
name|mpiCALTable
operator|->
name|spaReg0
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiReadCALTable: spaReg1 0x%x\n"
operator|,
name|mpiCALTable
operator|->
name|spaReg1
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiReadCALTable: spaReg2 0x%x\n"
operator|,
name|mpiCALTable
operator|->
name|spaReg2
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiReadCALTable: spaReg3 0x%x\n"
operator|,
name|mpiCALTable
operator|->
name|spaReg3
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiReadCALTable: spaReg4 0x%x\n"
operator|,
name|mpiCALTable
operator|->
name|spaReg4
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiReadCALTable: spaReg5 0x%x\n"
operator|,
name|mpiCALTable
operator|->
name|spaReg5
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiReadCALTable: spaReg6 0x%x\n"
operator|,
name|mpiCALTable
operator|->
name|spaReg6
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiReadCALTable: spaReg7 0x%x\n"
operator|,
name|mpiCALTable
operator|->
name|spaReg7
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn void mpiWriteCALTable(agsaRoot_t *agRoot,  *                            spc_SPASTable_t *mpiCALTable, index)  *  \brief Writing the Phy Analog Setup Register Table  *  \param agsaRoot    Handles for this instance of SAS/SATA LLL  *  \param mpiCALTable Pointer of Phy Calibration Table  *  * Return:  *         None  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|mpiWriteCALTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|spc_SPASTable_t
modifier|*
name|mpiCALTable
parameter_list|,
name|bit32
name|index
parameter_list|)
block|{
name|bit32
name|CFGTableOffset
decl_stmt|,
name|TableOffset
decl_stmt|;
name|bit32
name|CALTableOffset
decl_stmt|;
name|bit8
name|pcibar
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"m6"
argument_list|)
expr_stmt|;
comment|/* get offset of the configuration table */
name|TableOffset
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|CFGTableOffset
operator|=
name|TableOffset
operator|&
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
comment|/* get PCI BAR */
name|TableOffset
operator|=
operator|(
name|TableOffset
operator|&
name|SCRATCH_PAD0_BAR_MASK
operator|)
operator|>>
name|SHIFT26
expr_stmt|;
comment|/* convert the PCI BAR to logical bar number */
name|pcibar
operator|=
operator|(
name|bit8
operator|)
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|TableOffset
argument_list|)
expr_stmt|;
comment|/* read Calibration Table Offset from the configuration table */
name|CALTableOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CFGTableOffset
operator|+
name|MAIN_ANALOG_SETUP_OFFSET
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|CALTableOffset
operator|&=
literal|0x00FFFFFF
expr_stmt|;
block|}
name|CALTableOffset
operator|=
name|CFGTableOffset
operator|+
name|CALTableOffset
operator|+
operator|(
name|index
operator|*
name|ANALOG_SETUP_ENTRY_SIZE
operator|*
literal|4
operator|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|TX_PORT_CFG1_OFFSET
argument_list|)
argument_list|,
name|mpiCALTable
operator|->
name|spaReg0
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|TX_PORT_CFG2_OFFSET
argument_list|)
argument_list|,
name|mpiCALTable
operator|->
name|spaReg1
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|TX_PORT_CFG3_OFFSET
argument_list|)
argument_list|,
name|mpiCALTable
operator|->
name|spaReg2
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|TX_CFG_OFFSET
argument_list|)
argument_list|,
name|mpiCALTable
operator|->
name|spaReg3
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|RV_PORT_CFG1_OFFSET
argument_list|)
argument_list|,
name|mpiCALTable
operator|->
name|spaReg4
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|RV_PORT_CFG2_OFFSET
argument_list|)
argument_list|,
name|mpiCALTable
operator|->
name|spaReg5
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|RV_CFG1_OFFSET
argument_list|)
argument_list|,
name|mpiCALTable
operator|->
name|spaReg6
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|RV_CFG2_OFFSET
argument_list|)
argument_list|,
name|mpiCALTable
operator|->
name|spaReg7
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWriteCALTable: Offset 0x%08x  spaReg0 0x%x 0x%x 0x%x 0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|TX_PORT_CFG1_OFFSET
argument_list|)
operator|,
name|mpiCALTable
operator|->
name|spaReg0
operator|,
name|mpiCALTable
operator|->
name|spaReg1
operator|,
name|mpiCALTable
operator|->
name|spaReg2
operator|,
name|mpiCALTable
operator|->
name|spaReg3
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWriteCALTable: Offset 0x%08x  spaReg4 0x%x 0x%x 0x%x 0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|CALTableOffset
operator|+
name|RV_PORT_CFG1_OFFSET
argument_list|)
operator|,
name|mpiCALTable
operator|->
name|spaReg4
operator|,
name|mpiCALTable
operator|->
name|spaReg5
operator|,
name|mpiCALTable
operator|->
name|spaReg6
operator|,
name|mpiCALTable
operator|->
name|spaReg7
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"m6"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn void mpiWriteCALAll(agsaRoot_t *agRoot,  *                          agsaPhyAnalogSetupTable_t *mpiCALTable)  *  \brief Writing the Phy Analog Setup Register Table  *  \param agsaRoot    Handles for this instance of SAS/SATA LLL  *  \param mpiCALTable Pointer of Phy Calibration Table  *  * Return:  *         None  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|void
name|mpiWriteCALAll
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaPhyAnalogSetupTable_t
modifier|*
name|mpiCALTable
parameter_list|)
block|{
name|bit8
name|i
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"mz"
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"mz"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_INDEX
condition|;
name|i
operator|++
control|)
block|{
name|mpiWriteCALTable
argument_list|(
name|agRoot
argument_list|,
operator|(
name|spc_SPASTable_t
operator|*
operator|)
operator|&
name|mpiCALTable
operator|->
name|phyAnalogSetupRegisters
index|[
name|i
index|]
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"mz"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|mpiWrAnalogSetupTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|mpiConfig_t
modifier|*
name|config
parameter_list|)
block|{
name|bit32
name|AnalogTableBase
decl_stmt|,
name|CFGTableOffset
decl_stmt|,
name|value
decl_stmt|,
name|phy
decl_stmt|;
name|bit32
name|AnalogtableSize
decl_stmt|;
name|bit8
name|pcibar
decl_stmt|;
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|pcibar
operator|=
operator|(
name|bit8
operator|)
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|CFGTableOffset
operator|=
name|value
operator|&
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
name|AnalogtableSize
operator|=
name|AnalogTableBase
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CFGTableOffset
operator|+
name|MAIN_ANALOG_SETUP_OFFSET
argument_list|)
expr_stmt|;
name|AnalogtableSize
operator|&=
literal|0xFF000000
expr_stmt|;
name|AnalogtableSize
operator|>>=
name|SHIFT24
expr_stmt|;
name|AnalogTableBase
operator|&=
literal|0x00FFFFFF
expr_stmt|;
name|AnalogTableBase
operator|=
name|CFGTableOffset
operator|+
name|AnalogTableBase
expr_stmt|;
comment|//   config->phyAnalogConfig.phyAnalogSetupRegisters[0].spaRegister0 = 0;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:Analogtable Base Offset %08X pcibar %d\n"
operator|,
name|AnalogTableBase
operator|,
name|pcibar
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:%d %d\n"
operator|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|agsaPhyAnalogSetupRegisters_t
argument_list|)
operator|,
name|AnalogtableSize
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|phy
operator|=
literal|0
init|;
name|phy
operator|<
literal|10
condition|;
name|phy
operator|++
control|)
comment|/* upto 10 phys See PM*/
block|{
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|0
operator|)
argument_list|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister0
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|4
operator|)
argument_list|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister1
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|8
operator|)
argument_list|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister2
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|12
operator|)
argument_list|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister3
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|16
operator|)
argument_list|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister4
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|20
operator|)
argument_list|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister5
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|24
operator|)
argument_list|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister6
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|28
operator|)
argument_list|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister7
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|32
operator|)
argument_list|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister8
argument_list|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|36
operator|)
argument_list|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister9
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:phy %d Offset 0x%08x spaRegister0 0x%x 0x%x\n"
operator|,
name|phy
operator|,
operator|(
name|bit32
operator|)
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|0
operator|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister0
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:phy %d Offset 0x%08x spaRegister1 0x%x 0x%x\n"
operator|,
name|phy
operator|,
operator|(
name|bit32
operator|)
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|4
operator|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister1
operator|,
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:phy %d Offset 0x%08x spaRegister2 0x%x\n"
operator|,
name|phy
operator|,
operator|(
name|bit32
operator|)
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|8
operator|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister2
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:phy %d Offset 0x%08x spaRegister3 0x%x\n"
operator|,
name|phy
operator|,
operator|(
name|bit32
operator|)
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|12
operator|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister3
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:phy %d Offset 0x%08x spaRegister4 0x%x\n"
operator|,
name|phy
operator|,
operator|(
name|bit32
operator|)
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|16
operator|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister4
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:phy %d Offset 0x%08x spaRegister5 0x%x\n"
operator|,
name|phy
operator|,
operator|(
name|bit32
operator|)
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|20
operator|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister5
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:phy %d Offset 0x%08x spaRegister6 0x%x\n"
operator|,
name|phy
operator|,
operator|(
name|bit32
operator|)
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|24
operator|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister6
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:phy %d Offset 0x%08x spaRegister7 0x%x\n"
operator|,
name|phy
operator|,
operator|(
name|bit32
operator|)
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|28
operator|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister7
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:phy %d Offset 0x%08x spaRegister8 0x%x\n"
operator|,
name|phy
operator|,
operator|(
name|bit32
operator|)
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|32
operator|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister8
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrAnalogSetupTable:phy %d Offset 0x%08x spaRegister9 0x%x\n"
operator|,
name|phy
operator|,
operator|(
name|bit32
operator|)
name|AnalogTableBase
operator|+
operator|(
name|AnalogtableSize
operator|*
name|phy
operator|)
operator|+
literal|36
operator|,
name|config
operator|->
name|phyAnalogConfig
operator|.
name|phyAnalogSetupRegisters
index|[
name|phy
index|]
operator|.
name|spaRegister9
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|GLOBAL
name|void
name|mpiWrIntVecTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|mpiConfig_t
modifier|*
name|config
parameter_list|)
block|{
name|bit32
name|CFGTableOffset
decl_stmt|,
name|value
decl_stmt|;
name|bit32
name|INTVTableOffset
decl_stmt|;
name|bit32
name|ValuetoWrite
decl_stmt|;
name|bit8
name|pcibar
decl_stmt|,
name|i
decl_stmt|,
name|obq
decl_stmt|;
comment|/* get offset of the configuration table */
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|CFGTableOffset
operator|=
name|value
operator|&
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
comment|/* get PCI BAR */
name|value
operator|=
operator|(
name|value
operator|&
name|SCRATCH_PAD0_BAR_MASK
operator|)
operator|>>
name|SHIFT26
expr_stmt|;
comment|/* convert the PCI BAR to logical bar number */
name|pcibar
operator|=
operator|(
name|bit8
operator|)
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* read Interrupt Table Offset from the main configuration table */
name|INTVTableOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CFGTableOffset
operator|+
name|MAIN_INT_VEC_TABLE_OFFSET
argument_list|)
expr_stmt|;
name|INTVTableOffset
operator|&=
literal|0x00FFFFFF
expr_stmt|;
name|INTVTableOffset
operator|=
name|CFGTableOffset
operator|+
name|INTVTableOffset
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWrIntVecTable: Base Offset %08X\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|INTVTableOffset
operator|+
name|INT_VT_Coal_CNT_TO
argument_list|)
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_NUM_VECTOR
condition|;
name|i
operator|++
control|)
block|{
name|bit32
name|found
init|=
literal|0
decl_stmt|;
for|for
control|(
name|obq
operator|=
literal|0
init|;
name|obq
operator|<
name|MAX_NUM_VECTOR
condition|;
name|obq
operator|++
control|)
block|{
comment|/* find OBQ for  vector i */
if|if
condition|(
name|config
operator|->
name|outboundQueues
index|[
name|obq
index|]
operator|.
name|interruptVector
operator|==
name|i
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
continue|continue;
block|}
name|ValuetoWrite
operator|=
operator|(
operator|(
name|config
operator|->
name|outboundQueues
index|[
name|obq
index|]
operator|.
name|interruptDelay
operator|<<
name|SHIFT15
operator|)
operator||
name|config
operator|->
name|outboundQueues
index|[
name|obq
index|]
operator|.
name|interruptThreshold
operator|)
expr_stmt|;
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|INTVTableOffset
operator|+
name|INT_VT_Coal_CNT_TO
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
name|InterruptVT_t
argument_list|)
argument_list|)
argument_list|,
name|ValuetoWrite
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiWrIntVecTable: Q %d interruptDelay 0x%X interruptThreshold 0x%X \n"
operator|,
name|i
operator|,
name|config
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptDelay
operator|,
name|config
operator|->
name|outboundQueues
index|[
name|i
index|]
operator|.
name|interruptThreshold
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiWrIntVecTable: %d INT_VT_Coal_CNT_TO Bar %d Offset %3X Writing 0x%08x\n"
operator|,
name|i
operator|,
name|pcibar
operator|,
call|(
name|bit32
call|)
argument_list|(
name|INTVTableOffset
operator|+
name|INT_VT_Coal_CNT_TO
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
name|InterruptVT_t
argument_list|)
argument_list|)
operator|,
name|ValuetoWrite
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_NUM_VECTOR
condition|;
name|i
operator|++
control|)
block|{
comment|/* read interrupt colescing control and timer  */
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|INTVTableOffset
operator|+
name|INT_VT_Coal_CNT_TO
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
name|InterruptVT_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG4
argument_list|(
operator|(
literal|"mpiWrIntVecTable: Offset 0x%08x Interrupt Colescing iccict[%02d] 0x%x\n"
operator|,
call|(
name|bit32
call|)
argument_list|(
name|INTVTableOffset
operator|+
name|INT_VT_Coal_CNT_TO
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
name|InterruptVT_t
argument_list|)
argument_list|)
operator|,
name|i
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|GLOBAL
name|void
name|mpiWrPhyAttrbTable
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|sasPhyAttribute_t
modifier|*
name|phyAttrib
parameter_list|)
block|{
name|bit32
name|CFGTableOffset
decl_stmt|,
name|value
decl_stmt|;
name|bit32
name|PHYTableOffset
decl_stmt|;
name|bit8
name|pcibar
decl_stmt|,
name|i
decl_stmt|;
comment|/* get offset of the configuration table */
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|CFGTableOffset
operator|=
name|value
operator|&
name|SCRATCH_PAD0_OFFSET_MASK
expr_stmt|;
comment|/* get PCI BAR */
name|value
operator|=
operator|(
name|value
operator|&
name|SCRATCH_PAD0_BAR_MASK
operator|)
operator|>>
name|SHIFT26
expr_stmt|;
comment|/* convert the PCI BAR to logical bar number */
name|pcibar
operator|=
operator|(
name|bit8
operator|)
name|mpiGetPCIBarIndex
argument_list|(
name|agRoot
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* read Phy Attribute Table Offset from the configuration table */
name|PHYTableOffset
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
operator|(
name|bit32
operator|)
name|CFGTableOffset
operator|+
name|MAIN_PHY_ATTRIBUTE_OFFSET
argument_list|)
expr_stmt|;
name|PHYTableOffset
operator|&=
literal|0x00FFFFFF
expr_stmt|;
name|PHYTableOffset
operator|=
name|CFGTableOffset
operator|+
name|PHYTableOffset
operator|+
name|PHY_EVENT_OQ
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWrPhyAttrbTable: PHYTableOffset 0x%08x\n"
operator|,
name|PHYTableOffset
operator|)
argument_list|)
expr_stmt|;
comment|/* write OQ event per phy */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_VALID_PHYS
condition|;
name|i
operator|++
control|)
block|{
name|ossaHwRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|PHYTableOffset
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
name|phyAttrb_t
argument_list|)
argument_list|)
argument_list|,
name|phyAttrib
operator|->
name|phyAttribute
index|[
name|i
index|]
operator|.
name|phyEventOQ
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiWrPhyAttrbTable:%d Offset 0x%08x phyAttribute 0x%x\n"
operator|,
name|i
operator|,
call|(
name|bit32
call|)
argument_list|(
name|PHYTableOffset
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
name|phyAttrb_t
argument_list|)
argument_list|)
operator|,
name|phyAttrib
operator|->
name|phyAttribute
index|[
name|i
index|]
operator|.
name|phyEventOQ
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_VALID_PHYS
condition|;
name|i
operator|++
control|)
block|{
name|value
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|pcibar
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|PHYTableOffset
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
name|phyAttrb_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiWrPhyAttrbTable: OQ Event per phy[%x] 0x%x\n"
operator|,
name|i
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|TEST
end_ifdef

begin_comment
comment|/******************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \fn mpiFreezeInboundQueue(agsaRoot_t *agRoot)  *  \brief Freeze the inbound queue  *  *  \param agRoot             Handles for this instance of SAS/SATA hardware  *  \param bitMapQueueNum0    bit map for inbound queue number 0 - 31 to freeze  *  \param bitMapQueueNum1    bit map for inbound queue number 32 - 63 to freeze  *  * Return:  *         AGSA_RC_SUCCESS if Un-initialize the configuration table sucessful  *         AGSA_RC_FAILURE if Un-initialize the configuration table failed  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiFreezeInboundQueue
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|bitMapQueueNum0
parameter_list|,
name|bit32
name|bitMapQueueNum1
parameter_list|)
block|{
name|bit32
name|value
decl_stmt|,
name|togglevalue
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"Entering function:mpiFreezeInboundQueue\n"
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|NULL
operator|!=
name|agRoot
argument_list|,
literal|"agRoot argument cannot be null"
argument_list|)
expr_stmt|;
name|togglevalue
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bitMapQueueNum0
condition|)
block|{
comment|/* update the inbound queue number to HOST_SCRATCH_PAD1 register for queue 0 to 31 */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiFreezeInboundQueue: SCRATCH_PAD0 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiFreezeInboundQueue: SCRATCH_PAD3 value = 0x%x\n"
operator|,
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_3
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
name|value
operator||=
name|bitMapQueueNum0
expr_stmt|;
name|siHalRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_HOST_SCRATCH_PAD_1
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_1
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bitMapQueueNum1
condition|)
block|{
comment|/* update the inbound queue number to HOST_SCRATCH_PAD2 register for queue 32 to 63 */
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_2
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
name|value
operator||=
name|bitMapQueueNum1
expr_stmt|;
name|siHalRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_HOST_SCRATCH_PAD_2
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_2
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
comment|/* Write bit 2 to Inbound DoorBell Register */
name|siHalRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_IBDB_SET
argument_list|,
name|MSGU_IBDB_SET
argument_list|,
name|IBDB_IBQ_FREEZE
argument_list|)
expr_stmt|;
comment|/* wait until Inbound DoorBell Clear Register toggled */
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_2
argument_list|)
expr_stmt|;
comment|/* 2 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
comment|/* Read Inbound DoorBell Register - for RevB */
comment|//    value = ossaHwRegReadExt(agRoot, PCIBAR0, MSGU_IBDB_SET);
name|value
operator|=
name|MSGU_READ_IDR
expr_stmt|;
name|value
operator|&=
name|IBDB_IBQ_FREEZE
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|value
operator|!=
name|togglevalue
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiFreezeInboundQueue: IBDB value/toggle = 0x%x 0x%x\n"
operator|,
name|value
operator|,
name|togglevalue
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/** \fn mpiUnFreezeInboundQueue(agsaRoot_t *agRoot)  *  \brief Freeze the inbound queue  *  *  \param agRoot             Handles for this instance of SAS/SATA hardware  *  \param bitMapQueueNum0    bit map for inbound queue number 0 - 31 to freeze  *  \param bitMapQueueNum1    bit map for inbound queue number 32 - 63 to freeze  *  * Return:  *         AGSA_RC_SUCCESS if Un-initialize the configuration table sucessful  *         AGSA_RC_FAILURE if Un-initialize the configuration table failed  */
end_comment

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiUnFreezeInboundQueue
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|bit32
name|bitMapQueueNum0
parameter_list|,
name|bit32
name|bitMapQueueNum1
parameter_list|)
block|{
name|bit32
name|value
decl_stmt|,
name|togglevalue
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"Entering function:mpiUnFreezeInboundQueue\n"
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
name|NULL
operator|!=
name|agRoot
argument_list|,
literal|"agRoot argument cannot be null"
argument_list|)
expr_stmt|;
name|togglevalue
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bitMapQueueNum0
condition|)
block|{
comment|/* update the inbound queue number to HOST_SCRATCH_PAD1 register - for queue 0 to 31 */
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_1
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
name|value
operator||=
name|bitMapQueueNum0
expr_stmt|;
name|siHalRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_HOST_SCRATCH_PAD_1
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_1
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bitMapQueueNum1
condition|)
block|{
comment|/* update the inbound queue number to HOST_SCRATCH_PAD2 register - for queue 32 to 63 */
name|value
operator|=
name|siHalRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_SCRATCH_PAD_2
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
name|value
operator||=
name|bitMapQueueNum1
expr_stmt|;
name|siHalRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_HOST_SCRATCH_PAD_2
argument_list|,
name|MSGU_HOST_SCRATCH_PAD_2
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
comment|/* Write bit 2 to Inbound DoorBell Register */
name|siHalRegWriteExt
argument_list|(
name|agRoot
argument_list|,
name|GEN_MSGU_IBDB_SET
argument_list|,
name|MSGU_IBDB_SET
argument_list|,
name|IBDB_IBQ_UNFREEZE
argument_list|)
expr_stmt|;
comment|/* wait until Inbound DoorBell Clear Register toggled */
name|max_wait_time
operator|=
name|WAIT_SECONDS
argument_list|(
name|gWait_2
argument_list|)
expr_stmt|;
comment|/* 2 sec */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
comment|/* Read Inbound DoorBell Register - for RevB */
name|value
operator|=
name|MSGU_READ_IDR
expr_stmt|;
name|value
operator|&=
name|IBDB_IBQ_UNFREEZE
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|value
operator|!=
name|togglevalue
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiUnFreezeInboundQueue: IBDB value/toggle = 0x%x 0x%x\n"
operator|,
name|value
operator|,
name|togglevalue
operator|)
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TEST ****************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|si_check_V_HDA
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|bit32
name|hda_status
init|=
literal|0
decl_stmt|;
name|hda_status
operator|=
operator|(
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|SPC_V_HDA_RESPONSE_OFFSET
operator|+
literal|28
argument_list|)
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_check_V_HDA: hda_status 0x%08X\n"
operator|,
name|hda_status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hda_status
operator|&
name|SPC_V_HDAR_RSPCODE_MASK
operator|)
operator|==
name|SPC_V_HDAR_IDLE
condition|)
block|{
comment|/* HDA mode */
name|SA_DBG1
argument_list|(
operator|(
literal|"si_check_V_HDA: HDA mode, value = 0x%x\n"
operator|,
name|hda_status
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_HDA_NO_FW_RUNNING
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|si_check_V_Ready
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|bit32
name|SCRATCH_PAD1
decl_stmt|;
name|bit32
name|max_wait_time
decl_stmt|;
name|bit32
name|max_wait_count
decl_stmt|;
comment|/* ILA */
name|max_wait_time
operator|=
operator|(
literal|200
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 200 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_ILA_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_ILA_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"si_check_V_Ready: SCRATCH_PAD1_V_ILA_MASK (0x%x)  not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_ILA_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|AGSA_RC_FAILURE
operator|)
return|;
block|}
comment|/* RAAE */
name|max_wait_time
operator|=
operator|(
literal|200
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 200 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"si_check_V_Ready: SCRATCH_PAD1_V_RAAE_MASK (0x%x) not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_RAAE_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|AGSA_RC_FAILURE
operator|)
return|;
block|}
comment|/* IOP0 */
name|max_wait_time
operator|=
operator|(
literal|200
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 200 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_IOP0_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_IOP0_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"si_check_V_Ready: SCRATCH_PAD1_V_IOP0_MASK (0x%x) not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_IOP0_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|AGSA_RC_FAILURE
operator|)
return|;
block|}
comment|/* IOP1 */
name|max_wait_time
operator|=
operator|(
literal|200
operator|*
literal|1000
operator|)
expr_stmt|;
comment|/* wait 200 milliseconds */
name|max_wait_count
operator|=
name|MAKE_MODULO
argument_list|(
name|max_wait_time
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
do|do
block|{
name|ossaStallThread
argument_list|(
name|agRoot
argument_list|,
name|WAIT_INCREMENT
argument_list|)
expr_stmt|;
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_IOP1_MASK
operator|)
operator|!=
name|SCRATCH_PAD1_V_IOP1_MASK
operator|)
operator|&&
operator|(
name|max_wait_count
operator|-=
name|WAIT_INCREMENT
operator|)
condition|)
do|;
if|if
condition|(
operator|!
name|max_wait_count
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"si_check_V_Ready: SCRATCH_PAD1_V_IOP1_MASK (0x%x) not set SCRATCH_PAD1 = 0x%x\n"
operator|,
name|SCRATCH_PAD1_V_IOP1_MASK
operator|,
name|SCRATCH_PAD1
operator|)
argument_list|)
expr_stmt|;
comment|// return( AGSA_RC_FAILURE);
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|siScratchDump
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|bit32
name|SCRATCH_PAD1
decl_stmt|;
name|bit32
name|ret
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|SALLSDK_DEBUG
name|bit32
name|SCRATCH_PAD2
decl_stmt|;
name|bit32
name|SCRATCH_PAD3
decl_stmt|;
name|bit32
name|SCRATCH_PAD0
decl_stmt|;
name|SCRATCH_PAD0
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_0
argument_list|)
expr_stmt|;
name|SCRATCH_PAD2
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_2
argument_list|)
expr_stmt|;
name|SCRATCH_PAD3
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_3
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
name|SCRATCH_PAD1
operator|=
name|ossaHwRegReadExt
argument_list|(
name|agRoot
argument_list|,
name|PCIBAR0
argument_list|,
name|MSGU_SCRATCH_PAD_1
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siScratchDump: SCRATCH_PAD 0 0x%08x 1 0x%08x 2 0x%08x 3 0x%08x\n"
operator|,
name|SCRATCH_PAD0
operator|,
name|SCRATCH_PAD1
operator|,
name|SCRATCH_PAD2
operator|,
name|SCRATCH_PAD3
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_RESERVED
operator|)
operator|==
name|SCRATCH_PAD1_V_RESERVED
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siScratchDump: SCRATCH_PAD1 SCRATCH_PAD1_V_RESERVED 0x%08x\n"
operator|,
name|SCRATCH_PAD1_V_RESERVED
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|==
name|SCRATCH_PAD1_V_RAAE_MASK
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siScratchDump: SCRATCH_PAD1 valid 0x%08x\n"
operator|,
name|SCRATCH_PAD0
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"siScratchDump: RAAE ready 0x%08x\n"
operator|,
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_ILA_MASK
operator|)
operator|==
name|SCRATCH_PAD1_V_ILA_MASK
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siScratchDump: ILA  ready 0x%08x\n"
operator|,
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_ILA_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_BOOTSTATE_MASK
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siScratchDump: BOOTSTATE not success 0x%08x\n"
operator|,
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_BOOTSTATE_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_IOP0_MASK
operator|)
operator|==
name|SCRATCH_PAD1_V_IOP0_MASK
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siScratchDump: IOP0 ready 0x%08x\n"
operator|,
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_IOP0_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_IOP1_MASK
operator|)
operator|==
name|SCRATCH_PAD1_V_IOP1_MASK
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siScratchDump: IOP1 ready 0x%08x\n"
operator|,
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_IOP1_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_READY
operator|)
operator|==
name|SCRATCH_PAD1_V_READY
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siScratchDump: SCRATCH_PAD1_V_READY  0x%08x\n"
operator|,
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_READY
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_BOOTSTATE_MASK
operator|)
operator|==
name|SCRATCH_PAD1_V_BOOTSTATE_MASK
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siScratchDump: SCRATCH_PAD1_V_BOOTSTATE_MASK  0x%08x\n"
operator|,
name|SCRATCH_PAD1
operator|&
name|SCRATCH_PAD1_V_BOOTSTATE_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
name|si_macro_check
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPC      %d\n"
operator|,
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_HIL      %d\n"
operator|,
name|smIS_HIL
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SFC      %d\n"
operator|,
name|smIS_SFC
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_spc8001  %d\n"
operator|,
name|smIS_spc8001
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_spc8081  %d\n"
operator|,
name|smIS_spc8081
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8008 %d\n"
operator|,
name|smIS_SPCV8008
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8009 %d\n"
operator|,
name|smIS_SPCV8009
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8018 %d\n"
operator|,
name|smIS_SPCV8018
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8019 %d\n"
operator|,
name|smIS_SPCV8019
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_ADAP8088 %d\n"
operator|,
name|smIS_ADAP8088
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_ADAP8089 %d\n"
operator|,
name|smIS_ADAP8089
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8070 %d\n"
operator|,
name|smIS_SPCV8070
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8071 %d\n"
operator|,
name|smIS_SPCV8071
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8072 %d\n"
operator|,
name|smIS_SPCV8072
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8073 %d\n"
operator|,
name|smIS_SPCV8073
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8074 %d\n"
operator|,
name|smIS_SPCV8074
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8075 %d\n"
operator|,
name|smIS_SPCV8075
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8076 %d\n"
operator|,
name|smIS_SPCV8076
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV8077 %d\n"
operator|,
name|smIS_SPCV8077
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV9015 %d\n"
operator|,
name|smIS_SPCV9015
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV9060 %d\n"
operator|,
name|smIS_SPCV9060
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS_SPCV     %d\n"
operator|,
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"si_macro_check:smIS64bInt    %d\n"
operator|,
name|smIS64bInt
argument_list|(
name|agRoot
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


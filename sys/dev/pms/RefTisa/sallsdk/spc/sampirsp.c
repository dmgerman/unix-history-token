begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/*! \file sampirsp.c  *  \brief The file implements the functions of MPI Outbound Response Message  *  */
end_comment

begin_comment
comment|/******************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/spc/saglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SA_ENABLE_TRACE_FUNCTIONS
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|siTraceFileID
end_ifdef

begin_undef
undef|#
directive|undef
name|siTraceFileID
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|siTraceFileID
value|'J'
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Protoytpes */
end_comment

begin_function_decl
name|void
name|saReturnRequestToFreePool
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequestDesc_t
modifier|*
name|pRequest
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Process Outbound IOMB Message  *  *  Process Outbound IOMB from SPC  *  *  \param agRoot       Handles for this instance of SAS/SATA LL Layer  *  \param pMsg1        Pointer of Response IOMB message 1  *  \param category     category of outbpond IOMB header  *  \param opcode       Opcode of Outbound IOMB header  *  \param bc           buffer count of IOMB header  *  *  \return success or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_ifdef
unit|FORCEINLINE bit32 mpiParseOBIomb(   agsaRoot_t        *agRoot,   bit32             *pMsg1,   mpiMsgCategory_t  category,   bit16             opcode   ) {   agsaLLRoot_t      *saRoot = (agsaLLRoot_t *)(agRoot->sdkData);   bit32              ret = AGSA_RC_SUCCESS;   bit32              parserStatus = AGSA_RC_SUCCESS;    smTraceFuncEnter(hpDBG_VERY_LOUD, "2f");    switch (opcode)   {     case OPC_OUB_COMBINED_SSP_COMP:     {       agsaSSPCoalescedCompletionRsp_t  *pIomb = (agsaSSPCoalescedCompletionRsp_t *)pMsg1;       agsaIORequestDesc_t              *pRequest = agNULL;       bit32  tag     = 0;       bit32  sspTag  = 0;       bit32  count   = 0;
ifdef|#
directive|ifdef
name|SALL_API_TEST
end_ifdef

begin_else
unit|saRoot->LLCounters.IOCounter.numSSPCompleted++;       SA_DBG3(("mpiParseOBIomb, SSP_COMP Response received IOMB=%p %d\n",          pMsg1, saRoot->LLCounters.IOCounter.numSSPCompleted));
else|#
directive|else
end_else

begin_endif
unit|SA_DBG3(("mpiParseOBIomb, OPC_OUB_COMBINED_SSP_COMP Response received IOMB=%p\n", pMsg1));
endif|#
directive|endif
end_endif

begin_comment
comment|/* get Tag */
end_comment

begin_comment
unit|for (count = 0; count< pIomb->coalescedCount; count++)       {         tag = pIomb->sspComplCxt[count].tag;         sspTag = pIomb->sspComplCxt[count].SSPTag;         pRequest = (agsaIORequestDesc_t *)saRoot->IOMap[tag].IORequest;         SA_ASSERT((pRequest), "pRequest");          if(pRequest == agNULL)         {           SA_DBG1(("mpiParseOBIomb,OPC_OUB_COMBINED_SSP_COMP Resp IOMB tag=0x%x, status=0x%x, param=0x%x, SSPTag=0x%x\n", tag, OSSA_IO_SUCCESS, 0, sspTag));           return(AGSA_RC_FAILURE);         }         SA_ASSERT((pRequest->valid), "pRequest->valid");          SA_DBG3(("mpiParseOBIomb, OPC_OUB_COMBINED_SSP_COMP IOMB tag=0x%x, status=0x%x, param=0x%x, SSPTag=0x%x\n", tag, OSSA_IO_SUCCESS, 0, sspTag));
comment|/* Completion of SSP without Response Data */
end_comment

begin_ifdef
unit|siIODone( agRoot, pRequest, OSSA_IO_SUCCESS, sspTag);       }     }     break;      case OPC_OUB_SSP_COMP:     {
ifdef|#
directive|ifdef
name|SALL_API_TEST
end_ifdef

begin_else
unit|saRoot->LLCounters.IOCounter.numSSPCompleted++;       SA_DBG3(("mpiParseOBIomb, SSP_COMP Response received IOMB=%p %d\n",          pMsg1, saRoot->LLCounters.IOCounter.numSSPCompleted));
else|#
directive|else
end_else

begin_endif
unit|SA_DBG3(("mpiParseOBIomb, SSP_COMP Response received IOMB=%p\n", pMsg1));
endif|#
directive|endif
end_endif

begin_comment
comment|/* process the SSP IO Completed response message */
end_comment

begin_ifdef
unit|mpiSSPCompletion(agRoot, pMsg1);       break;     }     case OPC_OUB_COMBINED_SATA_COMP:     {       agsaSATACoalescedCompletionRsp_t    *pIomb;       agsaIORequestDesc_t       *pRequest;       bit32                     tag;       bit32                     count;
ifdef|#
directive|ifdef
name|SALL_API_TEST
end_ifdef

begin_else
unit|saRoot->LLCounters.IOCounter.numSSPCompleted++;       SA_DBG3(("mpiParseOBIomb, OPC_OUB_COMBINED_SATA_COMP Response received IOMB=%p %d\n",          pMsg1, saRoot->LLCounters.IOCounter.numSSPCompleted));
else|#
directive|else
end_else

begin_endif
unit|SA_DBG3(("mpiParseOBIomb, OPC_OUB_COMBINED_SATA_COMP Response received IOMB=%p\n", pMsg1));
endif|#
directive|endif
end_endif

begin_comment
unit|pIomb = (agsaSATACoalescedCompletionRsp_t *)pMsg1;
comment|/* get Tag */
end_comment

begin_comment
unit|for (count = 0; count< pIomb->coalescedCount; count++)       {         tag = pIomb->stpComplCxt[count].tag;         pRequest = (agsaIORequestDesc_t *)saRoot->IOMap[tag].IORequest;         SA_ASSERT((pRequest), "pRequest");          if(pRequest == agNULL)         {           SA_DBG1(("mpiParseOBIomb,OPC_OUB_COMBINED_SATA_COMP Resp IOMB tag=0x%x, status=0x%x, param=0x%x\n", tag, OSSA_IO_SUCCESS, 0));           return(AGSA_RC_FAILURE);         }         SA_ASSERT((pRequest->valid), "pRequest->valid");          SA_DBG3(("mpiParseOBIomb, OPC_OUB_COMBINED_SATA_COMP IOMB tag=0x%x, status=0x%x, param=0x%x\n", tag, OSSA_IO_SUCCESS, 0));
comment|/* Completion of SATA without Response Data */
end_comment

begin_ifdef
unit|siIODone( agRoot, pRequest, OSSA_IO_SUCCESS, 0);       }       break;     }     case OPC_OUB_SATA_COMP:     {
ifdef|#
directive|ifdef
name|SALL_API_TEST
end_ifdef

begin_else
unit|saRoot->LLCounters.IOCounter.numSataCompleted++;       SA_DBG3(("mpiParseOBIomb, SATA_COMP Response received IOMB=%p %d\n",              pMsg1, saRoot->LLCounters.IOCounter.numSataCompleted));
else|#
directive|else
end_else

begin_endif
unit|SA_DBG3(("mpiParseOBIomb, SATA_COMP Response received IOMB=%p\n", pMsg1));
endif|#
directive|endif
end_endif

begin_comment
comment|/* process the response message */
end_comment

begin_ifdef
unit|mpiSATACompletion(agRoot, pMsg1);       break;     }     case OPC_OUB_SSP_ABORT_RSP:     {
ifdef|#
directive|ifdef
name|SALL_API_TEST
end_ifdef

begin_else
unit|saRoot->LLCounters.IOCounter.numSSPAbortedCB++;
else|#
directive|else
end_else

begin_endif
unit|SA_DBG3(("mpiParseOBIomb, SSP_ABORT Response received IOMB=%p\n", pMsg1));
endif|#
directive|endif
end_endif

begin_comment
comment|/* process the response message */
end_comment

begin_ifdef
unit|parserStatus = mpiSSPAbortRsp(agRoot, (agsaSSPAbortRsp_t *)pMsg1);       if(parserStatus !=  AGSA_RC_SUCCESS)       {          SA_DBG3(("mpiParseOBIomb, mpiSSPAbortRsp FAIL IOMB=%p\n", pMsg1));       }        break;     }     case OPC_OUB_SATA_ABORT_RSP:     {
ifdef|#
directive|ifdef
name|SALL_API_TEST
end_ifdef

begin_else
unit|saRoot->LLCounters.IOCounter.numSataAbortedCB++;
else|#
directive|else
end_else

begin_endif
unit|SA_DBG3(("mpiParseOBIomb, SATA_ABORT Response received IOMB=%p\n", pMsg1));
endif|#
directive|endif
end_endif

begin_comment
comment|/* process the response message */
end_comment

begin_comment
unit|mpiSATAAbortRsp(agRoot, (agsaSATAAbortRsp_t *)pMsg1);       break;     }     case OPC_OUB_SATA_EVENT:     {       SA_DBG3(("mpiParseOBIomb, SATA_EVENT Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiSATAEvent(agRoot, (agsaSATAEventRsp_t *)pMsg1);       break;     }     case OPC_OUB_SSP_EVENT:     {       SA_DBG3(("mpiParseOBIomb, SSP_EVENT Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_ifdef
unit|mpiSSPEvent(agRoot, (agsaSSPEventRsp_t *)pMsg1);       break;     }     case OPC_OUB_SMP_COMP:     {
ifdef|#
directive|ifdef
name|SALL_API_TEST
end_ifdef

begin_else
unit|saRoot->LLCounters.IOCounter.numSMPCompleted++;       SA_DBG3(("mpiParseOBIomb, SMP_COMP Response received IOMB=%p, %d\n",              pMsg1, saRoot->LLCounters.IOCounter.numSMPCompleted));
else|#
directive|else
end_else

begin_endif
unit|SA_DBG3(("mpiParseOBIomb, SMP_COMP Response received IOMB=%p\n", pMsg1));
endif|#
directive|endif
end_endif

begin_comment
comment|/* process the response message */
end_comment

begin_ifndef
unit|mpiSMPCompletion(agRoot, (agsaSMPCompletionRsp_t *)pMsg1);       break;     }
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_ifdef
unit|case OPC_OUB_ECHO:     {
ifdef|#
directive|ifdef
name|SALL_API_TEST
end_ifdef

begin_else
unit|saRoot->LLCounters.IOCounter.numEchoCB++;       SA_DBG3(("mpiParseOBIomb, ECHO Response received %d\n", saRoot->LLCounters.IOCounter.numEchoCB));
else|#
directive|else
end_else

begin_endif
unit|SA_DBG3(("mpiParseOBIomb, ECHO Response received\n"));
endif|#
directive|endif
end_endif

begin_comment
comment|/* process the response message */
end_comment

begin_endif
unit|mpiEchoRsp(agRoot, (agsaEchoRsp_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_comment
unit|case OPC_OUB_GET_NVMD_DATA:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_GET_NVMD_DATA received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiGetNVMDataRsp(agRoot, (agsaGetNVMDataRsp_t *)pMsg1);       break;     }     case OPC_OUB_SPC_HW_EVENT:     {       SA_ASSERT((smIS_SPC(agRoot)), "smIS_SPC");       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SPC_HW_EVENT Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiHWevent(agRoot, (agsaHWEvent_SPC_OUB_t *)pMsg1);       break;     }     case OPC_OUB_HW_EVENT:     {       SA_DBG3(("mpiParseOBIomb, HW_EVENT Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiHWevent(agRoot, (agsaHWEvent_SPC_OUB_t *)pMsg1);       break;     }     case OPC_OUB_PHY_START_RESPONSE:     {       SA_DBG1(("mpiParseOBIomb, OPC_OUB_PHY_START_RESPONSE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiPhyStartEvent( agRoot, (agsaHWEvent_Phy_OUB_t  *)pMsg1  );        break;     }     case OPC_OUB_PHY_STOP_RESPONSE:     {       SA_DBG1(("mpiParseOBIomb, OPC_OUB_PHY_STOP_RESPONSE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiPhyStopEvent( agRoot, (agsaHWEvent_Phy_OUB_t  *)pMsg1  );       break;     }      case OPC_OUB_LOCAL_PHY_CNTRL:     {       SA_DBG3(("mpiParseOBIomb, PHY CONTROL Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiPhyCntrlRsp(agRoot, (agsaLocalPhyCntrlRsp_t *)pMsg1);       break;     }     case OPC_OUB_SPC_DEV_REGIST:     {       SA_ASSERT((smIS_SPC(agRoot)), "smIS_SPC");       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SPC_DEV_REGIST Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiDeviceRegRsp(agRoot, (agsaDeviceRegistrationRsp_t *)pMsg1);       break;     }     case OPC_OUB_DEV_REGIST:     {       SA_DBG2(("mpiParseOBIomb, DEV_REGISTRATION Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiDeviceRegRsp(agRoot, (agsaDeviceRegistrationRsp_t *)pMsg1);       break;     }     case OPC_OUB_DEREG_DEV:     {       SA_DBG3(("mpiParseOBIomb, DEREGISTRATION DEVICE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_ifndef
unit|mpiDeregDevHandleRsp(agRoot, (agsaDeregDevHandleRsp_t *)pMsg1);       break;     }
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_comment
unit|case OPC_OUB_GET_DEV_HANDLE:     {       SA_DBG3(("mpiParseOBIomb, GET_DEV_HANDLE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_endif
unit|mpiGetDevHandleRsp(agRoot, (agsaGetDevHandleRsp_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_comment
unit|case OPC_OUB_SPC_DEV_HANDLE_ARRIV:     {       SA_DBG3(("mpiParseOBIomb, SPC_DEV_HANDLE_ARRIV Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiDeviceHandleArrived(agRoot, (agsaDeviceHandleArrivedNotify_t *)pMsg1);       break;     }     case OPC_OUB_DEV_HANDLE_ARRIV:     {       SA_DBG3(("mpiParseOBIomb, DEV_HANDLE_ARRIV Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_if
unit|mpiDeviceHandleArrived(agRoot, (agsaDeviceHandleArrivedNotify_t *)pMsg1);       break;     }
if|#
directive|if
literal|0
end_if

begin_comment
comment|//Sunitha
end_comment

begin_endif
unit|case OPC_OUB_THERM_HW_EVENT: 	{       SA_DBG3(("mpiParseOBIomb, THERM_HW_EVENT Response received IOMB=%p\n", pMsg1));       ossaLogThermalEvent(agRoot, (agsaThermal_Hw_Event_Notify_t *)pMsg1);       break; 	}
endif|#
directive|endif
end_endif

begin_comment
comment|//Sunitha
end_comment

begin_comment
unit|case OPC_OUB_SSP_RECV_EVENT:     {       SA_DBG3(("mpiParseOBIomb, SSP_RECV_EVENT Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiSSPReqReceivedNotify(agRoot, (agsaSSPReqReceivedNotify_t *)pMsg1);       break;     }     case OPC_OUB_DEV_INFO:     {       SA_ASSERT((smIS_SPCV(agRoot)), "smIS_SPCV");       SA_DBG3(("mpiParseOBIomb, DEV_INFO Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_ifndef
unit|mpiGetDevInfoRsp(agRoot, (agsaGetDevInfoRspV_t *)pMsg1);       break;     }
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_comment
unit|case OPC_OUB_GET_PHY_PROFILE_RSP:     {       SA_ASSERT((smIS_SPCV(agRoot)), "smIS_SPCV");       SA_DBG2(("mpiParseOBIomb, OPC_OUB_GET_PHY_PROFILE_RSP Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiGetPhyProfileRsp(agRoot, (agsaGetPhyProfileRspV_t *)pMsg1);       break;     }     case OPC_OUB_SET_PHY_PROFILE_RSP:     {       SA_ASSERT((smIS_SPCV(agRoot)), "smIS_SPCV");       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SET_PHY_PROFILE_RSP Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_endif
unit|mpiSetPhyProfileRsp(agRoot, (agsaSetPhyProfileRspV_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_comment
comment|/* BIOS */
end_comment

begin_comment
unit|case OPC_OUB_SPC_DEV_INFO:     {       SA_ASSERT((smIS_SPC(agRoot)), "smIS_SPC");       SA_DBG3(("mpiParseOBIomb, DEV_INFO Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiGetDevInfoRspSpc(agRoot, (agsaGetDevInfoRsp_t *)pMsg1);       break;     }     case OPC_OUB_FW_FLASH_UPDATE:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_FW_FLASH_UPDATE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiFwFlashUpdateRsp(agRoot, (agsaFwFlashUpdateRsp_t *)pMsg1);       break;     }     case OPC_OUB_FLASH_OP_EXT_RSP:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_FW_FLASH_UPDATE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_ifndef
unit|mpiFwExtFlashUpdateRsp(agRoot, (agsaFwFlashOpExtRsp_t *)pMsg1);       break;     }
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|SPC_ENABLE_PROFILE
end_ifdef

begin_comment
unit|case OPC_OUB_FW_PROFILE:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_FW_PROFILE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_endif
unit|mpiFwProfileRsp(agRoot, (agsaFwProfileRsp_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_comment
unit|case OPC_OUB_SET_NVMD_DATA:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SET_NVMD_DATA received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiSetNVMDataRsp(agRoot, (agsaSetNVMDataRsp_t *)pMsg1);       break;     }      case OPC_OUB_GPIO_RESPONSE:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SET_GPIO_RESPONSE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiGPIORsp(agRoot, (agsaGPIORsp_t *)pMsg1);       break;     }     case OPC_OUB_GPIO_EVENT:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SET_GPIO_RESPONSE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_endif
unit|mpiGPIOEventRsp(agRoot, (agsaGPIOEvent_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_comment
comment|/* BIOS */
end_comment

begin_comment
unit|case OPC_OUB_GENERAL_EVENT:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SET_GENERAL_EVENT Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_ifndef
unit|mpiGeneralEventRsp(agRoot, (agsaGeneralEventRsp_t *)pMsg1);       break;     }
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_comment
unit|case OPC_OUB_SAS_DIAG_MODE_START_END:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SAS_DIAG_MODE_START_END Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiSASDiagStartEndRsp(agRoot, (agsaSASDiagStartEndRsp_t *)pMsg1);       break;     }     case OPC_OUB_SAS_DIAG_EXECUTE:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SAS_DIAG_EXECUTE_RSP Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_endif
unit|mpiSASDiagExecuteRsp(agRoot, (agsaSASDiagExecuteRsp_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_comment
comment|/* BIOS */
end_comment

begin_comment
unit|case OPC_OUB_GET_TIME_STAMP:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_GET_TIME_STAMP Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiGetTimeStampRsp(agRoot, (agsaGetTimeStampRsp_t *)pMsg1);       break;     }      case OPC_OUB_SPC_SAS_HW_EVENT_ACK:     {       SA_ASSERT((smIS_SPC(agRoot)), "smIS_SPC");       SA_DBG3(("mpiParseOBIomb,OPC_OUB_SPC_SAS_HW_EVENT_ACK  Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiSASHwEventAckRsp(agRoot, (agsaSASHwEventAckRsp_t *)pMsg1);       break;     }      case OPC_OUB_SAS_HW_EVENT_ACK:     {       SA_ASSERT((smIS_SPCV(agRoot)), "smIS_SPCV");       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SAS_HW_EVENT_ACK Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiSASHwEventAckRsp(agRoot, (agsaSASHwEventAckRsp_t *)pMsg1);       break;     }     case OPC_OUB_PORT_CONTROL:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_PORT_CONTROL Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_ifdef
unit|mpiPortControlRsp(agRoot, (agsaPortControlRsp_t *)pMsg1);       break;     }     case OPC_OUB_SMP_ABORT_RSP:     {
ifdef|#
directive|ifdef
name|SALL_API_TEST
end_ifdef

begin_else
unit|saRoot->LLCounters.IOCounter.numSMPAbortedCB++;       SA_DBG3(("mpiParseOBIomb, SMP_ABORT Response received IOMB=%p, %d\n",              pMsg1, saRoot->LLCounters.IOCounter.numSMPAbortedCB));
else|#
directive|else
end_else

begin_endif
unit|SA_DBG3(("mpiParseOBIomb, OPC_OUB_SMP_ABORT_RSP Response received IOMB=%p\n", pMsg1));
endif|#
directive|endif
end_endif

begin_comment
comment|/* process the response message */
end_comment

begin_comment
unit|mpiSMPAbortRsp(agRoot, (agsaSMPAbortRsp_t *)pMsg1);       break;     }     case OPC_OUB_DEVICE_HANDLE_REMOVAL:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_DEVICE_HANDLE_REMOVAL received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiDeviceHandleRemoval(agRoot, (agsaDeviceHandleRemoval_t *)pMsg1);       break;     }     case OPC_OUB_SET_DEVICE_STATE:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SET_DEVICE_STATE received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_ifndef
unit|mpiSetDeviceStateRsp(agRoot, (agsaSetDeviceStateRsp_t *)pMsg1);       break;     }
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_comment
unit|case OPC_OUB_GET_DEVICE_STATE:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_GET_DEVICE_STATE received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_endif
unit|mpiGetDeviceStateRsp(agRoot, (agsaGetDeviceStateRsp_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_comment
comment|/* BIOS */
end_comment

begin_comment
unit|case OPC_OUB_SET_DEV_INFO:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SET_DEV_INFO received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_ifndef
unit|mpiSetDevInfoRsp(agRoot, (agsaSetDeviceInfoRsp_t *)pMsg1);       break;     }
ifndef|#
directive|ifndef
name|BIOS_DEBUG
end_ifndef

begin_comment
unit|case OPC_OUB_SAS_RE_INITIALIZE:     {       SA_ASSERT((smIS_SPC(agRoot)), "smIS_SPC");       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SAS_RE_INITIALIZE received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_endif
unit|mpiSasReInitializeRsp(agRoot, (agsaSasReInitializeRsp_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_comment
comment|/* BIOS */
end_comment

begin_comment
unit|case OPC_OUB_SGPIO_RESPONSE:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SGPIO_RESPONSE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_ifndef
unit|mpiSGpioRsp(agRoot, (agsaSGpioRsp_t *)pMsg1);       break;     }
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_comment
unit|case OPC_OUB_PCIE_DIAG_EXECUTE:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_PCIE_DIAG_EXECUTE Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_comment
unit|mpiPCIeDiagExecuteRsp(agRoot, (agsaPCIeDiagExecuteRsp_t *)pMsg1);       break;     }     case 2104:
comment|//delray start
end_comment

begin_comment
unit|{       if(smIS_SPC6V(agRoot))       {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_GET_DFE_DATA_RSP Response received IOMB=%p\n", pMsg1));
comment|/* process the response message */
end_comment

begin_endif
unit|mpiGetDFEDataRsp(agRoot, (agsaGetDDEFDataRsp_t *)pMsg1);       }       if(smIS_SPC12V(agRoot))       {         SA_DBG3(("mpiParseOBIomb, OPC_INB_GET_VIST_CAP Response received IOMB=%p\n", pMsg1));         mpiGetVisRsp(agRoot, (agsaGetVisCapRsp_t *)pMsg1);       }         else       {         SA_DBG1(("mpiParseOBIomb, 2104  Response received IOMB=%p\n", pMsg1));       }       break;     }
endif|#
directive|endif
end_endif

begin_comment
comment|/* BIOS */
end_comment

begin_ifndef
unit|case OPC_OUB_SET_CONTROLLER_CONFIG:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_SET_CONTROLLER_CONFIG Response received IOMB=%p\n", pMsg1));       mpiSetControllerConfigRsp(agRoot, (agsaSetControllerConfigRsp_t *)pMsg1);       break;     }
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_endif
unit|case OPC_OUB_GET_CONTROLLER_CONFIG:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_GET_CONTROLLER_CONFIG Response received IOMB=%p\n", pMsg1));       mpiGetControllerConfigRsp(agRoot, (agsaGetControllerConfigRsp_t *)pMsg1);       break;     }     case OPC_OUB_KEK_MANAGEMENT:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_KEK_MANAGEMENT Response received IOMB=%p\n", pMsg1));       mpiKekManagementRsp(agRoot, (agsaKekManagementRsp_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_comment
comment|/* BIOS */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|UN_USED_FUNC
end_ifdef

begin_endif
unit|case OPC_OUB_DEK_MANAGEMENT:     {       SA_DBG3(("mpiParseOBIomb, OPC_OUB_DEK_MANAGEMENT Response received IOMB=%p\n", pMsg1));       mpiDekManagementRsp(agRoot, (agsaDekManagementRsp_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_endif
unit|case OPC_OUB_OPR_MGMT:     {       SA_DBG1(("mpiParseOBIomb, OPC_OUB_OPR_MGMT Response received IOMB=%p\n", pMsg1));       mpiOperatorManagementRsp(agRoot, (agsaOperatorMangmenRsp_t *)pMsg1);       break;     }     case OPC_OUB_ENC_TEST_EXECUTE:     {       SA_DBG1(("mpiParseOBIomb, OPC_OUB_ENC_TEST_EXECUTE Response received IOMB=%p\n", pMsg1));       mpiBistRsp(agRoot, (agsaEncryptBistRsp_t *)pMsg1);       break;     }
endif|#
directive|endif
end_endif

begin_comment
comment|/* BIOS */
end_comment

begin_comment
unit|case OPC_OUB_SET_OPERATOR:     {       SA_DBG1(("mpiParseOBIomb, OPC_OUB_SET_OPERATOR Response received IOMB=%p\n", pMsg1));       mpiSetOperatorRsp(agRoot, (agsaSetOperatorRsp_t *)pMsg1);       break;     }     case OPC_OUB_GET_OPERATOR:     {       SA_DBG1(("mpiParseOBIomb, OPC_OUB_GET_OPERATOR Response received IOMB=%p\n", pMsg1));       mpiGetOperatorRsp(agRoot, (agsaGetOperatorRsp_t *)pMsg1);       break;     }     case OPC_OUB_DIF_ENC_OFFLOAD_RSP:
comment|//delray start
end_comment

begin_comment
unit|{       SA_ASSERT((smIS_SPCV(agRoot)), "smIS_SPCV");       SA_DBG1(("mpiParseOBIomb, OPC_OUB_DIF_ENC_OFFLOAD_RSP Response received IOMB=%p\n", pMsg1));       mpiDifEncOffloadRsp(agRoot, (agsaDifEncOffloadRspV_t *)pMsg1);       break;     }
comment|//delray end
end_comment

begin_ifdef
unit|default:     {
ifdef|#
directive|ifdef
name|SALL_API_TEST
end_ifdef

begin_else
unit|saRoot->LLCounters.IOCounter.numUNKNWRespIOMB++;       SA_DBG1(("mpiParseOBIomb, UnKnown Response received IOMB=%p, %d\n",              pMsg1, saRoot->LLCounters.IOCounter.numUNKNWRespIOMB));
else|#
directive|else
end_else

begin_endif
unit|SA_DBG1(("mpiParseOBIomb, Unknown IOMB Response received opcode 0x%X IOMB=%p\n",opcode, pMsg1));
endif|#
directive|endif
end_endif

begin_comment
unit|break;     }   }
comment|/* switch */
end_comment

begin_endif
unit|smTraceFuncExit(hpDBG_VERY_LOUD, 'a', "2f");    return ret;  }
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|BIOS
end_ifndef

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief ECHO Response  *  *  This routine handles the response of ECHO Command  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiEchoRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaEchoRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2g"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiEchoRsp: HTAG=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEchoRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiEchoRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2g"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
name|ossaEchoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|pIomb
operator|->
name|payload
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiEchoRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2g"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Get NVM Data Response  *  *  This routine handles the response of GET NVM Data Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetNVMDataRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGetNVMDataRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|i
decl_stmt|,
name|dataLen
decl_stmt|;
name|bit32
name|DlenStatus
decl_stmt|,
name|tag
decl_stmt|,
name|iRTdaBnDpsAsNvm
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2h"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetNVMDataRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|DlenStatus
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetNVMDataRsp_t
argument_list|,
name|DlenStatus
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|iRTdaBnDpsAsNvm
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetNVMDataRsp_t
argument_list|,
name|iRTdaBnDpsAsNvm
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|dataLen
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetNVMDataRsp_t
argument_list|,
name|NVMData
index|[
literal|10
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetNVMDataRsp: HTAG=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetNVMDataRsp: Bad Response IOMB!!! pRequest is NULL.\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2h"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
if|if
condition|(
name|iRTdaBnDpsAsNvm
operator|&
name|IRMode
condition|)
block|{
comment|/* indirect mode - IR bit set */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetNVMDataRsp: OSSA_SUCCESS, IR=1, DataLen=%d\n"
operator|,
name|dataLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_CONFIG_SEEPROM
operator|)
operator|||
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_VPD_FLASH
operator|)
operator|||
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_TWI_DEVICES
operator|)
operator|||
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_EXPANSION_ROM
operator|)
operator|||
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_IOP_REG_FLASH
operator|)
condition|)
block|{
comment|/* CB for NVMD */
comment|//#ifdef UN_USED_FUNC
name|ossaGetNVMDResponseCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
operator|(
name|DlenStatus
operator|&
name|NVMD_STAT
operator|)
argument_list|,
name|INDIRECT_MODE
argument_list|,
name|dataLen
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
comment|//#endif
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AAP1_RDUMP
operator|)
operator|||
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|IOP_RDUMP
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|UN_USED_FUNC
if|if
condition|(
operator|(
name|DlenStatus
operator|&
name|NVMD_STAT
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* CB for Register Dump */
name|ossaGetRegisterDumpCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|OSSA_SUCCESS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* CB for Register Dump */
name|ossaGetRegisterDumpCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|OSSA_FAILURE
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
else|else
block|{
comment|/* Should not be happened */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetNVMDataRsp: (IR=1)Wrong Device type 0x%x\n"
operator|,
name|iRTdaBnDpsAsNvm
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
comment|/* direct mode */
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetNVMDataRsp: OSSA_SUCCESS, IR=0, DataLen=%d\n"
operator|,
operator|(
operator|(
name|DlenStatus
operator|&
name|NVMD_LEN
operator|)
operator|>>
name|SHIFT24
operator|)
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
operator|(
operator|(
name|DlenStatus
operator|&
name|NVMD_LEN
operator|)
operator|>>
name|SHIFT24
operator|)
operator|/
literal|4
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetNVMDataRsp: OSSA_SUCCESS, NVMDATA=0x%x\n"
operator|,
name|pIomb
operator|->
name|NVMData
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_CONFIG_SEEPROM
operator|)
operator|||
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_VPD_FLASH
operator|)
operator|||
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_TWI_DEVICES
operator|)
condition|)
block|{
comment|/* CB for NVMD */
comment|//    char * safe_type_pun = (char *)(&pIomb->NVMData[0]);
ifdef|#
directive|ifdef
name|UN_USED_FUNC
name|ossaGetNVMDResponseCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
operator|(
name|DlenStatus
operator|&
name|NVMD_STAT
operator|)
argument_list|,
name|DIRECT_MODE
argument_list|,
operator|(
operator|(
name|DlenStatus
operator|&
name|NVMD_LEN
operator|)
operator|>>
name|SHIFT24
operator|)
argument_list|,
operator|(
name|agsaFrameHandle_t
operator|*
operator|)
name|safe_type_pun
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AAP1_RDUMP
operator|)
operator|||
operator|(
operator|(
name|iRTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|IOP_RDUMP
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|UN_USED_FUNC
if|if
condition|(
operator|(
name|DlenStatus
operator|&
name|NVMD_STAT
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* CB for Register Dump */
name|ossaGetRegisterDumpCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|OSSA_SUCCESS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* CB for Register Dump */
name|ossaGetRegisterDumpCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|OSSA_FAILURE
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
else|else
block|{
comment|/* Should not be happened */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetNVMDataRsp: (IR=0)Wrong Device type 0x%x\n"
operator|,
name|iRTdaBnDpsAsNvm
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetNVMDataRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2h"
argument_list|)
expr_stmt|;
comment|/* return value */
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Phy Event Response from SPCv  *  *  Process Phy Event from SPC  *  *  \param agRoot        Handles for this instance of SAS/SATA LL Layer  *  \param pIomb         pointer of IOMB  *  *  \return success or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiPhyStartEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaHWEvent_Phy_OUB_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|bit32
name|phyId
decl_stmt|;
name|bit32
name|IOMBStatus
decl_stmt|;
name|bit32
name|tag
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|HwCBStatus
decl_stmt|;
if|if
condition|(
name|saRoot
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStartEvent: saRoot == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|AGSA_RC_FAILURE
operator|)
return|;
block|}
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2H"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_Phy_OUB_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStartEvent: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x \n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2H"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStartEvent: Status 0x%X PhyId 0x%X\n"
operator|,
name|pIomb
operator|->
name|Status
operator|,
name|pIomb
operator|->
name|ReservedPhyId
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IOMBStatus
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_Phy_OUB_t
argument_list|,
name|Status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|phyId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_Phy_OUB_t
argument_list|,
name|ReservedPhyId
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|IOMBStatus
condition|)
block|{
case|case
name|OSSA_MPI_IO_SUCCESS
case|:
comment|/* PhyStart operation completed successfully */
name|HwCBStatus
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|linkstatus
operator|=
literal|1
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStartEvent:MPI_IO_SUCCESS IOMBStatus 0x%x for phyId 0x%x\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
comment|/* Callback with PHY_UP */
break|break;
case|case
name|OSSA_MPI_ERR_INVALID_PHY_ID
case|:
comment|/* identifier specified in the PHY_START command is invalid i.e out of supported range for this product. */
name|HwCBStatus
operator|=
literal|1
expr_stmt|;
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|linkstatus
operator|=
literal|0
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStartEvent: MPI_ERR_INVALID_PHY_ID IOMBStatus 0x%x for phyId 0x%x\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ERR_PHY_ALREADY_STARTED
case|:
name|HwCBStatus
operator|=
literal|2
expr_stmt|;
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|linkstatus
operator|=
literal|1
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStartEvent: MPI_ERR_PHY_ALREADY_STARTED IOMBStatus 0x%x for phyId 0x%x\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ERR_INVALID_ANALOG_TBL_IDX
case|:
name|HwCBStatus
operator|=
literal|4
expr_stmt|;
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|linkstatus
operator|=
literal|0
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStartEvent: MPI_ERR_INVALID_ANALOG_TBL_IDX IOMBStatus 0x%x for phyId 0x%x\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
break|break;
default|default:
name|HwCBStatus
operator|=
literal|3
expr_stmt|;
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|linkstatus
operator|=
literal|0
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStartEvent: Unknown IOMBStatus 0x%x for phyId 0x%x\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
break|break;
block|}
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_PHY_START_STATUS
argument_list|,
operator|(
operator|(
name|HwCBStatus
operator|<<
name|SHIFT8
operator|)
operator||
name|phyId
operator|)
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
comment|/* return the request to free pool */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStartEvent: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|mpiPhyStopEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaHWEvent_Phy_OUB_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|bit32
name|phyId
decl_stmt|;
name|bit32
name|IOMBStatus
decl_stmt|;
name|bit32
name|HwCBStatus
decl_stmt|;
name|bit32
name|tag
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaPhy_t
modifier|*
name|pPhy
decl_stmt|;
name|agsaPort_t
modifier|*
name|pPort
decl_stmt|;
if|if
condition|(
name|saRoot
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStopEvent: saRoot == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|AGSA_RC_FAILURE
operator|)
return|;
block|}
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_Phy_OUB_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStopEvent: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x \n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2H"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IOMBStatus
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_Phy_OUB_t
argument_list|,
name|Status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|phyId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_Phy_OUB_t
argument_list|,
name|ReservedPhyId
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStopEvent: Status %08X PhyId %08X\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|phyId
operator|&=
literal|0xff
expr_stmt|;
comment|// SPCv PHY_ID is one byte wide
block|}
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|linkstatus
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|IOMBStatus
condition|)
block|{
case|case
name|OSSA_MPI_IO_SUCCESS
case|:
comment|/* PhyStart operation completed successfully */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStopEvent:MPI_IO_SUCCESS  0x%x for phyId 0x%x\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|HwCBStatus
operator|=
literal|0
expr_stmt|;
comment|/* Callback with PHY_DOWN */
break|break;
case|case
name|OSSA_MPI_ERR_INVALID_PHY_ID
case|:
comment|/* identifier specified in the PHY_START command is invalid i.e out of supported range for this product. */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStopEvent: MPI_ERR_INVALID_PHY_ID 0x%x for phyId 0x%x\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|HwCBStatus
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ERR_PHY_NOT_STARTED
case|:
comment|/* An attempt to stop a phy which is not started  */
name|HwCBStatus
operator|=
literal|4
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStopEvent:  0x%x for phyId 0x%x\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ERR_DEVICES_ATTACHED
case|:
comment|/* All the devices in a port need to be deregistered if the PHY_STOP is for the last phy  */
name|HwCBStatus
operator|=
literal|2
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStopEvent:  0x%x for phyId 0x%x\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|HwCBStatus
operator|=
literal|3
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStopEvent: Unknown Status 0x%x for phyId 0x%x\n"
operator|,
name|IOMBStatus
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|HwCBStatus
operator|==
literal|0
condition|)
block|{
name|pPhy
operator|=
operator|&
operator|(
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|)
expr_stmt|;
comment|/* get the port of the phy */
name|pPort
operator|=
name|pPhy
operator|->
name|pPort
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|pPort
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siPhyStopCB: phy%d invalidating port\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
comment|/* invalid port state, remove the port */
name|pPort
operator|->
name|status
operator||=
name|PORT_INVALIDATING
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|pPort
operator|->
name|portId
index|]
operator|.
name|PortStatus
operator||=
name|PORT_INVALIDATING
expr_stmt|;
comment|/* invalid the port */
name|siPortInvalid
argument_list|(
name|agRoot
argument_list|,
name|pPort
argument_list|)
expr_stmt|;
comment|/* map out the portmap */
name|saRoot
operator|->
name|PortMap
index|[
name|pPort
operator|->
name|portId
index|]
operator|.
name|PortContext
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|pPort
operator|->
name|portId
index|]
operator|.
name|PortID
operator|=
name|PORT_MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|pPort
operator|->
name|portId
index|]
operator|.
name|PortStatus
operator||=
name|PORT_INVALIDATING
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
operator|&
operator|(
name|pPort
operator|->
name|portContext
operator|)
argument_list|,
name|OSSA_HW_EVENT_PHY_STOP_STATUS
argument_list|,
operator|(
operator|(
name|HwCBStatus
operator|<<
name|SHIFT8
operator|)
operator||
name|phyId
operator|)
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siPhyStopCB: phy%d - Port is not established\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_PHY_STOP_STATUS
argument_list|,
operator|(
operator|(
name|HwCBStatus
operator|<<
name|SHIFT8
operator|)
operator||
name|phyId
operator|)
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
comment|/* set PHY_STOPPED status */
name|PHY_STATUS_SET
argument_list|(
name|pPhy
argument_list|,
name|PHY_STOPPED
argument_list|)
expr_stmt|;
comment|/* Exclude the phy from a port */
if|if
condition|(
name|agNULL
operator|!=
name|pPort
condition|)
block|{
comment|/* Acquire port list lock */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_PORT_LOCK
argument_list|)
expr_stmt|;
comment|/* Delete the phy from the port */
name|pPort
operator|->
name|phyMap
index|[
name|phyId
index|]
operator|=
name|agFALSE
expr_stmt|;
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|pPort
operator|=
name|agNULL
expr_stmt|;
comment|/* Release port list lock */
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_PORT_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"siPhyStopCB: Error phy%d - Port is not established\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_PHY_STOP_STATUS
argument_list|,
operator|(
operator|(
name|HwCBStatus
operator|<<
name|SHIFT8
operator|)
operator||
name|phyId
operator|)
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
comment|/* return the request to free pool */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyStartEvent: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Hardware Event Response from SPC  *  *  Process HW Event from SPC  *  *  \param agRoot        Handles for this instance of SAS/SATA LL Layer  *  \param pIomb         pointer of IOMB  *  *  \return success or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiHWevent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaHWEvent_SPC_OUB_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaPortContext_t
modifier|*
name|agPortContext
decl_stmt|;
name|agsaSASIdentify_t
modifier|*
name|IDframe
decl_stmt|;
name|agsaFisRegDeviceToHost_t
modifier|*
name|sataFis
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaPort_t
modifier|*
name|pPort
init|=
name|agNULL
decl_stmt|;
name|bit32
name|phyId
decl_stmt|;
name|bit32
name|portId
decl_stmt|;
name|bit32
name|Event
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|status
decl_stmt|;
name|bit8
name|linkRate
decl_stmt|;
name|bit32
name|LREventPhyIdPortId
decl_stmt|;
name|bit32
name|npipps
decl_stmt|,
name|eventParam
decl_stmt|,
name|npip
decl_stmt|,
name|port_state
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2j"
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|saRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWevent: saRoot == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|AGSA_RC_FAILURE
operator|)
return|;
block|}
if|if
condition|(
name|smIS_SPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|LREventPhyIdPortId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_SPC_OUB_t
argument_list|,
name|LRStatusEventPhyIdPortId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|npipps
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_SPC_OUB_t
argument_list|,
name|NpipPortState
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|eventParam
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_SPC_OUB_t
argument_list|,
name|EVParam
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiHWEvent: S, LREventPhyIdPortId 0x%08x npipps 0x%08x eventParam 0x%08x\n"
operator|,
name|LREventPhyIdPortId
operator|,
name|npipps
operator|,
name|eventParam
operator|)
argument_list|)
expr_stmt|;
comment|/* get port context */
name|portId
operator|=
name|LREventPhyIdPortId
operator|&
name|PORTID_MASK
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QK"
argument_list|,
name|portId
argument_list|)
expr_stmt|;
comment|/* TP:QK portId */
comment|/* get phyId */
name|phyId
operator|=
operator|(
name|LREventPhyIdPortId
operator|&
name|PHY_ID_BITS
operator|)
operator|>>
name|SHIFT4
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QK"
argument_list|,
name|npipps
argument_list|)
expr_stmt|;
comment|/* TP:QK npipps */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QL"
argument_list|,
name|portId
argument_list|)
expr_stmt|;
comment|/* TP:QL portId */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QM"
argument_list|,
name|phyId
argument_list|)
expr_stmt|;
comment|/* TP:QM phyId */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent:SPC, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|LREventPhyIdPortId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_V_OUB_t
argument_list|,
name|LRStatEventPortId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|npipps
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_V_OUB_t
argument_list|,
name|RsvPhyIdNpipRsvPortState
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|eventParam
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_V_OUB_t
argument_list|,
name|EVParam
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiHWEvent: V, LREventPhyIdPortId 0x%08x npipps 0x%08x eventParam 0x%08x\n"
operator|,
name|LREventPhyIdPortId
operator|,
name|npipps
operator|,
name|eventParam
operator|)
argument_list|)
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QN"
argument_list|,
name|npipps
argument_list|)
expr_stmt|;
comment|/* TP:QN npipps */
comment|/* get port context */
name|portId
operator|=
name|LREventPhyIdPortId
operator|&
name|PORTID_MASK
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QO"
argument_list|,
name|portId
argument_list|)
expr_stmt|;
comment|/* TP:QO portId */
comment|/* get phyId */
name|phyId
operator|=
operator|(
name|npipps
operator|&
name|PHY_ID_V_BITS
operator|)
operator|>>
name|SHIFT16
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"QP"
argument_list|,
name|phyId
argument_list|)
expr_stmt|;
comment|/* TP:QP phyId */
comment|/* get npipps */
name|npip
operator|=
operator|(
name|npipps
operator|&
literal|0xFF00
operator|)
operator|>>
name|SHIFT4
expr_stmt|;
name|port_state
operator|=
operator|(
name|npipps
operator|&
literal|0xF
operator|)
expr_stmt|;
name|npipps
operator|=
name|npip
operator||
name|port_state
expr_stmt|;
comment|// Make it look like SPCs nipps
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: V, PhyID 0x%x PortID 0x%x NPIP 0x%x PS 0x%x npipps 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
name|npip
operator|,
name|port_state
operator|,
name|npipps
operator|)
argument_list|)
expr_stmt|;
block|}
name|Event
operator|=
operator|(
name|LREventPhyIdPortId
operator|&
name|HW_EVENT_BITS
operator|)
operator|>>
name|SHIFT8
expr_stmt|;
comment|/* get Link Rate */
name|linkRate
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|LREventPhyIdPortId
operator|&
name|LINK_RATE_MASK
operator|)
operator|>>
name|SHIFT28
argument_list|)
expr_stmt|;
comment|/* get status byte */
name|status
operator|=
operator|(
name|LREventPhyIdPortId
operator|&
name|STATUS_BITS
operator|)
operator|>>
name|SHIFT24
expr_stmt|;
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"HA"
argument_list|,
name|portId
argument_list|)
expr_stmt|;
comment|/* TP:HA portId */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"HB"
argument_list|,
name|linkRate
argument_list|)
expr_stmt|;
comment|/* TP:HB linkRate */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"HC"
argument_list|,
name|phyId
argument_list|)
expr_stmt|;
comment|/* TP:HC phyId */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"HD"
argument_list|,
name|npipps
argument_list|)
expr_stmt|;
comment|/* TP:HD npipps */
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"HE"
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* TP:HE status */
if|if
condition|(
name|portId
operator|>
name|saRoot
operator|->
name|phyCount
condition|)
block|{
if|if
condition|(
name|OSSA_PORT_NOT_ESTABLISHED
operator|==
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
condition|)
block|{
comment|/* out of range checking for portId */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: PORT_ID is out of range, PhyID %d PortID %d\n"
operator|,
name|phyId
operator|,
name|portId
operator|)
argument_list|)
expr_stmt|;
comment|/* port is not estiblished */
name|agPortContext
operator|=
name|agNULL
expr_stmt|;
block|}
else|else
block|{
comment|/* portId is bad and state is correct - should not happen */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: PORT_ID is bad with correct Port State, PhyID %d PortID %d\n"
operator|,
name|phyId
operator|,
name|portId
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2j"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
else|else
block|{
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiHWEvent:PortID 0x%x PortStatus 0x%x PortContext %p\n"
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortID
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortStatus
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortContext
operator|)
argument_list|)
expr_stmt|;
name|agPortContext
operator|=
operator|(
name|agsaPortContext_t
operator|*
operator|)
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortContext
expr_stmt|;
block|}
if|if
condition|(
name|agPortContext
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: agPortContext is NULL, PhyID %d PortID %d\n"
operator|,
name|phyId
operator|,
name|portId
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTrace
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"HF"
argument_list|,
name|Event
argument_list|)
expr_stmt|;
comment|/* TP:HF OSSA_HW_EVENT */
switch|switch
condition|(
name|Event
condition|)
block|{
case|case
name|OSSA_HW_EVENT_SAS_PHY_UP
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_SAS_PHY_UP, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* get SAS Identify info */
name|IDframe
operator|=
operator|(
name|agsaSASIdentify_t
operator|*
operator|)
operator|&
name|pIomb
operator|->
name|sasIdentify
expr_stmt|;
comment|/* Callback about SAS link up */
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|linkstatus
operator||=
literal|2
expr_stmt|;
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|sasIdentify
operator|.
name|phyIdentifier
operator|=
name|IDframe
operator|->
name|phyIdentifier
expr_stmt|;
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|sasIdentify
operator|.
name|deviceType_addressFrameType
operator|=
name|IDframe
operator|->
name|deviceType_addressFrameType
expr_stmt|;
name|si_memcpy
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|sasIdentify
operator|.
name|sasAddressHi
operator|)
argument_list|,
operator|&
operator|(
name|IDframe
operator|->
name|sasAddressHi
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|si_memcpy
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|sasIdentify
operator|.
name|sasAddressLo
operator|)
argument_list|,
operator|&
operator|(
name|IDframe
operator|->
name|sasAddressLo
operator|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|siEventPhyUpRcvd
argument_list|(
name|agRoot
argument_list|,
name|phyId
argument_list|,
name|IDframe
argument_list|,
name|portId
argument_list|,
name|npipps
argument_list|,
name|linkRate
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_SATA_PHY_UP
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_SATA_PHY_UP, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* get SATA FIS info */
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|linkstatus
operator||=
literal|2
expr_stmt|;
name|sataFis
operator|=
operator|(
name|agsaFisRegDeviceToHost_t
operator|*
operator|)
operator|&
name|pIomb
operator|->
name|sataFis
expr_stmt|;
comment|/* Callback about SATA Link Up */
name|siEventSATASignatureRcvd
argument_list|(
name|agRoot
argument_list|,
name|phyId
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sataFis
argument_list|,
name|portId
argument_list|,
name|npipps
argument_list|,
name|linkRate
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_SATA_SPINUP_HOLD
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_SATA_SPINUP_HOLD, PhyID %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_SATA_SPINUP_HOLD
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_DOWN
case|:
block|{
name|agsaPhy_t
modifier|*
name|pPhy
init|=
operator|&
operator|(
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|)
decl_stmt|;
if|if
condition|(
name|pPhy
condition|)
block|{
name|osti_memset
argument_list|(
operator|&
name|pPhy
operator|->
name|sasIdentify
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASIdentify_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|saRoot
operator|->
name|phys
index|[
name|phyId
index|]
operator|.
name|linkstatus
operator|&=
literal|1
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agPortContext
condition|)
block|{
name|pPort
operator|=
operator|(
name|agsaPort_t
operator|*
operator|)
operator|(
name|agPortContext
operator|->
name|sdkData
operator|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_DOWN, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* callback */
if|if
condition|(
name|agNULL
operator|!=
name|pPort
condition|)
block|{
if|if
condition|(
name|OSSA_PORT_VALID
operator|==
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
condition|)
block|{
name|pPort
operator|->
name|status
operator|&=
operator|~
name|PORT_INVALIDATING
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortStatus
operator|&=
operator|~
name|PORT_INVALIDATING
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_DOWN, PhyID %d  ~PORT_INVALIDATING \n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|OSSA_PORT_INVALID
operator|==
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
condition|)
block|{
comment|/* set port invalid flag */
name|pPort
operator|->
name|status
operator||=
name|PORT_INVALIDATING
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortStatus
operator||=
name|PORT_INVALIDATING
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_DOWN PortInvalid portID %d PortContext %p NPIP 0x%x\n"
operator|,
name|portId
operator|,
name|agPortContext
operator|,
name|npipps
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|OSSA_PORT_IN_RESET
operator|==
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_DOWN PortInReset portID %d PortContext %p\n"
operator|,
name|portId
operator|,
name|agPortContext
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_DOWN Not PortInReset portID %d PortContext %p\n"
operator|,
name|portId
operator|,
name|agPortContext
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* report PhyId, NPIP, PortState */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
comment|/* Callback with PHY_DOWN */
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PHY_DOWN
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no portcontext.- error */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_DOWN PhyDown pPort is NULL.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* set PHY_DOWN status */
name|PHY_STATUS_SET
argument_list|(
name|pPhy
argument_list|,
name|PHY_DOWN
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_INBOUND_CRC
case|:
block|{
name|agsaPhyErrCountersPage_t
name|errorParam
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_ERR_INBOUND_CRC, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|errorParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaPhyErrCountersPage_t
argument_list|)
argument_list|)
expr_stmt|;
name|errorParam
operator|.
name|inboundCRCError
operator|=
name|eventParam
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PHY_ERR_INBOUND_CRC
argument_list|,
name|phyId
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|errorParam
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_HARD_RESET_RECEIVED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_HARD_RESET_RECEIVED, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_HARD_RESET_RECEIVED
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_INVALID_DWORD
case|:
block|{
name|agsaPhyErrCountersPage_t
name|errorParam
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_LINK_ERR_INVALID_DWORD, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|errorParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaPhyErrCountersPage_t
argument_list|)
argument_list|)
expr_stmt|;
name|errorParam
operator|.
name|invalidDword
operator|=
name|eventParam
expr_stmt|;
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PHY_ERR_INVALID_DWORD
argument_list|,
name|phyId
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|errorParam
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_DISPARITY_ERROR
case|:
block|{
name|agsaPhyErrCountersPage_t
name|errorParam
decl_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_LINK_ERR_DISPARITY_ERROR, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|si_memset
argument_list|(
operator|&
name|errorParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaPhyErrCountersPage_t
argument_list|)
argument_list|)
expr_stmt|;
name|errorParam
operator|.
name|runningDisparityError
operator|=
name|eventParam
expr_stmt|;
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PHY_ERR_DISPARITY_ERROR
argument_list|,
name|phyId
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|errorParam
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_CODE_VIOLATION
case|:
block|{
name|agsaPhyErrCountersPage_t
name|errorParam
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_LINK_ERR_CODE_VIOLATION, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|si_memset
argument_list|(
operator|&
name|errorParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaPhyErrCountersPage_t
argument_list|)
argument_list|)
expr_stmt|;
name|errorParam
operator|.
name|codeViolation
operator|=
name|eventParam
expr_stmt|;
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PHY_ERR_CODE_VIOLATION
argument_list|,
name|phyId
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|errorParam
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_LOSS_OF_DWORD_SYNCH
case|:
block|{
name|agsaPhyErrCountersPage_t
name|errorParam
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_LINK_ERR_LOSS_OF_DWORD_SYNCH, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|si_memset
argument_list|(
operator|&
name|errorParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaPhyErrCountersPage_t
argument_list|)
argument_list|)
expr_stmt|;
name|errorParam
operator|.
name|lossOfDwordSynch
operator|=
name|eventParam
expr_stmt|;
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PHY_ERR_LOSS_OF_DWORD_SYNCH
argument_list|,
name|phyId
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|errorParam
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PORT_RECOVERY_TIMER_TMO
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PORT_RECOVERY_TIMER_TMO, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|agPortContext
condition|)
block|{
name|pPort
operator|=
operator|(
name|agsaPort_t
operator|*
operator|)
operator|(
name|agPortContext
operator|->
name|sdkData
operator|)
expr_stmt|;
block|}
else|else
block|{
name|SA_ASSERT
argument_list|(
operator|(
name|agPortContext
operator|)
argument_list|,
literal|"agPortContext agNULL was there a PHY UP?"
argument_list|)
expr_stmt|;
return|return
operator|(
name|AGSA_RC_FAILURE
operator|)
return|;
block|}
comment|/* report PhyId, NPIP, PortState */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PORT_RECOVERY_TIMER_TMO
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|OSSA_PORT_VALID
operator|==
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
condition|)
block|{
name|pPort
operator|->
name|status
operator|&=
operator|~
name|PORT_INVALIDATING
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortStatus
operator|&=
operator|~
name|PORT_INVALIDATING
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PORT_RECOVERY_TIMER_TMO NOT PORT_INVALIDATING portID %d PortContext %p\n"
operator|,
name|portId
operator|,
name|agPortContext
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|OSSA_PORT_INVALID
operator|==
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
condition|)
block|{
comment|/* set port invalid flag */
name|pPort
operator|->
name|status
operator||=
name|PORT_INVALIDATING
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortStatus
operator||=
name|PORT_INVALIDATING
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PORT_RECOVERY_TIMER_TMO PORT_INVALIDATING portID %d PortContext %p\n"
operator|,
name|portId
operator|,
name|agPortContext
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|OSSA_PORT_IN_RESET
operator|==
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: PortInReset portID %d PortContext %p\n"
operator|,
name|portId
operator|,
name|agPortContext
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PORT_RECOVER
case|:
block|{
if|if
condition|(
name|agNULL
operator|!=
name|agPortContext
condition|)
block|{
name|pPort
operator|=
operator|(
name|agsaPort_t
operator|*
operator|)
operator|(
name|agPortContext
operator|->
name|sdkData
operator|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PORT_RECOVER, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|OSSA_PORT_VALID
operator|==
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
condition|)
block|{
if|if
condition|(
name|agNULL
operator|!=
name|pPort
condition|)
block|{
comment|/* reset port invalid flag */
name|pPort
operator|->
name|status
operator|&=
operator|~
name|PORT_INVALIDATING
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PORT_RECOVER NOT PORT_INVALIDATING portID %d PortContext %p\n"
operator|,
name|portId
operator|,
name|agPortContext
operator|)
argument_list|)
expr_stmt|;
block|}
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortStatus
operator|&=
operator|~
name|PORT_INVALIDATING
expr_stmt|;
block|}
comment|/* get SAS Identify info */
name|IDframe
operator|=
operator|(
name|agsaSASIdentify_t
operator|*
operator|)
operator|&
name|pIomb
operator|->
name|sasIdentify
expr_stmt|;
comment|/* report PhyId, NPIP, PortState and LinkRate */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|linkRate
operator|<<
name|SHIFT8
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PORT_RECOVER
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|IDframe
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_STOP_STATUS
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_STOP_STATUS PhyId=0x%x, status=0x%x eventParam=0x%x\n"
operator|,
name|phyId
operator|,
name|status
operator|,
name|eventParam
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_SPC_OUB_t
argument_list|,
name|EVParam
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|eventParam
condition|)
block|{
case|case
literal|0
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_STOP_STATUS Stopped 0\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_STOP_STATUS INVALID_PHY 1\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_STOP_STATUS DEVICES_ATTACHED 2\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_STOP_STATUS OTHER_FAILURE 3\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_STOP_STATUS PHY_NOT_ENABLED 4\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_STOP_STATUS Unknown code 0x%x\n"
operator|,
name|eventParam
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_STOP_STATUS phyId 0x%x status 0x%x eventParam 0x%x\n"
operator|,
name|phyId
operator|,
name|status
operator|,
name|eventParam
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|)
argument_list|,
literal|"pRequest NULL"
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
name|siPhyStopCB
argument_list|(
name|agRoot
argument_list|,
name|phyId
argument_list|,
name|status
argument_list|,
name|agContext
argument_list|,
name|portId
argument_list|,
name|npipps
argument_list|)
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWevent: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_BROADCAST_CHANGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_BROADCAST_CHANGE, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_BROADCAST_CHANGE
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_BROADCAST_SES
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_BROADCAST_CHANGE_SES, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_BROADCAST_SES
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_BROADCAST_EXP
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_BROADCAST_EXP, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_BROADCAST_EXP
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_ID_FRAME_TIMEOUT
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_ID_FRAME_TIMEOUT, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_ID_FRAME_TIMEOUT
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_START_STATUS
case|:
block|{
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaHWEvent_SPC_OUB_t
argument_list|,
name|EVParam
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|)
argument_list|,
literal|"pRequest"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWevent: pRequest (%p) NULL\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
break|break;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* makeup for CB */
name|status
operator|=
operator|(
name|status
operator|<<
literal|8
operator|)
operator||
name|phyId
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_PHY_START_STATUS
argument_list|,
name|status
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWevent: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_START_STATUS, PhyID %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PHY_ERR_PHY_RESET_FAILED
case|:
block|{
name|agsaPhyErrCountersPage_t
name|errorParam
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PHY_ERR_PHY_RESET_FAILED, PhyID %d PortID %d NPIP 0x%x PS 0x%x\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator|>>
name|SHIFT4
operator|,
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|si_memset
argument_list|(
operator|&
name|errorParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaPhyErrCountersPage_t
argument_list|)
argument_list|)
expr_stmt|;
name|errorParam
operator|.
name|phyResetProblem
operator|=
name|eventParam
expr_stmt|;
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PHY_ERR_PHY_RESET_FAILED
argument_list|,
name|phyId
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|errorParam
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PORT_RESET_TIMER_TMO
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PORT_RESET_TIMER_TMO, PhyID %d PortID %d\n"
operator|,
name|phyId
operator|,
name|portId
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PORT_RESET_TIMER_TMO
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_PORT_RESET_COMPLETE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_PORT_RESET_COMPLETE, PhyID %d PortID %d\n"
operator|,
name|phyId
operator|,
name|portId
operator|)
argument_list|)
expr_stmt|;
comment|/* get SAS Identify info */
name|IDframe
operator|=
operator|(
name|agsaSASIdentify_t
operator|*
operator|)
operator|&
name|pIomb
operator|->
name|sasIdentify
expr_stmt|;
comment|/* report PhyId, NPIP, PortState and LinkRate */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
operator||
operator|(
name|linkRate
operator|<<
name|SHIFT8
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_PORT_RESET_COMPLETE
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|IDframe
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_BROADCAST_ASYNCH_EVENT
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_BROADCAST_ASYNCH_EVENT, PhyID %d PortID %d\n"
operator|,
name|phyId
operator|,
name|portId
operator|)
argument_list|)
expr_stmt|;
comment|/* report PhyId, NPIP, PortState */
name|phyId
operator||=
operator|(
name|npipps
operator|&
name|PHY_IN_PORT_MASK
operator|)
operator||
operator|(
operator|(
name|npipps
operator|&
name|PORT_STATE_MASK
operator|)
operator|<<
name|SHIFT16
operator|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_BROADCAST_ASYNCH_EVENT
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_IT_NEXUS_LOSS
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_IT_NEXUS_LOSS, PhyID %d PortID %d status 0x%X\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_HW_EVENT_OPEN_RETRY_BACKOFF_THR_ADJUSTED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: OSSA_HW_EVENT_OPEN_RETRY_BACKOFF_THR_ADJUSTED, PhyID %d PortID %d status 0x%X\n"
operator|,
name|phyId
operator|,
name|portId
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agPortContext
argument_list|,
name|OSSA_HW_EVENT_OPEN_RETRY_BACKOFF_THR_ADJUSTED
argument_list|,
name|phyId
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiHWEvent: Unknown HW Event 0x%x status 0x%X\n"
operator|,
name|Event
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2j"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI SMP Completion  *  *  This function handles the SMP completion.  *  *  \param agRoot       Handles for this instance of SAS/SATA hardware  *  \param pIomb        pointer of Message1  *  \param bc           buffer count  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSMPCompletion
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSMPCompletionRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|tag
decl_stmt|;
name|bit32
name|param
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSMPCompletion: start, HTAG=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2k"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSMPCompletionRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSMPCompletionRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|param
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSMPCompletionRsp_t
argument_list|,
name|param
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get SMP request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x PARAM=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2k"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|OSSA_IO_SUCCESS
case|:
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_SUCCESS HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* process message */
name|siSMPRespRcvd
argument_list|(
name|agRoot
argument_list|,
name|pIomb
argument_list|,
name|param
argument_list|,
name|tag
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OVERFLOW
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OVERFLOW HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OVERFLOW
operator|++
expr_stmt|;
comment|/* SMP failed */
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORTED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_ABORTED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_ABORTED
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_PRINTOUT_IN_WINDBG
ifndef|#
directive|ifndef
name|DBG
name|DbgPrint
argument_list|(
literal|"agOSSA_IO_ABORTED  %d\n"
argument_list|,
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_ABORTED
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DBG  */
endif|#
directive|endif
comment|/* SA_PRINTOUT_IN_WINDBG  */
comment|/* SMP failed */
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_NO_DEVICE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_NO_DEVICE HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_NO_DEVICE
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ERROR_HW_TIMEOUT
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_ERROR_HW_TIMEOUT HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_ERROR_HW_TIMEOUT
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_BREAK
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_XFER_ERROR_BREAK HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_XFER_ERROR_BREAK
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_XFER_ERROR_PHY_NOT_READY HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_XFER_ERROR_PHY_NOT_READY
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_BREAK HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_BREAK
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_ERROR_RX_FRAME
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_XFER_ERROR_RX_FRAME HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_XFER_ERROR_RX_FRAME
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_XFER_OPEN_RETRY_TIMEOUT HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_XFER_OPEN_RETRY_TIMEOUT
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ERROR_INTERNAL_SMP_RESOURCE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_ERROR_INTERNAL_SMP_RESOURCE HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_ERROR_INTERNAL_SMP_RESOURCE
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_PORT_IN_RESET
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_PORT_IN_RESET HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_PORT_IN_RESET
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_NON_OPERATIONAL
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_DS_NON_OPERATIONAL HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_DS_NON_OPERATIONAL
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_IN_RECOVERY
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_DS_IN_RECOVERY HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_DS_IN_RECOVERY
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_HW_RESOURCE_BUSY
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_HW_RESOURCE_BUSY HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_HW_RESOURCE_BUSY
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORT_IN_PROGRESS
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_ABORT_IN_PROGRESS HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_ABORT_IN_PROGRESS
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORT_DELAYED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion:OSSA_IO_ABORT_DELAYED  HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_ABORT_DELAYED
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_INVALID_LENGTH
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_INVALID_LENGTH HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_INVALID_LENGTH
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_INVALID
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_DS_INVALID HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_DS_INVALID
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_READ_COMPL_ERR
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_XFER_READ_COMPL_ERR HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_XFER_READ_COMPL_ERR
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_ERR_OFFLOAD_DIF_OR_ENC_NOT_ENABLED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_MPI_ERR_OFFLOAD_DIF_OR_ENC_NOT_ENABLED
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_OPEN_PREEMPTED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: OSSA_IO_OPEN_CNX_ERROR_OPEN_PREEMPTED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_OPEN_PREEMPTED
operator|++
expr_stmt|;
name|siAbnormal
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPCompletion: Unknown Status = 0x%x Tag 0x%x\n"
operator|,
name|status
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoErrorCount
operator|.
name|agOSSA_IO_UNKNOWN_ERROR
operator|++
expr_stmt|;
comment|/* not allowed case. Therefore, assert */
name|SA_ASSERT
argument_list|(
operator|(
name|agFALSE
operator|)
argument_list|,
literal|"mpiSMPCompletion: Unknown Status"
argument_list|)
expr_stmt|;
break|break;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2k"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI Get Device Handle Command Response  *  *  This function handles the response of Get Device Handle Command.  *  *  \param agRoot       Handles for this instance of SAS/SATA hardware  *  \param pIomb        pointer of Message  *  \param bc           buffer count  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetDevHandleRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGetDevHandleRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaPortContext_t
modifier|*
name|agPortContext
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|bit8
name|portId
decl_stmt|;
name|bit32
name|deviceid
init|=
literal|0
decl_stmt|,
name|deviceIdc
decl_stmt|,
name|i
decl_stmt|;
name|bit32
name|DeviceIdcPortId
decl_stmt|,
name|tag
decl_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevHandleRsp: start, HTAG=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2m"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|DeviceIdcPortId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevHandleRsp_t
argument_list|,
name|DeviceIdcPortId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevHandleRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevHandleRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x DeviceIdcPortId=0x%x\n"
operator|,
name|tag
operator|,
name|DeviceIdcPortId
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2m"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* get port context */
name|portId
operator|=
call|(
name|bit8
call|)
argument_list|(
name|DeviceIdcPortId
operator|&
name|PORTID_MASK
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetDevHandleRsp:PortID 0x%x PortStatus 0x%x PortContext %p\n"
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortID
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortStatus
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortContext
operator|)
argument_list|)
expr_stmt|;
name|agPortContext
operator|=
operator|(
name|agsaPortContext_t
operator|*
operator|)
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortContext
expr_stmt|;
comment|/* get Device ID count */
name|deviceIdc
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|DeviceIdcPortId
operator|&
name|DEVICE_IDC_BITS
operator|)
operator|>>
name|SHIFT8
argument_list|)
expr_stmt|;
comment|/* based on the deviceIDC to get all device handles */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|deviceIdc
condition|;
name|i
operator|++
control|)
block|{
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceid
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevHandleRsp_t
argument_list|,
name|deviceId
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* find device handle from device index */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceid
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceHandle
expr_stmt|;
if|if
condition|(
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
condition|)
name|saRoot
operator|->
name|DeviceHandle
index|[
name|i
index|]
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
expr_stmt|;
else|else
name|saRoot
operator|->
name|DeviceHandle
index|[
name|i
index|]
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevHandleRsp:deviceid 0x%x  0x%x\n"
operator|,
name|deviceid
operator|,
operator|(
name|deviceid
operator|&
name|DEVICE_ID_BITS
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* call back oslayer */
name|ossaGetDeviceHandlesCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agPortContext
argument_list|,
name|saRoot
operator|->
name|DeviceHandle
argument_list|,
name|deviceIdc
argument_list|)
expr_stmt|;
comment|/* return the request to free pool */
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevHandleRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2m"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI Phy Control Command Response  *  *  This function handles the response of PHY Control Command.  *  *  \param agRoot       Handles for this instance of SAS/SATA hardware  *  \param pIomb        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiPhyCntrlRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaLocalPhyCntrlRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|phyId
decl_stmt|,
name|operation
decl_stmt|,
name|status
decl_stmt|,
name|tag
decl_stmt|,
name|phyOpId
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2n"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiPhyCntrlRsp: start, HTAG=0x%x,\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get tag */
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaLocalPhyCntrlRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|phyOpId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaLocalPhyCntrlRsp_t
argument_list|,
name|phyOpId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaLocalPhyCntrlRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyCntrlRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x PhyOpId=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|,
name|phyOpId
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2n"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|phyId
operator|=
name|phyOpId
operator|&
name|LOCAL_PHY_PHYID
expr_stmt|;
name|operation
operator|=
operator|(
name|phyOpId
operator|&
name|LOCAL_PHY_OP_BITS
operator|)
operator|>>
name|SHIFT8
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiPhyCntrlRsp: phyId=0x%x Operation=0x%x Status=0x%x\n"
operator|,
name|phyId
operator|,
name|operation
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
comment|/* call back with the status */
name|ossaLocalPhyControlCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|phyId
argument_list|,
name|operation
argument_list|,
name|status
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaLocalPhyControlCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|phyId
operator|,
name|operation
operator|,
name|status
operator|,
name|agNULL
operator|)
expr_stmt|;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPhyCntrlRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2n"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI Device Register Command Response  *  *  This function handles the response of Device Register Command.  *  *  \param agRoot       Handles for this instance of SAS/SATA hardware  *  \param pIomb        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiDeviceRegRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDeviceRegistrationRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
name|agNULL
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|deviceId
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
init|=
name|agNULL
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDeviceRemove
init|=
name|agNULL
decl_stmt|;
name|bit32
name|deviceIdx
decl_stmt|,
name|status
decl_stmt|,
name|tag
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2p"
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|saRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: start, HTAG=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|NULL
operator|!=
name|saRoot
operator|->
name|DeviceRegistrationCB
operator|)
argument_list|,
literal|"DeviceRegistrationCB can not be NULL"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeviceRegistrationRsp_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeviceRegistrationRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeviceRegistrationRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: deviceID 0x%x \n"
operator|,
name|deviceId
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: Bad IOMB!!! pRequest is NULL. TAG=0x%x, STATUS=0x%x DEVICEID=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|,
name|deviceId
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2p"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|pDevice
operator|=
name|pRequest
operator|->
name|pDevice
expr_stmt|;
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
comment|/* get Device Id or status */
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: hosttag 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: deviceID 0x%x Device Context %p\n"
operator|,
name|deviceId
operator|,
name|pDevice
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pDevice
condition|)
block|{
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: warning!!! no device is found\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2p"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agNULL
operator|==
name|saRoot
operator|->
name|DeviceRegistrationCB
condition|)
block|{
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: warning!!! no DeviceRegistrationCB is found\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2p"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|status
condition|)
block|{
case|case
literal|0
case|:
name|status
operator|=
name|OSSA_SUCCESS
expr_stmt|;
break|break;
case|case
name|MPI_ERR_DEVICE_HANDLE_UNAVAILABLE
case|:
name|status
operator|=
name|OSSA_FAILURE_OUT_OF_RESOURCE
expr_stmt|;
break|break;
case|case
name|MPI_ERR_DEVICE_ALREADY_REGISTERED
case|:
name|status
operator|=
name|OSSA_FAILURE_DEVICE_ALREADY_REGISTERED
expr_stmt|;
break|break;
case|case
name|MPI_ERR_PHY_ID_INVALID
case|:
name|status
operator|=
name|OSSA_FAILURE_INVALID_PHY_ID
expr_stmt|;
break|break;
case|case
name|MPI_ERR_PHY_ID_ALREADY_REGISTERED
case|:
name|status
operator|=
name|OSSA_FAILURE_PHY_ID_ALREADY_REGISTERED
expr_stmt|;
break|break;
case|case
name|MPI_ERR_PORT_INVALID_PORT_ID
case|:
name|status
operator|=
name|OSSA_FAILURE_PORT_ID_OUT_OF_RANGE
expr_stmt|;
break|break;
case|case
name|MPI_ERR_PORT_STATE_NOT_VALID
case|:
name|status
operator|=
name|OSSA_FAILURE_PORT_NOT_VALID_STATE
expr_stmt|;
break|break;
case|case
name|MPI_ERR_DEVICE_TYPE_NOT_VALID
case|:
name|status
operator|=
name|OSSA_FAILURE_DEVICE_TYPE_NOT_VALID
expr_stmt|;
break|break;
default|default:
name|SA_ASSERT
argument_list|(
operator|(
literal|0
operator|)
argument_list|,
literal|"DeviceRegistration Unknown status"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|OSSA_SUCCESS
case|:
comment|/* mapping the device handle and device id */
name|deviceIdx
operator|=
name|deviceId
operator|&
name|DEVICE_ID_BITS
expr_stmt|;
name|OS_ASSERT
argument_list|(
name|deviceIdx
operator|<
name|MAX_IO_DEVICE_ENTRIES
argument_list|,
literal|"deviceIdx MAX_IO_DEVICE_ENTRIES"
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceIdx
index|]
operator|.
name|DeviceIdFromFW
operator|=
name|deviceId
expr_stmt|;
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceIdx
index|]
operator|.
name|DeviceHandle
operator|=
operator|(
name|void
operator|*
operator|)
name|pDevice
expr_stmt|;
name|pDevice
operator|->
name|DeviceMapIndex
operator|=
name|deviceId
expr_stmt|;
operator|(
operator|*
call|(
name|ossaDeviceRegistrationCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceRegistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|OSSA_SUCCESS
operator|,
operator|&
name|pDevice
operator|->
name|targetDevHandle
operator|,
name|deviceId
operator|)
expr_stmt|;
break|break;
case|case
name|OSSA_FAILURE_OUT_OF_RESOURCE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: OSSA_FAILURE_OUT_OF_RESOURCE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* remove device from LL device list */
name|siPortDeviceRemove
argument_list|(
name|agRoot
argument_list|,
name|pDevice
operator|->
name|pPort
argument_list|,
name|pDevice
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
comment|/* call ossaDeviceRegistrationCB_t */
operator|(
operator|*
call|(
name|ossaDeviceRegistrationCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceRegistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|OSSA_FAILURE_OUT_OF_RESOURCE
operator|,
operator|&
name|pDevice
operator|->
name|targetDevHandle
operator|,
name|deviceId
operator|)
expr_stmt|;
break|break;
case|case
name|OSSA_FAILURE_DEVICE_ALREADY_REGISTERED
case|:
comment|/* get original device handle and device id */
name|pDeviceRemove
operator|=
name|pDevice
expr_stmt|;
name|deviceIdx
operator|=
name|deviceId
operator|&
name|DEVICE_ID_BITS
expr_stmt|;
name|OS_ASSERT
argument_list|(
name|deviceIdx
operator|<
name|MAX_IO_DEVICE_ENTRIES
argument_list|,
literal|"deviceIdx MAX_IO_DEVICE_ENTRIES"
argument_list|)
expr_stmt|;
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceIdx
index|]
operator|.
name|DeviceHandle
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: OSSA_FAILURE_DEVICE_ALREADY_REGISTERED, existing deviceContext %p\n"
operator|,
name|pDevice
operator|)
argument_list|)
expr_stmt|;
comment|/* no auto registration */
if|if
condition|(
name|pDevice
operator|!=
name|agNULL
condition|)
block|{
comment|/* remove device from LL device list */
name|siPortDeviceListRemove
argument_list|(
name|agRoot
argument_list|,
name|pDevice
operator|->
name|pPort
argument_list|,
name|pDeviceRemove
argument_list|)
expr_stmt|;
comment|/* call ossaDeviceRegistrationCB_t */
operator|(
operator|*
call|(
name|ossaDeviceRegistrationCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceRegistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|OSSA_FAILURE_DEVICE_ALREADY_REGISTERED
operator|,
operator|&
name|pDevice
operator|->
name|targetDevHandle
operator|,
name|deviceId
operator|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: pDevice is NULL. TAG=0x%x, STATUS=0x%x DEVICEID=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|,
name|deviceId
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"2p"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
break|break;
case|case
name|OSSA_FAILURE_INVALID_PHY_ID
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: OSSA_FAILURE_INVALID_PHY_ID\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* remove device from LL device list */
name|siPortDeviceRemove
argument_list|(
name|agRoot
argument_list|,
name|pDevice
operator|->
name|pPort
argument_list|,
name|pDevice
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
comment|/* call ossaDeviceRegistrationCB_t */
operator|(
operator|*
call|(
name|ossaDeviceRegistrationCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceRegistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|OSSA_FAILURE_INVALID_PHY_ID
operator|,
operator|&
name|pDevice
operator|->
name|targetDevHandle
operator|,
name|deviceId
operator|)
expr_stmt|;
break|break;
case|case
name|OSSA_FAILURE_PHY_ID_ALREADY_REGISTERED
case|:
comment|/* get original device handle and device id */
name|pDeviceRemove
operator|=
name|pDevice
expr_stmt|;
name|deviceIdx
operator|=
name|deviceId
operator|&
name|DEVICE_ID_BITS
expr_stmt|;
name|OS_ASSERT
argument_list|(
name|deviceIdx
operator|<
name|MAX_IO_DEVICE_ENTRIES
argument_list|,
literal|"deviceIdx MAX_IO_DEVICE_ENTRIES"
argument_list|)
expr_stmt|;
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceIdx
index|]
operator|.
name|DeviceHandle
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: OSSA_FAILURE_PHY_ID_ALREADY_REGISTERED, existing deviceContext %p\n"
operator|,
name|pDevice
operator|)
argument_list|)
expr_stmt|;
comment|/* no auto registration */
if|if
condition|(
name|pDevice
operator|!=
name|agNULL
condition|)
block|{
comment|/* remove device from LL device list */
name|siPortDeviceListRemove
argument_list|(
name|agRoot
argument_list|,
name|pDevice
operator|->
name|pPort
argument_list|,
name|pDeviceRemove
argument_list|)
expr_stmt|;
comment|/* call ossaDeviceRegistrationCB_t */
operator|(
operator|*
call|(
name|ossaDeviceRegistrationCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceRegistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|OSSA_FAILURE_PHY_ID_ALREADY_REGISTERED
operator|,
operator|&
name|pDevice
operator|->
name|targetDevHandle
operator|,
name|deviceId
operator|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: pDevice is NULL. TAG=0x%x, STATUS=0x%x DEVICEID=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|,
name|deviceId
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"2p"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
break|break;
case|case
name|OSSA_FAILURE_PORT_ID_OUT_OF_RANGE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: OSSA_FAILURE_OUT_OF_RESOURCE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* remove device from LL device list */
name|siPortDeviceRemove
argument_list|(
name|agRoot
argument_list|,
name|pDevice
operator|->
name|pPort
argument_list|,
name|pDevice
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
comment|/* call ossaDeviceRegistrationCB_t */
operator|(
operator|*
call|(
name|ossaDeviceRegistrationCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceRegistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|OSSA_FAILURE_PORT_ID_OUT_OF_RANGE
operator|,
operator|&
name|pDevice
operator|->
name|targetDevHandle
operator|,
name|deviceId
operator|)
expr_stmt|;
break|break;
case|case
name|OSSA_FAILURE_PORT_NOT_VALID_STATE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: OSSA_FAILURE_PORT_NOT_VALID_STATE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* remove device from LL device list */
name|siPortDeviceRemove
argument_list|(
name|agRoot
argument_list|,
name|pDevice
operator|->
name|pPort
argument_list|,
name|pDevice
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
comment|/* call ossaDeviceRegistrationCB_t */
operator|(
operator|*
call|(
name|ossaDeviceRegistrationCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceRegistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|OSSA_FAILURE_PORT_NOT_VALID_STATE
operator|,
operator|&
name|pDevice
operator|->
name|targetDevHandle
operator|,
name|deviceId
operator|)
expr_stmt|;
break|break;
case|case
name|OSSA_FAILURE_DEVICE_TYPE_NOT_VALID
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: OSSA_FAILURE_DEVICE_TYPE_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* remove device from LL device list */
name|siPortDeviceRemove
argument_list|(
name|agRoot
argument_list|,
name|pDevice
operator|->
name|pPort
argument_list|,
name|pDevice
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
comment|/* call ossaDeviceRegistrationCB_t */
operator|(
operator|*
call|(
name|ossaDeviceRegistrationCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceRegistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|OSSA_FAILURE_DEVICE_TYPE_NOT_VALID
operator|,
operator|&
name|pDevice
operator|->
name|targetDevHandle
operator|,
name|deviceId
operator|)
expr_stmt|;
break|break;
default|default:
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiDeviceRegRsp, unknown status in response %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceRegRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"2p"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI Deregister Device Command Response  *  *  This function handles the response of Deregister Command.  *  *  \param agRoot       Handles for this instance of SAS/SATA hardware  *  \param pIomb        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiDeregDevHandleRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDeregDevHandleRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|bit32
name|deviceIdx
decl_stmt|,
name|status
decl_stmt|,
name|tag
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2r"
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|NULL
operator|!=
name|saRoot
operator|->
name|DeviceDeregistrationCB
operator|)
argument_list|,
literal|"DeviceDeregistrationCB can not be NULL"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiDeregDevHandleRsp: start, HTAG=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeregDevHandleRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeregDevHandleRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceIdx
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeregDevHandleRsp_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevHandleRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x deviceIdx 0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|,
name|deviceIdx
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2r"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pDevice
operator|=
name|pRequest
operator|->
name|pDevice
expr_stmt|;
if|if
condition|(
name|pDevice
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
condition|)
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
expr_stmt|;
block|}
else|else
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevHandleRsp: pDevice is NULL"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2r"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agNULL
operator|==
name|agDevHandle
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevHandleRsp: warning!!! no deviceHandle is found"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2r"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevHandleRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevHandleRsp: deviceID 0x%x Device Context %p\n"
operator|,
name|pDevice
operator|->
name|DeviceMapIndex
operator|,
name|pDevice
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|saRoot
operator|->
name|DeviceDeregistrationCB
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevHandleRsp: warning!!! no DeviceDeregistrationCB is found"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"2r"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevHandleRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|OSSA_SUCCESS
case|:
operator|(
operator|*
call|(
name|ossaDeregisterDeviceHandleCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceDeregistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|agDevHandle
operator|,
name|OSSA_SUCCESS
operator|)
expr_stmt|;
name|siRemoveDevHandle
argument_list|(
name|agRoot
argument_list|,
name|agDevHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_ERR_DEVICE_HANDLE_INVALID
case|:
case|case
name|OSSA_INVALID_HANDLE
case|:
operator|(
operator|*
call|(
name|ossaDeregisterDeviceHandleCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceDeregistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|agDevHandle
operator|,
name|status
operator|)
expr_stmt|;
comment|// already removed and no device to remove
comment|//      siRemoveDevHandle(agRoot, agDevHandle);
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevRegRsp, OSSA_INVALID_HANDLE status in response %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_ERR_DEVICE_BUSY
case|:
operator|(
operator|*
call|(
name|ossaDeregisterDeviceHandleCB_t
call|)
argument_list|(
name|saRoot
operator|->
name|DeviceDeregistrationCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|agDevHandle
operator|,
name|status
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevRegRsp, OSSA_ERR_DEVICE_BUSY status in response %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_BUSY
expr_stmt|;
break|break;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevRegRsp, unknown status in response 0x%X\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeregDevHandleRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"2r"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Get Phy Profile Response SPCv  *  *  This routine handles the response of Get Phy Profile Command Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Message  *  *  \return sucess or fail  *  SPC  only  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetPhyProfileRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGetPhyProfileRspV_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|status
decl_stmt|,
name|tag
decl_stmt|;
name|bit32
name|Reserved_SOP_PHYID
decl_stmt|;
name|bit32
name|PhyId
decl_stmt|;
name|bit32
name|SOP
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2J"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get TAG */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: HTag=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2J"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Reserved_SOP_PHYID
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|Reserved_Ppc_SOP_PHYID
argument_list|)
argument_list|)
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp:   %p\n"
operator|,
name|pIomb
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: completionCB %p\n"
operator|,
name|pRequest
operator|->
name|completionCB
operator|)
argument_list|)
expr_stmt|;
name|SOP
operator|=
operator|(
name|Reserved_SOP_PHYID
operator|&
literal|0xFF00
operator|)
operator|>>
name|SHIFT8
expr_stmt|;
name|PhyId
operator|=
name|Reserved_SOP_PHYID
operator|&
literal|0xFF
expr_stmt|;
comment|/* check status success or failure */
if|if
condition|(
name|status
condition|)
block|{
comment|/* status is FAILED */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp:AGSA_RC_FAILURE  0x%08X\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SOP
condition|)
block|{
case|case
name|AGSA_SAS_PHY_ERR_COUNTERS_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_SAS_PHY_ERR_COUNTERS_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_ERR_COUNTERS_CLR_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_SAS_PHY_ERR_COUNTERS_CLR_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_BW_COUNTERS_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: GET_SAS_PHY_BW_COUNTERS SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_GENERAL_STATUS_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_SAS_PHY_GENERAL_STATUS_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_PHY_SNW3_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_PHY_SNW3_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_PHY_RATE_CONTROL_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_PHY_RATE_CONTROL_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_OPEN_REJECT_RETRY_BACKOFF_THRESHOLD_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_SAS_PHY_OPEN_REJECT_RETRY_BACKOFF_THRESHOLD_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: undefined SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2J"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: SUCCESS type 0x%X\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SOP
condition|)
block|{
case|case
name|AGSA_SAS_PHY_ERR_COUNTERS_CLR_PAGE
case|:
comment|/* call back with the status */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_SAS_PHY_ERR_COUNTERS_CLR_PAGE PhyId %d\n"
operator|,
name|PhyId
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_SAS_PHY_ERR_COUNTERS_PAGE
case|:
block|{
name|agsaPhyErrCountersPage_t
name|Errors
decl_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Errors
operator|.
name|invalidDword
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Errors
operator|.
name|runningDisparityError
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Errors
operator|.
name|codeViolation
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Errors
operator|.
name|lossOfDwordSynch
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Errors
operator|.
name|phyResetProblem
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Errors
operator|.
name|inboundCRCError
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|5
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* call back with the status */
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
operator|&
name|Errors
argument_list|)
expr_stmt|;
comment|/* status is SUCCESS */
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: pIomb %p\n"
operator|,
name|pIomb
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: Reserved_SOP_PHYID    0x%08X\n"
operator|,
name|Reserved_SOP_PHYID
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: invalidDword          0x%08X\n"
operator|,
name|Errors
operator|.
name|invalidDword
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: runningDisparityError 0x%08X\n"
operator|,
name|Errors
operator|.
name|runningDisparityError
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: codeViolation         0x%08X\n"
operator|,
name|Errors
operator|.
name|codeViolation
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: lossOfDwordSynch      0x%08X\n"
operator|,
name|Errors
operator|.
name|lossOfDwordSynch
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: phyResetProblem       0x%08X\n"
operator|,
name|Errors
operator|.
name|phyResetProblem
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: inboundCRCError       0x%08X\n"
operator|,
name|Errors
operator|.
name|inboundCRCError
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_BW_COUNTERS_PAGE
case|:
block|{
name|agsaPhyBWCountersPage_t
name|bw_counts
decl_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|bw_counts
operator|.
name|TXBWCounter
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|bw_counts
operator|.
name|RXBWCounter
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: GET_SAS_PHY_BW_COUNTERS TX 0x%08X RX 0x%08X\n"
operator|,
name|bw_counts
operator|.
name|TXBWCounter
operator|,
name|bw_counts
operator|.
name|RXBWCounter
operator|)
argument_list|)
expr_stmt|;
comment|/* call back with the status */
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
operator|&
name|bw_counts
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE
case|:
block|{
name|agsaPhyAnalogSettingsPage_t
name|analog
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE 0x%X\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|analog
operator|.
name|Dword0
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|analog
operator|.
name|Dword1
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|analog
operator|.
name|Dword2
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|analog
operator|.
name|Dword3
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|analog
operator|.
name|Dword4
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* call back with the status */
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
operator|&
name|analog
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_GENERAL_STATUS_PAGE
case|:
block|{
name|agsaSASPhyGeneralStatusPage_t
name|GenStatus
decl_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|GenStatus
operator|.
name|Dword0
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|GenStatus
operator|.
name|Dword1
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_SAS_PHY_GENERAL_STATUS_PAGE SOP 0x%x 0x%x 0x%x\n"
operator|,
name|SOP
operator|,
name|GenStatus
operator|.
name|Dword0
operator|,
name|GenStatus
operator|.
name|Dword1
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
operator|&
name|GenStatus
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_PHY_SNW3_PAGE
case|:
block|{
name|agsaPhySNW3Page_t
name|Snw3
decl_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Snw3
operator|.
name|LSNW3
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Snw3
operator|.
name|RSNW3
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_PHY_SNW3_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
operator|&
name|Snw3
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_PHY_RATE_CONTROL_PAGE
case|:
block|{
name|agsaPhyRateControlPage_t
name|RateControl
decl_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|RateControl
operator|.
name|Dword0
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|RateControl
operator|.
name|Dword1
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|RateControl
operator|.
name|Dword2
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_PHY_RATE_CONTROL_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
operator|&
name|RateControl
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_OPEN_REJECT_RETRY_BACKOFF_THRESHOLD_PAGE
case|:
block|{
name|agsaSASPhyOpenRejectRetryBackOffThresholdPage_t
name|Backoff
decl_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Backoff
operator|.
name|Dword0
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Backoff
operator|.
name|Dword1
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Backoff
operator|.
name|Dword2
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Backoff
operator|.
name|Dword3
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: AGSA_SAS_PHY_OPEN_REJECT_RETRY_BACKOFF_THRESHOLD_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaGetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
operator|&
name|Backoff
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: undefined successful SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetPhyProfileRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2J"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|mpiSetPhyProfileRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSetPhyProfileRspV_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|status
decl_stmt|,
name|tag
decl_stmt|;
name|bit32
name|Reserved_Ppc_PHYID
decl_stmt|;
name|bit32
name|PhyId
decl_stmt|;
name|bit16
name|SOP
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2Q"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetPhyProfileRspV_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetPhyProfileRspV_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|Reserved_Ppc_PHYID
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetPhyProfileRspV_t
argument_list|,
name|Reserved_Ppc_PHYID
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get TAG */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: HTag=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2Q"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp:   %p\n"
operator|,
name|pIomb
operator|)
argument_list|)
expr_stmt|;
name|SOP
operator|=
name|pRequest
operator|->
name|SOP
expr_stmt|;
name|PhyId
operator|=
name|Reserved_Ppc_PHYID
operator|&
literal|0xFF
expr_stmt|;
comment|/* check status success or failure */
if|if
condition|(
name|status
condition|)
block|{
comment|/* status is FAILED */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp:AGSA_RC_FAILURE  0x%08X\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SOP
condition|)
block|{
case|case
name|AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaSetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_PHY_SNW3_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: AGSA_PHY_SNW3_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaSetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_PHY_RATE_CONTROL_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: AGSA_PHY_RATE_CONTROL_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaSetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_MISC_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: AGSA_SAS_PHY_MISC_PAGE SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|ossaSetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: undefined SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2Q"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: SUCCESS type 0x%X\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SOP
condition|)
block|{
case|case
name|AGSA_PHY_SNW3_PAGE
case|:
case|case
name|AGSA_PHY_RATE_CONTROL_PAGE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: Status 0x%x SOP 0x%x PhyId %d\n"
operator|,
name|status
operator|,
name|SOP
operator|,
name|PhyId
operator|)
argument_list|)
expr_stmt|;
name|ossaSetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE
case|:
block|{
name|agsaPhyAnalogSettingsPage_t
name|analog
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: AGSA_SAS_PHY_ANALOG_SETTINGS_PAGE 0x%X\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|analog
operator|.
name|Dword0
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|analog
operator|.
name|Dword1
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|analog
operator|.
name|Dword2
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|analog
operator|.
name|Dword3
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|agRoot
argument_list|,
operator|&
name|analog
operator|.
name|Dword4
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetPhyProfileRspV_t
argument_list|,
name|PageSpecificArea
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* call back with the status */
name|ossaSetPhyProfileCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|SOP
argument_list|,
name|PhyId
argument_list|,
operator|&
name|analog
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: undefined successful SOP 0x%x\n"
operator|,
name|SOP
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: completionCB %p\n"
operator|,
name|pRequest
operator|->
name|completionCB
operator|)
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetPhyProfileRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2Q"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Get Device Information Response  *  *  This routine handles the response of Get Device Info Command Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Message  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetDevInfoRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGetDevInfoRspV_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaDeviceInfo_t
name|commonDevInfo
decl_stmt|;
name|bit32
name|ARSrateSMPTimeOutPortID
decl_stmt|,
name|IRMcnITNexusTimeOut
decl_stmt|,
name|status
decl_stmt|,
name|tag
decl_stmt|;
name|bit32
name|deviceid
decl_stmt|;
name|bit32
name|sasAddrHi
decl_stmt|;
name|bit32
name|sasAddrLow
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|bit32
name|option
decl_stmt|;
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2M"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRspV_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRspV_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get TAG */
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: HTag=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2M"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
comment|/* check status success or failure */
if|if
condition|(
name|status
condition|)
block|{
comment|/* status is FAILED */
name|ossaGetDeviceInfoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|,
name|OSSA_DEV_INFO_INVALID_HANDLE
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2M"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|option
operator|=
operator|(
name|bit32
operator|)
name|pRequest
operator|->
name|DeviceInfoCmdOption
expr_stmt|;
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* status is SUCCESS */
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceid
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRspV_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|ARSrateSMPTimeOutPortID
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRspV_t
argument_list|,
name|ARSrateSMPTimeOutPortID
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IRMcnITNexusTimeOut
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRspV_t
argument_list|,
name|IRMcnITNexusTimeOut
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|sasAddrHi
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRspV_t
argument_list|,
name|sasAddrHi
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|sasAddrLow
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRspV_t
argument_list|,
name|sasAddrLow
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* find device handle from device index */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceid
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceHandle
expr_stmt|;
if|if
condition|(
name|pDevice
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
condition|)
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
expr_stmt|;
block|}
else|else
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: pDevice is NULL"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2M"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: warning!!! no deviceHandle is found"
operator|)
argument_list|)
expr_stmt|;
name|ossaGetDeviceInfoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|,
name|OSSA_DEV_INFO_INVALID_HANDLE
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"2M"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|option
operator|=
operator|(
name|bit32
operator|)
name|pRequest
operator|->
name|DeviceInfoCmdOption
expr_stmt|;
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* setup common device information */
name|si_memset
argument_list|(
operator|&
name|commonDevInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDeviceInfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|commonDevInfo
operator|.
name|smpTimeout
operator|=
call|(
name|bit16
call|)
argument_list|(
operator|(
name|ARSrateSMPTimeOutPortID
operator|>>
name|SHIFT8
operator|)
operator|&
name|SMPTO_VBITS
argument_list|)
expr_stmt|;
name|commonDevInfo
operator|.
name|it_NexusTimeout
operator|=
call|(
name|bit16
call|)
argument_list|(
name|IRMcnITNexusTimeOut
operator|&
name|NEXUSTO_VBITS
argument_list|)
expr_stmt|;
name|commonDevInfo
operator|.
name|firstBurstSize
operator|=
call|(
name|bit16
call|)
argument_list|(
operator|(
name|IRMcnITNexusTimeOut
operator|>>
name|SHIFT16
operator|)
operator|&
name|FIRST_BURST_MCN
argument_list|)
expr_stmt|;
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|ARSrateSMPTimeOutPortID
operator|>>
name|SHIFT24
operator|)
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
name|commonDevInfo
operator|.
name|flag
operator|=
call|(
name|bit32
call|)
argument_list|(
operator|(
name|ARSrateSMPTimeOutPortID
operator|>>
name|SHIFT30
operator|)
operator|&
name|FLAG_VBITS
argument_list|)
expr_stmt|;
name|commonDevInfo
operator|.
name|flag
operator||=
name|IRMcnITNexusTimeOut
operator|&
literal|0xf0000
expr_stmt|;
if|if
condition|(
name|IRMcnITNexusTimeOut
operator|&
literal|0x1000000
condition|)
block|{
name|commonDevInfo
operator|.
name|flag
operator||=
literal|0x100000
expr_stmt|;
block|}
comment|/* check SAS device then copy SAS Address */
if|if
condition|(
operator|(
operator|(
name|ARSrateSMPTimeOutPortID
operator|&
name|DEV_TYPE_BITS
operator|)
operator|>>
name|SHIFT28
operator|==
literal|0x00
operator|)
operator|||
operator|(
operator|(
name|ARSrateSMPTimeOutPortID
operator|&
name|DEV_TYPE_BITS
operator|)
operator|>>
name|SHIFT28
operator|==
literal|0x01
operator|)
condition|)
block|{
comment|/* copy the sasAddressHi byte-by-byte : no endianness */
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|0
index|]
operator|=
name|pIomb
operator|->
name|sasAddrHi
index|[
literal|0
index|]
expr_stmt|;
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|1
index|]
operator|=
name|pIomb
operator|->
name|sasAddrHi
index|[
literal|1
index|]
expr_stmt|;
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|2
index|]
operator|=
name|pIomb
operator|->
name|sasAddrHi
index|[
literal|2
index|]
expr_stmt|;
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|3
index|]
operator|=
name|pIomb
operator|->
name|sasAddrHi
index|[
literal|3
index|]
expr_stmt|;
comment|/* copy the sasAddressLow byte-by-byte : no endianness */
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|0
index|]
operator|=
name|pIomb
operator|->
name|sasAddrLow
index|[
literal|0
index|]
expr_stmt|;
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|1
index|]
operator|=
name|pIomb
operator|->
name|sasAddrLow
index|[
literal|1
index|]
expr_stmt|;
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|2
index|]
operator|=
name|pIomb
operator|->
name|sasAddrLow
index|[
literal|2
index|]
expr_stmt|;
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|3
index|]
operator|=
name|pIomb
operator|->
name|sasAddrLow
index|[
literal|3
index|]
expr_stmt|;
block|}
comment|/* copy common device information to SAS and SATA device common header*/
name|si_memcpy
argument_list|(
operator|&
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
argument_list|,
operator|&
name|commonDevInfo
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDeviceInfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|si_memcpy
argument_list|(
operator|&
name|pDevice
operator|->
name|devInfo
operator|.
name|sataDeviceInfo
operator|.
name|commonDevInfo
argument_list|,
operator|&
name|commonDevInfo
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDeviceInfo_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup device firstBurstSize infomation */
name|pDevice
operator|->
name|devInfo
operator|.
name|sataDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|firstBurstSize
operator|=
call|(
name|bit16
call|)
argument_list|(
operator|(
name|IRMcnITNexusTimeOut
operator|>>
name|SHIFT16
operator|)
operator|&
name|FIRST_BURST
argument_list|)
expr_stmt|;
comment|/* Display Device Information */
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: smpTimeout=0x%x\n"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|smpTimeout
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: it_NexusTimeout=0x%x\n"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|it_NexusTimeout
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: firstBurstSize=0x%x\n"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|firstBurstSize
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: devType_S_Rate=0x%x\n"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|)
argument_list|)
expr_stmt|;
comment|/*   D518 P2I[15-12]: Disk  HP      DG0146FAMWL     , HPDE, WWID=5000c500:17459a31, 6.0G   */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: Device 0x%08X flag 0x%08X %s WWID= %02x%02x%02x%02x:%02x%02x%02x%02x, %s\n"
operator|,
name|deviceid
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|flag
operator|,
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator|==
literal|0x20
condition|?
literal|"SATA DA"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator|==
literal|0x10
condition|?
literal|"SSP/SMP"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator|==
literal|0x0
condition|?
literal|"  STP  "
else|:
literal|"Unknown"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|3
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|2
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|1
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|0
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|3
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|2
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|1
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|0
index|]
operator|,
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|8
condition|?
literal|" 1.5G"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|9
condition|?
literal|" 3.0G"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|10
condition|?
literal|" 6.0G"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|11
condition|?
literal|"12.0G"
else|:
literal|"????"
operator|)
argument_list|)
expr_stmt|;
name|ossaGetDeviceInfoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agDevHandle
argument_list|,
name|OSSA_DEV_INFO_NO_EXTENDED_INFO
argument_list|,
operator|&
name|commonDevInfo
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
name|option
operator|=
operator|(
name|bit32
operator|)
name|pRequest
operator|->
name|DeviceInfoCmdOption
expr_stmt|;
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"2M"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Get Device Information Response  *  *  This routine handles the response of Get Device Info Command Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Message  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetDevInfoRspSpc
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGetDevInfoRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|dTypeSrateSMPTOPortID
decl_stmt|,
name|FirstBurstSizeITNexusTimeOut
decl_stmt|,
name|status
decl_stmt|,
name|tag
decl_stmt|;
name|bit32
name|deviceid
decl_stmt|;
name|bit32
name|sasAddrHi
decl_stmt|;
name|bit32
name|sasAddrLow
decl_stmt|;
name|bit32
name|Info_avail
init|=
literal|0
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2t"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get TAG */
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc: HTag=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2t"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
comment|/* check status success or failure */
if|if
condition|(
name|status
condition|)
block|{
comment|/* status is FAILED */
name|ossaGetDeviceInfoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|,
name|OSSA_DEV_INFO_INVALID_HANDLE
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2t"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* status is SUCCESS */
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceid
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRsp_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|dTypeSrateSMPTOPortID
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRsp_t
argument_list|,
name|dTypeSrateSMPTOArPortID
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|FirstBurstSizeITNexusTimeOut
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRsp_t
argument_list|,
name|FirstBurstSizeITNexusTimeOut
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|sasAddrHi
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRsp_t
argument_list|,
name|sasAddrHi
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|sasAddrLow
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDevInfoRsp_t
argument_list|,
name|sasAddrLow
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc:deviceid                     0x%08X\n"
operator|,
name|deviceid
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc:dTypeSrateSMPTOPortID        0x%08X\n"
operator|,
name|dTypeSrateSMPTOPortID
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc:FirstBurstSizeITNexusTimeOut 0x%08X\n"
operator|,
name|FirstBurstSizeITNexusTimeOut
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc:sasAddrHi                    0x%08X\n"
operator|,
name|sasAddrHi
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc:sasAddrLow                   0x%08X\n"
operator|,
name|sasAddrLow
operator|)
argument_list|)
expr_stmt|;
comment|/* find device handle from device index */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceid
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceHandle
expr_stmt|;
if|if
condition|(
name|pDevice
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
condition|)
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
expr_stmt|;
block|}
else|else
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc: pDevice is NULL"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2t"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc: warning!!! no deviceHandle is found"
operator|)
argument_list|)
expr_stmt|;
name|ossaGetDeviceInfoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|,
name|OSSA_DEV_INFO_INVALID_HANDLE
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"2t"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|Info_avail
operator|=
name|OSSA_DEV_INFO_NO_EXTENDED_INFO
expr_stmt|;
comment|/* setup device common infomation */
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|smpTimeout
operator|=
call|(
name|bit16
call|)
argument_list|(
operator|(
name|dTypeSrateSMPTOPortID
operator|>>
name|SHIFT8
operator|)
operator|&
name|SMPTO_BITS
argument_list|)
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sataDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|smpTimeout
operator|=
call|(
name|bit16
call|)
argument_list|(
operator|(
name|dTypeSrateSMPTOPortID
operator|>>
name|SHIFT8
operator|)
operator|&
name|SMPTO_BITS
argument_list|)
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|it_NexusTimeout
operator|=
call|(
name|bit16
call|)
argument_list|(
name|FirstBurstSizeITNexusTimeOut
operator|&
name|NEXUSTO_BITS
argument_list|)
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sataDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|it_NexusTimeout
operator|=
call|(
name|bit16
call|)
argument_list|(
name|FirstBurstSizeITNexusTimeOut
operator|&
name|NEXUSTO_BITS
argument_list|)
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|firstBurstSize
operator|=
call|(
name|bit16
call|)
argument_list|(
operator|(
name|FirstBurstSizeITNexusTimeOut
operator|>>
name|SHIFT16
operator|)
operator|&
name|FIRST_BURST
argument_list|)
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sataDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|firstBurstSize
operator|=
call|(
name|bit16
call|)
argument_list|(
operator|(
name|FirstBurstSizeITNexusTimeOut
operator|>>
name|SHIFT16
operator|)
operator|&
name|FIRST_BURST
argument_list|)
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|flag
operator|=
call|(
name|bit32
call|)
argument_list|(
operator|(
name|dTypeSrateSMPTOPortID
operator|>>
name|SHIFT4
operator|)
operator|&
name|FLAG_BITS
argument_list|)
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sataDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|flag
operator|=
call|(
name|bit32
call|)
argument_list|(
operator|(
name|dTypeSrateSMPTOPortID
operator|>>
name|SHIFT4
operator|)
operator|&
name|FLAG_BITS
argument_list|)
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|dTypeSrateSMPTOPortID
operator|>>
name|SHIFT24
operator|)
operator|&
name|LINK_RATE_BITS
argument_list|)
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sataDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|dTypeSrateSMPTOPortID
operator|>>
name|SHIFT24
operator|)
operator|&
name|LINK_RATE_BITS
argument_list|)
expr_stmt|;
comment|/* check SAS device then copy SAS Address */
if|if
condition|(
operator|(
operator|(
name|dTypeSrateSMPTOPortID
operator|&
name|DEV_TYPE_BITS
operator|)
operator|>>
name|SHIFT28
operator|==
literal|0x00
operator|)
operator|||
operator|(
operator|(
name|dTypeSrateSMPTOPortID
operator|&
name|DEV_TYPE_BITS
operator|)
operator|>>
name|SHIFT28
operator|==
literal|0x01
operator|)
condition|)
block|{
comment|/* copy the sasAddressHi byte-by-byte : no endianness */
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|0
index|]
operator|=
name|pIomb
operator|->
name|sasAddrHi
index|[
literal|0
index|]
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|1
index|]
operator|=
name|pIomb
operator|->
name|sasAddrHi
index|[
literal|1
index|]
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|2
index|]
operator|=
name|pIomb
operator|->
name|sasAddrHi
index|[
literal|2
index|]
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|3
index|]
operator|=
name|pIomb
operator|->
name|sasAddrHi
index|[
literal|3
index|]
expr_stmt|;
comment|/* copy the sasAddressLow byte-by-byte : no endianness */
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|0
index|]
operator|=
name|pIomb
operator|->
name|sasAddrLow
index|[
literal|0
index|]
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|1
index|]
operator|=
name|pIomb
operator|->
name|sasAddrLow
index|[
literal|1
index|]
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|2
index|]
operator|=
name|pIomb
operator|->
name|sasAddrLow
index|[
literal|2
index|]
expr_stmt|;
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|3
index|]
operator|=
name|pIomb
operator|->
name|sasAddrLow
index|[
literal|3
index|]
expr_stmt|;
block|}
comment|/* Display Device Information */
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc: smpTimeout=     0x%x\n"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|smpTimeout
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc: it_NexusTimeout=0x%x\n"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|it_NexusTimeout
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc: firstBurstSize= 0x%x\n"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|firstBurstSize
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc: devType_S_Rate= 0x%x\n"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"Device SPC deviceid 0x%08X flag 0x%08X %s WWID= %02x%02x%02x%02x:%02x%02x%02x%02x, %s\n"
operator|,
name|deviceid
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|flag
operator|,
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator|==
literal|0x20
condition|?
literal|"SATA DA"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator|==
literal|0x10
condition|?
literal|"SSP/SMP"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator|==
literal|0x0
condition|?
literal|"  STP  "
else|:
literal|"Unknown"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|3
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|2
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|1
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|0
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|3
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|2
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|1
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|0
index|]
operator|,
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|8
condition|?
literal|" 1.5G"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|9
condition|?
literal|" 3.0G"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|10
condition|?
literal|" 6.0G"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|11
condition|?
literal|"12.0G"
else|:
literal|"????"
operator|)
argument_list|)
expr_stmt|;
name|ossaGetDeviceInfoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agDevHandle
argument_list|,
name|Info_avail
argument_list|,
operator|&
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDevInfoRspSpc: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"2t"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Set Device Information Response  *  *  This routine handles the response of Set Device Info Command Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Message  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSetDevInfoRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSetDeviceInfoRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|status
decl_stmt|,
name|deviceid
decl_stmt|,
name|option
decl_stmt|,
name|param
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2v"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetDeviceInfoRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetDeviceInfoRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get TAG */
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp: HTag=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2v"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
comment|/* check status success or failure */
if|if
condition|(
name|status
condition|)
block|{
comment|/* status is FAILED */
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp: status is FAILED pRequest->completionCB == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
name|ossaSetDeviceInfoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp: status is FAILED use CB\n"
operator|)
argument_list|)
expr_stmt|;
operator|(
operator|*
call|(
name|ossaSetDeviceInfoCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|agNULL
operator|,
name|status
operator|,
literal|0
operator|,
literal|0
operator|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2v"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* status is SUCCESS */
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceid
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetDeviceInfoRsp_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|option
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetDeviceInfoRsp_t
argument_list|,
name|SA_SR_SI
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|param
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetDeviceInfoRsp_t
argument_list|,
name|A_R_ITNT
argument_list|)
argument_list|)
expr_stmt|;
comment|/* find device handle from device index */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceid
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceHandle
expr_stmt|;
if|if
condition|(
name|pDevice
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
condition|)
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
expr_stmt|;
block|}
else|else
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp: pDevice is NULL"
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"2v"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp: warning!!! no deviceHandle is found"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|ossaSetDeviceInfoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|,
name|OSSA_IO_NO_DEVICE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaSetDeviceInfoCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|agNULL
operator|,
name|OSSA_IO_NO_DEVICE
operator|,
literal|0
operator|,
literal|0
operator|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"2v"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp:, option 0x%X param 0x%X\n"
operator|,
name|option
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp:was option 0x%X param 0x%X\n"
operator|,
name|option
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp:pDevice->option 0x%X pDevice->param 0x%X\n"
operator|,
name|pDevice
operator|->
name|option
operator|,
name|pDevice
operator|->
name|param
operator|)
argument_list|)
expr_stmt|;
name|option
operator||=
name|pDevice
operator|->
name|option
expr_stmt|;
name|param
operator||=
name|pDevice
operator|->
name|param
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp:now option 0x%X param 0x%X\n"
operator|,
name|option
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|ossaSetDeviceInfoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agDevHandle
argument_list|,
name|OSSA_SUCCESS
argument_list|,
name|option
argument_list|,
name|param
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaSetDeviceInfoCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|agDevHandle
operator|,
name|OSSA_SUCCESS
operator|,
name|option
operator|,
name|param
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSetDevInfoRsp:, option 0x%X param 0x%X\n"
operator|,
name|option
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|ossaSetDeviceInfoCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agDevHandle
argument_list|,
name|OSSA_SUCCESS
argument_list|,
name|option
argument_list|,
name|param
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaSetDeviceInfoCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|agDevHandle
operator|,
name|OSSA_SUCCESS
operator|,
name|option
operator|,
name|param
operator|)
expr_stmt|;
block|}
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"2v"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI SSP Event  *  *  This function handles the SAS Event.  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSSPEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSSPEventRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaPortContext_t
modifier|*
name|agPortContext
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|bit32
name|event
decl_stmt|,
name|deviceId
decl_stmt|;
name|bit32
name|deviceIdx
decl_stmt|,
name|tag
decl_stmt|,
name|portId_tmp
decl_stmt|;
name|bit32
name|SSPTag
decl_stmt|;
name|bit16
name|sspTag
decl_stmt|;
name|bit8
name|portId
decl_stmt|;
name|agsaDifDetails_t
name|Dif_details
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2u"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|event
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|portId_tmp
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|portId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|SSPTag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|SSPTag
argument_list|)
argument_list|)
expr_stmt|;
name|sspTag
operator|=
call|(
name|bit16
call|)
argument_list|(
name|SSPTag
operator|&
name|SSPTAG_BITS
argument_list|)
expr_stmt|;
comment|/* get IORequest from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|)
argument_list|,
literal|"pRequest"
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: agNULL == pRequest event 0x%X\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2u"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* get port context */
name|portId
operator|=
call|(
name|bit8
call|)
argument_list|(
name|portId_tmp
operator|&
name|PORTID_MASK
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSSPEvent:PortID 0x%x PortStatus 0x%x PortContext %p\n"
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortID
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortStatus
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortContext
operator|)
argument_list|)
expr_stmt|;
name|agPortContext
operator|=
operator|(
name|agsaPortContext_t
operator|*
operator|)
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortContext
expr_stmt|;
comment|/* get device Id */
name|deviceIdx
operator|=
name|deviceId
operator|&
name|DEVICE_ID_BITS
expr_stmt|;
name|OS_ASSERT
argument_list|(
name|deviceIdx
operator|<
name|MAX_IO_DEVICE_ENTRIES
argument_list|,
literal|"deviceIdx MAX_IO_DEVICE_ENTRIES"
argument_list|)
expr_stmt|;
comment|/* find device handle from device index */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceIdx
index|]
operator|.
name|DeviceHandle
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pDevice
condition|)
block|{
name|OS_ASSERT
argument_list|(
name|pDevice
argument_list|,
literal|"pDevice"
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
name|agNULL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
condition|)
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
expr_stmt|;
block|}
else|else
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
case|case
name|OSSA_IO_XFR_ERROR_DIF_MISMATCH
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent:  DIF Event 0x%x HTAG = 0x%x\n"
operator|,
name|event
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Dif_details
operator|.
name|UpperLBA
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|EVT_PARAM0_or_LBAH
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Dif_details
operator|.
name|LowerLBA
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|EVT_PARAM1_or_LBAL
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Dif_details
operator|.
name|sasAddressHi
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|SAS_ADDRH
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Dif_details
operator|.
name|sasAddressLo
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|SAS_ADDRL
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Dif_details
operator|.
name|ExpectedCRCUDT01
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|UDT1_E_UDT0_E_CRC_E
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Dif_details
operator|.
name|ExpectedUDT2345
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|UDT5_E_UDT4_E_UDT3_E_UDT2_E
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Dif_details
operator|.
name|ActualCRCUDT01
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|UDT1_A_UDT0_A_CRC_A
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Dif_details
operator|.
name|ActualUDT2345
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|UDT5_A_UDT4_A_UDT3_A_UDT2_A
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Dif_details
operator|.
name|DIFErrDevID
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|HW_DEVID_Reserved_DIF_ERR
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Dif_details
operator|.
name|ErrBoffsetEDataLen
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPEventRsp_t
argument_list|,
name|EDATA_LEN_ERR_BOFF
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSSPEvent: UpperLBA.         0x%08X LowerLBA.           0x%08X\n"
operator|,
name|Dif_details
operator|.
name|UpperLBA
operator|,
name|Dif_details
operator|.
name|LowerLBA
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSSPEvent: sasAddressHi.     0x%02X%02X%02X%02X sasAddressLo.       0x%02X%02X%02X%02X\n"
operator|,
name|Dif_details
operator|.
name|sasAddressHi
index|[
literal|0
index|]
operator|,
name|Dif_details
operator|.
name|sasAddressHi
index|[
literal|1
index|]
operator|,
name|Dif_details
operator|.
name|sasAddressHi
index|[
literal|2
index|]
operator|,
name|Dif_details
operator|.
name|sasAddressHi
index|[
literal|3
index|]
operator|,
name|Dif_details
operator|.
name|sasAddressLo
index|[
literal|0
index|]
operator|,
name|Dif_details
operator|.
name|sasAddressLo
index|[
literal|1
index|]
operator|,
name|Dif_details
operator|.
name|sasAddressLo
index|[
literal|2
index|]
operator|,
name|Dif_details
operator|.
name|sasAddressLo
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSSPEvent: ExpectedCRCUDT01. 0x%08X ExpectedUDT2345.    0x%08X\n"
operator|,
name|Dif_details
operator|.
name|ExpectedCRCUDT01
operator|,
name|Dif_details
operator|.
name|ExpectedUDT2345
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSSPEvent: ActualCRCUDT01.   0x%08X ActualUDT2345.      0x%08X\n"
operator|,
name|Dif_details
operator|.
name|ActualCRCUDT01
operator|,
name|Dif_details
operator|.
name|ActualUDT2345
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSSPEvent: DIFErrDevID.      0x%08X ErrBoffsetEDataLen. 0x%08X\n"
operator|,
name|Dif_details
operator|.
name|DIFErrDevID
operator|,
name|Dif_details
operator|.
name|ErrBoffsetEDataLen
operator|)
argument_list|)
expr_stmt|;
block|}
default|default:
block|{
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSSPEvent:  Non DIF event"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* get event */
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|OSSA_IO_OVERFLOW
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OVERFLOW tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OVERFLOW
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_BREAK
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERROR_BREAK tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_BREAK
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERROR_PHY_NOT_READY tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_PHY_NOT_READY
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_BREAK tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_BREAK
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_NAK_RECEIVED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERROR_NAK_RECEIVED tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_NAK_RECEIVED
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_ACK_NAK_TIMEOUT
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERROR_ACK_NAK_TIMEOUT tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_ACK_NAK_TIMEOUT
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_OFFSET_MISMATCH
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERROR_OFFSET_MISMATCH tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SA_ENABLE_PCI_TRIGGER
if|if
condition|(
name|saRoot
operator|->
name|swConfig
operator|.
name|PCI_trigger
operator|&
name|PCI_TRIGGER_OFFSET_MISMATCH
condition|)
block|{
name|siPCITriger
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SA_ENABLE_PCI_TRIGGER */
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_OFFSET_MISMATCH
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_XFER_ZERO_DATA_LEN
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERROR_XFER_ZERO_DATA_LEN tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_XFER_ZERO_DATA_LEN
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_CMD_ISSUE_ACK_NAK_TIMEOUT
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERROR_CMD_ISSUE_ACK_NAK_TIMEOUT tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_CMD_ISSUE_ACK_NAK_TIMEOUT
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_OPEN_RETRY_TIMEOUT tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_OPEN_RETRY_TIMEOUT
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_XFER_RDY_OVERRUN
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERROR_XFER_RDY_OVERRUN tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_XFER_RDY_OVERRUN
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_XFER_RDY_NOT_EXPECTED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERROR_XFER_RDY_NOT_EXPECTED tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_XFER_RDY_NOT_EXPECTED
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_CMD_FRAME_ISSUED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_CMD_FRAME_ISSUED tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_CMD_FRAME_ISSUED
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_UNEXPECTED_PHASE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERROR_UNEXPECTED_PHASE tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_UNEXPECTED_PHASE
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent:OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED HTAG = 0x%x sspTag = 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFR_ERROR_INTERNAL_CRC_ERROR
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFR_ERROR_INTERNAL_CRC_ERROR HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFR_ERROR_INTERNAL_CRC_ERROR
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
argument_list|,
operator|&
name|Dif_details
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
argument_list|,
operator|&
name|Dif_details
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
argument_list|,
operator|&
name|Dif_details
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFR_ERROR_DIF_MISMATCH
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFR_ERROR_DIF_MISMATCH tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFR_ERROR_DIF_MISMATCH
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
argument_list|,
operator|&
name|Dif_details
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERR_EOB_DATA_OVERRUN
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_ERR_EOB_DATA_OVERRUN tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERR_EOB_DATA_OVERRUN
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_READ_COMPL_ERR
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent: OSSA_IO_XFER_READ_COMPL_ERR tag 0x%x ssptag 0x%x\n"
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_READ_COMPL_ERR
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPEvent:  Unknown Event 0x%x tag 0x%x ssptag 0x%x\n"
operator|,
name|event
operator|,
name|tag
operator|,
name|sspTag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_UNKNOWN_ERROR
operator|++
expr_stmt|;
name|ossaSSPEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
name|sspTag
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2u"
argument_list|)
expr_stmt|;
comment|/* return value */
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI SATA Event  *  *  This function handles the SATA Event.  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSATAEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSATAEventRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
init|=
name|agNULL
decl_stmt|;
name|agsaPortContext_t
modifier|*
name|agPortContext
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|bit32
name|deviceIdx
decl_stmt|,
name|portId_tmp
decl_stmt|,
name|event
decl_stmt|,
name|tag
decl_stmt|,
name|deviceId
decl_stmt|;
name|bit8
name|portId
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2w"
argument_list|)
expr_stmt|;
comment|/* get port context */
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|portId_tmp
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSATAEventRsp_t
argument_list|,
name|portId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSATAEventRsp_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|event
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSATAEventRsp_t
argument_list|,
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSATAEventRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|OSSA_IO_XFER_ERROR_ABORTED_NCQ_MODE
operator|!=
name|event
condition|)
block|{
comment|/* get IORequest from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
block|}
comment|/* get port context - only for OSSA_IO_XFER_ERROR_ABORTED_NCQ_MODE */
name|portId
operator|=
call|(
name|bit8
call|)
argument_list|(
name|portId_tmp
operator|&
name|PORTID_MASK
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSATAEvent:PortID 0x%x PortStatus 0x%x PortContext %p\n"
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortID
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortStatus
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortContext
operator|)
argument_list|)
expr_stmt|;
name|agPortContext
operator|=
operator|(
name|agsaPortContext_t
operator|*
operator|)
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortContext
expr_stmt|;
comment|/* get device Id - only for OSSA_IO_XFER_ERROR_ABORTED_NCQ_MODE*/
name|deviceIdx
operator|=
name|deviceId
operator|&
name|DEVICE_ID_BITS
expr_stmt|;
name|OS_ASSERT
argument_list|(
name|deviceIdx
operator|<
name|MAX_IO_DEVICE_ENTRIES
argument_list|,
literal|"deviceIdx MAX_IO_DEVICE_ENTRIES"
argument_list|)
expr_stmt|;
comment|/* find device handle from device index */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceIdx
index|]
operator|.
name|DeviceHandle
expr_stmt|;
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
expr_stmt|;
comment|/* get event */
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|OSSA_IO_OVERFLOW
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_OVERFLOW HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OVERFLOW
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_BREAK
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_ERROR_BREAK HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_BREAK
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_ERROR_PHY_NOT_READY HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_PHY_NOT_READY
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_OPEN_CNX_ERROR_BREAK HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_BREAK
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent:  HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent:OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED  HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_NAK_RECEIVED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_ERROR_NAK_RECEIVED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_NAK_RECEIVED
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_ABORTED_NCQ_MODE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_ERROR_ABORTED_NCQ_MODE HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_ABORTED_NCQ_MODE
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_OFFSET_MISMATCH
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_ERROR_OFFSET_MISMATCH HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_OFFSET_MISMATCH
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_XFER_ZERO_DATA_LEN
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_ERROR_XFER_ZERO_DATA_LEN HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_XFER_ZERO_DATA_LEN
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_OPEN_RETRY_TIMEOUT HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_OPEN_RETRY_TIMEOUT
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_PEER_ABORTED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_ERROR_PEER_ABORTED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_PEER_ABORTED
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_CMD_FRAME_ISSUED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_CMD_FRAME_ISSUED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_CMD_FRAME_ISSUED
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent, OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_UNEXPECTED_PHASE
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent, OSSA_IO_XFER_ERROR_UNEXPECTED_PHASE HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_UNEXPECTED_PHASE
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_XFER_RDY_OVERRUN
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent, OSSA_IO_XFER_ERROR_XFER_RDY_OVERRUN HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_XFER_RDY_OVERRUN
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_XFER_RDY_NOT_EXPECTED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent, OSSA_IO_XFER_ERROR_XFER_RDY_NOT_EXPECTED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_XFER_RDY_NOT_EXPECTED
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_PIO_SETUP_ERROR
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_PIO_SETUP_ERROR HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_PIO_SETUP_ERROR
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFR_ERROR_DIF_MISMATCH
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFR_ERROR_DIF_MISMATCH HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFR_ERROR_DIF_MISMATCH
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFR_ERROR_INTERNAL_CRC_ERROR
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFR_ERROR_INTERNAL_CRC_ERROR HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFR_ERROR_INTERNAL_CRC_ERROR
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERR_EOB_DATA_OVERRUN
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_ERR_EOB_DATA_OVERRUN HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERR_EOB_DATA_OVERRUN
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OSSA_IO_XFER_ERROR_DMA_ACTIVATE_TIMEOUT
case|:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: OSSA_IO_XFER_ERROR_DMA_ACTIVATE_TIMEOUT HTAG = 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_XFER_ERROR_DMA_ACTIVATE_TIMEOUT
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAEvent: Unknown Event 0x%x HTAG = 0x%x\n"
operator|,
name|event
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|IoEventCount
operator|.
name|agOSSA_IO_UNKNOWN_ERROR
operator|++
expr_stmt|;
name|ossaSATAEvent
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|agPortContext
argument_list|,
name|agDevHandle
argument_list|,
name|event
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2w"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Set NVM Data Response  *  *  This routine handles the response of SET NVM Data Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSetNVMDataRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSetNVMDataRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|status
decl_stmt|,
name|iPTdaBnDpsAsNvm
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2x"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetNVMDataRsp: HTag=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetNVMDataRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|iPTdaBnDpsAsNvm
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetNVMDataRsp_t
argument_list|,
name|iPTdaBnDpsAsNvm
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetNVMDataRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetNVMDataRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2x"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|iPTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_CONFIG_SEEPROM
operator|)
operator|||
operator|(
operator|(
name|iPTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_VPD_FLASH
operator|)
operator|||
operator|(
operator|(
name|iPTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|==
name|AGSA_NVMD_TWI_DEVICES
operator|)
condition|)
block|{
comment|/* CB for VPD for SEEPROM-0, VPD_FLASH and TWI */
name|ossaSetNVMDResponseCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
operator|(
name|status
operator|&
name|NVMD_STAT
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* should not happend */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetNVMDataRsp: NVMD is wrong. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
operator|(
name|iPTdaBnDpsAsNvm
operator|&
name|NVMD_TYPE
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2x"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI SSP ABORT Response  *  *  This function handles the SSP Abort Response.  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSSPAbortRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSSPAbortRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|status
decl_stmt|,
name|scope
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2y"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPAbortRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPAbortRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|scope
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPAbortRsp_t
argument_list|,
name|scp
argument_list|)
argument_list|)
expr_stmt|;
name|scope
operator|&=
literal|3
expr_stmt|;
comment|/* get IORequest from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
comment|/* remove the SSP_ABORT or SATA_ABORT request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|)
argument_list|,
literal|"pRequest"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPAbortRsp: the request is NULL. Tag=%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2y"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agTRUE
operator|==
name|pRequest
operator|->
name|valid
condition|)
block|{
name|pDevice
operator|=
name|pRequest
operator|->
name|pDevice
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|pDevice
operator|)
argument_list|,
literal|"pRequest->pDevice"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSSPAbortRsp: request abort is valid Htag 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* remove the SSP_ABORT or SATA_ABORT request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|ossaSSPAbortCB
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|scope
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaGenericAbortCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|pRequest
operator|->
name|pIORequestContext
operator|,
name|scope
operator|,
name|status
operator|)
expr_stmt|;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* Delete the request from the pendingIORequests */
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|pDevice
operator|->
name|pendingIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPAbortRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|scope
condition|)
block|{
name|siCountActiveIORequestsOnDevice
argument_list|(
name|agRoot
argument_list|,
name|pDevice
operator|->
name|DeviceMapIndex
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPAbortRsp: the request is not valid any more. Tag=%x\n"
operator|,
name|pRequest
operator|->
name|HTag
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2y"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI SATA ABORT Response  *  *  This function handles the SATA Event.  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSATAAbortRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSATAAbortRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|status
decl_stmt|,
name|scope
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3B"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSATAAbortRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSATAAbortRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|scope
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSATAAbortRsp_t
argument_list|,
name|scp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get IORequest from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
comment|/* remove the SSP_ABORT or SATA_ABORT request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAAbortRsp: the request is NULL. Tag=%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|)
argument_list|,
literal|"pRequest"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3B"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agTRUE
operator|==
name|pRequest
operator|->
name|valid
condition|)
block|{
name|pDevice
operator|=
name|pRequest
operator|->
name|pDevice
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|pDevice
operator|)
argument_list|,
literal|"pRequest->pDevice"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSATAAbortRsp: request abort is valid Htag 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|ossaSATAAbortCB
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|scope
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaGenericAbortCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|pRequest
operator|->
name|pIORequestContext
operator|,
name|scope
operator|,
name|status
operator|)
expr_stmt|;
block|}
comment|/* remove the SATA_ABORT request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* Delete the request from the pendingIORequests */
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|pDevice
operator|->
name|pendingIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSATAAbortRsp: the request is not valid any more. Tag=%x\n"
operator|,
name|pRequest
operator|->
name|HTag
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3B"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Set GPIO Response  *  *  This routine handles the response of GPIO Command  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGPIORsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGPIORsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaGpioPinSetupInfo_t
name|pinSetupInfo
decl_stmt|;
name|agsaGpioEventSetupInfo_t
name|eventSetupInfo
decl_stmt|;
name|bit32
name|GpioIe
decl_stmt|,
name|OT11_0
decl_stmt|,
name|OT19_12
decl_stmt|,
name|GPIEVChange
decl_stmt|,
name|GPIEVFall
decl_stmt|,
name|GPIEVRise
decl_stmt|,
name|GpioRdVal
decl_stmt|,
name|tag
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"5C"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGPIORsp: HTag=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGPIORsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGPIORsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"5C"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
comment|/* set payload to zeros */
name|si_memset
argument_list|(
operator|&
name|pinSetupInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaGpioPinSetupInfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|eventSetupInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaGpioEventSetupInfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|GpioIe
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGPIORsp_t
argument_list|,
name|GpioIe
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|OT11_0
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGPIORsp_t
argument_list|,
name|OT11_0
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|OT19_12
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGPIORsp_t
argument_list|,
name|OT19_12
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|GPIEVChange
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGPIORsp_t
argument_list|,
name|GPIEVChange
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|GPIEVFall
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGPIORsp_t
argument_list|,
name|GPIEVFall
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|GPIEVRise
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGPIORsp_t
argument_list|,
name|GPIEVRise
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|GpioRdVal
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGPIORsp_t
argument_list|,
name|GpioRdVal
argument_list|)
argument_list|)
expr_stmt|;
name|pinSetupInfo
operator|.
name|gpioInputEnabled
operator|=
name|GpioIe
expr_stmt|;
name|pinSetupInfo
operator|.
name|gpioTypePart1
operator|=
name|OT11_0
expr_stmt|;
name|pinSetupInfo
operator|.
name|gpioTypePart2
operator|=
name|OT19_12
expr_stmt|;
name|eventSetupInfo
operator|.
name|gpioEventLevel
operator|=
name|GPIEVChange
expr_stmt|;
name|eventSetupInfo
operator|.
name|gpioEventFallingEdge
operator|=
name|GPIEVFall
expr_stmt|;
name|eventSetupInfo
operator|.
name|gpioEventRisingEdge
operator|=
name|GPIEVRise
expr_stmt|;
name|ossaGpioResponseCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|OSSA_IO_SUCCESS
argument_list|,
name|GpioRdVal
argument_list|,
operator|&
name|pinSetupInfo
argument_list|,
operator|&
name|eventSetupInfo
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGPIORsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"5C"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Set GPIO Event Response  *  *  This routine handles the response of GPIO Event  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGPIOEventRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGPIOEvent_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|bit32
name|GpioEvent
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3D"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|GpioEvent
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGPIOEvent_t
argument_list|,
name|GpioEvent
argument_list|)
argument_list|)
expr_stmt|;
name|ossaGpioEvent
argument_list|(
name|agRoot
argument_list|,
name|GpioEvent
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3D"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAS Diagnostic Start/End Response  *  *  This routine handles the response of SAS Diagnostic Start/End Command  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSASDiagStartEndRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSASDiagStartEndRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|Status
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2F"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSASDiagStartEndRsp: HTAG=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSASDiagStartEndRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSASDiagStartEndRsp_t
argument_list|,
name|Status
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagStartEndRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2F"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Status
condition|)
block|{
case|case
name|OSSA_DIAG_SE_SUCCESS
case|:
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSASDiagStartEndRsp: Status OSSA_DIAG_SE_SUCCESS 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DIAG_SE_INVALID_PHY_ID
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagStartEndRsp: Status OSSA_DIAG_SE_INVALID_PHY_ID 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DIAG_PHY_NOT_DISABLED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagStartEndRsp: Status OSSA_DIAG_PHY_NOT_DISABLED Status 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DIAG_OTHER_FAILURE
case|:
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagStartEndRsp: Status OSSA_DIAG_OTHER_FAILURE Status 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagStartEndRsp: Status OSSA_DIAG_OPCODE_INVALID Status 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagStartEndRsp:Status UNKNOWN 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ossaSASDiagStartEndCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|Status
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagStartEndRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2F"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAS Diagnostic Execute Response  *  *  This routine handles the response of SAS Diagnostic Execute Command  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSASDiagExecuteRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSASDiagExecuteRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|Status
decl_stmt|,
name|CmdTypeDescPhyId
decl_stmt|,
name|ReportData
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3G"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp: HTAG=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSASDiagExecuteRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSASDiagExecuteRsp_t
argument_list|,
name|Status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|CmdTypeDescPhyId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSASDiagExecuteRsp_t
argument_list|,
name|CmdTypeDescPhyId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|ReportData
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSASDiagExecuteRsp_t
argument_list|,
name|ReportData
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp: Bad Response IOMB!!! pRequest is NULL.TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3G"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
switch|switch
condition|(
name|Status
condition|)
block|{
case|case
name|OSSA_DIAG_SUCCESS
case|:
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp: Status OSSA_DIAG_SUCCESS 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DIAG_INVALID_COMMAND
case|:
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp: Status OSSA_DIAG_INVALID_COMMAND Status 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp: Status OSSA_DIAG_FAIL Status 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|OSSA_REGISTER_ACCESS_TIMEOUT
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp: Status OSSA_REGISTER_ACCESS_TIMEOUT Status 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DIAG_NOT_IN_DIAGNOSTIC_MODE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp: Status OSSA_DIAG_NOT_IN_DIAGNOSTIC_MODE Status 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DIAG_INVALID_PHY
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp: Status OSSA_DIAG_INVALID_PHY Status 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MEMORY_ALLOC_FAILURE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp: Status  Status 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp:Status UNKNOWN 0x%X \n"
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|ossaSASDiagExecuteCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|Status
argument_list|,
name|CmdTypeDescPhyId
argument_list|,
name|ReportData
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASDiagExecuteRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3G"
argument_list|)
expr_stmt|;
comment|/* return value */
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAS General Event Notification Response  *  *  This routine handles the response of Inbound IOMB Command with error case  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGeneralEventRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGeneralEventRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|tag
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
init|=
name|NULL
decl_stmt|;
name|agsaGeneralEventRsp_t
name|GenEventData
decl_stmt|;
name|agsaHWEventEncrypt_t
name|agEvent
decl_stmt|;
name|bit16
name|OpCode
init|=
literal|0
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3H"
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|GenEventData
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaGeneralEventRsp_t
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGeneralEventRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGeneralEventRsp:  %p\n"
operator|,
name|pIomb
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: OpCode 0x%X status 0x%x\n"
operator|,
name|pIomb
operator|->
name|inbIOMBpayload
index|[
literal|0
index|]
operator|&
name|OPCODE_BITS
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GENERAL_EVENT_PAYLOAD
condition|;
name|i
operator|++
control|)
block|{
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
name|i
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGeneralEventRsp_t
argument_list|,
name|inbIOMBpayload
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: inbIOMBpayload 0x%08x 0x%08x 0x%08x 0x%08x\n"
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|0
index|]
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|1
index|]
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|2
index|]
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: inbIOMBpayload 0x%08x 0x%08x 0x%08x 0x%08x\n"
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|4
index|]
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|8
index|]
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|6
index|]
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|7
index|]
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
comment|/*status  */
block|{
case|case
name|GEN_EVENT_IOMB_V_BIT_NOT_SET
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: GEN_EVENT_IOMB_V_BIT_NOT_SET\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN_EVENT_INBOUND_IOMB_OPC_NOT_SUPPORTED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: GEN_EVENT_INBOUND_IOMB_OPC_NOT_SUPPORTED\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN_EVENT_IOMB_INVALID_OBID
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: GEN_EVENT_IOMB_INVALID_OBID\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN_EVENT_DS_IN_NON_OPERATIONAL
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: GEN_EVENT_DS_IN_NON_OPERATIONAL\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN_EVENT_DS_IN_RECOVERY
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: GEN_EVENT_DS_IN_RECOVERY\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN_EVENT_DS_INVALID
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: GEN_EVENT_DS_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN_EVENT_IO_XFER_READ_COMPL_ERR
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: GEN_EVENT_IO_XFER_READ_COMPL_ERR 0x%x 0x%x 0x%x\n"
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|0
index|]
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|1
index|]
operator|,
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
name|ossaGeneralEvent
argument_list|(
name|agRoot
argument_list|,
name|status
argument_list|,
name|agContext
argument_list|,
name|GenEventData
operator|.
name|inbIOMBpayload
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3H"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: Unknown General Event status!!! 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3H"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|OpCode
operator|=
call|(
name|bit16
call|)
argument_list|(
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|0
index|]
operator|&
name|OPCODE_BITS
argument_list|)
expr_stmt|;
name|tag
operator|=
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|1
index|]
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp:OpCode 0x%X [0] 0x%08x\n"
operator|,
name|OpCode
operator|,
call|(
name|bit16
call|)
argument_list|(
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|0
index|]
operator|&
name|OPCODE_BITS
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|OpCode
condition|)
comment|/* OpCode */
block|{
case|case
name|OPC_INB_DEV_HANDLE_ACCEPT
case|:
case|case
name|OPC_INB_ECHO
case|:
case|case
name|OPC_INB_FW_FLASH_UPDATE
case|:
case|case
name|OPC_INB_GET_NVMD_DATA
case|:
case|case
name|OPC_INB_SET_NVMD_DATA
case|:
case|case
name|OPC_INB_DEREG_DEV_HANDLE
case|:
case|case
name|OPC_INB_SPC_GET_DEV_INFO
case|:
case|case
name|OPC_INB_GET_DEV_HANDLE
case|:
case|case
name|OPC_INB_SPC_REG_DEV
case|:
case|case
name|OPC_INB_SAS_DIAG_EXECUTE
case|:
case|case
name|OPC_INB_SAS_DIAG_MODE_START_END
case|:
case|case
name|OPC_INB_PHYSTART
case|:
case|case
name|OPC_INB_PHYSTOP
case|:
case|case
name|OPC_INB_LOCAL_PHY_CONTROL
case|:
case|case
name|OPC_INB_GPIO
case|:
case|case
name|OPC_INB_GET_TIME_STAMP
case|:
case|case
name|OPC_INB_PORT_CONTROL
case|:
case|case
name|OPC_INB_SET_DEVICE_STATE
case|:
case|case
name|OPC_INB_GET_DEVICE_STATE
case|:
case|case
name|OPC_INB_SET_DEV_INFO
case|:
comment|//      case OPC_INB_PCIE_DIAG_EXECUTE:
case|case
name|OPC_INB_SAS_HW_EVENT_ACK
case|:
case|case
name|OPC_INB_SAS_RE_INITIALIZE
case|:
case|case
name|OPC_INB_KEK_MANAGEMENT
case|:
case|case
name|OPC_INB_SET_OPERATOR
case|:
case|case
name|OPC_INB_GET_OPERATOR
case|:
comment|//      case OPC_INB_SGPIO:
ifdef|#
directive|ifdef
name|SPC_ENABLE_PROFILE
case|case
name|OPC_INB_FW_PROFILE
case|:
endif|#
directive|endif
comment|/* Uses the tag table, so we have to free it up */
name|SA_ASSERT
argument_list|(
operator|(
name|tag
operator|<
name|AGSA_MAX_VALID_PORTS
operator|*
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
operator|)
argument_list|,
literal|"OPC_OUB_GENERAL_EVENT tag out of range"
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|saRoot
operator|->
name|IOMap
index|[
name|tag
operator|<
operator|(
name|AGSA_MAX_VALID_PORTS
operator|*
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
operator|)
condition|?
name|tag
else|:
literal|0
index|]
operator|.
name|Tag
operator|!=
name|MARK_OFF
operator|)
argument_list|,
literal|"OPC_OUB_GENERAL_EVENT tag not in use 1"
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
if|if
condition|(
name|tag
operator|>
name|AGSA_MAX_VALID_PORTS
operator|*
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"3H"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
endif|#
directive|endif
comment|/* SALLSDK_DEBUG */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp:OpCode found 0x%x htag 0x%x\n"
operator|,
name|OpCode
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get agContext */
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|pRequest
condition|)
block|{
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp:pRequest (%p) NULL\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
break|break;
comment|/* ????  */
case|case
name|OPC_INB_SATA_HOST_OPSTART
case|:
case|case
name|OPC_INB_SATA_ABORT
case|:
case|case
name|OPC_INB_SSPINIIOSTART
case|:
case|case
name|OPC_INB_SSPINITMSTART
case|:
case|case
name|OPC_INB_SSPINIEXTIOSTART
case|:
case|case
name|OPC_INB_SSPTGTIOSTART
case|:
case|case
name|OPC_INB_SSPTGTRSPSTART
case|:
case|case
name|OPC_INB_SSP_DIF_ENC_OPSTART
case|:
case|case
name|OPC_INB_SATA_DIF_ENC_OPSTART
case|:
case|case
name|OPC_INB_SSP_ABORT
case|:
case|case
name|OPC_INB_SMP_REQUEST
case|:
case|case
name|OPC_INB_SMP_ABORT
case|:
block|{
comment|/* Uses the tag table, so we have to free it up */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp:OpCode found 0x%x htag 0x%x\n"
operator|,
name|OpCode
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|tag
operator|=
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|1
index|]
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|tag
operator|<
name|AGSA_MAX_VALID_PORTS
operator|*
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
operator|)
argument_list|,
literal|"OPC_OUB_GENERAL_EVENT tag out of range"
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|saRoot
operator|->
name|IOMap
index|[
name|tag
operator|<
operator|(
name|AGSA_MAX_VALID_PORTS
operator|*
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
operator|)
condition|?
name|tag
else|:
literal|0
index|]
operator|.
name|Tag
operator|!=
name|MARK_OFF
operator|)
argument_list|,
literal|"OPC_OUB_GENERAL_EVENT tag not in use 2"
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
if|if
condition|(
name|tag
operator|>
name|AGSA_MAX_VALID_PORTS
operator|*
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"3H"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
endif|#
directive|endif
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|pRequest
condition|)
block|{
name|pDevice
operator|=
name|pRequest
operator|->
name|pDevice
expr_stmt|;
comment|/* return the request to free pool */
comment|/* get IORequestContext */
name|agContext
operator|=
operator|(
name|agsaContext_t
operator|*
operator|)
name|pRequest
operator|->
name|pIORequestContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|pDevice
operator|->
name|pendingIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp:pRequest (%p) NULL\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
block|}
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp:OpCode Not found 0x%x htag 0x%x\n"
operator|,
name|OpCode
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
comment|/* Uses the tag table, so we have to free it up */
name|tag
operator|=
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|1
index|]
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|tag
operator|<
name|AGSA_MAX_VALID_PORTS
operator|*
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
operator|)
argument_list|,
literal|"OPC_OUB_GENERAL_EVENT tag out of range"
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|saRoot
operator|->
name|IOMap
index|[
name|tag
operator|<
operator|(
name|AGSA_MAX_VALID_PORTS
operator|*
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
operator|)
condition|?
name|tag
else|:
literal|0
index|]
operator|.
name|Tag
operator|!=
name|MARK_OFF
operator|)
argument_list|,
literal|"OPC_OUB_GENERAL_EVENT tag not in use 3"
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|SALLSDK_DEBUG
argument_list|)
if|if
condition|(
name|tag
operator|>
name|AGSA_MAX_VALID_PORTS
operator|*
name|saRoot
operator|->
name|swConfig
operator|.
name|maxActiveIOs
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'e'
argument_list|,
literal|"3H"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
endif|#
directive|endif
comment|/* get agContext */
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|pRequest
operator|==
name|agNULL
condition|)
block|{
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'f'
argument_list|,
literal|"3H"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
switch|switch
condition|(
name|OpCode
condition|)
comment|/* OpCode */
block|{
case|case
name|OPC_INB_KEK_MANAGEMENT
case|:
block|{
name|bit32
name|flags
init|=
name|GenEventData
operator|.
name|inbIOMBpayload
index|[
literal|2
index|]
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: OPC_INB_KEK_MANAGEMENT 0x%x htag 0x%x flags 0x%x\n"
operator|,
name|OpCode
operator|,
name|tag
operator|,
name|flags
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
literal|0xFF00
condition|)
comment|/* update and store*/
block|{
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_KEK_UPDATE_AND_STORE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: OSSA_HW_ENCRYPT_KEK_UPDATE_AND_STORE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* update */
block|{
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_KEK_UPDATE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: OSSA_HW_ENCRYPT_KEK_UPDATE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|agEvent
operator|.
name|status
operator|=
name|OSSA_INVALID_ENCRYPTION_SECURITY_MODE
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|agEvent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHWEventEncrypt_t
argument_list|)
argument_list|)
expr_stmt|;
name|agEvent
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: ossaHwCB OSSA_HW_EVENT_ENCRYPTION\n"
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|NULL
argument_list|,
name|OSSA_HW_EVENT_ENCRYPTION
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|agEvent
argument_list|,
name|agContext
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|OPC_INB_OPR_MGMT
case|:
name|si_memset
argument_list|(
operator|&
name|agEvent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHWEventEncrypt_t
argument_list|)
argument_list|)
expr_stmt|;
name|agEvent
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_OPERATOR_MANAGEMENT
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: OSSA_HW_ENCRYPT_OPERATOR_MANAGEMENT\n"
operator|)
argument_list|)
expr_stmt|;
name|ossaOperatorManagementCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC_INB_SET_OPERATOR
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: OSSA_HW_ENCRYPT_SET_OPERATOR\n"
operator|)
argument_list|)
expr_stmt|;
name|ossaSetOperatorCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
literal|0xFF
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC_INB_GET_OPERATOR
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: OSSA_HW_ENCRYPT_GET_OPERATOR\n"
operator|)
argument_list|)
expr_stmt|;
name|ossaGetOperatorCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
literal|0xFF
argument_list|,
literal|0xFF
argument_list|,
literal|0xFF
argument_list|,
literal|0xFF
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPC_INB_ENC_TEST_EXECUTE
case|:
name|si_memset
argument_list|(
operator|&
name|agEvent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHWEventEncrypt_t
argument_list|)
argument_list|)
expr_stmt|;
name|agEvent
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_TEST_EXECUTE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: OSSA_HW_ENCRYPT_TEST_EXECUTE\n"
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|NULL
argument_list|,
name|OSSA_HW_EVENT_ENCRYPTION
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|agEvent
argument_list|,
name|agContext
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGeneralEventRsp: MGMNT OpCode Not found 0x%x\n"
operator|,
name|OpCode
operator|)
argument_list|)
expr_stmt|;
name|ossaGeneralEvent
argument_list|(
name|agRoot
argument_list|,
name|status
argument_list|,
name|agContext
argument_list|,
name|GenEventData
operator|.
name|inbIOMBpayload
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'g'
argument_list|,
literal|"3H"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI SSP Request Received Event (target mode)  *  *  This function handles the SSP Request Received Event.  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pMsg1        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSSPReqReceivedNotify
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSSPReqReceivedNotify_t
modifier|*
name|pMsg1
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|bit32
name|deviceid
decl_stmt|,
name|iniTagSSPIul
decl_stmt|,
name|frameTypeHssa
decl_stmt|,
name|TlrHdsa
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3J"
argument_list|)
expr_stmt|;
comment|/* convert endiness if necassary */
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceid
argument_list|,
name|pMsg1
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPReqReceivedNotify_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|iniTagSSPIul
argument_list|,
name|pMsg1
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPReqReceivedNotify_t
argument_list|,
name|iniTagSSPIul
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|frameTypeHssa
argument_list|,
name|pMsg1
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPReqReceivedNotify_t
argument_list|,
name|frameTypeHssa
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|TlrHdsa
argument_list|,
name|pMsg1
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSSPReqReceivedNotify_t
argument_list|,
name|TlrHdsa
argument_list|)
argument_list|)
expr_stmt|;
comment|/* deviceId -> agDeviceHandle */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceid
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceHandle
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pDevice
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSSPReqReceivedNotify: warning!!! no deviceHandle is found"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* type punning only safe through char *. See gcc -fstrict_aliasing. */
name|char
modifier|*
name|safe_type_pun
init|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|pMsg1
operator|->
name|SSPIu
index|[
literal|0
index|]
operator|)
decl_stmt|;
if|if
condition|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|.
name|sdkData
operator|!=
name|agNULL
condition|)
block|{
name|ossaSSPReqReceived
argument_list|(
name|agRoot
argument_list|,
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
argument_list|,
operator|(
name|agsaFrameHandle_t
operator|*
operator|)
name|safe_type_pun
argument_list|,
call|(
name|bit16
call|)
argument_list|(
operator|(
name|iniTagSSPIul
operator|>>
name|SHIFT16
operator|)
operator|&
name|INITTAG_BITS
argument_list|)
argument_list|,
operator|(
operator|(
name|frameTypeHssa
operator|>>
name|SHIFT24
operator|)
operator|&
name|FRAME_TYPE
operator|)
operator||
operator|(
operator|(
name|TlrHdsa
operator|>>
name|SHIFT16
operator|)
operator|&
name|TLR_BITS
operator|)
argument_list|,
operator|(
name|iniTagSSPIul
operator|&
name|SSPIUL_BITS
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
operator|!=
name|agNULL
condition|)
block|{
name|ossaSSPReqReceived
argument_list|(
name|agRoot
argument_list|,
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
argument_list|,
operator|(
name|agsaFrameHandle_t
operator|*
operator|)
name|safe_type_pun
argument_list|,
call|(
name|bit16
call|)
argument_list|(
operator|(
name|iniTagSSPIul
operator|>>
name|SHIFT16
operator|)
operator|&
name|INITTAG_BITS
argument_list|)
argument_list|,
operator|(
operator|(
name|frameTypeHssa
operator|>>
name|SHIFT24
operator|)
operator|&
name|FRAME_TYPE
operator|)
operator||
operator|(
operator|(
name|TlrHdsa
operator|>>
name|SHIFT16
operator|)
operator|&
name|TLR_BITS
operator|)
argument_list|,
operator|(
name|iniTagSSPIul
operator|&
name|SSPIUL_BITS
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_ASSERT
argument_list|(
literal|0
argument_list|,
literal|"Device handle sdkData not set"
argument_list|)
expr_stmt|;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3J"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI Device Handle Arrived Event (target mode)  *  *  This function handles the Device Handle Arrived Event.  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pMsg1        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiDeviceHandleArrived
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDeviceHandleArrivedNotify_t
modifier|*
name|pMsg1
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|agsaPort_t
modifier|*
name|pPort
decl_stmt|;
name|agsaSASDeviceInfo_t
name|pDeviceInfo
decl_stmt|;
name|agsaPortContext_t
modifier|*
name|agPortContext
decl_stmt|;
name|agsaSASIdentify_t
name|remoteIdentify
decl_stmt|;
name|bit32
name|CTag
decl_stmt|;
name|bit32
name|FwdDeviceId
decl_stmt|;
name|bit32
name|ProtConrPortId
decl_stmt|;
name|bit32
name|portId
decl_stmt|;
name|bit32
name|conRate
decl_stmt|;
name|bit8
name|i
decl_stmt|,
name|protocol
decl_stmt|,
name|dTypeSRate
decl_stmt|;
name|bit32
name|HostAssignedId
decl_stmt|;
if|if
condition|(
name|saRoot
operator|==
name|agNULL
condition|)
block|{
name|SA_ASSERT
argument_list|(
operator|(
name|saRoot
operator|!=
name|agNULL
operator|)
argument_list|,
literal|"saRoot"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3L"
argument_list|)
expr_stmt|;
comment|/* convert endiness if necassary */
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|CTag
argument_list|,
name|pMsg1
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeviceHandleArrivedNotify_t
argument_list|,
name|CTag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|FwdDeviceId
argument_list|,
name|pMsg1
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeviceHandleArrivedNotify_t
argument_list|,
name|HostAssignedIdFwdDeviceId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|ProtConrPortId
argument_list|,
name|pMsg1
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeviceHandleArrivedNotify_t
argument_list|,
name|ProtConrPortId
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|portId
operator|=
name|ProtConrPortId
operator|&
name|PortId_V_MASK
expr_stmt|;
name|conRate
operator|=
operator|(
name|ProtConrPortId
operator|&
name|Conrate_V_MASK
operator|)
operator|>>
name|Conrate_V_SHIFT
expr_stmt|;
name|HostAssignedId
operator|=
operator|(
name|FwdDeviceId
operator|&
literal|0xFFFF0000
operator|)
operator|>>
name|SHIFT16
expr_stmt|;
if|if
condition|(
name|HostAssignedId
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleArrived: HostAssignedId 0x%X\n"
operator|,
name|HostAssignedId
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|portId
operator|=
name|ProtConrPortId
operator|&
name|PortId_SPC_MASK
expr_stmt|;
name|conRate
operator|=
operator|(
name|ProtConrPortId
operator|&
name|Conrate_SPC_MASK
operator|)
operator|>>
name|Conrate_SPC_SHIFT
expr_stmt|;
block|}
name|protocol
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|ProtConrPortId
operator|&
name|PROTOCOL_BITS
operator|)
operator|>>
name|PROTOCOL_SHIFT
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleArrived: New Port portID %d deviceid 0x%X conRate 0x%X protocol 0x%X\n"
operator|,
name|portId
operator|,
name|FwdDeviceId
operator|,
name|conRate
operator|,
name|protocol
operator|)
argument_list|)
expr_stmt|;
comment|/* Port Map */
name|agPortContext
operator|=
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortContext
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|agPortContext
condition|)
block|{
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_PORT_LOCK
argument_list|)
expr_stmt|;
comment|/* new port */
comment|/* Acquire port list lock */
comment|/* Allocate a free port */
name|pPort
operator|=
operator|(
name|agsaPort_t
operator|*
operator|)
name|saLlistGetHead
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freePorts
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|pPort
condition|)
block|{
name|saLlistRemove
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freePorts
operator|)
argument_list|,
operator|&
operator|(
name|pPort
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
comment|/* setup the port data structure */
name|pPort
operator|->
name|portContext
operator|.
name|osData
operator|=
name|agNULL
expr_stmt|;
name|pPort
operator|->
name|portContext
operator|.
name|sdkData
operator|=
name|pPort
expr_stmt|;
name|pPort
operator|->
name|tobedeleted
operator|=
name|agFALSE
expr_stmt|;
comment|/* Add to valid port list */
name|saLlistAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|validPorts
operator|)
argument_list|,
operator|&
operator|(
name|pPort
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
comment|/* Release port list lock */
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_PORT_LOCK
argument_list|)
expr_stmt|;
comment|/* Setup portMap based on portId */
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortID
operator|=
name|portId
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortContext
operator|=
operator|&
operator|(
name|pPort
operator|->
name|portContext
operator|)
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|portId
index|]
operator|.
name|PortStatus
operator|&=
operator|~
name|PORT_INVALIDATING
expr_stmt|;
name|pPort
operator|->
name|portId
operator|=
name|portId
expr_stmt|;
name|pPort
operator|->
name|status
operator|&=
operator|~
name|PORT_INVALIDATING
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiDeviceHandleArrived: ~PORT_INVALIDATING New Port portID %d PortContext %p\n"
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|pPort
operator|->
name|portId
index|]
operator|.
name|PortID
operator|,
operator|&
name|pPort
operator|->
name|portContext
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_PORT_LOCK
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiDeviceHandleArrived:Port NULL\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* pPort is agNULL*/
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3L"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
block|}
else|else
block|{
comment|/* exist port */
name|pPort
operator|=
operator|(
name|agsaPort_t
operator|*
operator|)
operator|(
name|agPortContext
operator|->
name|sdkData
operator|)
expr_stmt|;
name|pPort
operator|->
name|status
operator|&=
operator|~
name|PORT_INVALIDATING
expr_stmt|;
name|pPort
operator|->
name|portId
operator|=
name|portId
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|pPort
operator|->
name|portId
index|]
operator|.
name|PortStatus
operator|&=
operator|~
name|PORT_INVALIDATING
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleArrived: ~PORT_INVALIDATING Old port portID %d PortContext %p\n"
operator|,
name|portId
operator|,
operator|&
name|pPort
operator|->
name|portContext
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* build Device Information structure */
name|si_memset
argument_list|(
operator|&
name|pDeviceInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASDeviceInfo_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ProtConrPortId
operator|&
name|PROTOCOL_BITS
condition|)
block|{
name|protocol
operator|=
name|SA_IDFRM_SSP_BIT
expr_stmt|;
comment|/* SSP */
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|=
call|(
name|bit8
call|)
argument_list|(
name|conRate
operator||
literal|0x10
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|protocol
operator|=
name|SA_IDFRM_SMP_BIT
expr_stmt|;
comment|/* SMP */
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|=
operator|(
name|bit8
operator|)
name|conRate
expr_stmt|;
block|}
name|pDeviceInfo
operator|.
name|initiator_ssp_stp_smp
operator|=
name|protocol
expr_stmt|;
name|pDeviceInfo
operator|.
name|numOfPhys
operator|=
literal|1
expr_stmt|;
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|0
index|]
operator|=
name|pMsg1
operator|->
name|sasAddrHi
index|[
literal|0
index|]
expr_stmt|;
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|1
index|]
operator|=
name|pMsg1
operator|->
name|sasAddrHi
index|[
literal|1
index|]
expr_stmt|;
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|2
index|]
operator|=
name|pMsg1
operator|->
name|sasAddrHi
index|[
literal|2
index|]
expr_stmt|;
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|3
index|]
operator|=
name|pMsg1
operator|->
name|sasAddrHi
index|[
literal|3
index|]
expr_stmt|;
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|0
index|]
operator|=
name|pMsg1
operator|->
name|sasAddrLow
index|[
literal|0
index|]
expr_stmt|;
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|1
index|]
operator|=
name|pMsg1
operator|->
name|sasAddrLow
index|[
literal|1
index|]
expr_stmt|;
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|2
index|]
operator|=
name|pMsg1
operator|->
name|sasAddrLow
index|[
literal|2
index|]
expr_stmt|;
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|3
index|]
operator|=
name|pMsg1
operator|->
name|sasAddrLow
index|[
literal|3
index|]
expr_stmt|;
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|flag
operator|=
literal|0
expr_stmt|;
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|it_NexusTimeout
operator|=
name|ITL_TO_DEFAULT
expr_stmt|;
comment|/* deviceId -> agDeviceHandle */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|FwdDeviceId
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceHandle
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pDevice
condition|)
block|{
comment|/* new device */
name|si_memset
argument_list|(
operator|&
name|remoteIdentify
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASIdentify_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|remoteIdentify
operator|.
name|sasAddressHi
index|[
name|i
index|]
operator|=
name|pMsg1
operator|->
name|sasAddrHi
index|[
name|i
index|]
expr_stmt|;
name|remoteIdentify
operator|.
name|sasAddressLo
index|[
name|i
index|]
operator|=
name|pMsg1
operator|->
name|sasAddrLow
index|[
name|i
index|]
expr_stmt|;
block|}
name|remoteIdentify
operator|.
name|deviceType_addressFrameType
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xC0
argument_list|)
expr_stmt|;
name|dTypeSRate
operator|=
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
expr_stmt|;
comment|/* get Device from free Device List */
name|pDevice
operator|=
name|siPortSASDeviceAdd
argument_list|(
name|agRoot
argument_list|,
name|pPort
argument_list|,
name|remoteIdentify
argument_list|,
name|agTRUE
argument_list|,
name|SMP_TO_DEFAULT
argument_list|,
name|ITL_TO_DEFAULT
argument_list|,
literal|0
argument_list|,
name|dTypeSRate
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pDevice
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleArrived: Device Handle is NULL, Out of Resources Error.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bit32
name|AccStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|SaveId
init|=
name|FwdDeviceId
operator|&
literal|0xFFFF
decl_stmt|;
comment|/* mapping the device handle and device id */
name|saRoot
operator|->
name|DeviceMap
index|[
name|FwdDeviceId
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceIdFromFW
operator|=
name|FwdDeviceId
expr_stmt|;
name|saRoot
operator|->
name|DeviceMap
index|[
name|FwdDeviceId
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceHandle
operator|=
operator|(
name|void
operator|*
operator|)
name|pDevice
expr_stmt|;
name|pDevice
operator|->
name|DeviceMapIndex
operator|=
name|FwdDeviceId
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiDeviceHandleArrived: New deviceID 0x%x Device Context %p DeviceTypeSRate 0x%x\n"
operator|,
name|FwdDeviceId
operator|,
name|pDevice
operator|,
name|dTypeSRate
operator|)
argument_list|)
expr_stmt|;
comment|/* Call Back */
name|AccStatus
operator|=
name|ossaDeviceHandleAccept
argument_list|(
name|agRoot
argument_list|,
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
argument_list|,
operator|&
name|pDeviceInfo
argument_list|,
name|agPortContext
argument_list|,
operator|&
name|FwdDeviceId
argument_list|)
expr_stmt|;
name|HostAssignedId
operator|=
operator|(
name|FwdDeviceId
operator|&
literal|0xFFFF0000
operator|)
operator|>>
name|SHIFT16
expr_stmt|;
if|if
condition|(
name|HostAssignedId
condition|)
block|{
if|if
condition|(
name|SaveId
operator|==
operator|(
name|FwdDeviceId
operator|&
literal|0xFFFF
operator|)
condition|)
block|{
name|saRoot
operator|->
name|DeviceMap
index|[
name|FwdDeviceId
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceIdFromFW
operator|=
name|FwdDeviceId
expr_stmt|;
name|pDevice
operator|->
name|DeviceMapIndex
operator|=
name|FwdDeviceId
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleArrived:FwdDeviceId 0x%x HostAssignedId 0x%x\n"
operator|,
name|FwdDeviceId
operator|,
name|HostAssignedId
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleArrived:Id mangled expect 0x%x Got 0x%x\n"
operator|,
name|SaveId
operator|,
operator|(
name|FwdDeviceId
operator|&
literal|0xFFFF
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
block|}
comment|/* get AWT flag and ITLN_TMO value */
if|if
condition|(
name|AccStatus
operator|==
name|OSSA_RC_ACCEPT
condition|)
block|{
comment|/* build DEVICE_HANDLE_ACCEPT IOMB and send to SPC with action=accept */
name|mpiDevHandleAcceptCmd
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|CTag
argument_list|,
name|FwdDeviceId
argument_list|,
literal|0
argument_list|,
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|flag
argument_list|,
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|it_NexusTimeout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mpiDevHandleAcceptCmd
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|CTag
argument_list|,
name|FwdDeviceId
argument_list|,
literal|1
argument_list|,
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|flag
argument_list|,
name|pDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|it_NexusTimeout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleArrived Device 0x%08X flag 0x%08X %s WWID= %02x%02x%02x%02x:%02x%02x%02x%02x, %s\n"
operator|,
name|FwdDeviceId
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|flag
operator|,
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator|==
literal|0x20
condition|?
literal|"SATA DA"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator|==
literal|0x10
condition|?
literal|"SSP/SMP"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator|==
literal|0x0
condition|?
literal|"  STP  "
else|:
literal|"Unknown"
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|3
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|2
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|1
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressHi
index|[
literal|0
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|3
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|2
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|1
index|]
operator|,
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|sasAddressLo
index|[
literal|0
index|]
operator|,
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|8
condition|?
literal|" 1.5G"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|9
condition|?
literal|" 3.0G"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|10
condition|?
literal|" 6.0G"
else|:
operator|(
name|pDevice
operator|->
name|devInfo
operator|.
name|sasDeviceInfo
operator|.
name|commonDevInfo
operator|.
name|devType_S_Rate
operator|&
literal|0xF
operator|)
operator|==
literal|11
condition|?
literal|"12.0G"
else|:
literal|"????"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3L"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Get Time Stamp Response  *  *  This routine handles the response of Get Time Stamp Command  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetTimeStampRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGetTimeStampRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|timeStampLower
decl_stmt|,
name|timeStampUpper
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3M"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetTimeStampRsp: HTAG=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetTimeStampRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|timeStampLower
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetTimeStampRsp_t
argument_list|,
name|timeStampLower
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|timeStampUpper
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetTimeStampRsp_t
argument_list|,
name|timeStampUpper
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetTimeStampRsp: Bad Response IOMB!!! pRequest is NULL.TAG=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3M"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetTimeStampRsp: timeStampLower 0x%x timeStampUpper 0x%x\n"
operator|,
name|timeStampLower
operator|,
name|timeStampUpper
operator|)
argument_list|)
expr_stmt|;
name|ossaGetTimeStampCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|timeStampLower
argument_list|,
name|timeStampUpper
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetTimeStampRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3M"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAS HW Event Ack Response  *  *  This routine handles the response of SAS HW Event Ack Command  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSASHwEventAckRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSASHwEventAckRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaPort_t
modifier|*
name|pPort
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|status
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2N"
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSASHwEventAckRsp: Htag=0x%x %p\n"
operator|,
name|pIomb
operator|->
name|tag
operator|,
name|pIomb
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSASHwEventAckRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSASHwEventAckRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASHwEventAckRsp: Bad Response IOMB!!! pRequest is NULL.TAG=0x%x Status=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2N"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASHwEventAckRsp: status 0x%x Htag=0x%x HwAckType=0x%x\n"
operator|,
name|status
operator|,
name|pIomb
operator|->
name|tag
operator|,
name|pRequest
operator|->
name|HwAckType
operator|)
argument_list|)
expr_stmt|;
name|ossaHwEventAckCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|pPort
operator|=
name|pRequest
operator|->
name|pPort
expr_stmt|;
if|if
condition|(
name|agNULL
operator|!=
name|pPort
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASHwEventAckRsp: pPort %p tobedeleted %d\n"
operator|,
name|pPort
operator|,
name|pPort
operator|->
name|tobedeleted
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pPort
operator|->
name|status
operator|&
name|PORT_INVALIDATING
operator|&&
name|pPort
operator|->
name|tobedeleted
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASHwEventAckRsp: PORT_INVALIDATING portInvalid portID %d pPort %p, nulling out PortContext\n"
operator|,
name|pPort
operator|->
name|portId
operator|,
name|pPort
operator|)
argument_list|)
expr_stmt|;
comment|/* invalid the port */
name|siPortInvalid
argument_list|(
name|agRoot
argument_list|,
name|pPort
argument_list|)
expr_stmt|;
comment|/* map out the portmap */
name|saRoot
operator|->
name|PortMap
index|[
name|pPort
operator|->
name|portId
index|]
operator|.
name|PortContext
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|pPort
operator|->
name|portId
index|]
operator|.
name|PortID
operator|=
name|PORT_MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|PortMap
index|[
name|pPort
operator|->
name|portId
index|]
operator|.
name|PortStatus
operator||=
name|PORT_INVALIDATING
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASHwEventAckRsp:pPort->status 0x%x Htag=0x%x %p\n"
operator|,
name|pPort
operator|->
name|status
operator|,
name|pIomb
operator|->
name|tag
operator|,
name|pIomb
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASHwEventAckRsp: pPort is NULL, no portId, HTag=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSASHwEventAckRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2N"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Port Control Response  *  *  This routine handles the response of SAS HW Event Ack Command  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiPortControlRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaPortControlRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
init|=
name|agNULL
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
init|=
name|agNULL
decl_stmt|;
name|agsaPortContext_t
modifier|*
name|agPortContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|tag
decl_stmt|;
name|bit32
name|port
init|=
literal|0
decl_stmt|;
name|bit32
name|operation
init|=
literal|0
decl_stmt|;
name|bit32
name|status
init|=
literal|0
decl_stmt|;
name|bit32
name|portState
init|=
literal|0
decl_stmt|;
name|bit32
name|portOperation
init|=
literal|0
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3O"
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiPortControlRsp: HTag=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPortControlRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|operation
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPortControlRsp_t
argument_list|,
name|portOPPortId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPortControlRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|portState
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPortControlRsp_t
argument_list|,
name|rsvdPortState
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: Bad Response IOMB!!! pRequest is NULL.TAG=0x%x Status=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3O"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pRequest
operator|->
name|valid
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: pRequest->valid %d not set\n"
operator|,
name|pRequest
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiPortControlRsp: pRequest->completionCB %p\n"
operator|,
name|pRequest
operator|->
name|completionCB
operator|)
argument_list|)
expr_stmt|;
name|port
operator|=
name|operation
operator|&
name|PORTID_MASK
expr_stmt|;
if|if
condition|(
name|port
operator|<
name|AGSA_MAX_VALID_PORTS
condition|)
block|{
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiPortControlRsp: PortID 0x%x PortStatus 0x%x PortContext %p\n"
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|port
index|]
operator|.
name|PortID
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|port
index|]
operator|.
name|PortStatus
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|port
index|]
operator|.
name|PortContext
operator|)
argument_list|)
expr_stmt|;
name|agPortContext
operator|=
operator|(
name|agsaPortContext_t
operator|*
operator|)
name|saRoot
operator|->
name|PortMap
index|[
name|port
index|]
operator|.
name|PortContext
expr_stmt|;
block|}
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiPortControlRsp: PortID 0x%x PortStatus 0x%x PortContext %p\n"
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|operation
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortID
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|operation
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortStatus
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|operation
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortContext
operator|)
argument_list|)
expr_stmt|;
name|agPortContext
operator|=
operator|(
name|agsaPortContext_t
operator|*
operator|)
name|saRoot
operator|->
name|PortMap
index|[
name|operation
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortContext
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: agPortContext %p\n"
operator|,
name|agPortContext
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiPortControlRsp: portID 0x%x status 0x%x\n"
operator|,
operator|(
name|operation
operator|&
name|PORTID_MASK
operator|)
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: portID 0x%x status 0x%x agPortContext %p\n"
operator|,
name|port
operator|,
name|status
operator|,
name|agPortContext
operator|)
argument_list|)
expr_stmt|;
name|portOperation
operator|=
operator|(
operator|(
operator|(
name|operation
operator|&
name|LOCAL_PHY_OP_BITS
operator|)
operator|>>
name|SHIFT8
operator|)
operator||
operator|(
name|portState
operator|<<
name|SHIFT28
operator|)
operator|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: portState 0x%x operation 0x%x portOperation 0x%x\n"
operator|,
name|portState
operator|,
name|operation
operator|,
name|portOperation
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|portOperation
condition|)
block|{
case|case
name|AGSA_PORT_SET_SMP_PHY_WIDTH
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: AGSA_PORT_SET_SMP_PHY_WIDTH  operation 0x%x\n"
operator|,
name|operation
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_PORT_SET_PORT_RECOVERY_TIME
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: AGSA_PORT_SET_PORT_RECOVERY_TIME  operation 0x%x\n"
operator|,
name|operation
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_PORT_IO_ABORT
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: AGSA_PORT_IO_ABORT  operation 0x%x\n"
operator|,
name|operation
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_PORT_SET_PORT_RESET_TIME
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: AGSA_PORT_SET_PORT_RESET_TIME  operation 0x%x\n"
operator|,
name|operation
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_PORT_HARD_RESET
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: AGSA_PORT_HARD_RESET  operation 0x%x\n"
operator|,
name|operation
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_PORT_CLEAN_UP
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: AGSA_PORT_CLEAN_UP  operation 0x%x\n"
operator|,
name|operation
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_STOP_PORT_RECOVERY_TIMER
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: AGSA_STOP_PORT_RECOVERY_TIMER  operation 0x%x\n"
operator|,
name|operation
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: Unknown  operation 0x%x\n"
operator|,
name|operation
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ossaPortControlCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agPortContext
argument_list|,
name|portOperation
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPortControlRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3O"
argument_list|)
expr_stmt|;
comment|/* return value */
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI SMP ABORT Response  *  *  This function handles the SMP Abort Response.  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSMPAbortRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSMPAbortRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|scp
decl_stmt|,
name|status
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3P"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSMPAbortRsp: HTag=0x%x Status=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|,
name|pIomb
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSMPAbortRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSMPAbortRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|scp
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSMPAbortRsp_t
argument_list|,
name|scp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get IORequest from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPAbortRsp: pRequest is NULL, HTag=0x%x Status=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|,
name|pIomb
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|)
argument_list|,
literal|"pRequest"
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3P"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agTRUE
operator|==
name|pRequest
operator|->
name|valid
condition|)
block|{
name|pDevice
operator|=
name|pRequest
operator|->
name|pDevice
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|pDevice
operator|)
argument_list|,
literal|"pRequest->pDevice"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSMPAbortRsp: request abort is valid Htag 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* remove the SSP_ABORT or SATA_ABORT request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPAbortRsp: ************************************************* Valid for Expander only tag 0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|ossaSMPAbortCB
argument_list|(
name|agRoot
argument_list|,
name|pRequest
operator|->
name|pIORequestContext
argument_list|,
name|scp
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaGenericAbortCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|pRequest
operator|->
name|pIORequestContext
operator|,
name|scp
operator|,
name|status
operator|)
expr_stmt|;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* Delete the request from the pendingIORequests */
name|saLlistIORemove
argument_list|(
operator|&
operator|(
name|pDevice
operator|->
name|pendingIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPAbortRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSMPAbortRsp: the request is not valid any more. Tag=%x\n"
operator|,
name|pRequest
operator|->
name|HTag
operator|)
argument_list|)
expr_stmt|;
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3P"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SPC MPI Device Handle Arrived Event (target mode)  *  *  This function handles the Device Handle Arrived Event.  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pMsg1        pointer of Message  *  *  \return The read value  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiDeviceHandleRemoval
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDeviceHandleRemoval_t
modifier|*
name|pMsg1
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|agsaPortContext_t
modifier|*
name|agPortContext
decl_stmt|;
name|bit32
name|portId
decl_stmt|;
name|bit32
name|deviceid
decl_stmt|,
name|deviceIdx
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3R"
argument_list|)
expr_stmt|;
comment|/* convert endiness if necassary */
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|portId
argument_list|,
name|pMsg1
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeviceHandleRemoval_t
argument_list|,
name|portId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceid
argument_list|,
name|pMsg1
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDeviceHandleRemoval_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiDeviceHandleRemoval: portId=0x%x deviceId=0x%x\n"
operator|,
name|portId
operator|,
name|deviceid
operator|)
argument_list|)
expr_stmt|;
name|pDevice
operator|=
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceid
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceHandle
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiDeviceHandleRemoval:PortID 0x%x PortStatus 0x%x PortContext %p\n"
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortID
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortStatus
operator|,
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortContext
operator|)
argument_list|)
expr_stmt|;
name|agPortContext
operator|=
operator|(
name|agsaPortContext_t
operator|*
operator|)
name|saRoot
operator|->
name|PortMap
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|.
name|PortContext
expr_stmt|;
comment|/* Call Back */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleRemoval: portId=0x%x deviceId=0x%x autoDeregDeviceflag=0x%x\n"
operator|,
name|portId
operator|,
name|deviceid
operator|,
name|saRoot
operator|->
name|autoDeregDeviceflag
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
condition|)
block|{
name|ossaDeviceHandleRemovedEvent
argument_list|(
name|agRoot
argument_list|,
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
argument_list|,
name|agPortContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|->
name|autoDeregDeviceflag
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
condition|)
block|{
comment|/* remove the DeviceMap and MapIndex */
name|deviceIdx
operator|=
name|pDevice
operator|->
name|DeviceMapIndex
operator|&
name|DEVICE_ID_BITS
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleRemoval: A  Freed portId=0x%x deviceId=0x%x\n"
operator|,
name|portId
operator|,
name|deviceid
operator|)
argument_list|)
expr_stmt|;
name|OS_ASSERT
argument_list|(
name|deviceIdx
operator|<
name|MAX_IO_DEVICE_ENTRIES
argument_list|,
literal|"deviceIdx MAX_IO_DEVICE_ENTRIES"
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceIdx
index|]
operator|.
name|DeviceIdFromFW
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceIdx
index|]
operator|.
name|DeviceHandle
operator|=
name|agNULL
expr_stmt|;
name|pDevice
operator|->
name|DeviceMapIndex
operator|=
literal|0
expr_stmt|;
comment|/* Reset the device data structure */
name|pDevice
operator|->
name|pPort
operator|=
name|agNULL
expr_stmt|;
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|osData
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|saLlistAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeDevicesList
operator|)
argument_list|,
operator|&
operator|(
name|pDevice
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleRemoval: portId=0x%x deviceId=0x%x\n"
operator|,
name|portId
operator|,
name|deviceid
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|.
name|sdkData
condition|)
block|{
name|ossaDeviceHandleRemovedEvent
argument_list|(
name|agRoot
argument_list|,
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
argument_list|,
name|agPortContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|saRoot
operator|->
name|autoDeregDeviceflag
index|[
name|portId
operator|&
name|PORTID_MASK
index|]
condition|)
block|{
comment|/* remove the DeviceMap and MapIndex */
name|deviceIdx
operator|=
name|pDevice
operator|->
name|DeviceMapIndex
operator|&
name|DEVICE_ID_BITS
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleRemoval: A  Freed portId=0x%x deviceId=0x%x\n"
operator|,
name|portId
operator|,
name|deviceid
operator|)
argument_list|)
expr_stmt|;
name|OS_ASSERT
argument_list|(
name|deviceIdx
operator|<
name|MAX_IO_DEVICE_ENTRIES
argument_list|,
literal|"deviceIdx MAX_IO_DEVICE_ENTRIES"
argument_list|)
expr_stmt|;
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceIdx
index|]
operator|.
name|DeviceIdFromFW
operator|=
literal|0
expr_stmt|;
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceIdx
index|]
operator|.
name|DeviceHandle
operator|=
name|agNULL
expr_stmt|;
name|pDevice
operator|->
name|DeviceMapIndex
operator|=
literal|0
expr_stmt|;
comment|/* Reset the device data structure */
name|pDevice
operator|->
name|pPort
operator|=
name|agNULL
expr_stmt|;
name|pDevice
operator|->
name|initiatorDevHandle
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|pDevice
operator|->
name|initiatorDevHandle
operator|.
name|osData
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|saLlistAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeDevicesList
operator|)
argument_list|,
operator|&
operator|(
name|pDevice
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* no callback because bad device_id */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDeviceHandleRemoval: Bad Device Handle, deviceId=0x%x\n"
operator|,
name|deviceid
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3R"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Set Device State Response  *  *  This routine handles the response of SET Device State Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSetDeviceStateRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSetDeviceStateRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|status
decl_stmt|,
name|deviceState
decl_stmt|,
name|deviceId
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3Q"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDeviceStateRsp: HTag=0x%x, deviceId=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|,
name|pIomb
operator|->
name|deviceId
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetDeviceStateRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetDeviceStateRsp_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetDeviceStateRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDeviceStateRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3Q"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
comment|/* status is SUCCESS */
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceState
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetDeviceStateRsp_t
argument_list|,
name|pds_nds
argument_list|)
argument_list|)
expr_stmt|;
comment|/* find device handle from device index */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceId
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceHandle
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pDevice
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDeviceStateRsp: DeviceHandle is NULL!!! deviceId=0x%x TAG=0x%x STATUS=0x%x \n"
operator|,
name|deviceId
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3Q"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
condition|)
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
expr_stmt|;
block|}
else|else
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDeviceStateRsp: warning!!! no deviceHandle is found"
operator|)
argument_list|)
expr_stmt|;
name|ossaSetDeviceStateCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|,
name|OSSA_IO_NO_DEVICE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"3Q"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDeviceStateRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|ossaSetDeviceStateCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agDevHandle
argument_list|,
name|status
argument_list|,
operator|(
name|deviceState
operator|&
name|NDS_BITS
operator|)
argument_list|,
operator|(
name|deviceState
operator|&
name|PDS_BITS
operator|)
operator|>>
name|SHIFT4
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetDeviceStateRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"3Q"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Get Device State Response  *  *  This routine handles the response of GET Device State Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetDeviceStateRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGetDeviceStateRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|agsaDeviceDesc_t
modifier|*
name|pDevice
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|status
decl_stmt|,
name|deviceId
decl_stmt|,
name|deviceState
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3W"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDeviceStateRsp: HTag=0x%x, deviceId=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|,
name|pIomb
operator|->
name|deviceId
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDeviceStateRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceId
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDeviceStateRsp_t
argument_list|,
name|deviceId
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDeviceStateRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDeviceStateRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3W"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
comment|/* status is SUCCESS */
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|deviceState
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDeviceStateRsp_t
argument_list|,
name|ds
argument_list|)
argument_list|)
expr_stmt|;
comment|/* find device handle from device index */
name|pDevice
operator|=
operator|(
name|agsaDeviceDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|DeviceMap
index|[
name|deviceId
operator|&
name|DEVICE_ID_BITS
index|]
operator|.
name|DeviceHandle
expr_stmt|;
if|if
condition|(
name|pDevice
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|pDevice
operator|->
name|targetDevHandle
operator|.
name|sdkData
condition|)
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|targetDevHandle
operator|)
expr_stmt|;
block|}
else|else
block|{
name|agDevHandle
operator|=
operator|&
operator|(
name|pDevice
operator|->
name|initiatorDevHandle
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDeviceStateRsp: pDevice is NULL"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3W"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDeviceStateRsp: warning!!! no deviceHandle is found"
operator|)
argument_list|)
expr_stmt|;
name|ossaGetDeviceStateCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agNULL
argument_list|,
name|OSSA_IO_NO_DEVICE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"3W"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDeviceStateRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|ossaGetDeviceStateCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|agDevHandle
argument_list|,
name|status
argument_list|,
name|deviceState
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDeviceStateRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"3W"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAS ReInitialize Response  *  *  This routine handles the response of SAS Reinitialize Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSasReInitializeRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSasReInitializeRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaSASReconfig_t
name|SASReconfig
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|status
decl_stmt|,
name|setFlags
decl_stmt|,
name|MaxPorts
decl_stmt|;
name|bit32
name|openRejReCmdData
decl_stmt|,
name|sataHOLTMO
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3X"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSasReInitializeRsp: HTag=0x%x, status=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|,
name|pIomb
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSasReInitializeRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSasReInitializeRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|setFlags
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSasReInitializeRsp_t
argument_list|,
name|setFlags
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|MaxPorts
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSasReInitializeRsp_t
argument_list|,
name|MaxPorts
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|openRejReCmdData
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSasReInitializeRsp_t
argument_list|,
name|openRejReCmdData
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|sataHOLTMO
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSasReInitializeRsp_t
argument_list|,
name|sataHOLTMO
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSasReInitializeRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3X"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|SASReconfig
operator|.
name|flags
operator|=
name|setFlags
expr_stmt|;
name|SASReconfig
operator|.
name|maxPorts
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MaxPorts
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|SASReconfig
operator|.
name|openRejectRetriesCmd
operator|=
call|(
name|bit16
call|)
argument_list|(
operator|(
name|openRejReCmdData
operator|&
literal|0xFFFF0000
operator|)
operator|>>
name|SHIFT16
argument_list|)
expr_stmt|;
name|SASReconfig
operator|.
name|openRejectRetriesData
operator|=
call|(
name|bit16
call|)
argument_list|(
name|openRejReCmdData
operator|&
literal|0x0000FFFF
argument_list|)
expr_stmt|;
name|SASReconfig
operator|.
name|sataHolTmo
operator|=
call|(
name|bit16
call|)
argument_list|(
name|sataHOLTMO
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
name|ossaReconfigSASParamsCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
operator|&
name|SASReconfig
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSasReInitializeRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3X"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief serial GPIO Response  *  *  This routine handles the response of serial GPIO Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSGpioRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSGpioRsp_t
modifier|*
name|pInIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
init|=
name|NULL
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
init|=
name|NULL
decl_stmt|;
name|bit32
name|i
decl_stmt|,
name|tag
decl_stmt|,
name|resultFunctionFrameType
decl_stmt|;
name|agsaSGpioReqResponse_t
name|SgpioResponse
init|=
block|{
literal|0
block|}
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3Y"
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiSGpioRsp: HTAG=0x%x\n"
operator|,
name|pInIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pInIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSGpioRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|resultFunctionFrameType
argument_list|,
name|pInIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSGpioRsp_t
argument_list|,
name|resultFunctionFrameType
argument_list|)
argument_list|)
expr_stmt|;
name|SgpioResponse
operator|.
name|smpFrameType
operator|=
name|resultFunctionFrameType
operator|&
literal|0xFF
expr_stmt|;
name|SgpioResponse
operator|.
name|function
operator|=
operator|(
name|resultFunctionFrameType
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
expr_stmt|;
name|SgpioResponse
operator|.
name|functionResult
operator|=
operator|(
name|resultFunctionFrameType
operator|&
literal|0xFF0000
operator|)
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|SA_SAS_SMP_READ_GPIO_REGISTER
operator|==
name|SgpioResponse
operator|.
name|function
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OSSA_SGPIO_MAX_READ_DATA_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|SgpioResponse
operator|.
name|readWriteData
index|[
name|i
index|]
argument_list|,
name|pInIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSGpioRsp_t
argument_list|,
name|readData
argument_list|)
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Get the request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSGpioRsp: Bad Response IOMB!!! pRequest is NULL.TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|SgpioResponse
operator|.
name|functionResult
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3Y"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AGSA_RC_FAILURE
expr_stmt|;
block|}
else|else
block|{
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
name|ossaSGpioCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
operator|&
name|SgpioResponse
argument_list|)
expr_stmt|;
comment|/* Return the request to free pool */
name|saReturnRequestToFreePool
argument_list|(
name|agRoot
argument_list|,
name|pRequest
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3Y"
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief PCIE Diagnostics Response  *  *  This routine handles the response of PCIE Diagnostics Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiPCIeDiagExecuteRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|void
modifier|*
name|pInIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
name|agNULL
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|Status
decl_stmt|,
name|Command
decl_stmt|;
name|agsaPCIeDiagResponse_t
name|pciediadrsp
decl_stmt|;
name|bit32
modifier|*
name|pIomb
init|=
operator|(
name|bit32
operator|*
operator|)
name|pInIomb
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3Z"
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|saRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|pciediadrsp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaPCIeDiagResponse_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPCIeDiagExecuteRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Command
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPCIeDiagExecuteRsp_t
argument_list|,
name|CmdTypeDesc
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPCIeDiagExecuteRsp_t
argument_list|,
name|Status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|pciediadrsp
operator|.
name|ERR_BLKH
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPCIeDiagExecuteRsp_t
argument_list|,
name|ERR_BLKH
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|pciediadrsp
operator|.
name|ERR_BLKL
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPCIeDiagExecuteRsp_t
argument_list|,
name|ERR_BLKL
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|pciediadrsp
operator|.
name|DWord8
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPCIeDiagExecuteRsp_t
argument_list|,
name|DWord8
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|pciediadrsp
operator|.
name|DWord9
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPCIeDiagExecuteRsp_t
argument_list|,
name|DWord9
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|pciediadrsp
operator|.
name|DWord10
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPCIeDiagExecuteRsp_t
argument_list|,
name|DWord10
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|pciediadrsp
operator|.
name|DWord11
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPCIeDiagExecuteRsp_t
argument_list|,
name|DWord11
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|pciediadrsp
operator|.
name|DIF_ERR
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaPCIeDiagExecuteRsp_t
argument_list|,
name|DIF_ERR
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: HTAG=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsa_SPC_PCIeDiagExecuteRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Command
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsa_SPC_PCIeDiagExecuteRsp_t
argument_list|,
name|CmdTypeDesc
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsa_SPC_PCIeDiagExecuteRsp_t
argument_list|,
name|Status
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: SPC HTAG=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|Status
condition|)
block|{
case|case
name|OSSA_PCIE_DIAG_SUCCESS
case|:
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_SUCCESS TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_INVALID_LENGTH
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_IO_INVALID_LENGTH TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_INVALID_COMMAND
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_INVALID_COMMAND TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_INTERNAL_FAILURE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_INTERNAL_FAILURE TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_INVALID_CMD_TYPE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_INVALID_CMD_TYPE TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_INVALID_CMD_DESC
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_INVALID_CMD_DESC TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_IO_XFR_ERROR_DIF_CRC_MISMATCH TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_INVALID_PCIE_ADDR
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_INVALID_PCIE_ADDR TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_INVALID_BLOCK_SIZE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_INVALID_BLOCK_SIZE TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_LENGTH_NOT_BLOCK_SIZE_ALIGNED
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_LENGTH_NOT_BLOCK_SIZE_ALIGNED TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_IO_XFR_ERROR_DIF_MISMATCH
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_IO_XFR_ERROR_DIF_MISMATCH TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_PCIE_DIAG_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: OSSA_PCIE_DIAG_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp:  UNKNOWN status TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: Bad Response IOMB!!! pRequest is NULL.TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|Status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3Z"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|ossaPCIeDiagExecuteCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|Status
argument_list|,
name|Command
argument_list|,
operator|&
name|pciediadrsp
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiPCIeDiagExecuteRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3Z"
argument_list|)
expr_stmt|;
comment|/* return value */
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Get DFE Data command Response  *  *  This routine handles the response of Get DFE Data command Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetDFEDataRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|void
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
name|agNULL
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
init|=
literal|0
decl_stmt|,
name|status
init|=
literal|0
decl_stmt|,
name|In_Ln
init|=
literal|0
decl_stmt|,
name|MCNT
init|=
literal|0
decl_stmt|,
name|NBT
init|=
literal|0
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2Y"
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|saRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPCV
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDDEFDataRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDDEFDataRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|In_Ln
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDDEFDataRsp_t
argument_list|,
name|reserved_In_Ln
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|MCNT
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDDEFDataRsp_t
argument_list|,
name|MCNT
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|NBT
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetDDEFDataRsp_t
argument_list|,
name|NBT
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SPC does not support this command */
block|}
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|OSSA_DFE_MPI_IO_SUCCESS
case|:
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetDFEDataRsp: OSSA_DFE_MPI_IO_SUCCESS TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DFE_DATA_OVERFLOW
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDFEDataRsp: OSSA_DFE_DATA_OVERFLOW TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DFE_MPI_ERR_RESOURCE_UNAVAILABLE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDFEDataRsp: OSSA_DFE_MPI_ERR_RESOURCE_UNAVAILABLE TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DFE_CHANNEL_DOWN
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDFEDataRsp: OSSA_DFE_CHANNEL_DOWN TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DFE_MEASUREMENT_IN_PROGRESS
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDFEDataRsp: OSSA_DFE_MEASUREMENT_IN_PROGRESS TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DFE_CHANNEL_INVALID
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDFEDataRsp: OSSA_DFE_CHANNEL_INVALID TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_DFE_DMA_FAILURE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDFEDataRsp: OSSA_DFE_DMA_FAILURE TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDFEDataRsp:  UNKNOWN status TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDFEDataRsp: Bad Response IOMB!!! pRequest is NULL.TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2Y"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|ossaGetDFEDataCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|NBT
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetDFEDataRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2Y"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAS Set Controller Config Response  *  *  This routine handles the response of Set Controller Config Command  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSetControllerConfigRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSetControllerConfigRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaHWEventMode_t
name|agMode
decl_stmt|;
name|bit32
name|status
decl_stmt|,
name|errorQualifierPage
decl_stmt|,
name|tag
decl_stmt|;
name|bit32
name|errorQualifier
decl_stmt|;
name|bit32
name|pagetype
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3a"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp: HTag=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetControllerConfigRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetControllerConfigRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|errorQualifierPage
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetControllerConfigRsp_t
argument_list|,
name|errorQualifierPage
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3a"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|si_memset
argument_list|(
operator|&
name|agMode
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHWEventMode_t
argument_list|)
argument_list|)
expr_stmt|;
name|agMode
operator|.
name|modePageOperation
operator|=
name|agsaModePageSet
expr_stmt|;
name|agMode
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|agMode
operator|.
name|context
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
name|errorQualifier
operator|=
operator|(
name|errorQualifierPage
operator|&
literal|0xFFFF0000
operator|)
operator|>>
name|SHIFT16
expr_stmt|;
name|pagetype
operator|=
operator|(
name|errorQualifierPage
operator|&
literal|0xFF
operator|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp: Error detected tag 0x%x pagetype 0x%x status 0x%x errorQualifier 0x%x\n"
operator|,
name|tag
operator|,
name|pagetype
operator|,
name|status
operator|,
name|errorQualifier
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp: tag 0x%x pagetype 0x%x status 0x%x\n"
operator|,
name|tag
operator|,
name|pagetype
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|pagetype
condition|)
block|{
case|case
name|AGSA_ENCRYPTION_DEK_CONFIG_PAGE
case|:
case|case
name|AGSA_SAS_PROTOCOL_TIMER_CONFIG_PAGE
case|:
case|case
name|AGSA_INTERRUPT_CONFIGURATION_PAGE
case|:
case|case
name|AGSA_ENCRYPTION_HMAC_CONFIG_PAGE
case|:
case|case
name|AGSA_IO_GENERAL_CONFIG_PAGE
case|:
comment|/*case AGSA_ENCRYPTION_CONTROL_PARM_PAGE:*/
comment|/* Report the event before freeing the IOMB */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp:OSSA_HW_EVENT_MODE\n"
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agMode
operator|.
name|context
argument_list|,
name|OSSA_HW_EVENT_MODE
argument_list|,
name|errorQualifierPage
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|agMode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_ENCRYPTION_GENERAL_CONFIG_PAGE
case|:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp:warning!!!! GENERAL_CONFIG_PAGE is read only, cannot be set\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
comment|/* why we need to read the scrach pad register when handling ENCRYPTION_SECURITY_PARM_PAGE??? */
case|case
name|AGSA_ENCRYPTION_CONTROL_PARM_PAGE
case|:
block|{
name|bit32
name|ScratchPad1
init|=
literal|0
decl_stmt|;
name|bit32
name|ScratchPad3
init|=
literal|0
decl_stmt|;
name|agsaEncryptInfo_t
name|encrypt
decl_stmt|;
name|agsaEncryptInfo_t
modifier|*
name|encryptInfo
init|=
operator|&
name|encrypt
decl_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp: AGSA_ENCRYPTION_CONTROL_PARM_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|modePageContext
condition|)
block|{
name|pRequest
operator|->
name|modePageContext
operator|=
name|agFALSE
expr_stmt|;
block|}
name|si_memset
argument_list|(
operator|&
name|encrypt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaEncryptInfo_t
argument_list|)
argument_list|)
expr_stmt|;
name|encryptInfo
operator|->
name|status
operator|=
literal|0
expr_stmt|;
name|encryptInfo
operator|->
name|encryptionCipherMode
operator|=
literal|0
expr_stmt|;
name|encryptInfo
operator|->
name|encryptionSecurityMode
operator|=
literal|0
expr_stmt|;
name|ScratchPad1
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|V_Scratchpad_1_Register
argument_list|)
expr_stmt|;
name|ScratchPad3
operator|=
name|ossaHwRegRead
argument_list|(
name|agRoot
argument_list|,
name|V_Scratchpad_3_Register
argument_list|)
expr_stmt|;
if|if
condition|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_XTS_ENABLED
condition|)
block|{
name|encryptInfo
operator|->
name|encryptionCipherMode
operator|=
name|agsaEncryptCipherModeXTS
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_SM_MASK
operator|)
operator|==
name|SCRATCH_PAD3_V_SMF_ENABLED
condition|)
block|{
name|encryptInfo
operator|->
name|encryptionSecurityMode
operator|=
name|agsaEncryptSMF
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_SM_MASK
operator|)
operator|==
name|SCRATCH_PAD3_V_SMA_ENABLED
condition|)
block|{
name|encryptInfo
operator|->
name|encryptionSecurityMode
operator|=
name|agsaEncryptSMA
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_SM_MASK
operator|)
operator|==
name|SCRATCH_PAD3_V_SMB_ENABLED
condition|)
block|{
name|encryptInfo
operator|->
name|encryptionSecurityMode
operator|=
name|agsaEncryptSMB
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ScratchPad1
operator|&
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|==
name|SCRATCH_PAD1_V_RAAE_MASK
condition|)
block|{
if|if
condition|(
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_ENC_MASK
operator|)
operator|==
name|SCRATCH_PAD3_V_ENC_READY
condition|)
comment|/* 3 */
block|{
name|encryptInfo
operator|->
name|status
operator|=
name|AGSA_RC_SUCCESS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_ENC_READY
operator|)
operator|==
name|SCRATCH_PAD3_V_ENC_DISABLED
condition|)
comment|/* 0 */
block|{
name|encryptInfo
operator|->
name|status
operator|=
literal|0xFFFF
expr_stmt|;
name|encryptInfo
operator|->
name|encryptionCipherMode
operator|=
literal|0
expr_stmt|;
name|encryptInfo
operator|->
name|encryptionSecurityMode
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_ENC_MASK
operator|)
operator|==
name|SCRATCH_PAD3_V_ENC_DIS_ERR
condition|)
comment|/* 1 */
block|{
name|encryptInfo
operator|->
name|status
operator|=
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_ERR_CODE
operator|)
operator|>>
name|SHIFT16
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_ENC_MASK
operator|)
operator|==
name|SCRATCH_PAD3_V_ENC_ENA_ERR
condition|)
comment|/* 2 */
block|{
name|encryptInfo
operator|->
name|status
operator|=
operator|(
name|ScratchPad3
operator|&
name|SCRATCH_PAD3_V_ERR_CODE
operator|)
operator|>>
name|SHIFT16
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ScratchPad1
operator|&
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|==
name|SCRATCH_PAD1_V_RAAE_ERR
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp, RAAE not ready SPC AGSA_RC_FAILURE\n"
operator|)
argument_list|)
expr_stmt|;
name|encryptInfo
operator|->
name|status
operator|=
literal|0xFFFF
expr_stmt|;
name|encryptInfo
operator|->
name|encryptionCipherMode
operator|=
literal|0
expr_stmt|;
name|encryptInfo
operator|->
name|encryptionSecurityMode
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ScratchPad1
operator|&
name|SCRATCH_PAD1_V_RAAE_MASK
operator|)
operator|==
literal|0x0
condition|)
block|{
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp, RAAE not ready AGSA_RC_BUSY\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp, encryptionCipherMode 0x%x encryptionSecurityMode 0x%x status 0x%x\n"
operator|,
name|encryptInfo
operator|->
name|encryptionCipherMode
operator|,
name|encryptInfo
operator|->
name|encryptionSecurityMode
operator|,
name|encryptInfo
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp, ScratchPad3 0x%x\n"
operator|,
name|ScratchPad3
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp:AGSA_ENCRYPTION_CONTROL_PARM_PAGE 0x%X\n"
operator|,
name|agMode
operator|.
name|modePageOperation
operator|)
argument_list|)
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|OSSA_HW_EVENT_SECURITY_MODE
argument_list|,
name|errorQualifier
argument_list|,
operator|(
name|void
operator|*
operator|)
name|encryptInfo
argument_list|,
name|agMode
operator|.
name|context
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerConfigRsp: Unknown page code 0x%X\n"
operator|,
name|pagetype
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetControllerRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3a"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAS Get Controller Config Response  *  *  This routine handles the response of Get Controller Config Command  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetControllerConfigRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGetControllerConfigRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaHWEventMode_t
name|agMode
decl_stmt|;
name|bit32
name|status
decl_stmt|,
name|errorQualifier
decl_stmt|,
name|tag
decl_stmt|;
name|bit32
name|configPage
index|[
literal|12
index|]
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3b"
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|agMode
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHWEventMode_t
argument_list|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
name|configPage
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|configPage
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: HTag=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetControllerConfigRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetControllerConfigRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|errorQualifier
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetControllerConfigRsp_t
argument_list|,
name|errorQualifier
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|configPage
index|[
literal|0
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetControllerConfigRsp_t
argument_list|,
name|configPage
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|configPage
index|[
literal|1
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetControllerConfigRsp_t
argument_list|,
name|configPage
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|configPage
index|[
literal|2
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetControllerConfigRsp_t
argument_list|,
name|configPage
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|configPage
index|[
literal|3
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetControllerConfigRsp_t
argument_list|,
name|configPage
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|configPage
index|[
literal|4
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetControllerConfigRsp_t
argument_list|,
name|configPage
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|configPage
index|[
literal|5
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetControllerConfigRsp_t
argument_list|,
name|configPage
index|[
literal|5
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3b"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|si_memset
argument_list|(
operator|&
name|agMode
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHWEventMode_t
argument_list|)
argument_list|)
expr_stmt|;
name|agMode
operator|.
name|modePageOperation
operator|=
name|agsaModePageGet
expr_stmt|;
name|agMode
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: page 0x%x status 0x%x errorQualifier 0x%x \n"
operator|,
operator|(
name|pIomb
operator|->
name|configPage
index|[
literal|0
index|]
operator|&
literal|0xFF
operator|)
operator|,
name|status
operator|,
name|errorQualifier
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pIomb
operator|->
name|configPage
index|[
literal|0
index|]
operator|&
literal|0xFF
condition|)
block|{
case|case
name|AGSA_SAS_PROTOCOL_TIMER_CONFIG_PAGE
case|:
name|agMode
operator|.
name|modePageLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaSASProtocolTimerConfigurationPage_t
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: AGSA_SAS_PROTOCOL_TIMER_CONFIG_PAGE page len 0x%x \n"
operator|,
name|agMode
operator|.
name|modePageLen
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_INTERRUPT_CONFIGURATION_PAGE
case|:
name|agMode
operator|.
name|modePageLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaInterruptConfigPage_t
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: AGSA_INTERRUPT_CONFIGURATION_PAGE page len 0x%x \n"
operator|,
name|agMode
operator|.
name|modePageLen
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_IO_GENERAL_CONFIG_PAGE
case|:
name|agMode
operator|.
name|modePageLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaIoGeneralPage_t
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: AGSA_IO_GENERAL_CONFIG_PAGE page len 0x%x \n"
operator|,
name|agMode
operator|.
name|modePageLen
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_ENCRYPTION_GENERAL_CONFIG_PAGE
case|:
name|agMode
operator|.
name|modePageLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaEncryptGeneralPage_t
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: AGSA_ENCRYPTION_GENERAL_CONFIG_PAGE page len 0x%x \n"
operator|,
name|agMode
operator|.
name|modePageLen
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HIALEAH_ENCRYPTION
name|saRoot
operator|->
name|EncGenPage
operator|.
name|numberOfKeksPageCode
operator|=
name|configPage
index|[
literal|0
index|]
expr_stmt|;
name|saRoot
operator|->
name|EncGenPage
operator|.
name|KeyCardIdKekIndex
operator|=
name|configPage
index|[
literal|1
index|]
expr_stmt|;
name|saRoot
operator|->
name|EncGenPage
operator|.
name|KeyCardId3_0
operator|=
name|configPage
index|[
literal|2
index|]
expr_stmt|;
name|saRoot
operator|->
name|EncGenPage
operator|.
name|KeyCardId7_4
operator|=
name|configPage
index|[
literal|3
index|]
expr_stmt|;
name|saRoot
operator|->
name|EncGenPage
operator|.
name|KeyCardId11_8
operator|=
name|configPage
index|[
literal|4
index|]
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: numberOfKeksPageCode 0x%x\n"
operator|,
name|saRoot
operator|->
name|EncGenPage
operator|.
name|numberOfKeksPageCode
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: KeyCardIdKekIndex    0x%x\n"
operator|,
name|saRoot
operator|->
name|EncGenPage
operator|.
name|KeyCardIdKekIndex
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: KeyCardId3_0         0x%x\n"
operator|,
name|saRoot
operator|->
name|EncGenPage
operator|.
name|KeyCardId3_0
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: KeyCardId7_4         0x%x\n"
operator|,
name|saRoot
operator|->
name|EncGenPage
operator|.
name|KeyCardId7_4
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: KeyCardId11_8        0x%x\n"
operator|,
name|saRoot
operator|->
name|EncGenPage
operator|.
name|KeyCardId11_8
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HIALEAH_ENCRYPTION */
break|break;
case|case
name|AGSA_ENCRYPTION_DEK_CONFIG_PAGE
case|:
name|agMode
operator|.
name|modePageLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaEncryptDekConfigPage_t
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: AGSA_ENCRYPTION_DEK_CONFIG_PAGE page len 0x%x \n"
operator|,
name|agMode
operator|.
name|modePageLen
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_ENCRYPTION_CONTROL_PARM_PAGE
case|:
name|agMode
operator|.
name|modePageLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaEncryptControlParamPage_t
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: AGSA_ENCRYPTION_CONTROL_PARM_PAGE page len 0x%x \n"
operator|,
name|agMode
operator|.
name|modePageLen
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_ENCRYPTION_HMAC_CONFIG_PAGE
case|:
name|agMode
operator|.
name|modePageLen
operator|=
sizeof|sizeof
argument_list|(
name|agsaEncryptHMACConfigPage_t
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: AGSA_ENCRYPTION_HMAC_CONFIG_PAGE page len 0x%x \n"
operator|,
name|agMode
operator|.
name|modePageLen
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|agMode
operator|.
name|modePageLen
operator|=
literal|0
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerConfigRsp: Unknown !!! page len 0x%x \n"
operator|,
name|agMode
operator|.
name|modePageLen
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|agMode
operator|.
name|modePage
operator|=
operator|(
name|void
operator|*
operator|)
operator|&
name|pIomb
operator|->
name|configPage
index|[
literal|0
index|]
expr_stmt|;
name|agMode
operator|.
name|context
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* Report the event before freeing the IOMB */
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|NULL
argument_list|,
name|OSSA_HW_EVENT_MODE
argument_list|,
name|errorQualifier
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|agMode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetControllerRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3b"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief KEK Management Response  *  *  This routine handles the response of the KEK management message  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiKekManagementRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaKekManagementRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaHWEventEncrypt_t
name|agEvent
decl_stmt|;
name|bit32
name|status
decl_stmt|,
name|errorQualifier
decl_stmt|,
name|tag
decl_stmt|,
name|flags
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2A"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiKekManagementRsp: HTag=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaKekManagementRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaKekManagementRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|flags
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaKekManagementRsp_t
argument_list|,
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|errorQualifier
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaKekManagementRsp_t
argument_list|,
name|errorQualifier
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiKekManagementRsp:status 0x%x flags 0x%x errorQualifier 0x%x\n"
operator|,
name|status
operator|,
name|flags
operator|,
name|errorQualifier
operator|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|agEvent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHWEventEncrypt_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
literal|0xFF
operator|)
operator|==
name|KEK_MGMT_SUBOP_UPDATE
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiKekManagementRsp:KEK_MGMT_SUBOP_UPDATE 0x%x \n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
literal|0xFF00
condition|)
comment|/* update and store*/
block|{
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_KEK_UPDATE_AND_STORE
expr_stmt|;
block|}
else|else
comment|/* update */
block|{
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_KEK_UPDATE
expr_stmt|;
block|}
name|agEvent
operator|.
name|status
operator|=
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_MPI_ENC_ERR_ILLEGAL_KEK_PARAM
condition|)
block|{
name|agEvent
operator|.
name|eq
operator|=
name|errorQualifier
expr_stmt|;
block|}
name|agEvent
operator|.
name|info
operator|=
literal|0
expr_stmt|;
comment|/* Store the new KEK index in agEvent.handle */
name|agEvent
operator|.
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
call|(
name|bitptr
call|)
argument_list|(
name|flags
operator|>>
literal|24
argument_list|)
operator|)
expr_stmt|;
comment|/* Store the current KEK index in agEvent.param */
name|agEvent
operator|.
name|param
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
call|(
name|bitptr
call|)
argument_list|(
name|flags
operator|>>
literal|16
argument_list|)
operator|&
literal|0xFF
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|flags
operator|&
literal|0xFF
operator|)
operator|==
name|KEK_MGMT_SUBOP_INVALIDATE
condition|)
block|{
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_KEK_INVALIDTE
expr_stmt|;
name|agEvent
operator|.
name|status
operator|=
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_MPI_ENC_ERR_ILLEGAL_KEK_PARAM
condition|)
block|{
name|agEvent
operator|.
name|eq
operator|=
name|errorQualifier
expr_stmt|;
block|}
name|agEvent
operator|.
name|info
operator|=
literal|0
expr_stmt|;
comment|/* Store the new KEK index in agEvent.handle */
name|agEvent
operator|.
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
call|(
name|bitptr
call|)
argument_list|(
name|flags
operator|>>
literal|24
argument_list|)
operator|)
expr_stmt|;
comment|/* Store the current KEK index in agEvent.param */
name|agEvent
operator|.
name|param
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
call|(
name|bitptr
call|)
argument_list|(
name|flags
operator|>>
literal|16
argument_list|)
operator|&
literal|0xFF
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|flags
operator|&
literal|0xFF
operator|)
operator|==
name|KEK_MGMT_SUBOP_KEYCARDINVALIDATE
condition|)
block|{
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_KEK_UPDATE_AND_STORE
expr_stmt|;
name|agEvent
operator|.
name|status
operator|=
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_MPI_ENC_ERR_ILLEGAL_KEK_PARAM
condition|)
block|{
name|agEvent
operator|.
name|eq
operator|=
name|errorQualifier
expr_stmt|;
block|}
name|agEvent
operator|.
name|info
operator|=
literal|0
expr_stmt|;
comment|/* Store the new KEK index in agEvent.handle */
name|agEvent
operator|.
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
call|(
name|bitptr
call|)
argument_list|(
name|flags
operator|>>
literal|24
argument_list|)
operator|)
expr_stmt|;
comment|/* Store the current KEK index in agEvent.param */
name|agEvent
operator|.
name|param
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
call|(
name|bitptr
call|)
argument_list|(
name|flags
operator|>>
literal|16
argument_list|)
operator|&
literal|0xFF
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|flags
operator|&
literal|0xFF
operator|)
operator|==
name|KEK_MGMT_SUBOP_KEYCARDUPDATE
condition|)
block|{
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_KEK_UPDATE
expr_stmt|;
name|agEvent
operator|.
name|status
operator|=
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_MPI_ENC_ERR_ILLEGAL_KEK_PARAM
condition|)
block|{
name|agEvent
operator|.
name|eq
operator|=
name|errorQualifier
expr_stmt|;
block|}
name|agEvent
operator|.
name|info
operator|=
literal|0
expr_stmt|;
comment|/* Store the new KEK index in agEvent.handle */
name|agEvent
operator|.
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
call|(
name|bitptr
call|)
argument_list|(
name|flags
operator|>>
literal|24
argument_list|)
operator|)
expr_stmt|;
comment|/* Store the current KEK index in agEvent.param */
name|agEvent
operator|.
name|param
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
call|(
name|bitptr
call|)
argument_list|(
name|flags
operator|>>
literal|16
argument_list|)
operator|&
literal|0xFF
operator|)
expr_stmt|;
block|}
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiKekManagementRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2A"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|NULL
argument_list|,
name|OSSA_HW_EVENT_ENCRYPTION
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|agEvent
argument_list|,
name|agContext
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiKekManagementRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2A"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief DEK Management Response  *  *  This routine handles the response of the DEK management message  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiDekManagementRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDekManagementRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaHWEventEncrypt_t
name|agEvent
decl_stmt|;
name|bit32
name|flags
decl_stmt|,
name|status
decl_stmt|,
name|errorQualifier
decl_stmt|,
name|tag
decl_stmt|,
name|dekIndex
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"2B"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDekManagementRsp: HTag=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDekManagementRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDekManagementRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|flags
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDekManagementRsp_t
argument_list|,
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|errorQualifier
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDekManagementRsp_t
argument_list|,
name|errorQualifier
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|dekIndex
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDekManagementRsp_t
argument_list|,
name|dekIndex
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiDekManagementRsp:tag =0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiDekManagementRsp:status =0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiDekManagementRsp:flags =0x%x\n"
operator|,
name|flags
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiDekManagementRsp:errorQualifier =0x%x\n"
operator|,
name|errorQualifier
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiDekManagementRsp:dekIndex =0x%x\n"
operator|,
name|dekIndex
operator|)
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|agEvent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHWEventEncrypt_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
literal|0xFF
operator|)
operator|==
name|DEK_MGMT_SUBOP_UPDATE
condition|)
block|{
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_DEK_UPDATE
expr_stmt|;
block|}
else|else
block|{
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_DEK_INVALIDTE
expr_stmt|;
block|}
name|agEvent
operator|.
name|status
operator|=
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_MPI_ENC_ERR_ILLEGAL_DEK_PARAM
operator|||
name|OSSA_MPI_ERR_DEK_MANAGEMENT_DEK_UNWRAP_FAIL
condition|)
block|{
name|agEvent
operator|.
name|eq
operator|=
name|errorQualifier
expr_stmt|;
block|}
comment|/* Store the DEK in agEvent.info */
name|agEvent
operator|.
name|info
operator|=
operator|(
name|flags
operator|>>
literal|8
operator|)
operator|&
literal|0xF
expr_stmt|;
comment|/* Store the KEK index in agEvent.handle */
name|agEvent
operator|.
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
call|(
name|bitptr
call|)
argument_list|(
name|flags
operator|>>
literal|24
argument_list|)
operator|)
expr_stmt|;
comment|/* Store the DEK index in agEvent.param */
name|agEvent
operator|.
name|param
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|bitptr
operator|)
name|dekIndex
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDekManagementRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"2B"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|NULL
argument_list|,
name|OSSA_HW_EVENT_ENCRYPTION
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|agEvent
argument_list|,
name|agContext
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDekManagementRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"2B"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Operator Management Response  *  *  This routine handles the response of the Operator management message  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiOperatorManagementRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaOperatorMangmenRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaHWEventEncrypt_t
name|agEvent
decl_stmt|;
name|bit32
name|OPRIDX_AUTIDX_R_OMO
decl_stmt|,
name|status
decl_stmt|,
name|errorQualifier
decl_stmt|,
name|tag
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"36"
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiOperatorManagementRsp: HTag=0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaOperatorMangmenRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaOperatorMangmenRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|OPRIDX_AUTIDX_R_OMO
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaOperatorMangmenRsp_t
argument_list|,
name|OPRIDX_AUTIDX_R_OMO
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|errorQualifier
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaOperatorMangmenRsp_t
argument_list|,
name|errorQualifier
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiOperatorManagementRsp:tag =0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiOperatorManagementRsp:status =0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiOperatorManagementRsp:OPRIDX_AUTIDX_R_OMO =0x%x\n"
operator|,
name|OPRIDX_AUTIDX_R_OMO
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiOperatorManagementRsp:errorQualifier =0x%x\n"
operator|,
name|errorQualifier
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiOperatorManagementRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"36"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|agEvent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHWEventEncrypt_t
argument_list|)
argument_list|)
expr_stmt|;
name|agEvent
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|agEvent
operator|.
name|info
operator|=
name|OPRIDX_AUTIDX_R_OMO
expr_stmt|;
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_OPERATOR_MANAGEMENT
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OPR_MGMT_MPI_ENC_ERR_OPR_PARAM_ILLEGAL
condition|)
block|{
name|agEvent
operator|.
name|eq
operator|=
name|errorQualifier
expr_stmt|;
block|}
name|ossaOperatorManagementCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|errorQualifier
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiOperatorManagementRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"36"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|mpiBistRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaEncryptBistRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|agsaHWEventEncrypt_t
name|agEvent
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|results
index|[
literal|11
index|]
decl_stmt|;
name|bit32
name|length
decl_stmt|;
name|bit32
name|subop
decl_stmt|;
name|bit32
name|tag
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"37"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|subop
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|subop
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|0
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|1
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|2
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|3
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|4
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|5
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|5
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|6
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|6
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|7
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|8
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|8
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|9
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|9
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|results
index|[
literal|10
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaEncryptBistRsp_t
argument_list|,
name|testResults
index|[
literal|10
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|subop
operator|&=
literal|0xFF
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiBistRsp: HTag=0x%x subops =0x%x status =0x%x\n"
operator|,
name|pIomb
operator|->
name|tag
operator|,
name|subop
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|subop
condition|)
block|{
case|case
name|AGSA_BIST_TEST
case|:
name|length
operator|=
sizeof|sizeof
argument_list|(
name|agsaEncryptSelfTestStatusBitMap_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_SHA_TEST
case|:
name|length
operator|=
sizeof|sizeof
argument_list|(
name|agsaEncryptSHATestResult_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|AGSA_HMAC_TEST
case|:
name|length
operator|=
sizeof|sizeof
argument_list|(
name|agsaEncryptHMACTestResult_t
argument_list|)
expr_stmt|;
break|break;
default|default:
name|length
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|si_memset
argument_list|(
operator|&
name|agEvent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaHWEventEncrypt_t
argument_list|)
argument_list|)
expr_stmt|;
name|agEvent
operator|.
name|status
operator|=
name|status
expr_stmt|;
name|agEvent
operator|.
name|encryptOperation
operator|=
name|OSSA_HW_ENCRYPT_TEST_EXECUTE
expr_stmt|;
name|agEvent
operator|.
name|info
operator|=
name|length
expr_stmt|;
name|agEvent
operator|.
name|eq
operator|=
name|subop
expr_stmt|;
name|agEvent
operator|.
name|handle
operator|=
name|agNULL
expr_stmt|;
name|agEvent
operator|.
name|param
operator|=
operator|&
name|results
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiBistRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"37"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
name|ossaHwCB
argument_list|(
name|agRoot
argument_list|,
name|NULL
argument_list|,
name|OSSA_HW_EVENT_ENCRYPTION
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|agEvent
argument_list|,
name|agContext
argument_list|)
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiBistRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"37"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Set Operator Response  *  *  This routine handles the response of the Operator management message  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiSetOperatorRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaSetOperatorRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
init|=
name|agNULL
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ERR_QLFR_OPRIDX_PIN_ACS
decl_stmt|,
name|OPRIDX_PIN_ACS
decl_stmt|,
name|status
decl_stmt|,
name|errorQualifier
decl_stmt|,
name|tag
init|=
literal|0
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"38"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetOperatorRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetOperatorRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|ERR_QLFR_OPRIDX_PIN_ACS
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaSetOperatorRsp_t
argument_list|,
name|ERR_QLFR_OPRIDX_PIN_ACS
argument_list|)
argument_list|)
expr_stmt|;
name|errorQualifier
operator|=
name|ERR_QLFR_OPRIDX_PIN_ACS
operator|>>
literal|16
expr_stmt|;
name|OPRIDX_PIN_ACS
operator|=
name|ERR_QLFR_OPRIDX_PIN_ACS
operator|&
literal|0xFFFF
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetOperatorRsp: HTag=0x%x ERR_QLFR=0x%x OPRIDX_PIN_ACS=0x%x \n"
operator|,
name|tag
operator|,
name|errorQualifier
operator|,
name|OPRIDX_PIN_ACS
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetOperatorRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"38"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|ossaSetOperatorCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|errorQualifier
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiSetOperatorRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"38"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief Get Operator Response  *  *  This routine handles the response of the Operator management message  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiGetOperatorRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGetOperatorRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|Num_Option
decl_stmt|,
name|NumOperators
decl_stmt|,
name|status
decl_stmt|,
name|tag
decl_stmt|;
name|bit8
name|option
decl_stmt|,
name|Role
init|=
literal|0
decl_stmt|;
name|bit32
name|IDstr
index|[
literal|8
index|]
decl_stmt|;
name|bit8
modifier|*
name|tmpIDstr
init|=
name|agNULL
decl_stmt|;
name|agsaID_t
modifier|*
name|IDString
init|=
name|agNULL
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3f"
argument_list|)
expr_stmt|;
name|si_memset
argument_list|(
operator|&
name|IDstr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|IDstr
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|Num_Option
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|Num_Option
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IDstr
index|[
literal|0
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|IDString
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IDstr
index|[
literal|1
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|IDString
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IDstr
index|[
literal|2
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|IDString
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IDstr
index|[
literal|3
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|IDString
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IDstr
index|[
literal|4
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|IDString
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IDstr
index|[
literal|5
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|IDString
index|[
literal|5
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IDstr
index|[
literal|6
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|IDString
index|[
literal|6
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|IDstr
index|[
literal|7
index|]
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetOperatorRsp_t
argument_list|,
name|IDString
index|[
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetOperatorRsp:tag=0x%x status=0x%x Num_Option=0x%x IDString_Role=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|,
name|Num_Option
operator|,
name|IDstr
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3f"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|option
operator|=
name|Num_Option
operator|&
literal|0xFF
expr_stmt|;
name|NumOperators
operator|=
operator|(
name|Num_Option
operator|>>
name|SHIFT8
operator|)
operator|&
literal|0xFF
expr_stmt|;
comment|/* current operator's Role/ID, valid only if option == 1 */
if|if
condition|(
name|option
operator|==
literal|1
condition|)
block|{
comment|/* extra the role value as parameter */
name|Role
operator|=
name|IDstr
index|[
literal|0
index|]
operator|&
literal|0xFF
expr_stmt|;
name|tmpIDstr
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|IDstr
index|[
literal|0
index|]
expr_stmt|;
name|tmpIDstr
operator|++
expr_stmt|;
comment|/* skip role byte */
name|IDString
operator|=
operator|(
name|agsaID_t
operator|*
operator|)
name|tmpIDstr
expr_stmt|;
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|IDString
operator|->
name|ID
index|[
literal|0
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|1
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|2
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|IDString
operator|->
name|ID
index|[
literal|4
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|5
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|6
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|7
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|IDString
operator|->
name|ID
index|[
literal|8
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|9
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|10
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|11
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|IDString
operator|->
name|ID
index|[
literal|12
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|13
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|14
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|15
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|IDString
operator|->
name|ID
index|[
literal|16
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|17
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|18
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|19
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|IDString
operator|->
name|ID
index|[
literal|20
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|21
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|22
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|23
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: 0x%02x 0x%02x 0x%02x 0x%02x\n"
operator|,
name|IDString
operator|->
name|ID
index|[
literal|24
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|25
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|26
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|27
index|]
operator|)
argument_list|)
expr_stmt|;
name|SA_DBG2
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: 0x%02x 0x%02x 0x%02x\n"
operator|,
name|IDString
operator|->
name|ID
index|[
literal|28
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|29
index|]
operator|,
name|IDString
operator|->
name|ID
index|[
literal|30
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetOperatorRsp:status 0x%x option 0x%x Role 0x%x\n"
operator|,
name|status
operator|,
name|option
operator|,
name|Role
operator|)
argument_list|)
expr_stmt|;
name|ossaGetOperatorCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|option
argument_list|,
name|NumOperators
argument_list|,
name|Role
argument_list|,
name|IDString
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
if|if
condition|(
name|saLlistIOGetCount
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|)
operator|<
name|SA_RESERVED_REQUEST_COUNT
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetOperatorRsp: saving pRequest (%p) for later use\n"
operator|,
name|pRequest
operator|)
argument_list|)
expr_stmt|;
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeReservedRequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
block|}
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3f"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|mpiGetVHistRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaGetVHistCapRsp_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
name|agNULL
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
init|=
literal|0
decl_stmt|;
comment|/* 1 */
name|bit32
name|status
init|=
literal|0
decl_stmt|;
comment|/* 2 */
name|bit32
name|channel
decl_stmt|;
comment|/* 3 */
name|bit32
name|BistLo
decl_stmt|;
comment|/* 4 */
name|bit32
name|BistHi
decl_stmt|;
comment|/* 5 */
name|bit32
name|BytesXfered
init|=
literal|0
decl_stmt|;
comment|/* 6 */
name|bit32
name|PciLo
decl_stmt|;
comment|/* 7 */
name|bit32
name|PciHi
decl_stmt|;
comment|/* 8 */
name|bit32
name|PciBytecount
init|=
literal|0
decl_stmt|;
comment|/* 9 */
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3K"
argument_list|)
expr_stmt|;
comment|/* sanity check */
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|agRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|saRoot
operator|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|saRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIS_SPC12V
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetVHistCapRsp_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetVHistCapRsp_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|channel
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetVHistCapRsp_t
argument_list|,
name|channel
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|BistLo
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetVHistCapRsp_t
argument_list|,
name|BistLo
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|BistHi
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetVHistCapRsp_t
argument_list|,
name|BistHi
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|BytesXfered
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetVHistCapRsp_t
argument_list|,
name|BytesXfered
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|PciLo
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetVHistCapRsp_t
argument_list|,
name|PciLo
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|PciHi
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetVHistCapRsp_t
argument_list|,
name|PciHi
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|PciBytecount
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaGetVHistCapRsp_t
argument_list|,
name|PciBytecount
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SPC does not support this command */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetVHistRsp: smIS_SPC12V only\n"
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3K"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiGetVHistRsp: HTag=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetVHistRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3K"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
comment|/* check status success or failure */
if|if
condition|(
name|status
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetVHistRsp: status is FAILED, status = %x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|ossaVhistCaptureCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|BytesXfered
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaVhistCaptureCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|status
operator|,
name|BytesXfered
operator|)
expr_stmt|;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"3K"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* status is SUCCESS */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiGetVHistRsp: status is SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|ossaVhistCaptureCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|BytesXfered
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaVhistCaptureCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|status
operator|,
name|BytesXfered
operator|)
expr_stmt|;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'d'
argument_list|,
literal|"3K"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*! \brief DifEncOffload Response  *  *  This routine handles the response of the DifEncOffload Response  *  *  \param agRoot       Handles for this instance of SAS/SATA LLL  *  \param pIomb        Pointer of IOMB Mesage  *  *  \return sucess or fail  *  */
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_function
name|GLOBAL
name|bit32
name|mpiDifEncOffloadRsp
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaDifEncOffloadRspV_t
modifier|*
name|pIomb
parameter_list|)
block|{
name|bit32
name|ret
init|=
name|AGSA_RC_SUCCESS
decl_stmt|;
name|agsaLLRoot_t
modifier|*
name|saRoot
init|=
operator|(
name|agsaLLRoot_t
operator|*
operator|)
operator|(
name|agRoot
operator|->
name|sdkData
operator|)
decl_stmt|;
name|agsaIORequestDesc_t
modifier|*
name|pRequest
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
decl_stmt|;
name|bit32
name|tag
decl_stmt|,
name|status
decl_stmt|;
name|agsaOffloadDifDetails_t
name|details
decl_stmt|;
name|smTraceFuncEnter
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|"3F"
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tag
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDifEncOffloadRspV_t
argument_list|,
name|tag
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|status
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDifEncOffloadRspV_t
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get TAG */
name|SA_DBG3
argument_list|(
operator|(
literal|"mpiDifEncOffloadRsp: HTag=0x%x\n"
operator|,
name|tag
operator|)
argument_list|)
expr_stmt|;
comment|/* get request from IOMap */
name|pRequest
operator|=
operator|(
name|agsaIORequestDesc_t
operator|*
operator|)
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
expr_stmt|;
if|if
condition|(
name|agNULL
operator|==
name|pRequest
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDifEncOffloadRsp: Bad Response IOMB!!! pRequest is NULL. TAG=0x%x STATUS=0x%x\n"
operator|,
name|tag
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'a'
argument_list|,
literal|"3F"
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
name|agContext
operator|=
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
expr_stmt|;
comment|/* remove the request from IOMap */
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|Tag
operator|=
name|MARK_OFF
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|IORequest
operator|=
name|agNULL
expr_stmt|;
name|saRoot
operator|->
name|IOMap
index|[
name|tag
index|]
operator|.
name|agContext
operator|=
name|agNULL
expr_stmt|;
name|SA_ASSERT
argument_list|(
operator|(
name|pRequest
operator|->
name|valid
operator|)
argument_list|,
literal|"pRequest->valid"
argument_list|)
expr_stmt|;
comment|/* check status success or failure */
if|if
condition|(
name|status
condition|)
block|{
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDifEncOffloadRsp: status is FAILED, status = %x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_IO_XFR_ERROR_DIF_MISMATCH
operator|||
name|status
operator|==
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
operator|||
name|status
operator|==
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
operator|||
name|status
operator|==
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
condition|)
block|{
name|si_memset
argument_list|(
operator|&
name|details
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaOffloadDifDetails_t
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|details
operator|.
name|ExpectedCRCUDT01
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDifEncOffloadRspV_t
argument_list|,
name|ExpectedCRCUDT01
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|details
operator|.
name|ExpectedUDT2345
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDifEncOffloadRspV_t
argument_list|,
name|ExpectedUDT2345
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|details
operator|.
name|ActualCRCUDT01
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDifEncOffloadRspV_t
argument_list|,
name|ActualCRCUDT01
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|details
operator|.
name|ActualUDT2345
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDifEncOffloadRspV_t
argument_list|,
name|ActualUDT2345
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|details
operator|.
name|DIFErr
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDifEncOffloadRspV_t
argument_list|,
name|DIFErr
argument_list|)
argument_list|)
expr_stmt|;
name|OSSA_READ_LE_32
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|details
operator|.
name|ErrBoffset
argument_list|,
name|pIomb
argument_list|,
name|OSSA_OFFSET_OF
argument_list|(
name|agsaDifEncOffloadRspV_t
argument_list|,
name|ErrBoffset
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|ossaDIFEncryptionOffloadStartCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
operator|&
name|details
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaDIFEncryptionOffloadStartCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|status
operator|,
operator|&
name|details
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|ossaDIFEncryptionOffloadStartCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaDIFEncryptionOffloadStartCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|status
operator|,
name|agNULL
operator|)
expr_stmt|;
block|}
block|}
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'b'
argument_list|,
literal|"3F"
argument_list|)
expr_stmt|;
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
return|return
name|AGSA_RC_FAILURE
return|;
block|}
comment|/* status is SUCCESS */
name|SA_DBG1
argument_list|(
operator|(
literal|"mpiDifEncOffloadRsp: status is SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pRequest
operator|->
name|completionCB
operator|==
name|agNULL
condition|)
block|{
name|ossaDIFEncryptionOffloadStartCB
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|status
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
call|(
name|ossaDIFEncryptionOffloadStartCB_t
call|)
argument_list|(
name|pRequest
operator|->
name|completionCB
argument_list|)
operator|)
operator|(
name|agRoot
operator|,
name|agContext
operator|,
name|status
operator|,
name|agNULL
operator|)
expr_stmt|;
block|}
name|ossaSingleThreadedEnter
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
name|pRequest
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
comment|/* return the request to free pool */
name|saLlistIOAdd
argument_list|(
operator|&
operator|(
name|saRoot
operator|->
name|freeIORequests
operator|)
argument_list|,
operator|&
operator|(
name|pRequest
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|ossaSingleThreadedLeave
argument_list|(
name|agRoot
argument_list|,
name|LL_IOREQ_LOCKEQ_LOCK
argument_list|)
expr_stmt|;
comment|/* return value */
name|smTraceFuncExit
argument_list|(
name|hpDBG_VERY_LOUD
argument_list|,
literal|'c'
argument_list|,
literal|"3F"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


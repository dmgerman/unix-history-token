begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ** ********************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/dm/dmdefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/dm/dmtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/dm/dmproto.h>
end_include

begin_function
name|osGLOBAL
name|bit32
name|dmSMPStart
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|bit32
name|functionCode
parameter_list|,
name|bit8
modifier|*
name|pSmpBody
parameter_list|,
name|bit32
name|smpBodySize
parameter_list|,
name|bit32
name|agRequestType
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
init|=
name|agNULL
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody_t
modifier|*
name|dmSMPResponseBody
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|dmList_t
modifier|*
name|SMPList
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|agsaSMPFrame_t
modifier|*
name|agSMPFrame
decl_stmt|;
name|bit32
name|expectedRspLen
init|=
literal|0
decl_stmt|;
name|dmSMPFrameHeader_t
name|dmSMPFrameHeader
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: 2nd sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: 2nd sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|dm_memset
argument_list|(
operator|&
name|dmSMPFrameHeader
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dmSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: Wrong!!! oneExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|onePortContext
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: Wrong, onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
comment|/* get an smp REQUEST from the free list */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: no free SMP!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
comment|/* undo increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|--
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
else|else
block|{
name|DMLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|SMPList
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|dmSMPRequestBody
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmSMPRequestBody_t
argument_list|,
name|Link
argument_list|,
name|SMPList
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dmSMPRequestBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: dmSMPRequestBody is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: SMP id %d\n"
operator|,
name|dmSMPRequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|dmSMPRequestBody
operator|->
name|dmRoot
operator|=
name|dmRoot
expr_stmt|;
name|dmSMPRequestBody
operator|->
name|dmDevice
operator|=
name|oneDeviceData
expr_stmt|;
name|dmSMPRequestBody
operator|->
name|dmPortContext
operator|=
name|onePortContext
expr_stmt|;
name|agDevHandle
operator|=
name|oneExpander
operator|->
name|agDevHandle
expr_stmt|;
comment|/* save the callback funtion */
name|dmSMPRequestBody
operator|->
name|SMPCompletionFunc
operator|=
name|dmSMPCompleted
expr_stmt|;
comment|/* in dmsmp.c */
name|dmSMPRequestBody
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|dmSMPRequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SALL takes care of this */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSMPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|smpFrame
operator|)
expr_stmt|;
comment|/* sets dmSMPFrameHeader values */
if|if
condition|(
name|oneExpander
operator|->
name|SAS2
operator|==
literal|0
condition|)
block|{
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: SAS 1.1\n"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|functionCode
condition|)
block|{
case|case
name|SMP_REPORT_GENERAL
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_MANUFACTURE_INFORMATION
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportManufactureInfo_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_DISCOVER
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_PHY_ERROR_LOG
case|:
name|expectedRspLen
operator|=
literal|32
operator|-
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_PHY_SATA
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_ROUTING_INFORMATION
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportRouteTable_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_CONFIGURE_ROUTING_INFORMATION
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_PHY_CONTROL
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_PHY_TEST_FUNCTION
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_PMC_SPECIFIC
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
name|expectedRspLen
operator|=
literal|0
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: SAS 1.1 error, undefined or unused smp function code 0x%x !!!\n"
operator|,
name|functionCode
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
comment|/* SMP 1.1 header */
name|dmSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|dmSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|functionCode
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0
expr_stmt|;
block|}
else|else
comment|/* SAS 2 */
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSMPStart: SAS 2\n"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|functionCode
condition|)
block|{
case|case
name|SMP_REPORT_GENERAL
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral2_t
argument_list|)
operator|+
literal|4
expr_stmt|;
comment|/* SMP 2.0 header */
name|dmSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|dmSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|functionCode
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0x11
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_MANUFACTURE_INFORMATION
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportManufactureInfo2_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_DISCOVER
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespDiscover2_t
argument_list|)
operator|+
literal|4
expr_stmt|;
comment|/* SMP 2.0 header */
name|dmSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|dmSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|functionCode
expr_stmt|;
comment|//      dmSMPFrameHeader.smpFunctionResult = 0x6c;
name|dmSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0x1b
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0x02
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_PHY_ERROR_LOG
case|:
name|expectedRspLen
operator|=
literal|32
operator|-
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_PHY_SATA
case|:
comment|/* SMP 2.0 header */
name|dmSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|dmSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|functionCode
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0x10
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0x02
expr_stmt|;
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata2_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_ROUTING_INFORMATION
case|:
name|expectedRspLen
operator|=
sizeof|sizeof
argument_list|(
name|smpRespReportRouteTable2_t
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_CONFIGURE_ROUTING_INFORMATION
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
comment|/* SMP 2.0 header */
name|dmSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|dmSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|functionCode
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0x09
expr_stmt|;
break|break;
case|case
name|SMP_PHY_CONTROL
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
comment|/* SMP 2.0 header */
name|dmSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|dmSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|functionCode
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0x09
expr_stmt|;
break|break;
case|case
name|SMP_PHY_TEST_FUNCTION
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|SMP_DISCOVER_LIST
case|:
name|expectedRspLen
operator|=
name|SMP_MAXIMUM_PAYLOAD
expr_stmt|;
comment|/* 1024 without CRC */
comment|/* SMP 2.0 header */
name|dmSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|dmSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|functionCode
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0xFF
expr_stmt|;
name|dmSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0x06
expr_stmt|;
break|break;
case|case
name|SMP_PMC_SPECIFIC
case|:
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
break|break;
default|default:
name|expectedRspLen
operator|=
literal|0
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: SAS 2 error!!! undefined or unused smp function code 0x%x!!!\n"
operator|,
name|functionCode
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
block|}
if|if
condition|(
name|DMIsSPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DIRECT_SMP
comment|/* direct SMP with 48 or less payload */
if|if
condition|(
operator|(
name|smpBodySize
operator|+
literal|4
operator|)
operator|<=
name|SMP_DIRECT_PAYLOAD_LIMIT
condition|)
comment|/* 48 */
block|{
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: DIRECT smp payload\n"
operator|)
argument_list|)
expr_stmt|;
name|dm_memset
argument_list|(
name|dmSMPRequestBody
operator|->
name|smpPayload
argument_list|,
literal|0
argument_list|,
name|SMP_DIRECT_PAYLOAD_LIMIT
argument_list|)
expr_stmt|;
name|dm_memcpy
argument_list|(
name|dmSMPRequestBody
operator|->
name|smpPayload
argument_list|,
operator|&
name|dmSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dm_memcpy
argument_list|(
operator|(
name|dmSMPRequestBody
operator|->
name|smpPayload
operator|)
operator|+
literal|4
argument_list|,
name|pSmpBody
argument_list|,
name|smpBodySize
argument_list|)
expr_stmt|;
comment|/* direct SMP payload eg) REPORT_GENERAL, DISCOVER etc */
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|dmSMPRequestBody
operator|->
name|smpPayload
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
name|smpBodySize
operator|+
literal|4
expr_stmt|;
comment|/* without last 4 byte crc */
comment|/* to specify DIRECT SMP response */
name|agSMPFrame
operator|->
name|inFrameLen
operator|=
literal|0
expr_stmt|;
comment|/* temporary solution for T2D Combo*/
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|&&
name|defined
argument_list|(
name|TARGET_DRIVER
argument_list|)
comment|/* force smp repsonse to be direct */
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
name|expectedRspLen
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: INDIRECT smp payload, TBD\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/*      dmSMPRequestBody is SMP request      dmSMPResponsebody is SMP response   */
comment|/* get an smp RESPONSE from the free list */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: no free SMP!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* puy back dmSMPRequestBody to the freelist ???*/
comment|//    DMLIST_DEQUEUE_THIS(&(dmSMPRequestBody->Link));
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
comment|/* undo increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|--
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
else|else
block|{
name|DMLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|SMPList
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|dmSMPResponseBody
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmSMPRequestBody_t
argument_list|,
name|Link
argument_list|,
name|SMPList
argument_list|)
expr_stmt|;
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: SMP id %d\n"
operator|,
name|dmSMPResponseBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: dmSMPResponseBody is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
comment|/* fill in indirect SMP request fields */
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: INDIRECT smp payload\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* save the pointer to SMP response in SMP request */
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
operator|=
name|dmSMPResponseBody
expr_stmt|;
comment|/* SMP request and response initialization */
name|dm_memset
argument_list|(
name|dmSMPRequestBody
operator|->
name|IndirectSMP
argument_list|,
literal|0
argument_list|,
name|smpBodySize
operator|+
literal|4
argument_list|)
expr_stmt|;
name|dm_memset
argument_list|(
name|dmSMPResponseBody
operator|->
name|IndirectSMP
argument_list|,
literal|0
argument_list|,
name|expectedRspLen
argument_list|)
expr_stmt|;
name|dm_memcpy
argument_list|(
name|dmSMPRequestBody
operator|->
name|IndirectSMP
argument_list|,
operator|&
name|dmSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dm_memcpy
argument_list|(
name|dmSMPRequestBody
operator|->
name|IndirectSMP
operator|+
literal|4
argument_list|,
name|pSmpBody
argument_list|,
name|smpBodySize
argument_list|)
expr_stmt|;
comment|/* Indirect SMP request */
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|agNULL
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameAddrUpper32
operator|=
name|dmSMPRequestBody
operator|->
name|IndirectSMPUpper32
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameAddrLower32
operator|=
name|dmSMPRequestBody
operator|->
name|IndirectSMPLower32
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
name|smpBodySize
operator|+
literal|4
expr_stmt|;
comment|/* without last 4 byte crc */
comment|/* Indirect SMP response */
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
name|expectedRspLen
expr_stmt|;
name|agSMPFrame
operator|->
name|inFrameAddrUpper32
operator|=
name|dmSMPResponseBody
operator|->
name|IndirectSMPUpper32
expr_stmt|;
name|agSMPFrame
operator|->
name|inFrameAddrLower32
operator|=
name|dmSMPResponseBody
operator|->
name|IndirectSMPLower32
expr_stmt|;
name|agSMPFrame
operator|->
name|inFrameLen
operator|=
name|expectedRspLen
expr_stmt|;
comment|/* without last 4 byte crc */
endif|#
directive|endif
block|}
else|else
comment|/* SPCv controller */
block|{
comment|/* only direct mode for both request and response */
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPStart: DIRECT smp payload\n"
operator|)
argument_list|)
expr_stmt|;
name|agSMPFrame
operator|->
name|flag
operator|=
literal|0
expr_stmt|;
name|dm_memset
argument_list|(
name|dmSMPRequestBody
operator|->
name|smpPayload
argument_list|,
literal|0
argument_list|,
name|SMP_DIRECT_PAYLOAD_LIMIT
argument_list|)
expr_stmt|;
name|dm_memcpy
argument_list|(
name|dmSMPRequestBody
operator|->
name|smpPayload
argument_list|,
operator|&
name|dmSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dm_memcpy
argument_list|(
operator|(
name|dmSMPRequestBody
operator|->
name|smpPayload
operator|)
operator|+
literal|4
argument_list|,
name|pSmpBody
argument_list|,
name|smpBodySize
argument_list|)
expr_stmt|;
comment|/* direct SMP payload eg) REPORT_GENERAL, DISCOVER etc */
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|dmSMPRequestBody
operator|->
name|smpPayload
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
name|smpBodySize
operator|+
literal|4
expr_stmt|;
comment|/* without last 4 byte crc */
comment|/* to specify DIRECT SMP response */
name|agSMPFrame
operator|->
name|inFrameLen
operator|=
literal|0
expr_stmt|;
comment|/* temporary solution for T2D Combo*/
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|&&
name|defined
argument_list|(
name|TARGET_DRIVER
argument_list|)
comment|/* force smp repsonse to be direct */
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
name|expectedRspLen
expr_stmt|;
endif|#
directive|endif
comment|//    tdhexdump("tdSMPStart", (bit8*)agSMPFrame->outFrameBuf, agSMPFrame->outFrameLen);
comment|//    tdhexdump("tdSMPStart new", (bit8*)tdSMPRequestBody->smpPayload, agSMPFrame->outFrameLen);
comment|//    tdhexdump("tdSMPStart - tdSMPRequestBody", (bit8*)tdSMPRequestBody, sizeof(tdssSMPRequestBody_t));
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: !!! agDevHandle is NULL !!! \n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|dmsaSMPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
comment|/* start SMP timer */
if|if
condition|(
name|functionCode
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|functionCode
operator|==
name|SMP_DISCOVER
operator|||
name|functionCode
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|functionCode
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmDiscoverySMPTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|functionCode
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
block|}
return|return
name|DM_RC_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
comment|/* set timer */
if|if
condition|(
name|functionCode
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|functionCode
operator|==
name|SMP_DISCOVER
operator|||
name|functionCode
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|functionCode
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* only for discovery related SMPs*/
name|dmSMPBusyTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
return|return
name|DM_RC_SUCCESS
return|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: return DM_RC_BUSY!!! \n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
else|#
directive|else
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|DM_RC_BUSY
return|;
block|}
block|}
else|else
comment|/* AGSA_RC_FAILURE */
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPStart: return DM_RC_FAILURE!!! \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery failure or task management failure */
if|if
condition|(
name|functionCode
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|functionCode
operator|==
name|SMP_DISCOVER
operator|||
name|functionCode
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|functionCode
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
else|#
directive|else
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|DM_RC_FAILURE
return|;
block|}
block|}
return|return
name|DM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmsaSMPCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
name|dmSMPRequestBody_t
modifier|*
name|pSMPRequestBody
init|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
decl_stmt|;
comment|/* SPC can't be SMP target */
name|DM_DBG5
argument_list|(
operator|(
literal|"dmsaSMPCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSMPRequestBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmsaSMPCompleted: pSMPRequestBody is NULL!!! \n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pSMPRequestBody
operator|->
name|SMPCompletionFunc
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmsaSMPCompleted: pSMPRequestBody->SMPCompletionFunc is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|DM_INTERNAL_DEBUG
comment|/* debugging */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmsaSMPCompleted: agIOrequest %p\n"
operator|,
name|agIORequest
operator|->
name|osData
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmsaSMPCompleted: sizeof(tdIORequestBody_t) %d 0x%x\n"
operator|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
operator|,
sizeof|sizeof
argument_list|(
name|tdIORequestBody_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmsaSMPCompleted: SMPRequestbody %p\n"
operator|,
name|pSMPRequestBody
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmsaSMPCompleted: calling callback fn\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmsaSMPCompleted: callback fn %p\n"
operator|,
name|pSMPRequestBody
operator|->
name|SMPCompletionFunc
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* TD_INTERNAL_DEBUG */
comment|/*     if initiator, calling dmSMPCompleted() in dmsmp.c   */
name|pSMPRequestBody
operator|->
name|SMPCompletionFunc
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|dmPhyControlSend
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
comment|//                   dmDeviceData_t     *oneDeviceData, /* taget disk */
name|dmDeviceData_t
modifier|*
name|oneExpDeviceData
parameter_list|,
comment|/* taget disk */
name|bit8
name|phyOp
parameter_list|,
name|bit8
name|phyID
comment|// added
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|dmAllShared
operator|->
name|agRoot
decl_stmt|;
comment|//  thenil
comment|//  dmDeviceData_t      *oneExpDeviceData;
name|smpReqPhyControl_t
name|smpPhyControlReq
decl_stmt|;
comment|//  bit8                  phyID;
name|bit32
name|status
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPhyControlSend: start\n"
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|smpPhyControlReq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqPhyControl_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* fill in SMP payload */
name|smpPhyControlReq
operator|.
name|phyIdentifier
operator|=
name|phyID
expr_stmt|;
name|smpPhyControlReq
operator|.
name|phyOperation
operator|=
name|phyOp
expr_stmt|;
name|status
operator|=
name|dmSMPStart
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneExpDeviceData
argument_list|,
name|SMP_PHY_CONTROL
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|smpPhyControlReq
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqPhyControl_t
argument_list|)
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmReportGeneralSend
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|dmAllShared
operator|->
name|agRoot
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralSend: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralSend: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralSend: oneExpander %p did %d\n"
operator|,
name|oneDeviceData
operator|->
name|dmExpander
operator|,
name|oneDeviceData
operator|->
name|dmExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agRoot
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneralSend: agRoot is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|dmSMPStart
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_REPORT_GENERAL
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmReportGeneralRespRcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|smpRespReportGeneral_t
name|dmSMPReportGeneralResp
decl_stmt|;
name|smpRespReportGeneral_t
modifier|*
name|pdmSMPReportGeneralResp
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
decl_stmt|;
name|dmSMPRequestBody_t
modifier|*
name|dmSMPResponseBody
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
endif|#
directive|endif
name|pdmSMPReportGeneralResp
operator|=
operator|&
name|dmSMPReportGeneralResp
expr_stmt|;
name|dm_memset
argument_list|(
operator|&
name|dmSMPReportGeneralResp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|frameHandle
argument_list|,
literal|4
argument_list|,
name|pdmSMPReportGeneralResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|dmSMPResponseBody
operator|->
name|IndirectSMP
argument_list|,
literal|4
argument_list|,
name|pdmSMPReportGeneralResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|oneDeviceData
operator|->
name|numOfPhys
operator|=
operator|(
name|bit8
operator|)
name|pdmSMPReportGeneralResp
operator|->
name|numOfPhys
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
name|oneExpander
operator|->
name|routingIndex
operator|=
operator|(
name|bit16
operator|)
name|REPORT_GENERAL_GET_ROUTEINDEXES
argument_list|(
name|pdmSMPReportGeneralResp
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|configReserved
operator|=
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|configRouteTable
operator|=
name|REPORT_GENERAL_IS_CONFIGURABLE
argument_list|(
name|pdmSMPReportGeneralResp
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|configuring
operator|=
name|REPORT_GENERAL_IS_CONFIGURING
argument_list|(
name|pdmSMPReportGeneralResp
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: SAS 2 is %d\n"
operator|,
name|oneExpander
operator|->
name|SAS2
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: oneExpander %p did %d\n"
operator|,
name|oneExpander
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|->
name|SAS2
operator|==
literal|0
operator|&&
name|REPORT_GENERAL_IS_LONG_RESPONSE
argument_list|(
name|pdmSMPReportGeneralResp
argument_list|)
operator|==
literal|1
condition|)
block|{
name|oneExpander
operator|->
name|SAS2
operator|=
name|REPORT_GENERAL_IS_LONG_RESPONSE
argument_list|(
name|pdmSMPReportGeneralResp
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: SAS 2 Long Response=%d\n"
operator|,
name|REPORT_GENERAL_IS_LONG_RESPONSE
argument_list|(
name|pdmSMPReportGeneralResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|dmReportGeneralSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: oneExpander=%p numberofPhys=0x%x RoutingIndex=0x%x\n"
operator|,
name|oneExpander
operator|,
name|oneDeviceData
operator|->
name|numOfPhys
operator|,
name|oneExpander
operator|->
name|routingIndex
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: configRouteTable=%d configuring=%d\n"
operator|,
name|oneExpander
operator|->
name|configRouteTable
operator|,
name|oneExpander
operator|->
name|configuring
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|->
name|configuring
operator|==
literal|1
condition|)
block|{
name|discovery
operator|->
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|retries
operator|>=
name|dmAllShared
operator|->
name|MaxRetryDiscovery
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: retries are over!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/* failed the discovery */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: keep retrying\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: Prep222389 RETRY at %d Maximum Retry is %d\n"
operator|,
name|discovery
operator|->
name|retries
operator|,
name|dmAllShared
operator|->
name|MaxRetryDiscovery
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|// start timer for sending ReportGeneral
name|dmDiscoveryConfiguringTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|discovery
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneralRespRcvd: SMP failed; fn result 0x%x; stopping discovery !!!\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmReportGeneral2RespRcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|smpRespReportGeneral2_t
name|dmSMPReportGeneral2Resp
decl_stmt|;
name|smpRespReportGeneral2_t
modifier|*
name|pdmSMPReportGeneral2Resp
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
decl_stmt|;
name|dmSMPRequestBody_t
modifier|*
name|dmSMPResponseBody
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|bit32
name|ConfiguresOthers
init|=
name|agFALSE
decl_stmt|;
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
endif|#
directive|endif
name|pdmSMPReportGeneral2Resp
operator|=
operator|&
name|dmSMPReportGeneral2Resp
expr_stmt|;
name|dm_memset
argument_list|(
operator|&
name|dmSMPReportGeneral2Resp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral2_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|frameHandle
argument_list|,
literal|4
argument_list|,
name|pdmSMPReportGeneral2Resp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral2_t
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|dmSMPResponseBody
operator|->
name|IndirectSMP
argument_list|,
literal|4
argument_list|,
name|pdmSMPReportGeneral2Resp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral2_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* ??? start here */
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|oneDeviceData
operator|->
name|numOfPhys
operator|=
operator|(
name|bit8
operator|)
name|pdmSMPReportGeneral2Resp
operator|->
name|numOfPhys
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
name|oneExpander
operator|->
name|routingIndex
operator|=
operator|(
name|bit16
operator|)
name|SAS2_REPORT_GENERAL_GET_ROUTEINDEXES
argument_list|(
name|pdmSMPReportGeneral2Resp
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|configReserved
operator|=
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|configRouteTable
operator|=
name|SAS2_REPORT_GENERAL_IS_CONFIGURABLE
argument_list|(
name|pdmSMPReportGeneral2Resp
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|configuring
operator|=
name|SAS2_REPORT_GENERAL_IS_CONFIGURING
argument_list|(
name|pdmSMPReportGeneral2Resp
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|TTTSupported
operator|=
name|SAS2_REPORT_GENERAL_IS_TABLE_TO_TABLE_SUPPORTED
argument_list|(
name|pdmSMPReportGeneral2Resp
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|ConfiguresOthers
operator|=
name|SAS2_REPORT_GENERAL_IS_CONFIGURES_OTHERS
argument_list|(
name|pdmSMPReportGeneral2Resp
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: SAS 2 is %d\n"
operator|,
name|oneExpander
operator|->
name|SAS2
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: oneExpander %p did %d\n"
operator|,
name|oneExpander
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: oneExpander=%p numberofPhys=0x%x RoutingIndex=0x%x\n"
operator|,
name|oneExpander
operator|,
name|oneDeviceData
operator|->
name|numOfPhys
operator|,
name|oneExpander
operator|->
name|routingIndex
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: configRouteTable=%d configuring=%d\n"
operator|,
name|oneExpander
operator|->
name|configRouteTable
operator|,
name|oneExpander
operator|->
name|configuring
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfiguresOthers
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: ConfiguresOthers is true\n"
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|ConfiguresOthers
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|oneExpander
operator|->
name|configuring
operator|==
literal|1
condition|)
block|{
name|discovery
operator|->
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|retries
operator|>=
name|dmAllShared
operator|->
name|MaxRetryDiscovery
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: retries are over!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
comment|/* failed the discovery */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: keep retrying\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: Prep222389 RETRY at %d Maximum Retry is %d\n"
operator|,
name|discovery
operator|->
name|retries
operator|,
name|dmAllShared
operator|->
name|MaxRetryDiscovery
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|// start timer for sending ReportGeneral
name|dmDiscoveryConfiguringTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|discovery
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmReportGeneral2RespRcvd: SMP failed, stopping discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoverSend
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|dmAllShared
operator|->
name|agRoot
decl_stmt|;
name|smpReqDiscover_t
name|smpDiscoverReq
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverSend: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverSend: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverSend: oneExpander %p did %d\n"
operator|,
name|oneExpander
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverSend: phyID 0x%x\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|)
argument_list|)
expr_stmt|;
name|dm_memset
argument_list|(
operator|&
name|smpDiscoverReq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|smpDiscoverReq
operator|.
name|reserved1
operator|=
literal|0
expr_stmt|;
name|smpDiscoverReq
operator|.
name|reserved2
operator|=
literal|0
expr_stmt|;
name|smpDiscoverReq
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|smpDiscoverReq
operator|.
name|reserved3
operator|=
literal|0
expr_stmt|;
name|dmSMPStart
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_DISCOVER
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|smpDiscoverReq
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqDiscover_t
argument_list|)
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoverRespRcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|smpRespDiscover_t
modifier|*
name|pdmSMPDiscoverResp
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
decl_stmt|;
name|dmSMPRequestBody_t
modifier|*
name|dmSMPResponseBody
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
endif|#
directive|endif
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: oneExpander %p did %d\n"
operator|,
name|oneExpander
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pdmSMPDiscoverResp
operator|=
operator|&
operator|(
name|discovery
operator|->
name|SMPDiscoverResp
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|frameHandle
argument_list|,
literal|4
argument_list|,
name|pdmSMPDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|dmSMPResponseBody
operator|->
name|IndirectSMP
argument_list|,
literal|4
argument_list|,
name|pdmSMPDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|dmUpStreamDiscoverExpanderPhy
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|pdmSMPDiscoverResp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|dmDownStreamDiscoverExpanderPhy
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|pdmSMPDiscoverResp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_CONFIG_ROUTING
condition|)
block|{
comment|/* not done with configuring routing          1. set the timer          2. on timer expiration, call tdsaSASDownStreamDiscoverExpanderPhy()       */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: still configuring routing; setting timer\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: onePortContext %p oneDeviceData %p pdmSMPDiscoverResp %p\n"
operator|,
name|onePortContext
operator|,
name|oneDeviceData
operator|,
name|pdmSMPDiscoverResp
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"dmDiscoverRespRcvd"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pdmSMPDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmConfigureRouteTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|pdmSMPDiscoverResp
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* nothing */
block|}
block|}
elseif|else
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|PHY_VACANT
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: smpFunctionResult is PHY_VACANT, phyid %d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|dmUpStreamDiscoverExpanderPhySkip
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|dmDownStreamDiscoverExpanderPhySkip
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_CONFIG_ROUTING
condition|)
block|{
comment|/* not done with configuring routing          1. set the timer          2. on timer expiration, call tdsaSASDownStreamDiscoverExpanderPhy()       */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: still configuring routing; setting timer\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: onePortContext %p oneDeviceData %p pdmSMPDiscoverResp %p\n"
operator|,
name|onePortContext
operator|,
name|oneDeviceData
operator|,
name|pdmSMPDiscoverResp
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"dmDiscoverRespRcvd"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pdmSMPDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmConfigureRouteTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|pdmSMPDiscoverResp
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: Discovery Error SMP function return result error=0x%x !!!\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscover2RespRcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|smpRespDiscover2_t
modifier|*
name|pdmSMPDiscover2Resp
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
decl_stmt|;
name|dmSMPRequestBody_t
modifier|*
name|dmSMPResponseBody
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
endif|#
directive|endif
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverRespRcvd: oneExpander %p did %d\n"
operator|,
name|oneExpander
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pdmSMPDiscover2Resp
operator|=
operator|&
operator|(
name|discovery
operator|->
name|SMPDiscover2Resp
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|frameHandle
argument_list|,
literal|4
argument_list|,
name|pdmSMPDiscover2Resp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover2_t
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|dmSMPResponseBody
operator|->
name|IndirectSMP
argument_list|,
literal|4
argument_list|,
name|pdmSMPDiscover2Resp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover2_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: phyIdentifier %d\n"
operator|,
name|pdmSMPDiscover2Resp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: NegotiatedSSCHWMuxingSupported %d\n"
operator|,
name|pdmSMPDiscover2Resp
operator|->
name|NegotiatedSSCHWMuxingSupported
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: SAS2_MUXING_SUPPORTED %d\n"
operator|,
name|SAS2_DISCRSP_IS_MUXING_SUPPORTED
argument_list|(
name|pdmSMPDiscover2Resp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: NegotiatedLogicalLinkRate %d\n"
operator|,
name|pdmSMPDiscover2Resp
operator|->
name|NegotiatedLogicalLinkRate
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: ReasonNegotiatedPhysicalLinkRate %d\n"
operator|,
name|pdmSMPDiscover2Resp
operator|->
name|ReasonNegotiatedPhysicalLinkRate
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: SAS2_DISCRSP_GET_LOGICAL_LINKRATE %d\n"
operator|,
name|SAS2_DISCRSP_GET_LOGICAL_LINKRATE
argument_list|(
name|pdmSMPDiscover2Resp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: SAS2_DISCRSP_GET_LINKRATE %d\n"
operator|,
name|SAS2_DISCRSP_GET_LINKRATE
argument_list|(
name|pdmSMPDiscover2Resp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|//NegotiatedLogicalLinkRate 13
comment|//ReasonNegotiatedPhysicalLinkRate 94
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|dmUpStreamDiscover2ExpanderPhy
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|pdmSMPDiscover2Resp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|dmDownStreamDiscover2ExpanderPhy
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|pdmSMPDiscover2Resp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_CONFIG_ROUTING
condition|)
block|{
comment|/* not done with configuring routing          1. set the timer          2. on timer expiration, call tdsaSASDownStreamDiscoverExpanderPhy()       */
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: still configuring routing; setting timer\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: onePortContext %p oneDeviceData %p pdmSMPDiscover2Resp %p\n"
operator|,
name|onePortContext
operator|,
name|oneDeviceData
operator|,
name|pdmSMPDiscover2Resp
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"dmDiscover2RespRcvd"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pdmSMPDiscover2Resp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover2_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmConfigureRouteTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|agNULL
argument_list|,
name|pdmSMPDiscover2Resp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* nothing */
block|}
block|}
elseif|else
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|PHY_VACANT
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: smpFunctionResult is PHY_VACANT, phyid %d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|dmUpStreamDiscover2ExpanderPhySkip
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|dmDownStreamDiscover2ExpanderPhySkip
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_CONFIG_ROUTING
condition|)
block|{
comment|/* not done with configuring routing          1. set the timer          2. on timer expiration, call tdsaSASDownStreamDiscoverExpanderPhy()       */
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: still configuring routing; setting timer\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: onePortContext %p oneDeviceData %p pdmSMPDiscover2Resp %p\n"
operator|,
name|onePortContext
operator|,
name|oneDeviceData
operator|,
name|pdmSMPDiscover2Resp
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"dmDiscover2RespRcvd"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pdmSMPDiscover2Resp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover2_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmConfigureRouteTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|agNULL
argument_list|,
name|pdmSMPDiscover2Resp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* nothing */
block|}
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscover2RespRcvd: Discovery Error SMP function return result error=0x%x\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|NOT_YET
end_ifdef

begin_function
name|osGLOBAL
name|void
name|tdsaDiscoverList2Send
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|tdsaExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|smpReqDiscoverList2_t
name|smpDiscoverListReq
decl_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverList2Send: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverList2Send: device %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|oneDeviceData
operator|->
name|agRoot
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"tdsaDiscoverList2Send: phyID 0x%x\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|smpDiscoverListReq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqDiscoverList2_t
argument_list|)
argument_list|)
expr_stmt|;
name|smpDiscoverListReq
operator|.
name|reserved1
operator|=
literal|0
expr_stmt|;
name|smpDiscoverListReq
operator|.
name|StartingPhyID
operator|=
literal|0
expr_stmt|;
name|smpDiscoverListReq
operator|.
name|MaxNumDiscoverDesc
operator|=
literal|40
expr_stmt|;
comment|/* 40 for SHORT FORMAT; 8 for Long Format; SAS2 p630 */
name|smpDiscoverListReq
operator|.
name|byte10
operator|=
literal|0x2
expr_stmt|;
comment|/* phy filter; all but "no device attached" */
name|smpDiscoverListReq
operator|.
name|byte11
operator|=
literal|0x1
expr_stmt|;
comment|/* descriptor type; SHORT FORMAT */
name|dmSMPStart
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_DISCOVER_LIST
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|smpDiscoverListReq
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqDiscoverList2_t
argument_list|)
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|tdsaDiscoverList2RespRcvd
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|tdsaDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|tdssSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not yet */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief  dmReportPhySataSend * *  Purpose:  This function sends Report Phy SATA to a device. * *  \param   dmRoot: Pointer to the OS Specific module allocated dmRoot_t *                   instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   phyId: Phy Identifier. * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|dmReportPhySataSend
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|bit8
name|phyId
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|dmAllShared
operator|->
name|agRoot
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|smpReqReportPhySata_t
name|smpReportPhySataReq
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataSend: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataSend: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataSend: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataSend: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportPhySataSend: Error!!! expander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataSend: device %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataSend: phyid %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|dm_memset
argument_list|(
operator|&
name|smpReportPhySataReq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqReportPhySata_t
argument_list|)
argument_list|)
expr_stmt|;
name|smpReportPhySataReq
operator|.
name|phyIdentifier
operator|=
name|phyId
expr_stmt|;
name|dmSMPStart
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneExpander
operator|->
name|dmDevice
argument_list|,
name|SMP_REPORT_PHY_SATA
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|smpReportPhySataReq
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqReportPhySata_t
argument_list|)
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  dmReportPhySataRcvd * *  Purpose:  This function processes Report Phy SATA response. * *  \param   dmRoot_t: Pointer to the OS Specific module allocated dmRoot_t *                   instance. *  \param   agRoot: Pointer to chip/driver Instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   frameHeader: Pointer to SMP frame header. *  \param   frameHandle: A Handle used to refer to the response frame * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|dmReportPhySataRcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|smpRespReportPhySata_t
name|SMPreportPhySataResp
decl_stmt|;
name|smpRespReportPhySata_t
modifier|*
name|pSMPReportPhySataResp
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|oneDeviceData
operator|->
name|dmExpander
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|agsaFisRegDeviceToHost_t
modifier|*
name|fis
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|SataDevice
init|=
name|agNULL
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
decl_stmt|;
endif|#
directive|endif
name|bit8
name|sataDeviceType
decl_stmt|;
name|bit8
modifier|*
name|bit8fis
decl_stmt|;
name|bit8
name|i
init|=
literal|0
decl_stmt|;
name|bit32
name|a
init|=
literal|0
decl_stmt|;
name|bit8
name|bit8fisarray
index|[
literal|20
index|]
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|tdSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
endif|#
directive|endif
comment|/* get the current sata device hanlde stored in the expander structure */
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|SataDevice
operator|=
name|oneExpander
operator|->
name|dmDeviceToProcess
expr_stmt|;
block|}
if|if
condition|(
name|SataDevice
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: sasAddressHi 0x%08x\n"
operator|,
name|SataDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: sasAddressLo 0x%08x\n"
operator|,
name|SataDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: SataDevice is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|pSMPReportPhySataResp
operator|=
operator|&
name|SMPreportPhySataResp
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|frameHandle
argument_list|,
literal|4
argument_list|,
name|pSMPReportPhySataResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResp
argument_list|,
literal|4
argument_list|,
name|pSMPReportPhySataResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* tdhexdump("dmReportPhySataRcvd", (bit8 *)pSMPReportPhySataResp, sizeof(smpRespReportPhySata_t));*/
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|dmRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|dmRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|SataDevice
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: SataDevice is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverAbort
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|PHY_VACANT
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: smpFunctionResult == PHY_VACANT, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|fis
operator|=
operator|(
name|agsaFisRegDeviceToHost_t
operator|*
operator|)
operator|&
name|SMPreportPhySataResp
operator|.
name|regDevToHostFis
expr_stmt|;
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|fisType
operator|==
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
comment|/* save signature */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: saves the signature\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* saves signature */
name|SataDevice
operator|->
name|satSignature
index|[
literal|0
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|sectorCount
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|1
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaLow
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|2
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaMid
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|3
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaHigh
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|4
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|device
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: SATA Signature = %02x %02x %02x %02x %02x\n"
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|0
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|1
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|2
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|3
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
name|sataDeviceType
operator|=
name|tddmSATADeviceTypeDecode
argument_list|(
name|SataDevice
operator|->
name|satSignature
argument_list|)
expr_stmt|;
if|if
condition|(
name|sataDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
name|SataDevice
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||=
name|ATAPI_DEVICE_FLAG
expr_stmt|;
block|}
name|SataDevice
operator|->
name|dmDeviceInfo
operator|.
name|sataDeviceType
operator|=
name|sataDeviceType
expr_stmt|;
block|}
comment|/* Handling DataDomain buggy FIS */
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|error
operator|==
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
comment|/* needs to flip fis to host order */
name|bit8fis
operator|=
operator|(
name|bit8
operator|*
operator|)
name|fis
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|a
operator|=
name|DMA_LEBIT32_TO_BIT32
argument_list|(
operator|*
operator|(
name|bit32
operator|*
operator|)
name|bit8fis
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: a 0x%8x\n"
operator|,
name|a
operator|)
argument_list|)
expr_stmt|;
name|bit8fisarray
index|[
literal|4
operator|*
name|i
index|]
operator|=
operator|(
name|a
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
expr_stmt|;
name|bit8fisarray
index|[
literal|4
operator|*
name|i
operator|+
literal|1
index|]
operator|=
operator|(
name|a
operator|&
literal|0x00FF0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|bit8fisarray
index|[
literal|4
operator|*
name|i
operator|+
literal|2
index|]
operator|=
operator|(
name|a
operator|&
literal|0x0000FF00
operator|)
operator|>>
literal|8
expr_stmt|;
name|bit8fisarray
index|[
literal|4
operator|*
name|i
operator|+
literal|3
index|]
operator|=
operator|(
name|a
operator|&
literal|0x000000FF
operator|)
expr_stmt|;
name|bit8fis
operator|=
name|bit8fis
operator|+
literal|4
expr_stmt|;
block|}
name|fis
operator|=
operator|(
name|agsaFisRegDeviceToHost_t
operator|*
operator|)
name|bit8fisarray
expr_stmt|;
comment|/* save signature */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: DataDomain ATAPI saves the signature\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* saves signature */
name|SataDevice
operator|->
name|satSignature
index|[
literal|0
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|sectorCount
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|1
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaLow
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|2
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaMid
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|3
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaHigh
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|4
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|device
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: SATA Signature = %02x %02x %02x %02x %02x\n"
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|0
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|1
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|2
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|3
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
name|sataDeviceType
operator|=
name|tddmSATADeviceTypeDecode
argument_list|(
name|SataDevice
operator|->
name|satSignature
argument_list|)
expr_stmt|;
if|if
condition|(
name|sataDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
name|SataDevice
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||=
name|ATAPI_DEVICE_FLAG
expr_stmt|;
block|}
name|SataDevice
operator|->
name|dmDeviceInfo
operator|.
name|sataDeviceType
operator|=
name|sataDeviceType
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: getting next stp bride\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Continure to report this STP device to TD*/
if|if
condition|(
name|SataDevice
operator|->
name|ExpDevice
operator|!=
name|agNULL
condition|)
block|{
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|SataDevice
operator|->
name|dmDeviceInfo
argument_list|,
operator|&
name|SataDevice
operator|->
name|ExpDevice
operator|->
name|dmDeviceInfo
argument_list|,
name|dmDeviceArrival
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|SataDevice
operator|->
name|dmDeviceInfo
argument_list|,
name|agNULL
argument_list|,
name|dmDeviceArrival
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: siReportPhySataRcvd SMP function return result %x\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  dmReportPhySata2Rcvd * *  Purpose:  This function processes SAS2.0 Report Phy SATA response. * *  \param   dmRoot_t: Pointer to the OS Specific module allocated dmRoot_t *                   instance. *  \param   agRoot: Pointer to chip/driver Instance. *  \param   oneDeviceData: Pointer to the device data. *  \param   frameHeader: Pointer to SMP frame header. *  \param   frameHandle: A Handle used to refer to the response frame * *  \return: *           None * *   \note: * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|dmReportPhySata2Rcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|smpRespReportPhySata2_t
name|SMPreportPhySataResp
decl_stmt|;
name|smpRespReportPhySata2_t
modifier|*
name|pSMPReportPhySataResp
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|oneDeviceData
operator|->
name|dmExpander
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|agsaFisRegDeviceToHost_t
modifier|*
name|fis
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|SataDevice
init|=
name|agNULL
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody_t
modifier|*
name|tdSMPRequestBody
decl_stmt|;
endif|#
directive|endif
name|bit8
name|sataDeviceType
init|=
literal|0
decl_stmt|;
name|bit8
modifier|*
name|bit8fis
decl_stmt|;
name|bit8
name|i
init|=
literal|0
decl_stmt|;
name|bit32
name|a
init|=
literal|0
decl_stmt|;
name|bit8
name|bit8fisarray
index|[
literal|20
index|]
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|tdSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
endif|#
directive|endif
comment|/* get the current sata device hanlde stored in the expander structure */
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|SataDevice
operator|=
name|oneExpander
operator|->
name|dmDeviceToProcess
expr_stmt|;
block|}
if|if
condition|(
name|SataDevice
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: sasAddressHi 0x%08x\n"
operator|,
name|SataDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: sasAddressLo 0x%08x\n"
operator|,
name|SataDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySataRcvd: SataDevice is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|pSMPReportPhySataResp
operator|=
operator|&
name|SMPreportPhySataResp
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|frameHandle
argument_list|,
literal|4
argument_list|,
name|pSMPReportPhySataResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResp
argument_list|,
literal|4
argument_list|,
name|pSMPReportPhySataResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* tdhexdump("dmReportPhySataRcvd", (bit8 *)pSMPReportPhySataResp, sizeof(smpRespReportPhySata_t));*/
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|ostiFreeMemory
argument_list|(
name|dmRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqosMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPReqLen
argument_list|)
expr_stmt|;
name|ostiFreeMemory
argument_list|(
name|dmRoot
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPResposMemHandle
argument_list|,
name|tdSMPRequestBody
operator|->
name|IndirectSMPRespLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|SataDevice
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: SataDevice is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverAbort
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|PHY_VACANT
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: smpFunctionResult == PHY_VACANT, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|fis
operator|=
operator|(
name|agsaFisRegDeviceToHost_t
operator|*
operator|)
operator|&
name|SMPreportPhySataResp
operator|.
name|regDevToHostFis
expr_stmt|;
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|fisType
operator|==
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
comment|/* save signature */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: saves the signature\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* saves signature */
name|SataDevice
operator|->
name|satSignature
index|[
literal|0
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|sectorCount
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|1
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaLow
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|2
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaMid
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|3
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaHigh
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|4
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|device
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: SATA Signature = %02x %02x %02x %02x %02x\n"
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|0
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|1
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|2
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|3
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
name|sataDeviceType
operator|=
name|tddmSATADeviceTypeDecode
argument_list|(
name|SataDevice
operator|->
name|satSignature
argument_list|)
expr_stmt|;
if|if
condition|(
name|sataDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
name|SataDevice
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||=
name|ATAPI_DEVICE_FLAG
expr_stmt|;
block|}
name|SataDevice
operator|->
name|dmDeviceInfo
operator|.
name|sataDeviceType
operator|=
name|sataDeviceType
expr_stmt|;
block|}
comment|/* Handling DataDomain buggy FIS */
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|error
operator|==
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
comment|/* needs to flip fis to host order */
name|bit8fis
operator|=
operator|(
name|bit8
operator|*
operator|)
name|fis
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|a
operator|=
name|DMA_LEBIT32_TO_BIT32
argument_list|(
operator|*
operator|(
name|bit32
operator|*
operator|)
name|bit8fis
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: a 0x%8x\n"
operator|,
name|a
operator|)
argument_list|)
expr_stmt|;
name|bit8fisarray
index|[
literal|4
operator|*
name|i
index|]
operator|=
operator|(
name|a
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
expr_stmt|;
name|bit8fisarray
index|[
literal|4
operator|*
name|i
operator|+
literal|1
index|]
operator|=
operator|(
name|a
operator|&
literal|0x00FF0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|bit8fisarray
index|[
literal|4
operator|*
name|i
operator|+
literal|2
index|]
operator|=
operator|(
name|a
operator|&
literal|0x0000FF00
operator|)
operator|>>
literal|8
expr_stmt|;
name|bit8fisarray
index|[
literal|4
operator|*
name|i
operator|+
literal|3
index|]
operator|=
operator|(
name|a
operator|&
literal|0x000000FF
operator|)
expr_stmt|;
name|bit8fis
operator|=
name|bit8fis
operator|+
literal|4
expr_stmt|;
block|}
name|fis
operator|=
operator|(
name|agsaFisRegDeviceToHost_t
operator|*
operator|)
name|bit8fisarray
expr_stmt|;
comment|/* save signature */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: DataDomain ATAPI saves the signature\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* saves signature */
name|SataDevice
operator|->
name|satSignature
index|[
literal|0
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|sectorCount
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|1
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaLow
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|2
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaMid
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|3
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|lbaHigh
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|4
index|]
operator|=
name|fis
operator|->
name|d
operator|.
name|device
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|SataDevice
operator|->
name|satSignature
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: SATA Signature = %02x %02x %02x %02x %02x\n"
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|0
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|1
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|2
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|3
index|]
operator|,
name|SataDevice
operator|->
name|satSignature
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
name|sataDeviceType
operator|=
name|tddmSATADeviceTypeDecode
argument_list|(
name|SataDevice
operator|->
name|satSignature
argument_list|)
expr_stmt|;
if|if
condition|(
name|sataDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
name|SataDevice
operator|->
name|agDeviceInfo
operator|.
name|flag
operator||=
name|ATAPI_DEVICE_FLAG
expr_stmt|;
block|}
name|SataDevice
operator|->
name|dmDeviceInfo
operator|.
name|sataDeviceType
operator|=
name|sataDeviceType
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: getting next stp bride\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Continue to report this STP device to TD*/
if|if
condition|(
name|SataDevice
operator|->
name|ExpDevice
operator|!=
name|agNULL
condition|)
block|{
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|SataDevice
operator|->
name|dmDeviceInfo
argument_list|,
operator|&
name|SataDevice
operator|->
name|ExpDevice
operator|->
name|dmDeviceInfo
argument_list|,
name|dmDeviceArrival
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|SataDevice
operator|->
name|dmDeviceInfo
argument_list|,
name|agNULL
argument_list|,
name|dmDeviceArrival
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportPhySata2Rcvd: siReportPhySataRcvd SMP function return result %x\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|dmRoutingEntryAdd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|bit32
name|phyId
parameter_list|,
name|bit32
name|configSASAddressHi
parameter_list|,
name|bit32
name|configSASAddressLo
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|dmAllShared
operator|->
name|agRoot
decl_stmt|;
name|bit32
name|ret
init|=
name|agTRUE
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|smpReqConfigureRouteInformation_t
name|confRoutingInfo
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRoutingEntryAdd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRoutingEntryAdd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRoutingEntryAdd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRoutingEntryAdd: phyid %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|configSASAddressHi
operator|&&
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|configSASAddressLo
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRoutingEntryAdd: unnecessary\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|oneExpander
operator|->
name|routingAttribute
index|[
name|phyId
index|]
operator|!=
name|SAS_ROUTING_TABLE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRoutingEntryAdd: not table routing, routing is %d\n"
operator|,
name|oneExpander
operator|->
name|routingAttribute
index|[
name|phyId
index|]
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|onePortContext
operator|=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|dmPortContext
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_CONFIG_ROUTING
expr_stmt|;
comment|/* reset smpReqConfigureRouteInformation_t */
name|dm_memset
argument_list|(
operator|&
name|confRoutingInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqConfigureRouteInformation_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|->
name|currentIndex
index|[
name|phyId
index|]
operator|<
name|oneExpander
operator|->
name|routingIndex
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRoutingEntryAdd: adding sasAddressHi 0x%08x\n"
operator|,
name|configSASAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRoutingEntryAdd: adding sasAddressLo 0x%08x\n"
operator|,
name|configSASAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRoutingEntryAdd: phyid %d currentIndex[phyid] %d\n"
operator|,
name|phyId
operator|,
name|oneExpander
operator|->
name|currentIndex
index|[
name|phyId
index|]
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|configSASAddressHi
operator|=
name|configSASAddressHi
expr_stmt|;
name|oneExpander
operator|->
name|configSASAddressLo
operator|=
name|configSASAddressLo
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved1
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved1
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|OSSA_WRITE_BE_16
argument_list|(
name|agRoot
argument_list|,
name|confRoutingInfo
operator|.
name|expanderRouteIndex
argument_list|,
literal|0
argument_list|,
operator|(
name|oneExpander
operator|->
name|currentIndex
index|[
name|phyId
index|]
operator|)
argument_list|)
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved2
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|phyIdentifier
operator|=
operator|(
name|bit8
operator|)
name|phyId
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved3
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved3
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|disabledBit_reserved4
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved5
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved5
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|confRoutingInfo
operator|.
name|reserved5
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|confRoutingInfo
operator|.
name|routedSasAddressHi
argument_list|,
literal|0
argument_list|,
name|configSASAddressHi
argument_list|)
expr_stmt|;
name|OSSA_WRITE_BE_32
argument_list|(
name|agRoot
argument_list|,
name|confRoutingInfo
operator|.
name|routedSasAddressLo
argument_list|,
literal|0
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|confRoutingInfo
operator|.
name|reserved6
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|dmSMPStart
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneExpander
operator|->
name|dmDevice
argument_list|,
name|SMP_CONFIGURE_ROUTING_INFORMATION
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|confRoutingInfo
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqConfigureRouteInformation_t
argument_list|)
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|currentIndex
index|[
name|phyId
index|]
operator|++
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRoutingEntryAdd: Discovery Error routing index overflow for currentIndex=%d, routingIndex=%d\n"
operator|,
name|oneExpander
operator|->
name|currentIndex
index|[
name|phyId
index|]
operator|,
name|oneExpander
operator|->
name|routingIndex
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|agFALSE
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmConfigRoutingInfoRespRcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|oneDeviceData
operator|->
name|dmExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|UpStreamExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|DownStreamExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|ReturningExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|ConfigurableExpander
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|ReturningExpanderDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|dupConfigSASAddr
init|=
name|agFALSE
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
operator|||
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|PHY_VACANT
condition|)
block|{
name|DownStreamExpander
operator|=
name|oneExpander
operator|->
name|dmCurrentDownStreamExpander
expr_stmt|;
if|if
condition|(
name|DownStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|++
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: DownStreamExpander->currentUpStreamPhyIndex %d\n"
operator|,
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: DownStreamExpander->numOfUpStreamPhys %d\n"
operator|,
name|DownStreamExpander
operator|->
name|numOfUpStreamPhys
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: DownStreamExpander addrHi 0x%08x\n"
operator|,
name|DownStreamExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: DownStreamExpander addrLo 0x%08x\n"
operator|,
name|DownStreamExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
name|oneExpander
operator|->
name|currentDownStreamPhyIndex
operator|++
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: oneExpander->currentDownStreamPhyIndex %d oneExpander->numOfDownStreamPhys %d\n"
operator|,
name|oneExpander
operator|->
name|currentDownStreamPhyIndex
operator|,
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|DownStreamExpander
operator|!=
name|agNULL
operator|)
operator|&&
operator|(
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|<
name|DownStreamExpander
operator|->
name|numOfUpStreamPhys
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: first if\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: DownStreamExpander->currentUpStreamPhyIndex %d\n"
operator|,
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: DownStreamExpander->upStreamPhys[] %d\n"
operator|,
name|DownStreamExpander
operator|->
name|upStreamPhys
index|[
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
index|]
operator|)
argument_list|)
expr_stmt|;
name|dmRoutingEntryAdd
argument_list|(
name|dmRoot
argument_list|,
name|oneExpander
argument_list|,
name|DownStreamExpander
operator|->
name|upStreamPhys
index|[
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
index|]
argument_list|,
name|oneExpander
operator|->
name|configSASAddressHi
argument_list|,
name|oneExpander
operator|->
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* traversing up till discovery Root onePortContext->discovery.RootExp */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: else\n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|dmFindConfigurableExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
if|if
condition|(
name|UpStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: UpStreamExpander addrHi 0x%08x\n"
operator|,
name|UpStreamExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: UpStreamExpander addrLo 0x%08x\n"
operator|,
name|UpStreamExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: UpStreamExpander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|dupConfigSASAddr
operator|=
name|dmDuplicateConfigSASAddr
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|oneExpander
operator|->
name|configSASAddressHi
argument_list|,
name|oneExpander
operator|->
name|configSASAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|!=
name|agNULL
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: else if\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: ConfigurableExpander addrHi 0x%08x\n"
operator|,
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: ConfigurableExpander addrLo 0x%08x\n"
operator|,
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|UpStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|UpStreamExpander
operator|->
name|dmCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
block|}
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|dmFindCurrentDownStreamPhyIndex
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|dmReturnginExpander
operator|=
name|oneExpander
operator|->
name|dmReturnginExpander
expr_stmt|;
if|if
condition|(
name|DownStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|=
literal|0
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: ConfigurableExpander->currentDownStreamPhyIndex %d\n"
operator|,
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: ConfigurableExpander->downStreamPhys[] %d\n"
operator|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
operator|)
argument_list|)
expr_stmt|;
name|dmRoutingEntryAdd
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|oneExpander
operator|->
name|configSASAddressHi
argument_list|,
name|oneExpander
operator|->
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* going back to where it was */
comment|/* ConfigRoutingInfo is done for a target */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: $$$$$$ my change $$$$$ \n"
operator|)
argument_list|)
expr_stmt|;
name|ReturningExpander
operator|=
name|oneExpander
operator|->
name|dmReturnginExpander
expr_stmt|;
if|if
condition|(
name|DownStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|=
literal|0
expr_stmt|;
block|}
comment|/* debugging */
if|if
condition|(
name|ReturningExpander
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: ReturningExpander addrHi 0x%08x\n"
operator|,
name|ReturningExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: ReturningExpander addrLo 0x%08x\n"
operator|,
name|ReturningExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|ReturningExpanderDeviceData
operator|=
name|ReturningExpander
operator|->
name|dmDevice
expr_stmt|;
block|}
comment|/* No longer in DISCOVERY_CONFIG_ROUTING */
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_DOWN_STREAM
expr_stmt|;
if|if
condition|(
name|ReturningExpander
operator|!=
name|agNULL
operator|&&
name|ReturningExpanderDeviceData
operator|!=
name|agNULL
condition|)
block|{
comment|/* If not the last phy */
if|if
condition|(
name|ReturningExpander
operator|->
name|discoveringPhyId
operator|<
name|ReturningExpanderDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
comment|/* needs to send only one Discovery not multiple times */
if|if
condition|(
name|ReturningExpander
operator|->
name|discoverSMPAllowed
operator|==
name|agTRUE
condition|)
block|{
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|ReturningExpanderDeviceData
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ReturningExpander
operator|!=
name|agNULL
condition|)
block|{
name|ReturningExpander
operator|->
name|discoverSMPAllowed
operator|=
name|agFALSE
expr_stmt|;
block|}
block|}
comment|/* If the last phy */
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
name|ReturningExpander
operator|->
name|discoverSMPAllowed
operator|=
name|agTRUE
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|ReturningExpander
argument_list|)
expr_stmt|;
comment|/* continue downstream discovering */
name|dmDownStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|ReturningExpanderDeviceData
argument_list|)
expr_stmt|;
comment|//DownStreamExpander
block|}
block|}
block|}
block|}
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmConfigRoutingInfoRespRcvd: Discovery Error SMP function return result error=0x%x !!!\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmConfigRoutingInfo2RespRcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|oneDeviceData
operator|->
name|dmExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|UpStreamExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|DownStreamExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|ReturningExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|ConfigurableExpander
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|ReturningExpanderDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|dupConfigSASAddr
init|=
name|agFALSE
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|PHY_VACANT
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: smpFunctionResult is PHY_VACANT\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
operator|||
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|PHY_VACANT
condition|)
block|{
name|DownStreamExpander
operator|=
name|oneExpander
operator|->
name|dmCurrentDownStreamExpander
expr_stmt|;
if|if
condition|(
name|DownStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|++
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: DownStreamExpander->currentUpStreamPhyIndex %d\n"
operator|,
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: DownStreamExpander->numOfUpStreamPhys %d\n"
operator|,
name|DownStreamExpander
operator|->
name|numOfUpStreamPhys
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: DownStreamExpander addrHi 0x%08x\n"
operator|,
name|DownStreamExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: DownStreamExpander addrLo 0x%08x\n"
operator|,
name|DownStreamExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
name|oneExpander
operator|->
name|currentDownStreamPhyIndex
operator|++
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: oneExpander->currentDownStreamPhyIndex %d oneExpander->numOfDownStreamPhys %d\n"
operator|,
name|oneExpander
operator|->
name|currentDownStreamPhyIndex
operator|,
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|DownStreamExpander
operator|!=
name|agNULL
operator|)
operator|&&
operator|(
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|<
name|DownStreamExpander
operator|->
name|numOfUpStreamPhys
operator|)
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: first if\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: DownStreamExpander->currentUpStreamPhyIndex %d\n"
operator|,
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: DownStreamExpander->upStreamPhys[] %d\n"
operator|,
name|DownStreamExpander
operator|->
name|upStreamPhys
index|[
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
index|]
operator|)
argument_list|)
expr_stmt|;
name|dmRoutingEntryAdd
argument_list|(
name|dmRoot
argument_list|,
name|oneExpander
argument_list|,
name|DownStreamExpander
operator|->
name|upStreamPhys
index|[
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
index|]
argument_list|,
name|oneExpander
operator|->
name|configSASAddressHi
argument_list|,
name|oneExpander
operator|->
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* traversing up till discovery Root onePortContext->discovery.RootExp */
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: else\n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|dmFindConfigurableExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
if|if
condition|(
name|UpStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: UpStreamExpander addrHi 0x%08x\n"
operator|,
name|UpStreamExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: UpStreamExpander addrLo 0x%08x\n"
operator|,
name|UpStreamExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: UpStreamExpander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|dupConfigSASAddr
operator|=
name|dmDuplicateConfigSASAddr
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|oneExpander
operator|->
name|configSASAddressHi
argument_list|,
name|oneExpander
operator|->
name|configSASAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|!=
name|agNULL
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: else if\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: ConfigurableExpander addrHi 0x%08x\n"
operator|,
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: ConfigurableExpander addrLo 0x%08x\n"
operator|,
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|UpStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|UpStreamExpander
operator|->
name|dmCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
block|}
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|dmFindCurrentDownStreamPhyIndex
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|dmReturnginExpander
operator|=
name|oneExpander
operator|->
name|dmReturnginExpander
expr_stmt|;
if|if
condition|(
name|DownStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|=
literal|0
expr_stmt|;
block|}
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: ConfigurableExpander->currentDownStreamPhyIndex %d\n"
operator|,
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: ConfigurableExpander->downStreamPhys[] %d\n"
operator|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
operator|)
argument_list|)
expr_stmt|;
name|dmRoutingEntryAdd
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|oneExpander
operator|->
name|configSASAddressHi
argument_list|,
name|oneExpander
operator|->
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* going back to where it was */
comment|/* ConfigRoutingInfo is done for a target */
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: $$$$$$ my change $$$$$ \n"
operator|)
argument_list|)
expr_stmt|;
name|ReturningExpander
operator|=
name|oneExpander
operator|->
name|dmReturnginExpander
expr_stmt|;
if|if
condition|(
name|DownStreamExpander
operator|!=
name|agNULL
condition|)
block|{
name|DownStreamExpander
operator|->
name|currentUpStreamPhyIndex
operator|=
literal|0
expr_stmt|;
block|}
comment|/* debugging */
if|if
condition|(
name|ReturningExpander
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: ReturningExpander addrHi 0x%08x\n"
operator|,
name|ReturningExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: ReturningExpander addrLo 0x%08x\n"
operator|,
name|ReturningExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|ReturningExpanderDeviceData
operator|=
name|ReturningExpander
operator|->
name|dmDevice
expr_stmt|;
block|}
comment|/* No longer in DISCOVERY_CONFIG_ROUTING */
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_DOWN_STREAM
expr_stmt|;
if|if
condition|(
name|ReturningExpander
operator|!=
name|agNULL
operator|&&
name|ReturningExpanderDeviceData
operator|!=
name|agNULL
condition|)
block|{
comment|/* If not the last phy */
if|if
condition|(
name|ReturningExpander
operator|->
name|discoveringPhyId
operator|<
name|ReturningExpanderDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
comment|/* needs to send only one Discovery not multiple times */
if|if
condition|(
name|ReturningExpander
operator|->
name|discoverSMPAllowed
operator|==
name|agTRUE
condition|)
block|{
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|ReturningExpanderDeviceData
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ReturningExpander
operator|!=
name|agNULL
condition|)
block|{
name|ReturningExpander
operator|->
name|discoverSMPAllowed
operator|=
name|agFALSE
expr_stmt|;
block|}
block|}
comment|/* If the last phy */
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
name|ReturningExpander
operator|->
name|discoverSMPAllowed
operator|=
name|agTRUE
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|ReturningExpander
argument_list|)
expr_stmt|;
comment|/* continue downstream discovering */
name|dmDownStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|ReturningExpanderDeviceData
argument_list|)
expr_stmt|;
comment|//DownStreamExpander
block|}
block|}
block|}
block|}
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmConfigRoutingInfo2RespRcvd: Discovery Error SMP function return result error=0x%x!!!\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* no task management case here for phyControl*/
end_comment

begin_comment
comment|/* no task management case here for phyControl*/
end_comment

begin_function
name|osGLOBAL
name|void
name|dmPhyControlRespRcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPhyControlRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPhyControlRespRcvd: expander device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPhyControlRespRcvd: expander device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPhyControlRespRcvd: SMP success\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmPhyControlRespRcvd: SMP failure; result 0x%x !!!\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* no task management case here for phyControl*/
end_comment

begin_function
name|osGLOBAL
name|void
name|dmPhyControl2RespRcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmPhyControl2RespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmPhyControl2RespRcvd: expander device AddrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmPhyControl2RespRcvd: expander device AddrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmPhyControl2RespRcvd: SMP success\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmPhyControl2RespRcvd: SMP failure; result 0x%x !!!\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmPhyControlFailureRespRcvd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmPhyControlFailureRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|dmSetDeviceInfoCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|status
parameter_list|,
name|bit32
name|option
parameter_list|,
name|bit32
name|param
parameter_list|)
block|{
name|dmRoot_t
modifier|*
name|dmRoot
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|bit32
name|smstatus
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
init|=
name|agNULL
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|bit8
name|SMPRequestFunction
decl_stmt|;
name|bit8
name|devType_S_Rate
decl_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG4
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG4
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: option 0x%x\n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG4
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: param 0x%x\n"
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|OSSA_SUCCESS
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: option 0x%x\n"
operator|,
name|option
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: param 0x%x\n"
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|option
operator|==
literal|32
condition|)
comment|/* set connection rate */
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: IO failure\n"
operator|)
argument_list|)
expr_stmt|;
name|agIORequest
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
name|agContext
operator|->
name|osData
expr_stmt|;
name|dmSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|dmRoot
operator|=
name|dmSMPRequestBody
operator|->
name|dmRoot
expr_stmt|;
name|oneDeviceData
operator|=
name|dmSMPRequestBody
operator|->
name|dmDevice
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
name|SMPRequestFunction
operator|=
name|dmSMPRequestBody
operator|->
name|smpPayload
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* retry SMP */
if|if
condition|(
name|option
operator|==
literal|32
condition|)
comment|/* set connection rate */
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: set connection rate option\n"
operator|)
argument_list|)
expr_stmt|;
name|agIORequest
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
name|agContext
operator|->
name|osData
expr_stmt|;
name|dmSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|dmRoot
operator|=
name|dmSMPRequestBody
operator|->
name|dmRoot
expr_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|agSASRequestBody
operator|)
expr_stmt|;
name|oneDeviceData
operator|=
name|dmSMPRequestBody
operator|->
name|dmDevice
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
name|devType_S_Rate
operator|=
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
expr_stmt|;
name|devType_S_Rate
operator|=
operator|(
name|devType_S_Rate
operator|&
literal|0xF0
operator|)
operator||
operator|(
name|param
operator|>>
literal|28
operator|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
operator|=
name|devType_S_Rate
expr_stmt|;
name|SMPRequestFunction
operator|=
name|dmSMPRequestBody
operator|->
name|smpPayload
index|[
literal|1
index|]
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: SMPRequestFunction 0x%x\n"
operator|,
name|SMPRequestFunction
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSetDeviceInfoCB: new rate is 0x%x\n"
operator|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|smstatus
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|dmsaSMPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
comment|/* increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
comment|//          dmSMPRequestBody->retries++;
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* start discovery-related SMP timer */
name|dmDiscoverySMPTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|(
name|bit32
operator|)
name|SMPRequestFunction
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
comment|//          dmSMPRequestBody->retries++;
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmSMPBusyTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* For taskmanagement SMP, let's fail task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{       }
block|}
else|else
comment|/* AGSA_RC_FAILURE */
block|{
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{       }
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/* smp completion */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmSMPCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
name|agNULL
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
name|agNULL
decl_stmt|;
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaSMPFrame_t
modifier|*
name|agSMPFrame
decl_stmt|;
name|dmRoot_t
modifier|*
name|dmRoot
init|=
name|agNULL
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|oldonePortContext
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|bit8
name|smpHeader
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|SMPRequestFunction
decl_stmt|;
name|dmSMPFrameHeader_t
modifier|*
name|dmResponseSMPFrameHeader
decl_stmt|;
name|dmSMPFrameHeader_t
modifier|*
name|dmSMPFrameHeader
decl_stmt|;
name|bit8
modifier|*
name|dmSMPPayload
decl_stmt|;
name|smpReqPhyControl_t
modifier|*
name|smpPhyControlReq
decl_stmt|;
name|smpReqPhyControl2_t
modifier|*
name|smpPhyControl2Req
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPRequestBody_t
modifier|*
name|dmSMPResponseBody
init|=
name|agNULL
decl_stmt|;
name|dmSMPFrameHeader_t
modifier|*
name|dmRequestSMPFrameHeader
decl_stmt|;
name|bit8
name|smpRequestHeader
index|[
literal|4
index|]
decl_stmt|;
endif|#
directive|endif
name|bit32
name|status
decl_stmt|;
name|bit32
name|ConnRate
init|=
name|SAS_CONNECTION_RATE_12_0G
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
name|dmSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|dmRoot
operator|=
name|dmSMPRequestBody
operator|->
name|dmRoot
expr_stmt|;
name|dmIntRoot
operator|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
expr_stmt|;
name|dmAllShared
operator|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
expr_stmt|;
name|oneDeviceData
operator|=
name|dmSMPRequestBody
operator|->
name|dmDevice
expr_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSMPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|smpFrame
operator|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agFALSE
operator|&&
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|agNULL
operator|&&
name|dmSMPRequestBody
operator|->
name|dmPortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: port has been destroyed\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* all device, port information have been reset        just put smp to freeList     */
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
name|agDevHandle
operator|=
name|oneExpander
operator|->
name|agDevHandle
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|SMPRequestFunction
operator|=
name|dmSMPRequestBody
operator|->
name|smpPayload
index|[
literal|1
index|]
expr_stmt|;
else|#
directive|else
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|dmSMPRequestBody
operator|->
name|IndirectSMP
argument_list|,
literal|0
argument_list|,
name|smpRequestHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dmRequestSMPFrameHeader
operator|=
operator|(
name|dmSMPFrameHeader_t
operator|*
operator|)
name|smpRequestHeader
expr_stmt|;
name|SMPRequestFunction
operator|=
name|dmRequestSMPFrameHeader
operator|->
name|smpFunction
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NOT_IN_USE
comment|/* for debugging; dump SMP request payload */
name|dmhexdump
argument_list|(
literal|"smp payload"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|agSASRequestBody
operator|->
name|smpFrame
operator|.
name|outFrameBuf
argument_list|,
name|agSASRequestBody
operator|->
name|smpFrame
operator|.
name|outFrameLen
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"smp payload new"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|smpPayload
argument_list|,
name|agSASRequestBody
operator|->
name|smpFrame
operator|.
name|outFrameLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* sanity check */
if|if
condition|(
name|onePortContext
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPCompleted: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|oldonePortContext
operator|=
name|dmSMPRequestBody
operator|->
name|dmPortContext
expr_stmt|;
if|if
condition|(
name|oldonePortContext
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPCompleted: old pid %d\n"
operator|,
name|oldonePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, oldonePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
comment|/* decrement the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|--
expr_stmt|;
comment|/* for port invalid case;      full discovery -> full discovery; incremental discovery -> full discovery    */
if|if
condition|(
name|onePortContext
operator|!=
name|oldonePortContext
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: portcontext has changed!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* stop SMP timer */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
operator|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* clean up expanders data strucures; move to free exp when device is cleaned */
name|dmCleanAllExp
argument_list|(
name|dmRoot
argument_list|,
name|oldonePortContext
argument_list|)
expr_stmt|;
comment|/* remove devices */
name|dmInternalRemovals
argument_list|(
name|dmRoot
argument_list|,
name|oldonePortContext
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
operator|||
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_COMPLETED
operator|||
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_SAS_DONE
operator|||
name|onePortContext
operator|->
name|DiscoveryAbortInProgress
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* stop SMP timer */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
operator|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|==
literal|0
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: aborting discovery\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_COMPLETED
operator|||
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_SAS_DONE
operator|||
name|onePortContext
operator|->
name|DiscoveryAbortInProgress
operator|==
name|agTRUE
condition|)
block|{
name|onePortContext
operator|->
name|DiscoveryAbortInProgress
operator|=
name|agFALSE
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|DM_DSTATE_COMPLETED
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_SAS_DONE
expr_stmt|;
name|dmCleanAllExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryAbortInProgress
operator|==
name|agTRUE
condition|)
block|{
name|tddmDiscoverCB
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
name|dmDiscAborted
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: not yet abort; non zero pendingSMP %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* stop SMP timer */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
operator|(
name|oldonePortContext
operator|->
name|discovery
operator|.
name|DiscoverySMPTimer
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|oneExpander
operator|->
name|SAS2
operator|==
literal|0
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: SAS 1.1\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|//tdhexdump("dmSMPCompleted", (bit8*)agFrameHandle, agIOInfoLen);
comment|/* parsing SMP payload */
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|#
directive|else
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|dmSMPResponseBody
operator|->
name|IndirectSMP
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|dmResponseSMPFrameHeader
operator|=
operator|(
name|dmSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
comment|/* SMP function dependent payload */
switch|switch
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
condition|)
block|{
case|case
name|SMP_REPORT_GENERAL
case|:
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: report general\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
operator|+
literal|4
operator|&&
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral_t
argument_list|)
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
comment|/* start here */
name|dmReportGeneralRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_DISCOVER
case|:
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: discover\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
operator|+
literal|4
operator|&&
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|dmDiscoverRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_PHY_SATA
case|:
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: report phy sata\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
operator|+
literal|4
operator|&&
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|unsigned
name|int
operator|)
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata_t
argument_list|)
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|dmReportPhySataRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_CONFIGURE_ROUTING_INFORMATION
case|:
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: configure routing information\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
literal|4
operator|&&
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|dmConfigRoutingInfoRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_PHY_CONTROL
case|:
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: phy control\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
literal|4
operator|&&
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
comment|/*zero length is expected */
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|dmPhyControlRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_ROUTING_INFORMATION
case|:
comment|/* fall through */
case|case
name|SMP_REPORT_PHY_ERROR_LOG
case|:
comment|/* fall through */
case|case
name|SMP_PHY_TEST_FUNCTION
case|:
comment|/* fall through */
case|case
name|SMP_REPORT_MANUFACTURE_INFORMATION
case|:
comment|/* fall through */
case|case
name|SMP_READ_GPIO_REGISTER
case|:
comment|/* fall through */
case|case
name|SMP_WRITE_GPIO_REGISTER
case|:
comment|/* fall through */
default|default:
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: wrong SMP function 0x%x !!!\n"
operator|,
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: smpFrameType 0x%x !!!\n"
operator|,
name|dmResponseSMPFrameHeader
operator|->
name|smpFrameType
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: smpFunctionResult 0x%x !!!\n"
operator|,
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: smpReserved 0x%x !!!\n"
operator|,
name|dmResponseSMPFrameHeader
operator|->
name|smpReserved
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"dmSMPCompleted: SMP payload !!!"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|agFrameHandle
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* switch */
block|}
comment|/* OSSA_IO_SUCCESS */
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_INVALID_LENGTH
condition|)
block|{
comment|/* no retry this case */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: OSSA_IO_ABORTED or OSSA_IO_INVALID_LENGTH, status 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ERROR_INTERNAL_SMP_RESOURCE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: OSSA_IO_ERROR_INTERNAL_SMP_RESOURCE\n"
operator|)
argument_list|)
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dmResponseSMPFrameHeader
operator|=
operator|(
name|dmSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
name|status
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|dmsaSMPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
comment|/* increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* start discovery-related SMP timer */
name|dmDiscoverySMPTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
argument_list|)
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmSMPBusyTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* For taskmanagement SMP, let's fail task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
block|}
else|else
block|{         }
block|}
else|else
comment|/* AGSA_RC_FAILURE */
block|{
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
block|}
else|else
block|{         }
block|}
block|}
comment|/* OSSA_IO_ERROR_INTERNAL_SMP_RESOURCE*/
else|else
block|{
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: setting back to operational\n"
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|&&
name|dmAllShared
operator|->
name|RateAdjust
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: SMPRequestFunction 0x%x\n"
operator|,
name|SMPRequestFunction
operator|)
argument_list|)
expr_stmt|;
name|ConnRate
operator|=
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConnRate
operator|==
name|SAS_CONNECTION_RATE_1_5G
condition|)
block|{
comment|/* no retry; failure ??? */
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{           }
block|}
else|else
block|{
name|ConnRate
operator|=
name|ConnRate
operator|-
literal|1
expr_stmt|;
block|}
name|agContext
operator|=
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|agContext
operator|)
expr_stmt|;
name|agContext
operator|->
name|osData
operator|=
name|agIORequest
expr_stmt|;
name|saSetDeviceInfo
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
literal|32
argument_list|,
name|ConnRate
operator|<<
literal|28
argument_list|,
name|dmSetDeviceInfoCB
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dmSMPRequestBody
operator|->
name|retries
operator|<
name|SMP_RETRIES
condition|)
comment|/* 5 */
block|{
comment|/* retry the SMP again */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: failed, but retries %d agIOStatus 0x%x %d agIOInfoLen %d !!!\n"
operator|,
name|dmSMPRequestBody
operator|->
name|retries
operator|,
name|agIOStatus
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dmResponseSMPFrameHeader
operator|=
operator|(
name|dmSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
name|status
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|dmsaSMPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
comment|/* increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
name|dmSMPRequestBody
operator|->
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* start discovery-related SMP timer */
name|dmDiscoverySMPTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
argument_list|)
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
name|dmSMPRequestBody
operator|->
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmSMPBusyTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* For taskmanagement SMP, let's fail task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
block|}
else|else
block|{             }
block|}
else|else
comment|/* AGSA_RC_FAILURE */
block|{
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
block|}
else|else
block|{             }
block|}
block|}
else|else
block|{
name|dmSMPFrameHeader
operator|=
operator|(
name|dmSMPFrameHeader_t
operator|*
operator|)
name|agSMPFrame
operator|->
name|outFrameBuf
expr_stmt|;
name|dmSMPPayload
operator|=
operator|(
name|bit8
operator|*
operator|)
name|agSMPFrame
operator|->
name|outFrameBuf
operator|+
literal|4
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: failed. no more retry. agIOStatus 0x%x %d !!!\n"
operator|,
name|agIOStatus
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: failed, agIOStatus is OSSA_IO_DS_NON_OPERATIONAL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: failed, agIOStatus is OSSA_IO_DS_IN_RECOVERY!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* discovery failure */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: SMP function 0x%x\n"
operator|,
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: discover done with error\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: SMP_PHY_CONTROL\n"
operator|)
argument_list|)
expr_stmt|;
name|smpPhyControlReq
operator|=
operator|(
name|smpReqPhyControl_t
operator|*
operator|)
name|dmSMPPayload
expr_stmt|;
if|if
condition|(
name|smpPhyControlReq
operator|->
name|phyOperation
operator|==
name|SMP_PHY_CONTROL_CLEAR_AFFILIATION
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: discover done with error\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: unknown phy operation 0x%x\n"
operator|,
name|smpPhyControlReq
operator|->
name|phyOperation
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* SMP_PHY_CONTROL */
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPCompleted: SMP function 0x%x\n"
operator|,
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* else */
block|}
comment|/* for RateAdjust */
block|}
comment|/* outer else */
block|}
comment|/* SAS 1.1 */
comment|/************************************     SAS 2     ***********************************************/
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSMPCompleted: SAS 2\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|//tdhexdump("dmSMPCompleted", (bit8*)agFrameHandle, agIOInfoLen);
comment|/* parsing SMP payload */
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|#
directive|else
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|dmSMPResponseBody
operator|->
name|IndirectSMP
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|dmResponseSMPFrameHeader
operator|=
operator|(
name|dmSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
comment|/* SMP function dependent payload */
switch|switch
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
condition|)
block|{
case|case
name|SMP_REPORT_GENERAL
case|:
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSMPCompleted: report general\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|agIOInfoLen
operator|!=
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral2_t
argument_list|)
operator|+
literal|4
operator|)
operator|&&
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: report general mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|smpRespReportGeneral2_t
argument_list|)
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|dmReportGeneral2RespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_DISCOVER
case|:
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSMPCompleted: discover\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|agIOInfoLen
operator|!=
sizeof|sizeof
argument_list|(
name|smpRespDiscover2_t
argument_list|)
operator|+
literal|4
operator|)
operator|&&
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: discover mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|smpRespDiscover2_t
argument_list|)
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|dmDiscover2RespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_REPORT_PHY_SATA
case|:
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSMPCompleted: report phy sata\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|agIOInfoLen
operator|!=
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata2_t
argument_list|)
operator|+
literal|4
operator|)
operator|&&
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: report phy sata mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|smpRespReportPhySata2_t
argument_list|)
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|dmReportPhySata2Rcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_CONFIGURE_ROUTING_INFORMATION
case|:
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSMPCompleted: configure routing information\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
literal|4
operator|&&
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: configure routing information mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|dmConfigRoutingInfo2RespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMP_PHY_CONTROL
case|:
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSMPCompleted: phy control\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
literal|4
operator|&&
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
comment|/*zero length is expected */
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: phy control mismatch len agIOInfoLen 0x%x 0x%x\n"
operator|,
name|agIOInfoLen
operator|,
literal|4
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|dmPhyControl2RespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|NOT_YET
case|case
name|SMP_DISCOVER_LIST
case|:
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: SMP_DISCOVER_LIST\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: agIOInfoLen 0x%x \n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdhexdump
argument_list|(
literal|"dmSMPCompleted"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|agFrameHandle
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
break|break;
endif|#
directive|endif
case|case
name|SMP_REPORT_ROUTING_INFORMATION
case|:
comment|/* fall through */
case|case
name|SMP_REPORT_PHY_ERROR_LOG
case|:
comment|/* fall through */
case|case
name|SMP_PHY_TEST_FUNCTION
case|:
comment|/* fall through */
case|case
name|SMP_REPORT_MANUFACTURE_INFORMATION
case|:
comment|/* fall through */
case|case
name|SMP_READ_GPIO_REGISTER
case|:
comment|/* fall through */
case|case
name|SMP_WRITE_GPIO_REGISTER
case|:
comment|/* fall through */
default|default:
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: wrong SMP function 0x%x\n"
operator|,
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: smpFrameType 0x%x\n"
operator|,
name|dmResponseSMPFrameHeader
operator|->
name|smpFrameType
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: smpFunctionResult 0x%x\n"
operator|,
name|dmResponseSMPFrameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: smpReserved 0x%x\n"
operator|,
name|dmResponseSMPFrameHeader
operator|->
name|smpReserved
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"dmSMPCompleted: SMP payload"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|agFrameHandle
argument_list|,
name|agIOInfoLen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* agIOStatus == OSSA_IO_SUCCESS */
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_INVALID_LENGTH
condition|)
block|{
comment|/* no retry this case */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: OSSA_IO_ABORTED or OSSA_IO_INVALID_LENGTH, status 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ERROR_INTERNAL_SMP_RESOURCE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: OSSA_IO_ERROR_INTERNAL_SMP_RESOURCE\n"
operator|)
argument_list|)
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dmResponseSMPFrameHeader
operator|=
operator|(
name|dmSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
name|status
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|dmsaSMPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
comment|/* increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* start discovery-related SMP timer */
name|dmDiscoverySMPTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
argument_list|)
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmSMPBusyTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* For taskmanagement SMP, let's fail task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
block|}
else|else
block|{         }
block|}
else|else
comment|/* AGSA_RC_FAILURE */
block|{
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
block|}
else|else
block|{         }
block|}
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*          skip to the next expander       */
name|dmHandleZoneViolation
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: setting back to operational\n"
operator|)
argument_list|)
expr_stmt|;
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|&&
name|dmAllShared
operator|->
name|RateAdjust
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: SMPRequestFunction 0x%x\n"
operator|,
name|SMPRequestFunction
operator|)
argument_list|)
expr_stmt|;
name|ConnRate
operator|=
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConnRate
operator|==
name|SAS_CONNECTION_RATE_1_5G
condition|)
block|{
comment|/* no retry; failure ??? */
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{           }
block|}
else|else
block|{
name|ConnRate
operator|=
name|ConnRate
operator|-
literal|1
expr_stmt|;
block|}
name|agContext
operator|=
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|agContext
operator|)
expr_stmt|;
name|agContext
operator|->
name|osData
operator|=
name|agIORequest
expr_stmt|;
name|saSetDeviceInfo
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
literal|32
argument_list|,
name|ConnRate
operator|<<
literal|28
argument_list|,
name|dmSetDeviceInfoCB
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dmSMPRequestBody
operator|->
name|retries
operator|<
name|SMP_RETRIES
condition|)
comment|/* 5 */
block|{
comment|/* retry the SMP again */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: failed! but retries %d agIOStatus 0x%x %d agIOInfoLen %d\n"
operator|,
name|dmSMPRequestBody
operator|->
name|retries
operator|,
name|agIOStatus
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dmResponseSMPFrameHeader
operator|=
operator|(
name|dmSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
name|status
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|dmsaSMPCompleted
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
comment|/* increment the number of pending SMP */
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
name|dmSMPRequestBody
operator|->
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|SMPRequestFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|SMPRequestFunction
operator|==
name|SMP_DISCOVER
operator|||
name|SMPRequestFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|SMPRequestFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* start discovery-related SMP timer */
name|dmDiscoverySMPTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
call|(
name|bit32
call|)
argument_list|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
argument_list|)
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|++
expr_stmt|;
name|dmSMPRequestBody
operator|->
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmSMPBusyTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* For taskmanagement SMP, let's fail task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
block|}
else|else
block|{             }
block|}
else|else
comment|/* AGSA_RC_FAILURE */
block|{
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmResponseSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
comment|/* task management failure */
name|dmPhyControlFailureRespRcvd
argument_list|(
name|dmRoot
argument_list|,
name|agRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|dmResponseSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
block|}
else|else
block|{             }
block|}
block|}
else|else
block|{
name|dmSMPFrameHeader
operator|=
operator|(
name|dmSMPFrameHeader_t
operator|*
operator|)
name|agSMPFrame
operator|->
name|outFrameBuf
expr_stmt|;
name|dmSMPPayload
operator|=
operator|(
name|bit8
operator|*
operator|)
name|agSMPFrame
operator|->
name|outFrameBuf
operator|+
literal|4
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: failed! no more retry! agIOStatus 0x%x %d\n"
operator|,
name|agIOStatus
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: failed! agIOStatus is OSSA_IO_DS_NON_OPERATIONAL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: failed! agIOStatus is OSSA_IO_DS_IN_RECOVERY\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_GENERAL
operator|||
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_DISCOVER
operator|||
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_REPORT_PHY_SATA
operator|||
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_CONFIGURE_ROUTING_INFORMATION
condition|)
block|{
comment|/* discovery failure */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: SMP function 0x%x\n"
operator|,
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: discover done with error\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: SMP_PHY_CONTROL\n"
operator|)
argument_list|)
expr_stmt|;
name|smpPhyControl2Req
operator|=
operator|(
name|smpReqPhyControl2_t
operator|*
operator|)
name|dmSMPPayload
expr_stmt|;
if|if
condition|(
name|smpPhyControl2Req
operator|->
name|phyOperation
operator|==
name|SMP_PHY_CONTROL_CLEAR_AFFILIATION
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: discover done with error\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: unknown phy operation 0x%x\n"
operator|,
name|smpPhyControl2Req
operator|->
name|phyOperation
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* SMP_PHY_CONTROL */
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: SMP function 0x%x\n"
operator|,
name|dmSMPFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* else */
block|}
comment|/* for RateAdjust */
block|}
comment|/* outer else */
block|}
comment|/* SAS 2 else */
comment|/* SMP request */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
comment|/* SMP response */
name|dmSMPResponseBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|dmSMPRequestBody
operator|->
name|IndirectSMPResponse
expr_stmt|;
if|if
condition|(
name|dmSMPResponseBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPCompleted: Wrong, dmSMPResponseBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPResponseBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmSMPAbortCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|dmRoot_t
modifier|*
name|dmRoot
init|=
name|agNULL
decl_stmt|;
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
name|agNULL
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
name|agNULL
decl_stmt|;
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
init|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
decl_stmt|;
name|DM_DBG5
argument_list|(
operator|(
literal|"dmSMPAbortCB: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmSMPRequestBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPAbortCB: pSMPRequestBody is NULL!!! \n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|dmRoot
operator|=
name|dmSMPRequestBody
operator|->
name|dmRoot
expr_stmt|;
name|dmIntRoot
operator|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
expr_stmt|;
name|dmAllShared
operator|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
expr_stmt|;
comment|/* put back into free smplist */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|Link
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
comment|/* start here */
if|if
condition|(
name|flag
operator|==
literal|2
condition|)
block|{
comment|/* abort all per port */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPAbortCB: abort per port; not used!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|1
condition|)
block|{
comment|/* abort all */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPAbortCB: abort all; not used!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|0
condition|)
block|{
comment|/* abort one */
name|DM_DBG1
argument_list|(
operator|(
literal|"ossaSMPAbortCB: abort one\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPAbortCB: abort one, status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmSMPAbortCB: not allowed case, flag 0x%x!!!\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FDS_DM */
end_comment

end_unit


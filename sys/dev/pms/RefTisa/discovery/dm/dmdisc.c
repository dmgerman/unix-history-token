begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* ** *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE ** ********************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/dm/dmdefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/dm/dmtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/dm/dmproto.h>
end_include

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief dmDiscover  *    *  *  Purpose: A discovery is started by this function   *    *  \param   dmRoot:              DM context handle.  *  \param   dmPortContext:       Pointer to this instance of port context   *  \param   option:              Discovery option   *   *  \return:   *          DM_RC_SUCCESS  *          DM_RC_FAILURE  *  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|dmDiscover
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmPortContext_t
modifier|*
name|dmPortContext
parameter_list|,
name|bit32
name|option
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ret
init|=
name|DM_RC_FAILURE
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscover: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|dmPortContext
operator|->
name|dmData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscover: onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscover: invalid port!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|RegFailed
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscover: Registration failed!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
switch|switch
condition|(
name|option
condition|)
block|{
case|case
name|DM_DISCOVERY_OPTION_FULL_START
case|:
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscover: full, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|=
name|DM_DISCOVERY_OPTION_FULL_START
expr_stmt|;
name|dmDiscoveryResetMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dmFullDiscover
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
case|:
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscover: incremental, pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|=
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
expr_stmt|;
name|dmDiscoveryResetMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dmIncrementalDiscover
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
break|break;
case|case
name|DM_DISCOVERY_OPTION_ABORT
case|:
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscover: abort\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|!=
name|DM_DSTATE_COMPLETED
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|pendingSMP
operator|==
literal|0
condition|)
block|{
name|dmDiscoverAbort
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|tddmDiscoverCB
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
name|dmDiscAborted
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscover: abortInProgress\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryAbortInProgress
operator|=
name|agTRUE
expr_stmt|;
name|tddmDiscoverCB
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|dmDiscAbortInProgress
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscover: no discovery to abort\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmDiscoverCB
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|dmDiscAbortInvalid
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|DM_RC_SUCCESS
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|dmFullDiscover
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|dmSASSubID_t
name|dmSASSubID
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneExpDeviceData
init|=
name|agNULL
decl_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmFullDiscover: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmFullDiscover: invalid port!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_STARTED
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmFullDiscover: no two instances of discovery allowed!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|DM_DSTATE_STARTED
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressHi
operator|=
name|onePortContext
operator|->
name|sasRemoteAddressHi
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressLo
operator|=
name|onePortContext
operator|->
name|sasRemoteAddressLo
expr_stmt|;
comment|/* check OnePortContext->discovery.discoveringExpanderList */
name|oneExpander
operator|=
name|dmExpFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|dmSASSubID
operator|.
name|sasAddressHi
argument_list|,
name|dmSASSubID
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|oneExpDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
block|}
else|else
block|{
comment|/* check dmAllShared->mainExpanderList */
name|oneExpander
operator|=
name|dmExpMainListFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|dmSASSubID
operator|.
name|sasAddressHi
argument_list|,
name|dmSASSubID
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|oneExpDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
block|}
block|}
if|if
condition|(
name|oneExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|oneExpDeviceData
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|oneExpDeviceData
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneExpDeviceData
operator|->
name|registered
operator|=
name|agTRUE
expr_stmt|;
name|dmAddSASToSharedcontext
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|,
name|oneExpDeviceData
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmFullDiscover:oneExpDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
name|dmUpStreamDiscoverStart
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return
name|DM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|dmIncrementalDiscover
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|dmSASSubID_t
name|dmSASSubID
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneExpDeviceData
init|=
name|agNULL
decl_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmIncrementalDiscover: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmIncrementalDiscover: invalid port!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
comment|/* TDM triggerred; let go DM triggerred */
if|if
condition|(
name|flag
operator|==
name|agFALSE
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_STARTED
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmIncrementalDiscover: no two instances of discovery allowed!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
block|}
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|DM_DSTATE_STARTED
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|=
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressHi
operator|=
name|onePortContext
operator|->
name|sasRemoteAddressHi
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressLo
operator|=
name|onePortContext
operator|->
name|sasRemoteAddressLo
expr_stmt|;
comment|/* check OnePortContext->discovery.discoveringExpanderList */
name|oneExpander
operator|=
name|dmExpFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|dmSASSubID
operator|.
name|sasAddressHi
argument_list|,
name|dmSASSubID
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|oneExpDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
block|}
else|else
block|{
comment|/* check dmAllShared->mainExpanderList */
name|oneExpander
operator|=
name|dmExpMainListFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|dmSASSubID
operator|.
name|sasAddressHi
argument_list|,
name|dmSASSubID
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|oneExpDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
block|}
block|}
if|if
condition|(
name|oneExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|oneExpDeviceData
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|oneExpDeviceData
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneExpDeviceData
operator|->
name|registered
operator|=
name|agTRUE
expr_stmt|;
name|dmAddSASToSharedcontext
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|,
name|oneExpDeviceData
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmIncrementalDiscover:oneExpDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
name|dmUpStreamDiscoverStart
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return
name|DM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmUpStreamDiscoverStart
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
comment|//  dmExpander_t              *oneExpander = agNULL;
name|bit32
name|sasAddressHi
decl_stmt|,
name|sasAddressLo
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverStart: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverStart: invalid port!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     at this point, the 1st expander should have been registered.     find an expander from onePortContext    */
name|sasAddressHi
operator|=
name|onePortContext
operator|->
name|sasRemoteAddressHi
expr_stmt|;
name|sasAddressLo
operator|=
name|onePortContext
operator|->
name|sasRemoteAddressLo
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverStart: Port Remote AddrHi 0x%08x Remote AddrLo 0x%08x\n"
operator|,
name|sasAddressHi
operator|,
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|dmDeviceFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasAddressHi
argument_list|,
name|sasAddressLo
argument_list|)
expr_stmt|;
comment|//  oneDeviceData = oneExpander->dmDevice;
comment|// start here
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_UP_STREAM
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverStart: oneExpander is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
operator|||
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
if|#
directive|if
literal|1
comment|/* for incremental discovery */
comment|/* start here: if not on discoveringExpanderList, alloc and add        dmNewEXPorNot()       */
name|oneExpander
operator|=
name|dmExpFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasAddressHi
argument_list|,
name|sasAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
comment|/* alloc and add */
name|oneExpander
operator|=
name|dmDiscoveringExpanderAlloc
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverStart: failed to allocate expander or discovey aborted!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
endif|#
directive|endif
name|dmUpStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverStart: oneDeviceData is not an Expander did %d, wrong!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/* sends report general */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmUpStreamDiscovering
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|dmList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneNextExpander
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscovering: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscovering: invalid port!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscovering: should be the end\n"
operator|)
argument_list|)
expr_stmt|;
name|oneNextExpander
operator|=
name|agNULL
expr_stmt|;
block|}
else|else
block|{
name|DMLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|ExpanderList
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
name|oneNextExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneNextExpander
operator|!=
name|agNULL
condition|)
block|{
name|DMLIST_ENQUEUE_AT_HEAD
argument_list|(
operator|&
operator|(
name|oneNextExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscovering tdsaSASUpStreamDiscovering: dequeue head\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscovering: expander id %d\n"
operator|,
name|oneNextExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscovering: oneNextExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneNextExpander
operator|!=
name|agNULL
condition|)
block|{
name|dmReportGeneralSend
argument_list|(
name|dmRoot
argument_list|,
name|oneNextExpander
operator|->
name|dmDevice
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscovering: No more expander list\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDownStreamDiscoverStart
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDownStreamDiscoverStart
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|dmExpander_t
modifier|*
name|UpStreamExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverStart: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverStart: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* set discovery status */
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_DOWN_STREAM
expr_stmt|;
comment|/* If it's an expander */
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
operator|||
name|DEVICE_IS_SMP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
comment|/* If the two expanders are the root of two edge sets; sub-to-sub */
if|if
condition|(
operator|(
name|UpStreamExpander
operator|!=
name|agNULL
operator|)
operator|&&
operator|(
name|UpStreamExpander
operator|->
name|dmUpStreamExpander
operator|==
name|oneExpander
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverStart: Root found pExpander=%p pUpStreamExpander=%p\n"
operator|,
name|oneExpander
operator|,
name|UpStreamExpander
operator|)
argument_list|)
expr_stmt|;
comment|//Saves the root expander
name|onePortContext
operator|->
name|discovery
operator|.
name|RootExp
operator|=
name|oneExpander
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverStart: Root exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverStart: Root exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* reset up stream inform for pExpander */
name|oneExpander
operator|->
name|dmUpStreamExpander
operator|=
name|agNULL
expr_stmt|;
comment|/* Add the pExpander to discovering list */
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* reset up stream inform for oneExpander */
name|UpStreamExpander
operator|->
name|dmUpStreamExpander
operator|=
name|agNULL
expr_stmt|;
comment|/* Add the UpStreamExpander to discovering list */
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|UpStreamExpander
argument_list|)
expr_stmt|;
block|}
comment|/* If the two expanders are not the root of two edge sets. eg) one root */
else|else
block|{
comment|//Saves the root expander
name|onePortContext
operator|->
name|discovery
operator|.
name|RootExp
operator|=
name|oneExpander
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverStart: NO Root pExpander=%p\n"
operator|,
name|oneExpander
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverStart: Root exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverStart: Root exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* (2.2.2.1) Add the pExpander to discovering list */
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Continue down stream discovering */
name|dmDownStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDownStreamDiscovering
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|dmExpander_t
modifier|*
name|NextExpander
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: should be the end\n"
operator|)
argument_list|)
expr_stmt|;
name|NextExpander
operator|=
name|agNULL
expr_stmt|;
block|}
else|else
block|{
name|DMLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|ExpanderList
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
empty_stmt|;
name|NextExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|NextExpander
operator|!=
name|agNULL
condition|)
block|{
name|DMLIST_ENQUEUE_AT_HEAD
argument_list|(
operator|&
operator|(
name|NextExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
empty_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering tdsaSASDownStreamDiscovering: dequeue head\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: expander id %d\n"
operator|,
name|NextExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: NextExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
comment|/* If there is an expander for continue discoving */
if|if
condition|(
name|NextExpander
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: Found pNextExpander=%p discoveryStatus=0x%x\n"
operator|,
name|NextExpander
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
condition|)
block|{
comment|/* If the discovery status is DISCOVERY_DOWN_STREAM */
case|case
name|DISCOVERY_DOWN_STREAM
case|:
comment|/* Send report general for the next expander */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: DownStream pNextExpander=%p\n"
operator|,
name|NextExpander
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: oneExpander %p did %d\n"
operator|,
name|oneDeviceData
operator|->
name|dmExpander
operator|,
name|oneDeviceData
operator|->
name|dmExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: 2nd oneDeviceData %p did %d\n"
operator|,
name|NextExpander
operator|->
name|dmDevice
operator|,
name|NextExpander
operator|->
name|dmDevice
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: 2nd oneExpander %p did %d\n"
operator|,
name|NextExpander
operator|,
name|NextExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: 2nd used oneExpander %p did %d\n"
operator|,
name|NextExpander
operator|->
name|dmDevice
operator|->
name|dmExpander
operator|,
name|NextExpander
operator|->
name|dmDevice
operator|->
name|dmExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|NextExpander
operator|!=
name|NextExpander
operator|->
name|dmDevice
operator|->
name|dmExpander
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|dmReportGeneralSend
argument_list|(
name|dmRoot
argument_list|,
name|NextExpander
operator|->
name|dmDevice
argument_list|)
expr_stmt|;
break|break;
comment|/* If the discovery status is DISCOVERY_CONFIG_ROUTING */
case|case
name|DISCOVERY_CONFIG_ROUTING
case|:
case|case
name|DISCOVERY_REPORT_PHY_SATA
case|:
comment|/* set discovery status */
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_DOWN_STREAM
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: pPort->discovery.status=DISCOVERY_CONFIG_ROUTING, make it DOWN_STREAM\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* If not the last phy */
if|if
condition|(
name|NextExpander
operator|->
name|discoveringPhyId
operator|<
name|NextExpander
operator|->
name|dmDevice
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: pNextExpander->discoveringPhyId=0x%x pNextExpander->numOfPhys=0x%x.  Send More Discover\n"
operator|,
name|NextExpander
operator|->
name|discoveringPhyId
operator|,
name|NextExpander
operator|->
name|dmDevice
operator|->
name|numOfPhys
operator|)
argument_list|)
expr_stmt|;
comment|/* Send discover for the next expander */
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|NextExpander
operator|->
name|dmDevice
argument_list|)
expr_stmt|;
block|}
comment|/* If it's the last phy */
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: Last Phy, remove expander%p  start DownStream=%p\n"
operator|,
name|NextExpander
operator|,
name|NextExpander
operator|->
name|dmDevice
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|NextExpander
argument_list|)
expr_stmt|;
name|dmDownStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|NextExpander
operator|->
name|dmDevice
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: *** Unknown pPort->discovery.status=0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If no expander for continue discoving */
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscovering: No more expander DONE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* discover done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_SUCCESS
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmUpStreamDiscoverExpanderPhy
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|smpRespDiscover_t
modifier|*
name|pDiscoverResp
parameter_list|)
block|{
name|agsaSASIdentify_t
name|sasIdentify
decl_stmt|;
name|dmSASSubID_t
name|dmSASSubID
decl_stmt|;
name|bit32
name|attachedSasHi
decl_stmt|,
name|attachedSasLo
decl_stmt|;
name|dmExpander_t
modifier|*
name|AttachedExpander
init|=
name|agNULL
decl_stmt|;
name|bit8
name|connectionRate
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|AttachedDevice
init|=
name|agNULL
decl_stmt|;
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneExpander
operator|!=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|dmExpander
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|dm_memset
argument_list|(
operator|&
name|sasIdentify
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASIdentify_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: Phy #%d of SAS %08x-%08x\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   Attached device: %s\n"
operator|,
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|0
condition|?
literal|"No Device"
else|:
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|1
condition|?
literal|"End Device"
else|:
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|2
condition|?
literal|"Edge Expander"
else|:
literal|"Fanout Expander"
operator|)
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"   SAS address    : %08x-%08x\n"
operator|,
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
operator|,
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   SSP Target     : %d\n"
operator|,
name|DISCRSP_IS_SSP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   STP Target     : %d\n"
operator|,
name|DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   SMP Target     : %d\n"
operator|,
name|DISCRSP_IS_SMP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   SATA DEVICE    : %d\n"
operator|,
name|DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   SSP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_SSP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   STP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_STP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   SMP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   Phy ID         : %d\n"
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   Attached Phy ID: %d\n"
operator|,
name|pDiscoverResp
operator|->
name|attachedPhyIdentifier
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* for debugging */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|!=
name|pDiscoverResp
operator|->
name|phyIdentifier
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: !!! Incorrect SMP response !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: Request PhyID #%d Response PhyID #%d !!!\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"NO_DEVICE"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* saving routing attribute for non self-configuring expanders */
name|oneExpander
operator|->
name|routingAttribute
index|[
name|pDiscoverResp
operator|->
name|phyIdentifier
index|]
operator|=
operator|(
name|bit8
operator|)
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: SA_SAS_DEV_TYPE_FANOUT_EXPANDER\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: **** Topology Error subtractive routing on fanout expander device!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery error */
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* (2.1.3) discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: SA_SAS_DEV_TYPE_EDGE_EXPANDER\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
comment|/* Setup sasIdentify for the attached device */
name|sasIdentify
operator|.
name|phyIdentifier
operator|=
name|pDiscoverResp
operator|->
name|phyIdentifier
expr_stmt|;
name|sasIdentify
operator|.
name|deviceType_addressFrameType
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pDiscoverResp
operator|->
name|attachedDeviceType
operator|&
literal|0x70
argument_list|)
expr_stmt|;
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_Ssp_Stp_Smp_Sata_Initiator
expr_stmt|;
name|sasIdentify
operator|.
name|target_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_SataPS_Ssp_Stp_Smp_Sata_Target
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressHi
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressHi
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressLo
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressLo
expr_stmt|;
comment|/* incremental discovery */
name|dmSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
expr_stmt|;
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|target_ssp_stp_smp
expr_stmt|;
name|attachedSasHi
operator|=
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
name|attachedSasLo
operator|=
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
comment|/* If the phy has subtractive routing attribute */
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: SA_SAS_ROUTING_SUBTRACTIVE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup upstream phys */
name|dmExpanderUpStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|oneExpander
argument_list|,
operator|(
name|bit8
operator|)
name|pDiscoverResp
operator|->
name|attachedPhyIdentifier
argument_list|)
expr_stmt|;
comment|/* If the expander already has an upsteam device set up */
if|if
condition|(
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|==
name|agTRUE
condition|)
block|{
comment|/* just to update MCN */
name|dmPortSASDeviceFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|attachedSasLo
argument_list|,
name|attachedSasHi
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* If the sas address doesn't match */
if|if
condition|(
operator|(
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressHi
operator|!=
name|attachedSasHi
operator|)
operator|||
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressLo
operator|!=
name|attachedSasLo
operator|)
operator|)
operator|&&
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|||
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: **** Topology Error subtractive routing error - inconsistent SAS address!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* call back to notify discovery error */
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Setup SAS address for up stream device */
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|=
name|agTRUE
expr_stmt|;
name|oneExpander
operator|->
name|upStreamSASAddressHi
operator|=
name|attachedSasHi
expr_stmt|;
name|oneExpander
operator|->
name|upStreamSASAddressLo
operator|=
name|attachedSasLo
expr_stmt|;
if|if
condition|(
operator|(
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|!=
name|attachedSasHi
operator|)
operator|||
operator|(
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|!=
name|attachedSasLo
operator|)
condition|)
block|{
comment|/* Find the device from the discovered list */
name|AttachedDevice
operator|=
name|dmPortSASDeviceFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|attachedSasLo
argument_list|,
name|attachedSasHi
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* New device, If the device has been discovered before */
if|if
condition|(
name|AttachedDevice
operator|!=
name|agNULL
condition|)
comment|/* old device */
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: Seen This Device Before\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* If attached device is an edge expander */
if|if
condition|(
name|AttachedDevice
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
comment|/* The attached device is an expander */
name|AttachedExpander
operator|=
name|AttachedDevice
operator|->
name|dmExpander
expr_stmt|;
comment|/* If the two expanders are the root of the two edge expander sets */
if|if
condition|(
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressHi
operator|==
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|&&
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressLo
operator|==
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* Setup upstream expander for the pExpander */
name|oneExpander
operator|->
name|dmUpStreamExpander
operator|=
name|AttachedExpander
expr_stmt|;
block|}
comment|/* If the two expanders are not the root of the two edge expander sets */
else|else
block|{
comment|/* TODO: loop found, discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: **** Topology Error loop detection!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If attached device is not an edge expander */
else|else
block|{
comment|/*TODO: should not happen, ASSERT */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy, *** Attached Device is not Edge. Confused!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* AttachedExpander != agNULL */
comment|/* New device, If the device has not been discovered before */
else|else
comment|/* new device */
block|{
comment|/* Add the device */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: New device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* read minimum rate from the configuration                   onePortContext->LinkRate is SPC's local link rate               */
name|connectionRate
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|onePortContext
operator|->
name|LinkRate
argument_list|,
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: link rate 0x%x\n"
operator|,
name|onePortContext
operator|->
name|LinkRate
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: negotiatedPhyLinkRate 0x%x\n"
operator|,
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: connectionRate 0x%x\n"
operator|,
name|connectionRate
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
comment|/* incremental discovery */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|dmFindRegNValid
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* DISCRSP_IS_STP_TARGET(pDiscoverResp) || DISCRSP_IS_SATA_DEVICE(pDiscoverResp) */
else|else
block|{
comment|/* incremental discovery */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|dmFindRegNValid
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* If the device is added successfully */
if|if
condition|(
name|AttachedDevice
operator|!=
name|agNULL
condition|)
block|{
comment|/* (3.1.2.3.2.3.2.1) callback about new device */
if|if
condition|(
name|DISCRSP_IS_SSP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SSP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: Found SSP/SMP SAS %08x-%08x\n"
operator|,
name|attachedSasHi
operator|,
name|attachedSasLo
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: Found a SAS STP device.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* If the attached device is an expander */
if|if
condition|(
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
condition|)
block|{
comment|/* Allocate an expander data structure */
name|AttachedExpander
operator|=
name|dmDiscoveringExpanderAlloc
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedDevice
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: Found expander=%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* If allocate successfully */
if|if
condition|(
name|AttachedExpander
operator|!=
name|agNULL
condition|)
block|{
comment|/* Add the pAttachedExpander to discovering list */
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|)
expr_stmt|;
comment|/* Setup upstream expander for the pExpander */
name|oneExpander
operator|->
name|dmUpStreamExpander
operator|=
name|AttachedExpander
expr_stmt|;
block|}
comment|/* If failed to allocate */
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: Failed to allocate expander data structure!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If the attached device is an end device */
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: Found end device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* LP2006-05-26 added upstream device to the newly found device */
name|AttachedDevice
operator|->
name|dmExpander
operator|=
name|oneExpander
expr_stmt|;
name|oneExpander
operator|->
name|dmUpStreamExpander
operator|=
name|agNULL
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: Failed to add a device!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* else, new device */
block|}
comment|/* onePortContext->sasLocalAddressLo != attachedSasLo */
block|}
comment|/* else */
block|}
comment|/* DISCRSP_GET_ROUTINGATTRIB(pDiscoverResp) == SAS_ROUTING_SUBTRACTIVE */
block|}
comment|/* DISCRSP_GET_ATTACHED_DEVTYPE(pDiscoverResp) != SAS_NO_DEVICE */
block|}
comment|/* big else */
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: DISCOVERY_UP_STREAM find more ...\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: DISCOVERY_UP_STREAM last phy continue upstream..\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* for MCN */
name|dmUpdateAllAdjacent
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue upstream discovering */
name|dmUpStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: onePortContext->discovery.status not in DISCOVERY_UP_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhy: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmUpStreamDiscover2ExpanderPhy
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|smpRespDiscover2_t
modifier|*
name|pDiscoverResp
parameter_list|)
block|{
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|AttachedDevice
init|=
name|agNULL
decl_stmt|;
name|dmExpander_t
modifier|*
name|AttachedExpander
decl_stmt|;
name|agsaSASIdentify_t
name|sasIdentify
decl_stmt|;
name|bit8
name|connectionRate
decl_stmt|;
name|bit32
name|attachedSasHi
decl_stmt|,
name|attachedSasLo
decl_stmt|;
name|dmSASSubID_t
name|dmSASSubID
decl_stmt|;
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneExpander
operator|!=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|dmExpander
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|dm_memset
argument_list|(
operator|&
name|sasIdentify
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASIdentify_t
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: Phy #%d of SAS %08x-%08x\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   Attached device: %s\n"
operator|,
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|0
condition|?
literal|"No Device"
else|:
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|1
condition|?
literal|"End Device"
else|:
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|2
condition|?
literal|"Edge Expander"
else|:
literal|"Fanout Expander"
operator|)
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"   SAS address    : %08x-%08x\n"
operator|,
name|SAS2_DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
operator|,
name|SAS2_DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   SSP Target     : %d\n"
operator|,
name|SAS2_DISCRSP_IS_SSP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   STP Target     : %d\n"
operator|,
name|SAS2_DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   SMP Target     : %d\n"
operator|,
name|SAS2_DISCRSP_IS_SMP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   SATA DEVICE    : %d\n"
operator|,
name|SAS2_DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   SSP Initiator  : %d\n"
operator|,
name|SAS2_DISCRSP_IS_SSP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   STP Initiator  : %d\n"
operator|,
name|SAS2_DISCRSP_IS_STP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   SMP Initiator  : %d\n"
operator|,
name|SAS2_DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   Phy ID         : %d\n"
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   Attached Phy ID: %d\n"
operator|,
name|pDiscoverResp
operator|->
name|attachedPhyIdentifier
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|!=
name|pDiscoverResp
operator|->
name|phyIdentifier
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: !!! Incorrect SMP response !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: Request PhyID #%d Response PhyID #%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"NO_DEVICE"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover2_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* saving routing attribute for non self-configuring expanders */
name|oneExpander
operator|->
name|routingAttribute
index|[
name|pDiscoverResp
operator|->
name|phyIdentifier
index|]
operator|=
name|SAS2_DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: SA_SAS_DEV_TYPE_FANOUT_EXPANDER\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SAS2_DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: **** Topology Error subtractive routing on fanout expander device!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery error */
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* (2.1.3) discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: SA_SAS_DEV_TYPE_EDGE_EXPANDER\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
comment|/* Setup sasIdentify for the attached device */
name|sasIdentify
operator|.
name|phyIdentifier
operator|=
name|pDiscoverResp
operator|->
name|phyIdentifier
expr_stmt|;
name|sasIdentify
operator|.
name|deviceType_addressFrameType
operator|=
name|pDiscoverResp
operator|->
name|attachedDeviceTypeReason
operator|&
literal|0x70
expr_stmt|;
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_Ssp_Stp_Smp_Sata_Initiator
expr_stmt|;
name|sasIdentify
operator|.
name|target_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_SataPS_Ssp_Stp_Smp_Sata_Target
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressHi
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressHi
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressLo
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressLo
expr_stmt|;
comment|/* incremental discovery */
name|dmSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
expr_stmt|;
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|target_ssp_stp_smp
expr_stmt|;
name|attachedSasHi
operator|=
name|SAS2_DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
name|attachedSasLo
operator|=
name|SAS2_DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
comment|/* If the phy has subtractive routing attribute */
if|if
condition|(
name|SAS2_DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: SA_SAS_ROUTING_SUBTRACTIVE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Setup upstream phys */
name|dmExpanderUpStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|oneExpander
argument_list|,
operator|(
name|bit8
operator|)
name|pDiscoverResp
operator|->
name|attachedPhyIdentifier
argument_list|)
expr_stmt|;
comment|/* If the expander already has an upsteam device set up */
if|if
condition|(
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|==
name|agTRUE
condition|)
block|{
comment|/* just to update MCN */
name|dmPortSASDeviceFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|attachedSasLo
argument_list|,
name|attachedSasHi
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* If the sas address doesn't match */
if|if
condition|(
operator|(
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressHi
operator|!=
name|attachedSasHi
operator|)
operator|||
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressLo
operator|!=
name|attachedSasLo
operator|)
operator|)
operator|&&
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|||
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: **** Topology Error subtractive routing error - inconsistent SAS address!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* call back to notify discovery error */
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Setup SAS address for up stream device */
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|=
name|agTRUE
expr_stmt|;
name|oneExpander
operator|->
name|upStreamSASAddressHi
operator|=
name|attachedSasHi
expr_stmt|;
name|oneExpander
operator|->
name|upStreamSASAddressLo
operator|=
name|attachedSasLo
expr_stmt|;
if|if
condition|(
operator|(
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|!=
name|attachedSasHi
operator|)
operator|||
operator|(
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|!=
name|attachedSasLo
operator|)
condition|)
block|{
comment|/* Find the device from the discovered list */
name|AttachedDevice
operator|=
name|dmPortSASDeviceFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|attachedSasLo
argument_list|,
name|attachedSasHi
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* If the device has been discovered before */
if|if
condition|(
name|AttachedDevice
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: Seen This Device Before\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* If attached device is an edge expander */
if|if
condition|(
name|AttachedDevice
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
comment|/* The attached device is an expander */
name|AttachedExpander
operator|=
name|AttachedDevice
operator|->
name|dmExpander
expr_stmt|;
comment|/* If the two expanders are the root of the two edge expander sets */
if|if
condition|(
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressHi
operator|==
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|&&
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressLo
operator|==
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* Setup upstream expander for the pExpander */
name|oneExpander
operator|->
name|dmUpStreamExpander
operator|=
name|AttachedExpander
expr_stmt|;
block|}
comment|/* If the two expanders are not the root of the two edge expander sets */
else|else
block|{
comment|/* TODO: loop found, discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: **** Topology Error loop detection!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If attached device is not an edge expander */
else|else
block|{
comment|/*TODO: should not happen, ASSERT */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy, *** Attached Device is not Edge. Confused!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If the device has not been discovered before */
else|else
block|{
comment|/* Add the device */
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: New device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* read minimum rate from the configuration                   onePortContext->LinkRate is SPC's local link rate               */
name|connectionRate
operator|=
name|MIN
argument_list|(
name|onePortContext
operator|->
name|LinkRate
argument_list|,
name|SAS2_DISCRSP_GET_LOGICAL_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: link rate 0x%x\n"
operator|,
name|onePortContext
operator|->
name|LinkRate
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: negotiatedPhyLinkRate 0x%x\n"
operator|,
name|SAS2_DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: connectionRate 0x%x\n"
operator|,
name|connectionRate
operator|)
argument_list|)
expr_stmt|;
comment|//hhhhhhhh
if|if
condition|(
name|SAS2_DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|SAS2_DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
comment|/* incremental discovery */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|dmFindRegNValid
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* incremental discovery */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|dmFindRegNValid
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* If the device is added successfully */
if|if
condition|(
name|AttachedDevice
operator|!=
name|agNULL
condition|)
block|{
comment|/* (3.1.2.3.2.3.2.1) callback about new device */
if|if
condition|(
name|SAS2_DISCRSP_IS_SSP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|SAS2_DISCRSP_IS_SSP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|SAS2_DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|SAS2_DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: Found SSP/SMP SAS %08x-%08x\n"
operator|,
name|attachedSasHi
operator|,
name|attachedSasLo
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: Found a SAS STP device.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* If the attached device is an expander */
if|if
condition|(
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
condition|)
block|{
comment|/* Allocate an expander data structure */
name|AttachedExpander
operator|=
name|dmDiscoveringExpanderAlloc
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedDevice
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: Found expander=%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* If allocate successfully */
if|if
condition|(
name|AttachedExpander
operator|!=
name|agNULL
condition|)
block|{
comment|/* Add the pAttachedExpander to discovering list */
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|)
expr_stmt|;
comment|/* Setup upstream expander for the pExpander */
name|oneExpander
operator|->
name|dmUpStreamExpander
operator|=
name|AttachedExpander
expr_stmt|;
block|}
comment|/* If failed to allocate */
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy, Failed to allocate expander data structure!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If the attached device is an end device */
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: Found end device\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* LP2006-05-26 added upstream device to the newly found device */
name|AttachedDevice
operator|->
name|dmExpander
operator|=
name|oneExpander
expr_stmt|;
name|oneExpander
operator|->
name|dmUpStreamExpander
operator|=
name|agNULL
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy, Failed to add a device!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
comment|/* substractive routing */
block|}
block|}
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: DISCOVERY_UP_STREAM find more ...\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: DISCOVERY_UP_STREAM last phy continue upstream..\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* for MCN */
name|dmUpdateAllAdjacent
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue upstream discovering */
name|dmUpStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: onePortContext->discovery.status not in DISCOVERY_UP_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhy: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDownStreamDiscoverExpanderPhy
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|smpRespDiscover_t
modifier|*
name|pDiscoverResp
parameter_list|)
block|{
name|agsaSASIdentify_t
name|sasIdentify
decl_stmt|;
name|dmSASSubID_t
name|dmSASSubID
decl_stmt|;
name|bit32
name|attachedSasHi
decl_stmt|,
name|attachedSasLo
decl_stmt|;
name|dmExpander_t
modifier|*
name|AttachedExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|UpStreamExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|ConfigurableExpander
init|=
name|agNULL
decl_stmt|;
name|bit8
name|connectionRate
decl_stmt|,
name|negotiatedPhyLinkRate
decl_stmt|;
name|bit32
name|configSASAddressHi
decl_stmt|;
name|bit32
name|configSASAddressLo
decl_stmt|;
name|bit32
name|dupConfigSASAddr
init|=
name|agFALSE
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|AttachedDevice
init|=
name|agNULL
decl_stmt|;
name|bit32
name|SAS2SAS11Check
init|=
name|agFALSE
decl_stmt|;
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_ASSERT
argument_list|(
name|dmRoot
argument_list|,
literal|"(dmDownStreamDiscoverExpanderPhy) dmRoot NULL"
argument_list|)
expr_stmt|;
name|DM_ASSERT
argument_list|(
name|onePortContext
argument_list|,
literal|"(dmDownStreamDiscoverExpanderPhy) pPort NULL"
argument_list|)
expr_stmt|;
name|DM_ASSERT
argument_list|(
name|oneExpander
argument_list|,
literal|"(dmDownStreamDiscoverExpanderPhy) pExpander NULL"
argument_list|)
expr_stmt|;
name|DM_ASSERT
argument_list|(
name|pDiscoverResp
argument_list|,
literal|"(dmDownStreamDiscoverExpanderPhy) pDiscoverResp NULL"
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: onePortContxt=%p  oneExpander=%p\n"
operator|,
name|onePortContext
operator|,
name|oneExpander
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneExpander
operator|!=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|dmExpander
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* (1) Find the device structure of the expander */
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
name|DM_ASSERT
argument_list|(
name|oneDeviceData
argument_list|,
literal|"(dmDownStreamDiscoverExpanderPhy) pDevice NULL"
argument_list|)
expr_stmt|;
comment|/* for debugging */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Phy #%d of SAS %08x-%08x\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   Attached device: %s\n"
operator|,
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|0
condition|?
literal|"No Device"
else|:
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|1
condition|?
literal|"End Device"
else|:
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|2
condition|?
literal|"Edge Expander"
else|:
literal|"Fanout Expander"
operator|)
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* for debugging */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|!=
name|pDiscoverResp
operator|->
name|phyIdentifier
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: !!! Incorrect SMP response !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Request PhyID #%d Response PhyID #%d !!!\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"NO_DEVICE"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"   SAS address    : %08x-%08x\n"
operator|,
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
operator|,
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   SSP Target     : %d\n"
operator|,
name|DISCRSP_IS_SSP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   STP Target     : %d\n"
operator|,
name|DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   SMP Target     : %d\n"
operator|,
name|DISCRSP_IS_SMP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   SATA DEVICE    : %d\n"
operator|,
name|DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   SSP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_SSP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   STP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_STP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   SMP Initiator  : %d\n"
operator|,
name|DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   Phy ID         : %d\n"
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"   Attached Phy ID: %d\n"
operator|,
name|pDiscoverResp
operator|->
name|attachedPhyIdentifier
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* end for debugging */
comment|/* saving routing attribute for non self-configuring expanders */
name|oneExpander
operator|->
name|routingAttribute
index|[
name|pDiscoverResp
operator|->
name|phyIdentifier
index|]
operator|=
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|discoverSMPAllowed
operator|=
name|agTRUE
expr_stmt|;
comment|/* If a device is attached */
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
comment|/* Setup sasIdentify for the attached device */
name|sasIdentify
operator|.
name|phyIdentifier
operator|=
name|pDiscoverResp
operator|->
name|phyIdentifier
expr_stmt|;
name|sasIdentify
operator|.
name|deviceType_addressFrameType
operator|=
name|pDiscoverResp
operator|->
name|attachedDeviceType
operator|&
literal|0x70
expr_stmt|;
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_Ssp_Stp_Smp_Sata_Initiator
expr_stmt|;
name|sasIdentify
operator|.
name|target_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_SataPS_Ssp_Stp_Smp_Sata_Target
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressHi
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressHi
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressLo
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressLo
expr_stmt|;
comment|/* incremental discovery */
name|dmSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
expr_stmt|;
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|target_ssp_stp_smp
expr_stmt|;
name|attachedSasHi
operator|=
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
name|attachedSasLo
operator|=
name|DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
comment|/* If it's a direct routing */
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_DIRECT
condition|)
block|{
comment|/* If the attached device is an expander */
if|if
condition|(
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: **** Topology Error direct routing can't connect to expander!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* If the expander's attached device is not myself */
if|if
condition|(
operator|(
name|attachedSasHi
operator|!=
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|)
operator|||
operator|(
name|attachedSasLo
operator|!=
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|)
condition|)
block|{
comment|/* Find the attached device from discovered list */
name|AttachedDevice
operator|=
name|dmPortSASDeviceFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|attachedSasLo
argument_list|,
name|attachedSasHi
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* If the device has not been discovered before */
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
comment|//11
block|{
comment|/* If the phy has subtractive routing attribute */
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
operator|&&
operator|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|||
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Deferred!!! **** Topology Error subtractive routing error - inconsistent SAS address!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|DeferredError
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
comment|/* 11 */
block|{
comment|/* Add the device */
comment|/* read minimum rate from the configuration               onePortContext->LinkRate is SPC's local link rate           */
name|connectionRate
operator|=
name|MIN
argument_list|(
name|onePortContext
operator|->
name|LinkRate
argument_list|,
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: link rate 0x%x\n"
operator|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: negotiatedPhyLinkRate 0x%x\n"
operator|,
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: connectionRate 0x%x\n"
operator|,
name|connectionRate
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|dmFindRegNValid
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* DISCRSP_IS_STP_TARGET(pDiscoverResp) || DISCRSP_IS_SATA_DEVICE(pDiscoverResp) */
else|else
comment|/* 22 */
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|dmFindRegNValid
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* else 22 */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: newDevice  pDevice=%p\n"
operator|,
name|AttachedDevice
operator|)
argument_list|)
expr_stmt|;
comment|/* If the device is added successfully */
if|if
condition|(
name|AttachedDevice
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|SA_IDFRM_IS_SSP_TARGET
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SMP_TARGET
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SSP_INITIATOR
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SMP_INITIATOR
argument_list|(
operator|&
name|sasIdentify
argument_list|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Report a new SAS device !!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SA_IDFRM_IS_STP_TARGET
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SATA_DEVICE
argument_list|(
operator|&
name|sasIdentify
argument_list|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Found an STP or SATA device.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Found Other type of device.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* LP2006-05-26 added upstream device to the newly found device */
name|AttachedDevice
operator|->
name|dmExpander
operator|=
name|oneExpander
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: AttachedDevice %p did %d\n"
operator|,
name|AttachedDevice
operator|,
name|AttachedDevice
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Attached oneExpander %p did %d\n"
operator|,
name|AttachedDevice
operator|->
name|dmExpander
operator|,
name|AttachedDevice
operator|->
name|dmExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: oneExpander %p did %d\n"
operator|,
name|oneDeviceData
operator|->
name|dmExpander
operator|,
name|oneDeviceData
operator|->
name|dmExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* If the phy has table routing attribute */
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_TABLE
condition|)
block|{
comment|/* If the attached device is a fan out expander */
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: **** Topology Error two table routing phys are connected!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
comment|/* Allocate an expander data structure */
name|AttachedExpander
operator|=
name|dmDiscoveringExpanderAlloc
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedDevice
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Found a EDGE exp device.%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* If allocate successfully */
if|if
condition|(
name|AttachedExpander
operator|!=
name|agNULL
condition|)
block|{
comment|/* set up downstream information on configurable expander */
name|dmExpanderDownStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|oneExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
comment|/* Setup upstream information */
name|dmExpanderUpStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|AttachedExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|hasUpStreamDevice
operator|=
name|agTRUE
expr_stmt|;
name|AttachedExpander
operator|->
name|upStreamSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|upStreamSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|dmUpStreamExpander
operator|=
name|oneExpander
expr_stmt|;
comment|/* (2.3.2.2.2.2.2.2.2) Add the pAttachedExpander to discovering list */
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|)
expr_stmt|;
block|}
comment|/* If failed to allocate */
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Failed to allocate expander data structure!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*  discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* DISCRSP_GET_ROUTINGATTRIB(pDiscoverResp) == SAS_ROUTING_TABLE */
comment|/* If status is still DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: 1st before\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllUpExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|dmFindConfigurableExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
condition|)
block|{
if|if
condition|(
operator|(
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|&&
operator|(
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* directly attached between oneExpander and ConfigurableExpander */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: 1st before loc 1\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
expr_stmt|;
name|configSASAddressLo
operator|=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: 1st before loc 2\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* if !ConfigurableExpander */
name|dupConfigSASAddr
operator|=
name|dmDuplicateConfigSASAddr
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: 1st q123\n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|->
name|dmCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|dmFindCurrentDownStreamPhyIndex
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|dmReturnginExpander
operator|=
name|oneExpander
expr_stmt|;
name|dmRoutingEntryAdd
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* onePortContext->discovery.status == DISCOVERY_DOWN_STREAM */
block|}
comment|/* AttachedDevice != agNULL */
comment|/*  If fail to add the device */
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Failed to add a device!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*  discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* else 11 */
block|}
comment|/* AttachedDevice == agNULL */
comment|/* If the device has been discovered before */
else|else
comment|/* haha discovered before 33 */
block|{
comment|/* If the phy has subtractive routing attribute */
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
condition|)
block|{
comment|/* If the expander doesn't have up stream device */
if|if
condition|(
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|==
name|agFALSE
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: **** Topology Error loop, or end device connects to two expanders!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
comment|/* If the expander has up stream device */
else|else
comment|/* 44 */
block|{
comment|/* If sas address doesn't match */
if|if
condition|(
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressHi
operator|!=
name|attachedSasHi
operator|)
operator|||
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressLo
operator|!=
name|attachedSasLo
operator|)
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: **** Topology Error two subtractive phys!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* else 44 */
block|}
comment|/* DISCRSP_GET_ROUTINGATTRIB(pDiscoverResp) == SAS_ROUTING_SUBTRACTIVE */
comment|/* If the phy has table routing attribute */
elseif|else
if|if
condition|(
name|DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_TABLE
condition|)
block|{
comment|/* If the attached device is a fan out expander */
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
comment|/* (2.3.3.2.1.1) TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: **** Topology Error fan out expander to routing table phy!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
comment|/* If the attached device is an edge expander */
elseif|else
if|if
condition|(
name|DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
comment|/* Setup up stream inform */
name|AttachedExpander
operator|=
name|AttachedDevice
operator|->
name|dmExpander
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Found edge expander=%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* If the attached expander has up stream device */
if|if
condition|(
name|AttachedExpander
operator|->
name|hasUpStreamDevice
operator|==
name|agTRUE
condition|)
block|{
comment|/* compare the sas address */
if|if
condition|(
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressHi
operator|!=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|||
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressLo
operator|!=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|SAS2SAS11Check
operator|=
name|dmSAS2SAS11ErrorCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|,
name|oneExpander
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
if|if
condition|(
name|SAS2SAS11Check
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: **** Topology Error SAS2 and SAS1.1!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: **** Topology Error two table routing phys connected (1)!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Add edge expander=%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* set up downstream information on configurable expander */
name|dmExpanderDownStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|oneExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
comment|/* haha */
name|dmExpanderUpStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|AttachedExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
comment|/* Add the pAttachedExpander to discovering list */
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* AttachedExpander->hasUpStreamDevice == agTRUE */
comment|/* If the attached expander doesn't have up stream device */
else|else
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: **** Topology Error two table routing phys connected (2)!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* DISCRSP_GET_ATTACHED_DEVTYPE(pDiscoverResp) == SAS_EDGE_EXPANDER_DEVICE */
block|}
comment|/* DISCRSP_GET_ROUTINGATTRIB(pDiscoverResp) == SAS_ROUTING_TABLE */
comment|/* do this regradless of sub or table */
comment|/* If status is still DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: 2nd before\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllUpExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|dmFindConfigurableExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
condition|)
block|{
if|if
condition|(
operator|(
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|&&
operator|(
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* directly attached between oneExpander and ConfigurableExpander */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: 2nd before loc 1\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
expr_stmt|;
name|configSASAddressLo
operator|=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: 2nd before loc 2\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* if !ConfigurableExpander */
name|dupConfigSASAddr
operator|=
name|dmDuplicateConfigSASAddr
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: 2nd q123 \n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|->
name|dmCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|dmFindCurrentDownStreamPhyIndex
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|dmReturnginExpander
operator|=
name|oneExpander
expr_stmt|;
name|dmRoutingEntryAdd
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* onePortContext->discovery.status == DISCOVERY_DOWN_STREAM */
comment|/* incremental discovery */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
condition|)
block|{
name|connectionRate
operator|=
name|MIN
argument_list|(
name|onePortContext
operator|->
name|LinkRate
argument_list|,
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: incremental SATA_STP\n"
operator|)
argument_list|)
expr_stmt|;
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: incremental SAS\n"
operator|)
argument_list|)
expr_stmt|;
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* onePortContext->discovery.type == DM_DISCOVERY_OPTION_INCREMENTAL_START */
block|}
comment|/* else 33 */
block|}
comment|/* (attachedSasLo != onePortContext->sasLocalAddressLo) */
else|else
comment|/* else 44 */
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: Found Self\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: 3rd before\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllUpExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|dmFindConfigurableExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|dupConfigSASAddr
operator|=
name|dmDuplicateConfigSASAddr
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressHi
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: 3rd q123 Setup routing table\n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|->
name|dmCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|dmFindCurrentDownStreamPhyIndex
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|dmReturnginExpander
operator|=
name|oneExpander
expr_stmt|;
name|dmRoutingEntryAdd
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressHi
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressLo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* else 44 */
block|}
comment|/* DISCRSP_GET_ATTACHED_DEVTYPE(pDiscoverResp) !=  SAS_NO_DEVICE */
comment|/* If no device is attached */
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"!!!!!!!!!!!!!!!!!!!!! SPIN SATA !!!!!!!!!!!!!!!!!!!!!!!!!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|negotiatedPhyLinkRate
operator|=
name|DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
comment|// added by thenil
if|if
condition|(
name|negotiatedPhyLinkRate
operator|==
literal|0x03
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: SPIN SATA sent reset\n"
operator|)
argument_list|)
expr_stmt|;
name|dmPhyControlSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
comment|/* do nothing */
block|}
comment|/* Increment the discovering phy id */
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
comment|/* If the discovery status is DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
comment|/* If not the last phy */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
comment|/* If the last phy */
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* for MCN */
name|dmUpdateAllAdjacent
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue downstream discovering */
name|dmDownStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: onePortContext->discovery.status not in DISCOVERY_DOWN_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhy: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* works at SAS2 expander (called in dmDownStreamDiscover2ExpanderPhy())    if currentExpander is SAS2, called in dmDownStreamDiscover2ExpanderPhy()    if currentExpander is SAS1.1, called in dmDownStreamDiscoverExpanderPhy() */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|dmSAS2SAS11ErrorCheck
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|topExpander
parameter_list|,
name|dmExpander_t
modifier|*
name|bottomExpander
parameter_list|,
name|dmExpander_t
modifier|*
name|currentExpander
parameter_list|)
block|{
name|bit32
name|result
init|=
name|agFALSE
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|;
name|bit8
name|downStreamPhyID
decl_stmt|,
name|upStreamPhyID
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSAS2SAS11ErrorCheck: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|topExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSAS2SAS11ErrorCheck: topExpander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
if|if
condition|(
name|bottomExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSAS2SAS11ErrorCheck: bottomExpander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
if|if
condition|(
name|currentExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSAS2SAS11ErrorCheck: currentExpander is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSAS2SAS11ErrorCheck: topExpander addrHi 0x%08x addrLo 0x%08x\n"
operator|,
name|topExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|topExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSAS2SAS11ErrorCheck: bottomExpander addrHi 0x%08x addrLo 0x%08x\n"
operator|,
name|bottomExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|bottomExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmSAS2SAS11ErrorCheck: currentExpander addrHi 0x%08x addrLo 0x%08x\n"
operator|,
name|currentExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|currentExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DM_MAX_EXPANDER_PHYS
condition|;
name|i
operator|++
control|)
block|{
name|downStreamPhyID
operator|=
name|topExpander
operator|->
name|downStreamPhys
index|[
name|i
index|]
expr_stmt|;
name|upStreamPhyID
operator|=
name|bottomExpander
operator|->
name|upStreamPhys
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|currentExpander
operator|->
name|SAS2
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|downStreamPhyID
operator|==
name|upStreamPhyID
operator|&&
name|topExpander
operator|->
name|routingAttribute
index|[
name|downStreamPhyID
index|]
operator|==
name|SAS_ROUTING_TABLE
operator|&&
name|bottomExpander
operator|->
name|routingAttribute
index|[
name|i
index|]
operator|==
name|SAS_ROUTING_SUBTRACTIVE
operator|&&
name|topExpander
operator|->
name|SAS2
operator|==
literal|0
operator|&&
name|bottomExpander
operator|->
name|SAS2
operator|==
literal|1
condition|)
block|{
name|result
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|currentExpander
operator|->
name|SAS2
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|downStreamPhyID
operator|==
name|upStreamPhyID
operator|&&
name|topExpander
operator|->
name|routingAttribute
index|[
name|downStreamPhyID
index|]
operator|==
name|SAS_ROUTING_SUBTRACTIVE
operator|&&
name|bottomExpander
operator|->
name|routingAttribute
index|[
name|i
index|]
operator|==
name|SAS_ROUTING_TABLE
operator|&&
name|topExpander
operator|->
name|SAS2
operator|==
literal|1
operator|&&
name|bottomExpander
operator|->
name|SAS2
operator|==
literal|0
condition|)
block|{
name|result
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDownStreamDiscover2ExpanderPhy
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|smpRespDiscover2_t
modifier|*
name|pDiscoverResp
parameter_list|)
block|{
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|dmExpander_t
modifier|*
name|UpStreamExpander
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|AttachedDevice
init|=
name|agNULL
decl_stmt|;
name|dmExpander_t
modifier|*
name|AttachedExpander
decl_stmt|;
name|agsaSASIdentify_t
name|sasIdentify
decl_stmt|;
name|bit8
name|connectionRate
decl_stmt|;
name|bit32
name|attachedSasHi
decl_stmt|,
name|attachedSasLo
decl_stmt|;
name|dmSASSubID_t
name|dmSASSubID
decl_stmt|;
name|dmExpander_t
modifier|*
name|ConfigurableExpander
init|=
name|agNULL
decl_stmt|;
name|bit32
name|dupConfigSASAddr
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|configSASAddressHi
decl_stmt|;
name|bit32
name|configSASAddressLo
decl_stmt|;
name|bit32
name|SAS2SAS11Check
init|=
name|agFALSE
decl_stmt|;
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_ASSERT
argument_list|(
name|dmRoot
argument_list|,
literal|"(dmDownStreamDiscover2ExpanderPhy) dmRoot NULL"
argument_list|)
expr_stmt|;
name|DM_ASSERT
argument_list|(
name|onePortContext
argument_list|,
literal|"(dmDownStreamDiscover2ExpanderPhy) pPort NULL"
argument_list|)
expr_stmt|;
name|DM_ASSERT
argument_list|(
name|oneExpander
argument_list|,
literal|"(dmDownStreamDiscover2ExpanderPhy) pExpander NULL"
argument_list|)
expr_stmt|;
name|DM_ASSERT
argument_list|(
name|pDiscoverResp
argument_list|,
literal|"(dmDownStreamDiscover2ExpanderPhy) pDiscoverResp NULL"
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: onePortContxt=%p  oneExpander=%p  oneDeviceData=%p\n"
operator|,
name|onePortContext
operator|,
name|oneExpander
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneExpander
operator|!=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|dmExpander
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* (1) Find the device structure of the expander */
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
name|DM_ASSERT
argument_list|(
name|oneDeviceData
argument_list|,
literal|"(dmDownStreamDiscover2ExpanderPhy) pDevice NULL"
argument_list|)
expr_stmt|;
comment|/* for debugging */
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Phy #%d of SAS %08x-%08x\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   Attached device: %s\n"
operator|,
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|0
condition|?
literal|"No Device"
else|:
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|1
condition|?
literal|"End Device"
else|:
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
literal|2
condition|?
literal|"Edge Expander"
else|:
literal|"Fanout Expander"
operator|)
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* for debugging */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|!=
name|pDiscoverResp
operator|->
name|phyIdentifier
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: !!! Incorrect SMP response !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Request PhyID #%d Response PhyID #%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"NO_DEVICE"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover2_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"   SAS address    : %08x-%08x\n"
operator|,
name|SAS2_DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
operator|,
name|SAS2_DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   SSP Target     : %d\n"
operator|,
name|SAS2_DISCRSP_IS_SSP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   STP Target     : %d\n"
operator|,
name|SAS2_DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   SMP Target     : %d\n"
operator|,
name|SAS2_DISCRSP_IS_SMP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   SATA DEVICE    : %d\n"
operator|,
name|SAS2_DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   SSP Initiator  : %d\n"
operator|,
name|SAS2_DISCRSP_IS_SSP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   STP Initiator  : %d\n"
operator|,
name|SAS2_DISCRSP_IS_STP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   SMP Initiator  : %d\n"
operator|,
name|SAS2_DISCRSP_IS_SMP_INITIATOR
argument_list|(
name|pDiscoverResp
argument_list|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   Phy ID         : %d\n"
operator|,
name|pDiscoverResp
operator|->
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"   Attached Phy ID: %d\n"
operator|,
name|pDiscoverResp
operator|->
name|attachedPhyIdentifier
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* saving routing attribute for non self-configuring expanders */
name|oneExpander
operator|->
name|routingAttribute
index|[
name|pDiscoverResp
operator|->
name|phyIdentifier
index|]
operator|=
name|SAS2_DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|discoverSMPAllowed
operator|=
name|agTRUE
expr_stmt|;
comment|/* If a device is attached */
if|if
condition|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|!=
name|SAS_NO_DEVICE
condition|)
block|{
comment|/* Setup sasIdentify for the attached device */
name|sasIdentify
operator|.
name|phyIdentifier
operator|=
name|pDiscoverResp
operator|->
name|phyIdentifier
expr_stmt|;
name|sasIdentify
operator|.
name|deviceType_addressFrameType
operator|=
name|pDiscoverResp
operator|->
name|attachedDeviceTypeReason
operator|&
literal|0x70
expr_stmt|;
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_Ssp_Stp_Smp_Sata_Initiator
expr_stmt|;
name|sasIdentify
operator|.
name|target_ssp_stp_smp
operator|=
name|pDiscoverResp
operator|->
name|attached_SataPS_Ssp_Stp_Smp_Sata_Target
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressHi
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressHi
expr_stmt|;
operator|*
operator|(
name|bit32
operator|*
operator|)
name|sasIdentify
operator|.
name|sasAddressLo
operator|=
operator|*
operator|(
name|bit32
operator|*
operator|)
name|pDiscoverResp
operator|->
name|attachedSasAddressLo
expr_stmt|;
comment|/* incremental discovery */
name|dmSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
expr_stmt|;
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|target_ssp_stp_smp
expr_stmt|;
name|attachedSasHi
operator|=
name|SAS2_DISCRSP_GET_ATTACHED_SAS_ADDRESSHI
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
name|attachedSasLo
operator|=
name|SAS2_DISCRSP_GET_ATTACHED_SAS_ADDRESSLO
argument_list|(
name|pDiscoverResp
argument_list|)
expr_stmt|;
comment|/* If it's a direct routing */
if|if
condition|(
name|SAS2_DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_DIRECT
condition|)
block|{
comment|/* If the attached device is an expander */
if|if
condition|(
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|)
operator|||
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: **** Topology Error direct routing can't connect to expander!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* If the expander's attached device is not myself */
if|if
condition|(
operator|(
name|attachedSasHi
operator|!=
name|onePortContext
operator|->
name|sasLocalAddressHi
operator|)
operator|||
operator|(
name|attachedSasLo
operator|!=
name|onePortContext
operator|->
name|sasLocalAddressLo
operator|)
condition|)
block|{
comment|/* Find the attached device from discovered list */
name|AttachedDevice
operator|=
name|dmPortSASDeviceFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|attachedSasLo
argument_list|,
name|attachedSasHi
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* If the device has not been discovered before */
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
comment|//11
block|{
comment|//qqqqqq
if|if
condition|(
literal|0
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: **** Topology Error subtractive routing error - inconsistent SAS address!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Add the device */
comment|/* read minimum rate from the configuration               onePortContext->LinkRate is SPC's local link rate           */
name|connectionRate
operator|=
name|MIN
argument_list|(
name|onePortContext
operator|->
name|LinkRate
argument_list|,
name|SAS2_DISCRSP_GET_LOGICAL_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: link rate 0x%x\n"
operator|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: negotiatedPhyLinkRate 0x%x\n"
operator|,
name|SAS2_DISCRSP_GET_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: connectionRate 0x%x\n"
operator|,
name|connectionRate
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SAS2_DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|SAS2_DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|dmFindRegNValid
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental discovery */
name|AttachedDevice
operator|=
name|dmFindRegNValid
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|)
expr_stmt|;
comment|/* not registered and not valid; add this*/
if|if
condition|(
name|AttachedDevice
operator|==
name|agNULL
condition|)
block|{
name|AttachedDevice
operator|=
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: newDevice  pDevice=%p\n"
operator|,
name|AttachedDevice
operator|)
argument_list|)
expr_stmt|;
comment|/* If the device is added successfully */
if|if
condition|(
name|AttachedDevice
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|SA_IDFRM_IS_SSP_TARGET
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SMP_TARGET
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SSP_INITIATOR
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SMP_INITIATOR
argument_list|(
operator|&
name|sasIdentify
argument_list|)
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Report a new SAS device !!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SA_IDFRM_IS_STP_TARGET
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|||
name|SA_IDFRM_IS_SATA_DEVICE
argument_list|(
operator|&
name|sasIdentify
argument_list|)
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Found an STP or SATA device.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Found Other type of device.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* LP2006-05-26 added upstream device to the newly found device */
name|AttachedDevice
operator|->
name|dmExpander
operator|=
name|oneExpander
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: AttachedDevice %p did %d\n"
operator|,
name|AttachedDevice
operator|,
name|AttachedDevice
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Attached oneExpander %p did %d\n"
operator|,
name|AttachedDevice
operator|->
name|dmExpander
operator|,
name|AttachedDevice
operator|->
name|dmExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: oneExpander %p did %d\n"
operator|,
name|oneDeviceData
operator|->
name|dmExpander
operator|,
name|oneDeviceData
operator|->
name|dmExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* If the phy has table routing attribute */
if|if
condition|(
name|SAS2_DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_TABLE
condition|)
block|{
comment|/* If the attached device is a fan out expander */
if|if
condition|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: **** Topology Error two table routing phys are connected!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
comment|/* Allocate an expander data structure */
name|AttachedExpander
operator|=
name|dmDiscoveringExpanderAlloc
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedDevice
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Found a EDGE exp device.%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* If allocate successfully */
if|if
condition|(
name|AttachedExpander
operator|!=
name|agNULL
condition|)
block|{
comment|/* set up downstream information on configurable expander */
name|dmExpanderDownStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|oneExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
comment|/* Setup upstream information */
name|dmExpanderUpStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|AttachedExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
comment|//qqqqq
name|AttachedExpander
operator|->
name|hasUpStreamDevice
operator|=
name|agTRUE
expr_stmt|;
name|AttachedExpander
operator|->
name|upStreamSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|upStreamSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|dmUpStreamExpander
operator|=
name|oneExpander
expr_stmt|;
comment|/* (2.3.2.2.2.2.2.2.2) Add the pAttachedExpander to discovering list */
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|)
expr_stmt|;
block|}
comment|/* If failed to allocate */
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy, Failed to allocate expander data structure!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*  discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|//qqqqq
elseif|else
if|if
condition|(
name|SAS2_DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
operator|&&
operator|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
operator|||
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|)
condition|)
block|{
comment|/* Allocate an expander data structure */
name|AttachedExpander
operator|=
name|dmDiscoveringExpanderAlloc
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedDevice
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Found a EDGE/FANOUT exp device.%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* If allocate successfully */
if|if
condition|(
name|AttachedExpander
operator|!=
name|agNULL
condition|)
block|{
comment|/* set up downstream information on configurable expander */
name|dmExpanderDownStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|oneExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
comment|/* Setup upstream information */
name|dmExpanderUpStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|AttachedExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|hasUpStreamDevice
operator|=
name|agTRUE
expr_stmt|;
name|AttachedExpander
operator|->
name|upStreamSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|upStreamSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|AttachedExpander
operator|->
name|dmUpStreamExpander
operator|=
name|oneExpander
expr_stmt|;
comment|/* (2.3.2.2.2.2.2.2.2) Add the pAttachedExpander to discovering list */
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|)
expr_stmt|;
block|}
comment|/* If failed to allocate */
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy, Failed to allocate expander data structure (2)!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*  discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If status is still DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
operator|&&
name|onePortContext
operator|->
name|discovery
operator|.
name|ConfiguresOthers
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: 1st before\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllUpExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|dmFindConfigurableExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
condition|)
block|{
if|if
condition|(
operator|(
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|&&
operator|(
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* directly attached between oneExpander and ConfigurableExpander */
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: 1st before loc 1\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
expr_stmt|;
name|configSASAddressLo
operator|=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: 1st before loc 2\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* if !ConfigurableExpander */
name|dupConfigSASAddr
operator|=
name|dmDuplicateConfigSASAddr
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: 1st q123\n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|->
name|dmCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|dmFindCurrentDownStreamPhyIndex
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|dmReturnginExpander
operator|=
name|oneExpander
expr_stmt|;
name|dmRoutingEntryAdd
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/*  If fail to add the device */
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy, Failed to add a device!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*  discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* If the device has been discovered before */
else|else
comment|/* discovered before */
block|{
comment|/* If the phy has subtractive routing attribute */
if|if
condition|(
name|SAS2_DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_SUBTRACTIVE
condition|)
block|{
comment|/* If the expander doesn't have up stream device */
if|if
condition|(
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|==
name|agFALSE
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: **** Topology Error loop, or end device connects to two expanders!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
comment|/* If the expander has up stream device */
else|else
block|{
comment|//qqqqq
comment|/* If sas address doesn't match */
if|if
condition|(
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressHi
operator|!=
name|attachedSasHi
operator|)
operator|||
operator|(
name|oneExpander
operator|->
name|upStreamSASAddressLo
operator|!=
name|attachedSasLo
operator|)
condition|)
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: **** two subtractive phys!!! Allowed in SAS2!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|DeferredError
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
block|}
comment|/* If the phy has table routing attribute */
elseif|else
if|if
condition|(
name|SAS2_DISCRSP_GET_ROUTINGATTRIB
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_ROUTING_TABLE
condition|)
block|{
comment|/* If the attached device is a fan out expander */
if|if
condition|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
comment|/* (2.3.3.2.1.1) TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: **** Topology Error fan out expander to routing table phy!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
comment|/* If the attached device is an edge expander */
elseif|else
if|if
condition|(
name|SAS2_DISCRSP_GET_ATTACHED_DEVTYPE
argument_list|(
name|pDiscoverResp
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
comment|/* Setup up stream inform */
name|AttachedExpander
operator|=
name|AttachedDevice
operator|->
name|dmExpander
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Found edge expander=%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|//hhhhhh
comment|/* If the attached expander has up stream device */
if|if
condition|(
name|AttachedExpander
operator|->
name|hasUpStreamDevice
operator|==
name|agTRUE
condition|)
block|{
comment|/* compare the sas address */
if|if
condition|(
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressHi
operator|!=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|||
operator|(
name|AttachedExpander
operator|->
name|upStreamSASAddressLo
operator|!=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|AttachedExpander
operator|->
name|TTTSupported
operator|&&
name|oneExpander
operator|->
name|TTTSupported
condition|)
block|{
comment|/* 		     needs further error checking  		     UpstreamExpanderOfAttachedExpander = AttachedExpander->UpStreamExpander 		     for (i=0;i<DM_MAX_EXPANDER_PHYS;i++) 		     { 		       if (UpstreamExpanderOfAttachedExpander->downStreamPhys[i] != 0&& 		     }  		  */
name|SAS2SAS11Check
operator|=
name|dmSAS2SAS11ErrorCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
operator|->
name|dmUpStreamExpander
argument_list|,
name|AttachedExpander
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
if|if
condition|(
name|SAS2SAS11Check
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: **** Topology Error SAS2 and SAS1.1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Allowed Table to Table (1)\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* move on to the next phys but should be not proceed after oneExpander */
name|oneExpander
operator|->
name|UndoDueToTTTSupported
operator|=
name|agTRUE
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|DeferredError
operator|=
name|agFALSE
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: **** Topology Error two table routing phys connected (1)!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Add edge expander=%p\n"
operator|,
name|AttachedExpander
operator|)
argument_list|)
expr_stmt|;
comment|/* set up downstream information on configurable expander */
name|dmExpanderDownStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|oneExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
comment|/* haha */
name|dmExpanderUpStreamPhyAdd
argument_list|(
name|dmRoot
argument_list|,
name|AttachedExpander
argument_list|,
operator|(
name|bit8
operator|)
name|oneExpander
operator|->
name|discoveringPhyId
argument_list|)
expr_stmt|;
comment|/* Add the pAttachedExpander to discovering list */
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|AttachedExpander
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If the attached expander doesn't have up stream device */
else|else
block|{
if|if
condition|(
name|AttachedExpander
operator|->
name|TTTSupported
operator|&&
name|oneExpander
operator|->
name|TTTSupported
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Allowed Table to Table (2)\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* move on to the next phys but should be not proceed after oneExpander */
name|oneExpander
operator|->
name|UndoDueToTTTSupported
operator|=
name|agTRUE
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|DeferredError
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
comment|/* TODO: discovery error, callback */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: **** Topology Error two table routing phys connected (2)!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|=
name|oneExpander
operator|->
name|discoveringPhyId
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: sasAddressHi 0x%08x sasAddressLo 0x%08x phyid 0x%x\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressHi
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|sasAddressLo
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|sasAddressIDDiscoverError
operator|.
name|phyIdentifier
operator|)
argument_list|)
expr_stmt|;
comment|/* discovery done */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* for else if (SAS2_DISCRSP_GET_ROUTINGATTRIB(pDiscoverResp) == SAS_ROUTING_TABLE) */
comment|/* do this regradless of sub or table */
comment|/* If status is still DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
operator|&&
name|onePortContext
operator|->
name|discovery
operator|.
name|ConfiguresOthers
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: 2nd before\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllUpExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|dmFindConfigurableExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
condition|)
block|{
if|if
condition|(
operator|(
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
operator|&&
operator|(
name|ConfigurableExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
operator|)
condition|)
block|{
comment|/* directly attached between oneExpander and ConfigurableExpander */
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: 2nd before loc 1\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
expr_stmt|;
name|configSASAddressLo
operator|=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: 2nd before loc 2\n"
operator|)
argument_list|)
expr_stmt|;
name|configSASAddressHi
operator|=
name|DEVINFO_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|configSASAddressLo
operator|=
name|DEVINFO_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|AttachedDevice
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* if !ConfigurableExpander */
name|dupConfigSASAddr
operator|=
name|dmDuplicateConfigSASAddr
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: 2nd q123 \n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|->
name|dmCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|dmFindCurrentDownStreamPhyIndex
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|dmReturnginExpander
operator|=
name|oneExpander
expr_stmt|;
name|dmRoutingEntryAdd
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|configSASAddressHi
argument_list|,
name|configSASAddressLo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* if (onePortContext->discovery.status == DISCOVERY_DOWN_STREAM) */
comment|/* incremental discovery */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
condition|)
block|{
name|connectionRate
operator|=
name|MIN
argument_list|(
name|onePortContext
operator|->
name|LinkRate
argument_list|,
name|SAS2_DISCRSP_GET_LOGICAL_LINKRATE
argument_list|(
name|pDiscoverResp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SAS2_DISCRSP_IS_STP_TARGET
argument_list|(
name|pDiscoverResp
argument_list|)
operator|||
name|SAS2_DISCRSP_IS_SATA_DEVICE
argument_list|(
name|pDiscoverResp
argument_list|)
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: incremental SATA_STP\n"
operator|)
argument_list|)
expr_stmt|;
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|STP_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: incremental SAS\n"
operator|)
argument_list|)
expr_stmt|;
name|dmPortSASDeviceAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasIdentify
argument_list|,
name|agFALSE
argument_list|,
name|connectionRate
argument_list|,
name|dmAllShared
operator|->
name|itNexusTimeout
argument_list|,
literal|0
argument_list|,
name|SAS_DEVICE_TYPE
argument_list|,
name|oneDeviceData
argument_list|,
name|oneExpander
argument_list|,
name|pDiscoverResp
operator|->
name|phyIdentifier
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* else; existing devce */
block|}
comment|/* not attached to myself */
comment|/* If the attached device is myself */
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Found Self\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: 3rd before\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllUpExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|ConfiguresOthers
operator|==
name|agFALSE
condition|)
block|{
name|UpStreamExpander
operator|=
name|oneExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
name|ConfigurableExpander
operator|=
name|dmFindConfigurableExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|dupConfigSASAddr
operator|=
name|dmDuplicateConfigSASAddr
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressHi
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ConfigurableExpander
operator|&&
name|dupConfigSASAddr
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: 3rd q123 Setup routing table\n"
operator|)
argument_list|)
expr_stmt|;
name|UpStreamExpander
operator|->
name|dmCurrentDownStreamExpander
operator|=
name|oneExpander
expr_stmt|;
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
operator|=
name|dmFindCurrentDownStreamPhyIndex
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|->
name|dmReturnginExpander
operator|=
name|oneExpander
expr_stmt|;
name|dmRoutingEntryAdd
argument_list|(
name|dmRoot
argument_list|,
name|ConfigurableExpander
argument_list|,
name|ConfigurableExpander
operator|->
name|downStreamPhys
index|[
name|ConfigurableExpander
operator|->
name|currentDownStreamPhyIndex
index|]
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressHi
argument_list|,
name|onePortContext
operator|->
name|sasLocalAddressLo
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* If no device is attached */
else|else
block|{   }
comment|/* Increment the discovering phy id */
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
comment|/* If the discovery status is DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
comment|/* If not the last phy */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
comment|/* If the last phy */
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* for MCN */
name|dmUpdateAllAdjacent
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|ConfigurableExpander
operator|=
name|dmFindConfigurableExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|->
name|UndoDueToTTTSupported
operator|==
name|agTRUE
operator|&&
name|ConfigurableExpander
operator|!=
name|agNULL
condition|)
comment|//      if (oneExpander->UndoDueToTTTSupported == agTRUE)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: Not sure!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoveringUndoAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|UndoDueToTTTSupported
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue downstream discovering */
name|dmDownStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: onePortContext->discovery.status not in DISCOVERY_DOWN_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhy: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoveringUndoAdd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|dmExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|tmpOnePortContext
init|=
name|onePortContext
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveringUndoAdd: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveringUndoAdd: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|//  DM_DBG2(("dmDiscoveringUndoAdd: before\n"));
comment|//  dmDumpAllExp(dmRoot, onePortContext, oneExpander);
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveringUndoAdd: tempExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tempExpander
operator|->
name|dmUpStreamExpander
operator|==
name|oneExpander
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveringUndoAdd: match!!! expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveringUndoAdd: exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveringUndoAdd: exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|tempExpander
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
comment|//      DMLIST_ENQUEUE_AT_TAIL(&(tempExpander->linkNode),&(dmAllShared->freeExpanderList));
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|tempExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveringUndoAdd: hitting break\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
comment|//  DM_DBG2(("dmDiscoveringUndoAdd: after\n"));
comment|//  dmDumpAllExp(dmRoot, onePortContext, oneExpander);
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmHandleZoneViolation
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmHandleZoneViolation: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmHandleZoneViolation: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmHandleZoneViolation: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
name|oneDeviceData
operator|->
name|dmPortContext
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
if|if
condition|(
name|dmDiscoverCheck
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmHandleZoneViolation: invalid port or aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for MCN */
name|dmUpdateAllAdjacent
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
comment|/* continue upstream discovering */
name|dmUpStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* DISCOVERY_DOWN_STREAM or DISCOVERY_CONFIG_ROUTING */
block|{
comment|/* continue downstream discovering */
name|dmDownStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmUpStreamDiscoverExpanderPhySkip
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhySkip: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhySkip: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhySkip: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhySkip: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhySkip: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* for MCN */
name|dmUpdateAllAdjacent
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue upstream discovering */
name|dmUpStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhySkip: onePortContext->discovery.status not in DISCOVERY_UP_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpStreamDiscoverExpanderPhySkip: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmUpStreamDiscover2ExpanderPhySkip
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhySkip: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhySkip: DISCOVERY_UP_STREAM find more ...\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhySkip: DISCOVERY_UP_STREAM last phy continue upstream..\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* for MCN */
name|dmUpdateAllAdjacent
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue upstream discovering */
name|dmUpStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhySkip: onePortContext->discovery.status not in DISCOVERY_UP_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpStreamDiscover2ExpanderPhySkip: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDownStreamDiscoverExpanderPhySkip
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhySkip: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhySkip: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhySkip: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* Increment the discovering phy id */
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
comment|/* If the discovery status is DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
comment|/* If not the last phy */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhySkip: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
comment|/* If the last phy */
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhySkip: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* for MCN */
name|dmUpdateAllAdjacent
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue downstream discovering */
name|dmDownStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhySkip: onePortContext->discovery.status not in DISCOVERY_DOWN_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDownStreamDiscoverExpanderPhySkip: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDownStreamDiscover2ExpanderPhySkip
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhySkip: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
comment|/* Increment the discovering phy id */
name|oneExpander
operator|->
name|discoveringPhyId
operator|++
expr_stmt|;
comment|/* If the discovery status is DISCOVERY_DOWN_STREAM */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
comment|/* If not the last phy */
if|if
condition|(
name|oneExpander
operator|->
name|discoveringPhyId
operator|<
name|oneDeviceData
operator|->
name|numOfPhys
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhySkip: More Phys to discover\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* continue discovery for the next phy */
name|dmDiscoverSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
comment|/* If the last phy */
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhySkip: No More Phys\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* for MCN */
name|dmUpdateAllAdjacent
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
comment|/* remove the expander from the discovering list */
name|dmDiscoveringExpanderRemove
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
comment|/* continue downstream discovering */
name|dmDownStreamDiscovering
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhySkip: onePortContext->discovery.status not in DISCOVERY_DOWN_STREAM; status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDownStreamDiscover2ExpanderPhySkip: end return phyID#%d\n"
operator|,
name|oneExpander
operator|->
name|discoveringPhyId
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmExpanderUpStreamPhyAdd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|bit8
name|phyId
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
name|bit32
name|hasSet
init|=
name|agFALSE
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderUpStreamPhyAdd: start, phyid %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderUpStreamPhyAdd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderUpStreamPhyAdd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderUpStreamPhyAdd: phyid %d  numOfUpStreamPhys %d\n"
operator|,
name|phyId
operator|,
name|oneExpander
operator|->
name|numOfUpStreamPhys
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|numOfUpStreamPhys
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|upStreamPhys
index|[
name|i
index|]
operator|==
name|phyId
condition|)
block|{
name|hasSet
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|hasSet
operator|==
name|agFALSE
condition|)
block|{
name|oneExpander
operator|->
name|upStreamPhys
index|[
name|oneExpander
operator|->
name|numOfUpStreamPhys
operator|++
index|]
operator|=
name|phyId
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderUpStreamPhyAdd: AFTER phyid %d  numOfUpStreamPhys %d\n"
operator|,
name|phyId
operator|,
name|oneExpander
operator|->
name|numOfUpStreamPhys
operator|)
argument_list|)
expr_stmt|;
comment|/* for debugging */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|numOfUpStreamPhys
condition|;
name|i
operator|++
control|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderUpStreamPhyAdd: index %d upstream[index] %d\n"
operator|,
name|i
operator|,
name|oneExpander
operator|->
name|upStreamPhys
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmExpanderDownStreamPhyAdd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|bit8
name|phyId
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
name|bit32
name|hasSet
init|=
name|agFALSE
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderDownStreamPhyAdd: start, phyid %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderDownStreamPhyAdd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderDownStreamPhyAdd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderDownStreamPhyAdd: phyid %d  numOfDownStreamPhys %d\n"
operator|,
name|phyId
operator|,
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|numOfDownStreamPhys
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|downStreamPhys
index|[
name|i
index|]
operator|==
name|phyId
condition|)
block|{
name|hasSet
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|hasSet
operator|==
name|agFALSE
condition|)
block|{
name|oneExpander
operator|->
name|downStreamPhys
index|[
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|++
index|]
operator|=
name|phyId
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderDownStreamPhyAdd: AFTER phyid %d  numOfDownStreamPhys %d\n"
operator|,
name|phyId
operator|,
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|)
argument_list|)
expr_stmt|;
comment|/* for debugging */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|numOfDownStreamPhys
condition|;
name|i
operator|++
control|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpanderDownStreamPhyAdd: index %d downstream[index] %d\n"
operator|,
name|i
operator|,
name|oneExpander
operator|->
name|downStreamPhys
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoveryReportMCN
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit16
name|extension
init|=
literal|0
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneAttachedExpDeviceData
init|=
name|agNULL
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*   if full disocvery, report all devices using MCN   if incremental discovery,    1. compare MCN and PrevMCN   2. report the changed ones; report MCN   3. set PrevMCN to MCN      PrevMCN = MCN */
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: oneDeviceData sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: MCN 0x%08x PrevMCN 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|MCN
operator|,
name|oneDeviceData
operator|->
name|PrevMCN
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: FULL_START\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: INCREMENTAL_START\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*         if MCN is 0, the device is removed        */
if|if
condition|(
name|oneDeviceData
operator|->
name|MCN
operator|!=
name|oneDeviceData
operator|->
name|PrevMCN
operator|&&
name|oneDeviceData
operator|->
name|MCN
operator|!=
literal|0
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: reporting \n"
operator|)
argument_list|)
expr_stmt|;
name|extension
operator|=
name|oneDeviceData
operator|->
name|dmDeviceInfo
operator|.
name|ext
expr_stmt|;
comment|/* zero out MCN in extension */
name|extension
operator|=
name|extension
operator|&
literal|0x7FF
expr_stmt|;
comment|/* sets MCN in extension */
name|extension
operator|=
name|extension
operator||
operator|(
name|oneDeviceData
operator|->
name|MCN
operator|<<
literal|11
operator|)
expr_stmt|;
name|DEVINFO_PUT_EXT
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|dmDeviceInfo
operator|)
argument_list|,
name|extension
argument_list|)
expr_stmt|;
name|DM_DBG5
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: MCN 0x%08x PrevMCN 0x%08x\n"
operator|,
name|DEVINFO_GET_EXT_MCN
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|dmDeviceInfo
operator|)
argument_list|)
operator|,
name|oneDeviceData
operator|->
name|PrevMCN
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|ExpDevice
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: attached expander case\n"
operator|)
argument_list|)
expr_stmt|;
name|oneAttachedExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
operator|&
name|oneAttachedExpDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|dmDeviceMCNChange
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: No attached expander case\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|agNULL
argument_list|,
name|dmDeviceMCNChange
argument_list|)
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|PrevMCN
operator|=
name|oneDeviceData
operator|->
name|MCN
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryReportMCN: No change; no reporting \n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|MCN
operator|==
literal|0
condition|)
block|{
name|oneDeviceData
operator|->
name|PrevMCN
operator|=
name|oneDeviceData
operator|->
name|MCN
expr_stmt|;
block|}
block|}
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoveryDumpMCN
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryDumpMCN: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryDumpMCN: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryDumpMCN: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryDumpMCN: oneDeviceData sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryDumpMCN: MCN 0x%08x PrevMCN 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|MCN
operator|,
name|oneDeviceData
operator|->
name|PrevMCN
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoveryResetMCN
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryResetMCN: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* reinitialize the device data belonging to this portcontext */
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryResetMCN: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryResetMCN: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|ExpDevice
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryResetMCN: resetting oneDeviceData->ExpDevice\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|ExpDevice
operator|=
name|agNULL
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryResetMCN: resetting MCN and MCNdone\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|MCN
operator|=
literal|0
expr_stmt|;
name|oneDeviceData
operator|->
name|MCNDone
operator|=
name|agFALSE
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmDiscoveryResetMCN: oneDeviceData sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* do min(oneDeviceData, found-one) in all upstream and downstream find ajcanent expanders and mark it done; sees only ajcacent targets */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmUpdateAllAdjacent
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
comment|/* current one */
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|tmponeDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateAllAdjacent: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpdateAllAdjacent: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|->
name|MCNDone
operator|=
name|agTRUE
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateAllAdjacent: oneDeviceData sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|tmponeDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmponeDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpdateAllAdjacent: tmponeDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmUpdateAllAdjacent: loop did %d\n"
operator|,
name|tmponeDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmponeDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|&&
name|tmponeDeviceData
operator|->
name|ExpDevice
operator|==
name|oneDeviceData
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateAllAdjacent: setting MCN DONE\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateAllAdjacent: tmponeDeviceData sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|tmponeDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|tmponeDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|tmponeDeviceData
operator|->
name|MCNDone
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateAllAdjacent: tmponeDeviceData MCN 0x%x\n"
operator|,
name|tmponeDeviceData
operator|->
name|MCN
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateAllAdjacent: oneDeviceData MCN 0x%x\n"
operator|,
name|oneDeviceData
operator|->
name|MCN
operator|)
argument_list|)
expr_stmt|;
name|tmponeDeviceData
operator|->
name|MCN
operator|=
name|MIN
argument_list|(
name|oneDeviceData
operator|->
name|MCN
argument_list|,
name|tmponeDeviceData
operator|->
name|MCN
argument_list|)
expr_stmt|;
block|}
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmUpdateMCN
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceData_t
modifier|*
name|AdjacentDeviceData
parameter_list|,
comment|/* adjacent expander */
name|dmDeviceData_t
modifier|*
name|oneDeviceData
comment|/* current one */
parameter_list|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateMCN: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AdjacentDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpdateMCN: AdjacentDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmUpdateMCN: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateMCN: Current sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateMCN: AdjacentDeviceData one sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|AdjacentDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|AdjacentDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateMCN: DISCOVERY_UP_STREAM\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateMCN: DISCOVERY_DOWN_STREAM\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* MCN */
comment|/* directly attached one does not have MCN       update only adjacent device data   */
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agTRUE
operator|&&
name|AdjacentDeviceData
operator|->
name|MCNDone
operator|==
name|agFALSE
condition|)
block|{
name|AdjacentDeviceData
operator|->
name|MCN
operator|++
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateMCN: case 1 oneDeviceData MCN 0x%x\n"
operator|,
name|oneDeviceData
operator|->
name|MCN
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateMCN: case 1 AdjacentDeviceData MCN 0x%x\n"
operator|,
name|AdjacentDeviceData
operator|->
name|MCN
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|AdjacentDeviceData
operator|->
name|MCNDone
operator|==
name|agFALSE
condition|)
block|{
name|AdjacentDeviceData
operator|->
name|MCN
operator|++
expr_stmt|;
name|AdjacentDeviceData
operator|->
name|MCN
operator|=
name|MIN
argument_list|(
name|oneDeviceData
operator|->
name|MCN
argument_list|,
name|AdjacentDeviceData
operator|->
name|MCN
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateMCN: case 2 oneDeviceData MCN 0x%x\n"
operator|,
name|oneDeviceData
operator|->
name|MCN
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG2
argument_list|(
operator|(
literal|"dmUpdateMCN: case 2 AdjacentDeviceData MCN 0x%x\n"
operator|,
name|AdjacentDeviceData
operator|->
name|MCN
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* go through expander list and device list array ??? */
end_comment

begin_function
name|osGLOBAL
name|dmDeviceData_t
modifier|*
name|dmPortSASDeviceFind
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|sasAddrLo
parameter_list|,
name|bit32
name|sasAddrHi
parameter_list|,
name|dmDeviceData_t
modifier|*
name|CurrentDeviceData
comment|/* current expander */
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|,
modifier|*
name|RetDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|sasAddrHi
operator|,
name|sasAddrLo
operator|)
argument_list|)
expr_stmt|;
name|DM_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|dmRoot
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|DM_ASSERT
argument_list|(
operator|(
name|agNULL
operator|!=
name|onePortContext
operator|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: Full discovery\n"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|sasAddrHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|sasAddrLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|RetDeviceData
operator|=
name|oneDeviceData
expr_stmt|;
name|dmUpdateMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|RetDeviceData
argument_list|,
name|CurrentDeviceData
argument_list|)
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* incremental discovery */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: Incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|sasAddrHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|sasAddrLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceFind: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|RetDeviceData
operator|=
name|oneDeviceData
expr_stmt|;
name|dmUpdateMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|RetDeviceData
argument_list|,
name|CurrentDeviceData
argument_list|)
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
return|return
name|RetDeviceData
return|;
block|}
end_function

begin_function
name|bit32
name|dmNewEXPorNot
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmSASSubID_t
modifier|*
name|dmSASSubID
parameter_list|)
block|{
comment|//  dmIntRoot_t       *dmIntRoot    = (dmIntRoot_t *)dmRoot->dmData;
comment|//  dmIntContext_t    *dmAllShared = (dmIntContext_t *)&dmIntRoot->dmAllShared;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|bit32
name|ret
init|=
name|agTRUE
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNewEXPorNot: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|ExpanderList
operator|=
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|oneExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmNewEXPorNot: oneExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agFALSE
return|;
block|}
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|dmSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|dmSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNewEXPorNot: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|bit32
name|dmNewSASorNot
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmSASSubID_t
modifier|*
name|dmSASSubID
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|ret
init|=
name|agTRUE
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNewSASorNot: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmNewSASorNot: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agFALSE
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|dmSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|dmSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNewSASorNot: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  call osGLOBAL bit32  tddmReportDevice(                  dmRoot_t 		*dmRoot,                  dmPortContext_t	*dmPortContext,                  dmDeviceInfo_t		*dmDeviceInfo                  ) if not reported, report Device to TDM */
end_comment

begin_function
name|osGLOBAL
name|dmDeviceData_t
modifier|*
name|dmPortSASDeviceAdd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|agsaSASIdentify_t
name|sasIdentify
parameter_list|,
name|bit32
name|sasInitiator
parameter_list|,
name|bit8
name|connectionRate
parameter_list|,
name|bit32
name|itNexusTimeout
parameter_list|,
name|bit32
name|firstBurstSize
parameter_list|,
name|bit32
name|deviceType
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneExpDeviceData
parameter_list|,
name|dmExpander_t
modifier|*
name|dmExpander
parameter_list|,
name|bit8
name|phyID
parameter_list|)
block|{
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit8
name|dev_s_rate
init|=
literal|0
decl_stmt|;
name|bit8
name|sasorsata
init|=
literal|1
decl_stmt|;
name|dmSASSubID_t
name|dmSASSubID
decl_stmt|;
name|bit8
name|ExpanderConnectionRate
init|=
name|connectionRate
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneAttachedExpDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit16
name|extension
init|=
literal|0
decl_stmt|;
name|bit32
name|current_link_rate
init|=
literal|0
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: connectionRate %d\n"
operator|,
name|connectionRate
operator|)
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressHi
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressLo
operator|=
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|initiator_ssp_stp_smp
expr_stmt|;
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|sasIdentify
operator|.
name|target_ssp_stp_smp
expr_stmt|;
if|if
condition|(
name|oneExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|ExpanderConnectionRate
operator|=
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: ExpanderConnectionRate 0x%x\n"
operator|,
name|ExpanderConnectionRate
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|oneExpDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
literal|0x0
operator|&&
name|oneExpDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
literal|0x0
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: 1st Wrong expander!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* old device and already reported to TDM */
if|if
condition|(
name|agFALSE
operator|==
name|dmNewSASorNot
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|)
condition|)
comment|/* old device */
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: OLD qqqq initiator_ssp_stp_smp %d target_ssp_stp_smp %d\n"
operator|,
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|,
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate a new device and set the valid bit */
name|oneDeviceData
operator|=
name|dmAddSASToSharedcontext
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|,
name|oneExpDeviceData
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: no more device, oneDeviceData is null!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* If a device is allocated */
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: OLD, UP_STREAM\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: OLD, DOWN_STREAM\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: FULL_START\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|MCN
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: INCREMENTAL_START\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|MCN
operator|==
literal|0
operator|&&
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agFALSE
condition|)
block|{
name|oneDeviceData
operator|->
name|MCN
operator|++
expr_stmt|;
block|}
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: oneDeviceData MCN 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|MCN
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: oneDeviceData sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|//      oneDeviceData->sasIdentify = sasIdentify;
name|dm_memcpy
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|sasIdentify
operator|)
argument_list|,
operator|&
name|sasIdentify
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASIdentify_t
argument_list|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* parse sasIDframe to fill in agDeviceInfo */
name|DEVINFO_PUT_SMPTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|DEFAULT_SMP_TIMEOUT
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_ITNEXUSTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|itNexusTimeout
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FBS
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|firstBurstSize
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FLAG
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|=
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
comment|/* adjusting connectionRate */
name|oneAttachedExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
if|if
condition|(
name|oneAttachedExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|connectionRate
operator|=
name|MIN
argument_list|(
name|connectionRate
argument_list|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: 1st connectionRate 0x%x  DEVINFO_GET_LINKRATE(&oneAttachedExpDeviceData->agDeviceInfo) 0x%x\n"
operator|,
name|connectionRate
operator|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: 1st oneAttachedExpDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Device Type, SAS or SATA, connection rate; bit7 --- bit0 */
name|sasorsata
operator|=
operator|(
name|bit8
operator|)
name|deviceType
expr_stmt|;
comment|/* sTSDK spec device typ */
name|dev_s_rate
operator|=
name|dev_s_rate
operator||
operator|(
name|sasorsata
operator|<<
literal|4
operator|)
expr_stmt|;
name|dev_s_rate
operator|=
name|dev_s_rate
operator||
name|MIN
argument_list|(
name|connectionRate
argument_list|,
name|ExpanderConnectionRate
argument_list|)
expr_stmt|;
comment|/* detect link rate change */
name|current_link_rate
operator|=
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|current_link_rate
operator|!=
operator|(
name|bit32
operator|)
name|MIN
argument_list|(
name|connectionRate
argument_list|,
name|ExpanderConnectionRate
argument_list|)
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: link rate changed current 0x%x new 0x%x\n"
operator|,
name|current_link_rate
operator|,
name|MIN
argument_list|(
name|connectionRate
argument_list|,
name|ExpanderConnectionRate
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_DEV_S_RATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|dev_s_rate
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|ExpDevice
operator|!=
name|agNULL
condition|)
block|{
name|oneAttachedExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
operator|&
name|oneAttachedExpDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|dmDeviceRateChange
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|agNULL
argument_list|,
name|dmDeviceArrival
argument_list|)
expr_stmt|;
block|}
block|}
name|DEVINFO_PUT_DEV_S_RATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|dev_s_rate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
block|}
return|return
name|oneDeviceData
return|;
block|}
comment|/* old device */
comment|/* new device */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: NEW qqqq initiator_ssp_stp_smp %d target_ssp_stp_smp %d\n"
operator|,
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|,
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate a new device and set the valid bit */
name|oneDeviceData
operator|=
name|dmAddSASToSharedcontext
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|,
name|oneExpDeviceData
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: no more device, oneDeviceData is null !!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* If a device is allocated */
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
comment|//    DM_DBG3(("dmPortSASDeviceAdd: sasAddressHi 0x%08x\n", SA_IDFRM_GET_SAS_ADDRESSHI(&sasIdentify)));
comment|//    DM_DBG3(("dmPortSASDeviceAdd: sasAddressLo 0x%08x\n", SA_IDFRM_GET_SAS_ADDRESSLO(&sasIdentify)));
comment|//    oneDeviceData->sasIdentify = sasIdentify;
name|dm_memcpy
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|sasIdentify
operator|)
argument_list|,
operator|&
name|sasIdentify
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSASIdentify_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: NEW, UP_STREAM\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: NEW, DOWN_STREAM\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: FULL_START\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|MCN
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/* incremental */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: INCREMENTAL_START\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|MCN
operator|==
literal|0
operator|&&
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agFALSE
condition|)
block|{
name|oneDeviceData
operator|->
name|MCN
operator|++
expr_stmt|;
block|}
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: oneDeviceData MCN 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|MCN
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: oneDeviceData sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: sasAddressHi 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: sasAddressLo 0x%08x\n"
operator|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* parse sasIDframe to fill in agDeviceInfo */
name|DEVINFO_PUT_SMPTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|DEFAULT_SMP_TIMEOUT
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_ITNEXUSTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|itNexusTimeout
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FBS
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|firstBurstSize
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FLAG
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|=
name|SA_IDFRM_GET_DEVICETTYPE
argument_list|(
operator|&
name|sasIdentify
argument_list|)
expr_stmt|;
comment|/* adjusting connectionRate */
name|oneAttachedExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
if|if
condition|(
name|oneAttachedExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|connectionRate
operator|=
name|MIN
argument_list|(
name|connectionRate
argument_list|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: 2nd connectionRate 0x%x  DEVINFO_GET_LINKRATE(&oneAttachedExpDeviceData->agDeviceInfo) 0x%x\n"
operator|,
name|connectionRate
operator|,
name|DEVINFO_GET_LINKRATE
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|agDeviceInfo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: 2nd oneAttachedExpDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Device Type, SAS or SATA, connection rate; bit7 --- bit0 */
name|sasorsata
operator|=
operator|(
name|bit8
operator|)
name|deviceType
expr_stmt|;
name|dev_s_rate
operator|=
name|dev_s_rate
operator||
operator|(
name|sasorsata
operator|<<
literal|4
operator|)
expr_stmt|;
name|dev_s_rate
operator|=
name|dev_s_rate
operator||
name|MIN
argument_list|(
name|connectionRate
argument_list|,
name|ExpanderConnectionRate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_DEV_S_RATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|dev_s_rate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|agDeviceInfo
argument_list|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|osData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|agContext
operator|.
name|sdkData
operator|=
name|agNULL
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* reporting to TDM; setting dmDeviceInfo */
name|DEVINFO_PUT_SMPTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|DEFAULT_SMP_TIMEOUT
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_ITNEXUSTO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|itNexusTimeout
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FBS
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
operator|(
name|bit16
operator|)
name|firstBurstSize
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_FLAG
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_INITIATOR_SSP_STP_SMP
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_TARGET_SSP_STP_SMP
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
argument_list|)
expr_stmt|;
name|extension
operator|=
name|phyID
expr_stmt|;
comment|/* setting 6th bit of dev_s_rate */
if|if
condition|(
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
operator|||
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
name|extension
operator|=
call|(
name|bit16
call|)
argument_list|(
name|extension
operator||
operator|(
literal|1
operator|<<
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
name|DEVINFO_PUT_EXT
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|extension
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_DEV_S_RATE
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|dev_s_rate
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|SA_IDFRM_GET_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|SA_IDFRM_GET_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneDeviceData
operator|->
name|sasIdentify
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|ExpDevice
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: attached expander case\n"
operator|)
argument_list|)
expr_stmt|;
name|oneAttachedExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
comment|/*         Puts attached expander's SAS address into dmDeviceInfo       */
name|DEVINFO_PUT_SAS_ADDRESSLO
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|oneAttachedExpDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
name|DEVINFO_PUT_SAS_ADDRESSHI
argument_list|(
operator|&
name|oneAttachedExpDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|oneAttachedExpDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: oneAttachedExpDeviceData addrHi 0x%08x addrLo 0x%08x PhyID 0x%x ext 0x%x\n"
operator|,
name|DM_GET_SAS_ADDRESSHI
argument_list|(
name|oneAttachedExpDeviceData
operator|->
name|dmDeviceInfo
operator|.
name|sasAddressHi
argument_list|)
operator|,
name|DM_GET_SAS_ADDRESSLO
argument_list|(
name|oneAttachedExpDeviceData
operator|->
name|dmDeviceInfo
operator|.
name|sasAddressLo
argument_list|)
operator|,
name|phyID
operator|,
name|extension
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneAttachedExpDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
literal|0x0
operator|&&
name|oneAttachedExpDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
literal|0x0
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: 2nd Wrong expander!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|reported
operator|==
name|agFALSE
condition|)
block|{
name|oneDeviceData
operator|->
name|registered
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|reported
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|deviceType
operator|==
name|STP_DEVICE_TYPE
condition|)
block|{
comment|/*STP device, DM need send SMP Report Phy SATA to get the SATA device type */
name|oneAttachedExpDeviceData
operator|->
name|dmExpander
operator|->
name|dmDeviceToProcess
operator|=
name|oneDeviceData
expr_stmt|;
name|dmReportPhySataSend
argument_list|(
name|dmRoot
argument_list|,
name|oneAttachedExpDeviceData
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAS or SMP device */
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
operator|&
name|oneAttachedExpDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|dmDeviceArrival
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmPortSASDeviceAdd: NO attached expander case\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|reported
operator|==
name|agFALSE
condition|)
block|{
name|oneDeviceData
operator|->
name|registered
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|reported
operator|=
name|agTRUE
expr_stmt|;
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|agNULL
argument_list|,
name|dmDeviceArrival
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|oneDeviceData
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|dmDeviceData_t
modifier|*
name|dmFindRegNValid
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmSASSubID_t
modifier|*
name|dmSASSubID
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: Full discovery\n"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmFindRegNValid: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agFALSE
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|dmSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|dmSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* incremental discovery */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: Incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmFindRegNValid: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agFALSE
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|dmSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|dmSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: end returning NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindRegNValid: end returning NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|oneDeviceData
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmNotifyBC
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmPortContext_t
modifier|*
name|dmPortContext
parameter_list|,
name|bit32
name|type
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|dmPortContext
operator|->
name|dmData
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmNotifyBC: onePortContext is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|type
operator|==
name|OSSA_HW_EVENT_BROADCAST_CHANGE
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryAbortInProgress
operator|==
name|agFALSE
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_COMPLETED
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: BROADCAST_CHANGE\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|DM_DSTATE_NOT_STARTED
expr_stmt|;
name|onePortContext
operator|->
name|discoveryOptions
operator|=
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
expr_stmt|;
comment|/* processed broadcast change */
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: pid %d BROADCAST_CHANGE; updating SeenBC. Do nothing.\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|OSSA_HW_EVENT_BROADCAST_SES
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: OSSA_HW_EVENT_BROADCAST_SES\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|OSSA_HW_EVENT_BROADCAST_EXP
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: OSSA_HW_EVENT_BROADCAST_EXP\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: unspecified broadcast type 0x%x\n"
operator|,
name|type
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|WORKED
end_ifdef

begin_comment
comment|/* triggers incremental discovery */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmNotifyBC
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmPortContext_t
modifier|*
name|dmPortContext
parameter_list|,
name|bit32
name|type
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|dmPortContext
operator|->
name|dmData
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|OSSA_HW_EVENT_BROADCAST_CHANGE
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_COMPLETED
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: BROADCAST_CHANGE; does incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|DM_DSTATE_NOT_STARTED
expr_stmt|;
name|onePortContext
operator|->
name|discoveryOptions
operator|=
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
expr_stmt|;
comment|/* processed broadcast change */
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|ResetTriggerred
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: tdsaBCTimer\n"
operator|)
argument_list|)
expr_stmt|;
name|dmBCTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dmDiscover
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: pid %d BROADCAST_CHANGE; updating SeenBC. Do nothing.\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|OSSA_HW_EVENT_BROADCAST_SES
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: OSSA_HW_EVENT_BROADCAST_SES\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|OSSA_HW_EVENT_BROADCAST_EXP
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: OSSA_HW_EVENT_BROADCAST_EXP\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmNotifyBC: unspecified broadcast type 0x%x\n"
operator|,
name|type
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|osGLOBAL
name|bit32
name|dmResetFailedDiscovery
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmPortContext_t
modifier|*
name|dmPortContext
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmResetFailedDiscovery: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|dmPortContext
operator|->
name|dmData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmResetFailedDiscovery: onePortContext is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_COMPLETED_WITH_FAILURE
condition|)
block|{
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|DM_DSTATE_COMPLETED
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmResetFailedDiscovery: discovery is NOT DM_DSTATE_COMPLETED_WITH_FAILURE. It is 0x%x\n"
operator|,
name|onePortContext
operator|->
name|DiscoveryState
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
return|return
name|DM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|dmQueryDiscovery
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmPortContext_t
modifier|*
name|dmPortContext
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmQueryDiscovery: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|dmPortContext
operator|->
name|dmData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmQueryDiscovery: onePortContext is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
comment|/* call tddmQueryDiscoveryCB() */
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_COMPLETED
condition|)
block|{
name|tddmQueryDiscoveryCB
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|onePortContext
operator|->
name|discoveryOptions
argument_list|,
name|dmDiscCompleted
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_COMPLETED_WITH_FAILURE
condition|)
block|{
name|tddmQueryDiscoveryCB
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|onePortContext
operator|->
name|discoveryOptions
argument_list|,
name|dmDiscFailed
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmQueryDiscoveryCB
argument_list|(
name|dmRoot
argument_list|,
name|dmPortContext
argument_list|,
name|onePortContext
operator|->
name|discoveryOptions
argument_list|,
name|dmDiscInProgress
argument_list|)
expr_stmt|;
block|}
return|return
name|DM_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/*    should only for an expander */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|dmRegisterDevice
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmPortContext_t
modifier|*
name|dmPortContext
parameter_list|,
name|dmDeviceInfo_t
modifier|*
name|dmDeviceInfo
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|bit32
name|sasAddressHi
decl_stmt|,
name|sasAddressLo
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmSASSubID_t
name|dmSASSubID
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRegisterDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|dmPortContext
operator|->
name|dmData
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmRegisterDevice: onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmRegisterDevice: invalid port!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
name|onePortContext
operator|->
name|RegFailed
operator|=
name|agFALSE
expr_stmt|;
comment|/* tdssAddSASToSharedcontext() from ossaHwCB() osGLOBAL void tdssAddSASToSharedcontext(                           tdsaPortContext_t    *tdsaPortContext_Instance,                           agsaRoot_t           *agRoot,                           agsaDevHandle_t      *agDevHandle,                           tdsaSASSubID_t       *agSASSubID,                           bit32                registered,                           bit8                 phyID,                           bit32                flag                           ); from discovery   osGLOBAL tdsaDeviceData_t * tdssNewAddSASToSharedcontext(                                  agsaRoot_t           *agRoot,                                  tdsaPortContext_t    *onePortContext,                                  tdsaSASSubID_t       *agSASSubID,                                  tdsaDeviceData_t     *oneExpDeviceData,                                  bit8                 phyID                                  );      */
comment|/* start here */
name|dmSASSubID
operator|.
name|sasAddressHi
operator|=
name|DM_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|sasAddressLo
operator|=
name|DM_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|dmSASSubID
operator|.
name|initiator_ssp_stp_smp
operator|=
name|dmDeviceInfo
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|dmSASSubID
operator|.
name|target_ssp_stp_smp
operator|=
name|dmDeviceInfo
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|=
name|dmAddSASToSharedcontext
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
operator|&
name|dmSASSubID
argument_list|,
name|agNULL
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmRegisterDevice: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|devType_S_Rate
operator|=
name|dmDeviceInfo
operator|->
name|devType_S_Rate
expr_stmt|;
name|dm_memcpy
argument_list|(
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|sasAddressHi
argument_list|,
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dm_memcpy
argument_list|(
name|oneDeviceData
operator|->
name|agDeviceInfo
operator|.
name|sasAddressLo
argument_list|,
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* finds the type of expanders */
if|if
condition|(
name|DEVINFO_GET_EXT_SMP
argument_list|(
name|dmDeviceInfo
argument_list|)
condition|)
block|{
if|if
condition|(
name|DEVINFO_GET_EXT_EXPANDER_TYPE
argument_list|(
name|dmDeviceInfo
argument_list|)
operator|==
name|SAS_EDGE_EXPANDER_DEVICE
condition|)
block|{
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|=
name|SAS_EDGE_EXPANDER_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|DEVINFO_GET_EXT_EXPANDER_TYPE
argument_list|(
name|dmDeviceInfo
argument_list|)
operator|==
name|SAS_FANOUT_EXPANDER_DEVICE
condition|)
block|{
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|=
name|SAS_FANOUT_EXPANDER_DEVICE
expr_stmt|;
block|}
else|else
block|{
comment|/* default */
name|DM_DBG4
argument_list|(
operator|(
literal|"dmRegisterDevice: no expander type. default to edge expander\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SASSpecDeviceType
operator|=
name|SAS_EDGE_EXPANDER_DEVICE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|DEVINFO_GET_EXT_MCN
argument_list|(
name|dmDeviceInfo
argument_list|)
operator|==
literal|0xF
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmRegisterDevice: directly attached expander\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|directlyAttached
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|dmDeviceInfo
operator|.
name|ext
operator|=
call|(
name|bit16
call|)
argument_list|(
name|oneDeviceData
operator|->
name|dmDeviceInfo
operator|.
name|ext
operator||
operator|(
literal|0xF
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmRegisterDevice: NOT directly attached expander\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|directlyAttached
operator|=
name|agFALSE
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_NOT_STARTED
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRegisterDevice: DM_DSTATE_NOT_STARTED\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* before the discovery is started */
name|oneExpander
operator|=
name|dmDiscoveringExpanderAlloc
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|oneExpander
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
comment|/* update SAS address field */
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|=
name|DM_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|=
name|DM_GET_SAS_ADDRESSLO
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRegisterDevice: AddrHi 0x%08x AddrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoveringExpanderAdd
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmRegisterDevice: failed to allocate expander !!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* remember that the registration failed so that a discovery can't be started */
name|onePortContext
operator|->
name|RegFailed
operator|=
name|agTRUE
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
block|}
else|else
block|{
comment|/*       the discovery has started. Alloc and add have been done.       find an expander using dmDeviceInfo, and update the expander's agDevHandle       call dmExpFind()     */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRegisterDevice: NOT DM_DSTATE_NOT_STARTED\n"
operator|)
argument_list|)
expr_stmt|;
name|sasAddressHi
operator|=
name|DM_GET_SAS_ADDRESSHI
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressHi
argument_list|)
expr_stmt|;
name|sasAddressLo
operator|=
name|DM_GET_SAS_ADDRESSLO
argument_list|(
name|dmDeviceInfo
operator|->
name|sasAddressLo
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmRegisterDevice: AddrHi 0x%08x AddrLo 0x%08x\n"
operator|,
name|sasAddressHi
operator|,
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|=
name|dmExpFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|sasAddressHi
argument_list|,
name|sasAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|oneExpander
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmRegisterDevice: not allowed case, wrong !!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|DM_RC_FAILURE
return|;
block|}
block|}
return|return
name|DM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|dmExpander_t
modifier|*
name|dmDiscoveringExpanderAlloc
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAlloc: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAlloc: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAlloc: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAlloc: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAlloc: invalid port!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
comment|/* check exitence in dmAllShared->mainExpanderList */
name|oneExpander
operator|=
name|dmExpMainListFind
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
argument_list|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|freeExpanderList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAlloc: no free expanders pid %d!!!\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|ExpanderList
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeExpanderList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|oneExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneExpander
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAlloc: pid %d exp id %d \n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|dmDevice
operator|=
name|oneDeviceData
expr_stmt|;
name|oneExpander
operator|->
name|dmUpStreamExpander
operator|=
name|agNULL
expr_stmt|;
name|oneExpander
operator|->
name|dmCurrentDownStreamExpander
operator|=
name|agNULL
expr_stmt|;
name|oneExpander
operator|->
name|dmReturnginExpander
operator|=
name|agNULL
expr_stmt|;
name|oneExpander
operator|->
name|hasUpStreamDevice
operator|=
name|agFALSE
expr_stmt|;
name|oneExpander
operator|->
name|numOfUpStreamPhys
operator|=
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|currentUpStreamPhyIndex
operator|=
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|discoveringPhyId
operator|=
literal|0
expr_stmt|;
name|oneExpander
operator|->
name|underDiscovering
operator|=
name|agFALSE
expr_stmt|;
name|dm_memset
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|currentIndex
operator|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|oneExpander
operator|->
name|currentIndex
argument_list|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|dmExpander
operator|=
name|oneExpander
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAlloc: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAlloc: oneExpander %p did %d\n"
operator|,
name|oneDeviceData
operator|->
name|dmExpander
operator|,
name|oneDeviceData
operator|->
name|dmExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|oneExpander
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoveringExpanderAdd
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAdd: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAdd: expander id %d\n"
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAdd: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAdd: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAdd: invalid port!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAdd: UPSTREAM\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAdd: DOWNSTREAM\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAdd: status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneExpander
operator|->
name|underDiscovering
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderAdd: ADDED \n"
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|underDiscovering
operator|=
name|agTRUE
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|dmExpander_t
modifier|*
name|dmFindConfigurableExp
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|dmExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|tmpOnePortContext
init|=
name|onePortContext
decl_stmt|;
name|dmExpander_t
modifier|*
name|ret
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindConfigurableExp: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindConfigurableExp: NULL expander\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindConfigurableExp: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindConfigurableExp: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindConfigurableExp: empty UpdiscoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
name|tempExpander
operator|=
name|oneExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
while|while
condition|(
name|tempExpander
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindConfigurableExp: loop exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindConfigurableExp: loop exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempExpander
operator|->
name|configRouteTable
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindConfigurableExp: found configurable expander\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|tempExpander
expr_stmt|;
break|break;
block|}
name|tempExpander
operator|=
name|tempExpander
operator|->
name|dmUpStreamExpander
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|dmDuplicateConfigSASAddr
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|bit32
name|configSASAddressHi
parameter_list|,
name|bit32
name|configSASAddressLo
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
name|bit32
name|ret
init|=
name|agFALSE
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: NULL expander\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
if|if
condition|(
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|configSASAddressHi
operator|&&
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|configSASAddressLo
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: unnecessary\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: configsasAddressHi 0x%08x\n"
operator|,
name|configSASAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: configsasAddressLo 0x%08x\n"
operator|,
name|configSASAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: configSASAddrTableIndex %d\n"
operator|,
name|oneExpander
operator|->
name|configSASAddrTableIndex
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|configSASAddrTableIndex
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|configSASAddressHiTable
index|[
name|i
index|]
operator|==
name|configSASAddressHi
operator|&&
name|oneExpander
operator|->
name|configSASAddressLoTable
index|[
name|i
index|]
operator|==
name|configSASAddressLo
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: FOUND\n"
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
comment|/* new one; let's add it */
if|if
condition|(
name|ret
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: adding configSAS Addr\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDuplicateConfigSASAddr: configSASAddrTableIndex %d\n"
operator|,
name|oneExpander
operator|->
name|configSASAddrTableIndex
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|->
name|configSASAddressHiTable
index|[
name|oneExpander
operator|->
name|configSASAddrTableIndex
index|]
operator|=
name|configSASAddressHi
expr_stmt|;
name|oneExpander
operator|->
name|configSASAddressLoTable
index|[
name|oneExpander
operator|->
name|configSASAddrTableIndex
index|]
operator|=
name|configSASAddressLo
expr_stmt|;
name|oneExpander
operator|->
name|configSASAddrTableIndex
operator|++
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit16
name|dmFindCurrentDownStreamPhyIndex
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|dmExpander_t
modifier|*
name|DownStreamExpander
decl_stmt|;
name|bit16
name|index
init|=
literal|0
decl_stmt|;
name|bit16
name|i
decl_stmt|;
name|bit8
name|phyId
init|=
literal|0
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindCurrentDownStreamPhyIndex: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmFindCurrentDownStreamPhyIndex: wrong, oneExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|DownStreamExpander
operator|=
name|oneExpander
operator|->
name|dmCurrentDownStreamExpander
expr_stmt|;
if|if
condition|(
name|DownStreamExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmFindCurrentDownStreamPhyIndex: wrong, DownStreamExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindCurrentDownStreamPhyIndex: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindCurrentDownStreamPhyIndex: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindCurrentDownStreamPhyIndex: downstream exp addrHi 0x%08x\n"
operator|,
name|DownStreamExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindCurrentDownStreamPhyIndex: downstream exp addrLo 0x%08x\n"
operator|,
name|DownStreamExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindCurrentDownStreamPhyIndex: numOfDownStreamPhys %d\n"
operator|,
name|oneExpander
operator|->
name|numOfDownStreamPhys
operator|)
argument_list|)
expr_stmt|;
name|phyId
operator|=
name|DownStreamExpander
operator|->
name|upStreamPhys
index|[
literal|0
index|]
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindCurrentDownStreamPhyIndex: phyId %d\n"
operator|,
name|phyId
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oneExpander
operator|->
name|numOfDownStreamPhys
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|oneExpander
operator|->
name|downStreamPhys
index|[
name|i
index|]
operator|==
name|phyId
condition|)
block|{
name|index
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindCurrentDownStreamPhyIndex: index %d\n"
operator|,
name|index
operator|)
argument_list|)
expr_stmt|;
return|return
name|index
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|dmFindDiscoveringExpander
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|dmList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|dmExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|tmpOnePortContext
init|=
name|onePortContext
decl_stmt|;
name|bit32
name|ret
init|=
name|agFALSE
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindDiscoveringExpander: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindDiscoveringExpander: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindDiscoveringExpander: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindDiscoveringExpander: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempExpander
operator|==
name|oneExpander
condition|)
block|{
if|if
condition|(
name|tempExpander
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindDiscoveringExpander: match, expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindDiscoveringExpander: exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmFindDiscoveringExpander: exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoveringExpanderRemove
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: expander id %d\n"
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: exp addrHi 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: exp addrLo 0x%08x\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: BEFORE\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|dmDumpAllUpExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|dmDumpAllFreeExp
argument_list|(
name|dmRoot
argument_list|)
expr_stmt|;
comment|// if is temporary till smp problem is fixed
if|if
condition|(
name|dmFindDiscoveringExpander
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: oneDeviceData %p did %d\n"
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|,
name|oneExpander
operator|->
name|dmDevice
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: oneExpander %p did %d\n"
operator|,
name|oneExpander
operator|,
name|oneExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|!=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|dmExpander
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: before !!! wrong !!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|oneExpander
operator|->
name|underDiscovering
operator|=
name|agFALSE
expr_stmt|;
name|oneExpander
operator|->
name|discoveringPhyId
operator|=
literal|0
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_UP_STREAM
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: DISCOVERY_UP_STREAM\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|upNode
operator|)
argument_list|,
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|.
name|UpdiscoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|NumOfUpExp
operator|++
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: Status %d\n"
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
argument_list|)
expr_stmt|;
comment|//      DMLIST_ENQUEUE_AT_TAIL(&(oneExpander->linkNode),&(dmAllShared->freeExpanderList));
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
comment|// error checking
if|if
condition|(
name|oneExpander
operator|!=
name|oneExpander
operator|->
name|dmDevice
operator|->
name|dmExpander
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: after !!! wrong !!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|//end temp if
else|else
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: !!! problem !!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveringExpanderRemove: AFTER\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|dmDumpAllUpExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|dmDumpAllFreeExp
argument_list|(
name|dmRoot
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*   returns an expander with sasAddrLo, sasAddrHi from dmAllShared->mainExpanderList */
end_comment

begin_function
name|osGLOBAL
name|dmExpander_t
modifier|*
name|dmExpMainListFind
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|sasAddrHi
parameter_list|,
name|bit32
name|sasAddrLo
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|dmExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpMainListFind: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmExpMainListFind: empty mainExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|dmAllShared
operator|->
name|mainExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmExpMainListFind: tempExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpMainListFind: expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpMainListFind: exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpMainListFind: exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|sasAddrHi
operator|)
operator|&&
operator|(
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|sasAddrLo
operator|)
operator|&&
operator|(
name|tempExpander
operator|->
name|dmDevice
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpMainListFind: found expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpMainListFind: found exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpMainListFind: found exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
return|return
name|tempExpander
return|;
block|}
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
return|return
name|agNULL
return|;
block|}
end_function

begin_comment
comment|/*   returns an expander with sasAddrLo, sasAddrHi from discoveringExpanderList */
end_comment

begin_function
name|osGLOBAL
name|dmExpander_t
modifier|*
name|dmExpFind
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|sasAddrHi
parameter_list|,
name|bit32
name|sasAddrLo
parameter_list|)
block|{
name|dmList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|dmExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|tmpOnePortContext
init|=
name|onePortContext
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpFind: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpFind tdsaDumpAllExp: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmExpFind: tempExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpFind: expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpFind: exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpFind: exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|sasAddrHi
operator|)
operator|&&
operator|(
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|sasAddrLo
operator|)
operator|&&
operator|(
name|tempExpander
operator|->
name|dmDevice
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmExpFind: found\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|tempExpander
return|;
block|}
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
return|return
name|agNULL
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|dmDiscoverCheck
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverCheck: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverCheck: onePortContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverCheck: invalid port!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_COMPLETED
operator|||
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_SAS_DONE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverCheck: aborted discovery!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmDiscoverCB
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
name|dmDiscAborted
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
return|return
name|agFALSE
return|;
block|}
end_function

begin_comment
comment|/* ??? needs to handle pending SMPs     move from dmAllShared->discoveringExpanderList to dmAllShared->mainExpanderList   */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmDiscoverAbort
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_COMPLETED
operator|||
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_SAS_DONE
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverAbort: not allowed case!!! onePortContext->DiscoveryState 0x%x onePortContext->discovery.status 0x%x\n"
operator|,
name|onePortContext
operator|->
name|DiscoveryState
operator|,
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|DM_DSTATE_COMPLETED
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_SAS_DONE
expr_stmt|;
comment|/* move from dmAllShared->discoveringExpanderList to dmAllShared->mainExpanderList */
name|dmCleanAllExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* move from dmAllShared->discoveringExpanderList to dmAllShared->mainExpanderList */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmCleanAllExp
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|dmExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|tmpOnePortContext
init|=
name|onePortContext
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: before all clean up\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllFreeExp
argument_list|(
name|dmRoot
argument_list|)
expr_stmt|;
comment|/* clean up UpdiscoveringExpanderList*/
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: clean discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmCleanAllExp: tempExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: exp id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|=
name|dmExpMainListFind
argument_list|(
name|dmRoot
argument_list|,
name|tmpOnePortContext
argument_list|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
argument_list|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: moving\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: moving, exp id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* putting back to the free pool */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|tempExpander
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
comment|//      DMLIST_ENQUEUE_AT_TAIL(&(tempExpander->linkNode),&(dmAllShared->freeExpanderList));
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|tempExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|.
name|flink
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: in mainExpanderList; skippig\n"
operator|)
argument_list|)
expr_stmt|;
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* reset discoveringExpanderList */
name|DMLIST_INIT_HDR
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|discoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
comment|/* clean up UpdiscoveringExpanderList*/
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: clean UpdiscoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|UpdiscoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: empty UpdiscoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|UpdiscoveringExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|UpdiscoveringExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|upNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmCleanAllExp: tempExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: exp id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneExpander
operator|=
name|dmExpMainListFind
argument_list|(
name|dmRoot
argument_list|,
name|tmpOnePortContext
argument_list|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
argument_list|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: moving\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: moving exp id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|tempExpander
operator|->
name|upNode
operator|)
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|tempExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|UpdiscoveringExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|UpdiscoveringExpanderList
operator|.
name|flink
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: in mainExpanderList; skippig\n"
operator|)
argument_list|)
expr_stmt|;
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
block|}
comment|/* reset UpdiscoveringExpanderList */
name|DMLIST_INIT_HDR
argument_list|(
operator|&
operator|(
name|tmpOnePortContext
operator|->
name|discovery
operator|.
name|UpdiscoveringExpanderList
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmCleanAllExp: after all clean up\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllFreeExp
argument_list|(
name|dmRoot
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmInternalRemovals
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmInternalRemovals: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: valid %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: directlyAttached %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: right portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: full discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: different portcontext; oneDeviceData->dmPortContext pid %d oneportcontext pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|dmPortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmInternalRemovals: different portcontext; oneDeviceData->dmPortContext pid NULL oneportcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoveryResetProcessed
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryResetProcessed: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* reinitialize the device data belonging to this portcontext */
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryResetProcessed: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryResetProcessed: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryResetProcessed: resetting procssed flag\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|processed
operator|=
name|agFALSE
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*   calls osGLOBAL void  tddmDiscoverCB(                dmRoot_t 		*dmRoot,                dmPortContext_t		*dmPortContext,                bit32			eventStatus               )    */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmDiscoverDone
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverDone: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverDone: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* Set discovery status */
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|=
name|DISCOVERY_SAS_DONE
expr_stmt|;
comment|/* clean up expanders data strucures; move to free exp when device is cleaned */
name|dmCleanAllExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|dmDumpAllMainExp
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|dmDiscoveryResetProcessed
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|dmDiscoveryDumpMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverDone: broadcast change; discover again\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoveryResetMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|dmInternalRemovals
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
comment|/* processed broadcast change */
name|onePortContext
operator|->
name|discovery
operator|.
name|SeenBC
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|ResetTriggerred
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverDone: dmBCTimer\n"
operator|)
argument_list|)
expr_stmt|;
name|dmBCTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dmIncrementalDiscover
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|DM_DSTATE_COMPLETED
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_FULL_START
condition|)
block|{
if|if
condition|(
name|flag
operator|==
name|DM_RC_SUCCESS
condition|)
block|{
name|dmResetReported
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|dmDiscoveryReportMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
comment|/* call tddmDiscoverCB() */
name|tddmDiscoverCB
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
name|dmDiscCompleted
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|!=
name|DM_RC_SUCCESS
operator|||
name|onePortContext
operator|->
name|discovery
operator|.
name|DeferredError
operator|==
name|agTRUE
condition|)
block|{
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|DM_DSTATE_COMPLETED_WITH_FAILURE
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverDone: Error; clean up!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoveryInvalidateDevices
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|tddmDiscoverCB
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
name|dmDiscFailed
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|flag
operator|==
name|DM_RC_SUCCESS
condition|)
block|{
name|dmReportChanges
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|dmDiscoveryReportMCN
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|tddmDiscoverCB
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
name|dmDiscCompleted
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|!=
name|DM_RC_SUCCESS
operator|||
name|onePortContext
operator|->
name|discovery
operator|.
name|DeferredError
operator|==
name|agTRUE
condition|)
block|{
name|onePortContext
operator|->
name|DiscoveryState
operator|=
name|DM_DSTATE_COMPLETED_WITH_FAILURE
expr_stmt|;
name|dmDiscoveryInvalidateDevices
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
name|tddmDiscoverCB
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
name|dmDiscFailed
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/* called by dmDiscoveryErrorRemovals() or dmReportRemovals() on discovery failure */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmSubReportRemovals
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|dmDeviceData_t
modifier|*
name|oneAttachedExpDeviceData
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSubReportRemovals: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSubReportRemovals: flag 0x%x\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|==
name|dmDeviceRemoval
condition|)
block|{
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|ExpDevice
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSubReportRemovals: attached expander case\n"
operator|)
argument_list|)
expr_stmt|;
name|oneAttachedExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
operator|&
name|oneAttachedExpDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|flag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSubReportRemovals: NO attached expander case\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|agNULL
argument_list|,
name|flag
argument_list|)
expr_stmt|;
block|}
comment|/* this function is called at the end of discovery; reinitalizes oneDeviceData->reported */
name|oneDeviceData
operator|->
name|reported
operator|=
name|agFALSE
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* called by dmReportChanges() on discovery success */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmSubReportChanges
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|dmDeviceData_t
modifier|*
name|oneAttachedExpDeviceData
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSubReportChanges: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSubReportChanges: flag 0x%x\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|==
name|dmDeviceRemoval
condition|)
block|{
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|reported
operator|==
name|agFALSE
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|ExpDevice
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSubReportChanges: attached expander case\n"
operator|)
argument_list|)
expr_stmt|;
name|oneAttachedExpDeviceData
operator|=
name|oneDeviceData
operator|->
name|ExpDevice
expr_stmt|;
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
operator|&
name|oneAttachedExpDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|flag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSubReportChanges: NO attached expander case\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmReportDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|dmDeviceInfo
argument_list|,
name|agNULL
argument_list|,
name|flag
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSubReportChanges: skip; been reported\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* this function is called at the end of discovery; reinitalizes oneDeviceData->reported */
name|oneDeviceData
operator|->
name|reported
operator|=
name|agFALSE
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*   should add or remove be reported per device??? */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmReportChanges
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|added
init|=
name|agFALSE
decl_stmt|,
name|removed
init|=
name|agFALSE
decl_stmt|;
comment|//  dmDeviceData_t    *oneAttachedExpDeviceData = agNULL;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportChanges: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: right portcontext\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|&&
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|onePortContext
operator|->
name|sasRemoteAddressLo
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportChanges: keep, not reporting did 0x%x\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: same\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* reset valid bit */
name|oneDeviceData
operator|->
name|valid
operator|=
name|oneDeviceData
operator|->
name|valid2
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|dmSubReportChanges
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmDeviceNoChange
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agFALSE
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: removed\n"
operator|)
argument_list|)
expr_stmt|;
name|removed
operator|=
name|agTRUE
expr_stmt|;
comment|/* reset valid bit */
name|oneDeviceData
operator|->
name|valid
operator|=
name|oneDeviceData
operator|->
name|valid2
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|onePortContext
operator|->
name|RegisteredDevNums
operator|--
expr_stmt|;
name|dmSubReportChanges
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmDeviceRemoval
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: added\n"
operator|)
argument_list|)
expr_stmt|;
name|added
operator|=
name|agTRUE
expr_stmt|;
comment|/* reset valid bit */
name|oneDeviceData
operator|->
name|valid
operator|=
name|oneDeviceData
operator|->
name|valid2
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|dmSubReportChanges
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmDeviceArrival
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: else\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: different portcontext\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
comment|/*   osGLOBAL void  tddmReportDevice(                  dmRoot_t 		*dmRoot,                  dmPortContext_t	*dmPortContext,                  dmDeviceInfo_t		*dmDeviceInfo,                  dmDeviceInfo_t		*dmExpDeviceInfo, 		 bit32                   flag 		                   )    */
comment|/* arrival or removal at once */
if|if
condition|(
name|added
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: added at the end\n"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* TBD */
block|ostiInitiatorEvent(                          tiRoot,                          onePortContext->tiPortalContext,                          agNULL,                          tiIntrEventTypeDeviceChange,                          tiDeviceArrival,                          agNULL                          );
endif|#
directive|endif
block|}
if|if
condition|(
name|removed
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: removed at the end\n"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* TBD */
block|ostiInitiatorEvent(                        tiRoot,                        onePortContext->tiPortalContext,                        agNULL,                        tiIntrEventTypeDeviceChange,                        tiDeviceRemoval,                        agNULL                        );
endif|#
directive|endif
block|}
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|forcedOK
operator|==
name|agTRUE
operator|&&
name|added
operator|==
name|agFALSE
operator|&&
name|removed
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: missed chance to report. forced to report OK\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|discovery
operator|.
name|forcedOK
operator|=
name|agFALSE
expr_stmt|;
if|#
directive|if
literal|0
comment|/* TBD */
block|ostiInitiatorEvent(                        tiRoot,                        onePortContext->tiPortalContext,                        agNULL,                        tiIntrEventTypeDiscovery,                         tiDiscOK,                         agNULL                        );
endif|#
directive|endif
block|}
if|if
condition|(
name|added
operator|==
name|agFALSE
operator|&&
name|removed
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportChanges: the same\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmReportRemovals
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|removed
init|=
name|agFALSE
decl_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportRemovals: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportRemovals: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: valid %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: directlyAttached %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: right portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|&&
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|onePortContext
operator|->
name|sasRemoteAddressLo
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmReportRemovals: keeping\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: removing\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* notify only reported devices to OS layer*/
if|if
condition|(
name|DEVICE_IS_SSP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
operator|||
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|removed
operator|=
name|agTRUE
expr_stmt|;
block|}
comment|/* all targets except expanders */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|RegisteredDevNums
operator|--
expr_stmt|;
name|dmSubReportRemovals
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmDeviceRemoval
argument_list|)
expr_stmt|;
comment|/* reset valid bit */
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* called by port invalid case */
if|if
condition|(
name|flag
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|dmPortContext
operator|=
name|agNULL
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: different portcontext; oneDeviceData->dmPortContext pid %d oneportcontext pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|dmPortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: different portcontext; oneDeviceData->dmPortContext pid NULL oneportcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
if|if
condition|(
name|removed
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmReportRemovals: removed at the end\n"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* TBD */
block|ostiInitiatorEvent(                          tiRoot,                          onePortContext->tiPortalContext,                          agNULL,                          tiIntrEventTypeDeviceChange,                          tiDeviceRemoval,                          agNULL                          );
endif|#
directive|endif
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmResetReported
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmResetReported: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: valid %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: directlyAttached %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: right portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|reported
operator|=
name|agFALSE
expr_stmt|;
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: different portcontext; oneDeviceData->dmPortContext pid %d oneportcontext pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|dmPortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmResetReported: different portcontext; oneDeviceData->dmPortContext pid NULL oneportcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/* called on discover failure */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmDiscoveryInvalidateDevices
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: valid %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: directlyAttached %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: right portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|&&
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|onePortContext
operator|->
name|sasRemoteAddressLo
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: keeping\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|registered
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|reported
operator|=
name|agFALSE
expr_stmt|;
comment|/* all targets other than expanders */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|RegisteredDevNums
operator|--
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: different portcontext; oneDeviceData->dmPortContext pid %d oneportcontext pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|dmPortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryInvalidateDevices: different portcontext; oneDeviceData->dmPortContext pid NULL oneportcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/*   should DM report the device removal to TDM on an error case?  or  DM simply removes the devices  For now, the second option. */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmDiscoveryErrorRemovals
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: empty device list\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: loop did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: valid %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: valid2 %d\n"
operator|,
name|oneDeviceData
operator|->
name|valid2
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: directlyAttached %d\n"
operator|,
name|oneDeviceData
operator|->
name|directlyAttached
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: right portcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|onePortContext
operator|->
name|sasRemoteAddressHi
operator|&&
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|onePortContext
operator|->
name|sasRemoteAddressLo
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: keeping\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|valid
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agFALSE
expr_stmt|;
comment|/* all targets other than expanders */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|RegisteredDevNums
operator|--
expr_stmt|;
name|dmSubReportRemovals
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmDeviceRemoval
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: different portcontext; oneDeviceData->dmPortContext pid %d oneportcontext pid %d\n"
operator|,
name|oneDeviceData
operator|->
name|dmPortContext
operator|->
name|id
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryErrorRemovals: different portcontext; oneDeviceData->dmPortContext pid NULL oneportcontext pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/* move from dmAllShared->mainExpanderList to dmAllShared->freeExpanderList */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmDiscoveryExpanderCleanUp
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|ExpanderList
init|=
name|agNULL
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryExpanderCleanUp: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     be sure to call     osGLOBAL void     dmExpanderDeviceDataReInit(                            dmRoot_t 	    *dmRoot,                             dmExpander_t     *oneExpander                           );    */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|ExpanderList
operator|=
name|dmAllShared
operator|->
name|mainExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
condition|)
block|{
name|oneExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryExpanderCleanUp: oneExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
name|oneExpander
operator|->
name|dmDevice
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryExpanderCleanUp: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryExpanderCleanUp: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|dmExpanderDeviceDataReInit
argument_list|(
name|dmRoot
argument_list|,
name|oneExpander
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|linkNode
operator|)
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneExpander
operator|->
name|linkNode
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeExpanderList
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|dmAllShared
operator|->
name|mainExpanderList
operator|.
name|flink
expr_stmt|;
block|}
else|else
block|{
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryExpanderCleanUp: empty mainExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* moves all devices from dmAllShared->MainDeviceList to dmAllShared->FreeDeviceList */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmDiscoveryDeviceCleanUp
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryDeviceCleanUp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoveryDeviceCleanUp: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryDeviceCleanUp: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryDeviceCleanUp: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
condition|)
block|{
name|dmDeviceDataReInit
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|onePortContext
operator|->
name|RegisteredDevNums
operator|--
expr_stmt|;
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
block|}
else|else
block|{
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryDeviceCleanUp: empty MainDeviceList\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDumpAllExp
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllExp: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDumpAllUpExp
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllUpExp: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDumpAllFreeExp
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllFreeExp: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDumpAllMainExp
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmList_t
modifier|*
name|ExpanderList
decl_stmt|;
name|dmExpander_t
modifier|*
name|tempExpander
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainExp: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainExp: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_EXPANDER_LOCK
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|dmAllShared
operator|->
name|mainExpanderList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|ExpanderList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|mainExpanderList
operator|)
condition|)
block|{
name|tempExpander
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmExpander_t
argument_list|,
name|linkNode
argument_list|,
name|ExpanderList
argument_list|)
expr_stmt|;
if|if
condition|(
name|tempExpander
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDumpAllMainExp: tempExpander is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainExp: expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainExp: exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainExp: exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tempExpander
operator|->
name|dmDevice
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainExp: found expander id %d\n"
operator|,
name|tempExpander
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainExp: found exp addrHi 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainExp: found exp addrLo 0x%08x\n"
operator|,
name|tempExpander
operator|->
name|dmDevice
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
name|ExpanderList
operator|=
name|ExpanderList
operator|->
name|flink
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDumpAllMainDevice
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|total
init|=
literal|0
decl_stmt|,
name|port_total
init|=
literal|0
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainDevice: empty discoveringExpanderList\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainDevice: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainDevice: oneDeviceData id %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainDevice: addrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainDevice: addrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|total
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainDevice: found oneDeviceData id %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainDevice: found addrHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainDevice: found addrLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|port_total
operator|++
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDumpAllMainDevice: total %d port_totaol %d\n"
operator|,
name|total
operator|,
name|port_total
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|dmDeviceData_t
modifier|*
name|dmAddSASToSharedcontext
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmSASSubID_t
modifier|*
name|dmSASSubID
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneExpDeviceData
parameter_list|,
name|bit8
name|phyID
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|new_device
init|=
name|agTRUE
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: oneportContext ID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: oneExpDeviceData sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|oneExpDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|,
name|oneExpDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: oneExpDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|dmSASSubID
operator|->
name|sasAddressHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|dmSASSubID
operator|->
name|sasAddressLo
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|new_device
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* new device */
if|if
condition|(
name|new_device
operator|==
name|agTRUE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: new device\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|dmSASSubID
operator|->
name|sasAddressHi
operator|,
name|dmSASSubID
operator|->
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DMLIST_NOT_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: empty DeviceData FreeLink\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDumpAllMainDevice
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|DMLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|DeviceListList
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|FreeLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: oneDeviceData %p pid %d did %d\n"
operator|,
name|oneDeviceData
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|->
name|Count
operator|++
expr_stmt|;
name|oneDeviceData
operator|->
name|dmRoot
operator|=
name|dmRoot
expr_stmt|;
comment|/* saving sas address */
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|=
name|dmSASSubID
operator|->
name|sasAddressLo
expr_stmt|;
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|=
name|dmSASSubID
operator|->
name|sasAddressHi
expr_stmt|;
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|=
name|dmSASSubID
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|=
name|dmSASSubID
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|dmPortContext
operator|=
name|onePortContext
expr_stmt|;
comment|/* handles both SAS target and STP-target, SATA-device */
if|if
condition|(
operator|!
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|&&
operator|!
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|DM_SAS_DEVICE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|DM_SATA_DEVICE
expr_stmt|;
block|}
if|if
condition|(
name|oneExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|oneDeviceData
operator|->
name|ExpDevice
operator|=
name|oneExpDeviceData
expr_stmt|;
block|}
comment|/* set phyID only when it has initial value of 0xFF */
if|if
condition|(
name|oneDeviceData
operator|->
name|phyID
operator|==
literal|0xFF
condition|)
block|{
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
block|}
comment|/* incremental discovery */
comment|/* add device to incremental-related link. Report using this link           when incremental discovery is done */
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_NOT_STARTED
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: DM_DSTATE_NOT_STARTED\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: full discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
comment|/* add the devicedata to the portcontext */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: one case pid %d did %d \n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: new case pid %d did %d phyID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
comment|/* old device */
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: old device\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: oneDeviceData %p did %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddressHi 0x%08x sasAddressLo 0x%08x\n"
operator|,
name|dmSASSubID
operator|->
name|sasAddressHi
operator|,
name|dmSASSubID
operator|->
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|dmRoot
operator|=
name|dmRoot
expr_stmt|;
comment|/* saving sas address */
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|=
name|dmSASSubID
operator|->
name|sasAddressLo
expr_stmt|;
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|=
name|dmSASSubID
operator|->
name|sasAddressHi
expr_stmt|;
name|oneDeviceData
operator|->
name|initiator_ssp_stp_smp
operator|=
name|dmSASSubID
operator|->
name|initiator_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|target_ssp_stp_smp
operator|=
name|dmSASSubID
operator|->
name|target_ssp_stp_smp
expr_stmt|;
name|oneDeviceData
operator|->
name|dmPortContext
operator|=
name|onePortContext
expr_stmt|;
comment|/* handles both SAS target and STP-target, SATA-device */
if|if
condition|(
operator|!
name|DEVICE_IS_SATA_DEVICE
argument_list|(
name|oneDeviceData
argument_list|)
operator|&&
operator|!
name|DEVICE_IS_STP_TARGET
argument_list|(
name|oneDeviceData
argument_list|)
condition|)
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|DM_SAS_DEVICE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|DeviceType
operator|=
name|DM_SATA_DEVICE
expr_stmt|;
block|}
if|if
condition|(
name|oneExpDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|oneDeviceData
operator|->
name|ExpDevice
operator|=
name|oneExpDeviceData
expr_stmt|;
block|}
comment|/* set phyID only when it has initial value of 0xFF */
if|if
condition|(
name|oneDeviceData
operator|->
name|phyID
operator|==
literal|0xFF
condition|)
block|{
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|DiscoveryState
operator|==
name|DM_DSTATE_NOT_STARTED
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: DM_DSTATE_NOT_STARTED\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|type
operator|==
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: incremental discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid2
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: full discovery\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrHi 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: sasAddrLo 0x%08x \n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
block|}
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmAddSASToSharedcontext: old case pid %d did %d phyID %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|oneDeviceData
return|;
block|}
end_function

begin_comment
comment|/* no checking of valid and valid2 */
end_comment

begin_function
name|osGLOBAL
name|dmDeviceData_t
modifier|*
name|dmDeviceFind
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|sasAddrHi
parameter_list|,
name|bit32
name|sasAddrLo
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDeviceFind: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|dmAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|dmAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDeviceFind: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|==
name|sasAddrHi
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|==
name|sasAddrLo
operator|)
operator|&&
comment|//        (oneDeviceData->valid == agTRUE)&&
operator|(
name|oneDeviceData
operator|->
name|dmPortContext
operator|==
name|onePortContext
operator|)
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDeviceFind: Found pid %d did %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDeviceFind: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDeviceFind: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|SASAddressID
operator|.
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDeviceFind: end returning NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDeviceFind: end returning NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|oneDeviceData
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmBCTimer
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmBCTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|BCTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|BCTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|dmSetTimerRequest
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|BCTimer
argument_list|,
name|BC_TIMER_VALUE
operator|/
name|dmAllShared
operator|->
name|usecsPerTick
argument_list|,
name|dmBCTimerCB
argument_list|,
name|onePortContext
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|dmAddTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|dmAllShared
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|BCTimer
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmBCTimerCB
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmBCTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|BCTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|BCTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|discovery
operator|->
name|ResetTriggerred
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|onePortContext
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|dmDiscover
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
operator|->
name|dmPortContext
argument_list|,
name|DM_DISCOVERY_OPTION_INCREMENTAL_START
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* discovery related SMP timers */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmDiscoverySMPTimer
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|bit32
name|functionCode
parameter_list|,
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverySMPTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverySMPTimer: pid %d SMPFn 0x%x\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|functionCode
operator|)
argument_list|)
expr_stmt|;
comment|/* start the SMP timer which works as SMP application timer */
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|DiscoverySMPTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|dmSetTimerRequest
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|DiscoverySMPTimer
argument_list|,
name|SMP_TIMER_VALUE
operator|/
name|dmAllShared
operator|->
name|usecsPerTick
argument_list|,
name|dmDiscoverySMPTimerCB
argument_list|,
name|onePortContext
argument_list|,
name|dmSMPRequestBody
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|dmAddTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|dmAllShared
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|DiscoverySMPTimer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoverySMPTimerCB
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|bit8
name|SMPFunction
decl_stmt|;
ifndef|#
directive|ifndef
name|DIRECT_SMP
name|dmSMPFrameHeader_t
modifier|*
name|dmSMPFrameHeader
decl_stmt|;
name|bit8
name|smpHeader
index|[
literal|4
index|]
decl_stmt|;
endif|#
directive|endif
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agToBeAbortIORequest
init|=
name|agNULL
decl_stmt|;
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|dmSMPRequestBody_t
modifier|*
name|dmAbortSMPRequestBody
init|=
name|agNULL
decl_stmt|;
name|dmList_t
modifier|*
name|SMPList
decl_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverySMPTimerCB: start!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|dmSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|timerData2
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|oneDeviceData
operator|=
name|dmSMPRequestBody
operator|->
name|dmDevice
expr_stmt|;
name|agToBeAbortIORequest
operator|=
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agRoot
operator|=
name|dmAllShared
operator|->
name|agRoot
expr_stmt|;
ifdef|#
directive|ifdef
name|DIRECT_SMP
name|SMPFunction
operator|=
name|dmSMPRequestBody
operator|->
name|smpPayload
index|[
literal|1
index|]
expr_stmt|;
else|#
directive|else
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|dmSMPRequestBody
operator|->
name|IndirectSMP
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dmSMPFrameHeader
operator|=
operator|(
name|dmSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
name|SMPFunction
operator|=
name|dmSMPFrameHeader
operator|->
name|smpFunction
expr_stmt|;
endif|#
directive|endif
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoverySMPTimerCB: SMP function 0x%x\n"
operator|,
name|SMPFunction
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|DiscoverySMPTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|DiscoverySMPTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
comment|//for debugging
comment|//  saGetPendingPICI(agRoot);
switch|switch
condition|(
name|SMPFunction
condition|)
block|{
case|case
name|SMP_REPORT_GENERAL
case|:
comment|/* fall through */
case|case
name|SMP_DISCOVER
case|:
comment|/* fall through */
case|case
name|SMP_CONFIGURE_ROUTING_INFORMATION
case|:
comment|/* fall through */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverySMPTimerCB: failing discovery, SMP function 0x%x !!!\n"
operator|,
name|SMPFunction
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
return|return;
comment|/* no more things to do */
case|case
name|SMP_REPORT_PHY_SATA
case|:
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverySMPTimerCB: failing discovery, SMP function SMP_REPORT_PHY_SATA !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* do nothing */
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverySMPTimerCB: Error, not allowed case!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|registered
operator|==
name|agTRUE
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
operator|)
condition|)
block|{
comment|/* call to saSMPAbort(one) */
comment|/* get an smp REQUEST from the free list */
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|DMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverySMPTimerCB: no free SMP, can't abort SMP!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|DMLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|SMPList
argument_list|,
operator|&
operator|(
name|dmAllShared
operator|->
name|freeSMPList
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_SMP_LOCK
argument_list|)
expr_stmt|;
name|dmAbortSMPRequestBody
operator|=
name|DMLIST_OBJECT_BASE
argument_list|(
name|dmSMPRequestBody_t
argument_list|,
name|Link
argument_list|,
name|SMPList
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmAbortSMPRequestBody
operator|==
name|agNULL
condition|)
block|{
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverySMPTimerCB: dmAbortSMPRequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|DM_DBG5
argument_list|(
operator|(
literal|"dmDiscoverySMPTimerCB: SMP id %d\n"
operator|,
name|dmAbortSMPRequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|dmAbortSMPRequestBody
operator|->
name|dmRoot
operator|=
name|dmRoot
expr_stmt|;
name|agAbortIORequest
operator|=
operator|&
operator|(
name|dmAbortSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|dmAbortSMPRequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SALL takes care of this */
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
name|DM_DBG1
argument_list|(
operator|(
literal|"dmDiscoverySMPTimerCB: calling saSMPAbort!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|saSMPAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|oneExpander
operator|->
name|agDevHandle
argument_list|,
literal|0
argument_list|,
comment|/* abort one */
name|agToBeAbortIORequest
argument_list|,
name|dmSMPAbortCB
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmSMPBusyTimer
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPBusyTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPBusyTimer: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|SMPBusyTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|dmSetTimerRequest
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|,
name|SMP_BUSY_TIMER_VALUE
operator|/
name|dmAllShared
operator|->
name|usecsPerTick
argument_list|,
name|dmSMPBusyTimerCB
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
name|dmAddTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|dmAllShared
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmSMPBusyTimerCB
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|dmSMPRequestBody_t
modifier|*
name|dmSMPRequestBody
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|bit32
name|status
init|=
name|AGSA_RC_FAILURE
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
init|=
name|agNULL
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPBusyTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|dmDeviceData_t
operator|*
operator|)
name|timerData2
expr_stmt|;
name|dmSMPRequestBody
operator|=
operator|(
name|dmSMPRequestBody_t
operator|*
operator|)
name|timerData3
expr_stmt|;
name|agRoot
operator|=
name|dmAllShared
operator|->
name|agRoot
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|oneExpander
operator|=
name|oneDeviceData
operator|->
name|dmExpander
expr_stmt|;
name|agDevHandle
operator|=
name|oneExpander
operator|->
name|agDevHandle
expr_stmt|;
name|agSASRequestBody
operator|=
operator|&
operator|(
name|dmSMPRequestBody
operator|->
name|agSASRequestBody
operator|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|discovery
operator|->
name|SMPRetries
operator|++
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|SMPRetries
operator|<
name|SMP_BUSY_RETRIES
condition|)
block|{
name|status
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
literal|0
argument_list|,
name|agDevHandle
argument_list|,
name|AGSA_SMP_INIT_REQ
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|dmsaSMPCompleted
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
name|discovery
operator|->
name|SMPRetries
operator|=
literal|0
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|SMPBusyTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|SMPBusyTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|discovery
operator|->
name|SMPRetries
operator|=
literal|0
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* AGSA_RC_BUSY */
block|{
if|if
condition|(
name|discovery
operator|->
name|SMPRetries
operator|>=
name|SMP_BUSY_RETRIES
condition|)
block|{
comment|/* done with retris; give up */
name|DM_DBG3
argument_list|(
operator|(
literal|"dmSMPBusyTimerCB: retries are over\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|SMPBusyTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|SMPBusyTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|discovery
operator|->
name|SMPRetries
operator|=
literal|0
expr_stmt|;
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* keep retrying */
name|dmSMPBusyTimer
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|dmSMPRequestBody
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/* expander configuring timer */
end_comment

begin_function
name|osGLOBAL
name|void
name|dmDiscoveryConfiguringTimer
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryConfiguringTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryConfiguringTimer: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|discoveryTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|discoveryTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryConfiguringTimer: UsecsPerTick %d\n"
operator|,
name|dmAllShared
operator|->
name|usecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryConfiguringTimer: Timervalue %d\n"
operator|,
name|DISCOVERY_CONFIGURING_TIMER_VALUE
operator|/
name|dmAllShared
operator|->
name|usecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|dmSetTimerRequest
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|discoveryTimer
argument_list|,
name|DISCOVERY_CONFIGURING_TIMER_VALUE
operator|/
name|dmAllShared
operator|->
name|usecsPerTick
argument_list|,
name|dmDiscoveryConfiguringTimerCB
argument_list|,
name|onePortContext
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
name|dmAddTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|dmAllShared
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|discoveryTimer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmDiscoveryConfiguringTimerCB
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|dmIntPortContext_t
modifier|*
name|onePortContext
init|=
name|agNULL
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
init|=
name|agNULL
decl_stmt|;
name|dmDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|dmDeviceData_t
operator|*
operator|)
name|timerData2
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmDiscoveryConfiguringTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|discoveryTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|discoveryTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|||
name|oneDeviceData
operator|->
name|valid2
operator|==
name|agTRUE
condition|)
block|{
name|dmReportGeneralSend
argument_list|(
name|dmRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmConfigureRouteTimer
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|dmIntPortContext_t
modifier|*
name|onePortContext
parameter_list|,
name|dmExpander_t
modifier|*
name|oneExpander
parameter_list|,
name|smpRespDiscover_t
modifier|*
name|pdmSMPDiscoverResp
parameter_list|,
name|smpRespDiscover2_t
modifier|*
name|pdmSMPDiscover2Resp
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimer: start\n"
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimer: pid %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimer: onePortContext %p oneExpander %p pdmSMPDiscoverResp %p\n"
operator|,
name|onePortContext
operator|,
name|oneExpander
operator|,
name|pdmSMPDiscoverResp
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimer: discovery %p \n"
operator|,
name|discovery
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimer:  pid %d configureRouteRetries %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|discovery
operator|->
name|configureRouteRetries
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimer: discovery->status %d\n"
operator|,
name|discovery
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|configureRouteTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimer: UsecsPerTick %d\n"
operator|,
name|dmAllShared
operator|->
name|usecsPerTick
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimer: Timervalue %d\n"
operator|,
name|CONFIGURE_ROUTE_TIMER_VALUE
operator|/
name|dmAllShared
operator|->
name|usecsPerTick
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|->
name|SAS2
operator|==
literal|0
condition|)
block|{
comment|/* SAS 1.1 */
name|dmSetTimerRequest
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|,
name|CONFIGURE_ROUTE_TIMER_VALUE
operator|/
name|dmAllShared
operator|->
name|usecsPerTick
argument_list|,
name|dmConfigureRouteTimerCB
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
argument_list|,
operator|(
name|void
operator|*
operator|)
name|oneExpander
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pdmSMPDiscoverResp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAS 2 */
name|dmSetTimerRequest
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|,
name|CONFIGURE_ROUTE_TIMER_VALUE
operator|/
name|dmAllShared
operator|->
name|usecsPerTick
argument_list|,
name|dmConfigureRouteTimerCB
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
argument_list|,
operator|(
name|void
operator|*
operator|)
name|oneExpander
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pdmSMPDiscover2Resp
argument_list|)
expr_stmt|;
block|}
name|dmAddTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|dmAllShared
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|dmConfigureRouteTimerCB
parameter_list|(
name|dmRoot_t
modifier|*
name|dmRoot
parameter_list|,
name|void
modifier|*
name|timerData1
parameter_list|,
name|void
modifier|*
name|timerData2
parameter_list|,
name|void
modifier|*
name|timerData3
parameter_list|)
block|{
name|dmIntRoot_t
modifier|*
name|dmIntRoot
init|=
operator|(
name|dmIntRoot_t
operator|*
operator|)
name|dmRoot
operator|->
name|dmData
decl_stmt|;
name|dmIntContext_t
modifier|*
name|dmAllShared
init|=
operator|(
name|dmIntContext_t
operator|*
operator|)
operator|&
name|dmIntRoot
operator|->
name|dmAllShared
decl_stmt|;
name|dmIntPortContext_t
modifier|*
name|onePortContext
decl_stmt|;
name|dmExpander_t
modifier|*
name|oneExpander
decl_stmt|;
name|smpRespDiscover_t
modifier|*
name|pdmSMPDiscoverResp
init|=
name|agNULL
decl_stmt|;
name|smpRespDiscover2_t
modifier|*
name|pdmSMPDiscover2Resp
init|=
name|agNULL
decl_stmt|;
name|dmDiscovery_t
modifier|*
name|discovery
decl_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimerCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|onePortContext
operator|=
operator|(
name|dmIntPortContext_t
operator|*
operator|)
name|timerData1
expr_stmt|;
name|oneExpander
operator|=
operator|(
name|dmExpander_t
operator|*
operator|)
name|timerData2
expr_stmt|;
if|if
condition|(
name|oneExpander
operator|->
name|SAS2
operator|==
literal|0
condition|)
block|{
name|pdmSMPDiscoverResp
operator|=
operator|(
name|smpRespDiscover_t
operator|*
operator|)
name|timerData3
expr_stmt|;
block|}
else|else
block|{
name|pdmSMPDiscover2Resp
operator|=
operator|(
name|smpRespDiscover2_t
operator|*
operator|)
name|timerData3
expr_stmt|;
block|}
name|discovery
operator|=
operator|&
operator|(
name|onePortContext
operator|->
name|discovery
operator|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimerCB: onePortContext %p oneExpander %p pdmSMPDiscoverResp %p\n"
operator|,
name|onePortContext
operator|,
name|oneExpander
operator|,
name|pdmSMPDiscoverResp
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimerCB: discovery %p\n"
operator|,
name|discovery
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimerCB: pid %d configureRouteRetries %d\n"
operator|,
name|onePortContext
operator|->
name|id
operator|,
name|discovery
operator|->
name|configureRouteRetries
operator|)
argument_list|)
expr_stmt|;
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimerCB: discovery.status %d\n"
operator|,
name|discovery
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|configureRouteRetries
operator|++
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|configureRouteRetries
operator|>=
name|dmAllShared
operator|->
name|MaxRetryDiscovery
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimerCB: retries are over\n"
operator|)
argument_list|)
expr_stmt|;
name|tddmSingleThreadedEnter
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|discovery
operator|->
name|configureRouteTimer
operator|.
name|timerRunning
operator|==
name|agTRUE
condition|)
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
name|dmKillTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tddmSingleThreadedLeave
argument_list|(
name|dmRoot
argument_list|,
name|DM_TIMER_LOCK
argument_list|)
expr_stmt|;
block|}
name|discovery
operator|->
name|configureRouteRetries
operator|=
literal|0
expr_stmt|;
comment|/* failed the discovery */
name|dmDiscoverDone
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|DM_RC_FAILURE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneExpander
operator|->
name|SAS2
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimerCB: proceed by calling dmDownStreamDiscoverExpanderPhy\n"
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"dmConfigureRouteTimerCB"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pdmSMPDiscoverResp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover_t
argument_list|)
argument_list|)
expr_stmt|;
name|discovery
operator|->
name|configureRouteRetries
operator|=
literal|0
expr_stmt|;
name|dmDownStreamDiscoverExpanderPhy
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|pdmSMPDiscoverResp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG3
argument_list|(
operator|(
literal|"dmConfigureRouteTimerCB: setting timer again\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* set the timer again */
name|dmSetTimerRequest
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|,
name|CONFIGURE_ROUTE_TIMER_VALUE
operator|/
name|dmAllShared
operator|->
name|usecsPerTick
argument_list|,
name|dmConfigureRouteTimerCB
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
argument_list|,
operator|(
name|void
operator|*
operator|)
name|oneExpander
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pdmSMPDiscoverResp
argument_list|)
expr_stmt|;
name|dmAddTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|dmAllShared
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* SAS 1.1 */
else|else
block|{
comment|/* SAS 2 */
if|if
condition|(
name|onePortContext
operator|->
name|discovery
operator|.
name|status
operator|==
name|DISCOVERY_DOWN_STREAM
condition|)
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigureRouteTimerCB: proceed by calling dmDownStreamDiscover2ExpanderPhy\n"
operator|)
argument_list|)
expr_stmt|;
name|dmhexdump
argument_list|(
literal|"dmConfigureRouteTimerCB"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pdmSMPDiscover2Resp
argument_list|,
sizeof|sizeof
argument_list|(
name|smpRespDiscover2_t
argument_list|)
argument_list|)
expr_stmt|;
name|dmDownStreamDiscover2ExpanderPhy
argument_list|(
name|dmRoot
argument_list|,
name|onePortContext
argument_list|,
name|oneExpander
argument_list|,
name|pdmSMPDiscover2Resp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DM_DBG2
argument_list|(
operator|(
literal|"dmConfigureRouteTimerCB: setting timer again\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* set the timer again */
name|dmSetTimerRequest
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|,
name|CONFIGURE_ROUTE_TIMER_VALUE
operator|/
name|dmAllShared
operator|->
name|usecsPerTick
argument_list|,
name|dmConfigureRouteTimerCB
argument_list|,
operator|(
name|void
operator|*
operator|)
name|onePortContext
argument_list|,
operator|(
name|void
operator|*
operator|)
name|oneExpander
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pdmSMPDiscover2Resp
argument_list|)
expr_stmt|;
name|dmAddTimer
argument_list|(
name|dmRoot
argument_list|,
operator|&
name|dmAllShared
operator|->
name|timerlist
argument_list|,
operator|&
name|discovery
operator|->
name|configureRouteTimer
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FDS_ DM */
end_comment

end_unit


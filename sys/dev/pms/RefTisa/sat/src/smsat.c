begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/src/smdefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/src/smproto.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/src/smtypes.h>
end_include

begin_comment
comment|/* start smapi defined APIs */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smRegisterDevice
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agExpDevHandle
parameter_list|,
name|bit32
name|phyID
parameter_list|,
name|bit32
name|DeviceType
parameter_list|)
block|{
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smRegisterDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smRegisterDevice: smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smRegisterDevice: agDevHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|oneDeviceData
operator|=
name|smAddToSharedcontext
argument_list|(
name|smRoot
argument_list|,
name|agDevHandle
argument_list|,
name|smDeviceHandle
argument_list|,
name|agExpDevHandle
argument_list|,
name|phyID
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|oneDeviceData
operator|->
name|satDeviceType
operator|=
name|DeviceType
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
return|return
name|SM_RC_FAILURE
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smDeregisterDevice
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|)
block|{
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smDeregisterDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smDeregisterDevice: smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smDeregisterDevice: agDevHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|status
operator|=
name|smRemoveFromSharedcontext
argument_list|(
name|smRoot
argument_list|,
name|agDevHandle
argument_list|,
name|smDeviceHandle
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smIOAbort
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|tasktag
parameter_list|)
block|{
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIONewRequestBody
init|=
name|agNULL
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
init|=
name|agNULL
decl_stmt|;
comment|/* IO to be aborted */
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
decl_stmt|;
comment|/* abort IO itself */
name|smIORequestBody_t
modifier|*
name|smAbortIORequestBody
decl_stmt|;
if|#
directive|if
literal|1
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
endif|#
directive|endif
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satAbortIOContext
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smIOAbort: tasktag %p\n"
operator|,
name|tasktag
operator|)
argument_list|)
expr_stmt|;
comment|/*     alloc smIORequestBody for abort itself     call saSATAAbort()   */
name|agRoot
operator|=
name|smAllShared
operator|->
name|agRoot
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|tasktag
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbort: smIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
comment|/* needs to distinguish internally generated or externally generated */
name|satIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smIOAbort: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smIOAbort: Internal, SM generated\n"
operator|)
argument_list|)
expr_stmt|;
name|smIONewRequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|agIORequest
operator|=
operator|&
operator|(
name|smIONewRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
block|}
comment|/*     allocate smAbortIORequestBody for abort request itself   */
if|#
directive|if
literal|1
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|tdsmAllocMemory
argument_list|(
name|smRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|smAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* let os process IO */
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbort: tdsmAllocMemory failed...!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|smAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbort: tdsmAllocMemory returned NULL smAbortIORequestBody!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|smIOReInit
argument_list|(
name|smRoot
argument_list|,
name|smAbortIORequestBody
argument_list|)
expr_stmt|;
comment|/* setup task management structure */
name|smAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|satAbortIOContext
operator|=
operator|&
operator|(
name|smAbortIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satAbortIOContext
operator|->
name|smRequestBody
operator|=
name|smAbortIORequestBody
expr_stmt|;
name|smAbortIORequestBody
operator|->
name|smDevHandle
operator|=
name|smIORequestBody
operator|->
name|smDevHandle
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|smAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|smAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/* remember IO to be aborted */
name|smAbortIORequestBody
operator|->
name|smIOToBeAbortedRequest
operator|=
name|tasktag
expr_stmt|;
name|status
operator|=
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agIORequest
argument_list|,
name|smaSATAAbortCB
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smIOAbort: return status=0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 1 */
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbort: failed to call saSATAAbort, status=%d!!!\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smIOAbortAll
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|)
block|{
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smAbortIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satAbortIOContext
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smIOAbortAll: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agRoot
operator|=
name|smAllShared
operator|->
name|agRoot
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbortAll: smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbortAll: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbortAll: oneDeviceData is not valid, did %d !!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbortAll: agDevHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
comment|/*   smAbortIORequestBody = smDequeueIO(smRoot);   if (smAbortIORequestBody == agNULL)   {     SM_DBG1(("smIOAbortAll: empty freeIOList!!!\n"));     return SM_RC_FAILURE;   } */
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|tdsmAllocMemory
argument_list|(
name|smRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|smAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* let os process IO */
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbortAll: tdsmAllocMemory failed...!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|smAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbortAll: tdsmAllocMemory returned NULL smAbortIORequestBody!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|smIOReInit
argument_list|(
name|smRoot
argument_list|,
name|smAbortIORequestBody
argument_list|)
expr_stmt|;
comment|/* setup task management structure */
name|smAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|satAbortIOContext
operator|=
operator|&
operator|(
name|smAbortIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satAbortIOContext
operator|->
name|smRequestBody
operator|=
name|smAbortIORequestBody
expr_stmt|;
name|smAbortIORequestBody
operator|->
name|smDevHandle
operator|=
name|smDeviceHandle
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|smAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|smAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agTRUE
expr_stmt|;
comment|/* abort all */
name|status
operator|=
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
literal|1
argument_list|,
name|agNULL
argument_list|,
name|smaSATAAbortCB
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|AGSA_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOAbortAll: failed to call saSATAAbort, status=%d!!!\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smSuperIOStart
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smSuperScsiInitiatorRequest_t
modifier|*
name|smSCSIRequest
parameter_list|,
name|bit32
name|AddrHi
parameter_list|,
name|bit32
name|AddrLo
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smSuperIOStart: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smSuperIOStart: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smSuperIOStart: oneDeviceData is not valid, did %d !!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|smIORequest
operator|->
name|smData
expr_stmt|;
comment|//smDequeueIO(smRoot);
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smSuperIOStart: smIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|smIOReInit
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smSuperIOStart: io ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|sasAddressHi
operator|=
name|AddrHi
expr_stmt|;
name|oneDeviceData
operator|->
name|sasAddressLo
operator|=
name|AddrLo
expr_stmt|;
name|smIORequestBody
operator|->
name|smIORequest
operator|=
name|smIORequest
expr_stmt|;
name|smIORequestBody
operator|->
name|smDevHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
comment|/*    * Need to initialize all the fields within satIOContext except    * reqType and satCompleteCB which will be set later in SM.    */
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|.
name|senseData
operator|=
name|agNULL
expr_stmt|;
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|.
name|senseLen
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|=
name|oneDeviceData
expr_stmt|;
name|satIOContext
operator|->
name|pFis
operator|=
operator|&
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
expr_stmt|;
name|satIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
name|smSCSIRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|satIOContext
operator|->
name|pSense
operator|=
operator|&
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
expr_stmt|;
name|satIOContext
operator|->
name|pSmSenseData
operator|=
operator|&
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
expr_stmt|;
name|satIOContext
operator|->
name|pSmSenseData
operator|->
name|senseData
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
comment|/*    satIOContext->pSense = (scsiRspSense_t *)satIOContext->pSmSenseData->senseData; */
name|satIOContext
operator|->
name|smRequestBody
operator|=
name|smIORequestBody
expr_stmt|;
name|satIOContext
operator|->
name|interruptContext
operator|=
name|interruptContext
expr_stmt|;
name|satIOContext
operator|->
name|psmDeviceHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext
operator|->
name|smScsiXchg
operator|=
name|smSCSIRequest
expr_stmt|;
name|satIOContext
operator|->
name|superIOFlag
operator|=
name|agTRUE
expr_stmt|;
comment|//  satIOContext->superIOFlag = agFALSE;
name|satIOContext
operator|->
name|satIntIoContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
comment|/*    satIOContext->tiIORequest      = tiIORequest; */
comment|/* save context if we need to abort later */
comment|/*smIORequest->smData = smIORequestBody;*/
comment|/* followings are used only for internal IO */
name|satIOContext
operator|->
name|currentLBA
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|smsatIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* osGLOBAL bit32 tiINIIOStart(              tiRoot_t                  *tiRoot,              tiIORequest_t             *tiIORequest,              tiDeviceHandle_t          *tiDeviceHandle,              tiScsiInitiatorRequest_t  *tiScsiRequest,              void                      *tiRequestBody,              bit32                     interruptContext              )  GLOBAL bit32  satIOStart(                    tiRoot_t                  *tiRoot,                    tiIORequest_t             *tiIORequest,                    tiDeviceHandle_t          *tiDeviceHandle,                    tiScsiInitiatorRequest_t  *tiScsiRequest,                    smSatIOContext_t            *satIOContext                   ) smIOStart(           smRoot_t      *smRoot,           smIORequest_t     *smIORequest,           smDeviceHandle_t    *smDeviceHandle,           smScsiInitiatorRequest_t  *smSCSIRequest,           smIORequestBody_t             *smRequestBody,           bit32       interruptContext          )   */
end_comment

begin_function
name|FORCEINLINE
name|bit32
name|smIOStart
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smSCSIRequest
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smIOStart: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOStart: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOStart: oneDeviceData is not valid, did %d !!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|smIORequest
operator|->
name|smData
expr_stmt|;
comment|//smDequeueIO(smRoot);
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIOStart: smIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|smIOReInit
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smIOStart: io ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|smIORequest
operator|=
name|smIORequest
expr_stmt|;
name|smIORequestBody
operator|->
name|smDevHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
comment|/*    * Need to initialize all the fields within satIOContext except    * reqType and satCompleteCB which will be set later in SM.    */
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|.
name|senseData
operator|=
name|agNULL
expr_stmt|;
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|.
name|senseLen
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|=
name|oneDeviceData
expr_stmt|;
name|satIOContext
operator|->
name|pFis
operator|=
operator|&
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
expr_stmt|;
name|satIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
name|smSCSIRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|satIOContext
operator|->
name|pSense
operator|=
operator|&
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
expr_stmt|;
name|satIOContext
operator|->
name|pSmSenseData
operator|=
operator|&
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
expr_stmt|;
name|satIOContext
operator|->
name|pSmSenseData
operator|->
name|senseData
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
comment|/*    satIOContext->pSense = (scsiRspSense_t *)satIOContext->pSmSenseData->senseData; */
name|satIOContext
operator|->
name|smRequestBody
operator|=
name|smIORequestBody
expr_stmt|;
name|satIOContext
operator|->
name|interruptContext
operator|=
name|interruptContext
expr_stmt|;
name|satIOContext
operator|->
name|psmDeviceHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext
operator|->
name|smScsiXchg
operator|=
name|smSCSIRequest
expr_stmt|;
name|satIOContext
operator|->
name|superIOFlag
operator|=
name|agFALSE
expr_stmt|;
name|satIOContext
operator|->
name|satIntIoContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|currentLBA
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|smsatIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smTaskManagement
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|bit32
name|task
parameter_list|,
name|smLUN_t
modifier|*
name|lun
parameter_list|,
name|smIORequest_t
modifier|*
name|taskTag
parameter_list|,
comment|/* io to be aborted */
name|smIORequest_t
modifier|*
name|currentTaskTag
comment|/* task management */
parameter_list|)
block|{
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|smAllShared
operator|->
name|agRoot
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaContext_t
modifier|*
name|agContext
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smTaskManagement: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|task
operator|==
name|SM_LOGICAL_UNIT_RESET
operator|||
name|task
operator|==
name|SM_TARGET_WARM_RESET
operator|||
name|task
operator|==
name|SM_ABORT_TASK
condition|)
block|{
if|if
condition|(
name|task
operator|==
name|AG_LOGICAL_UNIT_RESET
condition|)
block|{
if|if
condition|(
operator|(
name|lun
operator|->
name|lun
index|[
literal|0
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|1
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|2
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|3
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|4
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|5
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|6
index|]
operator||
name|lun
operator|->
name|lun
index|[
literal|7
index|]
operator|)
operator|!=
literal|0
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smTaskManagement: *** REJECT *** LUN not zero, did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
block|}
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
name|oneDeviceData
operator|->
name|satAbortAfterReset
operator|=
name|agFALSE
expr_stmt|;
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
name|SA_DS_IN_RECOVERY
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|directlyAttached
operator|==
name|agFALSE
condition|)
block|{
comment|/* expander attached */
name|SM_DBG1
argument_list|(
operator|(
literal|"smTaskManagement: LUN reset or device reset expander attached!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smPhyControlSend
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|currentTaskTag
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smTaskManagement: LUN reset or device reset directly attached\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|currentTaskTag
operator|->
name|smData
expr_stmt|;
comment|//smDequeueIO(smRoot);
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smTaskManagement: smIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|smIOReInit
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
argument_list|)
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|smRequestBody
operator|=
name|smIORequestBody
expr_stmt|;
name|smIORequestBody
operator|->
name|smDevHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|agContext
operator|=
operator|&
operator|(
name|oneDeviceData
operator|->
name|agDeviceResetContext
operator|)
expr_stmt|;
name|agContext
operator|->
name|osData
operator|=
name|currentTaskTag
expr_stmt|;
name|status
operator|=
name|saLocalPhyControl
argument_list|(
name|agRoot
argument_list|,
name|agContext
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
operator|&
literal|0xFFFF
argument_list|,
name|oneDeviceData
operator|->
name|phyID
argument_list|,
name|AGSA_PHY_HARD_RESET
argument_list|,
name|smLocalPhyControlCB
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
return|return
name|SM_RC_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
return|return
name|SM_RC_BUSY
return|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_FAILURE
condition|)
block|{
return|return
name|SM_RC_FAILURE
return|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smTaskManagement: unknown status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
block|}
block|}
else|else
block|{
comment|/* smsatsmTaskManagement() which is satTM() */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|currentTaskTag
operator|->
name|smData
expr_stmt|;
comment|//smDequeueIO(smRoot);
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smTaskManagement: smIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|smIOReInit
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
argument_list|)
expr_stmt|;
comment|/*currentTaskTag->smData = smIORequestBody;*/
name|status
operator|=
name|smsatTaskManagement
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|task
argument_list|,
name|lun
argument_list|,
name|taskTag
argument_list|,
name|currentTaskTag
argument_list|,
name|smIORequestBody
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/********************************************************* end smapi defined APIS */
end_comment

begin_comment
comment|/* counterpart is    smEnqueueIO(smRoot_t       *smRoot,                smSatIOContext_t       *satIOContext) */
end_comment

begin_function
name|osGLOBAL
name|smIORequestBody_t
modifier|*
name|smDequeueIO
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|)
block|{
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smList_t
modifier|*
name|IOListList
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smDequeueIO: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|SMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|smAllShared
operator|->
name|freeIOList
operator|)
argument_list|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smDequeueIO: empty freeIOList!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|SMLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|IOListList
argument_list|,
operator|&
operator|(
name|smAllShared
operator|->
name|freeIOList
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
name|SMLIST_OBJECT_BASE
argument_list|(
name|smIORequestBody_t
argument_list|,
name|satIoBodyLink
argument_list|,
name|IOListList
argument_list|)
expr_stmt|;
name|SMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|smIORequestBody
operator|->
name|satIoBodyLink
operator|)
argument_list|)
expr_stmt|;
name|SMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|smIORequestBody
operator|->
name|satIoBodyLink
operator|)
argument_list|,
operator|&
operator|(
name|smAllShared
operator|->
name|mainIOList
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIORequestBody
operator|->
name|InUse
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smDequeueIO: wrong. already in USE ID %d!!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|smIOReInit
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smDequeueIO: io ID %d!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* debugging */
if|if
condition|(
name|smIORequestBody
operator|->
name|satIoBodyLink
operator|.
name|flink
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smDequeueIO: io ID %d, flink is NULL!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIORequestBody
operator|->
name|satIoBodyLink
operator|.
name|blink
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smDequeueIO: io ID %d, blink is NULL!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|smIORequestBody
return|;
block|}
end_function

begin_comment
comment|//start here
end_comment

begin_comment
comment|//compare with ossaSATAAbortCB()
end_comment

begin_comment
comment|//qqq1
end_comment

begin_function
name|osGLOBAL
name|void
name|smsatAbort
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
comment|/* abort itself */
name|smIORequestBody_t
modifier|*
name|smToBeAbortedIORequestBody
decl_stmt|;
comment|/* io to be aborted */
name|agsaIORequest_t
modifier|*
name|agToBeAbortedIORequest
decl_stmt|;
comment|/* io to be aborted */
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
decl_stmt|;
comment|/* abort io itself */
name|smSatIOContext_t
modifier|*
name|satAbortIOContext
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatAbort: satIOContext is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smToBeAbortedIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|agToBeAbortedIORequest
operator|=
operator|(
name|agsaIORequest_t
operator|*
operator|)
operator|&
operator|(
name|smToBeAbortedIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
comment|/*   smIORequestBody = smDequeueIO(smRoot);    if (smIORequestBody == agNULL)   {     SM_DBG1(("smsatAbort: empty freeIOList!!!\n"));     return;   }    */
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|tdsmAllocMemory
argument_list|(
name|smRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|smIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatAbort: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatAbort: ostiAllocMemory returned NULL smIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smIOReInit
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|smIORequestBody
operator|->
name|smDevHandle
operator|=
name|smToBeAbortedIORequestBody
operator|->
name|smDevHandle
expr_stmt|;
comment|/* initialize agIORequest */
name|satAbortIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satAbortIOContext
operator|->
name|smRequestBody
operator|=
name|smIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|smIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/*    * Issue abort    */
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
literal|0
argument_list|,
name|agNULL
argument_list|,
literal|0
argument_list|,
name|agToBeAbortedIORequest
argument_list|,
name|smaSATAAbortCB
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"satAbort: end!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatStartCheckPowerMode
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|currentTaskTag
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smSatInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: before alloc\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate any fis for seting SRT bit in device control */
name|satIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|currentTaskTag
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: before after\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: can't alloacate!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
return|return
name|SM_RC_FAILURE
return|;
block|}
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satIntIo
argument_list|,
name|currentTaskTag
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: TD satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: SM satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: TD smScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: SM smScsiXchg %p \n"
operator|,
name|satNewIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatCheckPowerMode
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntSmIORequest
argument_list|,
comment|/* New smIORequest */
name|smDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|smScsiXchg
argument_list|,
comment|/* New tiScsiInitiatorRequest_t *smScsiRequest, */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: failed in sending!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
return|return
name|SM_RC_FAILURE
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartCheckPowerMode: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatStartResetDevice
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|currentTaskTag
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smSatInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartResetDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartResetDevice: before alloc\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate any fis for seting SRT bit in device control */
name|satIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|currentTaskTag
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartResetDevice: before after\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartResetDevice: can't alloacate!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
return|return
name|SM_RC_FAILURE
return|;
block|}
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satIntIo
argument_list|,
name|currentTaskTag
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartResetDevice: TD satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartResetDevice: SM satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartResetDevice: TD smScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartResetDevice: SM smScsiXchg %p \n"
operator|,
name|satNewIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartResetDevice: satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
comment|/*if ATAPI device, send DEVICE RESET command to ATAPI device*/
name|status
operator|=
name|smsatDeviceReset
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntSmIORequest
argument_list|,
comment|/* New smIORequest */
name|smDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|smScsiXchg
argument_list|,
comment|/* New smScsiInitiatorRequest_t *smScsiRequest, NULL */
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|smsatResetDevice
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntSmIORequest
argument_list|,
comment|/* New smIORequest */
name|smDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|smScsiXchg
argument_list|,
comment|/* New smScsiInitiatorRequest_t *smScsiRequest, NULL */
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartResetDevice: failed in sending!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
return|return
name|SM_RC_FAILURE
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartResetDevice: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatTmAbortTask
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|currentTaskTag
parameter_list|,
comment|/* task management */
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
comment|/* NULL */
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|,
comment|/* task management */
name|smIORequest_t
modifier|*
name|taskTag
parameter_list|)
comment|/* io to be aborted */
block|{
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satTempIOContext
init|=
name|agNULL
decl_stmt|;
name|smList_t
modifier|*
name|elementHdr
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smIORequest_t
modifier|*
name|smIOReq
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTmAbortTask: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
comment|/*    * Check that the only pending I/O matches taskTag. If not return tiError.    */
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|elementHdr
operator|=
name|oneDeviceData
operator|->
name|satIoLinkList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|elementHdr
operator|!=
operator|&
name|oneDeviceData
operator|->
name|satIoLinkList
condition|)
block|{
name|satTempIOContext
operator|=
name|SMLIST_OBJECT_BASE
argument_list|(
name|smSatIOContext_t
argument_list|,
name|satIoContextLink
argument_list|,
name|elementHdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|satTempIOContext
operator|!=
name|agNULL
condition|)
block|{
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satTempIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smIOReq
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
block|}
name|elementHdr
operator|=
name|elementHdr
operator|->
name|flink
expr_stmt|;
comment|/* for the next while loop  */
comment|/*      * Check if the tag matches      */
if|if
condition|(
name|smIOReq
operator|==
name|taskTag
condition|)
block|{
name|found
operator|=
name|agTRUE
expr_stmt|;
name|satIOContext
operator|->
name|satToBeAbortedIOContext
operator|=
name|satTempIOContext
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTmAbortTask: found matching tag.\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* if matching tag */
block|}
comment|/* while loop */
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTmAbortTask: *** REJECT *** no match!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
comment|/* clean up TD layer's smIORequestBody */
if|if
condition|(
name|smIORequestBody
condition|)
block|{
if|if
condition|(
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|!=
name|agNULL
condition|)
block|{
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTmAbortTask: smIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|satTempIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTmAbortTask: satTempIOContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
comment|/*    * Save smIORequest, will be returned at device reset completion to return    * the TM completion.    */
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|currentTaskTag
expr_stmt|;
comment|/*    * Set flag to indicate device in recovery mode.    */
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
comment|/*    * Issue SATA device reset or check power mode.. Set flag to to automatically abort    * at the completion of SATA device reset.    * SAT r09 p25    */
name|oneDeviceData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
operator|(
name|satTempIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satTempIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTmAbortTask: calling satStartCheckPowerMode!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* send check power mode */
name|status
operator|=
name|smsatStartCheckPowerMode
argument_list|(
name|smRoot
argument_list|,
name|currentTaskTag
argument_list|,
comment|/* currentTaskTag */
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
comment|/* NULL */
name|satIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTmAbortTask: calling satStartResetDevice!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* send AGSA_SATA_PROTOCOL_SRST_ASSERT */
name|status
operator|=
name|smsatStartResetDevice
argument_list|(
name|smRoot
argument_list|,
name|currentTaskTag
argument_list|,
comment|/* currentTaskTag */
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
comment|/* NULL */
name|satIOContext
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* satTM() */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatTaskManagement
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|bit32
name|task
parameter_list|,
name|smLUN_t
modifier|*
name|lun
parameter_list|,
name|smIORequest_t
modifier|*
name|taskTag
parameter_list|,
comment|/* io to be aborted */
name|smIORequest_t
modifier|*
name|currentTaskTag
parameter_list|,
comment|/* task management */
name|smIORequestBody_t
modifier|*
name|smIORequestBody
parameter_list|)
block|{
name|smSatIOContext_t
modifier|*
name|satIOContext
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTaskManagement: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|pSatDevData
operator|=
name|oneDeviceData
expr_stmt|;
name|satIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|smRequestBody
operator|=
name|smIORequestBody
expr_stmt|;
name|satIOContext
operator|->
name|psmDeviceHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext
operator|->
name|satIntIoContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
comment|/* followings are used only for internal IO */
name|satIOContext
operator|->
name|currentLBA
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
literal|0
expr_stmt|;
comment|/* saving task in satIOContext */
name|satIOContext
operator|->
name|TMF
operator|=
name|task
expr_stmt|;
name|satIOContext
operator|->
name|satToBeAbortedIOContext
operator|=
name|agNULL
expr_stmt|;
if|if
condition|(
name|task
operator|==
name|AG_ABORT_TASK
condition|)
block|{
name|status
operator|=
name|smsatTmAbortTask
argument_list|(
name|smRoot
argument_list|,
name|currentTaskTag
argument_list|,
name|smDeviceHandle
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|,
name|taskTag
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTaskManagement: UNSUPPORTED TM task=0x%x!!!\n"
operator|,
name|task
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
return|return
name|SM_RC_FAILURE
return|;
block|}
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smPhyControlSend
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
comment|/* sata disk itself */
name|bit8
name|phyOp
parameter_list|,
name|smIORequest_t
modifier|*
name|CurrentTaskTag
parameter_list|,
name|bit32
name|queueNumber
parameter_list|)
block|{
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|smAllShared
operator|->
name|agRoot
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agExpDevHandle
decl_stmt|;
name|smpReqPhyControl_t
name|smpPhyControlReq
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|bit32
name|expectedRspLen
init|=
literal|0
decl_stmt|;
name|smSMPRequestBody_t
modifier|*
name|smSMPRequestBody
decl_stmt|;
name|agsaSASRequestBody_t
modifier|*
name|agSASRequestBody
decl_stmt|;
name|agsaSMPFrame_t
modifier|*
name|agSMPFrame
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agIORequest
decl_stmt|;
comment|//  agsaDevHandle_t           *agDevHandle;
name|smSMPFrameHeader_t
name|smSMPFrameHeader
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit8
modifier|*
name|pSmpBody
decl_stmt|;
comment|/* smp payload itself w/o first 4 bytes(header) */
name|bit32
name|smpBodySize
decl_stmt|;
comment|/* smp payload size w/o first 4 bytes(header) */
name|bit32
name|agRequestType
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smPhyControlSend: start\n"
operator|)
argument_list|)
expr_stmt|;
name|agExpDevHandle
operator|=
name|oneDeviceData
operator|->
name|agExpDevHandle
expr_stmt|;
if|if
condition|(
name|agExpDevHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlSend: agExpDevHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|SM_DBG5
argument_list|(
operator|(
literal|"smPhyControlSend: phyID %d\n"
operator|,
name|oneDeviceData
operator|->
name|phyID
operator|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
operator|&
name|smpPhyControlReq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smpReqPhyControl_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* fill in SMP payload */
name|smpPhyControlReq
operator|.
name|phyIdentifier
operator|=
operator|(
name|bit8
operator|)
name|oneDeviceData
operator|->
name|phyID
expr_stmt|;
name|smpPhyControlReq
operator|.
name|phyOperation
operator|=
name|phyOp
expr_stmt|;
comment|/* allocate smp and send it */
name|memAllocStatus
operator|=
name|tdsmAllocMemory
argument_list|(
name|smRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|smSMPRequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|smSMPRequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlSend: tdsmAllocMemory failed...!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|smSMPRequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlSend: tdsmAllocMemory returned NULL smSMPRequestBody!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
comment|/* saves mem handle for freeing later */
name|smSMPRequestBody
operator|->
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
comment|/* saves oneDeviceData */
name|smSMPRequestBody
operator|->
name|smDeviceData
operator|=
name|oneDeviceData
expr_stmt|;
comment|/* sata disk */
comment|/* saves oneDeviceData */
name|smSMPRequestBody
operator|->
name|smDevHandle
operator|=
name|oneDeviceData
operator|->
name|smDevHandle
expr_stmt|;
comment|//  agDevHandle = oneDeviceData->agDevHandle;
comment|/* save the callback funtion */
name|smSMPRequestBody
operator|->
name|SMPCompletionFunc
operator|=
name|smSMPCompleted
expr_stmt|;
comment|/* in satcb.c */
comment|/* for simulate warm target reset */
name|smSMPRequestBody
operator|->
name|CurrentTaskTag
operator|=
name|CurrentTaskTag
expr_stmt|;
if|if
condition|(
name|CurrentTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|CurrentTaskTag
operator|->
name|smData
operator|=
name|smSMPRequestBody
expr_stmt|;
block|}
comment|/* initializes the number of SMP retries */
name|smSMPRequestBody
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_INTERNAL_DEBUG
comment|/* debugging */
name|SM_DBG4
argument_list|(
operator|(
literal|"smPhyControlSend: SMPRequestbody %p\n"
operator|,
name|smSMPRequestBody
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smPhyControlSend: callback fn %p\n"
operator|,
name|smSMPRequestBody
operator|->
name|SMPCompletionFunc
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|agIORequest
operator|=
operator|&
operator|(
name|smSMPRequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|smSMPRequestBody
expr_stmt|;
name|agIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* SALL takes care of this */
name|agSASRequestBody
operator|=
operator|&
operator|(
name|smSMPRequestBody
operator|->
name|agSASRequestBody
operator|)
expr_stmt|;
name|agSMPFrame
operator|=
operator|&
operator|(
name|agSASRequestBody
operator|->
name|smpFrame
operator|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smPhyControlSend: agIORequest %p\n"
operator|,
name|agIORequest
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smPhyControlSend: SMPRequestbody %p\n"
operator|,
name|smSMPRequestBody
operator|)
argument_list|)
expr_stmt|;
name|expectedRspLen
operator|=
literal|4
expr_stmt|;
name|pSmpBody
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|&
name|smpPhyControlReq
expr_stmt|;
name|smpBodySize
operator|=
sizeof|sizeof
argument_list|(
name|smpReqPhyControl_t
argument_list|)
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SMP_INIT_REQ
expr_stmt|;
if|if
condition|(
name|SMIsSPC
argument_list|(
name|agRoot
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|smpBodySize
operator|+
literal|4
operator|)
operator|<=
name|SMP_DIRECT_PAYLOAD_LIMIT
condition|)
comment|/* 48 */
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smPhyControlSend: DIRECT smp payload\n"
operator|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
operator|&
name|smSMPFrameHeader
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|smSMPRequestBody
operator|->
name|smpPayload
argument_list|,
literal|0
argument_list|,
name|SMP_DIRECT_PAYLOAD_LIMIT
argument_list|)
expr_stmt|;
comment|/* SMP header */
name|smSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|smSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|SMP_PHY_CONTROL
expr_stmt|;
name|smSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0
expr_stmt|;
name|smSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0
expr_stmt|;
name|sm_memcpy
argument_list|(
name|smSMPRequestBody
operator|->
name|smpPayload
argument_list|,
operator|&
name|smSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
operator|(
name|smSMPRequestBody
operator|->
name|smpPayload
operator|)
operator|+
literal|4
argument_list|,
name|pSmpBody
argument_list|,
name|smpBodySize
argument_list|)
expr_stmt|;
comment|/* direct SMP payload eg) REPORT_GENERAL, DISCOVER etc */
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|smSMPRequestBody
operator|->
name|smpPayload
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
name|smpBodySize
operator|+
literal|4
expr_stmt|;
comment|/* without last 4 byte crc */
comment|/* to specify DIRECT SMP response */
name|agSMPFrame
operator|->
name|inFrameLen
operator|=
literal|0
expr_stmt|;
comment|/* temporary solution for T2D Combo*/
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|&&
name|defined
argument_list|(
name|TARGET_DRIVER
argument_list|)
comment|/* force smp repsonse to be direct */
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
name|expectedRspLen
expr_stmt|;
endif|#
directive|endif
comment|//    smhexdump("smPhyControlSend", (bit8*)agSMPFrame->outFrameBuf, agSMPFrame->outFrameLen);
comment|//    smhexdump("smPhyControlSend new", (bit8*)smSMPRequestBody->smpPayload, agSMPFrame->outFrameLen);
comment|//    smhexdump("smPhyControlSend - smSMPRequestBody", (bit8*)smSMPRequestBody, sizeof(smSMPRequestBody_t));
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlSend: INDIRECT smp payload, not supported!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
block|}
else|else
comment|/* SPCv controller */
block|{
comment|/* only direct mode for both request and response */
name|SM_DBG3
argument_list|(
operator|(
literal|"smPhyControlSend: DIRECT smp payload\n"
operator|)
argument_list|)
expr_stmt|;
name|agSMPFrame
operator|->
name|flag
operator|=
literal|0
expr_stmt|;
name|sm_memset
argument_list|(
operator|&
name|smSMPFrameHeader
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smSMPFrameHeader_t
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|smSMPRequestBody
operator|->
name|smpPayload
argument_list|,
literal|0
argument_list|,
name|SMP_DIRECT_PAYLOAD_LIMIT
argument_list|)
expr_stmt|;
comment|/* SMP header */
name|smSMPFrameHeader
operator|.
name|smpFrameType
operator|=
name|SMP_REQUEST
expr_stmt|;
comment|/* SMP request */
name|smSMPFrameHeader
operator|.
name|smpFunction
operator|=
operator|(
name|bit8
operator|)
name|SMP_PHY_CONTROL
expr_stmt|;
name|smSMPFrameHeader
operator|.
name|smpFunctionResult
operator|=
literal|0
expr_stmt|;
name|smSMPFrameHeader
operator|.
name|smpReserved
operator|=
literal|0
expr_stmt|;
name|sm_memcpy
argument_list|(
name|smSMPRequestBody
operator|->
name|smpPayload
argument_list|,
operator|&
name|smSMPFrameHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
operator|(
name|smSMPRequestBody
operator|->
name|smpPayload
operator|)
operator|+
literal|4
argument_list|,
name|pSmpBody
argument_list|,
name|smpBodySize
argument_list|)
expr_stmt|;
comment|/* direct SMP payload eg) REPORT_GENERAL, DISCOVER etc */
name|agSMPFrame
operator|->
name|outFrameBuf
operator|=
name|smSMPRequestBody
operator|->
name|smpPayload
expr_stmt|;
name|agSMPFrame
operator|->
name|outFrameLen
operator|=
name|smpBodySize
operator|+
literal|4
expr_stmt|;
comment|/* without last 4 byte crc */
comment|/* to specify DIRECT SMP response */
name|agSMPFrame
operator|->
name|inFrameLen
operator|=
literal|0
expr_stmt|;
comment|/* temporary solution for T2D Combo*/
if|#
directive|if
name|defined
argument_list|(
name|INITIATOR_DRIVER
argument_list|)
operator|&&
name|defined
argument_list|(
name|TARGET_DRIVER
argument_list|)
comment|/* force smp repsonse to be direct */
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|agSMPFrame
operator|->
name|expectedRespLen
operator|=
name|expectedRspLen
expr_stmt|;
endif|#
directive|endif
comment|//    smhexdump("smPhyControlSend", (bit8*)agSMPFrame->outFrameBuf, agSMPFrame->outFrameLen);
comment|//    smhexdump("smPhyControlSend new", (bit8*)smSMPRequestBody->smpPayload, agSMPFrame->outFrameLen);
comment|//    smhexdump("smPhyControlSend - smSMPRequestBody", (bit8*)smSMPRequestBody, sizeof(smSMPRequestBody_t));
block|}
name|status
operator|=
name|saSMPStart
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|queueNumber
argument_list|,
name|agExpDevHandle
argument_list|,
name|agRequestType
argument_list|,
name|agSASRequestBody
argument_list|,
operator|&
name|smSMPCompletedCB
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AGSA_RC_SUCCESS
condition|)
block|{
return|return
name|SM_RC_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|AGSA_RC_BUSY
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlSend: saSMPStart is busy!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_BUSY
return|;
block|}
else|else
comment|/* AGSA_RC_FAILURE */
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlSend: saSMPStart is failed. status %d!!!\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
block|}
end_function

begin_comment
comment|/* free IO which are internally completed within SM    counterpart is    osGLOBAL smIORequestBody_t *    smDequeueIO(smRoot_t          *smRoot) */
end_comment

begin_function
name|osGLOBAL
name|void
name|smEnqueueIO
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smEnqueueIO: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
comment|/* enque back to smAllShared->freeIOList */
if|if
condition|(
name|satIOContext
operator|->
name|satIntIoContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smEnqueueIO: external command!!!, io ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* debugging only */
if|if
condition|(
name|smIORequestBody
operator|->
name|satIoBodyLink
operator|.
name|flink
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smEnqueueIO: external command!!!, io ID %d, flink is NULL!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIORequestBody
operator|->
name|satIoBodyLink
operator|.
name|blink
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smEnqueueIO: external command!!!, io ID %d, blink is NULL!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smEnqueueIO: internal command!!!, io ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* debugging only */
if|if
condition|(
name|smIORequestBody
operator|->
name|satIoBodyLink
operator|.
name|flink
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smEnqueueIO: internal command!!!, io ID %d, flink is NULL!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIORequestBody
operator|->
name|satIoBodyLink
operator|.
name|blink
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smEnqueueIO: internal command!!!, io ID %d, blink is NULL!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|smIORequestBody
operator|->
name|smIORequest
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smEnqueueIO: smIORequest is NULL, io ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIORequestBody
operator|->
name|InUse
operator|==
name|agTRUE
condition|)
block|{
name|smIORequestBody
operator|->
name|InUse
operator|=
name|agFALSE
expr_stmt|;
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|SMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|smIORequestBody
operator|->
name|satIoBodyLink
operator|)
argument_list|)
expr_stmt|;
name|SMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|smIORequestBody
operator|->
name|satIoBodyLink
operator|)
argument_list|,
operator|&
operator|(
name|smAllShared
operator|->
name|freeIOList
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smEnqueueIO: check!!!, io ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|FORCEINLINE
name|void
name|smsatFreeIntIoResource
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smDeviceData_t
modifier|*
name|satDevData
parameter_list|,
name|smSatInternalIo_t
modifier|*
name|satIntIo
parameter_list|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatFreeIntIoResource: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatFreeIntIoResource: allowed call\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* sets the original smIOrequest to agNULL for internally generated ATA cmnd */
name|satIntIo
operator|->
name|satOrgSmIORequest
operator|=
name|agNULL
expr_stmt|;
comment|/*    * Free DMA memory if previosly alocated    */
if|if
condition|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|.
name|expDataLength
operator|!=
literal|0
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatFreeIntIoResource: DMA len %d\n"
operator|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatFreeIntIoResource: pointer %p\n"
operator|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|osHandle
operator|)
argument_list|)
expr_stmt|;
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|osHandle
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|.
name|expDataLength
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
operator|!=
literal|0
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatFreeIntIoResource: req body len %d\n"
operator|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Free mem allocated for Req body      */
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|osHandle
argument_list|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
operator|=
literal|0
expr_stmt|;
block|}
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatFreeIntIoResource: satDevData %p satIntIo id %d\n"
operator|,
name|satDevData
operator|,
name|satIntIo
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Return satIntIo to the free list    */
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|SMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|satIntIo
operator|->
name|satIntIoLink
operator|)
argument_list|)
expr_stmt|;
name|SMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|satIntIo
operator|->
name|satIntIoLink
operator|)
argument_list|,
operator|&
operator|(
name|satDevData
operator|->
name|satFreeIntIoLinkList
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|//start here
end_comment

begin_function
name|osGLOBAL
name|smSatInternalIo_t
modifier|*
name|smsatAllocIntIoResource
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceData_t
modifier|*
name|satDevData
parameter_list|,
name|bit32
name|dmaAllocLength
parameter_list|,
name|smSatInternalIo_t
modifier|*
name|satIntIo
parameter_list|)
block|{
name|smList_t
modifier|*
name|smList
init|=
name|agNULL
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: satIntIo %p\n"
operator|,
name|satIntIo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satDevData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: ***** ASSERT satDevData is null!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|satDevData
operator|->
name|satFreeIntIoLinkList
operator|)
argument_list|)
condition|)
block|{
name|SMLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|smList
argument_list|,
operator|&
operator|(
name|satDevData
operator|->
name|satFreeIntIoLinkList
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatAllocIntIoResource() no more internal free link!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
name|smList
operator|==
name|agNULL
condition|)
block|{
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatAllocIntIoResource() FAIL to alloc satIntIo!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|satIntIo
operator|=
name|SMLIST_OBJECT_BASE
argument_list|(
name|smSatInternalIo_t
argument_list|,
name|satIntIoLink
argument_list|,
name|smList
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: satDevData %p satIntIo id %d\n"
operator|,
name|satDevData
operator|,
name|satIntIo
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* Put in active list */
name|SMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|satIntIo
operator|->
name|satIntIoLink
operator|)
argument_list|)
expr_stmt|;
name|SMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|satIntIo
operator|->
name|satIntIoLink
operator|)
argument_list|,
operator|&
operator|(
name|satDevData
operator|->
name|satActiveIntIoLinkList
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
comment|/* Put in active list */
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|SMLIST_DEQUEUE_THIS
argument_list|(
name|smList
argument_list|)
expr_stmt|;
name|SMLIST_ENQUEUE_AT_TAIL
argument_list|(
name|smList
argument_list|,
operator|&
operator|(
name|satDevData
operator|->
name|satActiveIntIoLinkList
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|satIntIo
operator|=
name|SMLIST_OBJECT_BASE
argument_list|(
name|smSatInternalIo_t
argument_list|,
name|satIntIoLink
argument_list|,
name|smList
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: satDevData %p satIntIo id %d\n"
operator|,
name|satDevData
operator|,
name|satIntIo
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*     typedef struct     {       tdList_t                    satIntIoLink;       smIORequest_t               satIntSmIORequest;       void                        *satIntRequestBody;       smScsiInitiatorRequest_t    satIntSmScsiXchg;       smMem_t                     satIntDmaMem;       smMem_t                     satIntReqBodyMem;       bit32                       satIntFlag;     } smSatInternalIo_t;   */
comment|/*    * Allocate mem for Request Body    */
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
operator|=
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
expr_stmt|;
name|memAllocStatus
operator|=
name|tdsmAllocMemory
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|osHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|satIntIo
operator|->
name|satIntRequestBody
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|physAddrUpper
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|physAddrLower
argument_list|,
literal|8
argument_list|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatAllocIntIoResource() FAIL to alloc mem for Req Body!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Return satIntIo to the free list      */
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|SMLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|satIntIo
operator|->
name|satIntIoLink
argument_list|)
expr_stmt|;
name|SMLIST_ENQUEUE_AT_HEAD
argument_list|(
operator|&
name|satIntIo
operator|->
name|satIntIoLink
argument_list|,
operator|&
name|satDevData
operator|->
name|satFreeIntIoLinkList
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
comment|/*    *   Allocate DMA memory if required    */
if|if
condition|(
name|dmaAllocLength
operator|!=
literal|0
condition|)
block|{
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
operator|=
name|dmaAllocLength
expr_stmt|;
name|memAllocStatus
operator|=
name|tdsmAllocMemory
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|osHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|virtPtr
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|physAddrUpper
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|physAddrLower
argument_list|,
literal|8
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: len %d \n"
operator|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: pointer %p \n"
operator|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|osHandle
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatAllocIntIoResource() FAIL to alloc mem for DMA mem!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*        * Return satIntIo to the free list        */
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|SMLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|satIntIo
operator|->
name|satIntIoLink
argument_list|)
expr_stmt|;
name|SMLIST_ENQUEUE_AT_HEAD
argument_list|(
operator|&
name|satIntIo
operator|->
name|satIntIoLink
argument_list|,
operator|&
name|satDevData
operator|->
name|satFreeIntIoLinkList
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_INTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
comment|/*        * Free mem allocated for Req body        */
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|osHandle
argument_list|,
name|satIntIo
operator|->
name|satIntReqBodyMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
block|}
comment|/*     typedef struct     {       smList_t                    satIntIoLink;       smIORequest_t               satIntSmIORequest;       void                        *satIntRequestBody;       smScsiInitiatorRequest_t    satIntSmScsiXchg;       smMem_t                     satIntDmaMem;       smMem_t                     satIntReqBodyMem;       bit32                       satIntFlag;     } smSatInternalIo_t;   */
comment|/*    * Initialize satIntSmIORequest field    */
name|satIntIo
operator|->
name|satIntSmIORequest
operator|.
name|tdData
operator|=
name|agNULL
expr_stmt|;
comment|/* Not used for internal SAT I/O */
name|satIntIo
operator|->
name|satIntSmIORequest
operator|.
name|smData
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
comment|/*    * saves the original smIOrequest    */
name|satIntIo
operator|->
name|satOrgSmIORequest
operator|=
name|smIORequest
expr_stmt|;
comment|/*     typedef struct tiIniScsiCmnd     {       tiLUN_t     lun;       bit32       expDataLength;       bit32       taskAttribute;       bit32       crn;       bit8        cdb[16];     } tiIniScsiCmnd_t;      typedef struct tiScsiInitiatorExchange     {       void                *sglVirtualAddr;       tiIniScsiCmnd_t     scsiCmnd;       tiSgl_t             agSgl1;       tiSgl_t             agSgl2;       tiDataDirection_t   dataDirection;     } tiScsiInitiatorRequest_t;    */
comment|/*    * Initialize satIntSmScsiXchg. Since the internal SAT request is NOT    * originated from SCSI request, only the following fields are initialized:    *  - sglVirtualAddr if DMA transfer is involved    *  - agSgl1 if DMA transfer is involved    *  - expDataLength in scsiCmnd since this field is read by smsataLLIOStart()    */
if|if
condition|(
name|dmaAllocLength
operator|!=
literal|0
condition|)
block|{
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|sglVirtualAddr
operator|=
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|virtPtr
expr_stmt|;
name|OSSA_WRITE_LE_32
argument_list|(
name|agNULL
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|len
argument_list|,
literal|0
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
argument_list|)
expr_stmt|;
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|lower
operator|=
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|physAddrLower
expr_stmt|;
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|upper
operator|=
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|physAddrUpper
expr_stmt|;
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|type
operator|=
name|tiSgl
expr_stmt|;
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|.
name|expDataLength
operator|=
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|totalLength
expr_stmt|;
block|}
else|else
block|{
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|sglVirtualAddr
operator|=
name|agNULL
expr_stmt|;
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|lower
operator|=
literal|0
expr_stmt|;
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|upper
operator|=
literal|0
expr_stmt|;
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|type
operator|=
name|tiSgl
expr_stmt|;
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|.
name|expDataLength
operator|=
literal|0
expr_stmt|;
block|}
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: satIntIo->satIntSmScsiXchg.agSgl1.len %d\n"
operator|,
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|len
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: satIntIo->satIntSmScsiXchg.agSgl1.upper %d\n"
operator|,
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|upper
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: satIntIo->satIntSmScsiXchg.agSgl1.lower %d\n"
operator|,
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|lower
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: satIntIo->satIntSmScsiXchg.agSgl1.type %d\n"
operator|,
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatAllocIntIoResource: return satIntIo %p\n"
operator|,
name|satIntIo
operator|)
argument_list|)
expr_stmt|;
return|return
name|satIntIo
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|smDeviceData_t
modifier|*
name|smAddToSharedcontext
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agExpDevHandle
parameter_list|,
name|bit32
name|phyID
parameter_list|)
block|{
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|new_device
init|=
name|agTRUE
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smAddToSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|smAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|smAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|SMLIST_OBJECT_BASE
argument_list|(
name|smDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smAddToSharedcontext: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|agDevHandle
operator|==
name|agDevHandle
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smAddToSharedcontext: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|new_device
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
comment|/* new device */
if|if
condition|(
name|new_device
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smAddToSharedcontext: new device\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|SMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|smAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
condition|)
block|{
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smAddToSharedcontext: empty DeviceData FreeLink!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smDeviceHandle
operator|->
name|smData
operator|=
name|agNULL
expr_stmt|;
return|return
name|agNULL
return|;
block|}
name|SMLIST_DEQUEUE_FROM_HEAD
argument_list|(
operator|&
name|DeviceListList
argument_list|,
operator|&
operator|(
name|smAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|SMLIST_OBJECT_BASE
argument_list|(
name|smDeviceData_t
argument_list|,
name|FreeLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|smRoot
operator|=
name|smRoot
expr_stmt|;
name|oneDeviceData
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|smDeviceHandle
operator|->
name|smData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|smDevHandle
operator|=
name|smDeviceHandle
expr_stmt|;
if|if
condition|(
name|agExpDevHandle
operator|==
name|agNULL
condition|)
block|{
name|oneDeviceData
operator|->
name|directlyAttached
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|directlyAttached
operator|=
name|agFALSE
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|agExpDevHandle
operator|=
name|agExpDevHandle
expr_stmt|;
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingIO
operator|=
literal|0
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|=
literal|0
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|=
literal|0
expr_stmt|;
comment|/* add the devicedata to the portcontext */
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|SMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|,
operator|&
operator|(
name|smAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smAddToSharedcontext: new case did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smAddToSharedcontext: old device\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|smRoot
operator|=
name|smRoot
expr_stmt|;
name|oneDeviceData
operator|->
name|agDevHandle
operator|=
name|agDevHandle
expr_stmt|;
name|oneDeviceData
operator|->
name|valid
operator|=
name|agTRUE
expr_stmt|;
name|smDeviceHandle
operator|->
name|smData
operator|=
name|oneDeviceData
expr_stmt|;
name|oneDeviceData
operator|->
name|smDevHandle
operator|=
name|smDeviceHandle
expr_stmt|;
if|if
condition|(
name|agExpDevHandle
operator|==
name|agNULL
condition|)
block|{
name|oneDeviceData
operator|->
name|directlyAttached
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|directlyAttached
operator|=
name|agFALSE
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|agExpDevHandle
operator|=
name|agExpDevHandle
expr_stmt|;
name|oneDeviceData
operator|->
name|phyID
operator|=
name|phyID
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingIO
operator|=
literal|0
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|=
literal|0
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|=
literal|0
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smAddToSharedcontext: old case did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|oneDeviceData
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smRemoveFromSharedcontext
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|)
block|{
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smRemoveFromSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|//due to device all and completion
comment|//smDeviceHandle->smData = agNULL;
comment|/* find oneDeviceData from MainLink */
name|oneDeviceData
operator|=
name|smFindInSharedcontext
argument_list|(
name|smRoot
argument_list|,
name|agDevHandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
return|return
name|SM_RC_FAILURE
return|;
block|}
else|else
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|smDeviceDataReInit
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_DEVICE_LOCK
argument_list|)
expr_stmt|;
name|SMLIST_DEQUEUE_THIS
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|MainLink
operator|)
argument_list|)
expr_stmt|;
name|SMLIST_ENQUEUE_AT_TAIL
argument_list|(
operator|&
operator|(
name|oneDeviceData
operator|->
name|FreeLink
operator|)
argument_list|,
operator|&
operator|(
name|smAllShared
operator|->
name|FreeDeviceList
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_DEVICE_LOCK
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smRemoveFromSharedcontext: did %d bad case!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|smDeviceData_t
modifier|*
name|smFindInSharedcontext
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|)
block|{
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smFindInSharedcontext: start\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_DEVICE_LOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|SMLIST_EMPTY
argument_list|(
operator|&
operator|(
name|smAllShared
operator|->
name|MainDeviceList
operator|)
argument_list|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smFindInSharedcontext: empty MainDeviceList!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_DEVICE_LOCK
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
else|else
block|{
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_DEVICE_LOCK
argument_list|)
expr_stmt|;
block|}
name|DeviceListList
operator|=
name|smAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|smAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|SMLIST_OBJECT_BASE
argument_list|(
name|smDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smFindInSharedcontext: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|agDevHandle
operator|==
name|agDevHandle
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
operator|)
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smFindInSharedcontext: found, did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|oneDeviceData
return|;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smFindInSharedcontext: not found\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agNULL
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|smSatIOContext_t
modifier|*
name|smsatPrepareNewIO
parameter_list|(
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
parameter_list|,
name|smIORequest_t
modifier|*
name|smOrgIORequest
parameter_list|,
name|smDeviceData_t
modifier|*
name|satDevData
parameter_list|,
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
parameter_list|)
block|{
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smNewIORequestBody
decl_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatPrepareNewIO: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* the one to be used; good 8/2/07 */
name|satNewIntIo
operator|->
name|satOrgSmIORequest
operator|=
name|smOrgIORequest
expr_stmt|;
comment|/* this is already done in                                                       smsatAllocIntIoResource() */
name|smNewIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satNewIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|=
operator|&
operator|(
name|smNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSatDevData
operator|=
name|satDevData
expr_stmt|;
name|satNewIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|smNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
if|if
condition|(
name|scsiCmnd
operator|!=
name|agNULL
condition|)
block|{
comment|/* saves only CBD; not scsi command for LBA and number of blocks */
name|sm_memcpy
argument_list|(
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|->
name|cdb
argument_list|,
name|scsiCmnd
operator|->
name|cdb
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
name|satNewIOContext
operator|->
name|pSense
operator|=
operator|&
operator|(
name|smNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSmSenseData
operator|=
operator|&
operator|(
name|smNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSmSenseData
operator|->
name|senseData
operator|=
name|satNewIOContext
operator|->
name|pSense
expr_stmt|;
name|satNewIOContext
operator|->
name|smRequestBody
operator|=
name|satNewIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|->
name|interruptContext
operator|=
name|satNewIOContext
operator|->
name|interruptContext
expr_stmt|;
name|satNewIOContext
operator|->
name|satIntIoContext
operator|=
name|satNewIntIo
expr_stmt|;
name|satNewIOContext
operator|->
name|psmDeviceHandle
operator|=
name|satOrgIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
name|satNewIOContext
operator|->
name|satOrgIOContext
operator|=
name|satOrgIOContext
expr_stmt|;
comment|/* saves tiScsiXchg; only for writesame10() */
name|satNewIOContext
operator|->
name|smScsiXchg
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
return|return
name|satNewIOContext
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSetDevInfo
parameter_list|(
name|smDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|SATAIdData
parameter_list|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|oneDeviceData
operator|->
name|satFormatState
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|satDeviceFaultState
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|oneDeviceData
operator|->
name|satAbortAfterReset
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|satAbortCalled
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|satSectorDone
operator|=
literal|0
expr_stmt|;
comment|/* Qeueu depth, Word 75 */
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|=
name|SATAIdData
operator|->
name|queueDepth
operator|+
literal|1
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: max queue depth %d\n"
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
comment|/* Support NCQ, if Word 76 bit 8 is set */
if|if
condition|(
name|SATAIdData
operator|->
name|sataCapabilities
operator|&
literal|0x100
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: device supports NCQ\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satNCQ
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no NCQ\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satNCQ
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support 48 bit addressing, if Word 83 bit 10 and Word 86 bit 10 are set */
if|if
condition|(
operator|(
name|SATAIdData
operator|->
name|commandSetSupported1
operator|&
literal|0x400
operator|)
operator|&&
operator|(
name|SATAIdData
operator|->
name|commandSetFeatureEnabled1
operator|&
literal|0x400
operator|)
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: support 48 bit addressing\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|sat48BitSupport
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: NO 48 bit addressing\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|sat48BitSupport
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support SMART Self Test, word84 bit 1 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureSupportedExt
operator|&
literal|0x02
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: SMART self-test supported \n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satSMARTSelfTest
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no SMART self-test suppored\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satSMARTSelfTest
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support SMART feature set, word82 bit 0 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetSupported
operator|&
literal|0x01
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: SMART feature set supported \n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satSMARTFeatureSet
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no SMART feature set suppored\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satSMARTFeatureSet
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support SMART enabled, word85 bit 0 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureEnabled
operator|&
literal|0x01
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: SMART enabled \n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satSMARTEnabled
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no SMART enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satSMARTEnabled
operator|=
name|agFALSE
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
comment|/* Removable Media feature set support, word82 bit 2 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetSupported
operator|&
literal|0x4
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: Removable Media supported \n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satRemovableMedia
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no Removable Media suppored\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satRemovableMedia
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Removable Media feature set enabled, word 85, bit 2 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureEnabled
operator|&
literal|0x4
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: Removable Media enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satRemovableMediaEnabled
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no Removable Media enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satRemovableMediaEnabled
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* DMA Support, word49 bit8 */
if|if
condition|(
name|SATAIdData
operator|->
name|dma_lba_iod_ios_stimer
operator|&
literal|0x100
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: DMA supported \n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDMASupport
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no DMA suppored\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDMASupport
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support DMADIR, if Word 62 bit 8 is set */
if|if
condition|(
name|SATAIdData
operator|->
name|word62_74
index|[
literal|0
index|]
operator|&
literal|0x8000
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: DMADIR enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDMADIRSupport
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"satSetDevInfo: DMADIR disabled\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDMADIRSupport
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* DMA Enabled, word88 bit0-6, bit8-14*/
comment|/* 0x7F7F = 0111 1111 0111 1111*/
if|if
condition|(
name|SATAIdData
operator|->
name|ultraDMAModes
operator|&
literal|0x7F7F
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: DMA enabled \n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDMAEnabled
operator|=
name|agTRUE
expr_stmt|;
if|if
condition|(
name|SATAIdData
operator|->
name|ultraDMAModes
operator|&
literal|0x40
condition|)
block|{
name|oneDeviceData
operator|->
name|satUltraDMAMode
operator|=
literal|6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SATAIdData
operator|->
name|ultraDMAModes
operator|&
literal|0x20
condition|)
block|{
name|oneDeviceData
operator|->
name|satUltraDMAMode
operator|=
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SATAIdData
operator|->
name|ultraDMAModes
operator|&
literal|0x10
condition|)
block|{
name|oneDeviceData
operator|->
name|satUltraDMAMode
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SATAIdData
operator|->
name|ultraDMAModes
operator|&
literal|0x08
condition|)
block|{
name|oneDeviceData
operator|->
name|satUltraDMAMode
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SATAIdData
operator|->
name|ultraDMAModes
operator|&
literal|0x04
condition|)
block|{
name|oneDeviceData
operator|->
name|satUltraDMAMode
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SATAIdData
operator|->
name|ultraDMAModes
operator|&
literal|0x01
condition|)
block|{
name|oneDeviceData
operator|->
name|satUltraDMAMode
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no DMA enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDMAEnabled
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|satUltraDMAMode
operator|=
literal|0
expr_stmt|;
block|}
comment|/*     setting MaxUserAddrSectors: max user addressable setctors     word60 - 61, should be 0x 0F FF FF FF   */
name|oneDeviceData
operator|->
name|satMaxUserAddrSectors
operator|=
operator|(
name|SATAIdData
operator|->
name|numOfUserAddressableSectorsHi
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
name|SATAIdData
operator|->
name|numOfUserAddressableSectorsLo
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: MaxUserAddrSectors 0x%x decimal %d\n"
operator|,
name|oneDeviceData
operator|->
name|satMaxUserAddrSectors
operator|,
name|oneDeviceData
operator|->
name|satMaxUserAddrSectors
operator|)
argument_list|)
expr_stmt|;
comment|/* Read Look-ahead is supported */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetSupported
operator|&
literal|0x40
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: Read Look-ahead is supported\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satReadLookAheadSupport
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: Read Look-ahead is not supported\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satReadLookAheadSupport
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Volatile Write Cache is supported */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetSupported
operator|&
literal|0x20
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: Volatile Write Cache is supported\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satVolatileWriteCacheSupport
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: Volatile Write Cache is not supported\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satVolatileWriteCacheSupport
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* write cache enabled for caching mode page SAT Table 67 p69, word85 bit5 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureEnabled
operator|&
literal|0x20
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: write cache enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satWriteCacheEnabled
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no write cache enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satWriteCacheEnabled
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* look ahead enabled for caching mode page SAT Table 67 p69, word85 bit6 */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureEnabled
operator|&
literal|0x40
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: look ahead enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satLookAheadEnabled
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no look ahead enabled\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satLookAheadEnabled
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support WWN, if Word 87 bit 8 is set */
if|if
condition|(
name|SATAIdData
operator|->
name|commandSetFeatureDefault
operator|&
literal|0x100
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: device supports WWN\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satWWNSupport
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no WWN\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satWWNSupport
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support DMA Setup Auto-Activate, if Word 78 bit 2 is set */
if|if
condition|(
name|SATAIdData
operator|->
name|sataFeaturesSupported
operator|&
literal|0x4
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: device supports DMA Setup Auto-Activate\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDMASetupAA
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no DMA Setup Auto-Activate\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDMASetupAA
operator|=
name|agFALSE
expr_stmt|;
block|}
comment|/* Support NCQ Queue Management Command, if Word 77 bit 5 is set */
if|if
condition|(
name|SATAIdData
operator|->
name|word77
operator|&
literal|0x10
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: device supports NCQ Queue Management Command\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satNCQQMgntCmd
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetDevInfo: no NCQ Queue Management Command\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satNCQQMgntCmd
operator|=
name|agFALSE
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatInquiryStandard
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|,
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
parameter_list|)
block|{
name|smLUN_t
modifier|*
name|pLun
decl_stmt|;
name|pLun
operator|=
operator|&
name|scsiCmnd
operator|->
name|lun
expr_stmt|;
comment|/*     Assumption: Basic Task Mangement is supported     -> BQUE 1 and CMDQUE 0, SPC-4, Table96, p147   */
comment|/*     See SPC-4, 6.4.2, p 143     and SAT revision 8, 8.1.2, p 28    */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryStandard: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pInquiry
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryStandard: pInquiry is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryStandard: pInquiry is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*    * Reject all other LUN other than LUN 0.    */
if|if
condition|(
operator|(
operator|(
name|pLun
operator|->
name|lun
index|[
literal|0
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|1
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|2
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|3
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|4
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|5
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|6
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|7
index|]
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
comment|/* SAT Spec Table 8, p27, footnote 'a' */
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x7F
expr_stmt|;
block|}
else|else
block|{
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|pSATAIdData
operator|->
name|rm_ataDevice
operator|&
name|ATA_REMOVABLE_MEDIA_DEVICE_MASK
condition|)
block|{
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x80
expr_stmt|;
block|}
else|else
block|{
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0x05
expr_stmt|;
comment|/* SPC-3 */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* set HiSup 1; resp data format set to 2 */
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x1F
expr_stmt|;
comment|/* 35 - 4 = 31; Additional length */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* The following two are for task management. SAT Rev8, p20 */
if|if
condition|(
name|pSATAIdData
operator|->
name|sataCapabilities
operator|&
literal|0x100
condition|)
block|{
comment|/* NCQ supported; multiple outstanding SCSI IO are supported */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* BQUE bit is not set */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* CMDQUE bit is set */
block|}
else|else
block|{
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x80
expr_stmt|;
comment|/* BQUE bit is set */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* CMDQUE bit is not set */
block|}
comment|/*    * Vendor ID.    */
name|sm_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|8
index|]
argument_list|,
name|AG_SAT_VENDOR_ID_STRING
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* 8 bytes   */
comment|/*    * Product ID    */
comment|/* when flipped by LL */
name|pInquiry
index|[
literal|16
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|1
index|]
expr_stmt|;
name|pInquiry
index|[
literal|17
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|0
index|]
expr_stmt|;
name|pInquiry
index|[
literal|18
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|3
index|]
expr_stmt|;
name|pInquiry
index|[
literal|19
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|2
index|]
expr_stmt|;
name|pInquiry
index|[
literal|20
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|5
index|]
expr_stmt|;
name|pInquiry
index|[
literal|21
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|4
index|]
expr_stmt|;
name|pInquiry
index|[
literal|22
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|7
index|]
expr_stmt|;
name|pInquiry
index|[
literal|23
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|6
index|]
expr_stmt|;
name|pInquiry
index|[
literal|24
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|9
index|]
expr_stmt|;
name|pInquiry
index|[
literal|25
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|8
index|]
expr_stmt|;
name|pInquiry
index|[
literal|26
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|11
index|]
expr_stmt|;
name|pInquiry
index|[
literal|27
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|10
index|]
expr_stmt|;
name|pInquiry
index|[
literal|28
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|13
index|]
expr_stmt|;
name|pInquiry
index|[
literal|29
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|12
index|]
expr_stmt|;
name|pInquiry
index|[
literal|30
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|15
index|]
expr_stmt|;
name|pInquiry
index|[
literal|31
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|14
index|]
expr_stmt|;
comment|/* when flipped */
comment|/*    * Product Revision level.    */
comment|/*    * If the IDENTIFY DEVICE data received in words 25 and 26 from the ATA    * device are ASCII spaces (20h), do this translation.    */
if|if
condition|(
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|4
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|5
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|6
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|7
index|]
operator|==
literal|0x20
operator|)
condition|)
block|{
name|pInquiry
index|[
literal|32
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|1
index|]
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|0
index|]
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|3
index|]
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|2
index|]
expr_stmt|;
block|}
else|else
block|{
name|pInquiry
index|[
literal|32
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|5
index|]
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|4
index|]
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|7
index|]
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|6
index|]
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
comment|/*    * Product ID    */
comment|/* when flipped by LL */
name|pInquiry
index|[
literal|16
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|0
index|]
expr_stmt|;
name|pInquiry
index|[
literal|17
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|1
index|]
expr_stmt|;
name|pInquiry
index|[
literal|18
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|2
index|]
expr_stmt|;
name|pInquiry
index|[
literal|19
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|3
index|]
expr_stmt|;
name|pInquiry
index|[
literal|20
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|4
index|]
expr_stmt|;
name|pInquiry
index|[
literal|21
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|5
index|]
expr_stmt|;
name|pInquiry
index|[
literal|22
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|6
index|]
expr_stmt|;
name|pInquiry
index|[
literal|23
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|7
index|]
expr_stmt|;
name|pInquiry
index|[
literal|24
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|8
index|]
expr_stmt|;
name|pInquiry
index|[
literal|25
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|9
index|]
expr_stmt|;
name|pInquiry
index|[
literal|26
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|10
index|]
expr_stmt|;
name|pInquiry
index|[
literal|27
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|11
index|]
expr_stmt|;
name|pInquiry
index|[
literal|28
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|12
index|]
expr_stmt|;
name|pInquiry
index|[
literal|29
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|13
index|]
expr_stmt|;
name|pInquiry
index|[
literal|30
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|14
index|]
expr_stmt|;
name|pInquiry
index|[
literal|31
index|]
operator|=
name|pSATAIdData
operator|->
name|modelNumber
index|[
literal|15
index|]
expr_stmt|;
comment|/* when flipped */
comment|/*    * Product Revision level.    */
comment|/*    * If the IDENTIFY DEVICE data received in words 25 and 26 from the ATA    * device are ASCII spaces (20h), do this translation.    */
if|if
condition|(
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|4
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|5
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|6
index|]
operator|==
literal|0x20
operator|)
operator|&&
operator|(
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|7
index|]
operator|==
literal|0x20
operator|)
condition|)
block|{
name|pInquiry
index|[
literal|32
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|0
index|]
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|1
index|]
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|2
index|]
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
block|{
name|pInquiry
index|[
literal|32
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|4
index|]
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|5
index|]
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|6
index|]
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
name|pSATAIdData
operator|->
name|firmwareVersion
index|[
literal|7
index|]
expr_stmt|;
block|}
endif|#
directive|endif
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryStandard: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatInquiryPage0
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryPage0: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     See SPC-4, 7.6.9, p 345     and SAT revision 8, 10.3.2, p 77    */
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* page code */
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|8
operator|-
literal|3
expr_stmt|;
comment|/* last index(in this case, 6) - 3; page length */
comment|/* supported vpd page list */
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* page 0x00 supported */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x80
expr_stmt|;
comment|/* page 0x80 supported */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x83
expr_stmt|;
comment|/* page 0x83 supported */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x89
expr_stmt|;
comment|/* page 0x89 supported */
name|pInquiry
index|[
literal|8
index|]
operator|=
literal|0xB1
expr_stmt|;
comment|/* page 0xB1 supported */
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatInquiryPage83
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|,
name|smDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|)
block|{
name|satSimpleSATAIdentifyData_t
modifier|*
name|pSimpleData
decl_stmt|;
comment|/*    * When translating the fields, in some cases using the simple form of SATA    * Identify Device Data is easier. So we define it here.    * Both pSimpleData and pSATAIdData points to the same data.    */
name|pSimpleData
operator|=
operator|(
name|satSimpleSATAIdentifyData_t
operator|*
operator|)
name|pSATAIdData
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryPage83: start\n"
operator|)
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x83
expr_stmt|;
comment|/* page code */
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Reserved */
comment|/*    * If the ATA device returns word 87 bit 8 set to one in its IDENTIFY DEVICE    * data indicating that it supports the WORLD WIDE NAME field    * (i.e., words 108-111), the SATL shall include an identification descriptor    * containing a logical unit name.    */
if|if
condition|(
name|oneDeviceData
operator|->
name|satWWNSupport
condition|)
block|{
ifndef|#
directive|ifndef
name|PMC_FREEBSD
comment|/* Fill in SAT Rev8 Table85 */
comment|/*      * Logical unit name derived from the world wide name.      */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|12
expr_stmt|;
comment|/* 15-3; page length, no addition ID descriptor assumed*/
comment|/*      * Identifier descriptor      */
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Code set: binary codes */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x03
expr_stmt|;
comment|/* Identifier type : NAA  */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved               */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* Identifier length      */
comment|/* Bit 4-7 NAA field, bit 0-3 MSB of IEEE Company ID */
name|pInquiry
index|[
literal|8
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|9
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* IEEE Company ID */
name|pInquiry
index|[
literal|10
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority1
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* IEEE Company ID */
comment|/* Bit 4-7 LSB of IEEE Company ID, bit 0-3 MSB of Vendor Specific ID */
name|pInquiry
index|[
literal|11
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority1
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|12
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit16_31
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
name|pInquiry
index|[
literal|13
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit16_31
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
name|pInquiry
index|[
literal|14
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit0_15
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
name|pInquiry
index|[
literal|15
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit0_15
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
else|#
directive|else
comment|/* For FreeBSD */
comment|/* Fill in SAT Rev8 Table85 */
comment|/*      * Logical unit name derived from the world wide name.      */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|24
expr_stmt|;
comment|/* 35-3; page length, no addition ID descriptor assumed*/
comment|/*      * Identifier descriptor      */
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Code set: binary codes; this is proto_codeset in FreeBSD */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x03
expr_stmt|;
comment|/* Identifier type : NAA ; this is  id_type in FreeBSD*/
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved               */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* Identifier length      */
comment|/* Bit 4-7 NAA field, bit 0-3 MSB of IEEE Company ID */
name|pInquiry
index|[
literal|8
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|9
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* IEEE Company ID */
name|pInquiry
index|[
literal|10
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority1
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* IEEE Company ID */
comment|/* Bit 4-7 LSB of IEEE Company ID, bit 0-3 MSB of Vendor Specific ID */
name|pInquiry
index|[
literal|11
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|namingAuthority1
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|12
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit16_31
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
name|pInquiry
index|[
literal|13
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit16_31
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
name|pInquiry
index|[
literal|14
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit0_15
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
name|pInquiry
index|[
literal|15
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|uniqueID_bit0_15
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* Vendor Specific ID  */
name|pInquiry
index|[
literal|16
index|]
operator|=
literal|0x61
expr_stmt|;
comment|/* Code set: binary codes; this is proto_codeset in FreeBSD; SCSI_PROTO_SAS and SVPD_ID_CODESET_BINARY */
name|pInquiry
index|[
literal|17
index|]
operator|=
literal|0x93
expr_stmt|;
comment|/* Identifier type : NAA ; this is  id_type in FreeBSD; PIV set, ASSOCIATION is 01b and NAA (3h)   */
name|pInquiry
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved               */
name|pInquiry
index|[
literal|19
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* Identifier length      */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryPage83: sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryPage83: sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* SAS address of SATA */
name|pInquiry
index|[
literal|20
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressHi
operator|)
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
expr_stmt|;
name|pInquiry
index|[
literal|21
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressHi
operator|)
operator|&
literal|0xFF0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|pInquiry
index|[
literal|22
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressHi
operator|)
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
expr_stmt|;
name|pInquiry
index|[
literal|23
index|]
operator|=
operator|(
name|oneDeviceData
operator|->
name|sasAddressHi
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pInquiry
index|[
literal|24
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressLo
operator|)
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
expr_stmt|;
name|pInquiry
index|[
literal|25
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressLo
operator|)
operator|&
literal|0xFF0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|pInquiry
index|[
literal|26
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressLo
operator|)
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
expr_stmt|;
name|pInquiry
index|[
literal|27
index|]
operator|=
operator|(
name|oneDeviceData
operator|->
name|sasAddressLo
operator|)
operator|&
literal|0xFF
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
ifndef|#
directive|ifndef
name|PMC_FREEBSD
comment|/* Fill in SAT Rev8 Table86 */
comment|/*      * Logical unit name derived from the model number and serial number.      */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|72
expr_stmt|;
comment|/* 75 - 3; page length */
comment|/*      * Identifier descriptor      */
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Code set: ASCII codes */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Identifier type : T10 vendor ID based */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x44
expr_stmt|;
comment|/* 0x44, 68 Identifier length */
comment|/* Byte 8 to 15 is the vendor id string 'ATA     '. */
name|sm_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|8
index|]
argument_list|,
name|AG_SAT_VENDOR_ID_STRING
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/*      * Byte 16 to 75 is vendor specific id      */
name|pInquiry
index|[
literal|16
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|27
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|17
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|27
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|18
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|28
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|19
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|28
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|20
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|29
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|21
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|29
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|22
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|30
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|23
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|30
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|24
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|31
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|25
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|31
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|26
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|32
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|27
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|32
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|28
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|33
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|29
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|33
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|30
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|34
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|31
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|34
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|32
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|35
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|35
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|36
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|36
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|36
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|37
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|37
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|37
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|38
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|38
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|39
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|38
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|40
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|39
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|41
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|39
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|42
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|40
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|43
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|40
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|44
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|41
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|45
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|41
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|46
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|42
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|47
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|42
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|48
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|43
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|49
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|43
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|50
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|44
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|51
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|44
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|52
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|45
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|53
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|45
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|54
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|46
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|55
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|46
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|56
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|10
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|57
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|10
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|58
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|11
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|59
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|11
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|60
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|12
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|61
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|12
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|62
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|13
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|63
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|13
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|64
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|14
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|65
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|14
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|66
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|15
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|67
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|15
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|68
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|16
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|69
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|16
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|70
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|17
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|71
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|17
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|72
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|18
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|73
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|18
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|74
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|19
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|75
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|19
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* for the FreeBSD */
comment|/* Fill in SAT Rev8 Table86 */
comment|/*      * Logical unit name derived from the model number and serial number.      */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|84
expr_stmt|;
comment|/* 87 - 3; page length */
comment|/*      * Identifier descriptor      */
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Code set: ASCII codes */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Identifier type : T10 vendor ID based */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x44
expr_stmt|;
comment|/* 0x44, 68 Identifier length */
comment|/* Byte 8 to 15 is the vendor id string 'ATA     '. */
name|sm_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|8
index|]
argument_list|,
name|AG_SAT_VENDOR_ID_STRING
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/*      * Byte 16 to 75 is vendor specific id      */
name|pInquiry
index|[
literal|16
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|27
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|17
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|27
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|18
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|28
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|19
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|28
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|20
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|29
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|21
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|29
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|22
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|30
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|23
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|30
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|24
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|31
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|25
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|31
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|26
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|32
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|27
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|32
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|28
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|33
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|29
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|33
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|30
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|34
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|31
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|34
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|32
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|35
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|33
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|35
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|34
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|36
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|35
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|36
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|36
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|37
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|37
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|37
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|38
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|38
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|39
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|38
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|40
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|39
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|41
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|39
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|42
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|40
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|43
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|40
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|44
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|41
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|45
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|41
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|46
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|42
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|47
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|42
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|48
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|43
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|49
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|43
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|50
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|44
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|51
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|44
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|52
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|45
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|53
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|45
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|54
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|46
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|55
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|46
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|56
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|10
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|57
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|10
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|58
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|11
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|59
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|11
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|60
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|12
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|61
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|12
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|62
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|13
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|63
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|13
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|64
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|14
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|65
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|14
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|66
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|15
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|67
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|15
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|68
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|16
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|69
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|16
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|70
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|17
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|71
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|17
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|72
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|18
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|73
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|18
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|74
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|19
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|75
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|19
index|]
operator|)
operator|&
literal|0x00ff
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|76
index|]
operator|=
literal|0x61
expr_stmt|;
comment|/* Code set: binary codes; this is proto_codeset in FreeBSD; SCSI_PROTO_SAS and SVPD_ID_CODESET_BINARY */
name|pInquiry
index|[
literal|77
index|]
operator|=
literal|0x93
expr_stmt|;
comment|/* Identifier type : NAA ; this is  id_type in FreeBSD; PIV set, ASSOCIATION is 01b and NAA (3h)   */
name|pInquiry
index|[
literal|78
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved               */
name|pInquiry
index|[
literal|79
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* Identifier length      */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryPage83: NO WWN sasAddressHi 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|sasAddressHi
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryPage83: No WWN sasAddressLo 0x%08x\n"
operator|,
name|oneDeviceData
operator|->
name|sasAddressLo
operator|)
argument_list|)
expr_stmt|;
comment|/* SAS address of SATA */
name|pInquiry
index|[
literal|80
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressHi
operator|)
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
expr_stmt|;
name|pInquiry
index|[
literal|81
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressHi
operator|)
operator|&
literal|0xFF0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|pInquiry
index|[
literal|82
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressHi
operator|)
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
expr_stmt|;
name|pInquiry
index|[
literal|83
index|]
operator|=
operator|(
name|oneDeviceData
operator|->
name|sasAddressHi
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|pInquiry
index|[
literal|84
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressLo
operator|)
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
expr_stmt|;
name|pInquiry
index|[
literal|85
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressLo
operator|)
operator|&
literal|0xFF0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|pInquiry
index|[
literal|86
index|]
operator|=
operator|(
operator|(
name|oneDeviceData
operator|->
name|sasAddressLo
operator|)
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
expr_stmt|;
name|pInquiry
index|[
literal|87
index|]
operator|=
operator|(
name|oneDeviceData
operator|->
name|sasAddressLo
operator|)
operator|&
literal|0xFF
expr_stmt|;
endif|#
directive|endif
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatInquiryPage89
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|,
name|smDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
name|bit32
name|len
parameter_list|)
block|{
comment|/*     SAT revision 8, 10.3.5, p 83    */
name|satSimpleSATAIdentifyData_t
modifier|*
name|pSimpleData
decl_stmt|;
comment|/*    * When translating the fields, in some cases using the simple form of SATA    * Identify Device Data is easier. So we define it here.    * Both pSimpleData and pSATAIdData points to the same data.    */
name|pSimpleData
operator|=
operator|(
name|satSimpleSATAIdentifyData_t
operator|*
operator|)
name|pSATAIdData
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryPage89: start\n"
operator|)
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Peripheral Qualifier and Peripheral Device Type */
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x89
expr_stmt|;
comment|/* page code */
comment|/* Page length 0x238 */
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0x02
expr_stmt|;
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|0x38
expr_stmt|;
name|pInquiry
index|[
literal|4
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|5
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|7
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* reserved */
comment|/* SAT Vendor Identification */
name|sm_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|8
index|]
argument_list|,
literal|"PMC-SIERRA"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* 8 bytes   */
comment|/* SAT Product Idetification */
name|sm_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|16
index|]
argument_list|,
literal|"Tachyon-SPC    "
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* 16 bytes   */
comment|/* SAT Product Revision Level */
name|sm_strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pInquiry
index|[
literal|32
index|]
argument_list|,
literal|"01"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* 4 bytes   */
comment|/* Signature, SAT revision8, Table88, p85 */
name|pInquiry
index|[
literal|36
index|]
operator|=
literal|0x34
expr_stmt|;
comment|/* FIS type */
if|if
condition|(
name|oneDeviceData
operator|->
name|satDeviceType
operator|==
name|SATA_ATA_DEVICE
condition|)
block|{
comment|/* interrupt assume to be 0 */
name|pInquiry
index|[
literal|37
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|oneDeviceData
operator|->
name|satPMField
operator|)
operator|>>
operator|(
literal|4
operator|*
literal|7
operator|)
argument_list|)
expr_stmt|;
comment|/* first four bits of PM field */
block|}
else|else
block|{
comment|/* interrupt assume to be 1 */
name|pInquiry
index|[
literal|37
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
literal|0x40
operator|+
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|oneDeviceData
operator|->
name|satPMField
operator|)
operator|>>
operator|(
literal|4
operator|*
literal|7
operator|)
operator|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* first four bits of PM field */
block|}
name|pInquiry
index|[
literal|38
index|]
operator|=
literal|0
expr_stmt|;
name|pInquiry
index|[
literal|39
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|satDeviceType
operator|==
name|SATA_ATA_DEVICE
condition|)
block|{
name|pInquiry
index|[
literal|40
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* LBA Low          */
name|pInquiry
index|[
literal|41
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Mid          */
name|pInquiry
index|[
literal|42
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA High         */
name|pInquiry
index|[
literal|43
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Device           */
name|pInquiry
index|[
literal|44
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Low Exp      */
name|pInquiry
index|[
literal|45
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Mid Exp      */
name|pInquiry
index|[
literal|46
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA High Exp     */
name|pInquiry
index|[
literal|47
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved         */
name|pInquiry
index|[
literal|48
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Sector Count     */
name|pInquiry
index|[
literal|49
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Sector Count Exp */
block|}
else|else
block|{
name|pInquiry
index|[
literal|40
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* LBA Low          */
name|pInquiry
index|[
literal|41
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Mid          */
name|pInquiry
index|[
literal|42
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA High         */
name|pInquiry
index|[
literal|43
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Device           */
name|pInquiry
index|[
literal|44
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Low Exp      */
name|pInquiry
index|[
literal|45
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA Mid Exp      */
name|pInquiry
index|[
literal|46
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LBA High Exp     */
name|pInquiry
index|[
literal|47
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Reserved         */
name|pInquiry
index|[
literal|48
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Sector Count     */
name|pInquiry
index|[
literal|49
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Sector Count Exp */
block|}
comment|/* Reserved */
name|pInquiry
index|[
literal|50
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|51
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|52
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|53
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|54
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|55
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Command Code */
if|if
condition|(
name|oneDeviceData
operator|->
name|satDeviceType
operator|==
name|SATA_ATA_DEVICE
condition|)
block|{
name|pInquiry
index|[
literal|56
index|]
operator|=
literal|0xEC
expr_stmt|;
comment|/* IDENTIFY DEVICE */
block|}
else|else
block|{
name|pInquiry
index|[
literal|56
index|]
operator|=
literal|0xA1
expr_stmt|;
comment|/* IDENTIFY PACKET DEVICE */
block|}
comment|/* Reserved */
name|pInquiry
index|[
literal|57
index|]
operator|=
literal|0x0
expr_stmt|;
name|pInquiry
index|[
literal|58
index|]
operator|=
literal|0x0
expr_stmt|;
name|pInquiry
index|[
literal|59
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* check the length; len is assumed to be at least 60  */
if|if
condition|(
name|len
operator|<
name|SATA_PAGE89_INQUIRY_SIZE
condition|)
block|{
comment|/* Identify Device */
name|sm_memcpy
argument_list|(
operator|&
name|pInquiry
index|[
literal|60
index|]
argument_list|,
name|pSimpleData
argument_list|,
name|MIN
argument_list|(
operator|(
name|len
operator|-
literal|60
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|satSimpleSATAIdentifyData_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Identify Device */
name|sm_memcpy
argument_list|(
operator|&
name|pInquiry
index|[
literal|60
index|]
argument_list|,
name|pSimpleData
argument_list|,
sizeof|sizeof
argument_list|(
name|satSimpleSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatInquiryPage80
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryPage89: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     See SPC-4, 7.6.9, p 345     and SAT revision 8, 10.3.3, p 77    */
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0x80
expr_stmt|;
comment|/* page code */
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|0x14
expr_stmt|;
comment|/* page length */
comment|/* product serial number */
name|pInquiry
index|[
literal|4
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|1
index|]
expr_stmt|;
name|pInquiry
index|[
literal|5
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|0
index|]
expr_stmt|;
name|pInquiry
index|[
literal|6
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|3
index|]
expr_stmt|;
name|pInquiry
index|[
literal|7
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|2
index|]
expr_stmt|;
name|pInquiry
index|[
literal|8
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|5
index|]
expr_stmt|;
name|pInquiry
index|[
literal|9
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|4
index|]
expr_stmt|;
name|pInquiry
index|[
literal|10
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|7
index|]
expr_stmt|;
name|pInquiry
index|[
literal|11
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|6
index|]
expr_stmt|;
name|pInquiry
index|[
literal|12
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|9
index|]
expr_stmt|;
name|pInquiry
index|[
literal|13
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|8
index|]
expr_stmt|;
name|pInquiry
index|[
literal|14
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|11
index|]
expr_stmt|;
name|pInquiry
index|[
literal|15
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|10
index|]
expr_stmt|;
name|pInquiry
index|[
literal|16
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|13
index|]
expr_stmt|;
name|pInquiry
index|[
literal|17
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|12
index|]
expr_stmt|;
name|pInquiry
index|[
literal|18
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|15
index|]
expr_stmt|;
name|pInquiry
index|[
literal|19
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|14
index|]
expr_stmt|;
name|pInquiry
index|[
literal|20
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|17
index|]
expr_stmt|;
name|pInquiry
index|[
literal|21
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|16
index|]
expr_stmt|;
name|pInquiry
index|[
literal|22
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|19
index|]
expr_stmt|;
name|pInquiry
index|[
literal|23
index|]
operator|=
name|pSATAIdData
operator|->
name|serialNumber
index|[
literal|18
index|]
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatInquiryPageB1
parameter_list|(
name|bit8
modifier|*
name|pInquiry
parameter_list|,
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
parameter_list|)
block|{
name|bit32
name|i
decl_stmt|;
name|satSimpleSATAIdentifyData_t
modifier|*
name|pSimpleData
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryPageB1: start\n"
operator|)
argument_list|)
expr_stmt|;
name|pSimpleData
operator|=
operator|(
name|satSimpleSATAIdentifyData_t
operator|*
operator|)
name|pSATAIdData
expr_stmt|;
comment|/*     See SBC-3, revision31, Table193, p273     and SAT-3 revision 3, 10.3.6, p141    */
name|pInquiry
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Peripheral Qualifier and Peripheral Device Type */
name|pInquiry
index|[
literal|1
index|]
operator|=
literal|0xB1
expr_stmt|;
comment|/* page code */
comment|/* page length */
name|pInquiry
index|[
literal|2
index|]
operator|=
literal|0x0
expr_stmt|;
name|pInquiry
index|[
literal|3
index|]
operator|=
literal|0x3C
expr_stmt|;
comment|/* medium rotation rate */
name|pInquiry
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|217
index|]
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|pInquiry
index|[
literal|5
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|217
index|]
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* reserved */
name|pInquiry
index|[
literal|6
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* nominal form factor bits 3:0 */
name|pInquiry
index|[
literal|7
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSimpleData
operator|->
name|word
index|[
literal|168
index|]
operator|)
operator|&
literal|0xF
argument_list|)
expr_stmt|;
comment|/* reserved */
for|for
control|(
name|i
operator|=
literal|8
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|pInquiry
index|[
name|i
index|]
operator|=
literal|0x0
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatDefaultTranslation
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|smScsiRspSense_t
modifier|*
name|pSense
parameter_list|,
name|bit8
name|ataStatus
parameter_list|,
name|bit8
name|ataError
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatDefaultTranslation: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Check for device fault case    */
if|if
condition|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INTERNAL_TARGET_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*    * If status error bit it set, need to check the error register    */
if|if
condition|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
condition|)
block|{
if|if
condition|(
name|ataError
operator|&
name|NM_ATA_ERROR_MASK
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDefaultTranslation: NM_ATA_ERROR ataError= 0x%x, smIORequest=%p!!!\n"
operator|,
name|ataError
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|UNC_ATA_ERROR_MASK
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDefaultTranslation: UNC_ATA_ERROR ataError= 0x%x, smIORequest=%p!!!\n"
operator|,
name|ataError
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_MEDIUM_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_UNRECOVERED_READ_ERROR
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|IDNF_ATA_ERROR_MASK
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDefaultTranslation: IDNF_ATA_ERROR ataError= 0x%x, smIORequest=%p!!!\n"
operator|,
name|ataError
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_MEDIUM_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_RECORD_NOT_FOUND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|MC_ATA_ERROR_MASK
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDefaultTranslation: MC_ATA_ERROR ataError= 0x%x, smIORequest=%p!!!\n"
operator|,
name|ataError
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_UNIT_ATTENTION
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NOT_READY_TO_READY_CHANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|MCR_ATA_ERROR_MASK
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDefaultTranslation: MCR_ATA_ERROR ataError= 0x%x, smIORequest=%p!!!\n"
operator|,
name|ataError
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_UNIT_ATTENTION
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_OPERATOR_MEDIUM_REMOVAL_REQUEST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|ICRC_ATA_ERROR_MASK
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDefaultTranslation: ICRC_ATA_ERROR ataError= 0x%x, smIORequest=%p!!!\n"
operator|,
name|ataError
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INFORMATION_UNIT_CRC_ERROR
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ataError
operator|&
name|ABRT_ATA_ERROR_MASK
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDefaultTranslation: ABRT_ATA_ERROR ataError= 0x%x, smIORequest=%p!!!\n"
operator|,
name|ataError
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDefaultTranslation: **** UNEXPECTED ATA_ERROR **** ataError= 0x%x, smIORequest=%p!!!\n"
operator|,
name|ataError
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INTERNAL_TARGET_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
comment|/* Send the completion response now */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
comment|/*  (ataStatus& ERR_ATA_STATUS_MASK ) is false */
block|{
comment|/* This case should never happen */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDefaultTranslation: *** UNEXPECTED ATA status 0x%x *** smIORequest=%p!!!\n"
operator|,
name|ataStatus
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INTERNAL_TARGET_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smIDStart
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|)
block|{
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smIDStart: start, smIORequest %p\n"
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIDStart: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIDStart: oneDeviceData is not valid, did %d !!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|smIORequest
operator|->
name|smData
expr_stmt|;
comment|//smDequeueIO(smRoot);
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIDStart: smIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|smIOReInit
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smIDStart: io ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|smIORequest
operator|=
name|smIORequest
expr_stmt|;
name|smIORequestBody
operator|->
name|smDevHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
comment|/* setting up satIOContext */
name|satIOContext
operator|->
name|pSatDevData
operator|=
name|oneDeviceData
expr_stmt|;
name|satIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|smRequestBody
operator|=
name|smIORequestBody
expr_stmt|;
name|satIOContext
operator|->
name|psmDeviceHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext
operator|->
name|smScsiXchg
operator|=
name|agNULL
expr_stmt|;
comment|/*smIORequest->smData = smIORequestBody;*/
name|SM_DBG3
argument_list|(
operator|(
literal|"smIDStart: smIORequestBody %p smIORequestBody->smIORequest %p!!!\n"
operator|,
name|smIORequestBody
operator|,
name|smIORequestBody
operator|->
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smIDStart: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatIDSubStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smIDStart: smsatIDSubStart failure %d!!!\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smIDStart: exit\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*   SM generated IO, needs to call smsatAllocIntIoResource()   allocating using smsatAllocIntIoResource */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatIDSubStart
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smSCSIRequest
parameter_list|,
comment|/* agNULL */
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smSatInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|satDevData
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDSubStart: start\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|/* allocate identify device command */
name|satIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|satDevData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|,
comment|/* 512; size of identify device data */
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDSubStart: can't alloacate!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|satIOContext
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
comment|/* fill in fields */
comment|/* real ttttttthe one worked and the same; 5/21/07/ */
name|satIntIo
operator|->
name|satOrgSmIORequest
operator|=
name|smIORequest
expr_stmt|;
comment|/* changed */
name|smIORequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSatDevData
operator|=
name|satDevData
expr_stmt|;
name|satNewIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSense
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSmSenseData
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|smRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
comment|/* key fix */
comment|//  satNewIOContext->interruptContext = tiInterruptContext;
name|satNewIOContext
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satNewIOContext
operator|->
name|psmDeviceHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satNewIOContext
operator|->
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
comment|/* changed */
comment|/* this is valid only for TD layer generated (not triggered by OS at all) IO */
name|satNewIOContext
operator|->
name|smScsiXchg
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatIDSubStart: SM satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatIDSubStart: SM satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatIDSubStart: SM tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatIDSubStart: SM tiScsiXchg %p \n"
operator|,
name|satNewIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatIDSubStart: satNewIOContext %p smIORequestBody %p\n"
operator|,
name|satNewIOContext
operator|,
name|smIORequestBody
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatIDStart
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntSmIORequest
argument_list|,
comment|/* New smIORequest */
name|smDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|smScsiXchg
argument_list|,
comment|/* New smScsiInitiatorRequest_t *smScsiRequest, */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDSubStart: failed in sending %d!!!\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDSubStart: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatIDStart
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smSCSIRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
ifdef|#
directive|ifdef
name|SM_INTERNAL_DEBUG
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIoContext
decl_stmt|;
endif|#
directive|endif
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStart: start\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SM_INTERNAL_DEBUG
name|satIntIoContext
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|smIORequestBody
operator|=
name|satIntIoContext
operator|->
name|satIntRequestBody
expr_stmt|;
endif|#
directive|endif
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStart: IDENTIFY_PACKET_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_IDENTIFY_PACKET_DEVICE
expr_stmt|;
comment|/* 0x40 */
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStart: IDENTIFY_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_IDENTIFY_DEVICE
expr_stmt|;
comment|/* 0xEC */
block|}
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatIDStartCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
ifdef|#
directive|ifdef
name|SM_INTERNAL_DEBUG
name|smhexdump
argument_list|(
literal|"smsatIDStart"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|satIOContext
operator|->
name|pFis
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
name|smhexdump
argument_list|(
literal|"smsatIDStart LL"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStart: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|bit32
name|smsatIOStart
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smSCSIRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smDeviceData_t
modifier|*
name|pSatDevData
init|=
name|satIOContext
operator|->
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
init|=
name|satIOContext
operator|->
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
init|=
operator|&
name|smSCSIRequest
operator|->
name|scsiCmnd
decl_stmt|;
name|smLUN_t
modifier|*
name|pLun
init|=
operator|&
name|scsiCmnd
operator|->
name|lun
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|pSatIntIo
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIOStart: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Reject all other LUN other than LUN 0.    */
if|if
condition|(
operator|(
operator|(
name|pLun
operator|->
name|lun
index|[
literal|0
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|1
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|2
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|3
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|4
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|5
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|6
index|]
operator||
name|pLun
operator|->
name|lun
index|[
literal|7
index|]
operator|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|!=
name|SCSIOPC_INQUIRY
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOStart: *** REJECT *** LUN not zero, cdb[0]=0x%x did %d !!!\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_NOT_SUPPORTED
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIOStart: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
comment|/* this may happen after tiCOMReset until OS sends inquiry */
if|if
condition|(
name|pSatDevData
operator|->
name|IDDeviceValid
operator|==
name|agFALSE
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|!=
name|SCSIOPC_INQUIRY
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOStart: invalid identify device data did %d !!!\n"
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOStart: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOStart: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
return|return
name|SM_RC_NODEVICE
return|;
block|}
comment|/*    * Check if we need to return BUSY, i.e. recovery in progress    */
if|if
condition|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOStart: IN RECOVERY STATE cdb[0]=0x%x did=%d !!!\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIOStart: device %p satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIOStart: device %p satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
comment|//    return  SM_RC_FAILURE;
return|return
name|SM_RC_DEVICE_BUSY
return|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|==
name|SCSIOPC_REPORT_LUN
condition|)
block|{
return|return
name|smsatReportLun
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|smsatPacket
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
return|;
block|}
block|}
else|else
block|{
comment|/* Parse CDB */
switch|switch
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
condition|)
block|{
case|case
name|SCSIOPC_READ_10
case|:
name|status
operator|=
name|smsatRead10
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_10
case|:
name|status
operator|=
name|smsatWrite10
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_6
case|:
name|status
operator|=
name|smsatRead6
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_12
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_READ_12\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatRead12
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_16
case|:
name|status
operator|=
name|smsatRead16
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_6
case|:
name|status
operator|=
name|smsatWrite6
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_12
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_WRITE_12 \n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatWrite12
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_16
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_WRITE_16 \n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatWrite16
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_VERIFY_10
case|:
name|status
operator|=
name|smsatVerify10
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_VERIFY_12
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_VERIFY_12\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatVerify12
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_VERIFY_16
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_VERIFY_16\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatVerify16
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_TEST_UNIT_READY
case|:
name|status
operator|=
name|smsatTestUnitReady
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_INQUIRY
case|:
name|status
operator|=
name|smsatInquiry
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_REQUEST_SENSE
case|:
name|status
operator|=
name|smsatRequestSense
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_MODE_SENSE_6
case|:
name|status
operator|=
name|smsatModeSense6
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_MODE_SENSE_10
case|:
name|status
operator|=
name|smsatModeSense10
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_CAPACITY_10
case|:
name|status
operator|=
name|smsatReadCapacity10
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_CAPACITY_16
case|:
name|status
operator|=
name|smsatReadCapacity16
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_REPORT_LUN
case|:
name|status
operator|=
name|smsatReportLun
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_FORMAT_UNIT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_FORMAT_UNIT\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatFormatUnit
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_SEND_DIAGNOSTIC
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_SEND_DIAGNOSTIC\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatSendDiagnostic
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_START_STOP_UNIT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_START_STOP_UNIT\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatStartStopUnit
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_SAME_10
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_WRITE_SAME_10\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatWriteSame10
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_SAME_16
case|:
comment|/* no support due to transfer length(sector count) */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_WRITE_SAME_16\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatWriteSame16
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_LOG_SENSE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_LOG_SENSE\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatLogSense
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_MODE_SELECT_6
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_MODE_SELECT_6\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatModeSelect6
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_MODE_SELECT_10
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_MODE_SELECT_10\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatModeSelect10
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_SYNCHRONIZE_CACHE_10
case|:
comment|/* on error what to return, sharing CB with                                            satSynchronizeCache16 */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_SYNCHRONIZE_CACHE_10\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatSynchronizeCache10
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_SYNCHRONIZE_CACHE_16
case|:
comment|/* on error what to return, sharing CB with                                             satSynchronizeCache16 */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_SYNCHRONIZE_CACHE_16\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatSynchronizeCache16
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_AND_VERIFY_10
case|:
comment|/* single write and multiple writes */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_WRITE_AND_VERIFY_10\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatWriteAndVerify10
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_AND_VERIFY_12
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_WRITE_AND_VERIFY_12\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatWriteAndVerify12
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_AND_VERIFY_16
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_WRITE_AND_VERIFY_16\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatWriteAndVerify16
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_MEDIA_SERIAL_NUMBER
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_READ_MEDIA_SERIAL_NUMBER\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatReadMediaSerialNumber
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_READ_BUFFER
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_READ_BUFFER\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatReadBuffer
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_BUFFER
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_WRITE_BUFFER\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatWriteBuffer
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_REASSIGN_BLOCKS
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_REASSIGN_BLOCKS\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatReassignBlocks
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_ATA_PASS_THROUGH12
case|:
comment|/* fall through */
case|case
name|SCSIOPC_ATA_PASS_THROUGH16
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOStart: SCSIOPC_ATA_PASS_THROUGH\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatPassthrough
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smSCSIRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Not implemented SCSI cmd, set up error response */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOStart: unsupported SCSI cdb[0]=0x%x did=%d !!!\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|status
operator|=
name|SM_RC_SUCCESS
expr_stmt|;
break|break;
block|}
comment|/* end switch  */
block|}
if|if
condition|(
name|status
operator|==
name|SM_RC_BUSY
operator|||
name|status
operator|==
name|SM_RC_DEVICE_BUSY
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOStart: BUSY did %d!!!\n"
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIOStart: LL is busy or target queue is full\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIOStart: device %p satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingIO
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIOStart: device %p satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|pSatDevData
operator|,
name|pSatDevData
operator|->
name|satPendingNCQIO
operator|,
name|pSatDevData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|pSatIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|pSatDevData
argument_list|,
name|pSatIntIo
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSetSensePayload
parameter_list|(
name|smScsiRspSense_t
modifier|*
name|pSense
parameter_list|,
name|bit8
name|SnsKey
parameter_list|,
name|bit32
name|SnsInfo
parameter_list|,
name|bit16
name|SnsCode
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/* for fixed format sense data, SPC-4, p37 */
name|bit32
name|i
decl_stmt|;
name|bit32
name|senseLength
decl_stmt|;
name|bit8
name|tmp
init|=
literal|0
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetSensePayload: start\n"
operator|)
argument_list|)
expr_stmt|;
name|senseLength
operator|=
sizeof|sizeof
argument_list|(
name|smScsiRspSense_t
argument_list|)
expr_stmt|;
comment|/* zero out the data area */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|senseLength
condition|;
name|i
operator|++
control|)
block|{
operator|(
operator|(
name|bit8
operator|*
operator|)
name|pSense
operator|)
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/*    * SCSI Sense Data part of response data    */
name|pSense
operator|->
name|snsRespCode
operator|=
literal|0x70
expr_stmt|;
comment|/*  0xC0 == vendor specific */
comment|/*  0x70 == standard current error */
name|pSense
operator|->
name|senseKey
operator|=
name|SnsKey
expr_stmt|;
comment|/*    * Put sense info in scsi order format    */
name|pSense
operator|->
name|info
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|info
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|info
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|info
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsInfo
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|addSenseLen
operator|=
literal|11
expr_stmt|;
comment|/* fixed size of sense data = 18 */
name|pSense
operator|->
name|addSenseCode
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|SnsCode
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|senseQual
operator|=
call|(
name|bit8
call|)
argument_list|(
name|SnsCode
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/*    * Set pointer in scsi status    */
switch|switch
condition|(
name|SnsKey
condition|)
block|{
comment|/*      * set illegal request sense key specific error in cdb, no bit pointer      */
case|case
name|SCSI_SNSKEY_ILLEGAL_REQUEST
case|:
name|pSense
operator|->
name|skeySpecific
index|[
literal|0
index|]
operator|=
literal|0xC8
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* setting sense data length */
if|if
condition|(
name|satIOContext
operator|!=
name|agNULL
condition|)
block|{
name|satIOContext
operator|->
name|pSmSenseData
operator|->
name|senseLen
operator|=
literal|18
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetSensePayload: satIOContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Only for SCSI_SNSCODE_ATA_PASS_THROUGH_INFORMATION_AVAILABLE */
if|if
condition|(
name|SnsCode
operator|==
name|SCSI_SNSCODE_ATA_PASS_THROUGH_INFORMATION_AVAILABLE
condition|)
block|{
comment|/* filling in COMMAND-SPECIFIC INFORMATION */
name|tmp
operator|=
name|satIOContext
operator|->
name|extend
operator|<<
literal|7
operator||
name|satIOContext
operator|->
name|Sector_Cnt_Upper_Nonzero
operator|<<
literal|6
operator||
name|satIOContext
operator|->
name|LBA_Upper_Nonzero
operator|<<
literal|5
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetSensePayload: extend 0x%x Sector_Cnt_Upper_Nonzero 0x%x LBA_Upper_Nonzero 0x%x\n"
operator|,
name|satIOContext
operator|->
name|extend
operator|,
name|satIOContext
operator|->
name|Sector_Cnt_Upper_Nonzero
operator|,
name|satIOContext
operator|->
name|LBA_Upper_Nonzero
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSetSensePayload: tmp 0x%x\n"
operator|,
name|tmp
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|->
name|cmdSpecific
index|[
literal|0
index|]
operator|=
name|tmp
expr_stmt|;
name|pSense
operator|->
name|cmdSpecific
index|[
literal|1
index|]
operator|=
name|satIOContext
operator|->
name|LBAHigh07
expr_stmt|;
name|pSense
operator|->
name|cmdSpecific
index|[
literal|2
index|]
operator|=
name|satIOContext
operator|->
name|LBAMid07
expr_stmt|;
name|pSense
operator|->
name|cmdSpecific
index|[
literal|3
index|]
operator|=
name|satIOContext
operator|->
name|LBALow07
expr_stmt|;
comment|//    smhexdump("smsatSetSensePayload: cmdSpecific",(bit8 *)pSense->cmdSpecific, 4);
comment|//    smhexdump("smsatSetSensePayload: info",(bit8 *)pSense->info, 4);
block|}
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  smsatDecodeSATADeviceType * *   This routine decodes ATA signature * *  \param   pSignature:       ATA signature * * *  \return: *          TRUE if ATA signature *          FALSE otherwise * *****************************************************************************/
end_comment

begin_comment
comment|/*   ATA p65   PM p65   SATAII p79, p80  */
end_comment

begin_function
name|GLOBAL
name|bit32
name|smsatDecodeSATADeviceType
parameter_list|(
name|bit8
modifier|*
name|pSignature
parameter_list|)
block|{
name|bit32
name|deviceType
init|=
name|UNKNOWN_DEVICE
decl_stmt|;
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0x00
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0x00
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0xA0
condition|)
comment|/* this is the signature of a Hitachi SATA HDD*/
block|{
name|deviceType
operator|=
name|SATA_ATA_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0x00
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0x00
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0x00
condition|)
block|{
name|deviceType
operator|=
name|SATA_ATA_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0x14
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0xEB
operator|&&
operator|(
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0x00
operator|||
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0x10
operator|)
condition|)
block|{
name|deviceType
operator|=
name|SATA_ATAPI_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0x69
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0x96
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0x00
condition|)
block|{
name|deviceType
operator|=
name|SATA_PM_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0x01
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0x3C
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0xC3
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0x00
condition|)
block|{
name|deviceType
operator|=
name|SATA_SEMB_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pSignature
operator|)
index|[
literal|0
index|]
operator|==
literal|0xFF
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|1
index|]
operator|==
literal|0xFF
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|2
index|]
operator|==
literal|0xFF
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|3
index|]
operator|==
literal|0xFF
operator|&&
operator|(
name|pSignature
operator|)
index|[
literal|4
index|]
operator|==
literal|0xFF
condition|)
block|{
name|deviceType
operator|=
name|SATA_SEMB_WO_SEP_DEVICE
expr_stmt|;
block|}
return|return
name|deviceType
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for ATAPI Packet Command.  *  *  SAT implementation for ATAPI Packet and send FIS request to LL layer.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   smSatIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e smIOSuccess:     I/O request successfully initiated.  *    - \e smIOBusy:        No resources available, try again later.  *    - \e smIONoDevice:  Invalid device handle.  *    - \e smIOError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatPacket
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_D2H_PKT
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatPacket: start, SCSI CDB is 0x%X %X %X %X %X %X %X %X %X %X %X %X\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set 1*/
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_PACKET
expr_stmt|;
comment|/* 0xA0 */
if|if
condition|(
name|pSatDevData
operator|->
name|satDMADIRSupport
condition|)
comment|/* DMADIR enabled*/
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
operator|(
name|smScsiRequest
operator|->
name|dataDirection
operator|==
name|smDirectionIn
operator|)
condition|?
literal|0x04
else|:
literal|0
expr_stmt|;
comment|/* 1 for D2H, 0 for H2D */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/*DMA transfer mode*/
name|fis
operator|->
name|h
operator|.
name|features
operator||=
literal|0x01
expr_stmt|;
block|}
else|else
block|{
comment|/*PIO transfer mode*/
name|fis
operator|->
name|h
operator|.
name|features
operator||=
literal|0x0
expr_stmt|;
block|}
comment|/* Byte count low and byte count high */
if|if
condition|(
name|scsiCmnd
operator|->
name|expDataLength
operator|>
literal|0xFFFF
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS LBA (23:16) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
operator|(
name|bit8
operator|)
name|scsiCmnd
operator|->
name|expDataLength
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|expDataLength
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
block|}
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_PACKET
expr_stmt|;
if|if
condition|(
name|smScsiRequest
operator|->
name|dataDirection
operator|==
name|smDirectionIn
condition|)
block|{
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_D2H_PKT
expr_stmt|;
block|}
else|else
block|{
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_H2D_PKT
expr_stmt|;
block|}
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatPacketCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatPacket: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for smsatSetFeaturePIO.  *  *  This function creates Set Features fis and sends the request to LL layer  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   smSatIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e smIOSuccess:     I/O request successfully initiated.  *    - \e smIOBusy:        No resources available, try again later.  *    - \e smIONoDevice:  Invalid device handle.  *    - \e smIOError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatSetFeaturesPIO
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesPIO: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the Set Features command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x03
expr_stmt|;
comment|/* set transfer mode */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x0C
expr_stmt|;
comment|/*enable PIO transfer mode */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSetFeaturesPIOCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesPIO: return\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* debugging code */
if|if
condition|(
name|smIORequest
operator|->
name|tdData
operator|==
name|smIORequest
operator|->
name|smData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesPIO: incorrect smIORequest\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for SCSI REQUEST SENSE to ATAPI device.  *  *  SAT implementation for SCSI REQUEST SENSE.  *  *  \param   tiRoot:           Pointer to TISA initiator driver/port instance.  *  \param   tiIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   tiDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   tiScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   smSatIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e smIOSuccess:     I/O request successfully initiated.  *    - \e smIOBusy:        No resources available, try again later.  *    - \e smIONoDevice:  Invalid device handle.  *    - \e smIOError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatRequestSenseForATAPI
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_D2H_PKT
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|=
name|SCSIOPC_REQUEST_SENSE
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|=
operator|(
name|bit8
operator|)
name|scsiCmnd
operator|->
name|expDataLength
expr_stmt|;
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatRequestSenseForATAPI: start, SCSI CDB is 0x%X %X %X %X %X %X %X %X %X %X %X %X\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set 1*/
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_PACKET
expr_stmt|;
comment|/* 0xA0 */
if|if
condition|(
name|pSatDevData
operator|->
name|satDMADIRSupport
condition|)
comment|/* DMADIR enabled*/
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
operator|(
name|smScsiRequest
operator|->
name|dataDirection
operator|==
name|smDirectionIn
operator|)
condition|?
literal|0x04
else|:
literal|0
expr_stmt|;
comment|/* 1 for D2H, 0 for H2D */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator||=
literal|0x01
expr_stmt|;
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator||=
literal|0x0
expr_stmt|;
block|}
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
operator|(
name|bit8
operator|)
name|scsiCmnd
operator|->
name|expDataLength
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|expDataLength
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_PACKET
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_D2H_PKT
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatRequestSenseForATAPICB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatRequestSenseForATAPI: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for smsatDeviceReset.  *  *  This function creates DEVICE RESET fis and sends the request to LL layer  *  *  \param   smRoot:           Pointer to TISA initiator driver/port instance.  *  \param   smIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   smDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   smScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   smSatIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e smIOSuccess:     I/O request successfully initiated.  *    - \e smIOBusy:        No resources available, try again later.  *    - \e smIONoDevice:  Invalid device handle.  *    - \e smIOError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatDeviceReset
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatDeviceReset: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the  Execute Device Diagnostic command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_DEVICE_RESET
expr_stmt|;
comment|/* 0x08 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DEV_RESET
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatDeviceResetCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatDeviceReset: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*! \brief SAT implementation for smsatExecuteDeviceDiagnostic.  *  *  This function creates Execute Device Diagnostic fis and sends the request to LL layer  *  *  \param   smRoot:           Pointer to TISA initiator driver/port instance.  *  \param   smIORequest:      Pointer to TISA I/O request context for this I/O.  *  \param   smDeviceHandle:   Pointer to TISA device handle for this I/O.  *  \param   smScsiRequest:    Pointer to TISA SCSI I/O request and SGL list.  *  \param   smSatIOContext_t:   Pointer to the SAT IO Context  *  *  \return If command is started successfully  *    - \e smIOSuccess:     I/O request successfully initiated.  *    - \e smIOBusy:        No resources available, try again later.  *    - \e smIONoDevice:  Invalid device handle.  *    - \e smIOError:       Other errors.  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatExecuteDeviceDiagnostic
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatExecuteDeviceDiagnostic: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the  Execute Device Diagnostic command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_EXECUTE_DEVICE_DIAGNOSTIC
expr_stmt|;
comment|/* 0x90 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatExecuteDeviceDiagnosticCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatExecuteDeviceDiagnostic: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSetDeferredSensePayload
parameter_list|(
name|smScsiRspSense_t
modifier|*
name|pSense
parameter_list|,
name|bit8
name|SnsKey
parameter_list|,
name|bit32
name|SnsInfo
parameter_list|,
name|bit16
name|SnsCode
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetDeferredSensePayload: start\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|GLOBAL
name|bit32
name|smsatRead6
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_READ
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit16
name|tl
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatRead6: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* no FUA checking since read6 */
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead6: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* cbd6; computing LBA and transfer length */
name|lba
operator|=
operator|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
operator|)
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|tl
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead6: return LBA out of range!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
name|lba
operator|+
name|tl
operator|<=
name|SAT_TR_LBA_LIMIT
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* READ DMA*/
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead6: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA
expr_stmt|;
comment|/* 0xC8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* temporary fix */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xff
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* READ SECTORS for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead6: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* temporary fix */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xff
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* READ DMA EXT only */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead6: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
comment|/* 0x25 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* READ SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead6: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
comment|/* sanity check */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead6: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead6: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use READ FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x60 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_READ
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedDataIOCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|bit32
name|smsatRead10
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smDeviceData_t
modifier|*
name|pSatDevData
init|=
name|satIOContext
operator|->
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
init|=
name|satIOContext
operator|->
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
init|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
init|=
name|satIOContext
operator|->
name|pFis
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_READ
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatRead10: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatRead10: pSatDevData did=%d\n"
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|//  smhexdump("smsatRead10", (bit8 *)scsiCmnd->cdb, 10);
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead10: return FUA_NV!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*   sm_memset(LBA, 0, sizeof(LBA));   sm_memset(TL, 0, sizeof(TL));   */
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
comment|/* cbd10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead10: lba %d functioned lba %d\n"
operator|,
name|lba
operator|,
name|smsatComputeCDB10LBA
argument_list|(
name|satIOContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead10: lba 0x%x functioned lba 0x%x\n"
operator|,
name|lba
operator|,
name|smsatComputeCDB10LBA
argument_list|(
name|satIOContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead10: tl %d functioned tl %d\n"
operator|,
name|tl
operator|,
name|smsatComputeCDB10TL
argument_list|(
name|satIOContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead10: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead10: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead10: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatRead10: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use READ FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x60 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
comment|/* case 3 and 4 */
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* READ DMA EXT */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead10: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
comment|/* 0x25 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* READ MULTIPLE EXT or READ SECTOR(S) EXT or READ VERIFY SECTOR(S) EXT*/
comment|/* READ SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead10: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ10_FUA_MASK
condition|)
block|{
comment|/* for now, no support for FUA */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
block|}
block|}
else|else
comment|/* case 1 and 2 */
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* READ DMA*/
comment|/* in case that we can't fit the transfer length, we need to make it fit by sending multiple ATA cmnds */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead10: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA
expr_stmt|;
comment|/* 0xC8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* READ MULTIPLE or READ SECTOR(S) */
comment|/* READ SECTORS for easier implemetation */
comment|/* in case that we can't fit the transfer length, we need to make it fit by sending multiple ATA cmnds */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead10: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
block|}
block|}
comment|//  smhexdump("satRead10 final fis", (bit8 *)fis, sizeof(agsaFisRegHostToDevice_t));
comment|/* saves the current LBA and orginal TL */
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUED */
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead10: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatRead10: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x0
expr_stmt|;
name|smsatSplitSGL
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|,
name|NON_BIT48_ADDRESS_TL_LIMIT
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
comment|/* 0x100 * 0x200 */
operator|(
name|satIOContext
operator|->
name|OrgTL
operator|)
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
name|smsatSplitSGL
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|,
name|BIT48_ADDRESS_TL_LIMIT
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
comment|/* 0xFFFF * 0x200 */
operator|(
name|satIOContext
operator|->
name|OrgTL
operator|)
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
name|smsatSplitSGL
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|,
name|BIT48_ADDRESS_TL_LIMIT
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
comment|/* 0xFFFF * 0x200 */
operator|(
name|satIOContext
operator|->
name|OrgTL
operator|)
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
block|}
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead10: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatRead12
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_READ
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead12: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead12: return FUA_NV!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead12: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|lba
operator|=
name|smsatComputeCDB12LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|smsatComputeCDB12TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead12: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead12: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* READ DMA*/
comment|/* in case that we can't fit the transfer length,          we need to make it fit by sending multiple ATA cmnds */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead12: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA
expr_stmt|;
comment|/* 0xC8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* READ MULTIPLE or READ SECTOR(S) */
comment|/* READ SECTORS for easier implemetation */
comment|/* can't fit the transfer length but need to make it fit by sending multiple*/
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead12: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* READ DMA EXT */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead12: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
comment|/* 0x25 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* READ MULTIPLE EXT or READ SECTOR(S) EXT or READ VERIFY SECTOR(S) EXT*/
comment|/* READ SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead12: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ12_FUA_MASK
condition|)
block|{
comment|/* for now, no support for FUA */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead12: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatRead12: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use READ FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x60 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ12_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
block|}
comment|/* saves the current LBA and orginal TL */
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead12: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead12: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead12: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatRead16
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_READ
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
comment|//  bit32                     limitExtChk = agFALSE; /* lba limit check for bit48 addressing check */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead16: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead16: return FUA_NV!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead16: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* LSB */
name|lba
operator|=
name|smsatComputeCDB16LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|smsatComputeCDB16TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead16: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
comment|//    rangeChk = smsatAddNComparebit64(LBA, TL);
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead16: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* READ DMA*/
comment|/* in case that we can't fit the transfer length,          we need to make it fit by sending multiple ATA cmnds */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead16: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA
expr_stmt|;
comment|/* 0xC8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* READ MULTIPLE or READ SECTOR(S) */
comment|/* READ SECTORS for easier implemetation */
comment|/* can't fit the transfer length but need to make it fit by sending multiple*/
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead16: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* READ DMA EXT */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead16: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
comment|/* 0x25 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* READ MULTIPLE EXT or READ SECTOR(S) EXT or READ VERIFY SECTOR(S) EXT*/
comment|/* READ SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead16: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ16_FUA_MASK
condition|)
block|{
comment|/* for now, no support for FUA */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead16: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatRead16: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use READ FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x60 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ16_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_READ
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
block|}
comment|/* saves the current LBA and orginal TL */
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead16: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead16: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_DMA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_READ_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead16: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWrite6
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit16
name|tl
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite6: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite6: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* cbd6; computing LBA and transfer length */
name|lba
operator|=
operator|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
operator|)
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|tl
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite6: return LBA out of range!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
name|lba
operator|+
name|tl
operator|<=
name|SAT_TR_LBA_LIMIT
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite6: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* temporary fix */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xff
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE SECTORS for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite6: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* temporary fix */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xff
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
block|}
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT only */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite6: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite6: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
comment|/* sanity check */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite6: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite6: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* sector count is 256, 0x100*/
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedDataIOCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|bit32
name|smsatWrite10
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smDeviceData_t
modifier|*
name|pSatDevData
init|=
name|satIOContext
operator|->
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
init|=
name|satIOContext
operator|->
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
init|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
init|=
name|satIOContext
operator|->
name|pFis
decl_stmt|;
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatWrite10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite10: return FUA_NV!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*   sm_memset(LBA, 0, sizeof(LBA));   sm_memset(TL, 0, sizeof(TL)); */
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
comment|/* cbd10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|24
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|16
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: lba %d functioned lba %d\n"
operator|,
name|lba
operator|,
name|smsatComputeCDB10LBA
argument_list|(
name|satIOContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: tl %d functioned tl %d\n"
operator|,
name|tl
operator|,
name|smsatComputeCDB10TL
argument_list|(
name|satIOContext
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite10: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite10: cdb 0x%x 0x%x 0x%x 0x%x!!!\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite10: lba 0x%x SAT_TR_LBA_LIMIT 0x%x!!!\n"
operator|,
name|lba
operator|,
name|SAT_TR_LBA_LIMIT
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite10: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite10: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatWrite10: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
comment|/* case 3 and 4 */
elseif|else
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
else|else
comment|/* case 1 and 2 */
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* can't fit the transfer length */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* can't fit the transfer length */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
block|}
comment|//  smhexdump("satWrite10 final fis", (bit8 *)fis, sizeof(agsaFisRegHostToDevice_t));
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUEDK */
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatWrite10: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x0
expr_stmt|;
name|smsatSplitSGL
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|,
name|NON_BIT48_ADDRESS_TL_LIMIT
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
comment|/* 0x100 * 0x200 */
operator|(
name|satIOContext
operator|->
name|OrgTL
operator|)
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
name|smsatSplitSGL
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|,
name|BIT48_ADDRESS_TL_LIMIT
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
comment|/* 0xFFFF * 0x200 */
operator|(
name|satIOContext
operator|->
name|OrgTL
operator|)
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
name|smsatSplitSGL
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|,
name|BIT48_ADDRESS_TL_LIMIT
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
comment|/* 0xFFFF * 0x200 */
operator|(
name|satIOContext
operator|->
name|OrgTL
operator|)
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWrite12
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite12: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite12: return FUA_NV!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|lba
operator|=
name|smsatComputeCDB12LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|smsatComputeCDB12TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite12: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite12: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* In case that we can't fit the transfer length, we loop */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* In case that we can't fit the transfer length, we loop */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatWrite10: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE12_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite10: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite10: CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWrite16
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite16: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking FUA_NV */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FUA_NV_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite16: return FUA_NV!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite16: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* LSB */
name|lba
operator|=
name|smsatComputeCDB16LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|smsatComputeCDB16TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED   */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite16: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite16: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* In case that we can't fit the transfer length, we loop */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite16: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* In case that we can't fit the transfer length, we loop */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite16: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite16: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite16: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite16: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatWrite16: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE16_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite16: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedDataIOCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite16: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedDataIOCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatVerify10
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     For simple implementation,     no byte comparison supported as of 4/5/06   */
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking BYTCHK */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_VERIFY_BYTCHK_MASK
condition|)
block|{
comment|/*       should do the byte check       but not supported in this version      */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10: no byte checking!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
comment|/* cbd10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10: cdb 0x%x 0x%x 0x%x 0x%x!!!\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10: lba 0x%x SAT_TR_LBA_LIMIT 0x%x!!!\n"
operator|,
name|lba
operator|,
name|SAT_TR_LBA_LIMIT
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify10: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify10: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10: error case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|LoopNum
operator|=
literal|1
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify10: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10: error case 2!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatVerify12
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     For simple implementation,     no byte comparison supported as of 4/5/06   */
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify12: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking BYTCHK */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_VERIFY_BYTCHK_MASK
condition|)
block|{
comment|/*       should do the byte check       but not supported in this version      */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify12: no byte checking!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify12: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|lba
operator|=
name|smsatComputeCDB12LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|smsatComputeCDB12TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify12: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify12: cdb 0x%x 0x%x 0x%x 0x%x!!!\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify12: lba 0x%x SAT_TR_LBA_LIMIT 0x%x!!!\n"
operator|,
name|lba
operator|,
name|SAT_TR_LBA_LIMIT
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify12: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify12: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify12: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify12: error case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|LoopNum
operator|=
literal|1
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify12: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify12: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify12: error case 2!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatVerify16
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     For simple implementation,     no byte comparison supported as of 4/5/06   */
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify16: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking BYTCHK */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_VERIFY_BYTCHK_MASK
condition|)
block|{
comment|/*       should do the byte check       but not supported in this version      */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify16: no byte checking!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify16: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* LSB */
name|lba
operator|=
name|smsatComputeCDB16LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|smsatComputeCDB16TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify16: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify16: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify16: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify16: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify16: error case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|LoopNum
operator|=
literal|1
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify16: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify16: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify16: error case 2!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatTestUnitReady
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatTestUnitReady: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReady: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* SAT revision 8, 8.11.2, p42*/
if|if
condition|(
name|pSatDevData
operator|->
name|satStopState
operator|==
name|agTRUE
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_INITIALIZING_COMMAND_REQUIRED
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReady: stop state!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*    * Check if format is in progress    */
if|if
condition|(
name|pSatDevData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_FORMAT_IN_PROGRESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReady: FORMAT_IN_PROGRESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_FORMAT_IN_PROGRESS
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReady: format in progress!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*     check previously issued ATA command   */
if|if
condition|(
name|pSatDevData
operator|->
name|satPendingIO
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceFaultState
operator|==
name|agTRUE
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReady: previous command ended in error!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/*     check removalbe media feature set    */
if|if
condition|(
name|pSatDevData
operator|->
name|satRemovableMedia
operator|&&
name|pSatDevData
operator|->
name|satRemovableMediaEnabled
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatTestUnitReady: sending get media status cmnd\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* send GET MEDIA STATUS command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_GET_MEDIA_STATUS
expr_stmt|;
comment|/* 0xDA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatTestUnitReadyCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/*     number 6) in SAT p42     send ATA CHECK POWER MODE   */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatTestUnitReady: sending check power mode cmnd\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatTestUnitReady_1
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatTestUnitReady_1
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     sends SAT_CHECK_POWER_MODE as a part of TESTUNITREADY     internally generated - no directly corresponding scsi     called in satIOCompleted as a part of satTestUnitReady(), SAT, revision8, 8.11.2, p42   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatTestUnitReady_1: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the ATA CHECK POWER MODE command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_CHECK_POWER_MODE
expr_stmt|;
comment|/* 0xE5 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatTestUnitReadyCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatTestUnitReady_1: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatInquiry
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     CMDDT bit is obsolete in SPC-3 and this is assumed in SAT revision 8   */
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiry: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiry: pSatDevData did %d\n"
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|//smhexdump("smsatInquiry", (bit8 *)scsiCmnd->cdb, 6);
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiry: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking EVPD and Allocation Length */
comment|/* SPC-4 spec 6.4 p141 */
comment|/* EVPD bit == 0&& PAGE CODE != 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_EVPD_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiry: return EVPD and PAGE CODE!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiry: allocation length 0x%x %d\n"
operator|,
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|)
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|)
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* convert OS IO to TD internal IO */
if|if
condition|(
name|pSatDevData
operator|->
name|IDDeviceValid
operator|==
name|agFALSE
condition|)
block|{
name|status
operator|=
name|smsatStartIDDev
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiry: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiry: calling satInquiryIntCB\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatInquiryIntCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatStartIDDev
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smSatInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|satDevData
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartIDDev: start\n"
operator|)
argument_list|)
expr_stmt|;
name|satDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartIDDev: before alloc\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate identify device command */
name|satIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|satDevData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|,
comment|/* 512; size of identify device data */
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartIDDev: before after\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartIDDev: can't alloacate!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
return|return
name|SM_RC_FAILURE
return|;
block|}
name|satIntIo
operator|->
name|satOrgSmIORequest
operator|=
name|smIORequest
expr_stmt|;
comment|/* changed */
name|smIORequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSatDevData
operator|=
name|satDevData
expr_stmt|;
name|satNewIOContext
operator|->
name|pFis
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSense
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSmSenseData
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|)
expr_stmt|;
name|satNewIOContext
operator|->
name|smRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
comment|/* key fix */
name|satNewIOContext
operator|->
name|interruptContext
operator|=
name|tiInterruptContext
expr_stmt|;
name|satNewIOContext
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satNewIOContext
operator|->
name|psmDeviceHandle
operator|=
name|agNULL
expr_stmt|;
name|satNewIOContext
operator|->
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
comment|/* changed */
comment|/* this is valid only for TD layer generated (not triggered by OS at all) IO */
name|satNewIOContext
operator|->
name|smScsiXchg
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartIDDev: OS satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartIDDev: TD satNewIOContext %p \n"
operator|,
name|satNewIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartIDDev: OS tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartIDDev: TD tiScsiXchg %p \n"
operator|,
name|satNewIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartIDDev: satNewIOContext %p smIORequestBody %p!!!\n"
operator|,
name|satNewIOContext
operator|,
name|smIORequestBody
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatSendIDDev
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntSmIORequest
argument_list|,
comment|/* New smIORequest */
name|smDeviceHandle
argument_list|,
name|satNewIOContext
operator|->
name|smScsiXchg
argument_list|,
comment|/* New tiScsiInitiatorRequest_t *tiScsiRequest, */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartIDDev: failed in sending!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|satDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
return|return
name|SM_RC_FAILURE
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatStartIDDev: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatSendIDDev
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
ifdef|#
directive|ifdef
name|SM_INTERNAL_DEBUG
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIoContext
decl_stmt|;
endif|#
directive|endif
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatSendIDDev: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatSendIDDev: did %d\n"
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SM_INTERNAL_DEBUG
name|satIntIoContext
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|smIORequestBody
operator|=
name|satIntIoContext
operator|->
name|satIntRequestBody
expr_stmt|;
endif|#
directive|endif
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_IDENTIFY_PACKET_DEVICE
expr_stmt|;
comment|/* 0x40 */
else|else
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_IDENTIFY_DEVICE
expr_stmt|;
comment|/* 0xEC */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatInquiryCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
ifdef|#
directive|ifdef
name|SM_INTERNAL_DEBUG
name|smhexdump
argument_list|(
literal|"smsatSendIDDev"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|satIOContext
operator|->
name|pFis
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
name|smhexdump
argument_list|(
literal|"smsatSendIDDev LL"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatSendIDDev: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatRequestSense
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     SAT Rev 8 p38, Table25     sending SMART RETURN STATUS     Checking SMART Treshold Exceeded Condition is done in satRequestSenseCB()     Only fixed format sense data is support. In other words, we don't support DESC bit is set     in Request Sense    */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext2
decl_stmt|;
name|bit8
modifier|*
name|pDataBuffer
init|=
name|agNULL
decl_stmt|;
name|bit32
name|allocationLen
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pDataBuffer
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|allocationLen
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRequestSense: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSense: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*     Only fixed format sense data is support. In other words, we don't support DESC bit is set     in Request Sense    */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|ATA_REMOVABLE_MEDIA_DEVICE_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSense: DESC bit is set, which we don't support!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends SMART RETURN STATUS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_RETURN_STATUS
expr_stmt|;
comment|/* FIS features */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatRequestSenseCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense: if return, status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
else|else
block|{
comment|/*allocate iocontext for xmitting xmit SAT_CHECK_POWER_MODE       then call satRequestSense2 */
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense: before satIntIo %p\n"
operator|,
name|satIntIo
operator|)
argument_list|)
expr_stmt|;
comment|/* allocate iocontext */
name|satIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
comment|/* original request */
name|pSatDevData
argument_list|,
name|smScsiRequest
operator|->
name|scsiCmnd
operator|.
name|expDataLength
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense: after satIntIo %p\n"
operator|,
name|satIntIo
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* failed during sending SMART RETURN STATUS */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSense: else fail 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext except      * reqType and satCompleteCB which will be set depending on cmd.      */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense: satIntIo is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense: satIntIo is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* use this --- tttttthe one the same */
name|satIntIo
operator|->
name|satOrgSmIORequest
operator|=
name|smIORequest
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSatDevData
operator|=
name|pSatDevData
expr_stmt|;
name|satIOContext2
operator|->
name|pFis
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSense
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSmSenseData
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSmSenseData
operator|->
name|senseData
operator|=
name|satIOContext2
operator|->
name|pSense
expr_stmt|;
name|satIOContext2
operator|->
name|smRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|->
name|interruptContext
operator|=
name|satIOContext
operator|->
name|interruptContext
expr_stmt|;
name|satIOContext2
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satIOContext2
operator|->
name|psmDeviceHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext2
operator|->
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense: satIntIo->satIntSmScsiXchg.agSgl1.len %d\n"
operator|,
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|len
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense: satIntIo->satIntSmScsiXchg.agSgl1.upper %d\n"
operator|,
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|upper
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense: satIntIo->satIntSmScsiXchg.agSgl1.lower %d\n"
operator|,
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|lower
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense: satIntIo->satIntSmScsiXchg.agSgl1.type %d\n"
operator|,
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|smSgl1
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatRequestSense_1
argument_list|(
name|smRoot
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmIORequest
operator|)
argument_list|,
name|smDeviceHandle
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|)
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* failed during sending SMART RETURN STATUS */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSense: else fail 2!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense: else return success\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatRequestSense_1
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     sends SAT_CHECK_POWER_MODE   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRequestSense_1: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the ATA CHECK POWER MODE command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_CHECK_POWER_MODE
expr_stmt|;
comment|/* 0xE5 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatRequestSenseCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense_1: smSgl1.len %d\n"
operator|,
name|smScsiRequest
operator|->
name|smSgl1
operator|.
name|len
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense_1: smSgl1.upper %d\n"
operator|,
name|smScsiRequest
operator|->
name|smSgl1
operator|.
name|upper
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense_1: smSgl1.lower %d\n"
operator|,
name|smScsiRequest
operator|->
name|smSgl1
operator|.
name|lower
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSense_1: smSgl1.type %d\n"
operator|,
name|smScsiRequest
operator|->
name|smSgl1
operator|.
name|type
operator|)
argument_list|)
expr_stmt|;
comment|//  smhexdump("smsatRequestSense_1", (bit8 *)fis, sizeof(agsaFisRegHostToDevice_t));
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatModeSense6
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|bit32
name|allocationLen
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|pageSupported
decl_stmt|;
name|bit8
name|page
decl_stmt|;
name|bit8
modifier|*
name|pModeSense
decl_stmt|;
comment|/* Mode Sense data buffer */
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|bit8
name|PC
decl_stmt|;
name|bit8
name|AllPages
index|[
name|MODE_SENSE6_RETURN_ALL_PAGES_LEN
index|]
decl_stmt|;
name|bit8
name|Control
index|[
name|MODE_SENSE6_CONTROL_PAGE_LEN
index|]
decl_stmt|;
name|bit8
name|RWErrorRecovery
index|[
name|MODE_SENSE6_READ_WRITE_ERROR_RECOVERY_PAGE_LEN
index|]
decl_stmt|;
name|bit8
name|Caching
index|[
name|MODE_SENSE6_CACHING_LEN
index|]
decl_stmt|;
name|bit8
name|InfoExceptionCtrl
index|[
name|MODE_SENSE6_INFORMATION_EXCEPTION_CONTROL_PAGE_LEN
index|]
decl_stmt|;
name|bit8
name|lenRead
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pModeSense
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|//smhexdump("smsatModeSense6", (bit8 *)scsiCmnd->cdb, 6);
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense6: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense6: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking PC(Page Control)      SAT revion 8, 8.5.3 p33 and 10.1.2, p66   */
name|PC
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|)
operator|&
name|SCSI_MODE_SENSE6_PC_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|PC
operator|!=
literal|0
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense6: return due to PC value pc 0x%x!!!\n"
operator|,
name|PC
operator|>>
literal|6
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* reading PAGE CODE */
name|page
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|)
operator|&
name|SCSI_MODE_SENSE6_PAGE_CODE_MASK
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense6: page=0x%x\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
name|allocationLen
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
comment|/*     Based on page code value, returns a corresponding mode page     note: no support for subpage   */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|MODESENSE_RETURN_ALL_PAGES
case|:
case|case
name|MODESENSE_CONTROL_PAGE
case|:
comment|/* control */
case|case
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
comment|/* Read-Write Error Recovery */
case|case
name|MODESENSE_CACHING
case|:
comment|/* caching */
case|case
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
comment|/* informational exceptions control*/
name|pageSupported
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|MODESENSE_VENDOR_SPECIFIC_PAGE
case|:
comment|/* vendor specific */
default|default:
name|pageSupported
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|pageSupported
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense6 *** ERROR *** not supported page 0x%x did %d!!!\n"
operator|,
name|page
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|MODESENSE_RETURN_ALL_PAGES
case|:
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE6_RETURN_ALL_PAGES_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODESENSE_CONTROL_PAGE
case|:
comment|/* control */
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE6_CONTROL_PAGE_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
comment|/* Read-Write Error Recovery */
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE6_READ_WRITE_ERROR_RECOVERY_PAGE_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODESENSE_CACHING
case|:
comment|/* caching */
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE6_CACHING_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
comment|/* informational exceptions control*/
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE6_INFORMATION_EXCEPTION_CONTROL_PAGE_LEN
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense6: default error page %d!!!\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|page
operator|==
name|MODESENSE_RETURN_ALL_PAGES
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense6: MODESENSE_RETURN_ALL_PAGES\n"
operator|)
argument_list|)
expr_stmt|;
name|AllPages
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|1
argument_list|)
expr_stmt|;
name|AllPages
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|AllPages
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|AllPages
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
comment|/* density code */
name|AllPages
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|AllPages
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|AllPages
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|AllPages
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|AllPages
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE */
name|AllPages
index|[
literal|12
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
literal|13
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|AllPages
index|[
literal|14
index|]
operator|=
literal|0x40
expr_stmt|;
comment|/* ARRE is set */
name|AllPages
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MODESENSE_CACHING */
name|AllPages
index|[
literal|24
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
literal|25
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satWriteCacheEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
literal|26
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* WCE bit is set */
block|}
else|else
block|{
name|AllPages
index|[
literal|26
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
block|}
name|AllPages
index|[
literal|27
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|28
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|29
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|30
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|31
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|32
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|33
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|34
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|35
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satLookAheadEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
literal|36
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DRA bit is NOT set */
block|}
else|else
block|{
name|AllPages
index|[
literal|36
index|]
operator|=
literal|0x20
expr_stmt|;
comment|/* DRA bit is set */
block|}
name|AllPages
index|[
literal|37
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|38
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|39
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|40
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|41
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|42
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|43
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MODESENSE_CONTROL_PAGE */
name|AllPages
index|[
literal|44
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
literal|45
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|AllPages
index|[
literal|46
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* only GLTSD bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
literal|47
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* Queue Alogorithm modifier 1b and QErr 01b*/
block|}
else|else
block|{
name|AllPages
index|[
literal|47
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Queue Alogorithm modifier 0b and QErr 01b */
block|}
name|AllPages
index|[
literal|48
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|49
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|50
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|AllPages
index|[
literal|51
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|AllPages
index|[
literal|52
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|AllPages
index|[
literal|53
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|AllPages
index|[
literal|54
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|AllPages
index|[
literal|55
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
comment|/* MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE */
name|AllPages
index|[
literal|56
index|]
operator|=
literal|0x1C
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
literal|57
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
literal|58
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DEXCPT bit is NOT set */
block|}
else|else
block|{
name|AllPages
index|[
literal|58
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* DEXCPT bit is set */
block|}
name|AllPages
index|[
literal|59
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* We don't support MRIE */
name|AllPages
index|[
literal|60
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Interval timer vendor-specific */
name|AllPages
index|[
literal|61
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|62
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|63
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|64
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* REPORT-COUNT */
name|AllPages
index|[
literal|65
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|66
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|67
index|]
operator|=
literal|0x00
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|AllPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_CONTROL_PAGE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense6: MODESENSE_CONTROL_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|Control
index|[
literal|0
index|]
operator|=
name|MODE_SENSE6_CONTROL_PAGE_LEN
operator|-
literal|1
expr_stmt|;
name|Control
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|Control
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|Control
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
comment|/* density code */
name|Control
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Control
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Control
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Control
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Control
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/*      * Fill-up control mode page, SAT, Table 65      */
name|Control
index|[
literal|12
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page code */
name|Control
index|[
literal|13
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|Control
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* only GLTSD bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
name|Control
index|[
literal|15
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* Queue Alogorithm modifier 1b and QErr 01b*/
block|}
else|else
block|{
name|Control
index|[
literal|15
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Queue Alogorithm modifier 0b and QErr 01b */
block|}
name|Control
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|Control
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|Control
index|[
literal|20
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|Control
index|[
literal|21
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|Control
index|[
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|Control
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|Control
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense6: MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|RWErrorRecovery
index|[
literal|0
index|]
operator|=
name|MODE_SENSE6_READ_WRITE_ERROR_RECOVERY_PAGE_LEN
operator|-
literal|1
expr_stmt|;
name|RWErrorRecovery
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|RWErrorRecovery
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|RWErrorRecovery
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
comment|/* density code */
name|RWErrorRecovery
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|RWErrorRecovery
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|RWErrorRecovery
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|RWErrorRecovery
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/*      * Fill-up Read-Write Error Recovery mode page, SAT, Table 66      */
name|RWErrorRecovery
index|[
literal|12
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* page code */
name|RWErrorRecovery
index|[
literal|13
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|RWErrorRecovery
index|[
literal|14
index|]
operator|=
literal|0x40
expr_stmt|;
comment|/* ARRE is set */
name|RWErrorRecovery
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|RWErrorRecovery
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_CACHING
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense6: MODESENSE_CACHING\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* special case */
if|if
condition|(
name|allocationLen
operator|==
literal|4
operator|&&
name|page
operator|==
name|MODESENSE_CACHING
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense6: linux 2.6.8.24 support\n"
operator|)
argument_list|)
expr_stmt|;
name|Caching
index|[
literal|0
index|]
operator|=
literal|0x20
operator|-
literal|1
expr_stmt|;
comment|/* 32 - 1 */
name|Caching
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|Caching
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|Caching
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|Caching
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|Caching
index|[
literal|0
index|]
operator|=
name|MODE_SENSE6_CACHING_LEN
operator|-
literal|1
expr_stmt|;
name|Caching
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|Caching
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|Caching
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
comment|/* density code */
name|Caching
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Caching
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Caching
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Caching
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Caching
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/*      * Fill-up Caching mode page, SAT, Table 67      */
comment|/* length 20 */
name|Caching
index|[
literal|12
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* page code */
name|Caching
index|[
literal|13
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satWriteCacheEnabled
operator|==
name|agTRUE
condition|)
block|{
name|Caching
index|[
literal|14
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* WCE bit is set */
block|}
else|else
block|{
name|Caching
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
block|}
name|Caching
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satLookAheadEnabled
operator|==
name|agTRUE
condition|)
block|{
name|Caching
index|[
literal|24
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DRA bit is NOT set */
block|}
else|else
block|{
name|Caching
index|[
literal|24
index|]
operator|=
literal|0x20
expr_stmt|;
comment|/* DRA bit is set */
block|}
name|Caching
index|[
literal|25
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|26
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|27
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|28
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|29
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|30
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|31
index|]
operator|=
literal|0x00
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|Caching
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense6: MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|0
index|]
operator|=
name|MODE_SENSE6_INFORMATION_EXCEPTION_CONTROL_PAGE_LEN
operator|-
literal|1
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* default medium type (currently mounted medium type) */
name|InfoExceptionCtrl
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* no write-protect, no support for DPO-FUA */
name|InfoExceptionCtrl
index|[
literal|3
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length */
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
comment|/* density code */
name|InfoExceptionCtrl
index|[
literal|4
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|InfoExceptionCtrl
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|InfoExceptionCtrl
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|InfoExceptionCtrl
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/*      * Fill-up informational-exceptions control mode page, SAT, Table 68      */
name|InfoExceptionCtrl
index|[
literal|12
index|]
operator|=
literal|0x1C
expr_stmt|;
comment|/* page code */
name|InfoExceptionCtrl
index|[
literal|13
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
condition|)
block|{
name|InfoExceptionCtrl
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DEXCPT bit is NOT set */
block|}
else|else
block|{
name|InfoExceptionCtrl
index|[
literal|14
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* DEXCPT bit is set */
block|}
name|InfoExceptionCtrl
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* We don't support MRIE */
name|InfoExceptionCtrl
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Interval timer vendor-specific */
name|InfoExceptionCtrl
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* REPORT-COUNT */
name|InfoExceptionCtrl
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|InfoExceptionCtrl
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Error */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense6: Error page %d!!!\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* there can be only underrun not overrun in error case */
if|if
condition|(
name|allocationLen
operator|>
name|lenRead
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatModeSense6 reporting underrun lenRead=0x%x allocationLen=0x%x\n"
operator|,
name|lenRead
operator|,
name|allocationLen
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|lenRead
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatModeSense10
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|bit32
name|allocationLen
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|pageSupported
decl_stmt|;
name|bit8
name|page
decl_stmt|;
name|bit8
modifier|*
name|pModeSense
decl_stmt|;
comment|/* Mode Sense data buffer */
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|bit8
name|PC
decl_stmt|;
comment|/* page control */
name|bit8
name|LLBAA
decl_stmt|;
comment|/* Long LBA Accepted */
name|bit32
name|index
decl_stmt|;
name|bit8
name|AllPages
index|[
name|MODE_SENSE10_RETURN_ALL_PAGES_LLBAA_LEN
index|]
decl_stmt|;
name|bit8
name|Control
index|[
name|MODE_SENSE10_CONTROL_PAGE_LLBAA_LEN
index|]
decl_stmt|;
name|bit8
name|RWErrorRecovery
index|[
name|MODE_SENSE10_READ_WRITE_ERROR_RECOVERY_PAGE_LLBAA_LEN
index|]
decl_stmt|;
name|bit8
name|Caching
index|[
name|MODE_SENSE10_CACHING_LLBAA_LEN
index|]
decl_stmt|;
name|bit8
name|InfoExceptionCtrl
index|[
name|MODE_SENSE10_INFORMATION_EXCEPTION_CONTROL_PAGE_LLBAA_LEN
index|]
decl_stmt|;
name|bit8
name|lenRead
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pModeSense
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking PC(Page Control)      SAT revion 8, 8.5.3 p33 and 10.1.2, p66   */
name|PC
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|)
operator|&
name|SCSI_MODE_SENSE10_PC_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|PC
operator|!=
literal|0
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense10: return due to PC value pc 0x%x!!!\n"
operator|,
name|PC
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* finding LLBAA bit */
name|LLBAA
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|)
operator|&
name|SCSI_MODE_SENSE10_LLBAA_MASK
argument_list|)
expr_stmt|;
comment|/* reading PAGE CODE */
name|page
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|)
operator|&
name|SCSI_MODE_SENSE10_PAGE_CODE_MASK
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense10: page=0x%x, did %d\n"
operator|,
name|page
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|allocationLen
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
comment|/*     Based on page code value, returns a corresponding mode page     note: no support for subpage   */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|MODESENSE_RETURN_ALL_PAGES
case|:
comment|/* return all pages */
case|case
name|MODESENSE_CONTROL_PAGE
case|:
comment|/* control */
case|case
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
comment|/* Read-Write Error Recovery */
case|case
name|MODESENSE_CACHING
case|:
comment|/* caching */
case|case
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
comment|/* informational exceptions control*/
name|pageSupported
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|MODESENSE_VENDOR_SPECIFIC_PAGE
case|:
comment|/* vendor specific */
default|default:
name|pageSupported
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|pageSupported
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense10 *** ERROR *** not supported page 0x%x did %d!!!\n"
operator|,
name|page
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|MODESENSE_RETURN_ALL_PAGES
case|:
if|if
condition|(
name|LLBAA
condition|)
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE10_RETURN_ALL_PAGES_LLBAA_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE10_RETURN_ALL_PAGES_LEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MODESENSE_CONTROL_PAGE
case|:
comment|/* control */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE10_CONTROL_PAGE_LLBAA_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE10_CONTROL_PAGE_LEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
comment|/* Read-Write Error Recovery */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE10_READ_WRITE_ERROR_RECOVERY_PAGE_LLBAA_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE10_READ_WRITE_ERROR_RECOVERY_PAGE_LEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MODESENSE_CACHING
case|:
comment|/* caching */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE10_CACHING_LLBAA_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE10_CACHING_LEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
comment|/* informational exceptions control*/
if|if
condition|(
name|LLBAA
condition|)
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE10_INFORMATION_EXCEPTION_CONTROL_PAGE_LLBAA_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lenRead
operator|=
operator|(
name|bit8
operator|)
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|MODE_SENSE10_INFORMATION_EXCEPTION_CONTROL_PAGE_LEN
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense10: default error page %d!!!\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|page
operator|==
name|MODESENSE_RETURN_ALL_PAGES
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense10: MODESENSE_RETURN_ALL_PAGES\n"
operator|)
argument_list|)
expr_stmt|;
name|AllPages
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|AllPages
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|2
argument_list|)
expr_stmt|;
name|AllPages
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* medium type: default medium type (currently mounted medium type) */
name|AllPages
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* device-specific param: no write-protect, no support for DPO-FUA */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|AllPages
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA */
name|AllPages
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|AllPages
index|[
literal|4
index|]
operator||
literal|0x1
argument_list|)
expr_stmt|;
comment|/* LONGLBA is set */
block|}
else|else
block|{
name|AllPages
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA: LONGLBA is not set */
block|}
name|AllPages
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|AllPages
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* block descriptot length */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|AllPages
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* block descriptor length: LONGLBA is set. So, length is 16 */
block|}
else|else
block|{
name|AllPages
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length: LONGLBA is NOT set. So, length is 8 */
block|}
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
if|if
condition|(
name|LLBAA
condition|)
block|{
comment|/* density code */
name|AllPages
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|AllPages
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|AllPages
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|AllPages
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|AllPages
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|AllPages
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|AllPages
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|22
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|AllPages
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
comment|/* density code */
name|AllPages
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|AllPages
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|AllPages
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|AllPages
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|AllPages
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|AllPages
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|LLBAA
condition|)
block|{
name|index
operator|=
literal|24
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|16
expr_stmt|;
block|}
comment|/* MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE */
name|AllPages
index|[
name|index
operator|+
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
name|index
operator|+
literal|1
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|AllPages
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x40
expr_stmt|;
comment|/* ARRE is set */
name|AllPages
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MODESENSE_CACHING */
comment|/*      * Fill-up Caching mode page, SAT, Table 67      */
comment|/* length 20 */
name|AllPages
index|[
name|index
operator|+
literal|12
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
name|index
operator|+
literal|13
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satWriteCacheEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
name|index
operator|+
literal|14
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* WCE bit is set */
block|}
else|else
block|{
name|AllPages
index|[
name|index
operator|+
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
block|}
name|AllPages
index|[
name|index
operator|+
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|22
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satLookAheadEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
name|index
operator|+
literal|24
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DRA bit is NOT set */
block|}
else|else
block|{
name|AllPages
index|[
name|index
operator|+
literal|24
index|]
operator|=
literal|0x20
expr_stmt|;
comment|/* DRA bit is set */
block|}
name|AllPages
index|[
name|index
operator|+
literal|25
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|26
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|27
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|28
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|29
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|30
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|31
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MODESENSE_CONTROL_PAGE */
comment|/*      * Fill-up control mode page, SAT, Table 65      */
name|AllPages
index|[
name|index
operator|+
literal|32
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
name|index
operator|+
literal|33
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|AllPages
index|[
name|index
operator|+
literal|34
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* only GLTSD bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
name|index
operator|+
literal|35
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* Queue Alogorithm modifier 1b and QErr 01b*/
block|}
else|else
block|{
name|AllPages
index|[
name|index
operator|+
literal|35
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Queue Alogorithm modifier 0b and QErr 01b */
block|}
name|AllPages
index|[
name|index
operator|+
literal|36
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|37
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|38
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|AllPages
index|[
name|index
operator|+
literal|39
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|AllPages
index|[
name|index
operator|+
literal|40
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|AllPages
index|[
name|index
operator|+
literal|41
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|AllPages
index|[
name|index
operator|+
literal|42
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|AllPages
index|[
name|index
operator|+
literal|43
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
comment|/* MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE */
comment|/*      * Fill-up informational-exceptions control mode page, SAT, Table 68      */
name|AllPages
index|[
name|index
operator|+
literal|44
index|]
operator|=
literal|0x1C
expr_stmt|;
comment|/* page code */
name|AllPages
index|[
name|index
operator|+
literal|45
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
condition|)
block|{
name|AllPages
index|[
name|index
operator|+
literal|46
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DEXCPT bit is NOT set */
block|}
else|else
block|{
name|AllPages
index|[
name|index
operator|+
literal|46
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* DEXCPT bit is set */
block|}
name|AllPages
index|[
name|index
operator|+
literal|47
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* We don't support MRIE */
name|AllPages
index|[
name|index
operator|+
literal|48
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Interval timer vendor-specific */
name|AllPages
index|[
name|index
operator|+
literal|49
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|50
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|51
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|52
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* REPORT-COUNT */
name|AllPages
index|[
name|index
operator|+
literal|53
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|54
index|]
operator|=
literal|0x00
expr_stmt|;
name|AllPages
index|[
name|index
operator|+
literal|55
index|]
operator|=
literal|0x00
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|AllPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_CONTROL_PAGE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense10: MODESENSE_CONTROL_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|Control
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|Control
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|2
argument_list|)
expr_stmt|;
name|Control
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* medium type: default medium type (currently mounted medium type) */
name|Control
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* device-specific param: no write-protect, no support for DPO-FUA */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|Control
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA */
name|Control
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Control
index|[
literal|4
index|]
operator||
literal|0x1
argument_list|)
expr_stmt|;
comment|/* LONGLBA is set */
block|}
else|else
block|{
name|Control
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA: LONGLBA is not set */
block|}
name|Control
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Control
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* block descriptot length */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|Control
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* block descriptor length: LONGLBA is set. So, length is 16 */
block|}
else|else
block|{
name|Control
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length: LONGLBA is NOT set. So, length is 8 */
block|}
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
if|if
condition|(
name|LLBAA
condition|)
block|{
comment|/* density code */
name|Control
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Control
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Control
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Control
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Control
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Control
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Control
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|22
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Control
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
comment|/* density code */
name|Control
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Control
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Control
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Control
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Control
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Control
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|LLBAA
condition|)
block|{
name|index
operator|=
literal|24
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|16
expr_stmt|;
block|}
comment|/*      * Fill-up control mode page, SAT, Table 65      */
name|Control
index|[
name|index
operator|+
literal|0
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page code */
name|Control
index|[
name|index
operator|+
literal|1
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|Control
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* only GLTSD bit is set */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
name|Control
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* Queue Alogorithm modifier 1b and QErr 01b*/
block|}
else|else
block|{
name|Control
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Queue Alogorithm modifier 0b and QErr 01b */
block|}
name|Control
index|[
name|index
operator|+
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
name|index
operator|+
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|Control
index|[
name|index
operator|+
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|Control
index|[
name|index
operator|+
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* obsolete */
name|Control
index|[
name|index
operator|+
literal|8
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|Control
index|[
name|index
operator|+
literal|9
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Busy Timeout Period */
name|Control
index|[
name|index
operator|+
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|Control
index|[
name|index
operator|+
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* we don't support non-000b value for the self-test code */
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|Control
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense10: MODESENSE_READ_WRITE_ERROR_RECOVERY_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|RWErrorRecovery
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|RWErrorRecovery
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|2
argument_list|)
expr_stmt|;
name|RWErrorRecovery
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* medium type: default medium type (currently mounted medium type) */
name|RWErrorRecovery
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* device-specific param: no write-protect, no support for DPO-FUA */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|RWErrorRecovery
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA */
name|RWErrorRecovery
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|RWErrorRecovery
index|[
literal|4
index|]
operator||
literal|0x1
argument_list|)
expr_stmt|;
comment|/* LONGLBA is set */
block|}
else|else
block|{
name|RWErrorRecovery
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA: LONGLBA is not set */
block|}
name|RWErrorRecovery
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* block descriptot length */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|RWErrorRecovery
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* block descriptor length: LONGLBA is set. So, length is 16 */
block|}
else|else
block|{
name|RWErrorRecovery
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length: LONGLBA is NOT set. So, length is 8 */
block|}
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
if|if
condition|(
name|LLBAA
condition|)
block|{
comment|/* density code */
name|RWErrorRecovery
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|RWErrorRecovery
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|RWErrorRecovery
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|22
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|RWErrorRecovery
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
comment|/* density code */
name|RWErrorRecovery
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|RWErrorRecovery
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|RWErrorRecovery
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|RWErrorRecovery
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|RWErrorRecovery
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|RWErrorRecovery
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|LLBAA
condition|)
block|{
name|index
operator|=
literal|24
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|16
expr_stmt|;
block|}
comment|/*      * Fill-up Read-Write Error Recovery mode page, SAT, Table 66      */
name|RWErrorRecovery
index|[
name|index
operator|+
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* page code */
name|RWErrorRecovery
index|[
name|index
operator|+
literal|1
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
name|RWErrorRecovery
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x40
expr_stmt|;
comment|/* ARRE is set */
name|RWErrorRecovery
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
name|RWErrorRecovery
index|[
name|index
operator|+
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|RWErrorRecovery
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_CACHING
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense10: MODESENSE_CACHING\n"
operator|)
argument_list|)
expr_stmt|;
name|Caching
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|Caching
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|2
argument_list|)
expr_stmt|;
name|Caching
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* medium type: default medium type (currently mounted medium type) */
name|Caching
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* device-specific param: no write-protect, no support for DPO-FUA */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|Caching
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA */
name|Caching
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Caching
index|[
literal|4
index|]
operator||
literal|0x1
argument_list|)
expr_stmt|;
comment|/* LONGLBA is set */
block|}
else|else
block|{
name|Caching
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA: LONGLBA is not set */
block|}
name|Caching
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Caching
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* block descriptot length */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|Caching
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* block descriptor length: LONGLBA is set. So, length is 16 */
block|}
else|else
block|{
name|Caching
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length: LONGLBA is NOT set. So, length is 8 */
block|}
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
if|if
condition|(
name|LLBAA
condition|)
block|{
comment|/* density code */
name|Caching
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Caching
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Caching
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Caching
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Caching
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|Caching
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Caching
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|22
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Caching
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
comment|/* density code */
name|Caching
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|Caching
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|Caching
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|Caching
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|Caching
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|Caching
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|LLBAA
condition|)
block|{
name|index
operator|=
literal|24
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|16
expr_stmt|;
block|}
comment|/*      * Fill-up Caching mode page, SAT, Table 67      */
comment|/* length 20 */
name|Caching
index|[
name|index
operator|+
literal|0
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* page code */
name|Caching
index|[
name|index
operator|+
literal|1
index|]
operator|=
literal|0x12
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satWriteCacheEnabled
operator|==
name|agTRUE
condition|)
block|{
name|Caching
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* WCE bit is set */
block|}
else|else
block|{
name|Caching
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* WCE bit is NOT set */
block|}
name|Caching
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satLookAheadEnabled
operator|==
name|agTRUE
condition|)
block|{
name|Caching
index|[
name|index
operator|+
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DRA bit is NOT set */
block|}
else|else
block|{
name|Caching
index|[
name|index
operator|+
literal|12
index|]
operator|=
literal|0x20
expr_stmt|;
comment|/* DRA bit is set */
block|}
name|Caching
index|[
name|index
operator|+
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
name|Caching
index|[
name|index
operator|+
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|Caching
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|page
operator|==
name|MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSense10: MODESENSE_INFORMATION_EXCEPTION_CONTROL_PAGE\n"
operator|)
argument_list|)
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lenRead
operator|-
literal|2
argument_list|)
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* medium type: default medium type (currently mounted medium type) */
name|InfoExceptionCtrl
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* device-specific param: no write-protect, no support for DPO-FUA */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|InfoExceptionCtrl
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA */
name|InfoExceptionCtrl
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|InfoExceptionCtrl
index|[
literal|4
index|]
operator||
literal|0x1
argument_list|)
expr_stmt|;
comment|/* LONGLBA is set */
block|}
else|else
block|{
name|InfoExceptionCtrl
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved and LONGLBA: LONGLBA is not set */
block|}
name|InfoExceptionCtrl
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* block descriptot length */
if|if
condition|(
name|LLBAA
condition|)
block|{
name|InfoExceptionCtrl
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* block descriptor length: LONGLBA is set. So, length is 16 */
block|}
else|else
block|{
name|InfoExceptionCtrl
index|[
literal|7
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* block descriptor length: LONGLBA is NOT set. So, length is 8 */
block|}
comment|/*      * Fill-up direct-access device block-descriptor, SAT, Table 19      */
if|if
condition|(
name|LLBAA
condition|)
block|{
comment|/* density code */
name|InfoExceptionCtrl
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|InfoExceptionCtrl
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|14
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|16
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|17
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|18
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|19
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|InfoExceptionCtrl
index|[
literal|20
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|21
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|22
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|InfoExceptionCtrl
index|[
literal|23
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
comment|/* density code */
name|InfoExceptionCtrl
index|[
literal|8
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* density-code : reserved for direct-access */
comment|/* number of blocks */
name|InfoExceptionCtrl
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
name|InfoExceptionCtrl
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* unspecified */
comment|/* reserved */
name|InfoExceptionCtrl
index|[
literal|12
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* reserved */
comment|/* Block size */
name|InfoExceptionCtrl
index|[
literal|13
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
literal|14
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* Block size is always 512 bytes */
name|InfoExceptionCtrl
index|[
literal|15
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
if|if
condition|(
name|LLBAA
condition|)
block|{
name|index
operator|=
literal|24
expr_stmt|;
block|}
else|else
block|{
name|index
operator|=
literal|16
expr_stmt|;
block|}
comment|/*      * Fill-up informational-exceptions control mode page, SAT, Table 68      */
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|0
index|]
operator|=
literal|0x1C
expr_stmt|;
comment|/* page code */
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|1
index|]
operator|=
literal|0x0A
expr_stmt|;
comment|/* page length */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
condition|)
block|{
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* DEXCPT bit is NOT set */
block|}
else|else
block|{
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|2
index|]
operator|=
literal|0x08
expr_stmt|;
comment|/* DEXCPT bit is set */
block|}
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* We don't support MRIE */
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* Interval timer vendor-specific */
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|6
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* REPORT-COUNT */
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|10
index|]
operator|=
literal|0x00
expr_stmt|;
name|InfoExceptionCtrl
index|[
name|index
operator|+
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pModeSense
argument_list|,
operator|&
name|InfoExceptionCtrl
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Error */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense10: Error page %d!!!\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
if|if
condition|(
name|allocationLen
operator|>
name|lenRead
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSense10: reporting underrun lenRead=0x%x allocationLen=0x%x smIORequest=%p\n"
operator|,
name|lenRead
operator|,
name|allocationLen
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|lenRead
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatReadCapacity10
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit8
name|dataBuffer
index|[
literal|8
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bit32
name|allocationLen
decl_stmt|;
name|bit8
modifier|*
name|pVirtAddr
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit32
name|lastLba
decl_stmt|;
name|bit32
name|word117_118
decl_stmt|;
name|bit32
name|word117
decl_stmt|;
name|bit32
name|word118
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pVirtAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|pSATAIdData
operator|=
operator|&
name|pSatDevData
operator|->
name|satIdentifyData
expr_stmt|;
name|allocationLen
operator|=
name|scsiCmnd
operator|->
name|expDataLength
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReadCapacity10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*    * If Logical block address is not set to zero, return error    */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity10: *** ERROR *** logical address non zero, did %d!!!\n"
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*    * If PMI bit is not zero, return error    */
if|if
condition|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|)
operator|&
name|SCSI_READ_CAPACITY10_PMI_MASK
operator|)
operator|!=
literal|0
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity10: *** ERROR *** PMI is not zero, did %d\n"
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*     filling in Read Capacity parameter data     saved identify device has been already flipped     See ATA spec p125 and p136 and SBC spec p54   */
comment|/*    * If 48-bit addressing is supported, set capacity information from Identify    * Device Word 100-103.    */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/*      * Setting RETURNED LOGICAL BLOCK ADDRESS in READ CAPACITY(10) response data:      * SBC-2 specifies that if the capacity exceeded the 4-byte RETURNED LOGICAL      * BLOCK ADDRESS in READ CAPACITY(10) parameter data, the RETURNED LOGICAL      * BLOCK ADDRESS should be set to 0xFFFFFFFF so the application client would      * then issue a READ CAPACITY(16) command.      */
comment|/* ATA Identify Device information word 100 - 103 */
if|if
condition|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA32_47
operator|!=
literal|0
operator|)
operator|||
operator|(
name|pSATAIdData
operator|->
name|maxLBA48_63
operator|!=
literal|0
operator|)
condition|)
block|{
name|dataBuffer
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* MSB number of block */
name|dataBuffer
index|[
literal|1
index|]
operator|=
literal|0xFF
expr_stmt|;
name|dataBuffer
index|[
literal|2
index|]
operator|=
literal|0xFF
expr_stmt|;
name|dataBuffer
index|[
literal|3
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* LSB number of block */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity10: returns 0xFFFFFFFF!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* Fit the Readcapacity10 4-bytes response length */
block|{
name|lastLba
operator|=
operator|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA16_31
operator|)
operator|<<
literal|16
operator|)
operator|)
operator||
operator|(
name|pSATAIdData
operator|->
name|maxLBA0_15
operator|)
expr_stmt|;
name|lastLba
operator|=
name|lastLba
operator|-
literal|1
expr_stmt|;
comment|/* LBA starts from zero */
comment|/*         for testing       lastLba = lastLba - (512*10) - 1;       */
name|dataBuffer
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* MSB */
name|dataBuffer
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* LSB */
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatReadCapacity10: lastLba is 0x%x %d\n"
operator|,
name|lastLba
operator|,
name|lastLba
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatReadCapacity10: LBA 0 is 0x%x %d\n"
operator|,
name|dataBuffer
index|[
literal|0
index|]
operator|,
name|dataBuffer
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatReadCapacity10: LBA 1 is 0x%x %d\n"
operator|,
name|dataBuffer
index|[
literal|1
index|]
operator|,
name|dataBuffer
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatReadCapacity10: LBA 2 is 0x%x %d\n"
operator|,
name|dataBuffer
index|[
literal|2
index|]
operator|,
name|dataBuffer
index|[
literal|2
index|]
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatReadCapacity10: LBA 3 is 0x%x %d\n"
operator|,
name|dataBuffer
index|[
literal|3
index|]
operator|,
name|dataBuffer
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*    * For 28-bit addressing, set capacity information from Identify    * Device Word 60-61.    */
else|else
block|{
comment|/* ATA Identify Device information word 60 - 61 */
name|lastLba
operator|=
operator|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|numOfUserAddressableSectorsHi
operator|)
operator|<<
literal|16
operator|)
operator|)
operator||
operator|(
name|pSATAIdData
operator|->
name|numOfUserAddressableSectorsLo
operator|)
expr_stmt|;
name|lastLba
operator|=
name|lastLba
operator|-
literal|1
expr_stmt|;
comment|/* LBA starts from zero */
name|dataBuffer
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* MSB */
name|dataBuffer
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLba
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* LSB */
block|}
comment|/* SAT Rev 8d */
if|if
condition|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|word104_107
index|[
literal|2
index|]
operator|)
operator|&
literal|0x1000
operator|)
operator|==
literal|0
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReadCapacity10: Default Block Length is 512\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Set the block size, fixed at 512 bytes.      */
name|dataBuffer
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MSB block size in bytes */
name|dataBuffer
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|dataBuffer
index|[
literal|6
index|]
operator|=
literal|0x02
expr_stmt|;
name|dataBuffer
index|[
literal|7
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LSB block size in bytes */
block|}
else|else
block|{
name|word118
operator|=
name|pSATAIdData
operator|->
name|word112_126
index|[
literal|6
index|]
expr_stmt|;
name|word117
operator|=
name|pSATAIdData
operator|->
name|word112_126
index|[
literal|5
index|]
expr_stmt|;
name|word117_118
operator|=
operator|(
name|word118
operator|<<
literal|16
operator|)
operator|+
name|word117
expr_stmt|;
name|word117_118
operator|=
name|word117_118
operator|*
literal|2
expr_stmt|;
name|dataBuffer
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|word117_118
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* MSB block size in bytes */
name|dataBuffer
index|[
literal|5
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|word117_118
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|6
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|word117_118
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|7
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|word117_118
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* LSB block size in bytes */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity10: Nondefault word118 %d 0x%x !!!\n"
operator|,
name|word118
operator|,
name|word118
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity10: Nondefault word117 %d 0x%x !!!\n"
operator|,
name|word117
operator|,
name|word117
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity10: Nondefault Block Length is %d 0x%x !!!\n"
operator|,
name|word117_118
operator|,
name|word117_118
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* fill in MAX LBA, which is used in satSendDiagnostic_1() */
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|4
index|]
operator|=
name|dataBuffer
index|[
literal|0
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|5
index|]
operator|=
name|dataBuffer
index|[
literal|1
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|6
index|]
operator|=
name|dataBuffer
index|[
literal|2
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|7
index|]
operator|=
name|dataBuffer
index|[
literal|3
index|]
expr_stmt|;
comment|/* LSB */
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadCapacity10: 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x , did %d\n"
operator|,
name|dataBuffer
index|[
literal|0
index|]
operator|,
name|dataBuffer
index|[
literal|1
index|]
operator|,
name|dataBuffer
index|[
literal|2
index|]
operator|,
name|dataBuffer
index|[
literal|3
index|]
operator|,
name|dataBuffer
index|[
literal|4
index|]
operator|,
name|dataBuffer
index|[
literal|5
index|]
operator|,
name|dataBuffer
index|[
literal|6
index|]
operator|,
name|dataBuffer
index|[
literal|7
index|]
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pVirtAddr
argument_list|,
name|dataBuffer
argument_list|,
name|MIN
argument_list|(
name|allocationLen
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
comment|/*    * Send the completion response now.    */
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatReadCapacity16
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit8
name|dataBuffer
index|[
literal|32
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bit8
modifier|*
name|pVirtAddr
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit32
name|lastLbaLo
decl_stmt|;
name|bit32
name|allocationLen
decl_stmt|;
name|bit32
name|readCapacityLen
init|=
literal|32
decl_stmt|;
name|bit32
name|i
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pVirtAddr
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|pSATAIdData
operator|=
operator|&
name|pSatDevData
operator|->
name|satIdentifyData
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReadCapacity16: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Find the buffer size allocated by Initiator */
name|allocationLen
operator|=
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
operator|)
operator|)
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
if|if
condition|(
name|allocationLen
operator|<
name|readCapacityLen
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity16: *** ERROR *** insufficient len=0x%x readCapacityLen=0x%x!!!\n"
operator|,
name|allocationLen
operator|,
name|readCapacityLen
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
endif|#
directive|endif
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity16: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*    * If Logical blcok address is not set to zero, return error    */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|||
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity16: *** ERROR *** logical address non zero, did %d\n"
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*    * If PMI bit is not zero, return error    */
if|if
condition|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|14
index|]
operator|)
operator|&
name|SCSI_READ_CAPACITY16_PMI_MASK
operator|)
operator|!=
literal|0
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity16: *** ERROR *** PMI is not zero, did %d\n"
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*     filling in Read Capacity parameter data   */
comment|/*    * If 48-bit addressing is supported, set capacity information from Identify    * Device Word 100-103.    */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|dataBuffer
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA48_63
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/* MSB */
name|dataBuffer
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA48_63
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA32_47
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA32_47
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|lastLbaLo
operator|=
operator|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|maxLBA16_31
operator|)
operator|<<
literal|16
operator|)
operator|)
operator||
operator|(
name|pSATAIdData
operator|->
name|maxLBA0_15
operator|)
expr_stmt|;
name|lastLbaLo
operator|=
name|lastLbaLo
operator|-
literal|1
expr_stmt|;
comment|/* LBA starts from zero */
name|dataBuffer
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|5
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|6
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|7
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* LSB */
block|}
comment|/*    * For 28-bit addressing, set capacity information from Identify    * Device Word 60-61.    */
else|else
block|{
name|dataBuffer
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|dataBuffer
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|dataBuffer
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|dataBuffer
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|lastLbaLo
operator|=
operator|(
operator|(
operator|(
name|pSATAIdData
operator|->
name|numOfUserAddressableSectorsHi
operator|)
operator|<<
literal|16
operator|)
operator|)
operator||
operator|(
name|pSATAIdData
operator|->
name|numOfUserAddressableSectorsLo
operator|)
expr_stmt|;
name|lastLbaLo
operator|=
name|lastLbaLo
operator|-
literal|1
expr_stmt|;
comment|/* LBA starts from zero */
name|dataBuffer
index|[
literal|4
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|5
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|6
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|dataBuffer
index|[
literal|7
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lastLbaLo
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* LSB */
block|}
comment|/*    * Set the block size, fixed at 512 bytes.    */
name|dataBuffer
index|[
literal|8
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* MSB block size in bytes */
name|dataBuffer
index|[
literal|9
index|]
operator|=
literal|0x00
expr_stmt|;
name|dataBuffer
index|[
literal|10
index|]
operator|=
literal|0x02
expr_stmt|;
name|dataBuffer
index|[
literal|11
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* LSB block size in bytes */
comment|/* fill in MAX LBA, which is used in satSendDiagnostic_1() */
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|0
index|]
operator|=
name|dataBuffer
index|[
literal|0
index|]
expr_stmt|;
comment|/* MSB */
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|1
index|]
operator|=
name|dataBuffer
index|[
literal|1
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|2
index|]
operator|=
name|dataBuffer
index|[
literal|2
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|3
index|]
operator|=
name|dataBuffer
index|[
literal|3
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|4
index|]
operator|=
name|dataBuffer
index|[
literal|4
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|5
index|]
operator|=
name|dataBuffer
index|[
literal|5
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|6
index|]
operator|=
name|dataBuffer
index|[
literal|6
index|]
expr_stmt|;
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|7
index|]
operator|=
name|dataBuffer
index|[
literal|7
index|]
expr_stmt|;
comment|/* LSB */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReadCapacity16: 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x , did %d\n"
operator|,
name|dataBuffer
index|[
literal|0
index|]
operator|,
name|dataBuffer
index|[
literal|1
index|]
operator|,
name|dataBuffer
index|[
literal|2
index|]
operator|,
name|dataBuffer
index|[
literal|3
index|]
operator|,
name|dataBuffer
index|[
literal|4
index|]
operator|,
name|dataBuffer
index|[
literal|5
index|]
operator|,
name|dataBuffer
index|[
literal|6
index|]
operator|,
name|dataBuffer
index|[
literal|7
index|]
operator|,
name|dataBuffer
index|[
literal|8
index|]
operator|,
name|dataBuffer
index|[
literal|9
index|]
operator|,
name|dataBuffer
index|[
literal|10
index|]
operator|,
name|dataBuffer
index|[
literal|11
index|]
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|allocationLen
operator|>
literal|0xC
condition|)
comment|/* 0xc = 12 */
block|{
for|for
control|(
name|i
operator|=
literal|12
init|;
name|i
operator|<=
literal|31
condition|;
name|i
operator|++
control|)
block|{
name|dataBuffer
index|[
name|i
index|]
operator|=
literal|0x00
expr_stmt|;
block|}
block|}
name|sm_memcpy
argument_list|(
name|pVirtAddr
argument_list|,
name|dataBuffer
argument_list|,
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|readCapacityLen
argument_list|)
argument_list|)
expr_stmt|;
comment|/*    * Send the completion response now.    */
if|if
condition|(
name|allocationLen
operator|>
name|readCapacityLen
condition|)
block|{
comment|/* underrun */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadCapacity16: reporting underrun readCapacityLen=0x%x allocationLen=0x%x !!!\n"
operator|,
name|readCapacityLen
operator|,
name|allocationLen
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|readCapacityLen
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatReportLun
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|bit8
name|dataBuffer
index|[
literal|16
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bit32
name|allocationLen
decl_stmt|;
name|bit32
name|reportLunLen
decl_stmt|;
name|smScsiReportLun_t
modifier|*
name|pReportLun
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
endif|#
directive|endif
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pReportLun
operator|=
operator|(
name|smScsiReportLun_t
operator|*
operator|)
name|dataBuffer
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
endif|#
directive|endif
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReportLun: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|//  smhexdump("smsatReportLun: cdb", (bit8 *)scsiCmnd, 16);
comment|/* Find the buffer size allocated by Initiator */
name|allocationLen
operator|=
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|)
operator|)
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
name|reportLunLen
operator|=
literal|16
expr_stmt|;
comment|/* 8 byte header and 8 bytes of LUN0 */
if|if
condition|(
name|allocationLen
operator|<
name|reportLunLen
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReportLun: *** ERROR *** insufficient len=0x%x did %d\n"
operator|,
name|reportLunLen
operator|,
name|pSatDevData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* Set length to one entry */
name|pReportLun
operator|->
name|len
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|len
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|len
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|len
index|[
literal|3
index|]
operator|=
sizeof|sizeof
argument_list|(
name|tiLUN_t
argument_list|)
expr_stmt|;
name|pReportLun
operator|->
name|reserved
operator|=
literal|0
expr_stmt|;
comment|/* Set to LUN 0:    * - address method to 0x00: Peripheral device addressing method,    * - bus identifier to 0    */
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|pReportLun
operator|->
name|lunList
index|[
literal|0
index|]
operator|.
name|lun
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|sm_memcpy
argument_list|(
name|smScsiRequest
operator|->
name|sglVirtualAddr
argument_list|,
name|dataBuffer
argument_list|,
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|reportLunLen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|allocationLen
operator|>
name|reportLunLen
condition|)
block|{
comment|/* underrun */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReportLun: reporting underrun reportLunLen=0x%x allocationLen=0x%x !!!\n"
operator|,
name|reportLunLen
operator|,
name|allocationLen
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|reportLunLen
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatFormatUnit
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     note: we don't support media certification in this version and IP bit     satDevData->satFormatState will be agFalse since SAT does not actually sends     any ATA command    */
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|index
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatFormatUnit: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*     checking opcode     1. FMTDATA bit == 0(no defect list header)     2. FMTDATA bit == 1 and DCRT bit == 1(defect list header is provided     with DCRT bit set)   */
if|if
condition|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_FMTDATA_MASK
operator|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_FMTDATA_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_DCRT_MASK
operator|)
operator|)
condition|)
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatFormatUnit: return opcode!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*     checking DEFECT LIST FORMAT and defect list length   */
if|if
condition|(
operator|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_DEFECT_LIST_FORMAT_MASK
operator|)
operator|==
literal|0x00
operator|)
operator|||
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_DEFECT_LIST_FORMAT_MASK
operator|)
operator|==
literal|0x06
operator|)
operator|)
condition|)
block|{
comment|/* short parameter header */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_FORMAT_UNIT_LONGLIST_MASK
operator|)
operator|==
literal|0x00
condition|)
block|{
name|index
operator|=
literal|8
expr_stmt|;
block|}
comment|/* long parameter header */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_FORMAT_UNIT_LONGLIST_MASK
operator|)
operator|==
literal|0x01
condition|)
block|{
name|index
operator|=
literal|10
expr_stmt|;
block|}
comment|/* defect list length */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
name|index
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
name|index
operator|+
literal|1
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatFormatUnit: return defect list format!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_FMTDATA_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_CMPLIST_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatFormatUnit: return cmplist!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatFormatUnit: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* defect list header filed, if exists, SAT rev8, Table 37, p48 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FORMAT_UNIT_FMTDATA_MASK
condition|)
block|{
comment|/* case 1,2,3 */
comment|/* IMMED 1; FOV 0; FOV 1, DCRT 1, IP 0 */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IMMED_MASK
operator|)
operator|||
operator|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_FOV_MASK
operator|)
operator|)
operator|||
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_FOV_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_DCRT_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IP_MASK
operator|)
operator|)
condition|)
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatFormatUnit: return defect list case 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* case 4,5,6 */
comment|/*         1. IMMED 0, FOV 1, DCRT 0, IP 0         2. IMMED 0, FOV 1, DCRT 0, IP 1         3. IMMED 0, FOV 1, DCRT 1, IP 1       */
if|if
condition|(
operator|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IMMED_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_FOV_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_DCRT_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IP_MASK
operator|)
operator|)
operator|||
operator|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IMMED_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_FOV_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_DCRT_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IP_MASK
operator|)
operator|)
operator|||
operator|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IMMED_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_FOV_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_DCRT_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|&
name|SCSI_FORMAT_UNIT_IP_MASK
operator|)
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatFormatUnit: return defect list case 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/*    * Send the completion response now.    */
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatFormatUnit: return last\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatSendDiagnostic
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|parmLen
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* reset satVerifyState */
name|pSatDevData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
comment|/* no pending diagnostic in background */
name|pSatDevData
operator|->
name|satBGPendingDiag
operator|=
name|agFALSE
expr_stmt|;
comment|/* table 27, 8.10 p39 SAT Rev8 */
comment|/*     1. checking PF == 1     2. checking DEVOFFL == 1     3. checking UNITOFFL == 1     4. checking PARAMETER LIST LENGTH != 0    */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_PF_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_DEVOFFL_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_UNITOFFL_MASK
operator|)
operator|||
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return PF, DEVOFFL, UNITOFFL, PARAM LIST!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|parmLen
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* checking SELFTEST bit*/
comment|/* table 29, 8.10.3, p41 SAT Rev8 */
comment|/* case 1 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agFALSE
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return Table 29 case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* case 2 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agFALSE
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_ATA_DEVICE_FEATURE_NOT_ENABLED
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return Table 29 case 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*     case 3      see SELF TEST CODE later   */
comment|/* case 4 */
comment|/*     sends three ATA verify commands    */
if|if
condition|(
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agFALSE
operator|)
operator|)
operator|||
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agFALSE
operator|)
operator|)
condition|)
block|{
comment|/*       sector count 1, LBA 0       sector count 1, LBA MAX       sector count 1, LBA random     */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSendDiagnosticCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return Table 29 case 4\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/* case 5 */
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
operator|)
condition|)
block|{
comment|/* sends SMART EXECUTE OFF-LINE IMMEDIATE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x81
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSendDiagnosticCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return Table 29 case 5\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/* SAT rev8 Table29 p41 case 3*/
comment|/* checking SELF TEST CODE*/
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_SELFTEST_MASK
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agTRUE
operator|)
condition|)
block|{
comment|/* SAT rev8 Table28 p40 */
comment|/* finding self-test code */
switch|switch
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SEND_DIAGNOSTIC_TEST_CODE_MASK
operator|)
operator|>>
literal|5
condition|)
block|{
case|case
literal|1
case|:
name|pSatDevData
operator|->
name|satBGPendingDiag
operator|=
name|agTRUE
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
comment|/* sends SMART EXECUTE OFF-LINE IMMEDIATE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.        */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSendDiagnosticCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.        */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return Table 28 case 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
case|case
literal|2
case|:
name|pSatDevData
operator|->
name|satBGPendingDiag
operator|=
name|agTRUE
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
comment|/* issuing SMART EXECUTE OFF-LINE IMMEDIATE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x02
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.        */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSendDiagnosticCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.        */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return Table 28 case 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
case|case
literal|4
case|:
if|if
condition|(
name|parmLen
operator|!=
literal|0
condition|)
block|{
comment|/* check condition */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnostic: case 4, non zero ParmLen %d!!!\n"
operator|,
name|parmLen
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satBGPendingDiag
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends SMART EXECUTE OFF-LINE IMMEDIATE abort */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x7F
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSendDiagnosticCB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: send SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: Table 28 case 4\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
else|else
block|{
comment|/* check condition */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnostic: case 4, no pending diagnostic in background!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: Table 28 case 4\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
break|break;
case|case
literal|5
case|:
comment|/* issuing SMART EXECUTE OFF-LINE IMMEDIATE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x81
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.        */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSendDiagnosticCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.        */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return Table 28 case 5\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
case|case
literal|6
case|:
comment|/* issuing SMART EXECUTE OFF-LINE IMMEDIATE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x82
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.        */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSendDiagnosticCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.        */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return Table 28 case 6\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
case|case
literal|0
case|:
case|case
literal|3
case|:
comment|/* fall through */
case|case
literal|7
case|:
comment|/* fall through */
default|default:
break|break;
block|}
comment|/* switch */
comment|/* returns the results of default self-testing, which is good */
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return Table 28 case 0,3,7 and default\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic: return last\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatStartStopUnit
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnit: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnit: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* Spec p55, Table 48 checking START and LOEJ bit */
comment|/* case 1 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_START_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_LOEJ_MASK
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
comment|/* immed bit , SAT rev 8, 9.11.2.1 p 54*/
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnit: return table48 case 1-1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* sends FLUSH CACHE or FLUSH CACHE EXT */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* FLUSH CACHE EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE_EXT
expr_stmt|;
comment|/* 0xEA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
block|}
else|else
block|{
comment|/* FLUSH CACHE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE
expr_stmt|;
comment|/* 0xE7 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatStartStopUnitCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnit: return table48 case 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/* case 2 */
elseif|else
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_START_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_LOEJ_MASK
operator|)
condition|)
block|{
comment|/* immed bit , SAT rev 8, 9.11.2.1 p 54*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnit: return table48 case 2 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*       sends READ_VERIFY_SECTORS(_EXT)       sector count 1, any LBA between zero to Maximum     */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x01
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0x00
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatStartStopUnitCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnit: return table48 case 2 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
comment|/* case 3 */
elseif|else
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_START_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|&
name|SCSI_LOEJ_MASK
operator|)
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satRemovableMedia
operator|&&
name|pSatDevData
operator|->
name|satRemovableMediaEnabled
condition|)
block|{
comment|/* support for removal media */
comment|/* immed bit , SAT rev 8, 9.11.2.1 p 54*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnit: return table48 case 3 1\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*         sends MEDIA EJECT       */
comment|/* Media Eject fis */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_MEDIA_EJECT
expr_stmt|;
comment|/* 0xED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* sector count zero */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.        */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatStartStopUnitCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.        */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
comment|/* no support for removal media */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnit: return Table 29 case 3 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* case 4 */
else|else
comment|/* ( (scsiCmnd->cdb[4]& SCSI_START_MASK)&& (scsiCmnd->cdb[4]& SCSI_LOEJ_MASK) ) */
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnit: return Table 29 case 4\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWriteSame10
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking LBDATA and PBDATA */
comment|/* case 1 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_LBDATA_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_PBDATA_MASK
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10: case 1\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* spec 9.26.2, Table 62, p64, case 1*/
comment|/*       normal case       just like write in 9.17.1     */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
comment|/*         writeSame10 but no support for 48 bit addressing         -> problem in transfer length. Therefore, return check condition       */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10: return internal checking!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* cdb10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*       note: As of 2/10/2006, no support for DMA QUEUED     */
comment|/*       Table 34, 9.1, p 46, b (footnote)       When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),       return check condition     */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
if|if
condition|(
name|lba
operator|>
name|SAT_TR_LBA_LIMIT
operator|-
literal|1
condition|)
comment|/* SAT_TR_LBA_LIMIT is 2^28, 0x10000000 */
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10: return LBA out of range!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
if|if
condition|(
name|lba
operator|+
name|tl
operator|<=
name|SAT_TR_LBA_LIMIT
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA */
comment|/* can't fit the transfer length since WRITE DMA has 1 byte for sector count */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10: case 1-2 !!! error due to writesame10!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS is chosen for easier implemetation */
comment|/* can't fit the transfer length since WRITE DMA has 1 byte for sector count */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10: case 1-1 !!! error due to writesame10!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* end of case 1 and 2 */
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
comment|/* WRITE DMA EXT is chosen since WRITE SAME does not have FUA bit */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10: case 1-3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* error check              ATA spec, p125, 6.17.29              pSatDevData->satMaxUserAddrSectors should be 0x0FFFFFFF              and allowed value is 0x0FFFFFFF - 1           */
if|if
condition|(
name|pSatDevData
operator|->
name|satMaxUserAddrSectors
operator|>
literal|0x0FFFFFFF
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10: case 3 !!! warning can't fit sectors!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* one sector at a time */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT is chosen for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10: case 1-4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* error check              ATA spec, p125, 6.17.29              pSatDevData->satMaxUserAddrSectors should be 0x0FFFFFFF              and allowed value is 0x0FFFFFFF - 1           */
if|if
condition|(
name|pSatDevData
operator|->
name|satMaxUserAddrSectors
operator|>
literal|0x0FFFFFFF
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10: case 4 !!! warning can't fit sectors!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* one sector at a time */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10: case 1-5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10: case 1-5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* error check            ATA spec, p125, 6.17.29            pSatDevData->satMaxUserAddrSectors should be 0x0FFFFFFF            and allowed value is 0x0FFFFFFF - 1         */
if|if
condition|(
name|pSatDevData
operator|->
name|satMaxUserAddrSectors
operator|>
literal|0x0FFFFFFF
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10: case 4 !!! warning can't fit sectors!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* one sector at a time */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* NO FUA bit in the WRITE SAME 10 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatWriteSame10CB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/* end of case 1 */
elseif|else
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_LBDATA_MASK
operator|)
operator|&&
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_PBDATA_MASK
operator|)
condition|)
block|{
comment|/* spec 9.26.2, Table 62, p64, case 2*/
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10: return Table 62 case 2\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_LBDATA_MASK
operator|)
operator|&&
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_SAME_PBDATA_MASK
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10: Table 62 case 3\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* ( (scsiCmnd->cdb[1]& SCSI_WRITE_SAME_LBDATA_MASK)&&             (scsiCmnd->cdb[1]& SCSI_WRITE_SAME_PBDATA_MASK)) */
block|{
comment|/* spec 9.26.2, Table 62, p64, case 4*/
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10: return Table 62 case 4\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWriteSame16
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame16: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame16: return internal checking!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatLogSense
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pLogPage
decl_stmt|;
comment|/* Log Page data buffer */
name|bit32
name|flag
init|=
literal|0
decl_stmt|;
name|bit16
name|AllocLen
init|=
literal|0
decl_stmt|;
comment|/* allocation length */
name|bit8
name|AllLogPages
index|[
literal|8
index|]
decl_stmt|;
name|bit16
name|lenRead
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: start\n"
operator|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
operator|&
name|AllLogPages
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSense: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|AllocLen
operator|=
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|)
expr_stmt|;
name|AllocLen
operator|=
name|MIN
argument_list|(
name|AllocLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
comment|/* checking PC (Page Control) */
comment|/* nothing */
comment|/* special cases */
if|if
condition|(
name|AllocLen
operator|==
literal|4
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSense: AllocLen is 4!!!\n"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_LOG_SENSE_PAGE_CODE_MASK
condition|)
block|{
case|case
name|LOGSENSE_SUPPORTED_LOG_PAGES
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case LOGSENSE_SUPPORTED_LOG_PAGES\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTFeatureSet
operator|==
name|agTRUE
condition|)
block|{
comment|/* add informational exception log */
name|flag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
condition|)
block|{
comment|/* add Self-Test results log page */
name|flag
operator|=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* only supported, no informational exception log, no  Self-Test results log page */
name|flag
operator|=
literal|0
expr_stmt|;
block|}
name|lenRead
operator|=
literal|4
expr_stmt|;
name|AllLogPages
index|[
literal|0
index|]
operator|=
name|LOGSENSE_SUPPORTED_LOG_PAGES
expr_stmt|;
comment|/* page code */
name|AllLogPages
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* reserved  */
switch|switch
condition|(
name|flag
condition|)
block|{
case|case
literal|0
case|:
comment|/* only supported */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
comment|/* page length */
break|break;
case|case
literal|1
case|:
comment|/* supported and informational exception log */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|2
expr_stmt|;
comment|/* page length */
break|break;
case|case
literal|2
case|:
comment|/* supported and informational exception log */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
comment|/* page length */
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSense: error unallowed flag value %d!!!\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|sm_memcpy
argument_list|(
name|pLogPage
argument_list|,
operator|&
name|AllLogPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
break|break;
case|case
name|LOGSENSE_SELFTEST_RESULTS_PAGE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case LOGSENSE_SUPPORTED_LOG_PAGES\n"
operator|)
argument_list|)
expr_stmt|;
name|lenRead
operator|=
literal|4
expr_stmt|;
name|AllLogPages
index|[
literal|0
index|]
operator|=
name|LOGSENSE_SELFTEST_RESULTS_PAGE
expr_stmt|;
comment|/* page code */
name|AllLogPages
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* reserved  */
comment|/* page length = SELFTEST_RESULTS_LOG_PAGE_LENGTH - 1 - 3 = 400 = 0x190 */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0x01
expr_stmt|;
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|0x90
expr_stmt|;
comment|/* page length */
name|sm_memcpy
argument_list|(
name|pLogPage
argument_list|,
operator|&
name|AllLogPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
break|break;
case|case
name|LOGSENSE_INFORMATION_EXCEPTIONS_PAGE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case LOGSENSE_SUPPORTED_LOG_PAGES\n"
operator|)
argument_list|)
expr_stmt|;
name|lenRead
operator|=
literal|4
expr_stmt|;
name|AllLogPages
index|[
literal|0
index|]
operator|=
name|LOGSENSE_INFORMATION_EXCEPTIONS_PAGE
expr_stmt|;
comment|/* page code */
name|AllLogPages
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* reserved  */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
name|INFORMATION_EXCEPTIONS_LOG_PAGE_LENGTH
operator|-
literal|1
operator|-
literal|3
expr_stmt|;
comment|/* page length */
name|sm_memcpy
argument_list|(
name|pLogPage
argument_list|,
operator|&
name|AllLogPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSense: default Page Code 0x%x!!!\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_LOG_SENSE_PAGE_CODE_MASK
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* if */
comment|/* SAT rev8 Table 11  p30*/
comment|/* checking Page Code */
switch|switch
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_LOG_SENSE_PAGE_CODE_MASK
condition|)
block|{
case|case
name|LOGSENSE_SUPPORTED_LOG_PAGES
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case 1\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTFeatureSet
operator|==
name|agTRUE
condition|)
block|{
comment|/* add informational exception log */
name|flag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agTRUE
condition|)
block|{
comment|/* add Self-Test results log page */
name|flag
operator|=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* only supported, no informational exception log, no  Self-Test results log page */
name|flag
operator|=
literal|0
expr_stmt|;
block|}
name|AllLogPages
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page code */
name|AllLogPages
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* reserved  */
switch|switch
condition|(
name|flag
condition|)
block|{
case|case
literal|0
case|:
comment|/* only supported */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* supported page list */
name|lenRead
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|AllocLen
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* supported and informational exception log */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|2
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* supported page list */
name|AllLogPages
index|[
literal|5
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* supported page list */
name|lenRead
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|AllocLen
argument_list|,
literal|6
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* supported and informational exception log */
name|AllLogPages
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
comment|/* page length */
name|AllLogPages
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
comment|/* supported page list */
name|AllLogPages
index|[
literal|5
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* supported page list */
name|AllLogPages
index|[
literal|6
index|]
operator|=
literal|0x2F
expr_stmt|;
comment|/* supported page list */
name|lenRead
operator|=
call|(
name|bit8
call|)
argument_list|(
name|MIN
argument_list|(
name|AllocLen
argument_list|,
literal|7
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSense: error unallowed flag value %d!!!\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|sm_memcpy
argument_list|(
name|pLogPage
argument_list|,
operator|&
name|AllLogPages
argument_list|,
name|lenRead
argument_list|)
expr_stmt|;
comment|/* comparing allocation length to Log Page byte size */
comment|/* SPC-4, 4.3.4.6, p28 */
if|if
condition|(
name|AllocLen
operator|>
name|lenRead
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSense: reporting underrun lenRead=0x%x AllocLen=0x%x!!!\n"
operator|,
name|lenRead
operator|,
name|AllocLen
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|AllocLen
operator|-
name|lenRead
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|LOGSENSE_SELFTEST_RESULTS_PAGE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case 2\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking SMART self-test */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTSelfTest
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case 2 no SMART Self Test\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* if satSMARTEnabled is false, send SMART_ENABLE_OPERATIONS */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case 2 calling satSMARTEnable\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatLogSenseAllocate
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|,
literal|0
argument_list|,
name|LOG_SENSE_0
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
comment|/* SAT Rev 8, 10.2.4 p74 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case 2-1 sends READ LOG EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatLogSenseAllocate
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|,
literal|512
argument_list|,
name|LOG_SENSE_1
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case 2-2 sends SMART READ LOG\n"
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatLogSenseAllocate
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|,
literal|512
argument_list|,
name|LOG_SENSE_2
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
block|}
break|break;
case|case
name|LOGSENSE_INFORMATION_EXCEPTIONS_PAGE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case 3\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking SMART feature set */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTFeatureSet
operator|==
name|agFALSE
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* checking SMART feature enabled */
if|if
condition|(
name|pSatDevData
operator|->
name|satSMARTEnabled
operator|==
name|agFALSE
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_ATA_DEVICE_FEATURE_NOT_ENABLED
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT Rev 8, 10.2.3 p72 */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense: case 3 sends SMART RETURN STATUS\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART RETURN STATUS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_RETURN_STATUS
expr_stmt|;
comment|/* FIS features */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.            */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatLogSenseCB
expr_stmt|;
comment|/*            * Prepare SGL and send FIS to LL layer.            */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSense: default Page Code 0x%x!!!\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
name|SCSI_LOG_SENSE_PAGE_CODE_MASK
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* end switch */
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatLogSenseAllocate
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smSCSIRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|payloadSize
parameter_list|,
name|bit32
name|flag
parameter_list|)
block|{
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext2
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSenseAllocate: start\n"
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
comment|/* create internal satIOContext */
name|satIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
comment|/* original request */
name|pSatDevData
argument_list|,
name|payloadSize
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseAllocate: fail in allocation!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* end of memory allocation failure */
name|satIntIo
operator|->
name|satOrgSmIORequest
operator|=
name|smIORequest
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSatDevData
operator|=
name|pSatDevData
expr_stmt|;
name|satIOContext2
operator|->
name|pFis
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSense
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSmSenseData
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSmSenseData
operator|->
name|senseData
operator|=
name|satIOContext2
operator|->
name|pSense
expr_stmt|;
name|satIOContext2
operator|->
name|smRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|->
name|interruptContext
operator|=
name|satIOContext
operator|->
name|interruptContext
expr_stmt|;
name|satIOContext2
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satIOContext2
operator|->
name|psmDeviceHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext2
operator|->
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
if|if
condition|(
name|flag
operator|==
name|LOG_SENSE_0
condition|)
block|{
comment|/* SAT_SMART_ENABLE_OPERATIONS */
name|status
operator|=
name|smsatSMARTEnable
argument_list|(
name|smRoot
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmIORequest
operator|)
argument_list|,
name|smDeviceHandle
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|)
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
name|LOG_SENSE_1
condition|)
block|{
comment|/* SAT_READ_LOG_EXT */
name|status
operator|=
name|smsatLogSense_2
argument_list|(
name|smRoot
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmIORequest
operator|)
argument_list|,
name|smDeviceHandle
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|)
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_SMART_READ_LOG */
comment|/* SAT_READ_LOG_EXT */
name|status
operator|=
name|smsatLogSense_3
argument_list|(
name|smRoot
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmIORequest
operator|)
argument_list|,
name|smDeviceHandle
argument_list|,
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|)
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatSMARTEnable
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSMARTEnable: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the SAT_SMART_ENABLE_OPERATIONS command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_ENABLE_OPERATIONS
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSMARTEnableCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatLogSense_2
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense_2: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends READ LOG EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_LOG_EXT
expr_stmt|;
comment|/* 0x2F */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x07
expr_stmt|;
comment|/* 0x07 */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x01
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x00
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatLogSenseCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatLogSense_3
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense_3: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends READ LOG EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0x2F */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_READ_LOG
expr_stmt|;
comment|/* 0xd5 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x06
expr_stmt|;
comment|/* 0x06 */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* 0x4f */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* 0xc2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x01
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x00
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatLogSenseCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatModeSelect6
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pLogPage
decl_stmt|;
comment|/* Log Page data buffer */
name|bit32
name|StartingIndex
init|=
literal|0
decl_stmt|;
name|bit8
name|PageCode
init|=
literal|0
decl_stmt|;
name|bit32
name|chkCnd
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|parameterListLen
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking PF bit */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_MODE_SELECT6_PF_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6: PF bit check!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|parameterListLen
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|parameterListLen
operator|=
name|MIN
argument_list|(
name|parameterListLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
literal|0
operator|==
name|parameterListLen
operator|)
operator|||
operator|(
name|agNULL
operator|==
name|pLogPage
operator|)
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking Block Descriptor Length on Mode parameter header(6)*/
if|if
condition|(
name|pLogPage
index|[
literal|3
index|]
operator|==
literal|8
condition|)
block|{
comment|/* mode parameter block descriptor exists */
name|PageCode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pLogPage
index|[
literal|12
index|]
operator|&
literal|0x3F
argument_list|)
expr_stmt|;
comment|/* page code and index is 4 + 8 */
name|StartingIndex
operator|=
literal|12
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pLogPage
index|[
literal|3
index|]
operator|==
literal|0
condition|)
block|{
comment|/* mode parameter block descriptor does not exist */
name|PageCode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pLogPage
index|[
literal|4
index|]
operator|&
literal|0x3F
argument_list|)
expr_stmt|;
comment|/* page code and index is 4 + 0 */
name|StartingIndex
operator|=
literal|4
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6: return mode parameter block descriptor 0x%x!!!\n"
operator|,
name|pLogPage
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
switch|switch
condition|(
name|PageCode
condition|)
comment|/* page code */
block|{
case|case
name|MODESELECT_CONTROL_PAGE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6: Control mode page!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|1
index|]
operator|!=
literal|0x0A
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|!=
literal|0x02
operator|||
operator|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
operator|&&
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|!=
literal|0x12
operator|)
operator|||
operator|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agFALSE
operator|&&
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|!=
literal|0x02
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT3_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* SWP bit */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT4_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* UA_INTLCK_CTRL */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT5_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* UA_INTLCK_CTRL */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT0_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT1_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT2_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT6_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* TAS bit */
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|8
index|]
operator|!=
literal|0xFF
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|9
index|]
operator|!=
literal|0xFF
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|!=
literal|0x00
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|!=
literal|0x00
condition|)
block|{
name|chkCnd
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|chkCnd
operator|==
name|agTRUE
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6: unexpected values!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|SM_RC_SUCCESS
return|;
break|break;
case|case
name|MODESELECT_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6: Read-Write Error Recovery mode page!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_AWRE_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_RC_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_EER_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_PER_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_DTE_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_DCR_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6: return check condition\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6: return GOOD \n"
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
break|break;
case|case
name|MODESELECT_CACHING
case|:
comment|/* SAT rev8 Table67, p69*/
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6: Caching mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
literal|0xFB
operator|)
operator|||
comment|/* 1111 1011 */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|6
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|7
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|8
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|9
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|12
index|]
operator|&
literal|0xC1
operator|)
operator|||
comment|/* 1100 0001 */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|13
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|14
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|15
index|]
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6: return check condition!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
comment|/* sends ATA SET FEATURES based on WCE bit */
if|if
condition|(
operator|!
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_WCE_MASK
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6: disable write cache\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x82
expr_stmt|;
comment|/* disable write cache */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6: enable write cache\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x02
expr_stmt|;
comment|/* enable write cache */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
break|break;
case|case
name|MODESELECT_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6: Informational Exception Control mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_PERF_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT6_TEST_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6: return check condition!!! \n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
comment|/* sends either ATA SMART ENABLE/DISABLE OPERATIONS based on DEXCPT bit */
if|if
condition|(
operator|!
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
literal|0x08
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6: enable information exceptions reporting\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART ENABLE OPERATIONS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_ENABLE_OPERATIONS
expr_stmt|;
comment|/* enable */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* 0x4F */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* 0xC2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6: disable information exceptions reporting\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART DISABLE OPERATIONS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_DISABLE_OPERATIONS
expr_stmt|;
comment|/* disable */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* 0x4F */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* 0xC2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6: Error unknown page code 0x%x!!!\n"
operator|,
name|pLogPage
index|[
literal|12
index|]
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatModeSelect10
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pLogPage
decl_stmt|;
comment|/* Log Page data buffer */
name|bit16
name|BlkDescLen
init|=
literal|0
decl_stmt|;
comment|/* Block Descriptor Length */
name|bit32
name|StartingIndex
init|=
literal|0
decl_stmt|;
name|bit8
name|PageCode
init|=
literal|0
decl_stmt|;
name|bit32
name|chkCnd
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|parameterListLen
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking PF bit */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_MODE_SELECT10_PF_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect10: PF bit check!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|parameterListLen
operator|=
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|)
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|parameterListLen
operator|=
name|MIN
argument_list|(
name|parameterListLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
literal|0
operator|==
name|parameterListLen
operator|)
operator|||
operator|(
name|agNULL
operator|==
name|pLogPage
operator|)
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|BlkDescLen
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|pLogPage
index|[
literal|6
index|]
operator|<<
literal|8
operator|)
operator|+
name|pLogPage
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
comment|/* checking Block Descriptor Length on Mode parameter header(10) and LONGLBA bit*/
if|if
condition|(
operator|(
name|BlkDescLen
operator|==
literal|8
operator|)
operator|&&
operator|!
operator|(
name|pLogPage
index|[
literal|4
index|]
operator|&
name|SCSI_MODE_SELECT10_LONGLBA_MASK
operator|)
condition|)
block|{
comment|/* mode parameter block descriptor exists and length is 8 byte */
name|PageCode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pLogPage
index|[
literal|16
index|]
operator|&
literal|0x3F
argument_list|)
expr_stmt|;
comment|/* page code and index is 8 + 8 */
name|StartingIndex
operator|=
literal|16
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|BlkDescLen
operator|==
literal|16
operator|)
operator|&&
operator|(
name|pLogPage
index|[
literal|4
index|]
operator|&
name|SCSI_MODE_SELECT10_LONGLBA_MASK
operator|)
condition|)
block|{
comment|/* mode parameter block descriptor exists and length is 16 byte */
name|PageCode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pLogPage
index|[
literal|24
index|]
operator|&
literal|0x3F
argument_list|)
expr_stmt|;
comment|/* page code and index is 8 + 16 */
name|StartingIndex
operator|=
literal|24
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|BlkDescLen
operator|==
literal|0
condition|)
block|{
name|PageCode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|pLogPage
index|[
literal|8
index|]
operator|&
literal|0x3F
argument_list|)
expr_stmt|;
comment|/* page code and index is 8 + 0 */
name|StartingIndex
operator|=
literal|8
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect10: return mode parameter block descriptor 0x%x!!!\n"
operator|,
name|BlkDescLen
operator|)
argument_list|)
expr_stmt|;
comment|/* no more than one mode parameter block descriptor shall be supported */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/*     for debugging only   */
if|if
condition|(
name|StartingIndex
operator|==
literal|8
condition|)
block|{
name|smhexdump
argument_list|(
literal|"startingindex 8"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pLogPage
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|StartingIndex
operator|==
literal|16
condition|)
block|{
if|if
condition|(
name|PageCode
operator|==
name|MODESELECT_CACHING
condition|)
block|{
name|smhexdump
argument_list|(
literal|"startingindex 16"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pLogPage
argument_list|,
literal|16
operator|+
literal|20
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smhexdump
argument_list|(
literal|"startingindex 16"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pLogPage
argument_list|,
literal|16
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|PageCode
operator|==
name|MODESELECT_CACHING
condition|)
block|{
name|smhexdump
argument_list|(
literal|"startingindex 24"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pLogPage
argument_list|,
literal|24
operator|+
literal|20
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smhexdump
argument_list|(
literal|"startingindex 24"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pLogPage
argument_list|,
literal|24
operator|+
literal|12
argument_list|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|PageCode
condition|)
comment|/* page code */
block|{
case|case
name|MODESELECT_CONTROL_PAGE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect10: Control mode page\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*       compare pLogPage to expected value (SAT Table 65, p67)       If not match, return check condition      */
if|if
condition|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|1
index|]
operator|!=
literal|0x0A
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|!=
literal|0x02
operator|||
operator|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
operator|&&
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|!=
literal|0x12
operator|)
operator|||
operator|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agFALSE
operator|&&
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|!=
literal|0x02
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT3_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* SWP bit */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT4_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* UA_INTLCK_CTRL */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|&
name|BIT5_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* UA_INTLCK_CTRL */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT0_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT1_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT2_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* AUTOLOAD MODE */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|&
name|BIT6_MASK
operator|)
operator|!=
literal|0x00
operator|||
comment|/* TAS bit */
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|8
index|]
operator|!=
literal|0xFF
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|9
index|]
operator|!=
literal|0xFF
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|!=
literal|0x00
operator|||
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|!=
literal|0x00
condition|)
block|{
name|chkCnd
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|chkCnd
operator|==
name|agTRUE
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect10: unexpected values!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return
name|SM_RC_SUCCESS
return|;
break|break;
case|case
name|MODESELECT_READ_WRITE_ERROR_RECOVERY_PAGE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect10: Read-Write Error Recovery mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_AWRE_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_RC_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_EER_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_PER_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_DTE_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_DCR_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect10: return check condition!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatModeSelect10: return GOOD \n"
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
break|break;
case|case
name|MODESELECT_CACHING
case|:
comment|/* SAT rev8 Table67, p69*/
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect10: Caching mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
literal|0xFB
operator|)
operator|||
comment|/* 1111 1011 */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|3
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|4
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|5
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|6
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|7
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|8
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|9
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|10
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|11
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|12
index|]
operator|&
literal|0xC1
operator|)
operator|||
comment|/* 1100 0001 */
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|13
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|14
index|]
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|15
index|]
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect10: return check condition!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
comment|/* sends ATA SET FEATURES based on WCE bit */
if|if
condition|(
operator|!
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_WCE_MASK
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect10: disable write cache\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x82
expr_stmt|;
comment|/* disable write cache */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect10: enable write cache\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x02
expr_stmt|;
comment|/* enable write cache */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
break|break;
case|case
name|MODESELECT_INFORMATION_EXCEPTION_CONTROL_PAGE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect10: Informational Exception Control mode page\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_PERF_MASK
operator|)
operator|||
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_TEST_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect10: return check condition!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_PARAMETER_LIST
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
comment|/* sends either ATA SMART ENABLE/DISABLE OPERATIONS based on DEXCPT bit */
if|if
condition|(
operator|!
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|2
index|]
operator|&
name|SCSI_MODE_SELECT10_DEXCPT_MASK
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect10: enable information exceptions reporting\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART ENABLE OPERATIONS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_ENABLE_OPERATIONS
expr_stmt|;
comment|/* enable */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* 0x4F */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* 0xC2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect10: disable information exceptions reporting\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART DISABLE OPERATIONS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0xB0 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_DISABLE_OPERATIONS
expr_stmt|;
comment|/* disable */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x4F
expr_stmt|;
comment|/* 0x4F */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0xC2
expr_stmt|;
comment|/* 0xC2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.          */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatModeSelect6n10CB
expr_stmt|;
comment|/*          * Prepare SGL and send FIS to LL layer.          */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect10: Error unknown page code 0x%x!!!\n"
operator|,
name|pLogPage
index|[
literal|12
index|]
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatSynchronizeCache10
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSynchronizeCache10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking IMMED bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SYNC_CACHE_IMMED_MASK
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10: GOOD status due to IMMED bit!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* return GOOD status first here */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
comment|/* sends FLUSH CACHE or FLUSH CACHE EXT */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSynchronizeCache10: sends FLUSH CACHE EXT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* FLUSH CACHE EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE_EXT
expr_stmt|;
comment|/* 0xEA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSynchronizeCache10: sends FLUSH CACHE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* FLUSH CACHE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE
expr_stmt|;
comment|/* 0xE7 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSynchronizeCache10n16CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatSynchronizeCache16
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSynchronizeCache10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking IMMED bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_SYNC_CACHE_IMMED_MASK
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10: GOOD status due to IMMED bit!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* return GOOD status first here */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
comment|/* sends FLUSH CACHE or FLUSH CACHE EXT */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSynchronizeCache10: sends FLUSH CACHE EXT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* FLUSH CACHE EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE_EXT
expr_stmt|;
comment|/* 0xEA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSynchronizeCache10: sends FLUSH CACHE\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* FLUSH CACHE */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_FLUSH_CACHE
expr_stmt|;
comment|/* 0xE7 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS DEV is discared in SATA */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSynchronizeCache10n16CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWriteAndVerify10
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     combination of write10 and verify10   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking BYTCHK bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_N_VERIFY_BYTCHK_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: BYTCHK bit checking!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
comment|/* cbd10; computing LBA and transfer length */
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: return LBA out of range!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* can't fit the transfer length */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* can't fit the transfer length */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_N_VERIFY10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedWriteNVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify10: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedWriteNVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWriteAndVerify12
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     combination of write12 and verify12     temp: since write12 is not support (due to internal checking), no support   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking BYTCHK bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_N_VERIFY_BYTCHK_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: BYTCHK bit checking!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|lba
operator|=
name|smsatComputeCDB12LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|smsatComputeCDB12TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED    */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* In case that we can't fit the transfer length, we loop */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* In case that we can't fit the transfer length, we loop */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE12_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
comment|//  satIOContext->OrgLBA = lba;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
name|satIOContext
operator|->
name|LoopNum2
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedWriteNVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify12: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedWriteNVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWriteAndVerify16
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     combination of write16 and verify16     since write16 has 8 bytes LBA -> problem ATA LBA(upto 6 bytes), no support   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|AllChk
init|=
name|agFALSE
decl_stmt|;
comment|/* lba, lba+tl check against ATA limit and Disk capacity */
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking BYTCHK bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE_N_VERIFY_BYTCHK_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: BYTCHK bit checking!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|15
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|TL
index|[
literal|4
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|5
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
expr_stmt|;
name|TL
index|[
literal|6
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
name|TL
index|[
literal|7
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* LSB */
name|lba
operator|=
name|smsatComputeCDB16LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|smsatComputeCDB16TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* Table 34, 9.1, p 46 */
comment|/*     note: As of 2/10/2006, no support for DMA QUEUED   */
comment|/*     Table 34, 9.1, p 46, b     When no 48-bit addressing support or NCQ, if LBA is beyond (2^28 - 1),     return check condition   */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|!=
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agFALSE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: return LBA out of range, not EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|AllChk
operator|=
name|smsatCheckLimit
argument_list|(
name|LBA
argument_list|,
name|TL
argument_list|,
name|agTRUE
argument_list|,
name|pSatDevData
argument_list|)
expr_stmt|;
if|if
condition|(
name|AllChk
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: return LBA out of range, EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
comment|/* case 1 and 2 */
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* In case that we can't fit the transfer length, we loop */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* In case that we can't fit the transfer length, we loop */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: case 5 !!! error NCQ but 28 bit address support!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE16_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUEDK */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedWriteNVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteAndVerify16: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_FUA_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedWriteNVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatReadMediaSerialNumber
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_PIO_READ
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit8
modifier|*
name|pSerialNumber
decl_stmt|;
name|bit8
name|MediaSerialNumber
index|[
literal|64
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|bit32
name|allocationLen
init|=
literal|0
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pSATAIdData
operator|=
operator|&
operator|(
name|pSatDevData
operator|->
name|satIdentifyData
operator|)
expr_stmt|;
name|pSerialNumber
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumber: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumber: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|allocationLen
operator|=
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
operator|(
name|bit32
operator|)
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|)
operator|)
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|allocationLen
operator|==
literal|4
condition|)
block|{
if|if
condition|(
name|pSATAIdData
operator|->
name|commandSetFeatureDefault
operator|&
literal|0x4
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumber: Media serial number returning only length!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* SPC-3 6.16 p192; filling in length */
name|MediaSerialNumber
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|3
index|]
operator|=
literal|0x3C
expr_stmt|;
block|}
else|else
block|{
comment|/* 1 sector - 4 = 512 - 4 to avoid underflow; 0x1fc*/
name|MediaSerialNumber
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|2
index|]
operator|=
literal|0x1
expr_stmt|;
name|MediaSerialNumber
index|[
literal|3
index|]
operator|=
literal|0xfc
expr_stmt|;
block|}
name|sm_memcpy
argument_list|(
name|pSerialNumber
argument_list|,
name|MediaSerialNumber
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|IDDeviceValid
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSATAIdData
operator|->
name|commandSetFeatureDefault
operator|&
literal|0x4
condition|)
block|{
comment|/* word87 bit2 Media serial number is valid */
comment|/* read word 176 to 205; length is 2*30 = 60 = 0x3C*/
ifdef|#
directive|ifdef
name|LOG_ENABLE
name|smhexdump
argument_list|(
literal|"ID smsatReadMediaSerialNumber"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pSATAIdData
operator|->
name|currentMediaSerialNumber
argument_list|,
literal|2
operator|*
literal|30
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SPC-3 6.16 p192; filling in length */
name|MediaSerialNumber
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|3
index|]
operator|=
literal|0x3C
expr_stmt|;
name|sm_memcpy
argument_list|(
operator|&
name|MediaSerialNumber
index|[
literal|4
index|]
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pSATAIdData
operator|->
name|currentMediaSerialNumber
argument_list|,
literal|60
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|LOG_ENABLE
name|smhexdump
argument_list|(
literal|"smsatReadMediaSerialNumber"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|MediaSerialNumber
argument_list|,
literal|2
operator|*
literal|30
operator|+
literal|4
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sm_memcpy
argument_list|(
name|pSerialNumber
argument_list|,
name|MediaSerialNumber
argument_list|,
name|MIN
argument_list|(
name|allocationLen
argument_list|,
literal|64
argument_list|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
comment|/* word87 bit2 Media serial number is NOT valid */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumber: Media serial number is NOT valid!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* READ VERIFY SECTORS EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTORS */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
block|}
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatReadMediaSerialNumberCB
expr_stmt|;
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatReadBuffer
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
init|=
name|SM_RC_SUCCESS
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_PIO_READ
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|bufferOffset
decl_stmt|;
name|bit32
name|tl
decl_stmt|;
name|bit8
name|mode
decl_stmt|;
name|bit8
name|bufferID
decl_stmt|;
name|bit8
modifier|*
name|pBuff
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pBuff
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReadBuffer: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadBuffer: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|bufferOffset
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|mode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ_BUFFER_MODE_MASK
argument_list|)
expr_stmt|;
name|bufferID
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|READ_BUFFER_DATA_MODE
condition|)
comment|/* 2 */
block|{
if|if
condition|(
name|bufferID
operator|==
literal|0
operator|&&
name|bufferOffset
operator|==
literal|0
operator|&&
name|tl
operator|==
literal|512
condition|)
block|{
comment|/* send ATA READ BUFFER */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_BUFFER
expr_stmt|;
comment|/* 0xE4 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatReadBufferCB
expr_stmt|;
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|bufferID
operator|==
literal|0
operator|&&
name|bufferOffset
operator|==
literal|0
operator|&&
name|tl
operator|!=
literal|512
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadBuffer: allocation length is not 512; it is %d!!!\n"
operator|,
name|tl
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
if|if
condition|(
name|bufferID
operator|==
literal|0
operator|&&
name|bufferOffset
operator|!=
literal|0
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadBuffer: buffer offset is not 0; it is %d!!!\n"
operator|,
name|bufferOffset
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* all other cases unsupported */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadBuffer: unsupported case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
name|READ_BUFFER_DESCRIPTOR_MODE
condition|)
comment|/* 3 */
block|{
if|if
condition|(
name|tl
operator|<
name|READ_BUFFER_DESCRIPTOR_MODE_DATA_LEN
condition|)
comment|/* 4 */
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadBuffer: tl< 4; tl is %d!!!\n"
operator|,
name|tl
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
if|if
condition|(
name|bufferID
operator|==
literal|0
condition|)
block|{
comment|/* SPC-4, 6.15.5, p189; SAT-2 Rev00, 8.7.2.3, p41*/
name|pBuff
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
name|pBuff
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
name|pBuff
index|[
literal|2
index|]
operator|=
literal|0x02
expr_stmt|;
name|pBuff
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
if|if
condition|(
name|READ_BUFFER_DESCRIPTOR_MODE_DATA_LEN
operator|<
name|tl
condition|)
block|{
comment|/* underrrun */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadBuffer: underrun tl %d data %d!!!\n"
operator|,
name|tl
operator|,
name|READ_BUFFER_DESCRIPTOR_MODE_DATA_LEN
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|tl
operator|-
name|READ_BUFFER_DESCRIPTOR_MODE_DATA_LEN
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
comment|/* We don't support other than bufferID 0 */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
else|else
block|{
comment|/* We don't support any other mode */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadBuffer: unsupported mode %d!!!\n"
operator|,
name|mode
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWriteBuffer
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|NOT_YET
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_PIO_READ
decl_stmt|;
endif|#
directive|endif
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
endif|#
directive|endif
name|bit32
name|bufferOffset
decl_stmt|;
name|bit32
name|parmLen
decl_stmt|;
name|bit8
name|mode
decl_stmt|;
name|bit8
name|bufferID
decl_stmt|;
name|bit8
modifier|*
name|pBuff
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
endif|#
directive|endif
name|pBuff
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteBuffer: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteBuffer: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|bufferOffset
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|parmLen
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|mode
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ_BUFFER_MODE_MASK
argument_list|)
expr_stmt|;
name|bufferID
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* for debugging only */
name|smhexdump
argument_list|(
literal|"smsatWriteBuffer pBuff"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pBuff
argument_list|,
literal|24
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|WRITE_BUFFER_DATA_MODE
condition|)
comment|/* 2 */
block|{
if|if
condition|(
name|bufferID
operator|==
literal|0
operator|&&
name|bufferOffset
operator|==
literal|0
operator|&&
name|parmLen
operator|==
literal|512
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteBuffer: sending ATA WRITE BUFFER!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* send ATA WRITE BUFFER */
ifdef|#
directive|ifdef
name|NOT_YET
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_BUFFER
expr_stmt|;
comment|/* 0xE8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatWriteBufferCB
expr_stmt|;
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
endif|#
directive|endif
comment|/* temp */
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
if|if
condition|(
operator|(
name|bufferID
operator|==
literal|0
operator|&&
name|bufferOffset
operator|!=
literal|0
operator|)
operator|||
operator|(
name|bufferID
operator|==
literal|0
operator|&&
name|parmLen
operator|!=
literal|512
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteBuffer: wrong buffer offset %d or parameter length parmLen %d!!!\n"
operator|,
name|bufferOffset
operator|,
name|parmLen
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
comment|/* all other cases unsupported */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteBuffer: unsupported case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
name|WRITE_BUFFER_DL_MICROCODE_SAVE_MODE
condition|)
comment|/* 5 */
block|{
comment|/* temporary */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteBuffer: not yet supported mode %d!!!\n"
operator|,
name|mode
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
else|else
block|{
comment|/* We don't support any other mode */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteBuffer: unsupported mode %d!!!\n"
operator|,
name|mode
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_COMMAND
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatReassignBlocks
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     assumes all LBA fits in ATA command; no boundary condition is checked here yet   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pParmList
decl_stmt|;
comment|/* Log Page data buffer */
name|bit8
name|LongLBA
decl_stmt|;
name|bit8
name|LongList
decl_stmt|;
name|bit32
name|defectListLen
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|startingIndex
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pParmList
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocks: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking CONTROL */
comment|/* NACA == 1 or LINK == 1*/
if|if
condition|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_NACA_MASK
operator|)
operator|||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|&
name|SCSI_LINK_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocks: return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|sm_memset
argument_list|(
name|satIOContext
operator|->
name|LBA
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|ParmIndex
operator|=
literal|0
expr_stmt|;
name|satIOContext
operator|->
name|ParmLen
operator|=
literal|0
expr_stmt|;
name|LongList
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_REASSIGN_BLOCKS_LONGLIST_MASK
argument_list|)
expr_stmt|;
name|LongLBA
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_REASSIGN_BLOCKS_LONGLBA_MASK
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|LongList
operator|==
literal|0
condition|)
block|{
name|defectListLen
operator|=
operator|(
name|pParmList
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
name|pParmList
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
block|{
name|defectListLen
operator|=
operator|(
name|pParmList
index|[
literal|0
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|pParmList
index|[
literal|1
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|pParmList
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
name|pParmList
index|[
literal|3
index|]
expr_stmt|;
block|}
comment|/* SBC 5.16.2, p61*/
name|satIOContext
operator|->
name|ParmLen
operator|=
name|defectListLen
operator|+
literal|4
comment|/* header size */
expr_stmt|;
name|startingIndex
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|LongLBA
operator|==
literal|0
condition|)
block|{
name|LBA
index|[
literal|4
index|]
operator|=
name|pParmList
index|[
name|startingIndex
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|5
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|1
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|3
index|]
expr_stmt|;
comment|/* LSB */
name|startingIndex
operator|=
name|startingIndex
operator|+
literal|4
expr_stmt|;
block|}
else|else
block|{
name|LBA
index|[
literal|0
index|]
operator|=
name|pParmList
index|[
name|startingIndex
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|1
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|7
index|]
expr_stmt|;
comment|/* LSB */
name|startingIndex
operator|=
name|startingIndex
operator|+
literal|8
expr_stmt|;
block|}
name|smhexdump
argument_list|(
literal|"smsatReassignBlocks Parameter list"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pParmList
argument_list|,
literal|4
operator|+
name|defectListLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|4
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* DEV and LBA 27:24 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|sm_memcpy
argument_list|(
name|satIOContext
operator|->
name|LBA
argument_list|,
name|LBA
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|ParmIndex
operator|=
name|startingIndex
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatReassignBlocksCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatRead_1
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     Assumption: error check on lba and tl has been done in satRead*()     lba = lba + tl;   */
name|bit32
name|status
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|agNULL
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_READ
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|DenomTL
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|Remainder
init|=
literal|0
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
comment|/* 0 MSB, 3 LSB */
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatRead_1: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_DMA
case|:
name|DenomTL
operator|=
literal|0x100
expr_stmt|;
break|break;
case|case
name|SAT_READ_SECTORS
case|:
name|DenomTL
operator|=
literal|0x100
expr_stmt|;
break|break;
case|case
name|SAT_READ_DMA_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_READ_SECTORS_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_READ_FPDMA_QUEUED
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead_1: error incorrect ata command 0x%x!!!\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
break|break;
block|}
name|Remainder
operator|=
name|satOrgIOContext
operator|->
name|OrgTL
operator|%
name|DenomTL
expr_stmt|;
name|satOrgIOContext
operator|->
name|currentLBA
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
operator|+
name|DenomTL
expr_stmt|;
name|lba
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
expr_stmt|;
name|LBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF000000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF0000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_DMA
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA
expr_stmt|;
comment|/* 0xC8 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x0
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
break|break;
case|case
name|SAT_READ_SECTORS
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS
expr_stmt|;
comment|/* 0x20 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* FIS LBA (27:24) and FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x0
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
break|break;
case|case
name|SAT_READ_DMA_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_DMA_EXT
expr_stmt|;
comment|/* 0x25 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_READ
expr_stmt|;
break|break;
case|case
name|SAT_READ_SECTORS_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_SECTORS_EXT
expr_stmt|;
comment|/* 0x24 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
break|break;
case|case
name|SAT_READ_FPDMA_QUEUED
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x60 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_READ10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_READ
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRead_1: error incorrect ata command 0x%x!!!\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
break|break;
block|}
comment|/* Initialize CB for SATA completion.    */
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedDataIOCB
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
operator|==
name|SAT_READ_DMA
operator|||
name|satOrgIOContext
operator|->
name|ATACmd
operator|==
name|SAT_READ_SECTORS
condition|)
block|{
name|smsatSplitSGL
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
argument_list|,
name|satOrgIOContext
argument_list|,
name|NON_BIT48_ADDRESS_TL_LIMIT
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
comment|/* 0x100 * 0x200*/
operator|(
name|satOrgIOContext
operator|->
name|OrgTL
operator|)
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smsatSplitSGL
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
argument_list|,
name|satOrgIOContext
argument_list|,
name|BIT48_ADDRESS_TL_LIMIT
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
comment|/* 0xFFFF * 0x200*/
operator|(
name|satOrgIOContext
operator|->
name|OrgTL
operator|)
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
argument_list|,
comment|//smScsiRequest,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRead_1: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWrite_1
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     Assumption: error check on lba and tl has been done in satWrite*()     lba = lba + tl;   */
name|bit32
name|status
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|agNULL
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|DenomTL
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|Remainder
init|=
literal|0
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
comment|/* 0 MSB, 3 LSB */
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatWrite_1: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_WRITE_DMA
case|:
name|DenomTL
operator|=
literal|0x100
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS
case|:
name|DenomTL
operator|=
literal|0x100
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_FUA_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite_1: error incorrect ata command 0x%x!!!\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
break|break;
block|}
name|Remainder
operator|=
name|satOrgIOContext
operator|->
name|OrgTL
operator|%
name|DenomTL
expr_stmt|;
name|satOrgIOContext
operator|->
name|currentLBA
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
operator|+
name|DenomTL
expr_stmt|;
name|lba
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
expr_stmt|;
name|LBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF000000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF0000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_WRITE_DMA
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x0
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x0
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x3D */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
empty_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWrite_1: error incorrect ata command 0x%x!!!\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
break|break;
block|}
comment|/* Initialize CB for SATA completion.    */
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedDataIOCB
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
operator|==
name|SAT_WRITE_DMA
operator|||
name|satOrgIOContext
operator|->
name|ATACmd
operator|==
name|SAT_WRITE_SECTORS
condition|)
block|{
name|smsatSplitSGL
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
argument_list|,
name|satOrgIOContext
argument_list|,
name|NON_BIT48_ADDRESS_TL_LIMIT
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
comment|/* 0x100 * 0x200*/
operator|(
name|satOrgIOContext
operator|->
name|OrgTL
operator|)
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smsatSplitSGL
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
argument_list|,
name|satOrgIOContext
argument_list|,
name|BIT48_ADDRESS_TL_LIMIT
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
comment|/* 0xFFFF * 0x200*/
operator|(
name|satOrgIOContext
operator|->
name|OrgTL
operator|)
operator|*
name|SATA_SECTOR_SIZE
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
argument_list|,
comment|//smScsiRequest,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWrite_1: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatPassthrough
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smAtaPassThroughHdr_t
name|ataPassThroughHdr
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthrough: START!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|osti_memset
argument_list|(
operator|&
name|ataPassThroughHdr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smAtaPassThroughHdr_t
argument_list|)
argument_list|)
expr_stmt|;
name|ataPassThroughHdr
operator|.
name|opc
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
expr_stmt|;
name|ataPassThroughHdr
operator|.
name|mulCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|>>
literal|5
expr_stmt|;
name|ataPassThroughHdr
operator|.
name|proto
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|>>
literal|1
operator|)
operator|&
literal|0x0F
expr_stmt|;
name|ataPassThroughHdr
operator|.
name|extend
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
literal|1
expr_stmt|;
name|ataPassThroughHdr
operator|.
name|offline
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|>>
literal|6
expr_stmt|;
name|ataPassThroughHdr
operator|.
name|ckCond
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|>>
literal|5
operator|)
operator|&
literal|1
expr_stmt|;
name|ataPassThroughHdr
operator|.
name|tType
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|>>
literal|4
operator|)
operator|&
literal|1
expr_stmt|;
name|ataPassThroughHdr
operator|.
name|tDir
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|>>
literal|3
operator|)
operator|&
literal|1
expr_stmt|;
name|ataPassThroughHdr
operator|.
name|byteBlock
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|>>
literal|2
operator|)
operator|&
literal|1
expr_stmt|;
name|ataPassThroughHdr
operator|.
name|tlength
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0x3
expr_stmt|;
switch|switch
condition|(
name|ataPassThroughHdr
operator|.
name|proto
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|9
case|:
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DEV_RESET
expr_stmt|;
comment|//Device Reset
break|break;
case|case
literal|1
case|:
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_SRST_ASSERT
expr_stmt|;
comment|//Software reset
break|break;
case|case
literal|3
case|:
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|//Non Data mode
break|break;
case|case
literal|4
case|:
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|//IO_Data_In mode
break|break;
case|case
literal|5
case|:
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
comment|//PIO_Data_out
break|break;
case|case
literal|6
case|:
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
comment|//DMA READ and WRITE
break|break;
case|case
literal|8
case|:
name|agRequestType
operator|=
name|AGSA_SATA_ATAP_EXECDEVDIAG
expr_stmt|;
comment|//device diagnostic
break|break;
case|case
literal|12
case|:
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
comment|//FPDMA Read and Write
break|break;
default|default:
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|//Default Non Data Mode
break|break;
block|}
if|if
condition|(
operator|(
name|ataPassThroughHdr
operator|.
name|tlength
operator|==
literal|0
operator|)
operator|&&
operator|(
name|agRequestType
operator|!=
name|AGSA_SATA_PROTOCOL_NON_DATA
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthrough SCSI_SNSCODE_INVALID_FIELD_IN_CDB\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|==
literal|0xA1
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthrough A1h: COMMAND: %x  FEATURE: %x \n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* 0x01  FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* Reading LBA  FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
comment|/* Initialize CB for SATA completion*/
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatPassthroughCB
expr_stmt|;
comment|/*         * Prepare SGL and send FIS to LL layer.     */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
elseif|else
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|==
literal|0x85
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthrough 85h: COMMAND: %x  FEATURE: %x \n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|14
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
if|if
condition|(
literal|1
operator|==
name|ataPassThroughHdr
operator|.
name|extend
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
block|}
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|14
index|]
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
comment|/* Initialize CB for SATA completion.       */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatPassthroughCB
expr_stmt|;
comment|/*        * Prepare SGL and send FIS to LL layer.       */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthrough : INVALD PASSTHROUGH!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthrough : return control!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatNonChainedWriteNVerify_Verify
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerify_Verify: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedWriteNVerifyCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerify_Verify: return status %d!!!\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
else|else
block|{
comment|/* can't fit in SAT_READ_VERIFY_SECTORS becasue of Sector Count and LBA */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerify_Verify: can't fit in SAT_READ_VERIFY_SECTORS!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatChainedWriteNVerify_Start_Verify
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     deal with transfer length; others have been handled previously at this point;     no LBA check; no range check;   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|bit32
name|LoopNum
init|=
literal|1
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
name|bit8
name|TL
index|[
literal|4
index|]
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Start_Verify: start\n"
operator|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|TL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|TL
argument_list|)
argument_list|)
expr_stmt|;
comment|/* do not use memcpy due to indexing in LBA and TL */
name|LBA
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* LSB */
name|TL
index|[
literal|0
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
expr_stmt|;
comment|/* MSB */
name|TL
index|[
literal|1
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|2
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
name|TL
index|[
literal|3
index|]
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* LSB */
name|lba
operator|=
name|smsatComputeCDB12LBA
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
name|tl
operator|=
name|smsatComputeCDB12TL
argument_list|(
name|satIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Start_Verify: SAT_READ_VERIFY_SECTORS_EXT\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Start_Verify: SAT_READ_VERIFY_SECTORS\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
block|}
name|satIOContext
operator|->
name|currentLBA
operator|=
name|lba
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|tl
expr_stmt|;
comment|/*     computing number of loop and remainder for tl     0xFF in case not ext     0xFFFF in case EXT   */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
comment|/* SAT_READ_SECTORS_EXT, SAT_READ_DMA_EXT */
name|LoopNum
operator|=
name|smsatComputeLoopNum
argument_list|(
name|tl
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Start_Verify: error case 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|LoopNum
operator|=
literal|1
expr_stmt|;
block|}
name|satIOContext
operator|->
name|LoopNum
operator|=
name|LoopNum
expr_stmt|;
if|if
condition|(
name|LoopNum
operator|==
literal|1
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Start_Verify: NON CHAINED data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatNonChainedWriteNVerifyCB
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Start_Verify: CHAINED data!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* re-setting tl */
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Start_Verify: error case 2!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedWriteNVerifyCB
expr_stmt|;
block|}
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatChainedWriteNVerify_Write
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     Assumption: error check on lba and tl has been done in satWrite*()     lba = lba + tl;   */
name|bit32
name|status
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|agNULL
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|DenomTL
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|Remainder
init|=
literal|0
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
comment|/* 0 MSB, 3 LSB */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Write: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_WRITE_DMA
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_FUA_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Write: error incorrect ata command 0x%x!!!\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
break|break;
block|}
name|Remainder
operator|=
name|satOrgIOContext
operator|->
name|OrgTL
operator|%
name|DenomTL
expr_stmt|;
name|satOrgIOContext
operator|->
name|currentLBA
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
operator|+
name|DenomTL
expr_stmt|;
name|lba
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
expr_stmt|;
name|LBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF0
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0xF
argument_list|)
expr_stmt|;
comment|/* LSB */
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_WRITE_DMA
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x3D */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_WRITE10_FUA_MASK
condition|)
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0xC0
expr_stmt|;
comment|/* FIS FUA set */
else|else
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
empty_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Write: error incorrect ata command 0x%x!!!\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
break|break;
block|}
comment|/* Initialize CB for SATA completion.    */
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedWriteNVerifyCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"satChainedWriteNVerify_Write: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatChainedWriteNVerify_Verify
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|agNULL
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|DenomTL
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|Remainder
init|=
literal|0
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
comment|/* 0 MSB, 3 LSB */
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Verify: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Verify: error incorrect ata command 0x%x!!!\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
break|break;
block|}
name|Remainder
operator|=
name|satOrgIOContext
operator|->
name|OrgTL
operator|%
name|DenomTL
expr_stmt|;
name|satOrgIOContext
operator|->
name|currentLBA
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
operator|+
name|DenomTL
expr_stmt|;
name|lba
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
expr_stmt|;
name|LBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF0
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0xF
argument_list|)
expr_stmt|;
comment|/* LSB */
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Verify: error incorrect ata command 0x%x!!!\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|SM_RC_FAILURE
return|;
break|break;
block|}
comment|/* Initialize CB for SATA completion.    */
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedWriteNVerifyCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedWriteNVerify_Verify: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatChainedVerify
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|agNULL
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit32
name|agRequestType
init|=
name|AGSA_SATA_PROTOCOL_NON_DATA
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|bit32
name|DenomTL
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|Remainder
init|=
literal|0
decl_stmt|;
name|bit8
name|LBA
index|[
literal|4
index|]
decl_stmt|;
comment|/* 0 MSB, 3 LSB */
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatChainedVerify: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|DenomTL
operator|=
literal|0xFF
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|DenomTL
operator|=
literal|0xFFFF
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"satChainedVerify: error incorrect ata command 0x%x!!!\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
name|Remainder
operator|=
name|satOrgIOContext
operator|->
name|OrgTL
operator|%
name|DenomTL
expr_stmt|;
name|satOrgIOContext
operator|->
name|currentLBA
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
operator|+
name|DenomTL
expr_stmt|;
name|lba
operator|=
name|satOrgIOContext
operator|->
name|currentLBA
expr_stmt|;
name|LBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
comment|/* MSB */
name|LBA
index|[
literal|1
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xF0
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0xF
argument_list|)
expr_stmt|;
comment|/* LSB */
switch|switch
condition|(
name|satOrgIOContext
operator|->
name|ATACmd
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|0
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
operator|(
name|bit8
operator|)
name|Remainder
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
block|}
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|1
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|0
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|1
condition|)
block|{
comment|/* last loop */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
call|(
name|bit8
call|)
argument_list|(
name|Remainder
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|Remainder
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
else|else
block|{
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0xFF
expr_stmt|;
comment|/* FIS sector count (15:8) */
block|}
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"satChainedVerify: error incorrect ata command 0x%x!!!\n"
operator|,
name|satIOContext
operator|->
name|ATACmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|tiError
return|;
break|break;
block|}
comment|/* Initialize CB for SATA completion.    */
comment|/* chained data */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatChainedVerifyCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"satChainedVerify: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWriteSame10_1
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|lba
parameter_list|)
block|{
comment|/*     sends SAT_WRITE_DMA_EXT   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
name|lba1
decl_stmt|,
name|lba2
decl_stmt|,
name|lba3
decl_stmt|,
name|lba4
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10_1: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* MSB */
name|lba1
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF000000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
name|lba2
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x00FF0000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|lba3
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x0000FF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* LSB */
name|lba4
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0x000000FF
argument_list|)
expr_stmt|;
comment|/* SAT_WRITE_DMA_EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|lba4
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|lba3
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|lba2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|lba1
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
comment|/* one sector at a time */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatWriteSame10CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10_1 return status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWriteSame10_2
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|lba
parameter_list|)
block|{
comment|/*     sends SAT_WRITE_SECTORS_EXT   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
name|lba1
decl_stmt|,
name|lba2
decl_stmt|,
name|lba3
decl_stmt|,
name|lba4
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10_2: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* MSB */
name|lba1
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF000000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
name|lba2
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x00FF0000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|lba3
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x0000FF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* LSB */
name|lba4
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0x000000FF
argument_list|)
expr_stmt|;
comment|/* SAT_WRITE_SECTORS_EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|lba4
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|lba3
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|lba2
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|lba1
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
comment|/* one sector at a time */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatWriteSame10CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10_2 return status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatWriteSame10_3
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|lba
parameter_list|)
block|{
comment|/*     sends SAT_WRITE_FPDMA_QUEUED   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
name|lba1
decl_stmt|,
name|lba2
decl_stmt|,
name|lba3
decl_stmt|,
name|lba4
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10_3: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* MSB */
name|lba1
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0xFF000000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
name|lba2
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x00FF0000
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|lba3
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
name|lba
operator|&
literal|0x0000FF00
operator|)
operator|>>
operator|(
literal|8
operator|*
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* LSB */
name|lba4
operator|=
call|(
name|bit8
call|)
argument_list|(
name|lba
operator|&
literal|0x000000FF
argument_list|)
expr_stmt|;
comment|/* SAT_WRITE_FPDMA_QUEUED */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
comment|/* one sector at a time */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|lba4
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|lba3
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|lba2
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* NO FUA bit in the WRITE SAME 10 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|lba1
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatWriteSame10CB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10_3 return status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatStartStopUnit_1
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     SAT Rev 8, Table 48, 9.11.3 p55     sends STANDBY   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnit_1: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/* STANDBY */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_STANDBY
expr_stmt|;
comment|/* 0xE2 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* 0 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatStartStopUnitCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnit_1 return status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatSendDiagnostic_1
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     SAT Rev9, Table29, p41     send 2nd SAT_READ_VERIFY_SECTORS(_EXT)   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic_1: start\n"
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/*     sector count 1, LBA MAX   */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|pSatDevData
operator|->
name|satMaxLBA
index|[
literal|4
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* DEV and LBA 27:24 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSendDiagnosticCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatSendDiagnostic_2
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     SAT Rev9, Table29, p41     send 3rd SAT_READ_VERIFY_SECTORS(_EXT)   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnostic_2: start\n"
operator|)
argument_list|)
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|/*     sector count 1, LBA Random   */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x7F
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x7F
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSendDiagnosticCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatModeSelect6n10_1
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/* sends either ATA SET FEATURES based on DRA bit */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pLogPage
decl_stmt|;
comment|/* Log Page data buffer */
name|bit32
name|StartingIndex
init|=
literal|0
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6n10_1: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pLogPage
index|[
literal|3
index|]
operator|==
literal|8
condition|)
block|{
comment|/* mode parameter block descriptor exists */
name|StartingIndex
operator|=
literal|12
expr_stmt|;
block|}
else|else
block|{
comment|/* mode parameter block descriptor does not exist */
name|StartingIndex
operator|=
literal|4
expr_stmt|;
block|}
comment|/* sends ATA SET FEATURES based on DRA bit */
if|if
condition|(
operator|!
operator|(
name|pLogPage
index|[
name|StartingIndex
operator|+
literal|12
index|]
operator|&
name|SCSI_MODE_SELECT6_DRA_MASK
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6n10_1: enable read look-ahead feature\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xAA
expr_stmt|;
comment|/* enable read look-ahead */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatModeSelect6n10CB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6n10_1: disable read look-ahead feature\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x55
expr_stmt|;
comment|/* disable read look-ahead */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatModeSelect6n10CB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatLogSense_1
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense_1: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* SAT Rev 8, 10.2.4 p74 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense_1: case 2-1 sends READ LOG EXT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends READ LOG EXT */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_LOG_EXT
expr_stmt|;
comment|/* 0x2F */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x07
expr_stmt|;
comment|/* 0x07 */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x01
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x00
expr_stmt|;
comment|/* 1 sector counts */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatLogSenseCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSense_1: case 2-2 sends SMART READ LOG\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* sends SMART READ LOG */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SMART
expr_stmt|;
comment|/* 0x2F */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
name|SAT_SMART_READ_LOG
expr_stmt|;
comment|/* 0xd5 */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x06
expr_stmt|;
comment|/* 0x06 */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0x00
expr_stmt|;
comment|/* 0x4f */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0x00
expr_stmt|;
comment|/* 0xc2 */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x01
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x00
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.      */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatLogSenseCB
expr_stmt|;
comment|/*      * Prepare SGL and send FIS to LL layer.      */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatReassignBlocks_2
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit8
modifier|*
name|LBA
parameter_list|)
block|{
comment|/*     assumes all LBA fits in ATA command; no boundary condition is checked here yet     tiScsiRequest is TD generated for writing   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocks_2: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 2 */
comment|/* WRITE DMA*/
comment|/* can't fit the transfer length */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocks_2: case 2\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
comment|/* 0xCA */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|4
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA
expr_stmt|;
block|}
else|else
block|{
comment|/* case 1 */
comment|/* WRITE MULTIPLE or WRITE SECTOR(S) */
comment|/* WRITE SECTORS for easier implemetation */
comment|/* can't fit the transfer length */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocks_2: case 1\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C bit is set       */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
comment|/* 0x30 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* FIS LBA mode set LBA (27:24) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|4
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS
expr_stmt|;
block|}
comment|/* case 3 and 4 */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
if|if
condition|(
name|pSatDevData
operator|->
name|satDMASupport
operator|==
name|agTRUE
operator|&&
name|pSatDevData
operator|->
name|satDMAEnabled
operator|==
name|agTRUE
condition|)
block|{
comment|/* case 3 */
comment|/* WRITE DMA EXT or WRITE DMA FUA EXT */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocks_2: case 3\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
comment|/* SAT_WRITE_DMA_FUA_EXT is optional and we don't support it */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
comment|/* 0x35 */
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_DMA_EXT
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_DMA_WRITE
expr_stmt|;
block|}
else|else
block|{
comment|/* case 4 */
comment|/* WRITE MULTIPLE EXT or WRITE MULTIPLE FUA EXT or WRITE SECTOR(S) EXT */
comment|/* WRITE SECTORS EXT for easier implemetation */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocks_2: case 4\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
comment|/* 0x34 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS LBA mode set */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_SECTORS_EXT
expr_stmt|;
block|}
block|}
comment|/* case 5 */
if|if
condition|(
name|pSatDevData
operator|->
name|satNCQ
operator|==
name|agTRUE
condition|)
block|{
comment|/* WRITE FPDMA QUEUED */
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|!=
name|agTRUE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocks_2: case 5 !!! error NCQ but 28 bit address support \n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
name|SM_DBG6
argument_list|(
operator|(
literal|"satWrite10: case 5\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Support 48-bit FPDMA addressing, use WRITE FPDMA QUEUE command */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
comment|/* 0x61 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
comment|/* Check FUA bit */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* FIS FUA clear */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* Tag (7:3) set by LL layer */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
expr_stmt|;
name|satIOContext
operator|->
name|ATACmd
operator|=
name|SAT_WRITE_FPDMA_QUEUED
expr_stmt|;
block|}
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatReassignBlocksCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
comment|/* not the original, should be the TD generated one */
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatReassignBlocks_1
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
parameter_list|)
block|{
comment|/*     assumes all LBA fits in ATA command; no boundary condition is checked here yet     tiScsiRequest is OS generated; needs for accessing parameter list   */
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|bit8
modifier|*
name|pParmList
decl_stmt|;
comment|/* Log Page data buffer */
name|bit8
name|LongLBA
decl_stmt|;
name|bit8
name|LBA
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|startingIndex
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|pParmList
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocks_1: start\n"
operator|)
argument_list|)
expr_stmt|;
name|LongLBA
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_REASSIGN_BLOCKS_LONGLBA_MASK
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|LBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LBA
argument_list|)
argument_list|)
expr_stmt|;
name|startingIndex
operator|=
name|satOrgIOContext
operator|->
name|ParmIndex
expr_stmt|;
if|if
condition|(
name|LongLBA
operator|==
literal|0
condition|)
block|{
name|LBA
index|[
literal|4
index|]
operator|=
name|pParmList
index|[
name|startingIndex
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|1
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|3
index|]
expr_stmt|;
name|startingIndex
operator|=
name|startingIndex
operator|+
literal|4
expr_stmt|;
block|}
else|else
block|{
name|LBA
index|[
literal|0
index|]
operator|=
name|pParmList
index|[
name|startingIndex
index|]
expr_stmt|;
name|LBA
index|[
literal|1
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|1
index|]
expr_stmt|;
name|LBA
index|[
literal|2
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|2
index|]
expr_stmt|;
name|LBA
index|[
literal|3
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|3
index|]
expr_stmt|;
name|LBA
index|[
literal|4
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|4
index|]
expr_stmt|;
name|LBA
index|[
literal|5
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|5
index|]
expr_stmt|;
name|LBA
index|[
literal|6
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|6
index|]
expr_stmt|;
name|LBA
index|[
literal|7
index|]
operator|=
name|pParmList
index|[
name|startingIndex
operator|+
literal|7
index|]
expr_stmt|;
name|startingIndex
operator|=
name|startingIndex
operator|+
literal|8
expr_stmt|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|sat48BitSupport
operator|==
name|agTRUE
condition|)
block|{
comment|/* sends READ VERIFY SECTOR(S) EXT*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS_EXT
expr_stmt|;
comment|/* 0x42 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
name|LBA
index|[
literal|4
index|]
expr_stmt|;
comment|/* FIS LBA (31:24) */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
name|LBA
index|[
literal|3
index|]
expr_stmt|;
comment|/* FIS LBA (39:32) */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
name|LBA
index|[
literal|2
index|]
expr_stmt|;
comment|/* FIS LBA (47:40) */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (15:8) */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0x40
expr_stmt|;
comment|/* 01000000 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* READ VERIFY SECTOR(S)*/
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_VERIFY_SECTORS
expr_stmt|;
comment|/* 0x40 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS features NA       */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
name|LBA
index|[
literal|7
index|]
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
name|LBA
index|[
literal|6
index|]
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
name|LBA
index|[
literal|5
index|]
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|1
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
literal|0x4
operator|<<
literal|4
operator|)
operator||
operator|(
name|LBA
index|[
literal|4
index|]
operator|&
literal|0xF
operator|)
argument_list|)
expr_stmt|;
comment|/* DEV and LBA 27:24 */
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
block|}
name|sm_memcpy
argument_list|(
name|satOrgIOContext
operator|->
name|LBA
argument_list|,
name|LBA
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|->
name|ParmIndex
operator|=
name|startingIndex
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatReassignBlocksCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return
name|SM_RC_SUCCESS
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatSendReadLogExt
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendReadLogExt: start\n"
operator|)
argument_list|)
expr_stmt|;
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_READ_LOG_EXT
expr_stmt|;
comment|/* 0x2F */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0x10
expr_stmt|;
comment|/* Page number */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* DEV is ignored in SATA */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
comment|/*  */
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x01
expr_stmt|;
comment|/*  1 sector counts*/
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0x00
expr_stmt|;
comment|/*  1 sector counts */
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_PIO_READ
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatReadLogExtCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendReadLogExt: end status %d!!!\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatCheckPowerMode
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
comment|/*     sends SAT_CHECK_POWER_MODE as a part of ABORT TASKMANGEMENT for NCQ commands     internally generated - no directly corresponding scsi   */
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerMode: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the ATA CHECK POWER MODE command.    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_CHECK_POWER_MODE
expr_stmt|;
comment|/* 0xE5 */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatCheckPowerModeCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckPowerMode: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatResetDevice
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
comment|/* NULL */
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIoContext
decl_stmt|;
endif|#
directive|endif
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatResetDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satIntIoContext
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|smIORequestBody
operator|=
name|satIntIoContext
operator|->
name|satIntRequestBody
expr_stmt|;
endif|#
directive|endif
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatResetDevice: satIOContext %p smIORequestBody %p\n"
operator|,
name|satIOContext
operator|,
name|smIORequestBody
operator|)
argument_list|)
expr_stmt|;
comment|/* any fis should work */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0
expr_stmt|;
comment|/* C Bit is not set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
literal|0
expr_stmt|;
comment|/* any command */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0x4
expr_stmt|;
comment|/* SRST bit is set  */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_SRST_ASSERT
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatResetDeviceCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
ifdef|#
directive|ifdef
name|SM_INTERNAL_DEBUG
name|smhexdump
argument_list|(
literal|"smsatResetDevice"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|satIOContext
operator|->
name|pFis
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|smhexdump
argument_list|(
literal|"smsatResetDevice LL"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatResetDevice: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatDeResetDevice
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIoContext
decl_stmt|;
endif|#
directive|endif
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeResetDevice: start\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satIntIoContext
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|smIORequestBody
operator|=
name|satIntIoContext
operator|->
name|satIntRequestBody
expr_stmt|;
endif|#
directive|endif
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatDeResetDevice: satIOContext %p smIORequestBody %p\n"
operator|,
name|satIOContext
operator|,
name|smIORequestBody
operator|)
argument_list|)
expr_stmt|;
comment|/* any fis should work */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0
expr_stmt|;
comment|/* C Bit is not set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
literal|0
expr_stmt|;
comment|/* any command */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0
expr_stmt|;
comment|/* FIS reserve */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (7 :0 ) */
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (15:8 ) */
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA (23:16) */
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
comment|/* FIS LBA mode  */
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
comment|/* FIS sector count (7:0) */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* SRST bit is not set  */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_SRST_DEASSERT
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatDeResetDeviceCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
ifdef|#
directive|ifdef
name|SM_INTERNAL_DEBUG
name|smhexdump
argument_list|(
literal|"smsatDeResetDevice"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|satIOContext
operator|->
name|pFis
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|smhexdump
argument_list|(
literal|"smsatDeResetDevice LL"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegHostToDevice_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatDeResetDevice: end status %d\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* set feature for auto activate */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatSetFeaturesAA
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesAA: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the Set Features command.    * See SATA II 1.0a spec    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x10
expr_stmt|;
comment|/* enable SATA feature */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x02
expr_stmt|;
comment|/* DMA Setup FIS Auto-Activate */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSetFeaturesAACB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* debugging code */
if|if
condition|(
name|smIORequest
operator|->
name|tdData
operator|==
name|smIORequest
operator|->
name|smData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesAA: incorrect smIORequest\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeatures: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* set feature for DMA transfer mode*/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatSetFeaturesDMA
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesDMA: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the Set Features command.    * See SATA II 1.0a spec    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x03
expr_stmt|;
comment|/* enable ATA transfer mode */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0x40
operator||
operator|(
name|bit8
operator|)
name|pSatDevData
operator|->
name|satUltraDMAMode
expr_stmt|;
comment|/* enable Ultra DMA mode */
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSetFeaturesDMACB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* debugging code */
if|if
condition|(
name|smIORequest
operator|->
name|tdData
operator|==
name|smIORequest
operator|->
name|smData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMA: incorrect smIORequest\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesDMA: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* set feature for Read Look Ahead*/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatSetFeaturesReadLookAhead
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAhead: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the Set Features command.    * See SATA II 1.0a spec    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0xAA
expr_stmt|;
comment|/* Enable read look-ahead feature */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSetFeaturesReadLookAheadCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* debugging code */
if|if
condition|(
name|smIORequest
operator|->
name|tdData
operator|==
name|smIORequest
operator|->
name|smData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAhead: incorrect smIORequest\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAhead: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* set feature for Volatile Write Cache*/
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatSetFeaturesVolatileWriteCache
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|bit32
name|agRequestType
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|fis
decl_stmt|;
name|fis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCache: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Send the Set Features command.    * See SATA II 1.0a spec    */
name|fis
operator|->
name|h
operator|.
name|fisType
operator|=
literal|0x27
expr_stmt|;
comment|/* Reg host to device */
name|fis
operator|->
name|h
operator|.
name|c_pmPort
operator|=
literal|0x80
expr_stmt|;
comment|/* C Bit is set */
name|fis
operator|->
name|h
operator|.
name|command
operator|=
name|SAT_SET_FEATURES
expr_stmt|;
comment|/* 0xEF */
name|fis
operator|->
name|h
operator|.
name|features
operator|=
literal|0x02
expr_stmt|;
comment|/* Enable Volatile Write Cache feature */
name|fis
operator|->
name|d
operator|.
name|lbaLow
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMid
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHigh
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|device
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaLowExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaMidExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|lbaHighExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|featuresExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCount
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|sectorCountExp
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|reserved4
operator|=
literal|0
expr_stmt|;
name|fis
operator|->
name|d
operator|.
name|control
operator|=
literal|0
expr_stmt|;
comment|/* FIS HOB bit clear */
name|fis
operator|->
name|d
operator|.
name|reserved5
operator|=
literal|0
expr_stmt|;
name|agRequestType
operator|=
name|AGSA_SATA_PROTOCOL_NON_DATA
expr_stmt|;
comment|/* Initialize CB for SATA completion.    */
name|satIOContext
operator|->
name|satCompleteCB
operator|=
operator|&
name|smsatSetFeaturesVolatileWriteCacheCB
expr_stmt|;
comment|/*    * Prepare SGL and send FIS to LL layer.    */
name|satIOContext
operator|->
name|reqType
operator|=
name|agRequestType
expr_stmt|;
comment|/* Save it */
name|status
operator|=
name|smsataLLIOStart
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* debugging code */
if|if
condition|(
name|smIORequest
operator|->
name|tdData
operator|==
name|smIORequest
operator|->
name|smData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCache: incorrect smIORequest\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCache: return\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/******************************** start of utils    ***********************************************************/
end_comment

begin_function
name|osGLOBAL
name|FORCEINLINE
name|void
name|smsatBitSet
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|bit8
modifier|*
name|data
parameter_list|,
name|bit32
name|index
parameter_list|)
block|{
name|data
index|[
name|index
operator|>>
literal|3
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
name|index
operator|&
literal|7
operator|)
operator|)
expr_stmt|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|void
name|smsatBitClear
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|bit8
modifier|*
name|data
parameter_list|,
name|bit32
name|index
parameter_list|)
block|{
name|data
index|[
name|index
operator|>>
literal|3
index|]
operator|&=
operator|~
operator|(
literal|1
operator|<<
operator|(
name|index
operator|&
literal|7
operator|)
operator|)
expr_stmt|;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|BOOLEAN
name|smsatBitTest
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|bit8
modifier|*
name|data
parameter_list|,
name|bit32
name|index
parameter_list|)
block|{
return|return
operator|(
call|(
name|BOOLEAN
call|)
argument_list|(
operator|(
name|data
index|[
name|index
operator|>>
literal|3
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|index
operator|&
literal|7
operator|)
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|FORCEINLINE
name|bit32
name|smsatTagAlloc
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smDeviceData_t
modifier|*
name|pSatDevData
parameter_list|,
name|bit8
modifier|*
name|pTag
parameter_list|)
block|{
name|bit32
name|retCode
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|i
decl_stmt|;
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_NCQ_TAG_LOCK
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CCFLAG_OPTIMIZE_SAT_LOCK
if|if
condition|(
name|tdsmBitScanForward
argument_list|(
name|smRoot
argument_list|,
operator|&
name|i
argument_list|,
operator|~
operator|(
name|pSatDevData
operator|->
name|freeSATAFDMATagBitmap
operator|)
argument_list|)
condition|)
block|{
name|smsatBitSet
argument_list|(
name|smRoot
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|pSatDevData
operator|->
name|freeSATAFDMATagBitmap
argument_list|,
name|i
argument_list|)
expr_stmt|;
operator|*
name|pTag
operator|=
operator|(
name|bit8
operator|)
name|i
expr_stmt|;
name|retCode
operator|=
name|agTRUE
expr_stmt|;
block|}
else|#
directive|else
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pSatDevData
operator|->
name|satNCQMaxIO
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
literal|0
operator|==
name|smsatBitTest
argument_list|(
name|smRoot
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|pSatDevData
operator|->
name|freeSATAFDMATagBitmap
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|smsatBitSet
argument_list|(
name|smRoot
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|pSatDevData
operator|->
name|freeSATAFDMATagBitmap
argument_list|,
name|i
argument_list|)
expr_stmt|;
operator|*
name|pTag
operator|=
operator|(
name|bit8
operator|)
name|i
expr_stmt|;
name|retCode
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
block|}
endif|#
directive|endif
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_NCQ_TAG_LOCK
argument_list|)
expr_stmt|;
return|return
name|retCode
return|;
block|}
end_function

begin_function
name|FORCEINLINE
name|bit32
name|smsatTagRelease
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smDeviceData_t
modifier|*
name|pSatDevData
parameter_list|,
name|bit8
name|tag
parameter_list|)
block|{
name|bit32
name|retCode
init|=
name|agFALSE
decl_stmt|;
if|if
condition|(
name|tag
operator|<
name|pSatDevData
operator|->
name|satNCQMaxIO
condition|)
block|{
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_NCQ_TAG_LOCK
argument_list|)
expr_stmt|;
name|smsatBitClear
argument_list|(
name|smRoot
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|pSatDevData
operator|->
name|freeSATAFDMATagBitmap
argument_list|,
operator|(
name|bit32
operator|)
name|tag
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_NCQ_TAG_LOCK
argument_list|)
expr_stmt|;
comment|/*tdsmInterlockedAnd(smRoot, (volatile LONG *)(&pSatDevData->freeSATAFDMATagBitmap), ~(1<< (tag&31)));*/
name|retCode
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTagRelease: tag %d>= satNCQMaxIO %d!!!!\n"
operator|,
name|tag
operator|,
name|pSatDevData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|retCode
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatComputeCDB10LBA
parameter_list|(
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatComputeCDB10LBA: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smScsiRequest
operator|=
name|satIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|smScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
return|return
name|lba
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatComputeCDB10TL
parameter_list|(
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatComputeCDB10TL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smScsiRequest
operator|=
name|satIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|smScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
return|return
name|tl
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatComputeCDB12LBA
parameter_list|(
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatComputeCDB12LBA: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smScsiRequest
operator|=
name|satIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|smScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
return|return
name|lba
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatComputeCDB12TL
parameter_list|(
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatComputeCDB12TL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smScsiRequest
operator|=
name|satIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|smScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
return|return
name|tl
return|;
block|}
end_function

begin_comment
comment|/*   CBD16 has bit64 LBA   But it has to be less than (2^28 - 1)   Therefore, use last four bytes to compute LBA is OK */
end_comment

begin_function
name|osGLOBAL
name|bit32
name|smsatComputeCDB16LBA
parameter_list|(
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatComputeCDB16LBA: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smScsiRequest
operator|=
name|satIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|smScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
return|return
name|lba
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|bit32
name|smsatComputeCDB16TL
parameter_list|(
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
name|bit32
name|tl
init|=
literal|0
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatComputeCDB16TL: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smScsiRequest
operator|=
name|satIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
operator|(
name|smScsiRequest
operator|->
name|scsiCmnd
operator|)
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|12
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|13
index|]
expr_stmt|;
return|return
name|tl
return|;
block|}
end_function

begin_comment
comment|/*   (tl, denom)   tl can be upto bit32 because CDB16 has bit32 tl   Therefore, fine   either (tl, 0xFF) or (tl, 0xFFFF) */
end_comment

begin_function
name|osGLOBAL
name|FORCEINLINE
name|bit32
name|smsatComputeLoopNum
parameter_list|(
name|bit32
name|a
parameter_list|,
name|bit32
name|b
parameter_list|)
block|{
name|bit32
name|LoopNum
init|=
literal|0
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatComputeLoopNum: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|<
name|b
operator|||
name|a
operator|==
literal|0
condition|)
block|{
name|LoopNum
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|a
operator|==
name|b
operator|||
name|a
operator|==
literal|0
condition|)
block|{
name|LoopNum
operator|=
name|a
operator|/
name|b
expr_stmt|;
block|}
else|else
block|{
name|LoopNum
operator|=
name|a
operator|/
name|b
operator|+
literal|1
expr_stmt|;
block|}
block|}
return|return
name|LoopNum
return|;
block|}
end_function

begin_comment
comment|/*   Generic new function for checking   LBA itself, LBA+TL< SAT_TR_LBA_LIMIT or SAT_EXT_TR_LBA_LIMIT    and LBA+TL< Read Capacity Limit   flag: false - not 48BitSupport; true - 48BitSupport   returns TRUE when over the limit    */
end_comment

begin_function
name|osGLOBAL
name|FORCEINLINE
name|bit32
name|smsatCheckLimit
parameter_list|(
name|bit8
modifier|*
name|lba
parameter_list|,
name|bit8
modifier|*
name|tl
parameter_list|,
name|int
name|flag
parameter_list|,
name|smDeviceData_t
modifier|*
name|pSatDevData
parameter_list|)
block|{
name|bit32
name|lbaCheck
init|=
name|agFALSE
decl_stmt|;
name|int
name|i
decl_stmt|;
name|bit8
name|limit
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|rangeCheck
init|=
name|agFALSE
decl_stmt|;
name|bit16
name|ans
index|[
literal|8
index|]
decl_stmt|;
comment|// 0 MSB, 8 LSB
name|bit8
name|final_ans
index|[
literal|9
index|]
decl_stmt|;
comment|// 0 MSB, 9 LSB
name|bit8
name|Bit28max
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|Bit48max
index|[
literal|8
index|]
decl_stmt|;
name|bit32
name|ReadCapCheck
init|=
name|agFALSE
decl_stmt|;
name|bit32
name|ret
decl_stmt|;
name|bit8
name|final_satMaxLBA
index|[
literal|9
index|]
decl_stmt|;
name|bit8
name|oneTL
index|[
literal|8
index|]
decl_stmt|;
name|bit8
name|temp_satMaxLBA
index|[
literal|8
index|]
decl_stmt|;
comment|// 0 MSB, 8 LSB
comment|/*      check LBA   */
if|if
condition|(
name|flag
operator|==
name|agFALSE
condition|)
block|{
comment|/* limit is 0xF FF FF = 2^28 - 1 */
name|limit
index|[
literal|0
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* MSB */
name|limit
index|[
literal|1
index|]
operator|=
literal|0x0
expr_stmt|;
name|limit
index|[
literal|2
index|]
operator|=
literal|0x0
expr_stmt|;
name|limit
index|[
literal|3
index|]
operator|=
literal|0x0
expr_stmt|;
name|limit
index|[
literal|4
index|]
operator|=
literal|0xF
expr_stmt|;
name|limit
index|[
literal|5
index|]
operator|=
literal|0xFF
expr_stmt|;
name|limit
index|[
literal|6
index|]
operator|=
literal|0xFF
expr_stmt|;
name|limit
index|[
literal|7
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* LSB */
block|}
else|else
block|{
comment|/* limit is 0xF FF FF = 2^48 - 1 */
name|limit
index|[
literal|0
index|]
operator|=
literal|0x0
expr_stmt|;
comment|/* MSB */
name|limit
index|[
literal|1
index|]
operator|=
literal|0x0
expr_stmt|;
name|limit
index|[
literal|2
index|]
operator|=
literal|0xFF
expr_stmt|;
name|limit
index|[
literal|3
index|]
operator|=
literal|0xFF
expr_stmt|;
name|limit
index|[
literal|4
index|]
operator|=
literal|0xFF
expr_stmt|;
name|limit
index|[
literal|5
index|]
operator|=
literal|0xFF
expr_stmt|;
name|limit
index|[
literal|6
index|]
operator|=
literal|0xFF
expr_stmt|;
name|limit
index|[
literal|7
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* LSB */
block|}
comment|//compare lba to limit
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|lba
index|[
name|i
index|]
operator|>
name|limit
index|[
name|i
index|]
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: LBA check True at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|lbaCheck
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|lba
index|[
name|i
index|]
operator|<
name|limit
index|[
name|i
index|]
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckLimit: LBA check False at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|lbaCheck
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
else|else
block|{
continue|continue;
block|}
block|}
if|if
condition|(
name|lbaCheck
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: return LBA check True\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
comment|/*     check LBA+TL< SAT_TR_LBA_LIMIT or SAT_EXT_TR_LBA_LIMIT    */
name|sm_memset
argument_list|(
name|ans
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ans
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|final_ans
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|final_ans
argument_list|)
argument_list|)
expr_stmt|;
comment|// adding from LSB to MSB
for|for
control|(
name|i
operator|=
literal|7
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|ans
index|[
name|i
index|]
operator|=
call|(
name|bit16
call|)
argument_list|(
name|lba
index|[
name|i
index|]
operator|+
name|tl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|7
condition|)
block|{
name|ans
index|[
name|i
index|]
operator|=
call|(
name|bit16
call|)
argument_list|(
name|ans
index|[
name|i
index|]
operator|+
operator|(
operator|(
name|ans
index|[
name|i
operator|+
literal|1
index|]
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*     filling in the final answer    */
name|final_ans
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|ans
index|[
literal|0
index|]
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|final_ans
index|[
name|i
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|ans
index|[
name|i
operator|-
literal|1
index|]
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flag
operator|==
name|agFALSE
condition|)
block|{
name|sm_memset
argument_list|(
name|Bit28max
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|Bit28max
argument_list|)
argument_list|)
expr_stmt|;
name|Bit28max
index|[
literal|4
index|]
operator|=
literal|0x10
expr_stmt|;
comment|// max =0x1000 0000
comment|//compare final_ans to max
if|if
condition|(
name|final_ans
index|[
literal|0
index|]
operator|!=
literal|0
operator|||
name|final_ans
index|[
literal|1
index|]
operator|!=
literal|0
operator|||
name|final_ans
index|[
literal|2
index|]
operator|!=
literal|0
operator|||
name|final_ans
index|[
literal|3
index|]
operator|!=
literal|0
operator|||
name|final_ans
index|[
literal|4
index|]
operator|!=
literal|0
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: before 28Bit addressing TRUE\n"
operator|)
argument_list|)
expr_stmt|;
name|rangeCheck
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|5
init|;
name|i
operator|<=
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|>
name|Bit28max
index|[
name|i
operator|-
literal|1
index|]
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: 28Bit addressing TRUE at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|rangeCheck
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|<
name|Bit28max
index|[
name|i
operator|-
literal|1
index|]
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckLimit: 28Bit addressing FALSE at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|rangeCheck
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
else|else
block|{
continue|continue;
block|}
block|}
block|}
block|}
else|else
block|{
name|sm_memset
argument_list|(
name|Bit48max
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|Bit48max
argument_list|)
argument_list|)
expr_stmt|;
name|Bit48max
index|[
literal|1
index|]
operator|=
literal|0x1
expr_stmt|;
comment|//max = 0x1 0000 0000 0000
comment|//compare final_ans to max
if|if
condition|(
name|final_ans
index|[
literal|0
index|]
operator|!=
literal|0
operator|||
name|final_ans
index|[
literal|1
index|]
operator|!=
literal|0
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: before 48Bit addressing TRUE\n"
operator|)
argument_list|)
expr_stmt|;
name|rangeCheck
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<=
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|>
name|Bit48max
index|[
name|i
operator|-
literal|1
index|]
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: 48Bit addressing TRUE at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|rangeCheck
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|<
name|Bit48max
index|[
name|i
operator|-
literal|1
index|]
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckLimit: 48Bit addressing FALSE at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|rangeCheck
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
else|else
block|{
continue|continue;
block|}
block|}
block|}
block|}
if|if
condition|(
name|rangeCheck
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: return rangeCheck True\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
comment|/*       LBA+TL< Read Capacity Limit   */
name|sm_memset
argument_list|(
name|temp_satMaxLBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|temp_satMaxLBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|oneTL
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|oneTL
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|final_satMaxLBA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|final_satMaxLBA
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memset
argument_list|(
name|ans
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ans
argument_list|)
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
operator|&
name|temp_satMaxLBA
argument_list|,
operator|&
name|pSatDevData
operator|->
name|satMaxLBA
argument_list|,
sizeof|sizeof
argument_list|(
name|temp_satMaxLBA
argument_list|)
argument_list|)
expr_stmt|;
name|oneTL
index|[
literal|7
index|]
operator|=
literal|1
expr_stmt|;
comment|// adding temp_satMaxLBA to oneTL
for|for
control|(
name|i
operator|=
literal|7
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|ans
index|[
name|i
index|]
operator|=
call|(
name|bit16
call|)
argument_list|(
name|temp_satMaxLBA
index|[
name|i
index|]
operator|+
name|oneTL
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|7
condition|)
block|{
name|ans
index|[
name|i
index|]
operator|=
call|(
name|bit16
call|)
argument_list|(
name|ans
index|[
name|i
index|]
operator|+
operator|(
operator|(
name|ans
index|[
name|i
operator|+
literal|1
index|]
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*     filling in the final answer    */
name|final_satMaxLBA
index|[
literal|0
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|ans
index|[
literal|0
index|]
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|final_satMaxLBA
index|[
name|i
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
name|ans
index|[
name|i
operator|-
literal|1
index|]
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pSatDevData
operator|->
name|ReadCapacity
operator|==
literal|10
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|>
name|final_satMaxLBA
index|[
name|i
index|]
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: Read Capacity 10 TRUE at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|ReadCapCheck
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|<
name|final_satMaxLBA
index|[
name|i
index|]
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckLimit: Read Capacity 10 FALSE at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|ReadCapCheck
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
else|else
block|{
continue|continue;
block|}
block|}
if|if
condition|(
name|ReadCapCheck
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: after Read Capacity 10 TRUE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckLimit: after Read Capacity 10 FALSE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|pSatDevData
operator|->
name|ReadCapacity
operator|==
literal|16
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|>
name|final_satMaxLBA
index|[
name|i
index|]
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: Read Capacity 16 TRUE at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|ReadCapCheck
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|final_ans
index|[
name|i
index|]
operator|<
name|final_satMaxLBA
index|[
name|i
index|]
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckLimit: Read Capacity 16 FALSE at %d\n"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|ReadCapCheck
operator|=
name|agFALSE
expr_stmt|;
break|break;
block|}
else|else
block|{
continue|continue;
block|}
block|}
if|if
condition|(
name|ReadCapCheck
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: after Read Capacity 16 TRUE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckLimit: after Read Capacity 16 FALSE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckLimit: unknown pSatDevData->ReadCapacity %d\n"
operator|,
name|pSatDevData
operator|->
name|ReadCapacity
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ReadCapCheck
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: return ReadCapCheck True\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|agTRUE
return|;
block|}
name|ret
operator|=
operator|(
name|lbaCheck
operator||
name|rangeCheck
operator||
name|ReadCapCheck
operator|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckLimit: final check TRUE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckLimit: final check FALSE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatPrintSgl
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|agsaEsgl_t
modifier|*
name|agEsgl
parameter_list|,
name|bit32
name|idx
parameter_list|)
block|{
name|bit32
name|i
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaSgl_t
modifier|*
name|agSgl
decl_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|idx
condition|;
name|i
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agSgl
operator|=
operator|&
operator|(
name|agEsgl
operator|->
name|descriptor
index|[
name|i
index|]
operator|)
expr_stmt|;
endif|#
directive|endif
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatPrintSgl: agSgl %d upperAddr 0x%08x lowerAddr 0x%08x len 0x%08x ext 0x%08x\n"
operator|,
name|i
operator|,
name|agSgl
operator|->
name|sgUpper
operator|,
name|agSgl
operator|->
name|sgLower
operator|,
name|agSgl
operator|->
name|len
operator|,
name|agSgl
operator|->
name|extReserved
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSplitSGL
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|split
parameter_list|,
comment|/*in sector number, depeding on IO value */
name|bit32
name|tl
parameter_list|,
comment|/* in sector number */
name|bit32
name|flag
parameter_list|)
block|{
name|agsaSgl_t
modifier|*
name|agSgl
decl_stmt|;
name|agsaEsgl_t
modifier|*
name|agEsgl
decl_stmt|;
name|bit32
name|i
init|=
literal|0
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|totalLen
init|=
literal|0
decl_stmt|;
comment|/* in bytes */
name|bit32
name|splitLen
init|=
literal|0
decl_stmt|;
comment|/* in bytes */
name|bit32
name|splitDiffByte
init|=
literal|0
decl_stmt|;
comment|/* in bytes */
name|bit32
name|splitDiffExtra
init|=
literal|0
decl_stmt|;
comment|/* in bytes */
name|bit32
name|splitIdx
init|=
literal|0
decl_stmt|;
name|bit32
name|UpperAddr
decl_stmt|,
name|LowerAddr
decl_stmt|;
name|bit32
name|tmpLowerAddr
decl_stmt|;
name|void
modifier|*
name|sglVirtualAddr
decl_stmt|;
name|void
modifier|*
name|sglSplitVirtualAddr
decl_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smScsiRequest
operator|->
name|smSgl1
operator|.
name|type
operator|==
literal|0x80000000
condition|)
comment|/* esgl */
block|{
if|if
condition|(
name|flag
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: Not first time\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: UpperAddr 0x%08x LowerAddr 0x%08x\n"
operator|,
name|satIOContext
operator|->
name|UpperAddr
operator|,
name|satIOContext
operator|->
name|LowerAddr
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: SplitIdx %d AdjustBytes 0x%08x\n"
operator|,
name|satIOContext
operator|->
name|SplitIdx
operator|,
name|satIOContext
operator|->
name|AdjustBytes
operator|)
argument_list|)
expr_stmt|;
name|sglVirtualAddr
operator|=
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|agEsgl
operator|=
operator|(
name|agsaEsgl_t
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|sglSplitVirtualAddr
operator|=
operator|&
operator|(
name|agEsgl
operator|->
name|descriptor
index|[
name|satIOContext
operator|->
name|SplitIdx
index|]
operator|)
expr_stmt|;
name|agEsgl
operator|=
operator|(
name|agsaEsgl_t
operator|*
operator|)
name|sglSplitVirtualAddr
expr_stmt|;
if|if
condition|(
name|agEsgl
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSplitSGL: error!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* first sgl ajustment */
name|agSgl
operator|=
operator|&
operator|(
name|agEsgl
operator|->
name|descriptor
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|agSgl
operator|->
name|sgUpper
operator|=
name|satIOContext
operator|->
name|UpperAddr
expr_stmt|;
name|agSgl
operator|->
name|sgLower
operator|=
name|satIOContext
operator|->
name|LowerAddr
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
name|satIOContext
operator|->
name|AdjustBytes
expr_stmt|;
name|sm_memcpy
argument_list|(
name|sglVirtualAddr
argument_list|,
name|sglSplitVirtualAddr
argument_list|,
operator|(
name|satIOContext
operator|->
name|EsglLen
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|agsaSgl_t
argument_list|)
argument_list|)
expr_stmt|;
name|agEsgl
operator|=
operator|(
name|agsaEsgl_t
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|smsatPrintSgl
argument_list|(
name|smRoot
argument_list|,
operator|(
name|agsaEsgl_t
operator|*
operator|)
name|sglVirtualAddr
argument_list|,
name|satIOContext
operator|->
name|EsglLen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* first time */
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: first time\n"
operator|)
argument_list|)
expr_stmt|;
name|satIOContext
operator|->
name|EsglLen
operator|=
name|smScsiRequest
operator|->
name|smSgl1
operator|.
name|len
expr_stmt|;
name|agEsgl
operator|=
operator|(
name|agsaEsgl_t
operator|*
operator|)
name|smScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
if|if
condition|(
name|agEsgl
operator|==
name|agNULL
condition|)
block|{
return|return;
block|}
name|smsatPrintSgl
argument_list|(
name|smRoot
argument_list|,
name|agEsgl
argument_list|,
name|satIOContext
operator|->
name|EsglLen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tl
operator|>
name|split
condition|)
block|{
comment|/* split */
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: split case\n"
operator|)
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|agSgl
operator|=
operator|&
operator|(
name|agEsgl
operator|->
name|descriptor
index|[
name|i
index|]
operator|)
expr_stmt|;
name|splitLen
operator|=
name|splitLen
operator|+
name|agSgl
operator|->
name|len
expr_stmt|;
if|if
condition|(
name|splitLen
operator|>=
name|split
condition|)
block|{
name|splitDiffExtra
operator|=
name|splitLen
operator|-
name|split
expr_stmt|;
name|splitDiffByte
operator|=
name|agSgl
operator|->
name|len
operator|-
name|splitDiffExtra
expr_stmt|;
name|splitIdx
operator|=
name|i
expr_stmt|;
break|break;
block|}
name|i
operator|++
expr_stmt|;
block|}
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: splitIdx %d\n"
operator|,
name|splitIdx
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: splitDiffByte 0x%8x\n"
operator|,
name|splitDiffByte
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: splitDiffExtra 0x%8x \n"
operator|,
name|splitDiffExtra
operator|)
argument_list|)
expr_stmt|;
name|agSgl
operator|=
operator|&
operator|(
name|agEsgl
operator|->
name|descriptor
index|[
name|splitIdx
index|]
operator|)
expr_stmt|;
name|UpperAddr
operator|=
name|agSgl
operator|->
name|sgUpper
expr_stmt|;
name|LowerAddr
operator|=
name|agSgl
operator|->
name|sgLower
expr_stmt|;
name|tmpLowerAddr
operator|=
name|LowerAddr
operator|+
name|splitDiffByte
expr_stmt|;
if|if
condition|(
name|tmpLowerAddr
operator|<
name|LowerAddr
condition|)
block|{
name|UpperAddr
operator|=
name|UpperAddr
operator|+
literal|1
expr_stmt|;
block|}
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: UpperAddr 0x%08x tmpLowerAddr 0x%08x\n"
operator|,
name|UpperAddr
operator|,
name|tmpLowerAddr
operator|)
argument_list|)
expr_stmt|;
name|agSgl
operator|->
name|len
operator|=
name|splitDiffByte
expr_stmt|;
comment|/* Esgl len adjustment */
name|smScsiRequest
operator|->
name|smSgl1
operator|.
name|len
operator|=
name|splitIdx
expr_stmt|;
comment|/* expected data lent adjustment */
name|scsiCmnd
operator|->
name|expDataLength
operator|=
literal|0x20000
expr_stmt|;
comment|/* remeber for the next round */
name|satIOContext
operator|->
name|UpperAddr
operator|=
name|UpperAddr
expr_stmt|;
name|satIOContext
operator|->
name|LowerAddr
operator|=
name|tmpLowerAddr
expr_stmt|;
name|satIOContext
operator|->
name|SplitIdx
operator|=
name|splitIdx
expr_stmt|;
name|satIOContext
operator|->
name|AdjustBytes
operator|=
name|splitDiffExtra
expr_stmt|;
name|satIOContext
operator|->
name|EsglLen
operator|=
name|satIOContext
operator|->
name|EsglLen
operator|-
name|smScsiRequest
operator|->
name|smSgl1
operator|.
name|len
expr_stmt|;
name|satIOContext
operator|->
name|OrgTL
operator|=
name|satIOContext
operator|->
name|OrgTL
operator|-
literal|0x100
expr_stmt|;
comment|//    smsatPrintSgl(smRoot, agEsgl, satIOContext->EsglLen);
block|}
else|else
block|{
comment|/* no split */
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatSplitSGL: no split case\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Esgl len adjustment */
name|smScsiRequest
operator|->
name|smSgl1
operator|.
name|len
operator|=
name|satIOContext
operator|->
name|EsglLen
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|smScsiRequest
operator|->
name|smSgl1
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|agSgl
operator|=
operator|&
operator|(
name|agEsgl
operator|->
name|descriptor
index|[
name|i
index|]
operator|)
expr_stmt|;
name|totalLen
operator|=
name|totalLen
operator|+
operator|(
name|agSgl
operator|->
name|len
operator|)
expr_stmt|;
block|}
comment|/* expected data lent adjustment */
name|scsiCmnd
operator|->
name|expDataLength
operator|=
name|totalLen
expr_stmt|;
comment|//    smsatPrintSgl(smRoot, agEsgl, satIOContext->EsglLen);
block|}
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"not exntened esgl\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/******************************** end   of utils    ***********************************************************/
end_comment

end_unit


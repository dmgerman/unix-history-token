begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/src/smdefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/src/smproto.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/src/smtypes.h>
end_include

begin_decl_stmt
specifier|extern
name|smRoot_t
modifier|*
name|gsmRoot
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************** completion ***********************************************************/
end_comment

begin_function
name|FORCEINLINE
name|void
name|smllSATACompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|void
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
comment|//  smIntRoot_t          *smIntRoot = agNULL;
comment|//  smIntContext_t       *smAllShared = agNULL;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smDeviceData_t
modifier|*
name|pSatDevData
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smllSATACompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIORequest
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: agIORequest is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: smIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
if|if
condition|(
name|smIORequestBody
operator|->
name|ioCompleted
operator|==
name|agTRUE
condition|)
block|{
name|smDeviceHandle
operator|=
name|smIORequestBody
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: Error!!!!!! double completion!!!, ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|satIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: satIOContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pSatDevData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
if|if
condition|(
name|pSatDevData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: pSatDevData is NULL loc 1, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|->
name|satIntIoContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: external command!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: internal command!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|smDeviceHandle
operator|=
name|smIORequestBody
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: smDeviceHandle is NULL!!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|!=
name|pSatDevData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: diff device handle!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|->
name|satIntIoContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: external command!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: internal command!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: oneDeviceData is NULL!!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|->
name|satIntIoContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: external command!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: internal command!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
comment|/* release tag value for SATA */
if|if
condition|(
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
name|smsatTagRelease
argument_list|(
name|smRoot
argument_list|,
name|pSatDevData
argument_list|,
name|satIOContext
operator|->
name|sataTag
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smllSATACompleted: ncq tag 0x%x\n"
operator|,
name|satIOContext
operator|->
name|sataTag
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* just for debugging */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: agIOStatus is OSSA_IO_DS_NON_OPERATIONAL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: agIOStatus is OSSA_IO_DS_IN_RECOVERY!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smllSATACompleted: agIOStatus is OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|satIOContext
operator|->
name|satCompleteCB
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  smsatPacketCB * *   This routine is a callback function called from smllSATACompleted(). *   This CB routine deals with normal Packet command I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to smSatIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|smsatPacketCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|bit32
name|interruptContext
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
comment|//  bit32                     ataStatus = 0;
comment|//  bit32                     ataError;
name|bit32
name|status
init|=
name|SM_RC_SUCCESS
decl_stmt|;
comment|//  agsaFisRegD2HHeader_t     *statDevToHostFisHeader = agNULL;
comment|//  bit32                     dataLength;
name|bit8
name|bSenseKey
init|=
literal|0
decl_stmt|;
name|bit16
name|bSenseCodeInfo
init|=
literal|0
decl_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatPacketCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPacketCB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|interruptContext
operator|=
name|satIOContext
operator|->
name|interruptContext
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatPacketCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatPacketCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agIOInfoLen
operator|==
literal|0
operator|&&
name|agFirstDword
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatPacketCB: First, agIOStatus == OSSA_IO_SUCCESS, agFirstDword == agNULL, agIOInfoLen = %d\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
operator|!
operator|(
name|agIOInfoLen
operator|==
literal|0
operator|&&
name|agFirstDword
operator|==
name|agNULL
operator|)
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatPacketCB: Second, agIOStatus == OSSA_IO_SUCCESS , agFirstDword %p agIOInfoLen = %d\n"
operator|,
name|agFirstDword
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/*The SCSI command status is error, need to send REQUEST SENSE for getting more sense information*/
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|SENSE_DATA_LENGTH
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* memory allocation failure */
comment|/* just translate the ATAPI error register to sense information */
name|smsatTranslateATAPIErrorsToSCSIErrors
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPacketCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends request sense to ATAPI device for acquiring sense information */
name|status
operator|=
name|smsatRequestSenseForATAPI
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* just translate the ATAPI error register to sense information */
name|smsatTranslateATAPIErrorsToSCSIErrors
argument_list|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPacketCB: failed to call satRequestSenseForATAPI()\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatPacketCB: agIOStatus != OSSA_IO_SUCCESS, status %d\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatProcessAbnormalCompletion
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPacketCB: Unknown error \n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  smsatRequestSenseForATAPICB * *   This routine is a callback function called from smllSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to smSatIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|smsatRequestSenseForATAPICB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
comment|//   smSatIOContext_t            *satNewIOContext;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//   smSatInternalIo_t           *satNewIntIo = agNULL;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|bit32
name|interruptContext
decl_stmt|;
name|bit8
name|dataLength
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatRequestSenseForATAPICB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseForATAPICB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|interruptContext
operator|=
name|satIOContext
operator|->
name|interruptContext
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRequestSenseForATAPICB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatRequestSenseForATAPICB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agIOInfoLen
operator|==
literal|0
operator|&&
name|agFirstDword
operator|==
name|agNULL
operator|)
condition|)
block|{
comment|/* copy the request sense buffer to original IO buffer*/
if|if
condition|(
name|satIntIo
condition|)
block|{
name|sm_memcpy
argument_list|(
name|satOrgIOContext
operator|->
name|pSmSenseData
operator|->
name|senseData
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|virtPtr
argument_list|,
name|SENSE_DATA_LENGTH
argument_list|)
expr_stmt|;
block|}
name|satOrgIOContext
operator|->
name|pSmSenseData
operator|->
name|senseLen
operator|=
name|SENSE_DATA_LENGTH
expr_stmt|;
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* notify the OS to complete this SRB */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_UNDERFLOW
condition|)
block|{
comment|/* copy the request sense buffer to original IO buffer*/
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseForATAPICB: OSSA_IO_UNDERFLOW agIOInfoLen = %d\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|dataLength
operator|=
call|(
name|bit8
call|)
argument_list|(
name|scsiCmnd
operator|->
name|expDataLength
operator|-
name|agIOInfoLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
condition|)
block|{
name|sm_memcpy
argument_list|(
name|satOrgIOContext
operator|->
name|pSmSenseData
operator|->
name|senseData
argument_list|,
name|satIntIo
operator|->
name|satIntDmaMem
operator|.
name|virtPtr
argument_list|,
name|dataLength
argument_list|)
expr_stmt|;
block|}
name|satOrgIOContext
operator|->
name|pSmSenseData
operator|->
name|senseLen
operator|=
name|dataLength
expr_stmt|;
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* notify the OS to complete this SRB */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseForATAPICB: failed, agIOStatus error = 0x%x agIOInfoLen = %d\n"
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* notify the OS to complete this SRB */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatRequestSenseForATAPICB: end\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  smsatSetFeaturesPIOCB * *   This routine is a callback function called from smllSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to smSatIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|smsatSetFeaturesPIOCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|smIORequest_t
modifier|*
name|smIORequest
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesPIOCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesPIOCB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesPIOCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesPIOCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequest
operator|=
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIORequest
operator|->
name|tdData
operator|==
name|smIORequest
operator|->
name|smData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesPIOCB: the same tdData and smData error!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* check the agIOStatus */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_NO_DEVICE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_PORT_IN_RESET
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_INVALID
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesPIOCB: error status 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesPIOCB: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*if the ATAPI device support DMA, then enble this feature*/
if|if
condition|(
name|oneDeviceData
operator|->
name|satDMASupport
condition|)
block|{
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesPIOCB: memory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*Complete this identify packet device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends another ATA SET FEATURES based on DMA bit */
name|status
operator|=
name|smsatSetFeaturesDMA
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"satSetFeaturesPIOCB: failed to call smsatSetFeatures()\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*Complete this identify packet device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*Complete this identify packet device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesPIOCB: exit, agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  smsatDeviceResetCB * *   This routine is a callback function called from smllSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to smSatIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|smsatDeviceResetCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
comment|//    smSatIOContext_t          *satNewIOContext;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//    smSatInternalIo_t         *satNewIntIo = agNULL;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
endif|#
directive|endif
comment|//    bit32                     status;
name|bit32
name|AbortTM
init|=
name|agFALSE
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeviceResetCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
name|smDeviceHandle
operator|=
name|oneDeviceData
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatDeviceResetCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatDeviceResetCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatDeviceResetCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatDeviceResetCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeviceResetCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeviceResetCB: OSSA_IO_OPEN_CNX_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
comment|/* only agsaFisPioSetup_t is expected */
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeviceResetCB: ataStatus 0x%x ataError 0x%x!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*success */
if|if
condition|(
name|satOrgIOContext
operator|->
name|TMF
operator|==
name|AG_ABORT_TASK
condition|)
block|{
name|AbortTM
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|AbortTM
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeviceResetCB: calling satAbort!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatAbort
argument_list|(
name|smRoot
argument_list|,
name|agRoot
argument_list|,
name|satOrgIOContext
operator|->
name|satToBeAbortedIOContext
argument_list|)
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeviceResetCB: satPendingIO %d satNCQMaxIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeviceResetCB: satPendingNCQIO %d satPendingNONNCQIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMOK
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatDeviceResetCB: return\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  smsatExecuteDeviceDiagnosticCB * *   This routine is a callback function called from smllSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to smSatIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|smsatExecuteDeviceDiagnosticCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
comment|//    smSatIOContext_t            *satNewIOContext;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//    smSatInternalIo_t           *satNewIntIo = agNULL;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatExecuteDeviceDiagnosticCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatExecuteDeviceDiagnosticCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatExecuteDeviceDiagnosticCB: satOrgIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatExecuteDeviceDiagnosticCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|GLOBAL
name|void
name|smsatTranslateATAPIErrorsToSCSIErrors
parameter_list|(
name|bit8
name|bCommand
parameter_list|,
name|bit8
name|bATAStatus
parameter_list|,
name|bit8
name|bATAError
parameter_list|,
name|bit8
modifier|*
name|pSenseKey
parameter_list|,
name|bit16
modifier|*
name|pSenseCodeInfo
parameter_list|)
block|{
if|if
condition|(
name|pSenseKey
operator|==
name|agNULL
operator|||
name|pSenseCodeInfo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"TranslateATAErrorsToSCSIErros: pSenseKey == agNULL || pSenseCodeInfo == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|bATAStatus
operator|&
name|ERR_ATA_STATUS_MASK
condition|)
block|{
if|if
condition|(
name|bATAError
operator|&
name|NM_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_NOT_READY
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x3a00
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|ABRT_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|MCR_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_UNIT_ATTENTION
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x5a01
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|IDNF_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_MEDIUM_ERROR
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x1401
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|MC_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_UNIT_ATTENTION
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x2800
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|UNC_ATA_ERROR_MASK
condition|)
block|{
comment|/*READ*/
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_MEDIUM_ERROR
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x1100
expr_stmt|;
comment|/*add WRITE here */
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|ICRC_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x4703
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|bATAStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
literal|0x4400
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"unhandled ata error: bATAStatus = 0x%x, bATAError = 0x%x\n"
operator|,
name|bATAStatus
operator|,
name|bATAError
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|GLOBAL
name|void
name|smsatTranslateATAErrorsToSCSIErrors
parameter_list|(
name|bit8
name|bATAStatus
parameter_list|,
name|bit8
name|bATAError
parameter_list|,
name|bit8
modifier|*
name|pSenseKey
parameter_list|,
name|bit16
modifier|*
name|pSenseCodeInfo
parameter_list|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"TranslateATAErrorsToSCSIErros: bATAStatus=%d  bATAError= %d \n"
operator|,
name|bATAStatus
operator|,
name|bATAError
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pSenseKey
operator|==
name|agNULL
operator|||
name|pSenseCodeInfo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"TranslateATAErrorsToSCSIErros: pSenseKey == agNULL || pSenseCodeInfo == agNULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|bATAStatus
operator|&
name|ERR_ATA_STATUS_MASK
condition|)
block|{
if|if
condition|(
name|bATAError
operator|&
name|NM_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_NOT_READY
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|UNC_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_MEDIUM_ERROR
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
name|SCSI_SNSCODE_UNRECOVERED_READ_ERROR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|IDNF_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_ILLEGAL_REQUEST
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
name|SCSI_SNSCODE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|ABRT_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|MC_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_UNIT_ATTENTION
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
name|SCSI_SNSCODE_NOT_READY_TO_READY_CHANGE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|MCR_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_UNIT_ATTENTION
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
name|SCSI_SNSCODE_OPERATOR_MEDIUM_REMOVAL_REQUEST
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bATAError
operator|&
name|ICRC_ATA_ERROR_MASK
condition|)
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
name|SCSI_SNSCODE_INFORMATION_UNIT_CRC_ERROR
expr_stmt|;
block|}
else|else
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|bATAStatus
operator|&
name|DF_ATA_STATUS_MASK
condition|)
comment|/* INTERNAL TARGET FAILURE */
block|{
operator|*
name|pSenseKey
operator|=
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
operator|*
name|pSenseCodeInfo
operator|=
name|SCSI_SNSCODE_INTERNAL_TARGET_FAILURE
expr_stmt|;
block|}
block|}
end_function

begin_function
name|FORCEINLINE
name|void
name|smsatNonChainedDataIOCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
init|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|SatIntIo
init|=
name|satIOContext
operator|->
name|satIntIoContext
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|satIOContext
operator|->
name|pSatDevData
decl_stmt|;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|oneDeviceData
operator|->
name|smRoot
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
decl_stmt|;
name|bit32
name|interruptContext
init|=
name|satIOContext
operator|->
name|interruptContext
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatNonChainedDataIOCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SatIntIo
argument_list|)
expr_stmt|;
comment|/* Process completion */
if|if
condition|(
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|)
operator|&&
operator|(
name|agIOInfoLen
operator|==
literal|0
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedDataIOCB: success\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedDataIOCB: success agIORequest %p\n"
operator|,
name|agIORequest
operator|)
argument_list|)
expr_stmt|;
comment|/*      * Command was completed OK, this is the normal path.      * Now call the OS-App Specific layer about this completion.      */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedDataIOCB: calling smsatProcessAbnormalCompletion!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* More checking needed */
name|smsatProcessAbnormalCompletion
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|FORCEINLINE
name|void
name|smsatChainedDataIOCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
comment|//  smDeviceData_t             *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|bit32
name|dataLength
decl_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* agsaFisPioSetup_t or agsaFisRegDeviceToHost_t or agsaFisSetDevBits_t for read        agsaFisRegDeviceToHost_t or agsaFisSetDevBits_t for write        first, assumed to be Reg Device to Host FIS        This is OK to just find fis type     */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
comment|/* for debugging */
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* for debugging */
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: FAILED, error status and command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* the function below handles abort case */
name|smsatDelayedProcessAbnormalCompletion
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of error */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_DMA
case|:
comment|/* fall through */
case|case
name|SAT_READ_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_DMA_EXT
case|:
comment|/* fall through */
case|case
name|SAT_READ_SECTORS_EXT
case|:
comment|/* fall through */
case|case
name|SAT_READ_FPDMA_QUEUED
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_DMA
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_DMA_FUA_EXT
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_DMA_EXT
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: READ/WRITE success case\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internally genereated SAT_SMART_RETURN_STATUS */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* let's loop till TL */
comment|/* lba = lba + tl        loopnum--;        if (loopnum == 0) done      */
operator|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|)
operator|--
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|0
condition|)
block|{
comment|/* done with read */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* don't need to allocate payload memory here. Use the one allocated by OS layer */
name|dataLength
operator|=
literal|0
expr_stmt|;
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dataLength
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sending another ATA command */
switch|switch
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
condition|)
block|{
case|case
name|SCSIOPC_READ_6
case|:
comment|/* no loop should occur with READ6 since it fits in one ATA command */
break|break;
case|case
name|SCSIOPC_READ_10
case|:
comment|/* fall through */
case|case
name|SCSIOPC_READ_12
case|:
comment|/* fall through */
case|case
name|SCSIOPC_READ_16
case|:
comment|/* fall through */
name|status
operator|=
name|smsatRead_1
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSIOPC_WRITE_6
case|:
comment|/* no loop should occur with WRITE6 since it fits in one ATA command */
break|break;
case|case
name|SCSIOPC_WRITE_10
case|:
comment|/* fall through */
case|case
name|SCSIOPC_WRITE_12
case|:
comment|/* fall through */
case|case
name|SCSIOPC_WRITE_16
case|:
comment|/* fall through */
name|status
operator|=
name|smsatWrite_1
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: success but default case scsi cmd 0x%x ata cmd 0x%x!!!\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|tiError
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: calling satRead10_1 fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedDataIOCB: success but default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatNonChainedVerifyCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: SAT_READ_VERIFY_SECTORS!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: SAT_READ_VERIFY_SECTORS_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end error checking */
block|}
comment|/* process success from this point on */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: SAT_WRITE_DMA_EXT success \n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedVerifyCB: success but error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatChainedVerifyCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|bit32
name|dataLength
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: SAT_READ_VERIFY_SECTORS!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: SAT_READ_VERIFY_SECTORS_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end error checking */
block|}
comment|/* process success from this point on */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: SAT_WRITE_DMA_EXT success \n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* let's loop till TL */
comment|/* lba = lba + tl        loopnum--;        if (loopnum == 0) done      */
operator|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|)
operator|--
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|0
condition|)
block|{
comment|/*         done with write and verify       */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
else|else
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dataLength
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatChainedVerify
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: calling satChainedVerify fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedVerifyCB: success but error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatTestUnitReadyCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of TestUnitReady     Process SAT_GET_MEDIA_STATUS     Process SAT_CHECK_POWER_MODE   */
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: no internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: yes internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* orginal smIOContext */
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|satIOContext
operator|->
name|satIntIoContext
operator|->
name|satOrgSmIORequest
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|smOrgIORequest
operator|->
name|tdData
expr_stmt|;
name|satOrgIOContext
operator|=
operator|&
operator|(
name|smOrgIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailAborted
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     HW checks an error for us and the results is agIOStatus   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|statDevToHostFisHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_GET_MEDIA_STATUS
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: SAT_GET_MEDIA_STATUS failed!!! \n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking NM bit */
if|if
condition|(
name|ataError
operator|&
name|SCSI_NM_MASK
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_CHECK_POWER_MODE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: SAT_CHECK_POWER_MODE failed!!! \n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_DOES_NOT_RESPOND_TO_SELECTION
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: default failed command %d!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
comment|/* end error */
comment|/* ATA command completes sucessfully */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_GET_MEDIA_STATUS
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: SAT_GET_MEDIA_STATUS success\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends SAT_CHECK_POWER_MODE */
name|status
operator|=
name|smsatTestUnitReady_1
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* sending SAT_CHECK_POWER_MODE fails */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: calling satTestUnitReady_1 fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_CHECK_POWER_MODE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: SAT_CHECK_POWER_MODE success\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* returns good status */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatTestUnitReadyCB: default success command %d!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_CAUSE_NOT_REPORTABLE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatRequestSenseCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/* ATA Vol 1, p299 SAT_SMART_RETURN_STATUS */
comment|/*     if threshold exceeds, return SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE     else call satRequestSense_1 to send CHECK_POWER_MODE   */
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|agsaFisRegD2HData_t
name|statDevToHostFisData
decl_stmt|;
name|bit32
name|allocationLen
init|=
literal|0
decl_stmt|;
name|bit32
name|dataLength
decl_stmt|;
name|bit8
modifier|*
name|pDataBuffer
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatRequestSenseCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSenseCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
comment|/*ttttttthe one */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSenseCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|pDataBuffer
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|//satOrgIOContext->pSense;
block|}
else|else
block|{
name|pDataBuffer
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|//satOrgIOContext->pSense;
block|}
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSenseCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSenseCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSenseCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|pDataBuffer
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|//satOrgIOContext->pSense;
block|}
else|else
block|{
name|pDataBuffer
operator|=
operator|(
name|bit8
operator|*
operator|)
operator|(
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|//satOrgIOContext->pSense;
block|}
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSenseCB: fis command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|allocationLen
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: allocationLen in CDB %d 0x%x!!!\n"
operator|,
name|allocationLen
operator|,
name|allocationLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
comment|/* for debugging */
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
operator|&&
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_RETURN_STATUS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: FAILED, Wrong FIS type 0x%x and SAT_SMART_RETURN_STATU!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: FAILED, Wrong FIS type 0x%x and SAT_CHECK_POWER_MODE!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* for debugging */
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
operator|&&
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_RETURN_STATUS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: FAILED, error status and SAT_SMART_RETURN_STATU!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: FAILED, error status and SAT_CHECK_POWER_MODE!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
operator|&&
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_RETURN_STATUS
condition|)
block|{
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SMART RETURN STATUS */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|allocationLen
condition|)
block|{
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SAT_CHECK_POWER_MODE */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOW_POWER_CONDITION_ON
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|allocationLen
condition|)
block|{
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|statDevToHostFisData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegD2HData_t
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_SMART
case|:
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSenseCB: SAT_SMART_RETURN_STATUS case\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|statDevToHostFisData
operator|.
name|lbaMid
operator|==
literal|0xF4
operator|||
name|statDevToHostFisData
operator|.
name|lbaHigh
operator|==
literal|0x2C
condition|)
block|{
comment|/* threshold exceeds */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: threshold exceeds!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SMART RETURN STATUS */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|allocationLen
condition|)
block|{
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internally genereated SAT_SMART_RETURN_STATUS */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* at this point, successful SMART_RETURN_STATUS        xmit SAT_CHECK_POWER_MODE     */
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
else|else
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dataLength
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* failed as a part of sending SMART RETURN STATUS */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_HARDWARE_IMPENDING_FAILURE
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|allocationLen
condition|)
block|{
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sending SAT_CHECK_POWER_MODE */
name|status
operator|=
name|smsatRequestSense_1
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* sending SAT_CHECK_POWER_MODE fails */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* failed during sending SAT_CHECK_POWER_MODE */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOW_POWER_CONDITION_ON
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|allocationLen
condition|)
block|{
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: calling satRequestSense_1 fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_CHECK_POWER_MODE
case|:
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSenseCB: SAT_CHECK_POWER_MODE case\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* check ATA STANDBY state */
if|if
condition|(
name|statDevToHostFisData
operator|.
name|sectorCount
operator|==
literal|0x00
condition|)
block|{
comment|/* in STANDBY */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: in standby!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SAT_CHECK_POWER_MODE */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOW_POWER_CONDITION_ON
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|allocationLen
condition|)
block|{
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internnaly generated SAT_CHECK_POWER_MODE */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|satFormatState
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: in format!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* report using the original tiIOrequst */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_NOT_READY_FORMAT_IN_PROGRESS
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|allocationLen
condition|)
block|{
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
comment|/* normal: returns good status for requestsense */
comment|/* report using the original tiIOrequst */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatRequestSenseCB: returning good status for requestsense\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SENSE_DATA_LENGTH
operator|<
name|allocationLen
condition|)
block|{
comment|/* underrun */
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatRequestSenseCB reporting underrun lenNeeded=0x%x lenReceived=0x%x smIORequest=%p\n"
operator|,
name|SENSE_DATA_LENGTH
operator|,
name|allocationLen
operator|,
name|smOrgIORequest
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|SENSE_DATA_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatRequestSenseCB: success but error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
comment|/* pSense here is a part of satOrgIOContext */
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSmSenseData
operator|->
name|senseData
expr_stmt|;
name|satOrgIOContext
operator|->
name|pSmSenseData
operator|->
name|senseLen
operator|=
name|SENSE_DATA_LENGTH
expr_stmt|;
comment|/* unspecified case, return no sense and no addition info */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pDataBuffer
argument_list|,
name|pSense
argument_list|,
name|MIN
argument_list|(
name|SENSE_DATA_LENGTH
argument_list|,
name|allocationLen
argument_list|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* switch */
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSendDiagnosticCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of SendDiagnotic     Process READ VERIFY SECTOR(S) EXT two time     Process SMART ECECUTE OFF-LINE IMMEDIATE   */
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
name|oneDeviceData
operator|->
name|satBGPendingDiag
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x01
operator|&&
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x02
condition|)
block|{
comment|/* no completion for background send diagnotic. It is done in satSendDiagnostic() */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: fis command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/*     checking IO status, FIS type and error status   */
name|oneDeviceData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
name|oneDeviceData
operator|->
name|satBGPendingDiag
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: FAILED, NOT IO_SUCCESS and SAT_READ_VERIFY_SECTORS(_EXT)!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: FAILED, NOT IO_SUCCESS and SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* for debugging */
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: FAILED, Wrong FIS type 0x%x and SAT_READ_VERIFY_SECTORS(_EXT)!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: FAILED, Wrong FIS type 0x%x and SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* for debugging */
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: FAILED, error status and SAT_READ_VERIFY_SECTORS(_EXT)!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: FAILED, error status and SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
operator|)
condition|)
block|{
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SAT_READ_VERIFY_SECTORS(_EXT) */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_FAILED_SELF_TEST
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
comment|/* report using the original tiIOrequst */
comment|/* failed during sending SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_FAILED_SELF_TEST
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x01
operator|&&
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x02
condition|)
block|{
comment|/* no completion for background send diagnotic. It is done in satSendDiagnostic() */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
comment|/* processing success case */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: SAT_READ_VERIFY_SECTORS(_EXT) case\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satVerifyState
operator|++
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: satVerifyState %d\n"
operator|,
name|oneDeviceData
operator|->
name|satVerifyState
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internally genereated AT_READ_VERIFY_SECTORS(_EXT) */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|satVerifyState
operator|==
literal|3
condition|)
block|{
comment|/* reset satVerifyState */
name|oneDeviceData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
comment|/* return GOOD status */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: return GOOD status\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
comment|/* prepare SAT_READ_VERIFY_SECTORS(_EXT) */
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* reset satVerifyState */
name|oneDeviceData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
comment|/* failed as a part of sending SAT_READ_VERIFY_SECTORS(_EXT) */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_FAILED_SELF_TEST
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*        * Need to initialize all the fields within satIOContext        */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|satVerifyState
operator|==
literal|1
condition|)
block|{
comment|/* sending SAT_CHECK_POWER_MODE */
name|status
operator|=
name|smsatSendDiagnostic_1
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* oneDeviceData->satVerifyState == 2 */
name|status
operator|=
name|smsatSendDiagnostic_2
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* sending SAT_READ_VERIFY_SECTORS(_EXT) fails */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* failed during sending SAT_READ_VERIFY_SECTORS(_EXT) */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_LOGICAL_UNIT_FAILED_SELF_TEST
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
comment|/* reset satVerifyState */
name|oneDeviceData
operator|->
name|satVerifyState
operator|=
literal|0
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: calling satSendDiagnostic_1 or _2 fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* oneDeviceData->satVerifyState == 1 or 2 */
break|break;
case|case
name|SAT_SMART
case|:
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE case\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satBGPendingDiag
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|==
literal|0x01
operator|||
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|==
literal|0x02
condition|)
block|{
comment|/* for background send diagnostic, no completion here. It is done already. */
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with AT_SMART_EXEUTE_OFF_LINE_IMMEDIATE */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: returning but no IOCompleted\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: returning good status for senddiagnostic\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with AT_SMART_EXEUTE_OFF_LINE_IMMEDIATE */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSendDiagnosticCB: success but error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
comment|/* unspecified case, return no sense and no addition info */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatStartStopUnitCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of StartStopUnit     Process FLUSH CACHE (EXT)     Process STANDBY     Process READ VERIFY SECTOR(S) EXT     Process MEDIA EJECT   */
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnitCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: immed bit 0!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* IMMED == 1 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: immed bit 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_FLUSH_CACHE
case|:
comment|/* fall through */
case|case
name|SAT_FLUSH_CACHE_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: SAT_FLUSH_CACHE(_EXT)!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* check immed bit in scsi command */
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* IMMED == 1 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
condition|)
block|{
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SAT_STANDBY
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: SAT_STANDBY\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* check immed bit in scsi command */
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* IMMED == 1 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
condition|)
block|{
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: SAT_READ_VERIFY_SECTORS(_EXT)\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* IMMED == 1 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
condition|)
block|{
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SAT_MEDIA_EJECT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: SAT_MEDIA_EJECT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIA_LOAD_OR_EJECT_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
comment|/* IMMED == 1 */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
condition|)
block|{
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIA_LOAD_OR_EJECT_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* unspecified case, return no sense and no addition info */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: default command %d\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* switch */
return|return;
block|}
comment|/* error check */
block|}
comment|/* ATA command completes sucessfully */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_FLUSH_CACHE
case|:
comment|/* fall through */
case|case
name|SAT_FLUSH_CACHE_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: SAT_READ_VERIFY_SECTORS(_EXT) success case\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with SAT_FLUSH_CACHE(_EXT) */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* at this point, successful SAT_READ_VERIFY_SECTORS(_EXT)        send SAT_SATNDBY     */
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* IMMED == 1 */
block|{
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sending SAT_STANDBY */
name|status
operator|=
name|smsatStartStopUnit_1
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* sending SAT_CHECK_POWER_MODE fails */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* IMMED == 1 */
block|{
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ABORTED_COMMAND
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_COMMAND_SEQUENCE_ERROR
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: calling satStartStopUnit_1 fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_STANDBY
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: SAT_STANDBY success case\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with SAT_STANDBY */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*       if immed == 0, return good status      */
comment|/* IMMED == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|satStopState
operator|=
name|agTRUE
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: SAT_READ_VERIFY_SECTORS(_EXT) success case\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with SAT_READ_VERIFY_SECTORS(_EXT) */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*       if immed == 0, return good status      */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
comment|/*       if immed == 0, return good status      */
comment|/*       don't forget to check and set driver state; Active power state     */
name|oneDeviceData
operator|->
name|satStopState
operator|=
name|agFALSE
expr_stmt|;
break|break;
case|case
name|SAT_MEDIA_EJECT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatStartStopUnitCB: SAT_MEDIA_EJECT success case\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with SAT_READ_VERIFY_SECTORS(_EXT) */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*       if immed == 0, return good status      */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_IMMED_MASK
operator|)
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatStartStopUnitCB:success but  error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
comment|/* unspecified case, return no sense and no addition info */
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatWriteSame10CB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smNewIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|bit32
name|sectorcount
init|=
literal|0
decl_stmt|;
name|bit32
name|lba
init|=
literal|0
decl_stmt|,
name|tl
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|agsaFisSetDevBitsHeader_t
modifier|*
name|statSetDevBitFisHeader
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatWriteSame10CB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10CB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatWriteSame10CB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatWriteSame10CB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatWriteSame10CB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatWriteSame10CB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* FP, DMA and PIO write */
comment|/* First, assumed to be Reg Device to Host FIS */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|==
name|SET_DEV_BITS_FIS
condition|)
block|{
name|statSetDevBitFisHeader
operator|=
operator|(
name|agsaFisSetDevBitsHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
comment|/* Get ATA Status register */
name|ataStatus
operator|=
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x70
operator|)
expr_stmt|;
comment|/* bits 4,5,6 */
name|ataStatus
operator|=
name|ataStatus
operator||
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x07
operator|)
expr_stmt|;
comment|/* bits 0,1,2 */
block|}
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/*     checking IO status, FIS type and error status     FIS type should be either REG_DEV_TO_HOST_FIS or SET_DEV_BITS_FIS   */
if|if
condition|(
operator|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
operator|)
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: SAT_WRITE_DMA_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: SAT_WRITE_SECTORS_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: SAT_WRITE_FPDMA_QUEUED!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end error */
block|}
comment|/* process success from this point on */
comment|/*     note: inefficient implementation until a single block can be manipulated   */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10CB: SAT_WRITE_DMA_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10CB: SAT_WRITE_SECTORS_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10CB: SAT_WRITE_FPDMA_QUEUED success\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: error case command 0x%x success!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*     increment LBA by one, keeping the same sector count(1)     sends another ATA command with the changed parameters   */
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satSectorDone
operator|++
expr_stmt|;
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: sectordone %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satSectorDone
operator|)
argument_list|)
expr_stmt|;
name|lba
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
expr_stmt|;
name|tl
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatWriteSame10CB: lba 0x%x tl 0x%x\n"
operator|,
name|lba
operator|,
name|tl
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
literal|0
condition|)
block|{
comment|/* (oneDeviceData->satMaxUserAddrSectors - 1) - lba*/
name|sectorcount
operator|=
operator|(
literal|0x0FFFFFFF
operator|-
literal|1
operator|)
operator|-
name|lba
expr_stmt|;
block|}
else|else
block|{
name|sectorcount
operator|=
name|tl
expr_stmt|;
block|}
if|if
condition|(
name|sectorcount
operator|<=
literal|0
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: incorrect sectorcount 0x%x!!!\n"
operator|,
name|sectorcount
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sectorcount
operator|==
name|oneDeviceData
operator|->
name|satSectorDone
condition|)
block|{
comment|/*       done with writesame     */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: return writesame done!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satSectorDone
operator|=
literal|0
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* sends another ATA command */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: sends another SAT_WRITE_DMA_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: sends another SAT_WRITE_SECTORS_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: sends another SAT_WRITE_FPDMA_QUEUED!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
comment|/* the one to be used */
name|smNewIORequestBody
operator|=
name|satNewIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|=
operator|&
name|smNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
expr_stmt|;
name|satNewIOContext
operator|->
name|pSatDevData
operator|=
name|oneDeviceData
expr_stmt|;
name|satNewIOContext
operator|->
name|pFis
operator|=
operator|&
name|smNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
expr_stmt|;
name|satNewIOContext
operator|->
name|pScsiCmnd
operator|=
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
expr_stmt|;
comment|/* saves scsi command for LBA and number of blocks */
name|sm_memcpy
argument_list|(
name|satNewIOContext
operator|->
name|pScsiCmnd
argument_list|,
name|scsiCmnd
argument_list|,
sizeof|sizeof
argument_list|(
name|smIniScsiCmnd_t
argument_list|)
argument_list|)
expr_stmt|;
name|satNewIOContext
operator|->
name|pSense
operator|=
operator|&
name|smNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
expr_stmt|;
name|satNewIOContext
operator|->
name|pSmSenseData
operator|=
operator|&
name|smNewIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
expr_stmt|;
name|satNewIOContext
operator|->
name|pSmSenseData
operator|->
name|senseData
operator|=
name|satNewIOContext
operator|->
name|pSense
expr_stmt|;
name|satNewIOContext
operator|->
name|smRequestBody
operator|=
name|satNewIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satNewIOContext
operator|->
name|interruptContext
operator|=
name|satNewIOContext
operator|->
name|interruptContext
expr_stmt|;
name|satNewIOContext
operator|->
name|satIntIoContext
operator|=
name|satNewIntIo
expr_stmt|;
name|satNewIOContext
operator|->
name|psmDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
comment|/* saves smScsiXchg; only for writesame10() */
name|satNewIOContext
operator|->
name|smScsiXchg
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
condition|)
block|{
name|status
operator|=
name|smsatWriteSame10_1
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|,
name|lba
operator|+
name|oneDeviceData
operator|->
name|satSectorDone
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
condition|)
block|{
name|status
operator|=
name|smsatWriteSame10_2
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|,
name|lba
operator|+
name|oneDeviceData
operator|->
name|satSectorDone
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
name|status
operator|=
name|smsatWriteSame10_3
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|,
name|lba
operator|+
name|oneDeviceData
operator|->
name|satSectorDone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|tiError
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB: sucess but error in command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* sending ATA command fails */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteSame10CB:calling satWriteSame10_1 fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end send fails */
block|}
comment|/* end sends another ATA command */
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatLogSenseCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//  satDeviceData_t          *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|smScsiInitiatorRequest_t
modifier|*
name|smOrgScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|satReadLogExtSelfTest_t
modifier|*
name|virtAddr1
decl_stmt|;
name|satSmartReadLogSelfTest_t
modifier|*
name|virtAddr2
decl_stmt|;
name|bit8
modifier|*
name|pLogPage
decl_stmt|;
name|bit8
name|LogPage
index|[
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
index|]
decl_stmt|;
name|bit8
name|SelfTestExecutionStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|i
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|agsaFisRegD2HData_t
name|statDevToHostFisData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|allocationLen
init|=
literal|0
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatLogSenseCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSenseCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatLogSenseCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smOrgScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
comment|/* ATA command response payload */
name|smScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatLogSenseCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
name|pLogPage
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smOrgScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
comment|/* ATA command response payload */
name|smScsiRequest
operator|=
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|)
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* non-data and pio read -> device to host and pio setup fis are expected */
comment|/*       first, assumed to be Reg Device to Host FIS       This is OK to just find fis type     */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
operator|)
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_LOG_EXT
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: SAT_READ_LOG_EXT failed!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_READ_LOG
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: SAT_SMART_READ_LOG failed!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_RETURN_STATUS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: SAT_SMART_RETURN_STATUS failed!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: error unknown command 0x%x feature 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* error checking */
block|}
comment|/* prcessing the success case */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|statDevToHostFisData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaFisRegD2HData_t
argument_list|)
argument_list|)
expr_stmt|;
name|allocationLen
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSenseCB: allocationLen in CDB %d 0x%x\n"
operator|,
name|allocationLen
operator|,
name|allocationLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_LOG_EXT
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSenseCB: SAT_READ_LOG_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* process log data and sends it to upper */
comment|/* ATA: Extended Self-Test Log */
name|virtAddr1
operator|=
operator|(
name|satReadLogExtSelfTest_t
operator|*
operator|)
operator|(
name|smScsiRequest
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|/*       ATA/ATAPI VOLII, p197, 287       self-test execution status (4 bits); ((virtAddr1->byte[5]& 0xF0)>> 4)     */
name|SelfTestExecutionStatus
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|virtAddr1
operator|->
name|byte
index|[
literal|5
index|]
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
comment|/* fills in the log page from ATA log page */
comment|/* SPC-4, 7.2.10, Table 216, 217, p 259 - 260 */
name|LogPage
index|[
literal|0
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* page code */
name|LogPage
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|LogPage
index|[
literal|2
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* 0x190, page length */
name|LogPage
index|[
literal|3
index|]
operator|=
literal|0x90
expr_stmt|;
comment|/* SPC-4, Table 217 */
name|LogPage
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Parameter Code */
name|LogPage
index|[
literal|5
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Parameter Code,  unspecfied but ... */
name|LogPage
index|[
literal|6
index|]
operator|=
literal|3
expr_stmt|;
comment|/* unspecified but ... */
name|LogPage
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* Parameter Length */
name|LogPage
index|[
literal|8
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
literal|0
operator||
operator|(
operator|(
name|virtAddr1
operator|->
name|byte
index|[
literal|5
index|]
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
comment|/* Self Test Code and Self-Test Result */
name|LogPage
index|[
literal|9
index|]
operator|=
literal|0
expr_stmt|;
comment|/* self test number */
name|LogPage
index|[
literal|10
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|7
index|]
expr_stmt|;
comment|/* time stamp, MSB */
name|LogPage
index|[
literal|11
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|6
index|]
expr_stmt|;
comment|/* time stamp, LSB */
name|LogPage
index|[
literal|12
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure MSB*/
name|LogPage
index|[
literal|13
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|14
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|14
index|]
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|15
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|13
index|]
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|16
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|12
index|]
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|17
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|11
index|]
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|18
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|10
index|]
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|19
index|]
operator|=
name|virtAddr1
operator|->
name|byte
index|[
literal|9
index|]
expr_stmt|;
comment|/* address of first failure LSB */
comment|/* SAT rev8 Table75, p 76 */
switch|switch
condition|(
name|SelfTestExecutionStatus
condition|)
block|{
case|case
literal|0
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x81
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x82
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x83
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x84
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x85
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x86
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_MEDIUM_ERROR
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x87
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x88
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* fall through */
case|case
literal|10
case|:
comment|/* fall through */
case|case
literal|11
case|:
comment|/* fall through */
case|case
literal|12
case|:
comment|/* fall through */
case|case
literal|13
case|:
comment|/* fall through */
case|case
literal|14
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: Error, incorrect SelfTestExecutionStatus 0x%x!!!\n"
operator|,
name|SelfTestExecutionStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|LogPage
index|[
literal|23
index|]
operator|=
literal|0
expr_stmt|;
comment|/* vendor specific */
comment|/* the rest of Self-test results log */
comment|/* 403 is from SPC-4, 7.2.10, Table 216, p 259*/
for|for
control|(
name|i
operator|=
literal|24
init|;
name|i
operator|<=
literal|403
condition|;
name|i
operator|++
control|)
block|{
name|LogPage
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
comment|/* vendor specific */
block|}
name|sm_memcpy
argument_list|(
name|pLogPage
argument_list|,
name|LogPage
argument_list|,
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
operator|<
name|allocationLen
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatLogSenseCB: 1st underrun allocationLen %d len %d \n"
operator|,
name|allocationLen
operator|,
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
operator|)
argument_list|)
expr_stmt|;
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_READ_LOG
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSenseCB: SAT_SMART_READ_LOG success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* process log data and sends it to upper */
comment|/* ATA: Extended Self-Test Log */
name|virtAddr2
operator|=
operator|(
name|satSmartReadLogSelfTest_t
operator|*
operator|)
operator|(
name|smScsiRequest
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
comment|/*         SPC-4, p197, 287         self-test execution status (4 bits); ((virtAddr2->byte[3]& 0xF0)>> 4)       */
name|SelfTestExecutionStatus
operator|=
call|(
name|bit8
call|)
argument_list|(
operator|(
operator|(
name|virtAddr2
operator|->
name|byte
index|[
literal|3
index|]
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
comment|/* fills in the log page from ATA log page */
comment|/* SPC-4, 7.2.10, Table 216, 217, p 259 - 260 */
name|LogPage
index|[
literal|0
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* page code */
name|LogPage
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|LogPage
index|[
literal|2
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* 0x190, page length */
name|LogPage
index|[
literal|3
index|]
operator|=
literal|0x90
expr_stmt|;
comment|/* 0x190, page length */
comment|/* SPC-4, Table 217 */
name|LogPage
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Parameter Code */
name|LogPage
index|[
literal|5
index|]
operator|=
literal|0x01
expr_stmt|;
comment|/* Parameter Code unspecfied but ... */
name|LogPage
index|[
literal|6
index|]
operator|=
literal|3
expr_stmt|;
comment|/* unspecified but ... */
name|LogPage
index|[
literal|7
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* Parameter Length */
name|LogPage
index|[
literal|8
index|]
operator|=
call|(
name|bit8
call|)
argument_list|(
literal|0
operator||
operator|(
operator|(
name|virtAddr2
operator|->
name|byte
index|[
literal|3
index|]
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
operator|)
argument_list|)
expr_stmt|;
comment|/* Self Test Code and Self-Test Result */
name|LogPage
index|[
literal|9
index|]
operator|=
literal|0
expr_stmt|;
comment|/* self test number */
name|LogPage
index|[
literal|10
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|5
index|]
expr_stmt|;
comment|/* time stamp, MSB */
name|LogPage
index|[
literal|11
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|4
index|]
expr_stmt|;
comment|/* time stamp, LSB */
name|LogPage
index|[
literal|12
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure MSB*/
name|LogPage
index|[
literal|13
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|14
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|15
index|]
operator|=
literal|0
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|16
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|10
index|]
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|17
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|9
index|]
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|18
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|8
index|]
expr_stmt|;
comment|/* address of first failure */
name|LogPage
index|[
literal|19
index|]
operator|=
name|virtAddr2
operator|->
name|byte
index|[
literal|7
index|]
expr_stmt|;
comment|/* address of first failure LSB */
comment|/* SAT rev8 Table75, p 76 */
switch|switch
condition|(
name|SelfTestExecutionStatus
condition|)
block|{
case|case
literal|0
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x81
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x82
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_ABORTED_COMMAND
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x83
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x84
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x85
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x86
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_MEDIUM_ERROR
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x87
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_HARDWARE_ERROR
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_DIAGNOSTIC_FAILURE_ON_COMPONENT_NN
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
literal|0x88
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* fall through */
case|case
literal|10
case|:
comment|/* fall through */
case|case
literal|11
case|:
comment|/* fall through */
case|case
literal|12
case|:
comment|/* fall through */
case|case
literal|13
case|:
comment|/* fall through */
case|case
literal|14
case|:
comment|/* unspecified */
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|LogPage
index|[
literal|20
index|]
operator|=
literal|0
operator||
name|SCSI_SNSKEY_NO_SENSE
expr_stmt|;
name|LogPage
index|[
literal|21
index|]
operator|=
operator|(
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|LogPage
index|[
literal|22
index|]
operator|=
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
operator|&
literal|0xFF
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: Error, incorrect SelfTestExecutionStatus 0x%x!!!\n"
operator|,
name|SelfTestExecutionStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|LogPage
index|[
literal|23
index|]
operator|=
literal|0
expr_stmt|;
comment|/* vendor specific */
comment|/* the rest of Self-test results log */
comment|/* 403 is from SPC-4, 7.2.10, Table 216, p 259*/
for|for
control|(
name|i
operator|=
literal|24
init|;
name|i
operator|<=
literal|403
condition|;
name|i
operator|++
control|)
block|{
name|LogPage
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
comment|/* vendor specific */
block|}
name|sm_memcpy
argument_list|(
name|pLogPage
argument_list|,
name|LogPage
argument_list|,
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
operator|<
name|allocationLen
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatLogSenseCB: 2nd underrun allocationLen %d len %d \n"
operator|,
name|allocationLen
operator|,
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
operator|)
argument_list|)
expr_stmt|;
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|SELFTEST_RESULTS_LOG_PAGE_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_RETURN_STATUS
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatLogSenseCB: SAT_SMART_RETURN_STATUS success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* fills in the log page from ATA output */
comment|/* SPC-4, 7.2.5, Table 209, 211, p 255 */
name|LogPage
index|[
literal|0
index|]
operator|=
literal|0x2F
expr_stmt|;
comment|/* page code unspecified */
name|LogPage
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* reserved */
name|LogPage
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* page length */
name|LogPage
index|[
literal|3
index|]
operator|=
literal|0x07
expr_stmt|;
comment|/* page length */
comment|/*         SPC-4, 7.2.5, Table 211, p 255         no vendor specific field        */
name|LogPage
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Parameter Code */
name|LogPage
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Parameter Code unspecfied but to do: */
name|LogPage
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
comment|/* unspecified */
name|LogPage
index|[
literal|7
index|]
operator|=
literal|0x03
expr_stmt|;
comment|/* Parameter length, unspecified */
comment|/* SAT rev8, 10.2.3.1 Table 72, p 73 */
if|if
condition|(
name|statDevToHostFisData
operator|.
name|lbaMid
operator|==
literal|0x4F
operator|||
name|statDevToHostFisData
operator|.
name|lbaHigh
operator|==
literal|0xC2
condition|)
block|{
name|LogPage
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Sense code */
name|LogPage
index|[
literal|9
index|]
operator|=
literal|0
expr_stmt|;
comment|/* Sense code qualifier */
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisData
operator|.
name|lbaMid
operator|==
literal|0xF4
operator|||
name|statDevToHostFisData
operator|.
name|lbaHigh
operator|==
literal|0x2C
condition|)
block|{
name|LogPage
index|[
literal|8
index|]
operator|=
literal|0x5D
expr_stmt|;
comment|/* Sense code */
name|LogPage
index|[
literal|9
index|]
operator|=
literal|0x10
expr_stmt|;
comment|/* Sense code qualifier */
block|}
comment|/* Assumption: No support for SCT */
name|LogPage
index|[
literal|10
index|]
operator|=
literal|0xFF
expr_stmt|;
comment|/* Most Recent Temperature Reading */
name|sm_memcpy
argument_list|(
name|pLogPage
argument_list|,
name|LogPage
argument_list|,
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|INFORMATION_EXCEPTIONS_LOG_PAGE_LENGTH
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|INFORMATION_EXCEPTIONS_LOG_PAGE_LENGTH
operator|<
name|allocationLen
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatLogSenseCB: 3rd underrun allocationLen %d len %d \n"
operator|,
name|allocationLen
operator|,
name|INFORMATION_EXCEPTIONS_LOG_PAGE_LENGTH
operator|)
argument_list|)
expr_stmt|;
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|INFORMATION_EXCEPTIONS_LOG_PAGE_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: error unknown command success 0x%x feature 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatLogSenseCB: error unknown command success 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSMARTEnableCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
comment|//  satDeviceData_t           *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSMARTEnableCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTEnableCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
comment|/*ttttttthe one */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTEnableCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTEnableCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTEnableCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTEnableCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTEnableCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTEnableCB: not success status, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* process success case */
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|512
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatLogSense_1
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* sending SAT_CHECK_POWER_MODE fails */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatModeSelect6n10CB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
comment|/* smScsiXchg */
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SET_FEATURES
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x82
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x02
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: 1 SAT_SET_FEATURES failed, feature 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0xAA
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x55
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: 2 SAT_SET_FEATURES failed, feature 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: error unknown command 0x%x feature 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_ENABLE_OPERATIONS
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_DISABLE_OPERATIONS
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: SAT_SMART_ENABLE/DISABLE_OPERATIONS failed, feature 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: error unknown command 0x%x feature 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* error checking */
block|}
comment|/* prcessing the success case */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SET_FEATURES
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x82
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x02
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: 1 SAT_SET_FEATURES success, feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x02
condition|)
block|{
comment|/* enable write cache */
name|oneDeviceData
operator|->
name|satWriteCacheEnabled
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
comment|/* disable write cache */
name|oneDeviceData
operator|->
name|satWriteCacheEnabled
operator|=
name|agFALSE
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends either ATA SET FEATURES based on DRA bit */
name|status
operator|=
name|smsatModeSelect6n10_1
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* sending ATA command fails */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: calling satModeSelect6_1 fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end send fails */
return|return;
block|}
elseif|else
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0xAA
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
literal|0x55
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: 2 SAT_SET_FEATURES success, feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* return stat_good */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: error unknown command success 0x%x feature 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
condition|)
block|{
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_ENABLE_OPERATIONS
operator|)
operator|||
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_DISABLE_OPERATIONS
operator|)
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: SAT_SMART_ENABLE/DISABLE_OPERATIONS success, feature 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* return stat_good */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: error unknown command failed 0x%x feature 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatModeSelect6n10CB: error default case command success 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSynchronizeCache10n16CB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of SynchronizeCache10 and SynchronizeCache16     Process SAT_FLUSH_CACHE_EXT     Process SAT_FLUSH_CACHE   */
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
comment|/* SPC: Self-Test Result Log page */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_FLUSH_CACHE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: SAT_FLUSH_CACHE failed!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking IMMED bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FLUSH_CACHE_IMMED_MASK
condition|)
block|{
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
break|break;
case|case
name|SAT_FLUSH_CACHE_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: SAT_FLUSH_CACHE_EXT failed!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking IMMED bit */
if|if
condition|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FLUSH_CACHE_IMMED_MASK
condition|)
block|{
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|smsatSetDeferredSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: error unknown command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
break|break;
block|}
return|return;
block|}
comment|/* end of error checking */
block|}
comment|/* prcessing the success case */
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_FLUSH_CACHE
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: SAT_FLUSH_CACHE success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking IMMED bit */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FLUSH_CACHE_IMMED_MASK
operator|)
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_FLUSH_CACHE_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: SAT_FLUSH_CACHE_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* checking IMMED bit */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_FLUSH_CACHE_IMMED_MASK
operator|)
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
default|default:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSynchronizeCache10n16CB: error unknown command 0x%x\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
break|break;
block|}
return|return;
block|}
end_function

begin_comment
comment|//qqqqqqqq
end_comment

begin_function
name|osGLOBAL
name|void
name|smsatNonChainedWriteNVerifyCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of WriteAndVerify10     Process SAT_WRITE_DMA_FUA_EXT     Process SAT_WRITE_DMA_EXT     Process SAT_WRITE_SECTORS_EXT     Process SAT_WRITE_FPDMA_QUEUED     Process SAT_READ_VERIFY_SECTORS     Process SAT_READ_VERIFY_SECTORS_EXT     chained command   */
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
comment|/* smScsiXchg */
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|agsaFisSetDevBitsHeader_t
modifier|*
name|statSetDevBitFisHeader
init|=
name|agNULL
decl_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
comment|/* SPC: Self-Test Result Log page */
name|smScsiRequest
operator|=
name|satIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: start agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/*       FIS type should be either REG_DEV_TO_HOST_FIS or SET_DEV_BITS_FIS     */
comment|/* First, assumed to be Reg Device to Host FIS */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|==
name|SET_DEV_BITS_FIS
condition|)
block|{
name|statSetDevBitFisHeader
operator|=
operator|(
name|agsaFisSetDevBitsHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
comment|/* Get ATA Status register */
name|ataStatus
operator|=
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x70
operator|)
expr_stmt|;
comment|/* bits 4,5,6 */
name|ataStatus
operator|=
name|ataStatus
operator||
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x07
operator|)
expr_stmt|;
comment|/* bits 0,1,2 */
block|}
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/*     checking IO status, FIS type and error status     FIS type should be either REG_DEV_TO_HOST_FIS or SET_DEV_BITS_FIS     Both have fisType in the same location   */
if|if
condition|(
operator|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
operator|)
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_WRITE_DMA_FUA_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_WRITE_DMA_FUA_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_WRITE_DMA_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_WRITE_SECTORS_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_WRITE_FPDMA_QUEUED!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_READ_VERIFY_SECTORS!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_READ_VERIFY_SECTORS_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end error checking */
block|}
comment|/* process success from this point on */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_WRITE_DMA_FUA_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_WRITE_DMA_FUA_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_DMA_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_WRITE_DMA_EXT success\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_WRITE_SECTORS_EXT succes\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_WRITE_FPDMA_QUEUED succes\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_READ_VERIFY_SECTORS succes\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* return stat_good */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: SAT_READ_VERIFY_SECTORS_EXT succes\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* return stat_good */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB:  error default case command 0x%x success!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
break|break;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends ATA verify command(READ_VERIFY_SECTORS or READ_VERIFY_SECTORS_EXT) */
name|status
operator|=
name|smsatNonChainedWriteNVerify_Verify
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* sending ATA command fails */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatNonChainedWriteNVerifyCB: calling satWriteAndVerify10_1 fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end send fails */
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatChainedWriteNVerifyCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     send write in loop     then, send verify in loop   */
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|dataLength
decl_stmt|;
name|bit32
name|status
init|=
name|tiError
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* agsaFisPioSetup_t or agsaFisRegDeviceToHost_t or agsaFisSetDevBits_t for read        agsaFisRegDeviceToHost_t or agsaFisSetDevBits_t for write        first, assumed to be Reg Device to Host FIS        This is OK to just find fis type     */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
comment|/* for debugging */
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|SET_DEV_BITS_FIS
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* for debugging */
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: FAILED, error status and command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* the function below handles abort case */
name|smsatDelayedProcessAbnormalCompletion
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of error */
comment|/* process the success case */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_WRITE_DMA
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_SECTORS
case|:
comment|/* fall through */
comment|//  case SAT_WRITE_DMA_FUA_EXT: /* fall through */
case|case
name|SAT_WRITE_DMA_EXT
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_SECTORS_EXT
case|:
comment|/* fall through */
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: WRITE success case\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internally genereated SAT_SMART_RETURN_STATUS */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* let's loop till TL */
comment|/* lba = lba + tl        loopnum--;        if (loopnum == 0) done      */
operator|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|)
operator|--
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
else|else
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dataLength
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|0
condition|)
block|{
comment|/*         done with write         start with verify       */
name|satOrgIOContext
operator|->
name|LoopNum
operator|=
name|satOrgIOContext
operator|->
name|LoopNum2
expr_stmt|;
name|status
operator|=
name|smsatChainedWriteNVerify_Start_Verify
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|smsatChainedWriteNVerify_Write
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: calling satChainedWriteNVerify_Write fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_READ_VERIFY_SECTORS
case|:
comment|/* fall through */
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* done with internally genereated SAT_SMART_RETURN_STATUS */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* let's loop till TL */
comment|/* lba = lba + tl        loopnum--;        if (loopnum == 0) done      */
operator|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|)
operator|--
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|LoopNum
operator|==
literal|0
condition|)
block|{
comment|/*         done with write and verify       */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|satOrgIOContext
operator|->
name|superIOFlag
condition|)
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiSuperScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
else|else
block|{
name|dataLength
operator|=
operator|(
operator|(
name|tiScsiInitiatorRequest_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
operator|->
name|scsiCmnd
operator|.
name|expDataLength
expr_stmt|;
block|}
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|dataLength
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatChainedWriteNVerify_Verify
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: calling satChainedWriteNVerify_Verify fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatChainedWriteNVerifyCB: success but default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatReadMediaSerialNumberCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//  satDeviceData_t           *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smOrgScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|bit8
modifier|*
name|pMediaSerialNumber
decl_stmt|;
name|bit8
name|MediaSerialNumber
index|[
name|ZERO_MEDIA_SERIAL_NUMBER_LENGTH
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit32
name|allocationLen
init|=
literal|0
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumberCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumberCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumberCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
name|pMediaSerialNumber
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smOrgScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
comment|/* ATA command response payload */
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumberCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumberCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumberCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
name|pMediaSerialNumber
operator|=
operator|(
name|bit8
operator|*
operator|)
name|smOrgScsiRequest
operator|->
name|sglVirtualAddr
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumberCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* process success case */
name|allocationLen
operator|=
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|<<
operator|(
literal|8
operator|*
literal|3
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|<<
operator|(
literal|8
operator|*
literal|2
operator|)
operator|)
operator|+
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumberCB: allocationLen in CDB %d 0x%x\n"
operator|,
name|allocationLen
operator|,
name|allocationLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_SECTORS_EXT
condition|)
block|{
name|MediaSerialNumber
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|3
index|]
operator|=
literal|4
expr_stmt|;
name|MediaSerialNumber
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|MediaSerialNumber
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|sm_memcpy
argument_list|(
name|pMediaSerialNumber
argument_list|,
name|MediaSerialNumber
argument_list|,
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|ZERO_MEDIA_SERIAL_NUMBER_LENGTH
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZERO_MEDIA_SERIAL_NUMBER_LENGTH
operator|<
name|allocationLen
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumberCB: 1st underrun allocationLen %d len %d !!!\n"
operator|,
name|allocationLen
operator|,
name|ZERO_MEDIA_SERIAL_NUMBER_LENGTH
operator|)
argument_list|)
expr_stmt|;
comment|/* underrun */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* == satIntIo->satOrgSmIORequest */
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|ZERO_MEDIA_SERIAL_NUMBER_LENGTH
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadMediaSerialNumberCB: error unknown command success 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatReadBufferCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatReadBufferCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadBufferCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadBufferCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadBufferCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadBufferCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReadBufferCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadBufferCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* process success case */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_BUFFER
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadBufferCB: error unknown command success 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatWriteBufferCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatWriteBufferCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatWriteBufferCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatWriteBufferCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
comment|/* SCSI command response payload to OS layer */
comment|//    pMediaSerialNumber        = (bit8 *) s,OrgScsiRequest->sglVirtualAddr;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatWriteBufferCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatWriteBufferCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatWriteBufferCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteBufferCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NOT_READY
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_MEDIUM_NOT_PRESENT
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* process success case */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_BUFFER
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatWriteBufferCB: error unknown command success 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatReassignBlocksCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|status
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
comment|/* smScsiXchg */
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: satOrgIOContext is NULL, Wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: satOrgIOContext is NOT NULL, Wrong\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB SAT_READ_VERIFY_SECTORS(_EXT) failed!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Verify failed; send Write with same LBA */
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|512
argument_list|,
comment|/* writing 1 sector */
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* send Write with same LBA */
name|status
operator|=
name|smsatReassignBlocks_2
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|,
name|satOrgIOContext
operator|->
name|LBA
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* sending ATA command fails */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB calling fail 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end send fails */
return|return;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB SAT_WRITE failed!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* fall through */
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB error default case unexpected command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* error checking */
block|}
comment|/* prcessing the success case */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_READ_VERIFY_SECTORS_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
comment|/* next LBA; verify */
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|ParmIndex
operator|>=
name|satOrgIOContext
operator|->
name|ParmLen
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: GOOD status\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* return stat_good */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: processing next LBA\n"
operator|)
argument_list|)
expr_stmt|;
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* send Verify with the next LBA */
name|status
operator|=
name|smsatReassignBlocks_1
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
name|smScsiRequest
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* sending ATA command fails */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB calling satModeSelect6_1 fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end send fails */
block|}
comment|/* else */
return|return;
block|}
elseif|else
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_DMA_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_SECTORS_EXT
operator|||
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_WRITE_FPDMA_QUEUED
condition|)
block|{
comment|/* next LBA; verify */
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReassignBlocksCB error unknown command success 0x%x !!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_WRITE_ERROR_AUTO_REALLOCATION_FAILED
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|FORCEINLINE
name|void
name|smsatDecrementPendingIO
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIntContext_t
modifier|*
name|smAllShared
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CCFLAG_OPTIMIZE_SAT_LOCK
name|bit32
specifier|volatile
name|satPendingNCQIO
init|=
literal|0
decl_stmt|;
name|bit32
specifier|volatile
name|satPendingNONNCQIO
init|=
literal|0
decl_stmt|;
name|bit32
specifier|volatile
name|satPendingIO
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
comment|/* CCFLAG_OPTIMIZE_SAT_LOCK */
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|satIOContext
operator|->
name|pSatDevData
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
init|=
name|satIOContext
operator|->
name|satIntIoContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
init|=
name|satIOContext
operator|->
name|satOrgIOContext
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satIOContext
operator|->
name|smRequestBody
expr_stmt|;
endif|#
directive|endif
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: start\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CCFLAG_OPTIMIZE_SAT_LOCK
if|if
condition|(
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
name|tdsmInterlockedDecrement
argument_list|(
name|smRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|satPendingNCQIO
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmInterlockedDecrement
argument_list|(
name|smRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
argument_list|)
expr_stmt|;
block|}
name|tdsmInterlockedDecrement
argument_list|(
name|smRoot
argument_list|,
operator|&
name|oneDeviceData
operator|->
name|satPendingIO
argument_list|)
expr_stmt|;
comment|/* temp */
name|tdsmInterlockedExchange
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satPendingNCQIO
argument_list|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
argument_list|)
expr_stmt|;
name|tdsmInterlockedExchange
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satPendingNONNCQIO
argument_list|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
argument_list|)
expr_stmt|;
name|tdsmInterlockedExchange
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satPendingIO
argument_list|,
name|oneDeviceData
operator|->
name|satPendingIO
argument_list|)
expr_stmt|;
if|if
condition|(
name|satPendingNCQIO
operator|==
operator|-
literal|1
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: satPendingNCQIO adjustment!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|satPendingNONNCQIO
operator|==
operator|-
literal|1
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: satPendingNONNCQIO adjustment!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|satPendingIO
operator|==
operator|-
literal|1
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: satPendingIO adjustment!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingIO
operator|=
literal|0
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_WRITE
operator|)
operator|||
operator|(
name|satIOContext
operator|->
name|reqType
operator|==
name|AGSA_SATA_PROTOCOL_FPDMA_READ
operator|)
condition|)
block|{
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|--
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingIO
operator|--
expr_stmt|;
name|SMLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|satIOContext
operator|->
name|satIoContextLink
argument_list|)
expr_stmt|;
comment|/* temp */
if|if
condition|(
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|==
operator|-
literal|1
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: satPendingNCQIO adjustment!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|satPendingIO
operator|==
operator|-
literal|1
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: satPendingIO adjustment!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingIO
operator|=
literal|0
expr_stmt|;
block|}
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmSingleThreadedEnter
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|--
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingIO
operator|--
expr_stmt|;
name|SMLIST_DEQUEUE_THIS
argument_list|(
operator|&
name|satIOContext
operator|->
name|satIoContextLink
argument_list|)
expr_stmt|;
comment|/* temp */
if|if
condition|(
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|==
operator|-
literal|1
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: satPendingNONNCQIO adjustment!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|satPendingIO
operator|==
operator|-
literal|1
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: satPendingIO adjustment!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satPendingIO
operator|=
literal|0
expr_stmt|;
block|}
name|tdsmSingleThreadedLeave
argument_list|(
name|smRoot
argument_list|,
name|SM_EXTERNAL_IO_LOCK
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CCFLAG_OPTIMIZE_SAT_LOCK */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: external command!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*smEnqueueIO(smRoot, satIOContext);*/
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: internal command!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
comment|/* No smEnqueueIO since only alloc used */
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatDecrementPendingIO: internal only command!!!, ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
comment|/* smDequeueIO used */
comment|/*smEnqueueIO(smRoot, satOrgIOContext);*/
block|}
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatProcessAbnormalCompletion
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
comment|//  tdsaRootOsData_t     *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t             *tiRoot = (tiRoot_t *)osData->tiRoot;
name|bit32
name|interruptContext
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
comment|//  satDeviceData_t      *pSatDevData;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|interruptContext
operator|=
name|satIOContext
operator|->
name|interruptContext
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Get into the detail */
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_SUCCESS
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_SUCCESS agIOInfoLen 0x%x calling smsatIOCompleted!!!\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/*      * At this point agIOInfoLen should be non-zero and there is valid FIS      * to read. Pass this info to the SAT layer in order to do the ATA status      * to SCSI status translation.      */
name|smsatIOCompleted
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORTED
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_ABORTED!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailAborted
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
if|if
condition|(
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: TM callback!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: wrong, smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMOK
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
comment|/*        * Reset flag        */
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/*      * Check if we are in recovery mode and need to update the recovery flag      */
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|satPendingIO
operator|==
literal|0
operator|)
condition|)
block|{
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: STATE NORMAL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: did %d satDriveState %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|,
name|oneDeviceData
operator|->
name|satDriveState
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: satPendingIO %d satNCQMaxIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: satPendingNCQIO %d satPendingNONNCQIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_OVERFLOW
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_OVERFLOW!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOOverRun
argument_list|,
name|agIOInfoLen
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|OSSA_IO_UNDERFLOW
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_UNDERFLOW!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|agIOInfoLen
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_FAILED
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_FAILED!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORT_RESET
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_ABORT_RESET!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailAbortReset
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
comment|/*      * Check if we are in recovery mode and need to update the recovery flag      */
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|satPendingIO
operator|==
literal|0
operator|)
condition|)
block|{
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: STATE NORMAL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: satDriveState %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satDriveState
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: satPendingIO %d satNCQMaxIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: satPendingNCQIO %d satPendingNONNCQIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_NOT_VALID
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_NOT_VALID!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailNotValid
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|OSSA_IO_NO_DEVICE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_NO_DEVICE!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
comment|/* removed from spec */
case|case
name|OSSA_IO_ILLEGAL_PARAMETER
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_ILLEGAL_PARAMETER!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_LINK_FAILURE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_LINK_FAILURE!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_PROG_ERROR
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_PROG_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_OPEN_PREEMPTED
case|:
comment|/* fall through */
ifdef|#
directive|ifdef
name|REMOVED
comment|/* removed from spec */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
case|:
comment|/* fall through */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_OPEN_CNX_ERROR_* 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: wrong, smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: wrong, oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailBusy
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFER_ERROR_BREAK
case|:
comment|/* fall throuth */
endif|#
directive|endif
case|case
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_NAK_RECEIVED
case|:
comment|/* fall throuth */
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFER_ERROR_ACK_NAK_TIMEOUT
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_PEER_ABORTED
case|:
comment|/* fall throuth */
endif|#
directive|endif
case|case
name|OSSA_IO_XFER_ERROR_DMA
case|:
comment|/* fall throuth */
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFER_ERROR_RX_FRAME
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_CREDIT_TIMEOUT
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_SATA
case|:
comment|/* fall throuth */
endif|#
directive|endif
case|case
name|OSSA_IO_XFER_ERROR_SATA_LINK_TIMEOUT
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_ABORTED_DUE_TO_SRST
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_REJECTED_NCQ_MODE
case|:
comment|/* fall throuth */
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFER_ERR_EOB_DATA_OVERRUN
case|:
case|case
name|OSSA_IO_XFER_ERROR_ABORTED_NCQ_MODE
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_DISRUPTED_PHY_DOWN
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_OFFSET_MISMATCH
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_XFER_ZERO_DATA_LEN
case|:
comment|/* fall throuth */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_XFER_ERROR_* 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFER_ERROR_CMD_ISSUE_ACK_NAK_TIMEOUT
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_CMD_ISSUE_BREAK_BEFORE_ACK_NAK
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_CMD_ISSUE_PHY_DOWN_BEFORE_ACK_NAK
case|:
comment|/* fall throuth */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_XFER_ERROR_CMD_ISSUE_* 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_PIO_SETUP_ERROR
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_XFER_PIO_SETUP_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|OSSA_IO_DS_IN_ERROR
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_DS_IN_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: wrong, smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: wrong, oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_NON_OPERATIONAL
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_IO_DS_NON_OPERATIONAL!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: wrong, smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: wrong, oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_PORT_IN_RESET
case|:
case|case
name|OSSA_IO_DS_IN_RECOVERY
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: OSSA_IO_DS_IN_RECOVERY or OSSA_IO_PORT_IN_RESET status %x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
case|:
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
case|:
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
case|:
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
case|:
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: SSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_XX status %x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_IO_RQE_BUSY_FULL
case|:
case|case
name|OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE
case|:
case|case
name|OSSA_MPI_ERR_ATAPI_DEVICE_BUSY
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = OSSA_MPI_%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailBusy
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
case|:
comment|/* fall through */
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
case|:
endif|#
directive|endif
case|case
name|OSSA_IO_XFR_ERROR_CIPHER_MODE_INVALID
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DEK_IV_MISMATCH
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DEK_RAM_INTERFACE_ERROR
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DEK_INDEX_OUT_OF_BOUNDS
case|:
case|case
name|OSSA_IO_XFR_ERROR_DEK_ILLEGAL_TABLE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = ENCRYPTION ERROR 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatEncryptionHandler
argument_list|(
name|smRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = DIF ERROR 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatDifHandler
argument_list|(
name|smRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: agIOStatus = unknown 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|!=
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbnormalCompletion: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* switch */
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatDelayedProcessAbnormalCompletion
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
comment|//  tdsaRootOsData_t     *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t             *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  bit32                interruptContext = osData->IntContext;
name|bit32
name|interruptContext
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
comment|//  satDeviceData_t      *pSatDevData;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: oneDeviceData is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|interruptContext
operator|=
name|satIOContext
operator|->
name|interruptContext
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Get into the detail */
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_SUCCESS
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_SUCCESS calling smsatIOCompleted!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* do nothing */
break|break;
case|case
name|OSSA_IO_ABORTED
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_ABORTED!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailAborted
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: TM callback!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: wrong, smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMOK
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
comment|/*          * Reset flag          */
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
block|}
block|}
comment|/*      * Check if we are in recovery mode and need to update the recovery flag      */
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|satPendingIO
operator|==
literal|0
operator|)
condition|)
block|{
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: STATE NORMAL.!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: satDriveState %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satDriveState
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: satPendingIO %d satNCQMaxIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: satPendingNCQIO %d satPendingNONNCQIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_OVERFLOW
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_OVERFLOW!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOOverRun
argument_list|,
name|agIOInfoLen
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|OSSA_IO_UNDERFLOW
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_UNDERFLOW!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|agIOInfoLen
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_FAILED
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_FAILED!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_ABORT_RESET
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_ABORT_RESET!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailAbortReset
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
comment|/*      * Check if we are in recovery mode and need to update the recovery flag      */
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|satPendingIO
operator|==
literal|0
operator|)
condition|)
block|{
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: STATE NORMAL.!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: satDriveState %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satDriveState
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: satPendingIO %d satNCQMaxIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: satPendingNCQIO %d satPendingNONNCQIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_NOT_VALID
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_NOT_VALID!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailNotValid
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|OSSA_IO_NO_DEVICE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_NO_DEVICE!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
comment|/* removed from spec */
case|case
name|OSSA_IO_ILLEGAL_PARAMETER
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_ILLEGAL_PARAMETER!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_LINK_FAILURE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_LINK_FAILURE!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_PROG_ERROR
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_PROG_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
case|:
comment|/* fall through */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_OPEN_PREEMPTED
case|:
comment|/* fall through */
ifdef|#
directive|ifdef
name|REMOVED
comment|/* removed from spec */
case|case
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
case|:
comment|/* fall through */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_OPEN_CNX_ERROR_* 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: wrong, smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: wrong, oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailBusy
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFER_ERROR_BREAK
case|:
comment|/* fall throuth */
endif|#
directive|endif
case|case
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_NAK_RECEIVED
case|:
comment|/* fall throuth */
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFER_ERROR_ACK_NAK_TIMEOUT
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_PEER_ABORTED
case|:
comment|/* fall throuth */
endif|#
directive|endif
case|case
name|OSSA_IO_XFER_ERROR_DMA
case|:
comment|/* fall throuth */
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFER_ERROR_RX_FRAME
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_CREDIT_TIMEOUT
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_SATA
case|:
comment|/* fall throuth */
endif|#
directive|endif
case|case
name|OSSA_IO_XFER_ERROR_SATA_LINK_TIMEOUT
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_ABORTED_DUE_TO_SRST
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_REJECTED_NCQ_MODE
case|:
comment|/* fall throuth */
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFER_ERROR_ABORTED_NCQ_MODE
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_DISRUPTED_PHY_DOWN
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_OFFSET_MISMATCH
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_XFER_ZERO_DATA_LEN
case|:
comment|/* fall throuth */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_XFER_ERROR_* 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFER_ERROR_CMD_ISSUE_ACK_NAK_TIMEOUT
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_CMD_ISSUE_BREAK_BEFORE_ACK_NAK
case|:
comment|/* fall throuth */
case|case
name|OSSA_IO_XFER_ERROR_CMD_ISSUE_PHY_DOWN_BEFORE_ACK_NAK
case|:
comment|/* fall throuth */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_XFER_ERROR_CMD_ISSUE_* 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFER_PIO_SETUP_ERROR
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_XFER_PIO_SETUP_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: wrong, smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: wrong, oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|OSSA_IO_DS_IN_ERROR
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_DS_IN_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: wrong, smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: wrong, oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_NON_OPERATIONAL
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_IO_DS_NON_OPERATIONAL!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: wrong, smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: wrong, oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_PORT_IN_RESET
case|:
case|case
name|OSSA_IO_DS_IN_RECOVERY
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: OSSA_IO_DS_IN_RECOVERY or OSSA_IO_PORT_IN_RESET status %x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
case|:
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
case|:
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
case|:
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
case|:
case|case
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: SSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_XX status %x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_DS_INVALID
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: OSSA_IO_DS_INVALID status %x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_MPI_IO_RQE_BUSY_FULL
case|:
case|case
name|OSSA_MPI_ERR_IO_RESOURCE_UNAVAILABLE
case|:
case|case
name|OSSA_MPI_ERR_ATAPI_DEVICE_BUSY
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = OSSA_MPI_%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailBusy
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
case|:
comment|/* fall through */
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
case|:
endif|#
directive|endif
case|case
name|OSSA_IO_XFR_ERROR_CIPHER_MODE_INVALID
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DEK_IV_MISMATCH
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DEK_RAM_INTERFACE_ERROR
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DEK_INDEX_OUT_OF_BOUNDS
case|:
case|case
name|OSSA_IO_XFR_ERROR_DEK_ILLEGAL_TABLE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = ENCRYPTION ERROR 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatEncryptionHandler
argument_list|(
name|smRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|REMOVED
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
comment|/* fall through */
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = DIF ERROR 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatDifHandler
argument_list|(
name|smRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDelayedProcessAbnormalCompletion: agIOStatus = unknown!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* switch */
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatIDStartCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of SAT_IDENTIFY_DEVICE during discovery   */
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
init|=
name|agNULL
decl_stmt|;
comment|//  agsaFisRegD2HData_t       *deviceToHostFisData = agNULL;
comment|//  bit8                      signature[8];
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
endif|#
directive|endif
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit16
modifier|*
name|tmpptr
decl_stmt|,
name|tmpptr_tmp
decl_stmt|;
name|bit32
name|x
decl_stmt|;
name|void
modifier|*
name|sglVirtualAddr
decl_stmt|;
name|bit32
name|status
init|=
literal|0
decl_stmt|;
comment|//  tdsaPortContext_t         *onePortContext = agNULL;
comment|//  tiPortalContext_t         *tiPortalContext = agNULL;
comment|//  bit32                     retry_status;
name|smIORequest_t
modifier|*
name|smIORequest
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|//  onePortContext = oneDeviceData->tdPortContext;
comment|//  tiPortalContext= onePortContext->tiPortalContext;
name|oneDeviceData
operator|->
name|IDDeviceValid
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: External, OS generated!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: Not possible case!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatIDStartCB: Internal, SM generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIDStartCB: satOrgIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIDStartCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
if|if
condition|(
name|smOrgIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: smOrgIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|sglVirtualAddr
operator|=
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|sglVirtualAddr
expr_stmt|;
block|}
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smIORequest
operator|=
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: OPEN_RETRY_TIMEOUT or STP_RESOURCES_BUSY or OPEN_RETRY_BACKOFF_THRESHOLD_REACHED or OSSA_IO_DS_NON_OPERATIONAL!!! 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStartCB: smOrgIORequestBody %p smIORequest %p\n"
operator|,
name|smOrgIORequestBody
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStartCB: smOrgIORequestBody->id %d\n"
operator|,
name|smOrgIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_XFER_OPEN_RETRY_TIMEOUT
condition|)
block|{
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIORetry
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
comment|/* set device to operational */
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agTRUE
condition|)
block|{
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIORetry
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSTPResourceBusy
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: before pending IO %d NCQ pending IO %d NONNCQ pending IO %d\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: after pending IO %d NCQ pending IO %d NONNCQ pending IO %d\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStartCB: smOrgIORequestBody %p smIORequest %p\n"
operator|,
name|smOrgIORequestBody
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStartCB: smOrgIORequestBody->id %d\n"
operator|,
name|smOrgIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOFailed
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_UNDERFLOW
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_PHY_NOT_READY
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_NAK_RECEIVED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_DMA
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_SATA_LINK_TIMEOUT
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_XFER_ERROR_REJECTED_NCQ_MODE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_NO_DEVICE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_PORT_IN_RESET
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_INVALID
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: OSSA_IO_OPEN_CNX_ERROR 0x%x!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStartCB: smOrgIORequestBody %p smIORequest %p\n"
operator|,
name|smOrgIORequestBody
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStartCB: smOrgIORequestBody->id %d\n"
operator|,
name|smOrgIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOFailed
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
operator|||
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agFirstDword
operator|!=
name|agNULL
operator|&&
name|agIOInfoLen
operator|!=
literal|0
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
comment|/* only agsaFisPioSetup_t is expected */
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: ataStatus 0x%x ataError 0x%x!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStartCB: smOrgIORequestBody %p smIORequest %p\n"
operator|,
name|smOrgIORequestBody
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStartCB: smOrgIORequestBody->id %d\n"
operator|,
name|smOrgIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
block|{
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOFailed
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
comment|/* success */
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatIDStartCB: Success\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatIDStartCB: Success did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* Convert to host endian */
name|tmpptr
operator|=
operator|(
name|bit16
operator|*
operator|)
name|sglVirtualAddr
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bit16
argument_list|)
condition|;
name|x
operator|++
control|)
block|{
name|OSSA_READ_LE_16
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tmpptr_tmp
argument_list|,
name|tmpptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|tmpptr
operator|=
name|tmpptr_tmp
expr_stmt|;
name|tmpptr
operator|++
expr_stmt|;
block|}
name|pSATAIdData
operator|=
operator|(
name|agsaSATAIdentifyData_t
operator|*
operator|)
name|sglVirtualAddr
expr_stmt|;
comment|//smhexdump("satAddSATAIDDevCB before", (bit8 *)pSATAIdData, sizeof(agsaSATAIdentifyData_t));
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIDStartCB: OS satOrgIOContext %p \n"
operator|,
name|satOrgIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIDStartCB: TD satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIDStartCB: OS tiScsiXchg %p \n"
operator|,
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIDStartCB: TD tiScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
comment|/* copy ID Dev data to oneDeviceData */
name|oneDeviceData
operator|->
name|satIdentifyData
operator|=
operator|*
name|pSATAIdData
expr_stmt|;
name|oneDeviceData
operator|->
name|IDDeviceValid
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|SM_INTERNAL_DEBUG
name|smhexdump
argument_list|(
literal|"smsatIDStartCB ID Dev data"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pSATAIdData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|smhexdump
argument_list|(
literal|"smsatIDStartCB Device ID Dev data"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|oneDeviceData
operator|->
name|satIdentifyData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* set oneDeviceData fields from IndentifyData */
name|smsatSetDevInfo
argument_list|(
name|oneDeviceData
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIORequest
operator|->
name|tdData
operator|==
name|smIORequest
operator|->
name|smData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: the same tdData and smData error!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* send the Set Feature ATA command to SATA device for enbling PIO and DMA transfer mode*/
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDStartCB: momory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOFailed
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/*enable PIO mode*/
name|status
operator|=
name|smsatSetFeaturesPIO
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOFailed
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatIDStartCB: End device id %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatIOCompleted
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|respFisLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
comment|//  satDeviceData_t           *pSatDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|smIniScsiCmnd_t
modifier|*
name|pScsiCmnd
decl_stmt|;
endif|#
directive|endif
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
decl_stmt|;
comment|//  agsaRoot_t                *agRoot;
comment|//  agsaDevHandle_t           *agDevHandle;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext2
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|agsaFisSetDevBitsHeader_t
modifier|*
name|statSetDevBitFisHeader
init|=
name|agNULL
decl_stmt|;
name|smIORequest_t
name|smIORequestTMP
decl_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|pScsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
endif|#
directive|endif
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
comment|//  agRoot          = ((tdsaDeviceData_t *)(pSatDevData->satSaDeviceData))->agRoot;
comment|//  agDevHandle     = ((tdsaDeviceData_t *)(pSatDevData->satSaDeviceData))->agDevHandle;
comment|//  tiDeviceHandle  =&((tdsaDeviceData_t *)(pSatDevData->satSaDeviceData))->tiDeviceHandle;
name|smDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
comment|/*    * Find out the type of response FIS:    * Set Device Bit FIS or Reg Device To Host FIS.    */
comment|/* First assume it is Reg Device to Host FIS */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|statDevToHostFisHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* for debugging */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOCompleted: H to D command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOCompleted: D to H fistype 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|==
name|SET_DEV_BITS_FIS
condition|)
block|{
comment|/* It is Set Device Bits FIS */
name|statSetDevBitFisHeader
operator|=
operator|(
name|agsaFisSetDevBitsHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
comment|/* Get ATA Status register */
name|ataStatus
operator|=
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x70
operator|)
expr_stmt|;
comment|/* bits 4,5,6 */
name|ataStatus
operator|=
name|ataStatus
operator||
operator|(
name|statSetDevBitFisHeader
operator|->
name|statusHi_Lo
operator|&
literal|0x07
operator|)
expr_stmt|;
comment|/* bits 0,1,2 */
comment|/* ATA Eror register   */
name|ataError
operator|=
name|statSetDevBitFisHeader
operator|->
name|error
expr_stmt|;
name|statDevToHostFisHeader
operator|=
name|agNULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOCompleted: *** UNEXPECTED RESP FIS TYPE 0x%x *** smIORequest=%p!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_HARDWARE_ERROR
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INTERNAL_TARGET_FAILURE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
condition|)
block|{
name|oneDeviceData
operator|->
name|satDeviceFaultState
operator|=
name|agTRUE
expr_stmt|;
block|}
else|else
block|{
name|oneDeviceData
operator|->
name|satDeviceFaultState
operator|=
name|agFALSE
expr_stmt|;
block|}
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatIOCompleted: smIORequest=%p  CDB=0x%x ATA CMD =0x%x\n"
operator|,
name|smIORequest
operator|,
name|pScsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
comment|/*    * Decide which ATA command is the translation needed    */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_FPDMA_QUEUED
case|:
case|case
name|SAT_WRITE_FPDMA_QUEUED
case|:
comment|/************************************************************************        *        * !!!! See Section 13.5.2.4 of SATA 2.5 specs.                      !!!!        * !!!! If the NCQ error ends up here, it means that the device sent !!!!        * !!!! Set Device Bit FIS (which has SActive register) instead of   !!!!        * !!!! Register Device To Host FIS (which does not have SActive     !!!!        * !!!! register). The callback ossaSATAEvent() deals with the case  !!!!        * !!!! where Register Device To Host FIS was sent by the device.    !!!!        *        * For NCQ we need to issue READ LOG EXT command with log page 10h        * to get the error and to allow other I/Os to continue.        *        * Here is the basic flow or sequence of error recovery, note that due        * to the SATA HW assist that we have, this sequence is slighly different        * from the one described in SATA 2.5:        *        * 1. Set SATA device flag to indicate error condition and returning busy        *    for all new request.        *   return SM_RC_SUCCESS;         * 2. Because the HW/LL layer received Set Device Bit FIS, it can get the        *    tag or I/O context for NCQ request, SATL would translate the ATA error        *    to SCSI status and return the original NCQ I/O with the appopriate        *    SCSI status.        *        * 3. Prepare READ LOG EXT page 10h command. Set flag to indicate that        *    the failed I/O has been returned to the OS Layer. Send command.        *        * 4. When the device receives READ LOG EXT page 10h request all other        *    pending I/O are implicitly aborted. No completion (aborted) status        *    will be sent to the host for these aborted commands.        *        * 5. SATL receives the completion for READ LOG EXT command in        *    smsatReadLogExtCB(). Steps 6,7,8,9 below are the step 1,2,3,4 in        *    smsatReadLogExtCB().        *        * 6. Check flag that indicates whether the failed I/O has been returned        *    to the OS Layer. If not, search the I/O context in device data        *    looking for a matched tag. Then return the completion of the failed        *    NCQ command with the appopriate/trasnlated SCSI status.        *        * 7. Issue abort to LL layer to all other pending I/Os for the same SATA        *    drive.        *        * 8. Free resource allocated for the internally generated READ LOG EXT.        *        * 9. At the completion of abort, in the context of ossaSATACompleted(),        *    return the I/O with error status to the OS-App Specific layer.        *    When all I/O aborts are completed, clear SATA device flag to        *    indicate ready to process new request.        *        ***********************************************************************/
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOCompleted: NCQ ERROR smIORequest=%p ataStatus=0x%x ataError=0x%x!!!\n"
operator|,
name|smIORequest
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
comment|/* Set flag to indicate we are in recovery */
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
comment|/* Return the failed NCQ I/O to OS-Apps Specifiic layer */
name|smsatDefaultTranslation
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|satIOContext
argument_list|,
name|pSense
argument_list|,
operator|(
name|bit8
operator|)
name|ataStatus
argument_list|,
operator|(
name|bit8
operator|)
name|ataError
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
comment|/*        * Allocate resource for READ LOG EXT page 10h        */
name|satIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
operator|&
operator|(
name|smIORequestTMP
operator|)
argument_list|,
comment|/* anything but NULL */
name|oneDeviceData
argument_list|,
sizeof|sizeof
argument_list|(
name|satReadLogExtPage10h_t
argument_list|)
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*        * If we cannot allocate resource for READ LOG EXT 10 in order to do        * the normal NCQ recovery, we will do SATA device reset.        */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOCompleted: can't send RLE due to resource lack!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Abort I/O after completion of device reset */
name|oneDeviceData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* needs further investigation */
comment|/* no report to OS layer */
name|satSubTM
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|SM_INTERNAL_TM_RESET
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOCompleted: calling saSATADeviceReset 1!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*        * Set flag to indicate that the failed I/O has been returned to the        * OS-App specific Layer.        */
name|satIntIo
operator|->
name|satIntFlag
operator|=
name|AG_SAT_INT_IO_FLAG_ORG_IO_COMPLETED
expr_stmt|;
comment|/* compare to satPrepareNewIO() */
comment|/* Send READ LOG EXIT page 10h command */
comment|/*        * Need to initialize all the fields within satIOContext except        * reqType and satCompleteCB which will be set depending on cmd.        */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSatDevData
operator|=
name|oneDeviceData
expr_stmt|;
name|satIOContext2
operator|->
name|pFis
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSense
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSmSenseData
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSmSenseData
operator|->
name|senseData
operator|=
name|satIOContext2
operator|->
name|pSense
expr_stmt|;
name|satIOContext2
operator|->
name|smRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|->
name|interruptContext
operator|=
name|interruptContext
expr_stmt|;
name|satIOContext2
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satIOContext2
operator|->
name|psmDeviceHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext2
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext2
operator|->
name|smScsiXchg
operator|=
name|agNULL
expr_stmt|;
name|status
operator|=
name|smsatSendReadLogExt
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOCompleted: can't send RLE due to LL api failure!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* Abort I/O after completion of device reset */
name|oneDeviceData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* needs further investigation */
comment|/* no report to OS layer */
name|satSubTM
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|SM_INTERNAL_TM_RESET
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIOCompleted: calling saSATADeviceReset 2!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|SAT_READ_DMA_EXT
case|:
comment|/* fall through */
comment|/* Use default status/error translation */
case|case
name|SAT_READ_DMA
case|:
comment|/* fall through */
comment|/* Use default status/error translation */
default|default:
name|smsatDefaultTranslation
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|satIOContext
argument_list|,
name|pSense
argument_list|,
operator|(
name|bit8
operator|)
name|ataStatus
argument_list|,
operator|(
name|bit8
operator|)
name|ataError
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* end switch  */
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatEncryptionHandler
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|bit32
name|errorDetail
init|=
name|smDetailOtherError
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatEncryptionHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatEncryptionHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_KEY_CACHE_MISS\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailDekKeyCacheMiss
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_CIPHER_MODE_INVALID
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatEncryptionHandler: OSSA_IO_XFR_ERROR_CIPHER_MODE_INVALID\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailCipherModeInvalid
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_IV_MISMATCH
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_IV_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailDekIVMismatch
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_RAM_INTERFACE_ERROR
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_RAM_INTERFACE_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailDekRamInterfaceError
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_INDEX_OUT_OF_BOUNDS
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatEncryptionHandler: OSSA_IO_XFR_ERROR_DEK_INDEX_OUT_OF_BOUNDS\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailDekIndexOutofBounds
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DEK_ILLEGAL_TABLE
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatEncryptionHandler:OSSA_IO_XFR_ERROR_DEK_ILLEGAL_TABLE\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailOtherError
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatEncryptionHandler: other error!!! 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailOtherError
expr_stmt|;
break|break;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOEncryptError
argument_list|,
name|errorDetail
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatDifHandler
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|bit32
name|agOtherInfo
parameter_list|,
name|bit32
name|interruptContext
parameter_list|)
block|{
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|bit32
name|errorDetail
init|=
name|smDetailOtherError
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaDifDetails_t
modifier|*
name|DifDetail
decl_stmt|;
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDifHandler: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDifHandler: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|DifDetail
operator|=
operator|(
name|agsaDifDetails_t
operator|*
operator|)
name|agParam
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|agIOStatus
condition|)
block|{
case|case
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDifHandler: OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailDifAppTagMismatch
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDifHandler: OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailDifRefTagMismatch
expr_stmt|;
break|break;
case|case
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDifHandler: OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailDifCrcMismatch
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDifHandler: other error!!! 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|errorDetail
operator|=
name|smDetailOtherError
expr_stmt|;
break|break;
block|}
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDifHandler: DIF detail UpperLBA 0x%08x LowerLBA 0x%08x\n"
operator|,
name|DifDetail
operator|->
name|UpperLBA
operator|,
name|DifDetail
operator|->
name|LowerLBA
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIODifError
argument_list|,
name|errorDetail
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatProcessAbort
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
endif|#
directive|endif
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatProcessAbort: start\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|smDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
endif|#
directive|endif
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
if|if
condition|(
operator|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
operator|&&
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_EXEUTE_OFF_LINE_IMMEDIATE
operator|)
operator|&&
operator|(
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x01
operator|&&
name|hostToDevFis
operator|->
name|d
operator|.
name|lbaLow
operator|!=
literal|0x02
operator|)
condition|)
block|{
comment|/* no completion for send diagnotic in background. It is done in satSendDiagnostic() */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailAborted
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbort: TM callback!!!\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMOK
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*      * Reset flag      */
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
block|}
comment|/*    * Check if we are in recovery mode and need to update the recovery flag    */
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_IN_RECOVERY
operator|)
operator|&&
operator|(
name|oneDeviceData
operator|->
name|satPendingIO
operator|==
literal|0
operator|)
condition|)
block|{
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbort: STATE NORMAL.!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbort: satDriveState %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satDriveState
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbort: satPendingIO %d satNCQMaxIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatProcessAbort: satPendingNCQIO %d satPendingNONNCQIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatNonDataIOCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|bit32
name|interruptContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatNonDataIOCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"satNonDataIOCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
name|interruptContext
operator|=
name|satIOContext
operator|->
name|interruptContext
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/* Process completion */
if|if
condition|(
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|)
operator|&&
operator|(
name|agIOInfoLen
operator|==
literal|0
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"satNonDataIOCB: *** ERROR***  agIORequest=%p agIOStatus=0x%x agIOInfoLen %d!!!\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|smIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* More checking needed, for non-data IO this should be the normal case */
name|smsatProcessAbnormalCompletion
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agFirstDword
argument_list|,
name|agIOInfoLen
argument_list|,
name|agParam
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatInquiryCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/*     In the process of Inquiry     Process SAT_IDENTIFY_DEVICE   */
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
endif|#
directive|endif
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
comment|/* TD's smScsiXchg */
name|smScsiInitiatorRequest_t
modifier|*
name|smOrgScsiRequest
decl_stmt|;
comment|/* OS's smScsiXchg */
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit8
modifier|*
name|pInquiry
decl_stmt|;
name|bit8
name|page
init|=
literal|0xFF
decl_stmt|;
name|bit16
modifier|*
name|tmpptr
decl_stmt|,
name|tmpptr_tmp
decl_stmt|;
name|bit32
name|x
decl_stmt|;
name|bit32
name|lenReceived
init|=
literal|0
decl_stmt|;
name|bit32
name|allocationLen
init|=
literal|0
decl_stmt|;
name|bit32
name|lenNeeded
init|=
literal|0
decl_stmt|;
name|bit8
name|dataBuffer
index|[
name|SATA_PAGE89_INQUIRY_SIZE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smScsiRequest
operator|=
name|satIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryCB: satOrgIOContext is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|pInquiry
operator|=
name|dataBuffer
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatInquiryCB: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryCB: agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryCB: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* should NOT be retried */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryCB: NOT OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryCB: OSSA_IO_OPEN_CNX_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailNoLogin
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
operator|||
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agFirstDword
operator|!=
name|agNULL
operator|&&
name|agIOInfoLen
operator|!=
literal|0
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
comment|/* only agsaFisPioSetup_t is expected */
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryCB: ataStatus 0x%x ataError 0x%x!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
comment|/* Convert to host endian */
name|tmpptr
operator|=
operator|(
name|bit16
operator|*
operator|)
operator|(
name|smScsiRequest
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bit16
argument_list|)
condition|;
name|x
operator|++
control|)
block|{
name|OSSA_READ_LE_16
argument_list|(
name|AGROOT
argument_list|,
operator|&
name|tmpptr_tmp
argument_list|,
name|tmpptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|tmpptr
operator|=
name|tmpptr_tmp
expr_stmt|;
name|tmpptr
operator|++
expr_stmt|;
comment|/*Print tmpptr_tmp here for debugging purpose*/
block|}
name|pSATAIdData
operator|=
operator|(
name|agsaSATAIdentifyData_t
operator|*
operator|)
operator|(
name|smScsiRequest
operator|->
name|sglVirtualAddr
operator|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryCB: OS satOrgIOContext %p \n"
operator|,
name|satOrgIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryCB: TD satIOContext %p \n"
operator|,
name|satIOContext
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryCB: OS smScsiXchg %p \n"
operator|,
name|satOrgIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryCB: TD smScsiXchg %p \n"
operator|,
name|satIOContext
operator|->
name|smScsiXchg
operator|)
argument_list|)
expr_stmt|;
comment|/* copy ID Dev data to oneDeviceData */
name|oneDeviceData
operator|->
name|satIdentifyData
operator|=
operator|*
name|pSATAIdData
expr_stmt|;
name|oneDeviceData
operator|->
name|IDDeviceValid
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|SM_INTERNAL_DEBUG
name|smhexdump
argument_list|(
literal|"smsatInquiryCB ID Dev data"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
name|pSATAIdData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
name|smhexdump
argument_list|(
literal|"smsatInquiryCB Device ID Dev data"
argument_list|,
operator|(
name|bit8
operator|*
operator|)
operator|&
name|oneDeviceData
operator|->
name|satIdentifyData
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaSATAIdentifyData_t
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|// smhexdump("smsatInquiryCB Device ID Dev data",(bit8 *)&oneDeviceData->satIdentifyData, sizeof(agsaSATAIdentifyData_t));
comment|/* set oneDeviceData fields from IndentifyData */
name|smsatSetDevInfo
argument_list|(
name|oneDeviceData
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
name|allocationLen
operator|=
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|)
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
comment|/* SPC-4, spec 6.4 p 141 */
comment|/* EVPD bit == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_EVPD_MASK
operator|)
condition|)
block|{
comment|/* Returns the standard INQUIRY data */
name|lenNeeded
operator|=
name|STANDARD_INQUIRY_SIZE
expr_stmt|;
name|smsatInquiryStandard
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|scsiCmnd
argument_list|)
expr_stmt|;
comment|//smhexdump("smsatInquiryCB ***standard***", (bit8 *)pInquiry, 36);
block|}
else|else
block|{
comment|/* EVPD bit != 0&& PAGE CODE != 0 */
comment|/* returns the pages of vital product data information */
comment|/* we must support page 00h, 83h and 89h */
name|page
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|page
operator|!=
name|INQUIRY_SUPPORTED_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_BLOCK_DEVICE_CHARACTERISTICS_VPD_PAGE
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryCB: invalid PAGE CODE 0x%x!!!\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* checking length */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|INQUIRY_SUPPORTED_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGE0_INQUIRY_SIZE
expr_stmt|;
comment|/* 9 */
break|break;
case|case
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
case|:
if|if
condition|(
name|oneDeviceData
operator|->
name|satWWNSupport
condition|)
block|{
name|lenNeeded
operator|=
name|SATA_PAGE83_INQUIRY_WWN_SIZE
expr_stmt|;
comment|/* 16 */
block|}
else|else
block|{
name|lenNeeded
operator|=
name|SATA_PAGE83_INQUIRY_NO_WWN_SIZE
expr_stmt|;
comment|/* 76 */
block|}
break|break;
case|case
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGE89_INQUIRY_SIZE
expr_stmt|;
comment|/* 572 */
break|break;
case|case
name|INQUIRY_BLOCK_DEVICE_CHARACTERISTICS_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGEB1_INQUIRY_SIZE
expr_stmt|;
comment|/* 64 */
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryCB: wrong!!! invalid PAGE CODE 0x%x!!!\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*      * Fill in the Inquiry data depending on what Inquiry data we are returning.      */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|INQUIRY_SUPPORTED_VPD_PAGE
case|:
name|smsatInquiryPage0
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
case|:
name|smsatInquiryPage83
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
case|:
name|smsatInquiryPage89
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|oneDeviceData
argument_list|,
name|lenReceived
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_BLOCK_DEVICE_CHARACTERISTICS_VPD_PAGE
case|:
name|smsatInquiryPageB1
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryCB: wrong!!! invalidinvalid PAGE CODE 0x%x!!!\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* else */
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryCB: calling tdsmIOCompletedCB\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* if this is a standard Inquiry command, notify Stoport to set the device queue depth to max NCQ */
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|satNCQ
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
literal|0x01
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|tdsmSetDeviceQueueDepth
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|-
literal|1
argument_list|)
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryCB: failed to call tdsmSetDeviceQueueDepth()!!! Q=%d\n"
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|sm_memcpy
argument_list|(
name|smOrgScsiRequest
operator|->
name|sglVirtualAddr
argument_list|,
name|dataBuffer
argument_list|,
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|lenNeeded
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|allocationLen
operator|>
name|lenNeeded
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryCB reporting underrun lenNeeded=0x%x allocationLen=0x%x smIORequest=%p\n"
operator|,
name|lenNeeded
operator|,
name|allocationLen
operator|,
name|smOrgIORequest
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|lenNeeded
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryCB: device %p pending IO %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatInquiryIntCB
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|smIORequest_t
modifier|*
name|smIORequest
parameter_list|,
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
parameter_list|,
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
parameter_list|,
name|smSatIOContext_t
modifier|*
name|satIOContext
parameter_list|)
block|{
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
comment|//  satDeviceData_t           *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaSATAIdentifyData_t
modifier|*
name|pSATAIdData
decl_stmt|;
name|bit8
modifier|*
name|pInquiry
decl_stmt|;
name|bit8
name|page
init|=
literal|0xFF
decl_stmt|;
name|bit32
name|lenReceived
init|=
literal|0
decl_stmt|;
name|bit32
name|allocationLen
init|=
literal|0
decl_stmt|;
name|bit32
name|lenNeeded
init|=
literal|0
decl_stmt|;
name|bit8
name|dataBuffer
index|[
name|SATA_PAGE89_INQUIRY_SIZE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryIntCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
name|scsiCmnd
operator|=
operator|&
name|smScsiRequest
operator|->
name|scsiCmnd
expr_stmt|;
name|pInquiry
operator|=
name|dataBuffer
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|pSATAIdData
operator|=
operator|&
name|oneDeviceData
operator|->
name|satIdentifyData
expr_stmt|;
name|allocationLen
operator|=
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|)
operator|<<
literal|8
operator|)
operator|+
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
expr_stmt|;
name|allocationLen
operator|=
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|scsiCmnd
operator|->
name|expDataLength
argument_list|)
expr_stmt|;
comment|/* SPC-4, spec 6.4 p 141 */
comment|/* EVPD bit == 0 */
if|if
condition|(
operator|!
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
name|SCSI_EVPD_MASK
operator|)
condition|)
block|{
comment|/* Returns the standard INQUIRY data */
name|lenNeeded
operator|=
name|STANDARD_INQUIRY_SIZE
expr_stmt|;
name|smsatInquiryStandard
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|scsiCmnd
argument_list|)
expr_stmt|;
comment|//smhexdump("satInquiryIntCB ***standard***", (bit8 *)pInquiry, 36);
block|}
else|else
block|{
comment|/* EVPD bit != 0&& PAGE CODE != 0 */
comment|/* returns the pages of vital product data information */
comment|/* we must support page 00h, 83h and 89h */
name|page
operator|=
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|page
operator|!=
name|INQUIRY_SUPPORTED_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_UNIT_SERIAL_NUMBER_VPD_PAGE
operator|)
operator|&&
operator|(
name|page
operator|!=
name|INQUIRY_BLOCK_DEVICE_CHARACTERISTICS_VPD_PAGE
operator|)
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_ILLEGAL_REQUEST
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_INVALID_FIELD_IN_CDB
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryIntCB: invalid PAGE CODE 0x%x!!!\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* checking length */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|INQUIRY_SUPPORTED_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGE0_INQUIRY_SIZE
expr_stmt|;
comment|/* 36 */
break|break;
case|case
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
case|:
if|if
condition|(
name|oneDeviceData
operator|->
name|satWWNSupport
condition|)
block|{
name|lenNeeded
operator|=
name|SATA_PAGE83_INQUIRY_WWN_SIZE
expr_stmt|;
comment|/* 16 */
block|}
else|else
block|{
name|lenNeeded
operator|=
name|SATA_PAGE83_INQUIRY_NO_WWN_SIZE
expr_stmt|;
comment|/* 76 */
block|}
break|break;
case|case
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGE89_INQUIRY_SIZE
expr_stmt|;
comment|/* 572 */
break|break;
case|case
name|INQUIRY_UNIT_SERIAL_NUMBER_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGE80_INQUIRY_SIZE
expr_stmt|;
comment|/* 24 */
break|break;
case|case
name|INQUIRY_BLOCK_DEVICE_CHARACTERISTICS_VPD_PAGE
case|:
name|lenNeeded
operator|=
name|SATA_PAGEB1_INQUIRY_SIZE
expr_stmt|;
comment|/* 64 */
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryIntCB: wrong!!! invalidinvalid PAGE CODE 0x%x!!!\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/*      * Fill in the Inquiry data depending on what Inquiry data we are returning.      */
switch|switch
condition|(
name|page
condition|)
block|{
case|case
name|INQUIRY_SUPPORTED_VPD_PAGE
case|:
name|smsatInquiryPage0
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_DEVICE_IDENTIFICATION_VPD_PAGE
case|:
name|smsatInquiryPage83
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|oneDeviceData
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_ATA_INFORMATION_VPD_PAGE
case|:
name|smsatInquiryPage89
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|,
name|oneDeviceData
argument_list|,
name|lenReceived
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_UNIT_SERIAL_NUMBER_VPD_PAGE
case|:
name|smsatInquiryPage80
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
break|break;
case|case
name|INQUIRY_BLOCK_DEVICE_CHARACTERISTICS_VPD_PAGE
case|:
name|smsatInquiryPageB1
argument_list|(
name|pInquiry
argument_list|,
name|pSATAIdData
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryIntCB: wrong!!! invalidinvalid PAGE CODE 0x%x!!!\n"
operator|,
name|page
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* else */
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryIntCB: calling tdsmIOCompletedCB\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* if this is a standard Inquiry command, notify Stoport to set the device queue depth to max NCQ */
if|if
condition|(
operator|(
name|oneDeviceData
operator|->
name|satNCQ
operator|==
name|agTRUE
operator|)
operator|&&
operator|(
operator|(
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|&
literal|0x01
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|tdsmSetDeviceQueueDepth
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|-
literal|1
argument_list|)
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatInquiryIntCB: failed to call tdsmSetDeviceQueueDepth()!!! Q=%d\n"
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|sm_memcpy
argument_list|(
name|smScsiRequest
operator|->
name|sglVirtualAddr
argument_list|,
name|dataBuffer
argument_list|,
name|MIN
argument_list|(
name|allocationLen
argument_list|,
name|lenNeeded
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|allocationLen
operator|>
name|lenNeeded
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryIntCB reporting underrun lenNeeded=0x%x allocationLen=0x%x smIORequest=%p\n"
operator|,
name|lenNeeded
operator|,
name|allocationLen
operator|,
name|smIORequest
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|allocationLen
operator|-
name|lenNeeded
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatInquiryIntCB: device %p pending IO %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatInquiryIntCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatVerify10CB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify10CB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify10CB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatVerify10CB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satIOContext
operator|->
name|pSense
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatVerify10CB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatVerify10CB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatVerify10CB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10CB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisRegDeviceToHost_t is expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10CB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10CB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10CB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10CB: SAT_READ_VERIFY_SECTORS_EXT!!!\n"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10CB: error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end error checking */
block|}
comment|/* process success from this point on */
switch|switch
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
condition|)
block|{
case|case
name|SAT_READ_VERIFY_SECTORS_EXT
case|:
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatVerify10CB: SAT_WRITE_DMA_EXT success \n"
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatVerify10CB: success but error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_NO_SENSE
argument_list|,
literal|0
argument_list|,
name|SCSI_SNSCODE_NO_ADDITIONAL_INFO
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
comment|/* ==&satIntIo->satOrgSmIORequest */
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatReadLogExtCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satReadLogExtIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|agsaIORequest_t
modifier|*
name|agAbortIORequest
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smAbortIORequestBody
decl_stmt|;
name|bit32
name|PhysUpper32
decl_stmt|;
name|bit32
name|PhysLower32
decl_stmt|;
name|bit32
name|memAllocStatus
decl_stmt|;
name|void
modifier|*
name|osMemHandle
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatReadLogExtCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadLogExtCB: agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satReadLogExtIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satReadLogExtIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satReadLogExtIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smDeviceHandle
operator|=
name|satReadLogExtIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadLogExtCB: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadLogExtCB: smIORequestBody ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadLogExtCB: smIORequestBody ioCompleted %d ioStarted %d\n"
operator|,
name|smIORequestBody
operator|->
name|ioCompleted
operator|,
name|smIORequestBody
operator|->
name|ioStarted
operator|)
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satReadLogExtIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
comment|/*    * If READ LOG EXT failed, we issue device reset.    */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
operator|||
operator|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
operator|&&
name|agFirstDword
operator|!=
name|agNULL
operator|&&
name|agIOInfoLen
operator|!=
literal|0
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadLogExtCB: FAILED.!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* Abort I/O after completion of device reset */
name|oneDeviceData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* needs to investigate this case */
comment|/* no report to OS layer */
name|satSubTM
argument_list|(
name|smRoot
argument_list|,
name|satReadLogExtIOContext
operator|->
name|ptiDeviceHandle
argument_list|,
name|TD_INTERNAL_TM_RESET
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
comment|/***************************************************************************    * The following steps take place when READ LOG EXT successfully completed.    ***************************************************************************/
comment|/************************************************************************    *    * 1. Issue abort to LL layer to all other pending I/Os for the same SATA    *    drive.    *    * 2. Free resource allocated for the internally generated READ LOG EXT.    *    * 3. At the completion of abort, in the context of ossaSATACompleted(),    *    return the I/O with error status to the OS-App Specific layer.    *    When all I/O aborts are completed, clear SATA device flag to    *    indicate ready to process new request.    *    ***********************************************************************/
comment|/*    * Issue abort to LL layer to all other pending I/Os for the same SATA drive    */
comment|/*     replace the single IO abort with device abort   */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadLogExtCB: issuing saSATAAbort. Device Abort!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SMAbortAll
operator|=
name|agTRUE
expr_stmt|;
comment|/*   smAbortIORequestBody = smDequeueIO(smRoot);    if (smAbortIORequestBody == agNULL)   {     SM_DBG1(("smsatReadLogExtCB: empty freeIOList!!!\n"));     return;   }   */
comment|/* allocating agIORequest for abort itself */
name|memAllocStatus
operator|=
name|tdsmAllocMemory
argument_list|(
name|smRoot
argument_list|,
operator|&
name|osMemHandle
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|smAbortIORequestBody
argument_list|,
operator|&
name|PhysUpper32
argument_list|,
operator|&
name|PhysLower32
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|,
name|agTRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|memAllocStatus
operator|!=
name|tiSuccess
condition|)
block|{
comment|/* let os process IO */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadLogExtCB: ostiAllocMemory failed...\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|smAbortIORequestBody
operator|==
name|agNULL
condition|)
block|{
comment|/* let os process IO */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadLogExtCB: ostiAllocMemory returned NULL smAbortIORequestBody\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smIOReInit
argument_list|(
name|smRoot
argument_list|,
name|smAbortIORequestBody
argument_list|)
expr_stmt|;
comment|/* setup task management structure */
name|smAbortIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|=
name|osMemHandle
expr_stmt|;
name|smAbortIORequestBody
operator|->
name|smDevHandle
operator|=
name|smDeviceHandle
expr_stmt|;
comment|/* setup task management structure */
comment|//  smAbortIORequestBody->IOType.InitiatorTMIO.osMemHandle = osMemHandle;
name|satIOContext
operator|=
operator|&
operator|(
name|smAbortIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext
operator|->
name|smRequestBody
operator|=
name|smAbortIORequestBody
expr_stmt|;
comment|/* initialize agIORequest */
name|agAbortIORequest
operator|=
operator|&
operator|(
name|smAbortIORequestBody
operator|->
name|agIORequest
operator|)
expr_stmt|;
name|agAbortIORequest
operator|->
name|osData
operator|=
operator|(
name|void
operator|*
operator|)
name|smAbortIORequestBody
expr_stmt|;
name|agAbortIORequest
operator|->
name|sdkData
operator|=
name|agNULL
expr_stmt|;
comment|/* LL takes care of this */
comment|/*    * Issue abort (device abort all)    */
name|saSATAAbort
argument_list|(
name|agRoot
argument_list|,
name|agAbortIORequest
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|,
name|oneDeviceData
operator|->
name|agDevHandle
argument_list|,
literal|1
argument_list|,
name|agNULL
argument_list|,
name|smaSATAAbortCB
argument_list|)
expr_stmt|;
comment|/*    * Free resource allocated for the internally generated READ LOG EXT.    */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*    * Sequence of recovery continue at some other context:    * At the completion of abort, in the context of ossaSATACompleted(),    * return the I/O with error status to the OS-App Specific layer.    * When all I/O aborts are completed, clear SATA device flag to    * indicate ready to process new request.    */
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatReadLogExtCB: end return!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|ossaSATAEvent
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|agsaPortContext_t
modifier|*
name|agPortContext
parameter_list|,
name|agsaDevHandle_t
modifier|*
name|agDevHandle
parameter_list|,
name|bit32
name|event
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|gsmRoot
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smList_t
modifier|*
name|DeviceListList
decl_stmt|;
name|bit32
name|found
init|=
name|agFALSE
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext2
decl_stmt|;
name|smIORequest_t
name|smIORequestTMP
decl_stmt|;
name|bit32
name|status
decl_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|agsaDifDetails_t
name|agDifDetails
decl_stmt|;
name|bit8
name|framePayload
index|[
literal|256
index|]
decl_stmt|;
name|bit16
name|frameOffset
init|=
literal|0
decl_stmt|;
name|bit16
name|frameLen
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_ERROR_ABORTED_NCQ_MODE
condition|)
block|{
comment|/* agIORequest is invalid, search for smDeviceHandle from smAllShared using agDevHandle */
comment|/* find a device's existence */
name|DeviceListList
operator|=
name|smAllShared
operator|->
name|MainDeviceList
operator|.
name|flink
expr_stmt|;
while|while
condition|(
name|DeviceListList
operator|!=
operator|&
operator|(
name|smAllShared
operator|->
name|MainDeviceList
operator|)
condition|)
block|{
name|oneDeviceData
operator|=
name|SMLIST_OBJECT_BASE
argument_list|(
name|smDeviceData_t
argument_list|,
name|MainLink
argument_list|,
name|DeviceListList
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|agDevHandle
operator|==
name|agDevHandle
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"ossaSATAEvent: did %d\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|found
operator|=
name|agTRUE
expr_stmt|;
break|break;
block|}
name|DeviceListList
operator|=
name|DeviceListList
operator|->
name|flink
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"ossaSATAEvent: not found!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|valid
operator|==
name|agFALSE
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"ossaSATAEvent: oneDeviceData is not valid did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/**************************************************************************      *      * !!!! See Section 13.5.2.4 of SATA 2.5 specs.                       !!!!      * !!!! If the NCQ error ends up here, it means that the device sent  !!!!      * !!!! Register Device To Host FIS (which does not have SActive      !!!!      * !!!! register) instead of Set Device Bit FIS (which has SActive    !!!!      * !!!! register). The routine osSatIOCompleted() deals with the case !!!!      * !!!! where Set Device Bit FIS was sent by the device.              !!!!      *      * For NCQ we need to issue READ LOG EXT command with log page 10h      * to get the error and to allow other I/Os to continue.      *      * Here is the basic flow or sequence of error recovery, this sequence is      * similar to the one described in SATA 2.5:      *      * 1. Set SATA device flag to indicate error condition and returning busy      *    for all new request.      *      * 2. Prepare READ LOG EXT page 10h command. Set flag to indicate that      *    the failed I/O has NOT been returned to the OS Layer. Send command.      *      * 3. When the device receives READ LOG EXT page 10h request all other      *    pending I/O are implicitly aborted. No completion (aborted) status      *    will be sent to the host for these aborted commands.      *      * 4. SATL receives the completion for READ LOG EXT command in      *    smsatReadLogExtCB(). Steps 5,6,7,8 below are the step 1,2,3,4 in      *    smsatReadLogExtCB().      *      * 5. Check flag that indicates whether the failed I/O has been returned      *    to the OS Layer. If not, search the I/O context in device data      *    looking for a matched tag. Then return the completion of the failed      *    NCQ command with the appopriate/trasnlated SCSI status.      *      * 6. Issue abort to LL layer to all other pending I/Os for the same SATA      *    drive.      *      * 7. Free resource allocated for the internally generated READ LOG EXT.      *      * 8. At the completion of abort, in the context of ossaSATACompleted(),      *    return the I/O with error status to the OS-App Specific layer.      *    When all I/O aborts are completed, clear SATA device flag to      *    indicate ready to process new request.      *      *************************************************************************/
name|smDeviceHandle
operator|=
name|oneDeviceData
operator|->
name|smDevHandle
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|satDriveState
operator|==
name|SAT_DEV_STATE_NORMAL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: NCQ ERROR did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
comment|/* Set flag to indicate we are in recovery */
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_IN_RECOVERY
expr_stmt|;
comment|/*        * Allocate resource for READ LOG EXIT page 10h        */
name|satIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
operator|&
operator|(
name|smIORequestTMP
operator|)
argument_list|,
comment|/* anything but NULL */
name|oneDeviceData
argument_list|,
sizeof|sizeof
argument_list|(
name|satReadLogExtPage10h_t
argument_list|)
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/*        * If we cannot allocate resource to do the normal NCQ recovery, we        * will do SATA device reset.        */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
comment|/* Abort I/O after completion of device reset */
name|oneDeviceData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: can't send RLE due to resource lack!!!\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* needs to investigate this case */
comment|/* no report to OS layer */
name|smsatSubTM
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|TD_INTERNAL_TM_RESET
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
comment|/*        * Clear flag to indicate that the failed I/O has NOT been returned to the        * OS-App specific Layer.        */
name|satIntIo
operator|->
name|satIntFlag
operator|=
literal|0
expr_stmt|;
comment|/* compare to satPrepareNewIO() */
comment|/* Send READ LOG EXIT page 10h command */
comment|/*        * Need to initialize all the fields within satIOContext except        * reqType and satCompleteCB which will be set depending on cmd.        */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
name|satIOContext2
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSatDevData
operator|=
name|oneDeviceData
expr_stmt|;
name|satIOContext2
operator|->
name|pFis
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|agSATARequestBody
operator|.
name|fis
operator|.
name|fisRegHostToDev
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pScsiCmnd
operator|=
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|.
name|scsiCmnd
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSense
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|sensePayload
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSmSenseData
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|smSenseData
operator|)
expr_stmt|;
name|satIOContext2
operator|->
name|pSmSenseData
operator|->
name|senseData
operator|=
name|satIOContext2
operator|->
name|pSense
expr_stmt|;
name|satIOContext2
operator|->
name|smRequestBody
operator|=
name|satIntIo
operator|->
name|satIntRequestBody
expr_stmt|;
comment|//not used
comment|//      satIOContext2->interruptContext = interruptContext;
name|satIOContext2
operator|->
name|satIntIoContext
operator|=
name|satIntIo
expr_stmt|;
name|satIOContext2
operator|->
name|psmDeviceHandle
operator|=
name|smDeviceHandle
expr_stmt|;
name|satIOContext2
operator|->
name|satOrgIOContext
operator|=
name|agNULL
expr_stmt|;
name|satIOContext2
operator|->
name|smScsiXchg
operator|=
name|agNULL
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: smIORequestBody ID %d!!!\n"
operator|,
name|smIORequestBody
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: smIORequestBody ioCompleted %d ioStarted %d\n"
operator|,
name|smIORequestBody
operator|->
name|ioCompleted
operator|,
name|smIORequestBody
operator|->
name|ioStarted
operator|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|smsatSendReadLogExt
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
operator|&
name|satIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satIOContext2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: can't send RLE due to LL api failure!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* Abort I/O after completion of device reset */
name|oneDeviceData
operator|->
name|satAbortAfterReset
operator|=
name|agTRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|NOT_YET
comment|/* needs to investigate this case */
comment|/* no report to OS layer */
name|smsatSubTM
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|TD_INTERNAL_TM_RESET
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agNULL
argument_list|,
name|agFALSE
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: NCQ ERROR but recovery in progress!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_CMD_FRAME_ISSUED
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_XFER_CMD_FRAME_ISSUED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_PIO_SETUP_ERROR
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_XFER_PIO_SETUP_ERROR\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_XFR_ERROR_DEK_KEY_TAG_MISMATCH\n"
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_MISMATCH
operator|||
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_APPLICATION_TAG_MISMATCH
operator|||
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_REFERENCE_TAG_MISMATCH
operator|||
name|event
operator|==
name|OSSA_IO_XFR_ERROR_DIF_CRC_MISMATCH
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: DIF related, event 0x%x\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
comment|/* process DIF detail information */
name|SM_DBG2
argument_list|(
operator|(
literal|"ossaSATAEvent: agIOInfoLen %d\n"
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agParam
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"ossaSATAEvent: agParam is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOInfoLen
operator|<
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"ossaSATAEvent: wrong agIOInfoLen!!! agIOInfoLen %d sizeof(agsaDifDetails_t) %d\n"
operator|,
name|agIOInfoLen
operator|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* reads agsaDifDetails_t */
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
literal|0
argument_list|,
operator|&
name|agDifDetails
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
argument_list|)
expr_stmt|;
name|frameOffset
operator|=
operator|(
name|agDifDetails
operator|.
name|ErrBoffsetEDataLen
operator|&
literal|0xFFFF
operator|)
expr_stmt|;
name|frameLen
operator|=
operator|(
name|agDifDetails
operator|.
name|ErrBoffsetEDataLen
operator|&
literal|0xFFFF0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"ossaSATAEvent: UpperLBA 0x%08x LowerLBA 0x%08x\n"
operator|,
name|agDifDetails
operator|.
name|UpperLBA
operator|,
name|agDifDetails
operator|.
name|LowerLBA
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"ossaSATAEvent: SASAddrHI 0x%08x SASAddrLO 0x%08x\n"
operator|,
name|SM_GET_SAS_ADDRESSHI
argument_list|(
name|agDifDetails
operator|.
name|sasAddressHi
argument_list|)
operator|,
name|SM_GET_SAS_ADDRESSLO
argument_list|(
name|agDifDetails
operator|.
name|sasAddressLo
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"ossaSATAEvent: DIF error mask 0x%x Device ID 0x%x\n"
operator|,
operator|(
name|agDifDetails
operator|.
name|DIFErrDevID
operator|)
operator|&
literal|0xFF
operator|,
operator|(
name|agDifDetails
operator|.
name|DIFErrDevID
operator|&
literal|0xFFFF0000
operator|)
operator|>>
literal|16
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|frameLen
operator|!=
literal|0
operator|&&
name|frameLen
operator|<=
literal|256
condition|)
block|{
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agParam
argument_list|,
sizeof|sizeof
argument_list|(
name|agsaDifDetails_t
argument_list|)
argument_list|,
name|framePayload
argument_list|,
name|frameLen
argument_list|)
expr_stmt|;
name|smhexdump
argument_list|(
literal|"ossaSATAEvent frame"
argument_list|,
name|framePayload
argument_list|,
name|frameLen
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: smIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smDeviceHandle
operator|=
name|smIORequestBody
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: ERROR event %d did=%d\n"
operator|,
name|event
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smAllShared
operator|->
name|FCA
condition|)
block|{
if|if
condition|(
name|oneDeviceData
operator|->
name|SMNumOfFCA
operator|<=
literal|0
condition|)
comment|/* does SMP HARD RESET only upto one time */
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY; sending HARD_RESET\n"
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|SMNumOfFCA
operator|++
expr_stmt|;
name|smPhyControlSend
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|SMP_PHY_CONTROL_HARD_RESET
argument_list|,
name|agNULL
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* given up after one time of SMP HARD RESET; */
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY; but giving up sending HARD_RESET!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_ERROR_NAK_RECEIVED
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_XFER_ERROR_NAK_RECEIVED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|OSSA_IO_XFER_ERROR_DMA_ACTIVATE_TIMEOUT
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: OSSA_IO_XFER_ERROR_DMA_ACTIVATE_TIMEOUT\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaSATAEvent: other event 0x%x\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smSMPCompletedCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
name|smSMPRequestBody_t
modifier|*
name|smSMPRequestBody
init|=
operator|(
name|smSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smSMPCompletedCB: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smSMPRequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smSMPCompletedCB: smSMPRequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|smSMPRequestBody
operator|->
name|SMPCompletionFunc
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smSMPCompletedCB: smSMPRequestBody->SMPCompletionFunc is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* calling smSMPCompleted */
name|smSMPRequestBody
operator|->
name|SMPCompletionFunc
argument_list|(
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|agIOStatus
argument_list|,
name|agIOInfoLen
argument_list|,
name|agFrameHandle
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smSMPCompleted
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|gsmRoot
decl_stmt|;
name|smSMPRequestBody_t
modifier|*
name|smSMPRequestBody
init|=
operator|(
name|smSMPRequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smIORequest_t
modifier|*
name|CurrentTaskTag
decl_stmt|;
name|bit8
name|smpHeader
index|[
literal|4
index|]
decl_stmt|;
name|smSMPFrameHeader_t
modifier|*
name|smSMPFrameHeader
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smSMPCompleted: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smSMPRequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smSMPCompleted: smSMPRequestBody is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|CurrentTaskTag
operator|=
name|smSMPRequestBody
operator|->
name|CurrentTaskTag
expr_stmt|;
name|oneDeviceData
operator|=
name|smSMPRequestBody
operator|->
name|smDeviceData
expr_stmt|;
name|smDeviceHandle
operator|=
name|smSMPRequestBody
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smSMPCompleted: smDeviceHandle is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smSMPCompleted: oneDeviceData is NULL, wrong!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agExpDevHandle
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|saFrameReadBlock
argument_list|(
name|agRoot
argument_list|,
name|agFrameHandle
argument_list|,
literal|0
argument_list|,
name|smpHeader
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|smSMPFrameHeader
operator|=
operator|(
name|smSMPFrameHeader_t
operator|*
operator|)
name|smpHeader
expr_stmt|;
if|if
condition|(
name|smSMPFrameHeader
operator|->
name|smpFunction
operator|==
name|SMP_PHY_CONTROL
condition|)
block|{
name|SM_DBG3
argument_list|(
operator|(
literal|"smSMPCompleted: phy control\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOInfoLen
operator|!=
literal|4
operator|&&
name|smSMPFrameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
comment|/*zero length is expected */
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smSMPCompleted: mismatch len agIOInfoLen 0x%x 0x%x!!!\n"
operator|,
name|agIOInfoLen
operator|,
literal|4
operator|)
argument_list|)
expr_stmt|;
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CurrentTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|smPhyControlRespRcvd
argument_list|(
name|smRoot
argument_list|,
name|agRoot
argument_list|,
name|agIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|smSMPFrameHeader
argument_list|,
name|agFrameHandle
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* unknown SMP function */
name|SM_DBG2
argument_list|(
operator|(
literal|"smSMPCompleted: unknown smSMPFrameHeader %d!!!\n"
operator|,
name|smSMPFrameHeader
operator|->
name|smpFunction
operator|)
argument_list|)
expr_stmt|;
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CurrentTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smSMPCompleted: failed agIOStatus %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_RETRY_BACKOFF_THRESHOLD_REACHED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_TMO
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_NO_DEST
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_OPEN_COLLIDE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS_PATHWAY_BLOCKED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smSMPCompleted: setting back to operational\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agDevHandle
operator|!=
name|agNULL
condition|)
block|{
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smSMPCompleted: agDevHandle is NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CurrentTaskTag
operator|!=
name|agNULL
condition|)
block|{
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smSMPRequestBody
operator|->
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smSMPRequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smPhyControlRespRcvd
parameter_list|(
name|smRoot_t
modifier|*
name|smRoot
parameter_list|,
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|smDeviceData_t
modifier|*
name|oneDeviceData
parameter_list|,
comment|/* sata disk */
name|smSMPFrameHeader_t
modifier|*
name|frameHeader
parameter_list|,
name|agsaFrameHandle_t
name|frameHandle
parameter_list|,
name|smIORequest_t
modifier|*
name|CurrentTaskTag
parameter_list|)
block|{
name|smDeviceData_t
modifier|*
name|TargetDeviceData
init|=
name|agNULL
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|smSMPRequestBody_t
modifier|*
name|smSMPRequestBody
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smPhyControlRespRcvd: start\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CurrentTaskTag
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlRespRcvd: CurrentTaskTag is NULL; allowed\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smSMPRequestBody
operator|=
operator|(
name|smSMPRequestBody_t
operator|*
operator|)
name|CurrentTaskTag
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|smSMPRequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlRespRcvd: smSMPRequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smDeviceHandle
operator|=
name|smSMPRequestBody
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smPhyControlRespRcvd: smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|TargetDeviceData
operator|=
name|smSMPRequestBody
operator|->
name|smDeviceData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|!=
name|TargetDeviceData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlRespRcvd: oneDeviceData != TargetDeviceData!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|agDevHandle
operator|=
name|TargetDeviceData
operator|->
name|agDevHandle
expr_stmt|;
if|if
condition|(
name|frameHeader
operator|->
name|smpFunctionResult
operator|==
name|SMP_FUNCTION_ACCEPTED
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smPhyControlRespRcvd: SMP success\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlRespRcvd: callback to TD layer with success\n"
operator|)
argument_list|)
expr_stmt|;
name|TargetDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMOK
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smPhyControlRespRcvd: SMP failure; result %d!!!\n"
operator|,
name|frameHeader
operator|->
name|smpFunctionResult
operator|)
argument_list|)
expr_stmt|;
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|CurrentTaskTag
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatCheckPowerModeCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/* callback for satDeResetDevice */
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|bit32
name|AbortTM
init|=
name|agFALSE
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
name|smDeviceHandle
operator|=
name|oneDeviceData
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: OSSA_IO_OPEN_CNX_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisPioSetup_t is expected */
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: ataStatus 0x%x ataError 0x%x!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: success!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: TMF %d!!!\n"
operator|,
name|satOrgIOContext
operator|->
name|TMF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|TMF
operator|==
name|AG_ABORT_TASK
condition|)
block|{
name|AbortTM
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|AbortTM
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: calling local satAbort!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatAbort
argument_list|(
name|smRoot
argument_list|,
name|agRoot
argument_list|,
name|satOrgIOContext
operator|->
name|satToBeAbortedIOContext
argument_list|)
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: satPendingIO %d satNCQMaxIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: satPendingNCQIO %d satPendingNONNCQIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMOK
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: device %p pending IO %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatCheckPowerModeCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatCheckPowerModePassCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|bit8
name|bSenseKey
init|=
literal|0
decl_stmt|;
name|bit16
name|bSenseCodeInfo
init|=
literal|0
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModePassCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatCheckPowerModePassCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatCheckPowerModePassCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatCheckPowerModePassCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatCheckPowerModePassCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModePassCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisPioSetup_t is expected */
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModePassCB: ataStatus 0x%x ataError 0x%x!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatTranslateATAErrorsToSCSIErrors
argument_list|(
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatCheckPowerModePassCB: success!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatIDDataPassCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|bit8
name|bSenseKey
init|=
literal|0
decl_stmt|;
name|bit16
name|bSenseCodeInfo
init|=
literal|0
decl_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatIDDataPassCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatIDDataPassCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatIDDataPassCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatIDDataPassCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatIDDataPassCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDDataPassCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisPioSetup_t is expected */
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatIDDataPassCB: ataStatus 0x%x ataError 0x%x!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatTranslateATAErrorsToSCSIErrors
argument_list|(
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatIDDataPassCB: success!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatIDDataPassCB: extend 0x%x ck_cond 0x%x sectorCnt07 0x%x\n"
operator|,
name|satOrgIOContext
operator|->
name|extend
operator|,
name|satIOContext
operator|->
name|ck_cond
operator|,
name|satOrgIOContext
operator|->
name|sectorCnt07
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG3
argument_list|(
operator|(
literal|"smsatIDDataPassCB: LBAHigh07 0x%x LBAMid07 0x%x LBALow07 0x%x\n"
operator|,
name|satOrgIOContext
operator|->
name|LBAHigh07
operator|,
name|satOrgIOContext
operator|->
name|LBAMid07
operator|,
name|satOrgIOContext
operator|->
name|LBALow07
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|->
name|ck_cond
condition|)
block|{
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|SCSI_SNSKEY_RECOVERED_ERROR
argument_list|,
name|satOrgIOContext
operator|->
name|sectorCnt07
argument_list|,
name|SCSI_SNSCODE_ATA_PASS_THROUGH_INFORMATION_AVAILABLE
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
block|}
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatResetDeviceCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/* callback for satResetDevice */
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
comment|//  satDeviceData_t         *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|bit32
name|status
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatResetDeviceCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
name|smDeviceHandle
operator|=
name|oneDeviceData
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatResetDeviceCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatResetDeviceCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatResetDeviceCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatResetDeviceCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatResetDeviceCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatResetDeviceCB: OSSA_IO_OPEN_CNX_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisPioSetup_t is expected */
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatResetDeviceCB: ataStatus 0x%x ataError 0x%x!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
comment|/* memory allocation failure */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatResetDeviceCB: momory allocation fails!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end of memory allocation failure */
comment|/*      * Need to initialize all the fields within satIOContext      */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* send AGSA_SATA_PROTOCOL_SRST_DEASSERT */
name|status
operator|=
name|smsatDeResetDevice
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
operator|->
name|psmDeviceHandle
argument_list|,
name|agNULL
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
comment|/* sending AGSA_SATA_PROTOCOL_SRST_DEASSERT fails */
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|//  oneDeviceData->satTmTaskTag = agNULL;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatResetDeviceCB: device %p pending IO %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatResetDeviceCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatDeResetDeviceCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
comment|/* callback for satDeResetDevice */
comment|//  tdsaRootOsData_t        *osData = (tdsaRootOsData_t *)agRoot->osData;
comment|//  tiRoot_t                *tiRoot = (tiRoot_t *)osData->tiRoot;
comment|//  tdsaRoot_t              *tdsaRoot        = (tdsaRoot_t *) tiRoot->tdData;
comment|//  tdsaContext_t           *tdsaAllShared = (tdsaContext_t *)&tdsaRoot->tdsaAllShared;
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//  satDeviceData_t           *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
decl_stmt|;
name|agsaFisPioSetupHeader_t
modifier|*
name|satPIOSetupHeader
init|=
name|agNULL
decl_stmt|;
endif|#
directive|endif
name|bit32
name|AbortTM
init|=
name|agFALSE
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: start!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
name|smDeviceHandle
operator|=
name|oneDeviceData
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: External, OS generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: Internal, TD generated\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_PROTOCOL_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_ZONE_VIOLATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BREAK
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_IT_NEXUS_LOSS
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_BAD_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_CONNECTION_RATE_NOT_SUPPORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_WRONG_DESTINATION
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_UNKNOWN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_OPEN_CNX_ERROR_STP_RESOURCES_BUSY
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: OSSA_IO_OPEN_CNX_ERROR!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* only agsaFisPioSetup_t is expected */
ifdef|#
directive|ifdef
name|TD_DEBUG_ENABLE
name|satPIOSetupHeader
operator|=
operator|(
name|agsaFisPioSetupHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|PioSetup
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|satPIOSetupHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|satPIOSetupHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
endif|#
directive|endif
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: ataStatus 0x%x ataError 0x%x!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* success */
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: success !!!\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: TMF %d!!!\n"
operator|,
name|satOrgIOContext
operator|->
name|TMF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|->
name|TMF
operator|==
name|AG_ABORT_TASK
condition|)
block|{
name|AbortTM
operator|=
name|agTRUE
expr_stmt|;
block|}
if|if
condition|(
name|AbortTM
operator|==
name|agTRUE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: calling satAbort!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatAbort
argument_list|(
name|smRoot
argument_list|,
name|agRoot
argument_list|,
name|satOrgIOContext
operator|->
name|satToBeAbortedIOContext
argument_list|)
expr_stmt|;
block|}
name|oneDeviceData
operator|->
name|satTmTaskTag
operator|=
name|agNULL
expr_stmt|;
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: satPendingIO %d satNCQMaxIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: satPendingNCQIO %d satPendingNONNCQIO %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMOK
argument_list|,
name|oneDeviceData
operator|->
name|satTmTaskTag
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: device %p pending IO %d\n"
operator|,
name|oneDeviceData
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG6
argument_list|(
operator|(
literal|"smsatDeResetDeviceCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smaSATAAbortCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|flag
parameter_list|,
name|bit32
name|status
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|gsmRoot
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: smIORequestBody is NULL!!! \n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIOContext
operator|=
operator|&
operator|(
name|smIORequestBody
operator|->
name|transport
operator|.
name|SATA
operator|.
name|satIOContext
operator|)
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: satIOContext is NULL!!! \n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|!=
name|agNULL
condition|)
block|{
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|smDeviceHandle
operator|=
name|smIORequestBody
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|!=
name|agNULL
condition|)
block|{
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|!=
name|agNULL
condition|)
block|{
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|flag
operator|==
literal|2
condition|)
block|{
comment|/* abort per port */
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: abort per port, not yet!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|1
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: abort all!!!\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|->
name|OSAbortAll
operator|==
name|agTRUE
condition|)
block|{
name|oneDeviceData
operator|->
name|OSAbortAll
operator|=
name|agFALSE
expr_stmt|;
if|#
directive|if
literal|0
block|ostiInitiatorEvent( tiRoot,                             agNULL,                             tiDeviceHandle,                             tiIntrEventTypeLocalAbort,                             tiAbortOK,                             agNULL);
endif|#
directive|endif
if|#
directive|if
literal|1
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeLocalAbort
argument_list|,
name|smTMOK
argument_list|,
name|agNULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|!=
name|agNULL
condition|)
block|{
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|flag
operator|==
literal|0
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: abort one\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: OSSA_IO_SUCCESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NOT_VALID
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: OSSA_IO_NOT_VALID\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_NO_DEVICE
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: OSSA_IO_NO_DEVICE\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_IN_PROGRESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: OSSA_IO_ABORT_IN_PROGRESS\n"
operator|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|REMOVED
elseif|else
if|if
condition|(
name|status
operator|==
name|OSSA_IO_ABORT_DELAYED
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: OSSA_IO_ABORT_DELAYED\n"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: unspecified status 0x%x\n"
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
operator|!=
name|agNULL
condition|)
block|{
name|tdsmFreeMemory
argument_list|(
name|smRoot
argument_list|,
name|smIORequestBody
operator|->
name|IOType
operator|.
name|InitiatorTMIO
operator|.
name|osMemHandle
argument_list|,
sizeof|sizeof
argument_list|(
name|smIORequestBody_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smaSATAAbortCB: wrong flag %d\n"
operator|,
name|flag
operator|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smLocalPhyControlCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaContext_t
modifier|*
name|agContext
parameter_list|,
name|bit32
name|phyId
parameter_list|,
name|bit32
name|phyOperation
parameter_list|,
name|bit32
name|status
parameter_list|,
name|void
modifier|*
name|parm
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|gsmRoot
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
init|=
name|agNULL
decl_stmt|;
name|smIORequest_t
modifier|*
name|currentTaskTag
decl_stmt|;
name|agsaDevHandle_t
modifier|*
name|agDevHandle
init|=
name|agNULL
decl_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smLocalPhyControlCB: start phyId 0x%x phyOperation 0x%x status 0x%x\n"
operator|,
name|phyId
operator|,
name|phyOperation
operator|,
name|status
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smLocalPhyControlCB: agContext is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|currentTaskTag
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|agContext
operator|->
name|osData
expr_stmt|;
if|if
condition|(
name|currentTaskTag
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smLocalPhyControlCB: currentTaskTag is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|currentTaskTag
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|smIORequestBody
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smLocalPhyControlCB: smIORequestBody is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|smDeviceHandle
operator|=
name|smIORequestBody
operator|->
name|smDevHandle
expr_stmt|;
if|if
condition|(
name|smDeviceHandle
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smLocalPhyControlCB: smDeviceHandle is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|oneDeviceData
operator|=
operator|(
name|smDeviceData_t
operator|*
operator|)
name|smDeviceHandle
operator|->
name|smData
expr_stmt|;
if|if
condition|(
name|oneDeviceData
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smLocalPhyControlCB: oneDeviceData is NULL!!!\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|phyOperation
condition|)
block|{
case|case
name|AGSA_PHY_LINK_RESET
case|:
comment|/* fall through */
case|case
name|AGSA_PHY_HARD_RESET
case|:
if|if
condition|(
name|status
operator|==
name|OSSA_SUCCESS
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smLocalPhyControlCB: callback to TD layer with success\n"
operator|)
argument_list|)
expr_stmt|;
name|agDevHandle
operator|=
name|oneDeviceData
operator|->
name|agDevHandle
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smLocalPhyControlCB: satPendingIO %d satNCQMaxIO %d\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingIO
operator|,
name|oneDeviceData
operator|->
name|satNCQMaxIO
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smLocalPhyControlCB: satPendingNCQIO %d satPendingNONNCQIO %d\n"
operator|,
name|oneDeviceData
operator|->
name|satPendingNCQIO
operator|,
name|oneDeviceData
operator|->
name|satPendingNONNCQIO
operator|)
argument_list|)
expr_stmt|;
name|oneDeviceData
operator|->
name|satDriveState
operator|=
name|SAT_DEV_STATE_NORMAL
expr_stmt|;
ifdef|#
directive|ifdef
name|REMOVED
name|saSetDeviceState
argument_list|(
name|agRoot
argument_list|,
name|agNULL
argument_list|,
name|tdsmRotateQnumber
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|)
argument_list|,
name|agDevHandle
argument_list|,
name|SA_DS_OPERATIONAL
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMOK
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smLocalPhyControlCB: callback to TD layer with failure!!!\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|SM_DBG1
argument_list|(
operator|(
literal|"ossaLocalPhyControlCB: error default case. phyOperation is %d!!!\n"
operator|,
name|phyOperation
operator|)
argument_list|)
expr_stmt|;
comment|/* TM completed */
name|tdsmEventCB
argument_list|(
name|smRoot
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIntrEventTypeTaskManagement
argument_list|,
name|smTMFailed
argument_list|,
name|currentTaskTag
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSetFeaturesAACB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smIORequest_t
modifier|*
name|smIORequest
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesAACB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesAACB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSetFeaturesAACB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smIORequest
operator|=
name|smOrgIORequest
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSetFeaturesAACB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
block|}
name|smIORequest
operator|=
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesAACB: fail, case 1 agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesAACB: fail, case 2 status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOInfoLen
operator|!=
literal|0
operator|&&
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|statDevToHostFisHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesAACB: fail, case 3 ataStatus %d ataError %d!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ataError
operator|!=
literal|0
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesAACB: fail, case 4 ataStatus %d ataError %d!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIORequest
operator|->
name|tdData
operator|==
name|smIORequest
operator|->
name|smData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesAACB: the same tdData and smData error!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*Complete this identify device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesAACB: end\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  smsatSetFeaturesDMACB * *   This routine is a callback function called from smllSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to smSatIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|smsatSetFeaturesDMACB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|smIORequest_t
modifier|*
name|smIORequest
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequest
operator|=
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|satDMAEnabled
operator|=
name|agTRUE
expr_stmt|;
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|smIORequest
operator|->
name|tdData
operator|==
name|smIORequest
operator|->
name|smData
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: the same tdData and smData error!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: agIOStatus 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
comment|/* check the agIOStatus */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_NO_DEVICE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_PORT_IN_RESET
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_INVALID
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: error status 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|oneDeviceData
operator|->
name|satDeviceType
operator|==
name|SATA_ATAPI_DEVICE
condition|)
block|{
comment|/*if ATAPI device, only need to enable PIO and DMA transfer mode, then complete this identify device command */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* enble read look-ahead feature*/
if|if
condition|(
name|oneDeviceData
operator|->
name|satReadLookAheadSupport
operator|==
name|agTRUE
condition|)
block|{
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: memory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*Complete this identify packet device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES  command to enable Read Look-Ahead  */
name|status
operator|=
name|smsatSetFeaturesReadLookAhead
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: failed to call smsatSetFeatures()\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*Complete this identify device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* enble Volatile Write Cache feature*/
if|if
condition|(
name|oneDeviceData
operator|->
name|satVolatileWriteCacheSupport
operator|==
name|agTRUE
condition|)
block|{
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: memory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*Complete this identify packet device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES command to enable Volatile Write Cache */
name|status
operator|=
name|smsatSetFeaturesVolatileWriteCache
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: failed to call smsatSetFeatures()\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*Complete this identify device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* turn on DMA Setup FIS auto-activate by sending set feature FIS */
if|if
condition|(
name|oneDeviceData
operator|->
name|satNCQ
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|satDMASetupAA
operator|==
name|agTRUE
condition|)
block|{
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: momory allocation fails; can't send set feature\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* send the Set Feature ATA command to SATA device for enable DMA Setup FIS auto-activate */
name|status
operator|=
name|smsatSetFeaturesAA
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: failed to send set feature!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOFailed
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*Complete this identify device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesDMACB: end\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  smsatSetFeaturesReadLookAheadCB * *   This routine is a callback function called from smllSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to smSatIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|smsatSetFeaturesReadLookAheadCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|smIORequest_t
modifier|*
name|smIORequest
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequest
operator|=
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
name|oneDeviceData
operator|->
name|satLookAheadEnabled
operator|=
name|agTRUE
expr_stmt|;
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* check the agIOStatus */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_NO_DEVICE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_PORT_IN_RESET
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_INVALID
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: error status 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* enble Volatile Write Cache feature*/
if|if
condition|(
name|oneDeviceData
operator|->
name|satVolatileWriteCacheSupport
operator|==
name|agTRUE
condition|)
block|{
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: memory allocation fails\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*Complete this identify packet device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|scsiCmnd
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* sends SET FEATURES command to enable Volatile Write Cache */
name|status
operator|=
name|smsatSetFeaturesVolatileWriteCache
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: failed to call smsatSetFeatures()\n"
operator|)
argument_list|)
expr_stmt|;
comment|/*Complete this identify device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: end\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* turn on DMA Setup FIS auto-activate by sending set feature FIS */
if|if
condition|(
name|oneDeviceData
operator|->
name|satNCQ
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|satDMASetupAA
operator|==
name|agTRUE
condition|)
block|{
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: momory allocation fails; can't send set feature\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* send the Set Feature ATA command to SATA device for enable DMA Setup FIS auto-activate */
name|status
operator|=
name|smsatSetFeaturesAA
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: failed to send set feature!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOFailed
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*Complete this identify device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesReadLookAheadCB: end\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief  smsatSetFeaturesVolatileWriteCacheCB * *   This routine is a callback function called from smllSATACompleted(). *   This CB routine deals with normal non-chained data I/O SATA request. * *  \param   agRoot:      Handles for this instance of SAS/SATA hardware *  \param   agIORequest: Pointer to the LL I/O request context for this I/O. *  \param   agIOStatus:  Status of completed I/O. *  \param   agFirstDword:Pointer to the four bytes of FIS. *  \param   agIOInfoLen: Length in bytes of overrun/underrun residual or FIS *                        length. *  \param   agParam:     Additional info based on status. *  \param   ioContext:   Pointer to smSatIOContext_t. * *  \return: none * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|smsatSetFeaturesVolatileWriteCacheCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
init|=
name|agNULL
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satNewIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satNewIntIo
init|=
name|agNULL
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|smDeviceHandle_t
modifier|*
name|smDeviceHandle
decl_stmt|;
name|smIORequest_t
modifier|*
name|smIORequest
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|bit32
name|ataError
init|=
literal|0
decl_stmt|;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|bit32
name|status
init|=
name|SM_RC_FAILURE
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
if|if
condition|(
name|satIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: satIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smDeviceHandle
operator|=
name|satIOContext
operator|->
name|psmDeviceHandle
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smIORequest
operator|=
name|smOrgIORequest
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
block|}
name|smIORequest
operator|=
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: fail, case 1 agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: fail, case 2 status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|agIOInfoLen
operator|!=
literal|0
operator|&&
name|agIOStatus
operator|==
name|OSSA_IO_SUCCESS
condition|)
block|{
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
name|ataError
operator|=
name|statDevToHostFisHeader
operator|->
name|error
expr_stmt|;
comment|/* ATA Eror register   */
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: fail, case 3 ataStatus %d ataError %d!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ataError
operator|!=
literal|0
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: fail, case 4 ataStatus %d ataError %d!!!\n"
operator|,
name|ataStatus
operator|,
name|ataError
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|oneDeviceData
operator|->
name|satWriteCacheEnabled
operator|=
name|agTRUE
expr_stmt|;
comment|/* interal structure free */
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
comment|/* check the agIOStatus */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_NO_DEVICE
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_PORT_IN_RESET
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_NON_OPERATIONAL
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_RECOVERY
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_IN_ERROR
operator|||
name|agIOStatus
operator|==
name|OSSA_IO_DS_INVALID
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: error status 0x%x\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: did %d!!!\n"
operator|,
name|oneDeviceData
operator|->
name|id
operator|)
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* turn on DMA Setup FIS auto-activate by sending set feature FIS */
if|if
condition|(
name|oneDeviceData
operator|->
name|satNCQ
operator|==
name|agTRUE
operator|&&
name|oneDeviceData
operator|->
name|satDMASetupAA
operator|==
name|agTRUE
condition|)
block|{
name|satNewIntIo
operator|=
name|smsatAllocIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
literal|0
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
if|if
condition|(
name|satNewIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: momory allocation fails; can't send set feature\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* end memory allocation */
name|satNewIOContext
operator|=
name|smsatPrepareNewIO
argument_list|(
name|satNewIntIo
argument_list|,
name|smOrgIORequest
argument_list|,
name|oneDeviceData
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
comment|/* send the Set Feature ATA command to SATA device for enable DMA Setup FIS auto-activate */
name|status
operator|=
name|smsatSetFeaturesAA
argument_list|(
name|smRoot
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmIORequest
argument_list|,
name|satNewIOContext
operator|->
name|psmDeviceHandle
argument_list|,
operator|&
name|satNewIntIo
operator|->
name|satIntSmScsiXchg
argument_list|,
comment|/* orginal from OS layer */
name|satNewIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|SM_RC_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: failed to send set feature!!!\n"
operator|)
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satNewIntIo
argument_list|)
expr_stmt|;
comment|/* clean up TD layer's IORequestBody */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOFailed
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*Complete this identify device IO */
name|tdsmIDCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smIORequest
argument_list|,
name|smDeviceHandle
argument_list|,
name|smIOSuccess
argument_list|,
operator|&
operator|(
name|oneDeviceData
operator|->
name|satIdentifyData
operator|)
argument_list|)
expr_stmt|;
block|}
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSetFeaturesVolatileWriteCacheCB: end\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSMARTEnablePassCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|agsaFrameHandle_t
name|agFrameHandle
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
comment|//smSatIOContext_t         *satNewIOContext;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//smSatInternalIo_t        *satNewIntIo = agNULL;
comment|//  satDeviceData_t           *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
comment|//bit32                     status;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|bit8
name|bSenseKey
init|=
literal|0
decl_stmt|;
name|bit16
name|bSenseCodeInfo
init|=
literal|0
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSMARTEnablePassCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTEnablePassCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate tiIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
comment|/*ttttttthe one */
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTEnablePassCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTEnablePassCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTEnablePassCB: satOrgIOContext is NULL, wrong\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTEnablePassCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTEnablePassCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*     checking IO status, FIS type and error status   */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTEnablePassCB: not success status, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatTranslateATAErrorsToSCSIErrors
argument_list|(
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* process success case */
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTEnablePassCB:success status, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSMARTRStatusPassCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//  satDeviceData_t          *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|smScsiInitiatorRequest_t
modifier|*
name|smOrgScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
comment|//  agsaFisRegD2HData_t        statDevToHostFisData;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit8
name|bSenseKey
init|=
literal|0
decl_stmt|;
name|bit16
name|bSenseCodeInfo
init|=
literal|0
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
comment|/* ATA command response payload */
name|smScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|" 0x%02x, 0x%02x, 0x%02x, 0x%02x,\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|0
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|1
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|2
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|3
index|]
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|" 0x%02x, 0x%02x, 0x%02x, 0x%02x,\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|4
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|5
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|6
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|7
index|]
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|" 0x%02x, 0x%02x, 0x%02x, 0x%02x,\n"
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|8
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|9
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|10
index|]
operator|,
name|scsiCmnd
operator|->
name|cdb
index|[
literal|11
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB: satOrgIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
comment|/* ATA command response payload */
name|smScsiRequest
operator|=
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|)
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
comment|/* non-data -> device to host  fis are expected */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
if|if
condition|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatTranslateATAErrorsToSCSIErrors
argument_list|(
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* error checking */
block|}
comment|/* prcessing the success case */
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSMARTRStatusPassCB: SAT_SMART_RETURN_STATUS success\n"
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatSMARTReadLogCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
comment|//	satDeviceData_t 		 *satDevData;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|smScsiInitiatorRequest_t
modifier|*
name|smOrgScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
comment|//	  satReadLogExtSelfTest_t	*virtAddr1;
comment|//	  satSmartReadLogSelfTest_t *virtAddr2;
comment|//bit8						*pLogPage;
comment|//	  bit8						 SelfTestExecutionStatus = 0;
comment|//	  bit32 					 i = 0;
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
comment|//	  agsaFisRegD2HData_t		 statDevToHostFisData;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
comment|//	  bit32 					 lenReceived = 0;
name|bit8
name|bSenseKey
init|=
literal|0
decl_stmt|;
name|bit16
name|bSenseCodeInfo
init|=
literal|0
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
comment|/* ATA command response payload */
name|smScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: satOrgIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
comment|/* ATA command response payload */
name|smScsiRequest
operator|=
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|)
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|//for Debuggings
if|if
condition|(
name|agFirstDword
operator|!=
name|NULL
condition|)
block|{
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: statDevToHostFisHeader->status, status %d!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
operator|)
operator|&&
operator|(
name|agFirstDword
operator|!=
name|NULL
operator|)
condition|)
block|{
comment|/* non-data and pio read -> device to host and pio setup fis are expected */
comment|/*       first, assumed to be Reg Device to Host FIS       This is OK to just find fis type     */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
operator|)
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* for debugging */
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|==
name|SAT_SMART
condition|)
block|{
if|if
condition|(
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|==
name|SAT_SMART_READ_LOG
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: SAT_SMART_READ_LOG failed!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: error unknown command 0x%x feature 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|features
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatSMARTReadLogCB: error default case command 0x%x!!!\n"
operator|,
name|hostToDevFis
operator|->
name|h
operator|.
name|command
operator|)
argument_list|)
expr_stmt|;
block|}
name|smsatTranslateATAErrorsToSCSIErrors
argument_list|(
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* error checking */
block|}
comment|/* prcessing the success case */
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|osGLOBAL
name|void
name|smsatPassthroughCB
parameter_list|(
name|agsaRoot_t
modifier|*
name|agRoot
parameter_list|,
name|agsaIORequest_t
modifier|*
name|agIORequest
parameter_list|,
name|bit32
name|agIOStatus
parameter_list|,
name|agsaFisHeader_t
modifier|*
name|agFirstDword
parameter_list|,
name|bit32
name|agIOInfoLen
parameter_list|,
name|void
modifier|*
name|agParam
parameter_list|,
name|void
modifier|*
name|ioContext
parameter_list|)
block|{
name|smRoot_t
modifier|*
name|smRoot
init|=
name|agNULL
decl_stmt|;
name|smIntRoot_t
modifier|*
name|smIntRoot
init|=
name|agNULL
decl_stmt|;
name|smIntContext_t
modifier|*
name|smAllShared
init|=
name|agNULL
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smIORequestBody
decl_stmt|;
name|smIORequestBody_t
modifier|*
name|smOrgIORequestBody
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satIOContext
decl_stmt|;
name|smSatIOContext_t
modifier|*
name|satOrgIOContext
decl_stmt|;
name|smSatInternalIo_t
modifier|*
name|satIntIo
decl_stmt|;
name|smDeviceData_t
modifier|*
name|oneDeviceData
decl_stmt|;
name|smScsiRspSense_t
modifier|*
name|pSense
decl_stmt|;
name|smIORequest_t
modifier|*
name|smOrgIORequest
decl_stmt|;
name|agsaFisRegHostToDevice_t
modifier|*
name|hostToDevFis
init|=
name|agNULL
decl_stmt|;
name|bit32
name|ataStatus
init|=
literal|0
decl_stmt|;
name|smScsiInitiatorRequest_t
modifier|*
name|smScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|smScsiInitiatorRequest_t
modifier|*
name|smOrgScsiRequest
decl_stmt|;
comment|/* tiScsiXchg */
name|agsaFisRegD2HHeader_t
modifier|*
name|statDevToHostFisHeader
init|=
name|agNULL
decl_stmt|;
name|smIniScsiCmnd_t
modifier|*
name|scsiCmnd
decl_stmt|;
name|bit8
name|bSenseKey
init|=
literal|0
decl_stmt|;
name|bit16
name|bSenseCodeInfo
init|=
literal|0
decl_stmt|;
name|SM_DBG2
argument_list|(
operator|(
literal|"smsatPassthroughCB: start\n"
operator|)
argument_list|)
expr_stmt|;
name|SM_DBG5
argument_list|(
operator|(
literal|"smsatPassthroughCB:agIORequest=%p agIOStatus=0x%x agIOInfoLen %d\n"
operator|,
name|agIORequest
operator|,
name|agIOStatus
operator|,
name|agIOInfoLen
operator|)
argument_list|)
expr_stmt|;
comment|/* internally generate smIOContext */
name|smIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|agIORequest
operator|->
name|osData
expr_stmt|;
name|satIOContext
operator|=
operator|(
name|smSatIOContext_t
operator|*
operator|)
name|ioContext
expr_stmt|;
name|satIntIo
operator|=
name|satIOContext
operator|->
name|satIntIoContext
expr_stmt|;
name|oneDeviceData
operator|=
name|satIOContext
operator|->
name|pSatDevData
expr_stmt|;
name|hostToDevFis
operator|=
name|satIOContext
operator|->
name|pFis
expr_stmt|;
name|smRoot
operator|=
name|oneDeviceData
operator|->
name|smRoot
expr_stmt|;
name|smIntRoot
operator|=
operator|(
name|smIntRoot_t
operator|*
operator|)
name|smRoot
operator|->
name|smData
expr_stmt|;
name|smAllShared
operator|=
operator|(
name|smIntContext_t
operator|*
operator|)
operator|&
name|smIntRoot
operator|->
name|smAllShared
expr_stmt|;
if|if
condition|(
name|satIntIo
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatPassthroughCB: External smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
expr_stmt|;
name|smOrgIORequest
operator|=
name|smIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
comment|/* ATA command response payload */
name|smScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatPassthroughCB: Internal smSatInternalIo_t satIntIoContext\n"
operator|)
argument_list|)
expr_stmt|;
name|satOrgIOContext
operator|=
name|satIOContext
operator|->
name|satOrgIOContext
expr_stmt|;
if|if
condition|(
name|satOrgIOContext
operator|==
name|agNULL
condition|)
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatPassthroughCB: satOrgIOContext is NULL\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|SM_DBG4
argument_list|(
operator|(
literal|"smsatPassthroughCB: satOrgIOContext is NOT NULL\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|smOrgIORequestBody
operator|=
operator|(
name|smIORequestBody_t
operator|*
operator|)
name|satOrgIOContext
operator|->
name|smRequestBody
expr_stmt|;
name|smOrgIORequest
operator|=
operator|(
name|smIORequest_t
operator|*
operator|)
name|smOrgIORequestBody
operator|->
name|smIORequest
expr_stmt|;
name|pSense
operator|=
name|satOrgIOContext
operator|->
name|pSense
expr_stmt|;
name|smOrgScsiRequest
operator|=
name|satOrgIOContext
operator|->
name|smScsiXchg
expr_stmt|;
comment|/* ATA command response payload */
name|smScsiRequest
operator|=
operator|(
name|smScsiInitiatorRequest_t
operator|*
operator|)
operator|&
operator|(
name|satIntIo
operator|->
name|satIntSmScsiXchg
operator|)
expr_stmt|;
name|scsiCmnd
operator|=
name|satOrgIOContext
operator|->
name|pScsiCmnd
expr_stmt|;
block|}
name|smIORequestBody
operator|->
name|ioCompleted
operator|=
name|agTRUE
expr_stmt|;
name|smIORequestBody
operator|->
name|ioStarted
operator|=
name|agFALSE
expr_stmt|;
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_UNDERFLOW
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthroughCB: IO_UNDERFLOW, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOUnderRun
argument_list|,
name|agIOInfoLen
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|agFirstDword
operator|==
name|agNULL
operator|&&
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthroughCB: wrong. agFirstDword is NULL when error, status %d!!!\n"
operator|,
name|agIOStatus
operator|)
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOFailed
argument_list|,
name|smDetailOtherError
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|//for Debuggings
if|if
condition|(
operator|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
operator|)
operator|&&
operator|(
name|agFirstDword
operator|!=
name|NULL
operator|)
condition|)
block|{
comment|/* non-data and pio read -> device to host and pio setup fis are expected */
comment|/*           first, assumed to be Reg Device to Host FIS 	  This is OK to just find fis type         */
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|ataStatus
operator|=
name|statDevToHostFisHeader
operator|->
name|status
expr_stmt|;
comment|/* ATA Status register */
block|}
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
operator|)
operator|&&
operator|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
operator|)
operator|)
operator|||
operator|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
operator|)
condition|)
block|{
comment|/* for debugging */
if|if
condition|(
name|agIOStatus
operator|!=
name|OSSA_IO_SUCCESS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthroughCB: FAILED, NOT IO_SUCCESS!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|REG_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthroughCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|statDevToHostFisHeader
operator|->
name|fisType
operator|!=
name|PIO_SETUP_DEV_TO_HOST_FIS
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthroughCB: FAILED, Wrong FIS type 0x%x!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|fisType
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ataStatus
operator|&
name|ERR_ATA_STATUS_MASK
operator|)
operator|||
operator|(
name|ataStatus
operator|&
name|DF_ATA_STATUS_MASK
operator|)
condition|)
block|{
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthroughCB: FAILED, FAILED, error status!!!\n"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Process abort case */
if|if
condition|(
name|agIOStatus
operator|==
name|OSSA_IO_ABORTED
condition|)
block|{
name|smsatProcessAbort
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
name|smsatTranslateATAErrorsToSCSIErrors
argument_list|(
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* error checking */
block|}
comment|/* prcessing the success case */
if|if
condition|(
name|agFirstDword
operator|!=
name|NULL
condition|)
block|{
name|statDevToHostFisHeader
operator|=
operator|(
name|agsaFisRegD2HHeader_t
operator|*
operator|)
operator|&
operator|(
name|agFirstDword
operator|->
name|D2H
operator|)
expr_stmt|;
name|SM_DBG1
argument_list|(
operator|(
literal|"smsatPassthroughCB: statDevToHostFisHeader->status, status %d!!!\n"
operator|,
name|statDevToHostFisHeader
operator|->
name|status
operator|)
argument_list|)
expr_stmt|;
name|smsatTranslateATAErrorsToSCSIErrors
argument_list|(
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
argument_list|,
name|agFirstDword
operator|->
name|D2H
operator|.
name|error
argument_list|,
operator|&
name|bSenseKey
argument_list|,
operator|&
name|bSenseCodeInfo
argument_list|)
expr_stmt|;
name|smsatSetSensePayload
argument_list|(
name|pSense
argument_list|,
name|bSenseKey
argument_list|,
literal|0
argument_list|,
name|bSenseCodeInfo
argument_list|,
name|satOrgIOContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|agFirstDword
operator|->
name|D2H
operator|.
name|status
operator|&
literal|0x01
condition|)
block|{
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_CHECK_CONDITION
argument_list|,
name|satOrgIOContext
operator|->
name|pSmSenseData
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|tdsmIOCompletedCB
argument_list|(
name|smRoot
argument_list|,
name|smOrgIORequest
argument_list|,
name|smIOSuccess
argument_list|,
name|SCSI_STAT_GOOD
argument_list|,
name|agNULL
argument_list|,
name|satOrgIOContext
operator|->
name|interruptContext
argument_list|)
expr_stmt|;
name|smsatDecrementPendingIO
argument_list|(
name|smRoot
argument_list|,
name|smAllShared
argument_list|,
name|satIOContext
argument_list|)
expr_stmt|;
name|smsatFreeIntIoResource
argument_list|(
name|smRoot
argument_list|,
name|oneDeviceData
argument_list|,
name|satIntIo
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************* *Copyright (c) 2014 PMC-Sierra, Inc.  All rights reserved.  * *Redistribution and use in source and binary forms, with or without modification, are permitted provided  *that the following conditions are met:  *1. Redistributions of source code must retain the above copyright notice, this list of conditions and the *following disclaimer.  *2. Redistributions in binary form must reproduce the above copyright notice,  *this list of conditions and the following disclaimer in the documentation and/or other materials provided *with the distribution.  * *THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED  *WARRANTIES,INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS *FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE *FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  *NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  *BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  *LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  *SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE  ********************************************************************************/
end_comment

begin_comment
comment|/*******************************************************************************/
end_comment

begin_comment
comment|/** \file  *  *  * This file contains interrupt related functions in the SAS/SATA TD layer  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/pms/config.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osenv.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/ostypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osdebug.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/sa.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sallsdk/api/saosapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/titypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/ostiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/api/tiglobal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_SM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/sm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/smapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/sat/api/tdsmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|FDS_DM
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dm.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/dmapi.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/discovery/api/tddmapi.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/common/tdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/freebsd/driver/common/osstring.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdutil.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INITIATOR_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdtypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itddefs.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/ini/itdglobl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_DRIVER
end_ifdef

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdglobl.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdxchg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/sas/tgt/ttdtypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdsatypes.h>
end_include

begin_include
include|#
directive|include
file|<dev/pms/RefTisa/tisa/sassata/common/tdproto.h>
end_include

begin_comment
comment|/***************************************************************************** *! \biref  tiCOMInterruptHandler * *  Purpose: This function is called to service the hardware interrupt of the *           hardware. * *  \param tiRoot:   Pointer to initiator specific root data structure  for this *                   instance of the driver. * *  \param channelNum: The zero-base channel number of the controller. *                     0xFFFFFFFF indicates that the OS-App Specific layer does  *                     not provide the channel number. The TD/LL Layer needs to  *                     discover of any of its own channels that are causing the  *                     interrupt. * *  \return None * *  \note - The only thing that this API will do is to acknowledge and mask *          the necessary hardware interrupt register. The actual processing *          of the interrupt handler is done in tiCOMDelayedInterruptHandler(). * *****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|bit32
name|tiCOMInterruptHandler
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|channelNum
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
decl_stmt|;
name|bit32
name|interruptPending
init|=
name|agFALSE
decl_stmt|;
name|interruptPending
operator|=
name|saInterruptHandler
argument_list|(
name|agRoot
argument_list|,
name|channelNum
argument_list|)
expr_stmt|;
return|return
name|interruptPending
return|;
block|}
end_function

begin_comment
comment|/* tiCOMInterruptHandler() */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief tiCOMDelayedInterruptHandler * *  Purpose: This function is called to process the task associated with the *           interrupt handler. The task that this handler needs to do includes: *           completion of I/O, login event, error event, etc * *  \param tiRoot:     Pointer to initiator specific root data structure for *                     this instance of the driver. *  \param channelNum: The zero-base channel number of the controller. *                     0xFFFFFFFF indicates that the OS-App Specific layer does  *                     not provide the channel number. The TD/LL Layer needs to  *                     discover of any of its own channels that are causing the  *                     interrupt. *  \param count:      Count on how many items (such as IO completion) need to *                     be processed in this context. *  \param interruptContext: The thread/process context within which this  *                           function is called. * *             tiInterruptContext:     this function is called within an *                                     interrupt context. *             tiNonInterruptContext:  this function is called outside an *                                     interrupt context. *  \return None * *****************************************************************************/
end_comment

begin_function
name|FORCEINLINE
name|bit32
name|tiCOMDelayedInterruptHandler
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|channelNum
parameter_list|,
name|bit32
name|count
parameter_list|,
name|bit32
name|context
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
init|=
name|agNULL
decl_stmt|;
name|bit32
name|completed
init|=
literal|0
decl_stmt|;
name|TDSA_OUT_ENTER
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|==
name|tiInterruptContext
condition|)
block|{
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootInt
operator|)
expr_stmt|;
block|}
else|else
block|{
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
block|}
name|completed
operator|=
name|saDelayedInterruptHandler
argument_list|(
name|agRoot
argument_list|,
name|channelNum
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|completed
operator|==
literal|0
condition|)
block|{
name|TI_DBG3
argument_list|(
operator|(
literal|"tiCOMDelayedInterruptHandler: processedMsgCount zero\n"
operator|)
argument_list|)
expr_stmt|;
block|}
name|TDSA_OUT_LEAVE
argument_list|(
name|tiRoot
argument_list|)
expr_stmt|;
return|return
operator|(
name|completed
operator|)
return|;
block|}
end_function

begin_comment
comment|/* tiCOMDelayedInterruptHandler() */
end_comment

begin_comment
comment|/***************************************************************************** *! \brief tiCOMSystemInterruptsActive * *  Purpose: This function is called to indicate whether interrupts are  *           active or not from this point in time. * *  \param tiRoot:        Pointer to initiator specific root data structure for *                        this instance of the driver. *  \param sysIntsActive: Boolean value either true or false * *  \return None * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|void
name|tiCOMSystemInterruptsActive
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|sysIntsActive
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SPC_POLLINGMODE
if|if
condition|(
name|sysIntsActive
condition|)
return|return;
endif|#
directive|endif
comment|/* SPC_POLLINGMODE */
name|tdsaAllShared
operator|->
name|flags
operator|.
name|sysIntsActive
operator|=
name|sysIntsActive
expr_stmt|;
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMSystemInterruptsActive: start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* enable low level interrupts */
if|if
condition|(
name|agRoot
operator|->
name|sdkData
operator|!=
name|agNULL
condition|)
block|{
name|saSystemInterruptsActive
argument_list|(
name|agRoot
argument_list|,
operator|(
name|agBOOLEAN
operator|)
name|tdsaAllShared
operator|->
name|flags
operator|.
name|sysIntsActive
argument_list|)
expr_stmt|;
block|}
name|TI_DBG6
argument_list|(
operator|(
literal|"tiCOMSystemInterruptsActive: end\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* tiCOMSystemInterruptsActive */
end_comment

begin_function
name|osGLOBAL
name|void
name|tiComCountActiveIORequests
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|saCountActiveIORequests
argument_list|(
name|agRoot
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************************************** *! \brief tiCOMInterruptEnable * *  Purpose: This function is called to enable an interrupts on the specified channel  *           active or not from this point in time. * *  \param tiRoot:        Pointer to initiator specific root data structure for *                        this instance of the driver. *  \param : channelNum   vector number for MSIX  Zero for legacy interrupt  * *  \return None * *****************************************************************************/
end_comment

begin_function
name|osGLOBAL
name|FORCEINLINE
name|void
name|tiCOMInterruptEnable
parameter_list|(
name|tiRoot_t
modifier|*
name|tiRoot
parameter_list|,
name|bit32
name|channelNum
parameter_list|)
block|{
name|tdsaRoot_t
modifier|*
name|tdsaRoot
init|=
operator|(
name|tdsaRoot_t
operator|*
operator|)
name|tiRoot
operator|->
name|tdData
decl_stmt|;
name|tdsaContext_t
modifier|*
name|tdsaAllShared
init|=
operator|(
name|tdsaContext_t
operator|*
operator|)
operator|&
operator|(
name|tdsaRoot
operator|->
name|tdsaAllShared
operator|)
decl_stmt|;
name|agsaRoot_t
modifier|*
name|agRoot
decl_stmt|;
name|agRoot
operator|=
operator|&
operator|(
name|tdsaAllShared
operator|->
name|agRootNonInt
operator|)
expr_stmt|;
name|saSystemInterruptsEnable
argument_list|(
name|agRoot
argument_list|,
name|channelNum
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

